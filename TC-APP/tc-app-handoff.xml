This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: node_modules/**, dist/**, build/**, .next/**, *.log, .env*, .DS_Store, coverage/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
downloads/
  chikamoto_back.png
  chikamoto_front.png
  hiroto_takahashi_back_1768266219133.png
  hiroto_takahashi_front_1768266203603.png
  ichiro_back.png
  ichiro_front.png
  katsuya_nomura_back_1768266219134_1768282897048.png
  katsuya_nomura_front_1768282877880.png
  kazuhiro_kiyohara_back_final_1768383719938.png
  kazuhiro_kiyohara_front_1768282945883.png
  kazuma_okamoto_back_1768266187933.png
  kazuma_okamoto_front_1768266171182.png
  kazuyoshi_tatsunami_back_1768266236821_1768282929679.png
  kazuyoshi_tatsunami_front_1768282911734.png
  live-moment-sample-test.csv
  maki_back.png
  maki_front.png
  masumi_kuwata_back_final_1768383756460.png
  masumi_kuwata_front_final_1768383738725.png
  murakami_back.png
  murakami_front.png
  roki_sasaki_back.png
  roki_sasaki_front.png
  sadaharu_oh_back_1768282860731.png
  sadaharu_oh_front_1768282839477.png
  sakamoto_back.png
  sakamoto_front.png
  sample-card1.zip
  sample-card2.zip
  seiji_uebayashi_back_1768266283635.png
  seiji_uebayashi_front_1768266268762.png
  seiya_suzuki_back.png
  seiya_suzuki_front.png
  shigeo_nagashima_back_1768282823107.png
  shigeo_nagashima_front_1768282806605.png
  shohei_ohtani_back.png
  shohei_ohtani_front.png
  shota_imanaga_back_1768266152976.png
  shota_imanaga_front_1768266137078.png
  ultimate_phantom_ace_16_9_1768470474343.png
  yamamoto_back.png
  yamamoto_front.png
  yoshida_back.png
  yoshida_front.png
  yu_darvish_back_1768266119714.png
  yu_darvish_front_1768266103651.png
  yuki_ishii_back_final_1768383796303.png
  yuki_ishii_front_final_1768383773628.png
  yuki_okabayashi_back_1768266253226.png
  yuki_okabayashi_front_1768266236820.png
  yumeto_kanamaru_back_final_1768383840757.png
  yumeto_kanamaru_front_final_1768383819511.png
  後半.png
frontend/
  app/
    actions/
      admin.ts
      item.ts
      order.ts
      payout.ts
      send-email.ts
    admin/
      moments/
        DeleteMomentButton.tsx
        MomentForm.tsx
        page.tsx
      payouts/
        page.tsx
        PayoutRow.tsx
      layout.tsx
      page.tsx
    api/
      ai/
        image/
          route.ts
        text/
          route.ts
      analyze-card/
        route.ts
      checkout/
        route.ts
      debug/
        config/
          route.ts
      debug-auth/
        route.ts
      debug-email/
        route.ts
      debug-item/
      debug-moments/
      dev/
        moment/
          route.ts
      estimate-price/
        route.ts
      ping/
        route.ts
      webhooks/
        stripe/
          route.ts
    auctions/
      page.tsx
    checkout/
      [id]/
        page.tsx
    collection/
      page.tsx
    community/
      page.tsx
    debug-admin/
      page.tsx
    listings/
      [id]/
        page.tsx
    login/
      page.tsx
    market/
      page.tsx
    orders/
      [id]/
        success/
          page.tsx
      buy/
        [id]/
          page.tsx
      sell/
        [id]/
          page.tsx
    payouts/
      page.tsx
    profile/
      [userId]/
        page.tsx
      page.tsx
    register/
      page.tsx
    sell/
      page.tsx
    error.tsx
    favicon.ico
    global-error.tsx
    globals.css
    layout.tsx
    not-found.tsx
    page.tsx
  components/
    emails/
      OrderConfirmationEmail.tsx
      OrderReceivedEmail.tsx
      OrderShippedEmail.tsx
      PayoutRequestEmail.tsx
      ShippingRequestEmail.tsx
      WelcomeEmail.tsx
    AddToShowcaseModal.tsx
    CardListing.tsx
    DevTools.tsx
    Footer.tsx
    Header.tsx
    HeroSection.tsx
    LiveMomentListener.tsx
    LiveMomentToast.tsx
    MarketPriceLinks.tsx
    MomentHistoryBadge.tsx
    MomentHistoryPanel.tsx
    OrderHistory.tsx
    PremiumCardImage.tsx
    PurchaseAnimation.tsx
    ShowcaseCard.tsx
    SkeletonCard.tsx
  hooks/
    useZengin.ts
  lib/
    resend.ts
    stripe.ts
    teams.ts
  migrations/
    03_add_order_status.sql
    04_expand_listing_items.sql
    05_decouple_catalog.sql
    06_backfill_and_remove_catalog.sql
    07_update_complete_order_rpc.sql
    08_payout_system.sql
    09_add_shipping_to_orders.sql
    10_add_bank_codes.sql
    11_add_payout_fee.sql
    12_enhance_orders.sql
    13_fix_listing_rls.sql
    14_add_live_moments.sql
    15_add_moment_snapshot.sql
    16_add_moment_history.sql
    17_add_match_result_to_live_moments.sql
    18_add_is_finalized_to_live_moments.sql
    21_add_soft_delete_to_listings.sql
    22_add_origin_order_id_to_listings.sql
    23_add_incoming_to_listing_status_enum.sql
    24_add_seller_id_to_orders.sql
    25_fix_selling_view_rls.sql
    26_fix_buyer_seller_visibility.sql
    27_fix_rls_recursion.sql
    28_restore_mutation_rls.sql
    29_fix_workspace_visibility.sql
    30_self_healing_complete_order.sql
    31_allow_multiple_orders_per_listing.sql
    32_setup_storage.sql
    33_add_image_url_to_live_moments.sql
    34_add_fee_columns_to_orders.sql
    debug_helper.sql
    debug_indexes.sql
    debug_triggers.sql
    fix_schema_add_condition_rating.sql
    production_setup.sql
    reset_data.sql
    Untitled-3
    Untitled-4
    Untitled-5
  public/
    bg-stadium.png
    file.svg
    globe.svg
    next.svg
    sample_card_back2.png
    sample_card_front1.png
    sample-card-back.png
    sample-card-front.png
    test.html
    vercel.svg
    window.svg
  scripts/
    debug_14fb.ts
    debug_7575.ts
    debug_c376.ts
    debug_moments.ts
    fix_sakamoto.ts
    seed.ts
    simulate_action.ts
    test-gemini.ts
  types/
    index.ts
  utils/
    supabase/
      client.ts
      middleware.ts
      server.ts
  .gitignore
  check_all_clones.ts
  check_constraints.ts
  check_enum.ts
  check_images.ts
  check_item_details.ts
  check_moments.ts
  check_order_prices.ts
  check_original_30k.ts
  check_prices.ts
  check_schema.ts
  check_seller.ts
  check_statuses.ts
  cleanup_ohtani.ts
  debug_22k.ts
  debug_30k.ts
  debug_39k.ts
  debug_all_items.ts
  debug_missing_card.ts
  debug_roki.ts
  debug_success_item.js
  deep_check_8e8eb573.ts
  dump_workspace.ts
  eslint.config.mjs
  final_cleanup.ts
  find_30k_card.ts
  find_buyer1_clone.ts
  find_buyer2.ts
  find_sasaki_30k.ts
  find_sold_logic.ts
  find_specific_clone.ts
  fix_buyer2_stuck_items.ts
  fix_final.ts
  get_enum_values.ts
  get_status_enum.ts
  inspect_listing.ts
  list_buyer2_items.ts
  manual_recovery.ts
  middleware.ts
  next.config.js
  package.json
  postcss.config.js
  README.md
  recover_39k.ts
  recover_sasaki.ts
  simulate_insert.ts
  tailwind.config.js
  TC-APP.code-workspace
  test_action.ts
  test_incoming.ts
  test.ts
  trace_order.ts
  trigger_recovery.ts
  tsconfig.json
  vercel.json
  verify_visibility.ts
migrations/
  01_add_profile_name_fields.sql
  02_create_live_moments.sql
scripts/
specs/
  data_model.yaml
  openapi.yaml
  state_machine.md
supabase/
  migrations/
    20251220160000_add_origin_order_id.sql
add_address_columns.sql
add_columns.sql
add_delete_policy_listings.sql
add_live_moment_column.sql
add_more_catalog_items.sql
apply_rls_policies.sql
create_complete_order_function.sql
create_complete_order_rpc.sql
create_user_collections.sql
enable_live_moment_sample.sql
package.json
purchase_rpc.sql
repomix-output.xml
seed_catalog.py
seed_data.sql
storage_policy.sql
supabase_schema.sql
test_image.txt
update_status_enum.sql
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="downloads/live-moment-sample-test.csv">
92f97a6f-15a8-40ea-8d9e-b956805c10d7,2025-12-09 06:29:35.059014+00,大谷 翔平,HOMERUN,大谷翔平、劇的なサヨナラ満塁ホームラン！今季40号達成！,9回裏、2アウト満塁。ドジャースタジアムが揺れた歴史的瞬間。,5,"{""inning"": ""9th Bottom"", ""opponent"": ""Rays"", ""video_url"": ""https://example.com/moment/ohtani-40.mp4"", ""related_card_ids"": []}"
</file>

<file path="frontend/app/actions/admin.ts">
'use server';

import { createClient } from '@supabase/supabase-js';
import { revalidatePath } from 'next/cache';

// Admin Client (Bypass RLS)
const getAdminClient = () => {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

export async function createLiveMoment(formData: FormData) {
    const playerName = formData.get('playerName') as string;
    const title = formData.get('title') as string;
    const type = formData.get('type') as string;
    const intensity = parseInt(formData.get('intensity') as string);
    const description = formData.get('description') as string;
    const imageUrl = formData.get('imageUrl') as string;

    // Structured Match Data
    const teamVisitor = formData.get('teamVisitor') as string;
    const scoreVisitor = formData.get('scoreVisitor') as string;
    const teamHome = formData.get('teamHome') as string;
    const scoreHome = formData.get('scoreHome') as string;
    const progress = formData.get('progress') as string;

    let matchResult = null;
    if (teamVisitor && teamHome) {
        matchResult = `${teamVisitor} ${scoreVisitor || '0'} - ${scoreHome || '0'} ${teamHome} (${progress || 'Pre-Game'})`;
    }

    if (!playerName || !title || !type) {
        throw new Error('Missing required fields');
    }

    const { error } = await getAdminClient()
        .from('live_moments')
        .insert({
            player_name: playerName,
            title,
            type,
            intensity,
            description,
            image_url: imageUrl,
            match_result: matchResult
        });

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}

export async function approvePayout(payoutId: string) {
    // 1. Mark Payout as Paid
    const { error } = await getAdminClient()
        .from('payouts')
        .update({
            status: 'paid',
            processed_at: new Date().toISOString()
        })
        .eq('id', payoutId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/payouts');
    revalidatePath('/admin/payouts');
    revalidatePath('/admin'); // KPI update
}

/**
 * Finalize a Live Moment (Game Set)
 * Updates the moment result and propagates it to all stamped cards.
 */
export async function finalizeMoment(momentId: string, formData: FormData) {
    let finalScore = formData.get('finalScore') as string;

    if (!momentId || !finalScore) {
        throw new Error('Missing required fields');
    }

    // Auto-update inning to "9回裏" if "Game Set" button is pressed (User Requirement)
    // Replaces pattern like "(Top 1st)" or "(1回表)" with "(9回裏)"
    const inningPattern = /\((?:Top|Bot)\s+\d+\w+\)|\(\d+回[表裏]\)/gi;
    if (inningPattern.test(finalScore)) {
        finalScore = finalScore.replace(inningPattern, '(9回裏)');
    }

    console.log(`Finalizing Moment ${momentId} with score: ${finalScore}`);

    // 1. Update Live Moment Record
    const { error: updateError } = await getAdminClient()
        .from('live_moments')
        .update({
            match_result: finalScore,
            is_finalized: true
        })
        .eq('id', momentId);

    if (updateError) throw new Error(`Failed to update moment: ${updateError.message}`);

    // 2. Propagate to Items (Sync Logic)
    // Find items that have this moment in their history
    // Since we use JSONB array, we can filter roughly by string match or JSON containment if supported.
    // For MVP, simplistic fetch & filter is safer if volume is low.
    // Or use pgsql contains operator '@>'. 
    // BUT supabase-js syntax for json array contains element with specific field value is tricky.
    // We'll fetch items where moment_history is not empty/null for efficiency, then filter in memory (MVP).
    // Or better: .not('moment_history', 'is', null)

    // Efficient Query Attempt:
    // We want rows where moment_history @> [{ "moment_id": "..." }]
    // Supabase TS: .contains('moment_history', JSON.stringify([{ moment_id: momentId }]))

    const { data: items, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('id, moment_history')
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (fetchError) {
        console.error('Error fetching affected items:', fetchError);
        // We don't throw, we effectively partial success (Moment updated, sync failed)
        // But better to warn.
    }

    if (items && items.length > 0) {
        console.log(`Syncing ${items.length} items for Moment ${momentId}...`);

        const updates = items.map(async (item) => {
            const history = item.moment_history as any[];
            const updatedHistory = history.map(h => {
                if (h.moment_id === momentId) {
                    return { ...h, match_result: finalScore, status: 'finalized' };
                }
                return h;
            });

            return getAdminClient()
                .from('listing_items')
                .update({ moment_history: updatedHistory })
                .eq('id', item.id);
        });

        await Promise.all(updates);
        console.log('Sync complete.');
    }

    revalidatePath('/admin/moments');
}

export async function updateLiveMoment(momentId: string, formData: FormData) {
    const playerName = formData.get('playerName') as string;
    const title = formData.get('title') as string;
    const type = formData.get('type') as string;
    const intensity = parseInt(formData.get('intensity') as string);
    const description = formData.get('description') as string;
    const imageUrl = formData.get('imageUrl') as string;

    // Structured Match Data
    const teamVisitor = formData.get('teamVisitor') as string;
    const scoreVisitor = formData.get('scoreVisitor') as string;
    const teamHome = formData.get('teamHome') as string;
    const scoreHome = formData.get('scoreHome') as string;
    const progress = formData.get('progress') as string;

    let matchResult = null;
    if (teamVisitor && teamHome) {
        matchResult = `${teamVisitor} ${scoreVisitor || '0'} - ${scoreHome || '0'} ${teamHome} (${progress || 'Pre-Game'})`;
    }

    if (!momentId || !playerName || !title || !type) {
        throw new Error('Missing required fields');
    }

    const admin = getAdminClient();

    // Checking usage in listing_items
    const { count } = await admin
        .from('listing_items')
        .select('id', { count: 'exact', head: true })
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (count && count > 0) {
        throw new Error("このモーメントはすでにカードに記録（配布）されているため、変更できません。");
    }

    const { error } = await admin
        .from('live_moments')
        .update({
            player_name: playerName,
            title,
            type,
            intensity,
            description,
            image_url: imageUrl,
            match_result: matchResult
        })
        .eq('id', momentId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}

export async function deleteLiveMoment(momentId: string) {
    if (!momentId) {
        throw new Error('Missing momentId');
    }

    const admin = getAdminClient();

    // Checking usage in listing_items
    const { count } = await admin
        .from('listing_items')
        .select('id', { count: 'exact', head: true })
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (count && count > 0) {
        throw new Error("このモーメントはすでにカードに記録（配布）されているため、削除できません。");
    }

    const { error } = await admin
        .from('live_moments')
        .delete()
        .eq('id', momentId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}
</file>

<file path="frontend/app/actions/item.ts">
'use server';

import { createClient as createServerClient } from '../../utils/supabase/server';
import { createClient } from '@supabase/supabase-js';
import { revalidatePath } from 'next/cache';
import { randomUUID } from 'crypto';

const getAdminClient = () => {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

/**
 * Soft delete an item
 */
export async function deleteItem(itemId: string) {
    console.log(`[Soft Delete] Archive Request: ${itemId}`);

    const { error } = await getAdminClient()
        .from('listing_items')
        .update({ deleted_at: new Date().toISOString() })
        .eq('id', itemId);

    if (error) {
        throw new Error(`Failed to archive item: ${error.message}`);
    }

    revalidatePath('/collection');
    return { success: true };
}

/**
 * Restore a soft-deleted item
 */
export async function restoreItem(itemId: string) {
    console.log(`[Soft Delete] Restore Request: ${itemId}`);

    const { error } = await getAdminClient()
        .from('listing_items')
        .update({ deleted_at: null })
        .eq('id', itemId);

    if (error) {
        throw new Error(`Failed to restore item: ${error.message}`);
    }

    revalidatePath('/collection');
    return { success: true };
}

/**
 * Add a memory note to a specific moment in the card's history
 */
// Old tagMomentMemory is deprecated/replaced by addMomentMemory
// We keep it temporarily if needed but essentially we are moving lightly.

/**
 * Delete a memory note (Set to null/empty)
 * Only the author of the note can delete it.
 */
/**
 * Add a new memory to the timeline
 */
export async function addMomentMemory(itemId: string, momentIndex: number, text: string, momentId?: string) {
    if (text.length > 150) throw new Error('Note must be less than 150 characters');

    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Item
    const { data: item, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('seller_id, moment_history, player_name')
        .eq('id', itemId)
        .single();

    if (fetchError || !item) throw new Error('Item not found');

    // Permission Check: Owner OR Current Buyer
    if (item.seller_id !== user.id) {
        const { data: order } = await getAdminClient()
            .from('orders')
            .select('id')
            .eq('listing_id', itemId)
            .eq('buyer_id', user.id)
            .neq('status', 'cancelled')
            .maybeSingle();

        if (!order) {
            throw new Error('Only the item owner or its buyer can record memories');
        }
    }

    // 2. Prepare History
    let history = [...(item.moment_history || [])];

    let targetIndex = momentIndex;
    if (momentId) {
        let foundIndex = history.findIndex((m: any) => m.moment_id === momentId);

        // --- SELF-HEALING (RESTORED & ENHANCED) ---
        // If not in item history, check if it's in a relevant order snapshot
        if (foundIndex === -1) {
            console.log(`[addMomentMemory] Moment ${momentId} not in item history. Checking order snapshots...`);
            const { data: order } = await getAdminClient()
                .from('orders')
                .select('id, moment_snapshot')
                .eq('listing_id', itemId)
                .eq('buyer_id', user.id)
                .neq('status', 'cancelled')
                .maybeSingle();

            if (order && order.moment_snapshot) {
                const snapshots = Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot];
                const snap = snapshots.find((s: any) => s.id === momentId);

                if (snap) {
                    console.log(`[Healing] Stamping missing snapshot ${momentId} to item ${itemId} before adding memory.`);
                    const newMomentEntry = {
                        moment_id: snap.id,
                        timestamp: new Date().toISOString(),
                        title: snap.title,
                        player_name: snap.player_name,
                        intensity: snap.intensity,
                        description: snap.description,
                        match_result: snap.match_result,
                        owner_at_time: order.id,
                        status: snap.is_finalized ? 'finalized' : 'pending'
                    };
                    history.push(newMomentEntry);
                    foundIndex = history.length - 1;
                }
            }
        }

        if (foundIndex !== -1) {
            targetIndex = foundIndex;
        } else {
            // Still not found, and index is out of bounds or invalid
            if (targetIndex < 0 || targetIndex >= history.length) {
                throw new Error('Invalid moment index');
            }
        }
    } else if (targetIndex < 0 || targetIndex >= history.length) {
        throw new Error('Invalid moment index');
    }

    // 3. Add Memory to Array
    const moment = history[targetIndex];
    const memories = Array.isArray(moment.memories) ? moment.memories : [];

    // Fetch Display Name (Nickname)
    const { data: profile } = await getAdminClient()
        .from('profiles')
        .select('display_name, name')
        .eq('id', user.id)
        .single();

    const authorDisplayName = profile?.display_name || profile?.name || user.user_metadata?.full_name || 'Owner';

    const newMemory = {
        id: randomUUID(),
        author_id: user.id,
        author_name: authorDisplayName, // Snapshot Nickname
        text: text,
        created_at: new Date().toISOString(),
        is_hidden: false
    };

    memories.push(newMemory);

    history[targetIndex] = {
        ...moment,
        memories: memories,
        // Legacy fields for backward compat (optional, or just clear them?)
        // user_note: text, // Maybe don't overwrite legacy to keep it safe?
        // note_updated_at: new Date().toISOString()
    };

    // 4. Save
    const { error: updateError } = await getAdminClient()
        .from('listing_items')
        .update({ moment_history: history })
        .eq('id', itemId);

    if (updateError) throw new Error(updateError.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Edit an existing memory
 */
export async function editMomentMemory(itemId: string, momentIndex: number, memoryId: string, newText: string, momentId?: string) {
    if (newText.length > 150) throw new Error('Note must be less than 150 characters');

    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }
    if (targetIndex < 0) throw new Error('Invalid index');

    const moment = history[targetIndex];
    const memories = Array.isArray(moment.memories) ? moment.memories : [];

    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    // Permission Check: Author only
    if (memories[memIndex].author_id !== user.id) throw new Error('You can only edit your own memories');

    // Refresh Display Name (Nickname) on Edit
    const { data: profile } = await getAdminClient()
        .from('profiles')
        .select('display_name, name')
        .eq('id', user.id)
        .single();

    const authorDisplayName = profile?.display_name || profile?.name || user.user_metadata?.full_name || memories[memIndex].author_name;

    memories[memIndex] = {
        ...memories[memIndex],
        text: newText,
        author_name: authorDisplayName,
        updated_at: new Date().toISOString()
    };

    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * PHYSICALLY Delete a memory
 * Only the author can physically delete their own memory.
 */
export async function deleteMomentMemory(itemId: string, momentIndex: number, memoryId: string, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }

    const moment = history[targetIndex];
    let memories = Array.isArray(moment.memories) ? moment.memories : [];
    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    const memory = memories[memIndex];

    // Author Check: ONLY the author can physically delete.
    if (memory.author_id !== user.id) {
        throw new Error('Only the original author can physically delete this memory. Owners should use Hide instead.');
    }

    // Physical Delete
    memories.splice(memIndex, 1);
    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * LOGICALLY Hide/Unhide a memory
 * Both the current card owner AND the original author can toggle visibility.
 */
export async function toggleHideMomentMemory(itemId: string, momentIndex: number, memoryId: string, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }

    const moment = history[targetIndex];
    let memories = Array.isArray(moment.memories) ? moment.memories : [];
    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    // Permission Check: Owner or Author
    if (item.seller_id !== user.id && memories[memIndex].author_id !== user.id) {
        throw new Error('Only the current owner or the original author can change visibility');
    }

    // Toggle
    memories[memIndex].is_hidden = !memories[memIndex].is_hidden;
    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Hide/Unhide an entire moment in the history
 * Only the current card owner can hide/unhide whole moments.
 */
export async function toggleHideMoment(itemId: string, momentIndex: number, isHidden: boolean, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('seller_id, moment_history')
        .eq('id', itemId)
        .single();

    if (fetchError || !item) throw new Error('Item not found');
    if (item.seller_id !== user.id) throw new Error('Only the owner can manage memories');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;

    if (momentId) {
        const foundIndex = history.findIndex((m: any) => m.moment_id === momentId);
        if (foundIndex !== -1) targetIndex = foundIndex;
    }

    if (targetIndex < 0 || targetIndex >= history.length) throw new Error('Invalid index');

    // Logical delete (Hide)
    history[targetIndex] = {
        ...history[targetIndex],
        is_hidden: isHidden
    };

    const { error: updateError } = await getAdminClient()
        .from('listing_items')
        .update({ moment_history: history })
        .eq('id', itemId);

    if (updateError) throw new Error(updateError.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Find the item that was cloned for the buyer after a successful order
 */
export async function getBuyerItemByOrder(orderId: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error("FATAL: SUPABASE_SERVICE_ROLE_KEY is missing in Action environment.");
        return null;
    }

    try {
        // 1. Get order details
        const { data: order } = await getAdminClient()
            .from('orders')
            .select('listing_id, buyer_id, status, moment_snapshot, listing:listing_items!listing_id(*)')
            .eq('id', orderId)
            .single();

        if (!order) return null;

        // Security check
        if (order.buyer_id !== user.id) return null;

        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (!listing) return null;

        return {
            id: listing.id,
            history: listing.moment_history || []
        };
    } catch (criticalError: any) {
        console.error("[getBuyerItemByOrder] Critical Crash:", criticalError);
        return null;
    }
}
</file>

<file path="frontend/app/actions/order.ts">
'use server';

import { createClient } from '../../utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';
import { resend } from '../../lib/resend';
import OrderShippedEmail from '../../components/emails/OrderShippedEmail';
import OrderReceivedEmail from '../../components/emails/OrderReceivedEmail';
import { ReactElement } from 'react';

// Admin Client for Privileged Operations (Fetching Emails)
// Helper to get Admin Client safely
function getAdminClient() {
    console.log("[Debug] getAdminClient called. Checking env vars...");
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error("FATAL: SUPABASE_SERVICE_ROLE_KEY is missing/undefined in Vercel environment.");
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    );
}

/**
 * Mark Order as Shipped
 * Access: Seller Only
 */
export async function markAsShipped(orderId: string, trackingNumber?: string, carrier?: string) {
    const supabase = await createClient(); // Standard Client for Auth/RLS check
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order and Verify Ownership
    const { data: order, error: fetchError } = await supabase
        .from('orders')
        .select(`
            id,
            buyer_id,
            seller_id,
            status,
            listing:listing_items!listing_id (
                id, seller_id, series_name, player_name
            )
        `)
        .eq('id', orderId)
        .single();

    if (fetchError || !order) throw new Error('Order not found');

    // Verify Seller
    const listingDetail = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    console.log(`[Debug markAsShipped] Order: ${orderId}, User: ${user.id}, ListingSeller: ${listingDetail?.seller_id}, OrderSeller: ${order.seller_id}`);

    const isListingSeller = listingDetail.seller_id === user.id;
    const isOrderSeller = order.seller_id === user.id;

    if (!isListingSeller && !isOrderSeller) {
        const msg = `[Debug] Unauthorized: Seller ID mismatch. UserID=${user.id}, ListingSellerID=${listingDetail.seller_id}, OrderSellerID=${order.seller_id}`;
        console.error(msg);
        throw new Error(msg);
    }

    // 2. Update Order Status (Using Admin to bypass RLS/Policy constraints)
    const { error: updateError } = await getAdminClient()
        .from('orders')
        .update({
            status: 'shipped',
            tracking_number: trackingNumber,
            carrier: carrier,
            shipped_at: new Date().toISOString()
        })
        .eq('id', orderId);

    if (updateError) throw new Error(updateError.message);

    // 3. Send Email to Buyer (requires Admin to fetch email)
    try {
        const { data: buyerUser, error: buyerError } = await getAdminClient().auth.admin.getUserById(order.buyer_id);

        if (buyerUser && buyerUser.user && buyerUser.user.email) {
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
            const { error: emailError } = await resend.emails.send({
                from: 'Stadium Card <notifications@resend.dev>',
                to: [buyerUser.user.email],
                subject: 'Your Item Has Been Shipped',
                react: OrderShippedEmail({
                    buyerName: buyerUser.user.user_metadata?.full_name || 'Collector',
                    productName: listingDetail.player_name || listingDetail.series_name,
                    trackingNumber,
                    carrier,
                    orderUrl: `${baseUrl}/orders/buy/${order.id}`,
                    baseUrl
                }) as ReactElement
            });
            if (emailError) console.error('Email Error:', emailError);
        }
    } catch (err) {
        console.error('Failed to send email:', err);
        // Do not throw error here, as status update succeeded
    }

    return { success: true };
}

/**
 * Mark Order as Received (Completed)
 * Access: Buyer Only
 * Effect: Unlocks Funds (by setting listing status to Completed)
 */
export async function markAsReceived(orderId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order details
    const { data: order, error: fetchError } = await supabase
        .from('orders')
        .select(`
            id,
            buyer_id,
            listing_id,
            status,
            listing:listing_items!listing_id (
                id, seller_id, series_name, player_name
            )
        `)
        .eq('id', orderId)
        .single();

    if (fetchError || !order) throw new Error('Order not found');

    // Verify Buyer
    if (order.buyer_id !== user.id) {
        throw new Error('Unauthorized: You are not the buyer.');
    }

    // 2. Call RPC to complete the order and unlock funds
    // We pass listing_id to RPC
    const { error: rpcError } = await supabase.rpc('complete_order', {
        p_listing_id: order.listing_id
    });

    if (rpcError) throw new Error(rpcError.message);

    // Also explicitly set completed_at (RPC might miss it if logic not updated)
    await getAdminClient().from('orders').update({
        completed_at: new Date().toISOString()
    }).eq('id', orderId);

    // --- Unlock Item for Buyer's Workspace ---
    try {
        const { getBuyerItemByOrder } = await import('./item');
        const buyerItemData = await getBuyerItemByOrder(orderId);
        if (buyerItemData?.id) {
            console.log(`[markAsReceived] Unlocking item ${buyerItemData.id} for buyer.`);
            await getAdminClient()
                .from('listing_items')
                .update({
                    status: 'Draft',
                    origin_order_id: orderId // Ensure link is set even if webhook failed
                })
                .eq('id', buyerItemData.id)
                .in('status', ['Incoming', 'AwaitingShipment', 'Active']); // Added 'Active' safety net
        }
    } catch (unlockErr) {
        console.error('[markAsReceived] Failed to unlock item:', unlockErr);
    }

    // Prepare Listing Detail safe access
    const listingDetail = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    // 3. Send Email to Seller (Funds Added Notification) & Auto-Clone
    try {
        const { data: sellerUser, error: sellerError } = await getAdminClient().auth.admin.getUserById(listingDetail.seller_id);

        if (sellerUser && sellerUser.user && sellerUser.user.email) {
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

            // 4. Send Email to Seller
            const { error: emailError } = await resend.emails.send({
                from: 'Trade Card App <onboarding@resend.dev>',
                to: [sellerUser.user.email],
                subject: 'Transaction Completed: Funds Added',
                react: OrderReceivedEmail({
                    sellerName: sellerUser.user.user_metadata?.full_name || 'Seller',
                    productName: listingDetail.player_name || listingDetail.series_name,
                    payoutUrl: `${baseUrl}/payouts`
                }) as ReactElement
            });
            if (emailError) console.error('Email Error:', emailError);
        }
    } catch (err) {
        console.error('Failed to send email:', err);
    }

    return { success: true };
}


/**
 * Fetch Order Details for Seller (Bypassing RLS)
 */
export async function getSellerOrderDetails(orderId: string) {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
        throw new Error('Server configuration error');
    }

    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    console.log('Fetching order (Seller):', orderId);

    // 1. Fetch Order (No Join)
    const { data: order, error: orderError } = await getAdminClient()
        .from('orders')
        .select('*')
        .eq('id', orderId)
        .single();

    if (orderError || !order) {
        console.error('Admin Fetch Order Error:', JSON.stringify(orderError));
        throw new Error('Order not found in database');
    }

    // 2. Fetch Listing (Manual Join)
    const { data: listing, error: listingError } = await getAdminClient()
        .from('listing_items')
        .select('id, series_name, player_name, images, price, seller_id')
        .eq('id', order.listing_id)
        .single();

    if (listingError || !listing) {
        console.error('Admin Fetch Listing Error:', JSON.stringify(listingError));
        throw new Error('Associated listing not found');
    }

    // Explicit Ownership Check
    console.log(`[Debug getSellerOrderDetails] Order: ${orderId}, User: ${user.id}, Seller: ${listing.seller_id}, OrderSeller: ${order.seller_id}`);

    const isListingSeller = listing.seller_id === user.id;
    const isOrderSeller = order.seller_id === user.id;

    if (!isListingSeller && !isOrderSeller) {
        const msg = `[Debug] Unauthorized: Seller ID mismatch in getSellerOrderDetails. UserID=${user.id}, ListingSellerID=${listing.seller_id}, OrderSellerID=${order.seller_id}`;
        console.error(msg);
        throw new Error(msg);
    }

    // Combine
    return {
        ...order,
        listing: {
            ...listing,
            title: listing.series_name || listing.player_name
        }
    };
}

/**
 * Fetch Order Details for Buyer (Bypassing RLS)
 */
export async function getBuyerOrderDetails(orderId: string) {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
        throw new Error('Server configuration error');
    }

    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order
    const { data: order, error: orderError } = await getAdminClient()
        .from('orders')
        .select('*')
        .eq('id', orderId)
        .single();

    if (orderError || !order) {
        console.error('Admin Fetch Order (Buyer) Error:', JSON.stringify(orderError));
        throw new Error('Order not found');
    }

    // Verify Buyer
    if (order.buyer_id !== user.id) {
        throw new Error('Unauthorized: You are not the buyer.');
    }

    // 2. Fetch Listing
    const { data: listing, error: listingError } = await getAdminClient()
        .from('listing_items')
        .select('id, series_name, player_name, images, price, seller_id, status, moment_history')
        .eq('id', order.listing_id)
        .single();

    if (listingError || !listing) {
        console.error('Fetch Listing Error:', listingError);
        throw new Error(`Listing details not found: ${listingError?.message || 'Unknown error'}`);
    }

    return {
        ...order,
        listing: {
            ...listing,
            title: listing.series_name || listing.player_name
        }
    };
}

/**
 * Fetch All Orders for Seller
 */
export async function getSellerOrders() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];

    const { data, error } = await getAdminClient()
        .from('orders')
        .select(`
            id,
            status,
            total_amount,
            created_at,
            listing:listing_items!listing_id (
                title, player_name, images, series_name
            )
        `)
        .eq('seller_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching seller orders:', error);
        return [];
    }

    return data.map((order: any) => ({
        ...order,
        listing: Array.isArray(order.listing) ? order.listing[0] : order.listing
    }));
}

/**
 * Fetch All Orders for Buyer
 */
export async function getBuyerOrders() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];

    const { data, error } = await getAdminClient()
        .from('orders')
        .select(`
            id,
            status,
            total_amount,
            created_at,
            listing:listing_items!listing_id (
                title, player_name, images, series_name
            )
        `)
        .eq('buyer_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching buyer orders:', error);
        return [];
    }

    return data.map((order: any) => ({
        ...order,
        listing: Array.isArray(order.listing) ? order.listing[0] : order.listing
    }));
}
</file>

<file path="frontend/app/actions/payout.ts">
'use server';

import { createClient } from '../../utils/supabase/server';
import { Payout, SalesHistoryItem } from '../../types';

import { Resend } from 'resend';
import { PayoutRequestEmail } from '../../components/emails/PayoutRequestEmail';
import { ReactElement } from 'react';

// Legacy constant - deprecated, use getCurrentFeeRate() instead
// const PLATFORM_FEE_PERCENTAGE = 0.1;
const resend = new Resend(process.env.RESEND_API_KEY);

/**
 * 現在適用される手数料率を取得する。
 * 将来的にはキャンペーンテーブル参照やユーザーランク別の料率に拡張可能。
 * 現時点では環境変数 PLATFORM_FEE_RATE（デフォルト0.10）を使用。
 */
export async function getCurrentFeeRate(): Promise<number> {
    const envRate = process.env.PLATFORM_FEE_RATE;
    if (envRate) {
        const parsed = parseFloat(envRate);
        if (!isNaN(parsed) && parsed >= 0 && parsed <= 1) {
            return parsed;
        }
    }
    return 0.10; // デフォルト10%
}

/**
 * Logic A: Calculate Available Balance
 * 個別取引の net_earnings を積み上げて計算（一律掛け算ではない）
 */
export async function getAvailableBalance(userId: string) {
    const supabase = await createClient();

    // 1. 完了済み注文から net_earnings を個別に取得して合算
    const { data: soldOrders, error: soldError } = await supabase
        .from('orders')
        .select('total_amount, platform_fee, net_earnings')
        .eq('seller_id', userId)
        .eq('status', 'completed');

    if (soldError) throw new Error(soldError.message);

    const totalSoldAmount = soldOrders?.reduce((sum, o) => sum + (o.total_amount || 0), 0) || 0;
    const totalFees = soldOrders?.reduce((sum, o) => sum + (o.platform_fee || 0), 0) || 0;
    // 個別の net_earnings を積み上げる（一律掛け算ではない）
    const totalEarnings = soldOrders?.reduce((sum, o) => sum + (o.net_earnings || 0), 0) || 0;

    // 2. 出金済み/申請中の合計
    const { data: payouts, error: payoutError } = await supabase
        .from('payouts')
        .select('amount, status')
        .eq('user_id', userId)
        .neq('status', 'rejected');

    if (payoutError) throw new Error(payoutError.message);

    const totalPayouts = payouts?.reduce((sum, p) => sum + p.amount, 0) || 0;

    return {
        totalSold: totalSoldAmount,    // 総販売額
        totalFees: totalFees,          // 手数料合計
        totalEarnings: totalEarnings,  // 純収益合計（個別積み上げ）
        withdrawn: totalPayouts,
        available: totalEarnings - totalPayouts,
        orderCount: soldOrders?.length || 0,  // 取引件数
    };
}

/**
 * Update Profile Real Name (Kana)
 */
export async function updateProfileKana(userId: string, kana: string) {
    const supabase = await createClient();

    // Sanitize: Remove all spaces (half/full width)
    const sanitizedKana = kana.replace(/[\s\u3000]+/g, '');

    // Validate Kana (Katakana Only)
    const kanaRegex = /^[\u30A0-\u30FF]+$/;
    if (!kanaRegex.test(sanitizedKana)) {
        throw new Error('Real name must be in full-width Katakana.');
    }

    const { error } = await supabase
        .from('profiles')
        .update({ real_name_kana: sanitizedKana })
        .eq('id', userId);

    if (error) throw new Error(error.message);
    return { success: true };
}

/**
 * Logic B: Register Bank Account
 * Enforces KYC Name Match
 */
export async function registerBankAccount(userId: string, bankData: {
    bankName: string;
    bankCode?: string;
    branchName: string;
    branchCode?: string;
    accountType: 'ordinary' | 'current';
    accountNumber: string;
    accountHolderName?: string; // Optional from client, we override
}) {
    const supabase = await createClient();

    // 1. Get User Profile for Kata Name
    const { data: profile } = await supabase
        .from('profiles')
        .select('real_name_kana')
        .eq('id', userId)
        .single();

    if (!profile || !profile.real_name_kana) {
        throw new Error("Profile name (Katakana) is required.");
    }

    // 2. Validate Kana Match (Implicitly enforced by OVERRIDING the input)
    // We ignore bankData.accountHolderName and use profile.real_name_kana
    // Sanitize spaces just in case
    const safeHolderName = profile.real_name_kana.replace(/[\s\u3000]+/g, '');

    const { error } = await supabase
        .from('bank_accounts')
        .upsert({
            user_id: userId,
            bank_name: bankData.bankName,
            bank_code: bankData.bankCode,
            branch_name: bankData.branchName,
            branch_code: bankData.branchCode,
            account_type: bankData.accountType,
            account_number: bankData.accountNumber,
            account_holder_name: safeHolderName,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' });

    if (error) {
        console.error('Bank Reg Error:', error);
        throw new Error(error.message || 'Failed to register bank account.');
    }
    return { success: true };
}

const WITHDRAWAL_FEE = 250;
const FEE_EXEMPTION_THRESHOLD = 30000;

/**
 * Logic C: Request Payout
 */
export async function requestPayout(userId: string, netAmount: number) {
    const supabase = await createClient();

    if (netAmount <= 0) throw new Error('Invalid amount.');

    // 0. Verify Bank Account Exists
    const bankAccount = await getBankAccount(userId);
    if (!bankAccount) {
        throw new Error('Please register a bank account before requesting a payout.');
    }

    // 1. Calculate Fee based on Net Amount
    // Rule: If Net Payout is >= 30,000, Fee is 0.
    let fee = WITHDRAWAL_FEE;
    if (netAmount >= FEE_EXEMPTION_THRESHOLD) {
        fee = 0;
    }

    const grossAmount = netAmount + fee; // Total Deduction from Balance

    // 2. Check Balance against Gross Amount
    const balance = await getAvailableBalance(userId);
    if (balance.available < grossAmount) {
        throw new Error(`Insufficient balance. You need ¥${grossAmount.toLocaleString()} (Amount + Fee) but have ¥${balance.available.toLocaleString()}.`);
    }

    // 3. Create Payout Record
    const { error } = await supabase
        .from('payouts')
        .insert({
            user_id: userId,
            amount: grossAmount,     // Total Balance Deduction
            fee: fee,
            payout_amount: netAmount, // Actual Transfer Amount
            status: 'pending'
        });

    if (error) throw new Error(error.message);

    // 4. Send Notification to Admins
    if (process.env.ADMIN_EMAILS) {
        try {
            const adminEmails = process.env.ADMIN_EMAILS.split(',').map(e => e.trim());
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

            // Fetch User Name for Email
            const { data: profile } = await supabase
                .from('profiles')
                .select('name')
                .eq('id', userId)
                .single();

            const userName = profile?.name || 'Unknown User';

            const fromEmail = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev';
            await resend.emails.send({
                from: `Stadium Card <${fromEmail}>`,
                to: adminEmails,
                subject: 'New Payout Request',
                react: PayoutRequestEmail({
                    userName,
                    amount: netAmount,
                    payoutId: 'New', // We don't have ID easily unless we select it back. Using generic label.
                    adminUrl: `${baseUrl}/admin/payouts`
                }) as ReactElement
            });
        } catch (emailErr) {
            console.error("Failed to send admin notification:", emailErr);
            // Non-blocking error
        }
    }

    return { success: true };
}

/**
 * Fetch Payout History
 */
export async function getPayoutHistory(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('payouts')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data as Payout[];
}

/**
 * Fetch Registered Bank Account
 */
export async function getBankAccount(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('bank_accounts')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') throw new Error(error.message); // Ignore "not found"
    return data;
}

/**
 * Fetch Profile Kana
 */
export async function getProfileKana(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('profiles')
        .select('real_name_kana')
        .eq('id', userId)
        .single();

    if (error) return null;
    return data?.real_name_kana;
}

/**
 * 完了済み取引の個別販売履歴を取得する。
 * 各取引に記録された手数料率・手数料額をそのまま返す（後計算しない）。
 */
export async function getSalesHistory(userId: string): Promise<SalesHistoryItem[]> {
    const supabase = await createClient();

    const { data, error } = await supabase
        .from('orders')
        .select(`
            id,
            total_amount,
            fee_rate,
            platform_fee,
            net_earnings,
            status,
            created_at,
            completed_at,
            listing:listing_items!listing_id (
                id,
                player_name,
                images,
                series_name,
                manufacturer,
                year
            )
        `)
        .eq('seller_id', userId)
        .eq('status', 'completed')
        .order('completed_at', { ascending: false });

    if (error) throw new Error(error.message);

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    return (data || []).map((order: any) => {
        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        return {
            orderId: order.id,
            saleAmount: order.total_amount,
            feeRate: order.fee_rate ?? 0.10,
            platformFee: order.platform_fee ?? 0,
            netEarning: order.net_earnings ?? 0,
            completedAt: order.completed_at || order.created_at,
            listing: listing ? {
                id: listing.id,
                playerName: listing.player_name,
                image: listing.images?.[0] || null,
                seriesName: listing.series_name,
                manufacturer: listing.manufacturer,
                year: listing.year,
            } : null,
        };
    });
}
</file>

<file path="frontend/app/actions/send-email.ts">
'use server';

import { resend } from '../../lib/resend';
import WelcomeEmail from '../../components/emails/WelcomeEmail';
import { ReactElement } from 'react';

/**
 * Sends a welcome email to the specified user.
 * @param email - Recipient email address
 * @param name - User's name (optional)
 */
export async function sendWelcomeEmail(email: string, name: string = 'Member') {
    try {
        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

        const { data, error } = await resend.emails.send({
            from: 'Stadium Card <onboarding@resend.dev>', // Update this to your verified domain in production
            to: [email],
            subject: 'Welcome to Stadium Card',
            react: WelcomeEmail({ userFirstname: name, baseUrl }) as ReactElement,
        });

        if (error) {
            console.error('Email sending failed:', error);
            return { success: false, error: error.message };
        }

        return { success: true, data };
    } catch (e) {
        console.error('Unexpected error sending email:', e);
        return { success: false, error: 'Internal Server Error' };
    }
}
</file>

<file path="frontend/app/admin/moments/DeleteMomentButton.tsx">
'use client';

import { deleteLiveMoment } from '@/app/actions/admin';
import { useFormStatus } from 'react-dom';

export default function DeleteMomentButton({ id }: { id: string }) {
    return (
        <form action={deleteLiveMoment.bind(null, id)}>
            <DeleteButtonInner />
        </form>
    );
}

function DeleteButtonInner() {
    const { pending } = useFormStatus();

    return (
        <button
            type="submit"
            disabled={pending}
            className="text-xs text-red-500 hover:text-red-400 flex items-center gap-1 disabled:opacity-50"
            onClick={(e) => {
                if (!confirm('本当に削除しますか？')) e.preventDefault();
            }}
        >
            {pending ? '削除中...' : '🗑️ 削除'}
        </button>
    );
}
</file>

<file path="frontend/app/admin/moments/MomentForm.tsx">
'use client';

import { useState, useActionState, useEffect } from 'react';
import { createClient } from '@/utils/supabase/client';
import { createLiveMoment, updateLiveMoment } from '@/app/actions/admin';
import { TEAM_GROUPS } from '@/lib/teams';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';
import Image from 'next/image';

type MomentFormProps = {
    editingMoment?: any;
    defaultValues: {
        player: string;
        title: string;
        desc: string;
        intensity: string;
        visitor: string;
        home: string;
        scoreV: string;
        scoreH: string;
        progress: string;
        type: string;
    };
    isAutoFilled?: boolean;
};

export default function MomentForm({ editingMoment, defaultValues, isAutoFilled }: MomentFormProps) {
    const [isGenerating, setIsGenerating] = useState(false);
    const [generatedImage, setGeneratedImage] = useState<string | null>(null); // Base64
    const [isUploading, setIsUploading] = useState(false);
    const [uploadError, setUploadError] = useState<string | null>(null);

    // AI Text Draft State
    const [isDrafting, setIsDrafting] = useState(false);
    const [draftKeywords, setDraftKeywords] = useState("");

    // Form State (Controlled for AI Auto-fill)
    const [playerName, setPlayerName] = useState(editingMoment?.player_name || defaultValues.player);
    const [title, setTitle] = useState(editingMoment?.title || defaultValues.title);
    const [type, setType] = useState(editingMoment?.type || (defaultValues.type || 'BIG_PLAY'));
    const [intensity, setIntensity] = useState(editingMoment?.intensity || defaultValues.intensity || "3");
    const [description, setDescription] = useState(editingMoment?.description || defaultValues.desc);

    // Auto-scroll to generate button if auto-filled
    useEffect(() => {
        if (isAutoFilled && !editingMoment) {
            const btn = document.getElementById('generate-btn');
            if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, [isAutoFilled, editingMoment]);

    const handleAiDraft = async () => {
        setIsDrafting(true);
        try {
            // Combine inputs for context
            const contextKeywords = [
                playerName,
                type,
                draftKeywords
            ].filter(Boolean).join(", ");

            const res = await fetch('/api/ai/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords: contextKeywords }),
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            // Auto-fill fields
            if (data.title) setTitle(data.title);
            if (data.desc) setDescription(data.desc);
            if (data.intensity) setIntensity(String(data.intensity));

        } catch (e: any) {
            alert(`AI Draft Error: ${e.message}`);
        } finally {
            setIsDrafting(false);
        }
    };

    const handleGenerate = async () => {
        if (!description) {
            alert("画像生成には「詳細説明」が必要です。");
            return;
        }
        setIsGenerating(true);
        setGeneratedImage(null);
        try {
            const res = await fetch('/api/ai/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: description }),
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            setGeneratedImage(`data:image/png;base64,${data.b64_json}`);
        } catch (e: any) {
            alert(`生成エラー: ${e.message}`);
        } finally {
            setIsGenerating(false);
        }
    };

    const handleSubmit = async (formData: FormData) => {
        setIsUploading(true);
        setUploadError(null);

        try {
            let imageUrl = editingMoment?.image_url || null;

            // If we have a new generated image, upload it
            if (generatedImage) {
                const supabase = createClient();
                const blob = await (await fetch(generatedImage)).blob();
                const fileExt = 'png';
                const fileName = `generated-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError, data } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, blob, {
                        contentType: 'image/png',
                        upsert: false
                    });

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                imageUrl = publicUrl;
            }

            if (imageUrl) {
                formData.append('imageUrl', imageUrl);
            }

            // Call Server Action
            if (editingMoment) {
                await updateLiveMoment(editingMoment.id, formData);
            } else {
                await createLiveMoment(formData);
            }

            // Reset only if successful create (update keeps user on page usually, but our action redirects/revalidates)
            // Ideally we'd reset state if we stay, but the server action revalidates path.

        } catch (e: any) {
            console.error(e);
            setUploadError(e.message);
            setIsUploading(false); // Stop loading on error
            return; // Don't proceed
        }

        setIsUploading(false);
    };

    return (
        <form action={handleSubmit} className="space-y-4">
            {uploadError && (
                <div className="bg-red-500/10 border border-red-500 text-red-400 p-3 rounded text-sm">
                    {uploadError}
                </div>
            )}

            {/* Player Name */}
            <div>
                <label className="block text-sm text-gray-400 mb-1">選手名 (Player Name)</label>
                <input
                    name="playerName"
                    required
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="例: 大谷翔平 / Shohei Ohtani"
                />
            </div>

            {/* AI Text Generation Control */}
            <div className="bg-gray-800/50 p-3 rounded border border-gray-700/50 flex flex-col gap-2">
                <div className="flex gap-2 items-center">
                    <input
                        value={draftKeywords}
                        onChange={(e) => setDraftKeywords(e.target.value)}
                        placeholder="AI生成用キーワード (例: 甲子園, 場外弾, 逆転サヨナラ)"
                        className="flex-1 bg-black/50 border border-white/20 rounded px-3 py-2 text-white text-sm focus:border-[#FFD700] outline-none"
                    />
                    <button
                        type="button"
                        onClick={handleAiDraft}
                        disabled={isDrafting}
                        className="bg-teal-600 hover:bg-teal-500 text-white text-sm font-bold px-4 py-2 rounded flex items-center gap-2 transition-colors whitespace-nowrap"
                    >
                        {isDrafting ? <Loader2 className="w-4 h-4 animate-spin" /> : '✨ AI Draft (Claude)'}
                    </button>
                </div>
                <p className="text-[10px] text-gray-500">
                    ※ 選手名とキーワードから、タイトル・説明・熱狂度を自動生成します。
                </p>
            </div>

            <div>
                <label className="block text-sm text-gray-400 mb-1">タイトル (Title)</label>
                <input
                    name="title"
                    required
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="例: Walk-off Home Run"
                />
            </div>

            {/* Match Status */}
            <div className="bg-black/30 p-3 rounded border border-white/10 space-y-3">
                <label className="block text-sm text-gray-400 -mb-2">試合状況 (Match Status)</label>

                {/* Visitor */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">ビジター</span>
                    <select
                        name="teamVisitor"
                        required
                        defaultValue={defaultValues.visitor}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="">チーム選択...</option>
                        {TEAM_GROUPS.map((group) => (
                            <optgroup key={group.label} label={group.label}>
                                {group.teams.map((team) => (
                                    <option key={team.code} value={team.code}>{team.name}</option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                    <input
                        name="scoreVisitor"
                        type="number"
                        min="0"
                        placeholder="0"
                        defaultValue={defaultValues.scoreV}
                        className="w-16 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center focus:border-[#FFD700]"
                    />
                </div>

                {/* Home */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">ホーム</span>
                    <select
                        name="teamHome"
                        required
                        defaultValue={defaultValues.home}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="">チーム選択...</option>
                        {TEAM_GROUPS.map((group) => (
                            <optgroup key={group.label} label={group.label}>
                                {group.teams.map((team) => (
                                    <option key={team.code} value={team.code}>{team.name}</option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                    <input
                        name="scoreHome"
                        type="number"
                        min="0"
                        placeholder="0"
                        defaultValue={defaultValues.scoreH}
                        className="w-16 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center focus:border-[#FFD700]"
                    />
                </div>

                {/* Progress */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">進行</span>
                    <select
                        name="progress"
                        defaultValue={editingMoment ? defaultValues.progress : (defaultValues.progress || 'Top 1st')}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="Top 1st">Top 1st (1回表)</option>
                        <option value="Bot 1st">Bot 1st (1回裏)</option>
                        <option value="Top 2nd">Top 2nd (2回表)</option>
                        <option value="Bot 2nd">Bot 2nd (2回裏)</option>
                        <option value="Top 3rd">Top 3rd (3回表)</option>
                        <option value="Bot 3rd">Bot 3rd (3回裏)</option>
                        <option value="Top 4th">Top 4th (4回表)</option>
                        <option value="Bot 4th">Bot 4th (4回裏)</option>
                        <option value="Top 5th">Top 5th (5回表)</option>
                        <option value="Bot 5th">Bot 5th (5回裏)</option>
                        <option value="Top 6th">Top 6th (6回表)</option>
                        <option value="Bot 6th">Bot 6th (6回裏)</option>
                        <option value="Top 7th">Top 7th (7回表)</option>
                        <option value="Bot 7th">Bot 7th (7回裏)</option>
                        <option value="Top 8th">Top 8th (8回表)</option>
                        <option value="Bot 8th">Bot 8th (8回裏)</option>
                        <option value="Top 9th">Top 9th (9回表)</option>
                        <option value="Bot 9th">Bot 9th (9回裏)</option>
                        <option value="Top 10th">Top 10th (10回表)</option>
                        <option value="Bot 10th">Bot 10th (10回裏)</option>
                        <option value="Top 11th">Top 11th (11回表)</option>
                        <option value="Bot 11th">Bot 11th (11回裏)</option>
                        <option value="Top 12th">Top 12th (12回表)</option>
                        <option value="Bot 12th">Bot 12th (12回裏)</option>
                        <option value="Final">Final (試合終了)</option>
                    </select>
                </div>
            </div>

            <div>
                <label className="block text-sm text-gray-400 mb-1">イベントタイプ (Type)</label>
                <select
                    name="type"
                    value={type}
                    onChange={(e) => setType(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                >
                    <option value="HOMERUN">ホームラン (Homerun)</option>
                    <option value="STRIKEOUT">奪三振 (Strikeout)</option>
                    <option value="TIMELY">タイムリー/長打 (Timely/Hit)</option>
                    <option value="VICTORY">勝利 (Victory)</option>
                    <option value="RECORD_BREAK">記録達成 (Record Breaker)</option>
                    <option value="BIG_PLAY">好プレー/その他 (Big Play)</option>
                </select>
            </div>
            <div>
                <label className="block text-sm text-gray-400 mb-1">熱狂度 (Intensity 1-5)</label>
                <select
                    name="intensity"
                    value={intensity}
                    onChange={(e) => setIntensity(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                >
                    <option value="5">5 - Legendary (伝説級)</option>
                    <option value="4">4 - High (高)</option>
                    <option value="3">3 - Medium (中)</option>
                    <option value="2">2 - Low (低)</option>
                    <option value="1">1 - Minimal (最小)</option>
                </select>
            </div>
            <div>
                <label className="block text-sm text-gray-400 mb-1">詳細説明 (Description)</label>
                <textarea
                    name="description"
                    rows={5}
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="試合の文脈や詳細など..."
                />
            </div>

            {/* AI Image Generation Section */}
            <div className={`border rounded-lg p-4 transition-colors ${isAutoFilled ? 'border-purple-500/50 bg-purple-900/10' : 'border-white/10 bg-white/5'}`}>
                <div className="flex justify-between items-center mb-4">
                    <label className="text-sm font-bold text-gray-300 flex items-center gap-2">
                        <span>🖼️ カードアート (Card Art)</span>
                        {isAutoFilled && <span className="text-[10px] bg-purple-500 text-white px-2 py-0.5 rounded-full">Recommended</span>}
                    </label>
                </div>

                {/* Generated Image Preview */}
                {(generatedImage || editingMoment?.image_url) && (
                    <div className="mb-4 relative w-full aspect-square max-w-sm mx-auto rounded overflow-hidden border border-white/20">
                        <Image
                            src={generatedImage || editingMoment.image_url}
                            alt="Card Art"
                            fill
                            className="object-cover"
                        />
                        {generatedImage && (
                            <div className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                Preview (Unsaved)
                            </div>
                        )}
                    </div>
                )}

                <button
                    id="generate-btn"
                    type="button"
                    onClick={handleGenerate}
                    disabled={isGenerating || !description}
                    className={`w-full py-2 rounded font-bold text-sm flex items-center justify-center gap-2 transition-all
                        ${isGenerating ? 'bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-900/50'}
                    `}
                >
                    {isGenerating ? (
                        <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Generating Art...
                        </>
                    ) : (
                        <>
                            <span>⚡ Generate Card Art (DALL-E 3)</span>
                        </>
                    )}
                </button>
                <p className="text-[10px] text-gray-500 mt-2 text-center">
                    ※ 生成には数秒かかります。気に入るまで何度でも再生成可能です。<br />
                    保存時に自動的にアップロードされます。
                </p>
            </div>

            <button
                type="submit"
                disabled={isUploading}
                className={`w-full font-bold py-3 rounded transition-colors flex items-center justify-center gap-2
                    ${editingMoment ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-[#FFD700] hover:bg-[#F0C000] text-black'}
                    ${isUploading ? 'opacity-70 cursor-wait' : ''}
                `}
            >
                {isUploading && <Loader2 className="w-4 h-4 animate-spin" />}
                {editingMoment ? '変更を保存 (Update)' : 'モーメントを発行 (Broadcast)'}
            </button>
        </form>
    );
}
</file>

<file path="frontend/app/admin/moments/page.tsx">
import { createClient } from '@supabase/supabase-js';
import { finalizeMoment } from '@/app/actions/admin';
import { TEAM_GROUPS } from '@/lib/teams';
import Link from 'next/link';
import DeleteMomentButton from './DeleteMomentButton';
import MomentForm from './MomentForm';

// Admin Client for fetching list
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export default async function AdminMomentsPage({
    searchParams,
}: {
    searchParams: { [key: string]: string | string[] | undefined };
}) {
    // Handle searchParams safely
    const params = await searchParams;
    const editId = typeof params?.edit === 'string' ? params.edit : null;

    // Fetch list
    const { data: momentsData } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(20);

    // Fetch usage counts (N+1 tolerated for Admin UI)
    const moments = await Promise.all((momentsData || []).map(async (m) => {
        const { count } = await supabaseAdmin
            .from('listing_items')
            .select('id', { count: 'exact', head: true })
            .contains('moment_history', JSON.stringify([{ moment_id: m.id }]));
        return { ...m, usageCount: count || 0 };
    }));

    // Fetch editing item if needed
    let editingMoment = null;
    if (editId) {
        const { data } = await supabaseAdmin
            .from('live_moments')
            .select('*')
            .eq('id', editId)
            .single();
        editingMoment = data;
    }

    // Parse existing match result to pre-fill detailed fields if editing
    // match_result format example: "LAD 5 - 3 NYY (Top 9th)"
    let defaultVisitor = "";
    let defaultHome = "";
    let defaultScoreV = "";
    let defaultScoreH = "";
    let defaultProgress = "";

    // External Parameters (Auto-fill)
    const extPlayer = typeof params?.player === 'string' ? params.player : '';
    const extTitle = typeof params?.title === 'string' ? params.title : '';
    const extDesc = typeof params?.desc === 'string' ? params.desc : '';
    const extIntensity = typeof params?.intensity === 'string' ? params.intensity : '3';
    const extVisitor = typeof params?.visitor === 'string' ? params.visitor : '';
    const extHome = typeof params?.home === 'string' ? params.home : '';
    const extVisitorScore = typeof params?.visitorScore === 'string' ? params.visitorScore : '';
    const extHomeScore = typeof params?.homeScore === 'string' ? params.homeScore : '';
    // User requested defaults for these:
    // User requested defaults for these:
    const extType = typeof params?.type === 'string' ? params.type : '';
    const extProgress = typeof params?.progress === 'string' ? params.progress : '';

    // Check if any *meaningful* params are present for the banner (checking keys directly avoids default vals triggering it)
    const hasExternalParams = !editId && (
        !!params?.player || !!params?.title || !!params?.desc ||
        !!params?.visitor || !!params?.home ||
        !!params?.visitorScore || !!params?.homeScore ||
        !!params?.progress || !!params?.type
    );

    const isAutoFilled = hasExternalParams;

    if (editingMoment?.match_result) {
        try {
            const regex = /^(.+?)\s+(\d+)\s+-\s+(\d+)\s+(.+?)\s+\((.+)\)$/;
            const match = editingMoment.match_result.match(regex);
            if (match) {
                defaultVisitor = match[1];
                defaultScoreV = match[2];
                defaultScoreH = match[3];
                defaultHome = match[4];
                defaultProgress = match[5];
            }
        } catch (e) {
            console.error("Failed to parse match result", e);
        }
    } else if (isAutoFilled) {
        // Apply external params if valid
        console.log('[AutoFill] Applying external params:', { extVisitor, extHome, extProgress });
        defaultVisitor = extVisitor;
        defaultHome = extHome;
        defaultScoreV = extVisitorScore;
        defaultScoreH = extHomeScore;
        defaultProgress = extProgress;
    }

    return (
        <div className="p-8">
            <h2 className="text-2xl font-bold mb-6">ライブモーメント管理 (Live Matches)</h2>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Form Section */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-6 h-fit">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`text-lg font-bold ${editingMoment ? 'text-blue-400' : 'text-[#FFD700]'}`}>
                            {editingMoment ? 'イベント登録情報の修正' : '新規イベント登録'}
                        </h3>
                        {isAutoFilled && (
                            <div className="ml-4 flex items-center gap-1 bg-purple-900/40 border border-purple-500/30 text-purple-300 text-xs px-2 py-1 rounded animate-pulse w-fit">
                                <span>⚡</span>
                                <span>外部データから自動入力</span>
                            </div>
                        )}
                        {editingMoment && (
                            <Link href="/admin/moments" className="text-xs text-gray-400 hover:text-white border border-gray-600 px-2 py-1 rounded">
                                キャンセル
                            </Link>
                        )}
                    </div>

                    <MomentForm
                        editingMoment={editingMoment}
                        defaultValues={{
                            player: extPlayer,
                            title: extTitle,
                            desc: extDesc,
                            intensity: extIntensity,
                            visitor: defaultVisitor,
                            home: defaultHome,
                            scoreV: defaultScoreV,
                            scoreH: defaultScoreH,
                            progress: defaultProgress,
                            type: extType
                        }}
                        isAutoFilled={isAutoFilled}
                    />
                </div>

                {/* List Section */}
                <div>
                    <h3 className="text-lg font-bold mb-4 text-gray-300">履歴ログ (History)</h3>
                    <div className="space-y-3">
                        {moments?.map((m: any) => (
                            <div key={m.id} className={`bg-white/5 border p-4 rounded flex justify-between items-start ${editingMoment?.id === m.id ? 'border-blue-500/50 bg-blue-900/10' : 'border-white/10'}`}>
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="font-bold text-[#FFD700]">{m.player_name}</div>
                                        <div className="text-xs bg-white/10 px-1.5 py-0.5 rounded text-gray-300">{m.type}</div>
                                        {/* Usage Badge */}
                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${m.usageCount > 0 ? 'bg-green-900/40 border-green-500/50 text-green-400' : 'bg-gray-800 border-gray-600 text-gray-500'}`}>
                                            配布数: {m.usageCount || 0}枚
                                        </span>
                                    </div>
                                    <div className="text-sm text-white font-medium">{m.title}</div>
                                    {m.match_result && (
                                        <div className="text-xs text-gray-400 mt-0.5">
                                            {m.match_result}
                                            {m.is_finalized && <span className="ml-2 text-green-400 font-bold">✓ 終了済</span>}
                                        </div>
                                    )}
                                    <div className="text-xs text-gray-500 mt-1">{new Date(m.created_at).toLocaleString('ja-JP')}</div>

                                    {/* Action Buttons */}
                                    <div className="mt-3 flex items-center gap-3">
                                        {m.usageCount > 0 ? (
                                            <div title="配布済み(使用中)のため編集不可" className="flex items-center gap-2 text-gray-500 cursor-not-allowed border border-transparent px-2 py-0.5">
                                                <span className="text-xs">🔒</span>
                                                <span className="text-xs">使用中 (不可)</span>
                                            </div>
                                        ) : (
                                            <>
                                                <Link
                                                    href={`/admin/moments?edit=${m.id}`}
                                                    scroll={false}
                                                    className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 border border-blue-500/30 px-2 py-0.5 rounded hover:bg-blue-500/10 transition-colors"
                                                >
                                                    ✏️ 編集
                                                </Link>

                                                <DeleteMomentButton id={m.id} />
                                            </>
                                        )}
                                    </div>

                                    {/* Finalize Form for Pending Moments */}
                                    {!m.is_finalized && (
                                        <form action={finalizeMoment.bind(null, m.id)} className="mt-2 pt-2 border-t border-white/5 flex items-center gap-2">
                                            <input
                                                name="finalScore"
                                                required
                                                placeholder="最終スコア (例: 5-3)"
                                                defaultValue={m.match_result || ''}
                                                className="bg-black/30 border border-white/10 rounded px-2 py-1 text-xs text-white w-32 focus:border-[#FFD700] outline-none"
                                            />
                                            <button type="submit" className="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded transition-colors">
                                                試合終了を記録
                                            </button>
                                        </form>
                                    )}
                                </div>
                                <div className="ml-4 flex flex-col items-end gap-2">
                                    <div className="bg-white/10 px-2 py-1 rounded text-xs font-mono whitespace-nowrap">
                                        Lvl {m.intensity}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {moments?.length === 0 && (
                            <div className="text-gray-500 text-sm">記録されたモーメントはありません。</div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/admin/payouts/page.tsx">
import { createClient } from '@supabase/supabase-js';
import { approvePayout } from '@/app/actions/admin';
import PayoutRow from './PayoutRow';

// Admin Client
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export default async function AdminPayoutsPage() {
    // Join logic is tricky with Supabase JS client basic syntax.
    // We fetch payouts and then manually join profiles/bank accounts or use foreign key query syntax.
    // 'payouts' has 'user_id'. 
    // We need bank acocunt info. 'bank_accounts' is 1:1 with user usually.

    // Fetch payouts
    const { data: payoutsRaw, error } = await supabaseAdmin
        .from('payouts')
        .select('*')
        .eq('status', 'pending')
        .order('created_at', { ascending: true });

    if (error) {
        console.error("Payout Fetch Error:", error);
    }

    // Manual Join to avoid Relation constraints with auth.users
    const payouts = payoutsRaw || [];
    const userIds = Array.from(new Set(payouts.map((p: any) => p.user_id)));

    let profilesMap: Record<string, any> = {};
    let banksMap: Record<string, any> = {};

    if (userIds.length > 0) {
        const { data: profiles } = await supabaseAdmin
            .from('profiles')
            .select('id, email, name')
            .in('id', userIds);

        const { data: banks } = await supabaseAdmin
            .from('bank_accounts')
            .select('*')
            .in('user_id', userIds);

        profiles?.forEach((p: any) => profilesMap[p.id] = p);
        banks?.forEach((b: any) => banksMap[b.user_id] = b);
    }


    return (
        <div className="p-8">
            <h2 className="text-2xl font-bold mb-6">Payout Manager</h2>

            <div className="overflow-x-auto rounded-xl border border-white/10">
                <table className="w-full text-left text-sm">
                    <thead className="bg-white/5 text-gray-400 uppercase font-medium">
                        <tr>
                            <th className="px-6 py-4">User</th>
                            <th className="px-6 py-4">Bank Details</th>
                            <th className="px-6 py-4 text-right">Amount (Yen)</th>
                            <th className="px-6 py-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-white/10 bg-black/20">
                        {payouts.map((p: any) => {
                            // Determine fee logic (Display only, assume DB amount is net or gross? p.amount usually is requested amount)
                            // We should probably display it clearly.
                            // For simplicity, just listing raw data.

                            // Bank account might be an array if using foreign key linking with 'user_id' which is not FK on bank_accounts directly?
                            // Wait, bank_accounts.user_id references auth.users. Payouts.user_id references auth.users.
                            // Supabase Query: `bank_accounts:user_id` might return array because it thinks it's 1:N unless unique constraint is clear.
                            // The schema says `bank_accounts_user_id_key UNIQUE`, so it should be single object or array of 1.

                            const bank = banksMap[p.user_id];
                            const profile = profilesMap[p.user_id];

                            return (
                                <PayoutRow key={p.id} payout={p} profile={profile} bank={bank} />
                            );
                        })}
                        {payouts?.length === 0 && (
                            <tr>
                                <td colSpan={4} className="px-6 py-8 text-center text-gray-500">
                                    No pending payouts.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/admin/payouts/PayoutRow.tsx">
'use client';

import { useState } from 'react';
import { approvePayout } from '@/app/actions/admin';

interface PayoutRowProps {
    payout: any;
    profile: any;
    bank: any;
}

export default function PayoutRow({ payout, profile, bank }: PayoutRowProps) {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isProcessing, setIsProcessing] = useState(false);

    const handleApprove = async () => {
        if (!confirm('Are you sure you want to mark this as PAID?')) return;
        setIsProcessing(true);
        try {
            await approvePayout(payout.id);
            // Server action revalidates path, so UI will update (row disappears)
        } catch (e) {
            alert('Error: ' + e);
            setIsProcessing(false);
        }
    };

    return (
        <>
            <tr className="hover:bg-white/5 transition-colors cursor-pointer group" onClick={() => setIsModalOpen(true)}>
                <td className="px-6 py-4">
                    <div className="font-bold text-white group-hover:text-[#FFD700] transition-colors">{profile?.name || 'Unknown'}</div>
                    <div className="text-gray-500 text-xs">{profile?.email}</div>
                    <div className="text-gray-500 text-xs font-mono mt-1">{payout.user_id}</div>
                </td>
                <td className="px-6 py-4 text-gray-300">
                    {bank ? (
                        <>
                            <div>{bank.bank_name}</div>
                            <div className="text-xs text-gray-500">{bank.account_holder_name}</div>
                        </>
                    ) : (
                        <span className="text-red-500">No Bank Info</span>
                    )}
                </td>
                <td className="px-6 py-4 text-right font-mono text-lg">
                    ¥{payout.amount.toLocaleString()}
                </td>
                <td className="px-6 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                    {bank ? (
                        <button
                            onClick={handleApprove}
                            disabled={isProcessing}
                            className="bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white px-4 py-2 rounded text-xs font-bold uppercase tracking-wide transition-colors"
                        >
                            {isProcessing ? 'Processing...' : 'Mark Paid'}
                        </button>
                    ) : (
                        <span className="text-red-500 font-bold text-xs uppercase border border-red-500 px-2 py-1 rounded">
                            Bank Info Missing
                        </span>
                    )}
                </td>
            </tr>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={() => setIsModalOpen(false)}>
                    <div className="bg-[#111] border border-white/20 rounded-xl p-8 max-w-lg w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-[#FFD700] mb-6 border-b border-white/10 pb-4">Payout Details</h3>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Transfer Amount</label>
                                <div className="text-3xl font-mono font-bold text-white">¥{payout.amount.toLocaleString()}</div>
                            </div>

                            <div className="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Bank Name</label>
                                        <div className="text-lg text-white font-bold">{bank?.bank_name}</div>
                                        {bank?.bank_code && <div className="text-xs text-gray-400 font-mono">{bank.bank_code}</div>}
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Branch Name</label>
                                        <div className="text-lg text-white font-bold">{bank?.branch_name}</div>
                                        {bank?.branch_code && <div className="text-xs text-gray-400 font-mono">{bank.branch_code}</div>}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Type</label>
                                        <div className="text-white capitalize">{bank?.account_type === 'current' ? '当座' : '普通'}</div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Number</label>
                                        <div className="text-xl font-mono text-white tracking-widest">{bank?.account_number}</div>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Holder (Kana)</label>
                                    <div className="text-xl text-[#FFD700] font-bold tracking-wider">{bank?.account_holder_name}</div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">User Info</label>
                                <div className="text-sm text-gray-300">
                                    {profile?.name} <span className="text-gray-500">({profile?.email})</span>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 flex justify-end space-x-4">
                            <button
                                onClick={() => setIsModalOpen(false)}
                                className="px-4 py-2 rounded text-sm font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors"
                            >
                                Close
                            </button>
                            <button
                                onClick={() => {
                                    setIsModalOpen(false);
                                    handleApprove();
                                }}
                                disabled={isProcessing}
                                className="bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition-all"
                            >
                                Confirm Payment
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}
</file>

<file path="frontend/app/admin/layout.tsx">
import Link from 'next/link';
import { createClient } from '@/utils/supabase/server';
import { redirect } from 'next/navigation';

export default async function AdminLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    // Double check (Middleware should catch this, but safe to have)
    const adminEmails = (process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || '').split(/[,;|]+/).map(e => e.trim());
    if (!user || !user.email || !adminEmails.some(email => email.toLowerCase() === user.email?.toLowerCase())) {
        redirect('/');
    }

    return (
        <div className="min-h-screen bg-neutral-900 text-white flex flex-col md:flex-row">
            {/* Admin Sidebar */}
            <aside className="w-full md:w-64 bg-black border-b md:border-b-0 md:border-r border-white/10 flex-shrink-0">
                <div className="p-6 border-b border-white/10 flex justify-between items-center md:block">
                    <h1 className="text-xl font-bold tracking-wider text-[#FFD700]">ADMIN PANEL</h1>
                    <div className="md:hidden text-[10px] text-gray-500 text-right">
                        Logged in as:<br />
                        <span className="text-gray-300 truncate w-32 block">{user.email}</span>
                    </div>
                </div>
                <nav className="p-4 flex md:block space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto md:overflow-x-visible">
                    <Link href="/admin" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Dashboard
                    </Link>
                    <Link href="/admin/moments" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Live Moments
                    </Link>
                    <Link href="/admin/payouts" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Payouts
                    </Link>
                </nav>
                <div className="hidden md:block absolute bottom-0 w-64 p-4 border-t border-white/10">
                    <div className="text-xs text-gray-500">
                        Logged in as:<br />
                        <span className="text-gray-300 truncate block">{user.email}</span>
                    </div>
                    <Link href="/" className="mt-4 block text-center py-2 px-4 border border-white/20 rounded text-sm hover:bg-white/10 transition-colors">
                        Back to Site
                    </Link>
                </div>
            </aside>

            {/* Main Content */}
            <main className="flex-1 overflow-auto">
                {children}
            </main>
        </div>
    );
}
</file>

<file path="frontend/app/admin/page.tsx">
import Link from 'next/link';
import { createClient } from '@/utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';
import { createLiveMoment, finalizeMoment } from '@/app/actions/admin';

// Need admin client for global stats if RLS restricts (e.g. counting total users)
const getAdminClient = () => {
    return createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

export default async function AdminDashboard() {
    const supabaseAdmin = getAdminClient();

    // 1. Total Users
    const { count: userCount } = await supabaseAdmin
        .from('profiles')
        .select('*', { count: 'exact', head: true });

    // 2. Active Listings
    const { count: listingCount } = await supabaseAdmin
        .from('listing_items')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'Active');

    // 3. Pending Payouts
    const { count: payoutCount } = await supabaseAdmin
        .from('payouts')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'pending');

    // 4. Recent Moments (History)
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(5);

    return (
        <div className="p-4 md:p-8 space-y-10">
            <h2 className="text-2xl font-bold mb-6">Admin Control Panel</h2>

            {/* KPI Section */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Users</h3>
                    <p className="text-4xl font-mono font-bold text-white mt-2">{userCount ?? '-'}</p>
                </div>
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Active Listings</h3>
                    <p className="text-4xl font-mono font-bold text-[#FFD700] mt-2">{listingCount ?? '-'}</p>
                </div>
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Pending Payouts</h3>
                    <p className="text-4xl font-mono font-bold text-red-500 mt-2">{payoutCount ?? '-'}</p>
                </div>
            </div>

            {/* Event Registration Section (Live Moments) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg className="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 className="text-xl font-bold mb-6 text-[#FFD700] flex items-center gap-2">
                        <span>Live Moment / Event Registration</span>
                    </h3>

                    <form action={createLiveMoment} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 uppercase tracking-tighter">Player Name</label>
                                <input name="playerName" required className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none" placeholder="e.g. Shohei Ohtani" />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 uppercase tracking-tighter">Event Title</label>
                                <input name="title" required className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none" placeholder="e.g. 50-50 Achievement" />
                            </div>
                        </div>

                        <div className="bg-black/30 p-3 rounded border border-white/10 space-y-3">
                            <label className="block text-[10px] text-gray-400 mb-1 uppercase">Match Status / Live Score</label>
                            <div className="flex gap-2">
                                <select name="teamVisitor" required className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                    <option value="">Visitor Team</option>
                                    <option value="LAD">LAD (Dodgers)</option>
                                    <option value="NYY">NYY (Yankees)</option>
                                    <option value="SD">SD (Padres)</option>
                                    <option value="JPN">Samurai Japan</option>
                                </select>
                                <input name="scoreVisitor" type="number" min="0" placeholder="0" className="w-12 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center" />
                                <span className="text-gray-500">vs</span>
                                <input name="scoreHome" type="number" min="0" placeholder="0" className="w-12 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center" />
                                <select name="teamHome" required className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                    <option value="">Home Team</option>
                                    <option value="LAD">LAD (Dodgers)</option>
                                    <option value="NYY">NYY (Yankees)</option>
                                    <option value="SD">SD (Padres)</option>
                                    <option value="JPN">Samurai Japan</option>
                                </select>
                            </div>
                            <select name="progress" className="w-full bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                <option value="Top 1st">Top 1st</option>
                                <option value="Final">Final (試合終了)</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Impact Level (1-5)</label>
                            <input type="range" name="intensity" min="1" max="5" defaultValue="3" className="w-full accent-[#FFD700]" />
                        </div>

                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Details</label>
                            <textarea name="description" rows={3} className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none text-sm" placeholder="Additional context..." />
                        </div>

                        <button type="submit" className="w-full bg-gradient-to-r from-[#FFD700] to-[#F0B000] text-black font-black py-4 rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all shadow-lg shadow-[#FFD700]/10">
                            BROADCAST EVENT
                        </button>
                    </form>
                </div>

                {/* History Quick-View */}
                <div>
                    <h3 className="text-xl font-bold mb-6 text-gray-300">Recent Events</h3>
                    <div className="space-y-3">
                        {moments?.map((m: any) => (
                            <div key={m.id} className="bg-white/5 border border-white/10 p-4 rounded-xl flex justify-between items-start">
                                <div>
                                    <div className="font-bold text-[#FFD700]">{m.player_name}</div>
                                    <div className="text-sm text-white">{m.title}</div>
                                    <div className="text-[10px] text-gray-500 mt-1">{new Date(m.created_at).toLocaleString()}</div>
                                </div>
                                <div className="text-right">
                                    <div className="bg-white/10 px-2 py-1 rounded text-[10px] font-bold">LVL {m.intensity}</div>
                                    {m.is_finalized && <span className="text-green-400 text-[10px] font-bold mt-1 block">✓ FINAL</span>}
                                </div>
                            </div>
                        ))}
                        <Link href="/admin/moments" className="block text-center py-2 text-xs text-gray-500 hover:text-white transition-colors">
                            View all event history →
                        </Link>
                    </div>

                    <div className="mt-8 p-6 bg-red-500/5 border border-red-500/10 rounded-2xl">
                        <h4 className="text-red-500 font-bold mb-2">Payout Queue</h4>
                        <p className="text-sm text-gray-400">There are currently <span className="text-white font-bold">{payoutCount ?? 0}</span> payout requests pending review.</p>
                        <Link href="/admin/payouts" className="inline-block mt-4 text-xs font-bold bg-red-500/10 text-red-500 px-4 py-2 rounded-full border border-red-500/20 hover:bg-red-500/20">
                            Process Payouts →
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/api/ai/image/route.ts">
import { NextResponse } from 'next/server';
import OpenAI from 'openai';

// Initialize OpenAI client
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export const maxDuration = 60; // Allow 60 seconds (DALL-E can be slow)
export const dynamic = 'force-dynamic';

export async function POST(req: Request) {
    try {
        const { prompt } = await req.json();

        if (!prompt) {
            return NextResponse.json({ error: 'Prompt is required' }, { status: 400 });
        }

        if (!process.env.OPENAI_API_KEY) {
            return NextResponse.json({ error: 'OpenAI API Key is missing' }, { status: 500 });
        }

        console.log('Generating image for prompt:', prompt);

        // 1. Common Base Style
        const baseStyle = [
            "Premium high-end trading card digital illustration",
            "hyper-realistic art style rendered from a photograph",
            "player wearing full professional uniform", // ユニフォーム着用は絶対
            "authentic professional baseball mechanics",
            "dynamic stadium night lighting",
            "subtle energy particle effects",
            "ultra-detailed texture",
            "masterpiece",
            "8k resolution"
        ].join(", ");

        // 2. Role Detection & Action Specification
        const lowerPrompt = prompt.toLowerCase();
        let role = 'generic';
        let actionKeywords = "";

        // Basic keyword matching
        if (lowerPrompt.includes('pitch') || lowerPrompt.includes('strikeout') || lowerPrompt.includes('strike out') || lowerPrompt.includes('mound') || lowerPrompt.includes('save') || lowerPrompt.includes('throw')) {
            role = 'pitcher';
            actionKeywords = "Pitching action, on the mound, throwing a baseball, holding a ball in hand (NO BAT), dynamic pitching form, athletic posture";
        } else if (lowerPrompt.includes('catch') || lowerPrompt.includes('diving') || lowerPrompt.includes('defense') || lowerPrompt.includes('field') || lowerPrompt.includes('glove')) {
            role = 'fielder';
            actionKeywords = "Fielding action, catching a ball with baseball glove, diving play, defensive stance, wearing a baseball glove (NO BAT)";
        } else {
            // Default to Batter for hits, homeruns, or generic
            role = 'batter';
            actionKeywords = "Batting action, swinging a baseball bat, holding a bat with both hands, hitting a ball, dynamic swing, athletic batting stance";
        }

        console.log(`Detected Role: ${role} for prompt: "${prompt}"`);

        const enhancedPrompt = `${baseStyle}. ${actionKeywords}. Context: ${prompt}`;

        const response = await openai.images.generate({
            model: "dall-e-3",
            prompt: enhancedPrompt,
            n: 1,
            size: "1024x1024",
            response_format: "b64_json",
            quality: "standard", // "hd" is more expensive, standard is fine for preview -> compress
        });

        const image = response.data?.[0];

        if (!image?.b64_json) {
            throw new Error("No b64_json received from OpenAI");
        }

        return NextResponse.json({ b64_json: image.b64_json });

    } catch (error: any) {
        console.error("AI Image Generation Error:", error);
        return NextResponse.json(
            { error: error?.message || 'Failed to generate image' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/ai/text/route.ts">
import { NextResponse } from 'next/server';
import Anthropic from '@anthropic-ai/sdk';

export const maxDuration = 60;
export const dynamic = 'force-dynamic';

export async function POST(req: Request) {
    try {
        const { keywords } = await req.json();

        if (!keywords) {
            return NextResponse.json({ error: 'Keywords are required' }, { status: 400 });
        }

        if (!process.env.ANTHROPIC_API_KEY) {
            return NextResponse.json({ error: 'Anthropic API Key is missing' }, { status: 500 });
        }

        const anthropic = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
        });

        const systemPrompt = `
あなたはプロ野球トレーディングカードの敏腕編集者です。
ユーザーから提供されたキーワードを元に、ファンが熱狂し、購買意欲をそそるようなテキストを作成してください。
出力は必ずJSON形式のみとしてください。
        `;

        const userPrompt = `
Target Keywords: "${keywords}"

以下の要件でコンテンツを作成してください：
1. Title: 20文字以内の劇的でキャッチーなタイトル。体言止め推奨。
2. Desc: 60文字程度の状況描写。情景が浮かぶようなエモーショナルな表現で。
3. Intensity: 1〜5の熱量スコア（5が最高）。

Response format (JSON only):
{ "title": "...", "desc": "...", "intensity": "..." }
        `;

        const msg = await anthropic.messages.create({
            model: "claude-sonnet-4-5-20250929", // Latest confirmed working model
            max_tokens: 1000,
            temperature: 0.7,
            system: systemPrompt,
            messages: [
                {
                    "role": "user",
                    "content": userPrompt
                }
            ]
        });

        const content = msg.content[0];
        if (content.type !== 'text') {
            throw new Error('Unexpected response type from Claude');
        }

        // Extract JSON from response (in case of extra text)
        const jsonMatch = content.text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('Failed to parse JSON from Claude response');
        }

        const result = JSON.parse(jsonMatch[0]);

        return NextResponse.json(result);

    } catch (error: any) {
        console.error("AI Text Generation Error:", error);
        return NextResponse.json(
            { error: error?.message || 'Failed to generate text' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/analyze-card/route.ts">
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { generateObject } from 'ai';
import { z } from 'zod';

const google = createGoogleGenerativeAI({
    apiKey: process.env.GOOGLE_GENERATIVE_AI_API_KEY,
});

export async function POST(req: Request) {
    try {
        const { image } = await req.json();

        if (!image) {
            return new Response('No image provided', { status: 400 });
        }

        // Remove data URL prefix if present (e.g., "data:image/jpeg;base64,")
        const base64Image = image.replace(/^data:image\/[a-z]+;base64,/, '');

        const fieldSchema = z.object({
            value: z.string().nullable(),
            confidence: z.enum(['High', 'Medium', 'Low']),
            reason: z.string().optional().describe('Short reason for the confidence level.'),
        });

        const { object } = await generateObject({
            // Using generic alias for best availability
            model: google('gemini-flash-latest'),

            schema: z.object({
                playerName: fieldSchema.describe('Full name of the player. STRICT RULE: For Japanese players, you MUST output the name in "Kanji (Romaji)" format (e.g. "大谷翔平 (Shohei Ohtani)").'),
                team: fieldSchema.describe('Team name.'),
                year: fieldSchema.describe('Year of the card.'),
                brand: fieldSchema.describe('Card manufacturer/brand.'),
                cardNumber: fieldSchema.describe('Card number.'),

                // Features
                variation: fieldSchema.describe('Variation name or parallel type (e.g. "Pink Refractor", "Gold", "Base").'),
                parallelType: fieldSchema.describe('Specific parallel color/type if applicable (e.g. "Orange", "Camo", "Cracked Ice"). Null if base.'),
                isRefractor: fieldSchema.describe('Is this a Refractor/Chrome/Shiny card? "true" or "false".'),
                serialNumber: fieldSchema.describe('Serial number if visible (e.g. 10/50).'),

                isRookie: fieldSchema.describe('Is this a Rookie Card (RC)? "true" or "false".'),

                isAutograph: fieldSchema.describe('Is this an Autographed card? "true" or "false".'),
                autographType: fieldSchema.describe('Type of autograph: "On-Card", "Sticker", or "Facsimile" (printed). Null if no auto.'),

                // Grading
                isGraded: fieldSchema.describe('Is the card encased/graded? "true" or "false".'),
                gradingCompany: fieldSchema.describe('Grading company name (PSA, BGS, SGC, CGC) if graded.'),
                grade: fieldSchema.describe('Grade score (e.g. 10, 9.5, Gem Mint).'),

                condition: fieldSchema.describe('Condition if raw/ungraded (e.g. Near Mint).'),
            }),
            messages: [
                {
                    role: 'user',
                    content: [
                        { type: 'text', text: 'Analyze this baseball card. Extract details precisely. \n1. **Parallel/Variation**: Look carefully for colors (Orange, Blue, Gold) and texture (Refractor, Wave, Mojo). \n2. **Autograph**: Distinction between real auto (ink) and facsimile (printed) is crucial. \n3. **Japanese Players**: ALWAYS output "Kanji (Romaji)" format. Example: "山本由伸 (Yoshinobu Yamamoto)". \n4. **Booleans**: Output "true"/"false" as strings.' },
                        { type: 'image', image: base64Image },
                    ],
                },
            ],
        });

        return Response.json(object);
    } catch (error: any) {
        console.error('Gemini Analysis Error:', error);
        return new Response(JSON.stringify({ error: error.message }), { status: 500 });
    }
}
</file>

<file path="frontend/app/api/checkout/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '../../../lib/stripe';
import { createClient } from '../../../utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';

export async function POST(req: NextRequest) {
    try {
        const { listingId, returnUrl, shippingDetails } = await req.json();
        const supabase = await createClient();

        // 1. Auth Check
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // 2. Fetch Listing Details
        const { data: listing, error: listingError } = await supabase
            .from('listing_items')
            .select('*')
            .eq('id', listingId)
            .single();

        if (listingError || !listing) {
            return NextResponse.json({ error: 'Listing not found' }, { status: 404 });
        }

        if (listing.status !== 'Active') {
            return NextResponse.json({ error: 'Listing is not active' }, { status: 400 });
        }

        if (listing.seller_id === user.id) {
            return NextResponse.json({ error: 'Cannot purchase your own listing' }, { status: 400 });
        }

        // 2.5 Fetch Active Live Moment (Snapshot)
        // Check for moments in the last 1 hour
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
        const { data: recentMoments } = await supabase
            .from('live_moments')
            .select('*')
            .gt('created_at', oneHourAgo);

        // Filter by Player Name (Fuzzy Match)
        const listingPlayer = (listing.player_name || '').toLowerCase();

        const matchedMoments = recentMoments?.filter(m => {
            const momentPlayer = (m.player_name || '').toLowerCase();
            return listingPlayer.includes(momentPlayer) || momentPlayer.includes(listingPlayer);
        }).sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()) || [];

        // Snapshot ALL matched moments (Multiple Moments Support)
        const momentSnapshot = matchedMoments.length > 0 ? matchedMoments : null;

        // 3. Create or Reuse Pending Order
        // Build Admin Client for cross-user reservation check
        const supabaseAdmin = createAdminClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_ROLE_KEY!
        );

        // Check for any order for this listing that is effectively "locked"
        // Statuses that block a new checkout: pending, paid, awaiting_shipping, shipped
        const { data: activeOrders, error: fetchOrderError } = await supabaseAdmin
            .from('orders')
            .select('*')
            .eq('listing_id', listingId)
            .in('status', ['pending', 'paid', 'awaiting_shipping', 'shipped']);

        if (fetchOrderError) {
            console.error('Fetch Order Error:', fetchOrderError);
        }

        const existingMyOrder = activeOrders?.find(o => o.buyer_id === user.id);
        const someoneElseActiveOrder = activeOrders?.find(o => o.buyer_id !== user.id);

        let order = null;

        if (someoneElseActiveOrder) {
            // If someone else has an active transaction (pending or paid), we are blocked.
            const errorMsg = ['paid', 'awaiting_shipping', 'shipped'].includes(someoneElseActiveOrder.status)
                ? 'This item has already been sold.'
                : 'Item is currently in a transaction.';
            return NextResponse.json({ error: errorMsg }, { status: 400 });
        }

        if (existingMyOrder) {
            // If we have a pending order, we reuse it.
            // Update shipping details AND refresh moment snapshot
            const updateData: any = {
                moment_snapshot: momentSnapshot
            };

            if (shippingDetails) {
                updateData.shipping_name = shippingDetails.name;
                updateData.shipping_postal_code = shippingDetails.postalCode;
                updateData.shipping_address = shippingDetails.address;
                updateData.shipping_phone = shippingDetails.phone;
            }

            await supabaseAdmin.from('orders').update(updateData).eq('id', existingMyOrder.id);
            order = { ...existingMyOrder, ...updateData };
        } else {
            // No active order for us. Create a new one.
            // 手数料率の取得と計算（環境変数ベース）
            const feeRate = parseFloat(process.env.PLATFORM_FEE_RATE || '0.10');
            const platformFee = Math.floor(listing.price * feeRate);
            const netEarnings = listing.price - platformFee;

            const { data: newOrder, error: insertError } = await supabaseAdmin
                .from('orders')
                .insert({
                    listing_id: listingId,
                    buyer_id: user.id,
                    seller_id: listing.seller_id,
                    payment_method_id: 'stripe_checkout',
                    total_amount: listing.price,
                    fee_rate: feeRate,
                    platform_fee: platformFee,
                    net_earnings: netEarnings,
                    status: 'pending',
                    shipping_name: shippingDetails?.name,
                    shipping_postal_code: shippingDetails?.postalCode,
                    shipping_address: shippingDetails?.address,
                    shipping_phone: shippingDetails?.phone,
                    moment_snapshot: momentSnapshot
                })
                .select()
                .single();

            if (insertError) {
                if (insertError.code === '23505') {
                    return NextResponse.json({ error: 'Item is currently reserved by another user.' }, { status: 409 });
                }
                console.error('Order creation failed:', insertError);
                return NextResponse.json({
                    error: `Failed to create order record: ${insertError.message}`
                }, { status: 500 });
            }
            order = newOrder;
        }

        // 4. Create Stripe Checkout Session
        const session = await stripe.checkout.sessions.create({
            mode: 'payment',
            payment_method_types: ['card'],
            line_items: [
                {
                    price_data: {
                        currency: 'jpy',
                        product_data: {
                            name: `${listing.player_name || 'Card'}`,
                            description: `${listing.series_name || ''} (#${listing.card_number || '---'})`,
                            images: listing.images && listing.images.length > 0 ? [listing.images[0]] : [],
                            metadata: {
                                listing_id: listingId,
                            }
                        },
                        unit_amount: listing.price,
                    },
                    quantity: 1,
                },
            ],
            metadata: {
                userId: user.id,
                listingId: listingId,
                orderId: order.id, // Store our internal order ID to update it later
            },
            success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/orders/${order.id}/success?session_id={CHECKOUT_SESSION_ID}`,
            cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/checkout/${listingId}?canceled=true`,
        });

        return NextResponse.json({ url: session.url });
    } catch (err: any) {
        console.error('Stripe Checkout Error:', err);
        return NextResponse.json({ error: err.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/debug/config/route.ts">
import { NextResponse } from 'next/server';

export const dynamic = 'force-dynamic';

export async function GET() {
    const backendUrl = process.env.BACKEND_URL;
    return NextResponse.json({
        backend_url_configured: !!backendUrl,
        backend_url_value: backendUrl || 'NOT_SET (Defaults to localhost)',
        node_env: process.env.NODE_ENV
    });
}
</file>

<file path="frontend/app/api/debug-auth/route.ts">
import { createClient } from '@/utils/supabase/server';
import { NextResponse } from 'next/server';

export async function GET() {
    try {
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();

        const adminEmailsRaw = process.env.ADMIN_EMAILS || '';
        const publicAdminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || '';
        const adminEmails = adminEmailsRaw.split(',').map(e => e.trim().toLowerCase()).filter(Boolean);

        const userEmail = user?.email?.toLowerCase() || '';
        const isAdmin = userEmail ? adminEmails.includes(userEmail) : false;

        return NextResponse.json({
            status: 'success',
            diagnostics: {
                currentUser: user?.email || 'Guest',
                isAdmin,
                adminCount: adminEmails.length,
                // We don't return the full list for security, but we return a hint
                adminListHint: adminEmails.map(e => e[0] + '***' + e.split('@')[1]).join(', '),
                envSet: {
                    ADMIN_EMAILS: !!process.env.ADMIN_EMAILS,
                    NEXT_PUBLIC_ADMIN_EMAILS: !!process.env.NEXT_PUBLIC_ADMIN_EMAILS,
                    SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY
                }
            }
        });
    } catch (error: any) {
        return NextResponse.json({
            status: 'error',
            message: error.message
        }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/debug-email/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function POST(req: NextRequest) {
    if (!process.env.RESEND_API_KEY) {
        return NextResponse.json({ error: 'RESEND_API_KEY is missing' }, { status: 500 });
    }

    try {
        const { email } = await req.json();

        if (!email) {
            return NextResponse.json({ error: 'Email is required' }, { status: 400 });
        }

        const { data, error } = await resend.emails.send({
            from: 'Stadium Card <onboarding@resend.dev>',
            to: [email],
            subject: 'Debug Email Test',
            html: '<p>This is a test email from Stadium Card Debug Endpoint.</p>'
        });

        if (error) {
            console.error('Debug Email Error:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            success: true,
            data,
            message: `Email sent to ${email} (from onboarding@resend.dev). Note: In Test Mode, you can only send to your own authenticated email.`
        });

    } catch (err: any) {
        console.error('Debug Endpoint Error:', err);
        return NextResponse.json({ error: err.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/dev/moment/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const MOMENT_TEMPLATES = [
    { title: '165km/h Fastball', desc: 'Japanese Record Speed!', intensity: 5, type: 'RECORD_BREAK' },
    { title: 'Dramatic Walk-off HR', desc: 'Bottom of the 9th, 2 outs.', intensity: 5, type: 'HOMERUN' },
    { title: 'Spectacular Diving Catch', desc: 'Saved the game!', intensity: 4, type: 'BIG_PLAY' },
    { title: '3000th Strikeout', desc: 'Legendary achievement.', intensity: 5, type: 'BIG_PLAY' },
    { title: 'Perfect Game Bid', desc: '8th inning completed.', intensity: 5, type: 'BIG_PLAY' }
];

const PLAYERS = ['Roki Sasaki', 'Shohei Ohtani', 'Munetaka Murakami'];

export async function POST() {
    if (process.env.NODE_ENV === 'production') {
        return NextResponse.json({ error: 'Not allowed in production' }, { status: 403 });
    }

    try {
        const template = MOMENT_TEMPLATES[Math.floor(Math.random() * MOMENT_TEMPLATES.length)];
        const playerName = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];

        const { data, error } = await supabase
            .from('live_moments')
            .insert({
                title: `${playerName}: ${template.title}`,
                description: template.desc,
                player_name: playerName,
                intensity: template.intensity,
                type: template.type,
                is_finalized: false
            })
            .select()
            .single();

        if (error) throw error;

        return NextResponse.json({ success: true, moment: data });
    } catch (error: any) {
        console.error('Failed to create dev moment:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/estimate-price/route.ts">
import { NextRequest, NextResponse } from 'next/server';

// ============================================================
// Types
// ============================================================

interface EstimatePriceRequest {
    playerName: string;
    year?: string;
    brand?: string;
    cardNumber?: string;
    variation?: string;
    isAutograph?: boolean;
    isGraded?: boolean;
    grade?: string;
}

interface RecentSale {
    title: string;
    price: number;
    currency: string;
    soldDate: string;
    condition?: string;
}

interface EstimatePriceResponse {
    estimatedPriceRange: {
        min: number;
        max: number;
        currency: string;
    };
    recentSales: RecentSale[];
    dataSource: 'ebay' | 'mock';
    searchQuery: string;
}

// ============================================================
// eBay API Integration
// ============================================================

async function getEbayAccessToken(): Promise<string | null> {
    const clientId = process.env.EBAY_CLIENT_ID;
    const clientSecret = process.env.EBAY_CLIENT_SECRET;

    if (!clientId || !clientSecret) {
        return null;
    }

    try {
        const credentials = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
        const response = await fetch('https://api.ebay.com/identity/v1/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': `Basic ${credentials}`,
            },
            body: 'grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope',
        });

        if (!response.ok) {
            console.error('eBay OAuth failed:', await response.text());
            return null;
        }

        const data = await response.json();
        return data.access_token;
    } catch (error) {
        console.error('eBay OAuth error:', error);
        return null;
    }
}

async function searchEbaySoldListings(
    query: string,
    accessToken: string
): Promise<{ sales: RecentSale[]; priceRange: { min: number; max: number } } | null> {
    try {
        // eBay Browse API - Search for completed/sold items
        const searchUrl = new URL('https://api.ebay.com/buy/browse/v1/item_summary/search');
        searchUrl.searchParams.set('q', query);
        searchUrl.searchParams.set('filter', 'buyingOptions:{AUCTION},soldItems:true');
        searchUrl.searchParams.set('limit', '10');
        searchUrl.searchParams.set('sort', '-endDate');

        const response = await fetch(searchUrl.toString(), {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'X-EBAY-C-MARKETPLACE-ID': 'EBAY_US',
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            console.error('eBay Search failed:', await response.text());
            return null;
        }

        const data = await response.json();
        const items = data.itemSummaries || [];

        if (items.length === 0) {
            return null;
        }

        const sales: RecentSale[] = items.slice(0, 5).map((item: any) => ({
            title: item.title,
            price: parseFloat(item.price?.value || '0'),
            currency: item.price?.currency || 'USD',
            soldDate: item.itemEndDate || new Date().toISOString(),
            condition: item.condition,
        }));

        const prices = sales.map(s => s.price).filter(p => p > 0);
        const min = Math.min(...prices);
        const max = Math.max(...prices);

        return { sales, priceRange: { min, max } };
    } catch (error) {
        console.error('eBay Search error:', error);
        return null;
    }
}

// ============================================================
// Mock Data Generator
// ============================================================

function generateMockData(request: EstimatePriceRequest): EstimatePriceResponse {
    const { playerName, year, brand, variation, isAutograph, isGraded, grade } = request;

    // Base price calculation based on card attributes
    let basePrice = 1000; // ¥1,000 base

    // Famous players get higher prices
    const famousPlayers = ['ohtani', '大谷', 'trout', 'judge', 'soto', 'acuna'];
    const isTopPlayer = famousPlayers.some(p =>
        playerName.toLowerCase().includes(p)
    );
    if (isTopPlayer) basePrice *= 5;

    // Recent cards (2020+) are generally more valuable
    const cardYear = parseInt(year || '2020');
    if (cardYear >= 2020) basePrice *= 1.5;

    // Premium variations
    const premiumVariations = ['refractor', 'gold', 'auto', 'parallel', 'chrome'];
    const isPremium = premiumVariations.some(v =>
        (variation || '').toLowerCase().includes(v) ||
        (brand || '').toLowerCase().includes(v)
    );
    if (isPremium) basePrice *= 2;

    // Autograph premium
    if (isAutograph) basePrice *= 3;

    // Graded premium
    if (isGraded) {
        basePrice *= 1.5;
        const gradeNum = parseFloat(grade || '9');
        if (gradeNum >= 10) basePrice *= 2;
        else if (gradeNum >= 9.5) basePrice *= 1.5;
    }

    // Add variance for realistic range
    const min = Math.round(basePrice * 0.7);
    const max = Math.round(basePrice * 1.3);

    // Generate mock recent sales
    const mockSales: RecentSale[] = [];
    const baseDate = new Date();
    const conditions = ['PSA 10', 'PSA 9', 'BGS 9.5', 'Raw NM', 'Raw EX'];

    for (let i = 0; i < 5; i++) {
        const saleDate = new Date(baseDate);
        saleDate.setDate(saleDate.getDate() - (i * 3 + Math.floor(Math.random() * 5)));

        const salePrice = min + Math.random() * (max - min);

        mockSales.push({
            title: `${year || '2024'} ${brand || 'Topps'} ${playerName} ${variation || 'Base'} #${Math.floor(Math.random() * 300) + 1}`,
            price: Math.round(salePrice),
            currency: 'JPY',
            soldDate: saleDate.toISOString(),
            condition: conditions[i % conditions.length],
        });
    }

    return {
        estimatedPriceRange: { min, max, currency: 'JPY' },
        recentSales: mockSales,
        dataSource: 'mock',
        searchQuery: buildSearchQuery(request),
    };
}

// ============================================================
// Helpers
// ============================================================

function buildSearchQuery(request: EstimatePriceRequest): string {
    const parts = [
        request.playerName,
        request.year,
        request.brand,
        request.variation,
    ].filter(Boolean);

    if (request.isAutograph) parts.push('autograph');
    if (request.isGraded && request.grade) parts.push(request.grade);

    return parts.join(' ');
}

// ============================================================
// API Handler
// ============================================================

export async function POST(req: NextRequest) {
    try {
        const body: EstimatePriceRequest = await req.json();

        if (!body.playerName) {
            return NextResponse.json(
                { error: 'playerName is required' },
                { status: 400 }
            );
        }

        const searchQuery = buildSearchQuery(body);

        // Try eBay API first
        const accessToken = await getEbayAccessToken();

        if (accessToken) {
            const ebayResult = await searchEbaySoldListings(searchQuery, accessToken);

            if (ebayResult && ebayResult.sales.length > 0) {
                return NextResponse.json({
                    estimatedPriceRange: {
                        ...ebayResult.priceRange,
                        currency: 'USD',
                    },
                    recentSales: ebayResult.sales,
                    dataSource: 'ebay',
                    searchQuery,
                } as EstimatePriceResponse);
            }
        }

        // Fallback to mock data
        console.log('Using mock data for price estimation (eBay API not configured or no results)');
        const mockResponse = generateMockData(body);

        return NextResponse.json(mockResponse);
    } catch (error: any) {
        console.error('Price Estimation Error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/ping/route.ts">
import { NextResponse } from 'next/server';

export async function GET() {
    return NextResponse.json({ message: 'Pong' });
}
</file>

<file path="frontend/app/api/webhooks/stripe/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '../../../../lib/stripe';
import { headers } from 'next/headers';
import Stripe from 'stripe';
import { Resend } from 'resend';
import { ReactElement } from 'react';
import ShippingRequestEmail from '../../../../components/emails/ShippingRequestEmail';
import OrderConfirmationEmail from '../../../../components/emails/OrderConfirmationEmail';
import { createClient as createSupabaseClient } from '@supabase/supabase-js';

const resend = new Resend(process.env.RESEND_API_KEY!);

// This is required for the webhook to receive the raw body
// Not needed in App Router since we consume req.text() directly? 
// Actually, standard Next.js API routes needed bodyParser: false. 
// App Router handlers receive Request, we can read body.

export async function POST(req: NextRequest) {
    const body = await req.text();
    const headersList = await headers();
    const signature = headersList.get('stripe-signature');

    if (!signature) {
        return NextResponse.json({ error: 'Missing stripe-signature' }, { status: 400 });
    }

    let event: Stripe.Event;

    try {
        event = stripe.webhooks.constructEvent(
            body,
            signature,
            process.env.STRIPE_WEBHOOK_SECRET!
        );
        console.log(`[Webhook] Signature verified. Event Type: ${event.type}`);
    } catch (err: any) {
        console.error(`[Webhook] Signature verification failed: ${err.message}`);
        return NextResponse.json({ error: 'Webhook Error' }, { status: 400 });
    }

    // Handle the event
    if (event.type === 'checkout.session.completed') {
        const session = event.data.object as Stripe.Checkout.Session;

        // Retrieve metadata
        const md = session.metadata;
        console.log('[Webhook] Session Metadata:', md);

        const orderId = md?.orderId;
        const listingId = md?.listingId;

        if (!orderId || !listingId) {
            console.error('Webhook metadata missing orderId or listingId');
            return NextResponse.json({ error: 'Metadata missing' }, { status: 400 });
        }


        console.log(`Processing Order ${orderId} for Listing ${listingId}`);

        // 1. Update Order Status to 'paid'
        // Need to use service_role key ideally to bypass RLS if user is not logged in context?
        // Webhook is server-to-server. 'createClient()' uses cookie based auth usually.
        // HERE IS A PROBLEM: 'createClient' from utils/supabase/server relies on cookies.
        // Webhook requests DO NOT have user cookies.
        // We MUST use a Supabase Admin Client (Service Role) here.

        // I need to instantiate a Supabase client with SERVICE_ROLE_KEY.
        // Since I don't have a dedicated utility for admin client yet, I will create one inline or add to utils.
        // User has `process.env.SUPABASE_SERVICE_ROLE_KEY`? Usually yes in Supabase projects.
        // I'll check env vars later, but assuming standard setup.

        // Wait, I cannot see `utils/supabase/server.ts` imports easily to check if it supports admin.
        // I'll stick to creating a fresh client via `createClient` from `@supabase/supabase-js`.
        // I need to import `createClient` from package, not the helper.

        // 5. Create Admin Client
        if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
            console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
            return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });
        }

        const supabaseAdmin = createSupabaseClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_ROLE_KEY!
        );

        // Update Order
        const { error: orderError } = await supabaseAdmin
            .from('orders')
            .update({
                status: 'paid',
                payment_method_id: session.payment_intent as string || 'stripe'
            })
            .eq('id', orderId);

        if (orderError) {
            console.error('Error updating order:', orderError);
            return NextResponse.json({ error: 'DB Error' }, { status: 500 });
        }

        // 2. Fetch Listing, Active Moment & Order Data
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

        // Parallel fetch: Listing + Active Moments + Order (for buyer_id)
        const [listingResult, momentsResult, orderResult] = await Promise.all([
            supabaseAdmin
                .from('listing_items')
                .select('*') // Select all for cloning
                .eq('id', listingId)
                .single(),
            supabaseAdmin
                .from('live_moments')
                .select('*')
                .gt('created_at', oneHourAgo)
                .order('created_at', { ascending: false }),
            supabaseAdmin
                .from('orders')
                .select('id, moment_snapshot, buyer_id')
                .eq('id', orderId)
                .single()
        ]);

        const listingData = listingResult.data;
        const recentMoments = momentsResult.data || [];
        const currentOrder = orderResult.data;

        if (listingResult.error || !listingData || !currentOrder) {
            console.error('Error fetching data for cloning/moment matching:', listingResult.error || orderResult.error);
            return NextResponse.json({ error: 'DB Fetch Error' }, { status: 500 });
        }

        // 5. Transfer Ownership (Persistent ID Model)
        // Instead of cloning, we update the existing item's seller_id to the buyer_id
        // and set status to AwaitingShipment.
        const buyerId = currentOrder.buyer_id;
        const listing = listingData; // Rename for clarity in new logic
        console.log(`[Webhook] Transferring item ${listing.id} to buyer ${buyerId}`);

        const { error: transferError } = await supabaseAdmin
            .from('listing_items')
            .update({
                seller_id: buyerId,
                status: 'AwaitingShipment',
                origin_order_id: orderId, // Link for status tracking
                updated_at: new Date().toISOString()
            })
            .eq('id', listing.id);

        if (transferError) {
            console.error('[Webhook] CRITICAL: Failed to transfer ownership:', transferError.message);
            // We don't return 500 here because the payment was successful, 
            // but we need to track this failure.
        } else {
            console.log(`[Webhook] Successfully transferred ownership of item ${listing.id} to ${buyerId}`);
        }

        // 6. Record Seller in Order (For History)
        // Update the order with the original seller's ID before it was changed.
        const { error: orderUpdateError } = await supabaseAdmin
            .from('orders')
            .update({ seller_id: listing.seller_id })
            .eq('id', orderId);

        if (orderUpdateError) {
            console.error('[Webhook] Failed to record seller_id in order:', orderUpdateError.message);
        }

        // 7. Moment Syncing (Now on the transferred item)
        // Prefer captured snapshot from the order, fallback to live lookup ONLY if snapshot is missing
        let momentsToRecord = [];
        if (currentOrder.moment_snapshot) {
            console.log(`[Webhook Sync] Using captured snapshot (${Array.isArray(currentOrder.moment_snapshot) ? currentOrder.moment_snapshot.length : 1} moments) for item ${listing.id}`);
            momentsToRecord = Array.isArray(currentOrder.moment_snapshot) ? currentOrder.moment_snapshot : [currentOrder.moment_snapshot];
        } else {
            console.log(`[Webhook Sync] No snapshot found in order ${orderId}. Falling back to live lookup.`);
            const listingPlayer = (listing.player_name || '').toLowerCase();
            momentsToRecord = recentMoments.filter(m => {
                const momentPlayer = (m.player_name || '').toLowerCase();
                return listingPlayer.includes(momentPlayer) || momentPlayer.includes(listingPlayer);
            });
        }

        // Prepare History for Transferred Item
        const originalHistory = Array.isArray(listingData.moment_history) ? listingData.moment_history : [];

        // Filter out moments that are already present in the history (prevent duplicates from self-healing)
        const uniqueMomentsToRecord = momentsToRecord.filter(nm =>
            !originalHistory.some((oh: any) => (oh.moment_id === nm.id) || (oh.id === nm.id))
        );

        const newHistoryItems = uniqueMomentsToRecord.map(m => ({
            moment_id: m.id,
            timestamp: new Date().toISOString(),
            title: m.title,
            player_name: m.player_name,
            intensity: m.intensity,
            description: m.description,
            match_result: m.match_result,
            owner_at_time: orderId,
            status: m.is_finalized ? 'finalized' : 'pending'
        }));

        const fullBuyerHistory = [...originalHistory, ...newHistoryItems];

        // Update the item history
        if (newHistoryItems.length > 0) {
            console.log(`[Webhook] Appending ${newHistoryItems.length} moments to transferred item ${listing.id}`);
            await supabaseAdmin
                .from('listing_items')
                .update({ moment_history: fullBuyerHistory })
                .eq('id', listing.id);
        }

        // 3. Send Email to Seller (Shipping Request) - Using original listing data
        try {
            const { data: sellerUser } = await supabaseAdmin.auth.admin.getUserById(listingData.seller_id);

            if (sellerUser && sellerUser.user && sellerUser.user.email) {
                if (process.env.RESEND_API_KEY) {
                    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
                    await resend.emails.send({
                        from: 'Stadium Card <onboarding@resend.dev>',
                        to: [sellerUser.user.email],
                        subject: 'Item Sold - Shipping Required',
                        react: ShippingRequestEmail({
                            sellerName: sellerUser.user.user_metadata?.full_name || 'Seller',
                            productName: listingData.player_name || listingData.series_name,
                            orderUrl: `${baseUrl}/orders/sell/${orderId}`
                        }) as ReactElement
                    });
                }
            }
        } catch (emailErr) {
            console.error('Unexpected error sending shipping request email:', emailErr);
        }

        // 4. Send Email to Buyer (Order Confirmation)
        try {
            const { data: buyerUser } = await supabaseAdmin.auth.admin.getUserById(currentOrder.buyer_id);

            if (buyerUser && buyerUser.user && buyerUser.user.email) {
                if (process.env.RESEND_API_KEY) {
                    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
                    await resend.emails.send({
                        from: 'Stadium Card <onboarding@resend.dev>',
                        to: [buyerUser.user.email],
                        subject: 'Order Confirmed',
                        react: OrderConfirmationEmail({
                            buyerName: buyerUser.user.user_metadata?.full_name || 'Collector',
                            productName: listingData.player_name || listingData.series_name,
                            price: listingData.price,
                            orderUrl: `${baseUrl}/orders/buy/${orderId}`
                        }) as ReactElement
                    });
                }
            }
        } catch (buyerErr) {
            console.error('Unexpected error sending buyer confirmation email:', buyerErr);
        }

        console.log(`Order ${orderId} completed successfully (webhook logic).`);
    }

    return NextResponse.json({ received: true });
}
</file>

<file path="frontend/app/auctions/page.tsx">
'use client';

import Footer from '../../components/Footer';

export default function AuctionsPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full text-center">
                <div className="glass-panel-premium p-12 rounded-2xl shadow-2xl inline-block max-w-2xl">
                    <div className="w-20 h-20 bg-brand-blue/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-brand-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1槌3 10V3L4 14h7v7l9-11h-7z" />
                            {/* Using a gavel-like icon or generic lightning for now */}
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </div>
                    <h1 className="text-4xl font-heading font-bold text-white mb-4">オークション機能は近日公開</h1>
                    <p className="text-brand-platinum/60 text-lg mb-8">
                        レアカードをリアルタイムで入札できるオークション機能を準備中です。
                    </p>
                    <div className="inline-block px-6 py-3 rounded-full bg-brand-dark-light border border-brand-platinum/10 text-brand-platinum/40 text-sm font-mono">
                        公開予定: 2026年第1四半期
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/checkout/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import Footer from '../../../components/Footer';
import { createClient } from '../../../utils/supabase/client';

// Types (Duplicate from page.tsx for now)
type Manufacturer = "BBM" | "Calbee" | "Epoch" | "Topps_Japan";
type Team = "Giants" | "Tigers" | "Dragons" | "Swallows" | "Carp" | "BayStars" | "Hawks" | "Fighters" | "Marines" | "Buffaloes" | "Eagles" | "Lions";
type Rarity = "Common" | "Rare" | "Super Rare" | "Parallel" | "Autograph" | "Patch";



interface ConditionGrading {
    is_graded: boolean;
    service: string;
    score?: number;
    certification_number?: string;
}

interface ListingItem {
    id: string;
    price: number;
    images: string[];
    condition_grading: ConditionGrading;
    seller_id: string;
    status: string;

    // Backfilled Fields
    player_name?: string | null;
    team?: string | null;
    year?: number | null;
    manufacturer?: string | null;
    series_name?: string | null;
    card_number?: string | null;
}

export default function CheckoutPage() {
    const [user, setUser] = useState<any>(null);
    const params = useParams();
    const router = useRouter();
    const id = params.id as string;

    const [listing, setListing] = useState<ListingItem | null>(null);
    const [loading, setLoading] = useState(true);
    const [processing, setProcessing] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Detailed Shipping State
    const [shippingForm, setShippingForm] = useState({
        name: '',
        postalCode: '',
        address: '',
        phone: ''
    });

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            if (user) {
                // Fetch profile for address
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    const fullName = profile.last_name && profile.first_name
                        ? `${profile.last_name} ${profile.first_name}`
                        : profile.name || '';

                    const fullAddress = [
                        profile.address_line1,
                        profile.address_line2
                    ].filter(Boolean).join(' ');

                    setShippingForm({
                        name: fullName,
                        postalCode: profile.postal_code || '',
                        address: fullAddress,
                        phone: profile.phone_number || ''
                    });
                }
            }

            if (!id) return;

            try {
                const { data, error } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;
                setListing(data as any);
            } catch (err) {
                setError(err instanceof Error ? err.message : 'An unknown error occurred');
            } finally {
                setLoading(false);
            }
        };

        init();
    }, [id]);

    const handlePlaceOrder = async () => {
        if (!listing) return;
        if (!user) {
            router.push('/login');
            return;
        }

        // Validate Shipping Form
        if (!shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim()) {
            setError("Please fill in all shipping fields (Name, Address, Phone).");
            return;
        }

        setProcessing(true);
        setError(null);

        try {
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    listingId: listing.id,
                    returnUrl: window.location.origin,
                    shippingDetails: {
                        name: shippingForm.name,
                        postalCode: shippingForm.postalCode,
                        address: shippingForm.address,
                        phone: shippingForm.phone
                    }
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Payment initialization failed');
            }

            const { url } = await response.json();

            // Redirect to Stripe Checkout
            window.location.href = url;

        } catch (err: any) {
            console.error('Purchase Error:', err);
            setError(err.message || 'Transaction failed');
            setProcessing(false);
        }
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (error && !listing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-brand-dark">
                <div className="text-red-500 text-xl font-semibold mb-4">Error: {error}</div>
                <Link href="/" className="text-brand-blue hover:underline">
                    Back to Market
                </Link>
            </div>
        );
    }

    if (!listing) return null;

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pt-32 pb-12">
            <div className="flex-1 w-full max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 className="text-3xl font-heading font-bold text-white mb-8 text-center border-b border-white/10 pb-4">Checkout</h1>

                <div className="glass-panel-premium shadow-2xl rounded-2xl mb-6 overflow-hidden border border-brand-platinum/10">
                    <div className="bg-brand-dark-light/50 px-6 py-5 border-b border-brand-platinum/10">
                        <h3 className="text-lg leading-6 font-bold text-white">Order Summary</h3>
                    </div>
                    <div className="divide-y divide-white/5">
                        <div className="px-6 py-4 flex justify-between items-center group hover:bg-white/5 transition-colors">
                            <span className="text-sm font-medium text-brand-platinum">Item</span>
                            <span className="text-sm text-white font-bold group-hover:text-brand-blue-glow transition-colors">
                                {listing.player_name || 'Unknown Item'} <span className="text-brand-platinum/60 font-normal">({listing.year || '----'} {listing.manufacturer || ''})</span>
                            </span>
                        </div>
                        <div className="px-6 py-4 flex justify-between items-center">
                            <span className="text-sm font-medium text-brand-platinum">Condition</span>
                            <span className="text-sm text-white">
                                {listing.condition_grading.is_graded ? `Graded: ${listing.condition_grading.service} ${listing.condition_grading.score}` : 'Ungraded'}
                            </span>
                        </div>
                        <div className="px-6 py-5 flex justify-between items-center bg-brand-blue/5">
                            <span className="text-base font-bold text-white">Total Amount</span>
                            <span className="text-2xl font-bold text-brand-blue-glow font-heading tracking-tight">
                                ¥{listing.price.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>

                {/* Shipping Address Section */}
                <div className="glass-panel-premium shadow-2xl rounded-2xl mb-6 p-6 border border-brand-platinum/10">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="w-8 h-8 rounded-full bg-brand-gold/20 flex items-center justify-center text-brand-gold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 17h4V5H2v12h3m10 0h5v-3.5L15.5 8H10" /></svg>
                        </div>
                        <h3 className="text-lg leading-6 font-bold text-white">Shipping Address</h3>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Name <span className="text-red-400">*</span></label>
                            <input
                                type="text"
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                placeholder="Full Name"
                                value={shippingForm.name}
                                onChange={e => setShippingForm({ ...shippingForm, name: e.target.value })}
                            />
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                            <div className="col-span-1">
                                <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Postal Code</label>
                                <input
                                    type="text"
                                    className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                    placeholder="123-4567"
                                    value={shippingForm.postalCode}
                                    onChange={e => setShippingForm({ ...shippingForm, postalCode: e.target.value })}
                                />
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Phone Number <span className="text-red-400">*</span></label>
                                <input
                                    type="tel"
                                    className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                    placeholder="090-1234-5678"
                                    value={shippingForm.phone}
                                    onChange={e => setShippingForm({ ...shippingForm, phone: e.target.value })}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Full Address <span className="text-red-400">*</span></label>
                            <input
                                type="text"
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                placeholder="Prefecture, City, Street, Building"
                                value={shippingForm.address}
                                onChange={e => setShippingForm({ ...shippingForm, address: e.target.value })}
                            />
                        </div>

                        <div className="text-xs text-brand-platinum/40 italic mt-2">
                            * Updating this form does not change your main profile address.
                        </div>
                    </div>
                </div>

                {error && (
                    <div className="bg-red-500/10 border border-red-500/20 p-4 mb-6 rounded-xl flex items-center gap-3 animate-pulse">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
                        <p className="text-sm text-red-400 font-bold">{error}</p>
                    </div>
                )}

                <p className="text-xs text-brand-platinum/60 text-right mb-4 max-w-lg ml-auto leading-relaxed">
                    購入を確定すると、商品の発送に必要な範囲で、あなたの配送先情報が出品者に開示されます。
                </p>

                <div className="flex justify-end space-x-4">
                    <Link href={`/listings/${listing.id}`} className="px-6 py-3 border border-brand-platinum/20 rounded-xl text-sm font-bold text-brand-platinum hover:bg-brand-platinum/10 hover:text-white transition-all">
                        Cancel
                    </Link>
                    <button
                        onClick={handlePlaceOrder}
                        disabled={processing || !shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim()}
                        className={`inline-flex items-center gap-2 justify-center px-8 py-3 border border-transparent shadow-lg text-sm font-bold rounded-xl text-white bg-gradient-to-r from-brand-blue to-brand-blue-glow hover:from-brand-blue-glow hover:to-brand-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] shadow-brand-blue/20 ${processing || !shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim() ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                        {processing ? (
                            <>
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Processing...
                            </>
                        ) : (
                            <>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></svg>
                                Buy Now
                            </>
                        )}
                    </button>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/collection/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { createClient } from '../../utils/supabase/client';
import AddToShowcaseModal from '../../components/AddToShowcaseModal';
import ShowcaseCard from '../../components/ShowcaseCard';
import PurchaseAnimation from '../../components/PurchaseAnimation';
import SkeletonCard from '../../components/SkeletonCard';
import { deleteItem, restoreItem } from '../actions/item';

// Types
import { ListingItem } from '../../types';

interface OrderItem {
    id: string;
    listing_id: string;
    status: string;
    total_amount: number;
    tracking_number?: string;
    listing?: ListingItem;
    created_at: string;
    completed_at?: string;
}

function MyPageContent() {
    const [user, setUser] = useState<any>(null);
    const router = useRouter();
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const [activeTab, setActiveTab] = useState<'showcase' | 'listings' | 'orders' | 'history' | 'archive'>('showcase');
    const [historyTab, setHistoryTab] = useState<'sold' | 'purchased'>('sold');
    const [filter, setFilter] = useState<'All' | 'Draft' | 'Active' | 'Display'>('All');
    const [showcaseItems, setShowcaseItems] = useState<any[]>([]);
    const [archivedItems, setArchivedItems] = useState<any[]>([]);
    const [myListings, setMyListings] = useState<ListingItem[]>([]);
    const [myOrders, setMyOrders] = useState<OrderItem[]>([]);
    const [historySold, setHistorySold] = useState<ListingItem[]>([]);
    const [historyPurchased, setHistoryPurchased] = useState<OrderItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [currentUserId, setCurrentUserId] = useState<string | null>(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [showAnimation, setShowAnimation] = useState(false);

    const fetchData = async () => {
        setLoading(true);
        const supabase = createClient();
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            console.log('[Collection] No user found, redirecting to login');
            router.push('/login');
            setLoading(false);
            return;
        }
        setUser(user);
        setCurrentUserId(user.id);

        try {
            // Fetch All My Items (Listings + Collection)
            const { data: listingsData } = await supabase
                .from('listing_items')
                .select('*, orders:orders!listing_id(*), origin_order:orders!origin_order_id(id, status, moment_snapshot)') // Left Join (Removed !)
                .eq('seller_id', user.id);

            const activeItemsRaw = listingsData?.filter(i => !i.deleted_at) || [];
            const archivedItemsRaw = listingsData?.filter(i => !!i.deleted_at) || [];

            // Fetch Active Live Moments to tag items
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
            const { data: recentMoments } = await supabase
                .from('live_moments')
                .select('*')
                .gt('created_at', oneHourAgo);

            const livePlayerNames = new Set(recentMoments?.map(m => (m.player_name || '').toLowerCase()) || []);

            const tagWithLive = (item: any) => {
                if (!item) return null;

                // Live Moments enabled for ALL items (as per user request to boost selling intent)
                // Originally restricted to Active, now globally enabled for "Opportunity" notification.

                const playerName = (item.player_name || '').toLowerCase();
                const matchedMoments = recentMoments?.filter(m => {
                    const mName = (m.player_name || '').toLowerCase();
                    return playerName.includes(mName) || mName.includes(playerName);
                }) || [];

                return {
                    ...item,
                    is_live_moment: matchedMoments.length > 0,
                    live_moments: matchedMoments, // Full array for multi-badge
                    moment_created_at: matchedMoments[0]?.created_at || null // For legacy single-badge if needed
                };
            };

            // Helper for merging moments from order snapshots into item history
            const mergeOrderMoments = (item: any, orderData: any) => {
                if (!item || !orderData || !orderData.moment_snapshot) return item;

                const snapshots = Array.isArray(orderData.moment_snapshot) ? orderData.moment_snapshot : [orderData.moment_snapshot];
                const history = Array.isArray(item.moment_history) ? item.moment_history : [];

                const missingSnapshots = snapshots.filter((sn: any) =>
                    !history.some((h: any) => (h.moment_id === sn.id) || (h.id === sn.id))
                );

                if (missingSnapshots.length > 0) {
                    item.moment_history = [
                        ...history,
                        ...missingSnapshots.map((sn: any) => ({
                            moment_id: sn.id,
                            timestamp: sn.created_at || new Date().toISOString(),
                            title: sn.title,
                            player_name: sn.player_name,
                            intensity: sn.intensity,
                            description: sn.description,
                            match_result: sn.match_result,
                            owner_at_time: orderData.id,
                            status: 'finalized'
                        }))
                    ];
                }
                return item;
            };

            // Selling Tab: Active Transactions (Persistent Model: Query from orders)
            const { data: pendingSalesData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)')
                .eq('seller_id', user.id)
                .is('completed_at', null);

            console.log('[Collection] Pending Sales:', pendingSalesData?.length || 0);

            const activeMyListings = (pendingSalesData || []).map(order => ({
                ...order.listing,
                orders: order // Pass order for Manage link
            })).map(tagWithLive).filter(item => item !== null);
            setMyListings(activeMyListings as any);

            // History: Sold Items (Persistent Model: Query from orders)
            const { data: soldOrdersData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Get the listing details at time of fetch
                .eq('seller_id', user.id)
                .is('completed_at', null); // Initial check for pending sales? No, history usually means completed.

            // Actually, History > Sold should probably show Completed orders.
            const { data: completedSoldData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Disambiguate join
                .eq('seller_id', user.id)
                .not('completed_at', 'is', null);

            const soldHistory = (completedSoldData || []).map(order => ({
                ...order.listing,
                orders: order, // For formatDate(item.orders.completed_at)
                type: 'sold'
            })).map(tagWithLive);
            setHistorySold(soldHistory as any);

            // Buying Tab: Active Transactions only
            const { data: ordersData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Disambiguate join
                .eq('buyer_id', user.id);

            const activeMyOrders = (ordersData?.filter(order => {
                const orderStatus = (order.status || '').toLowerCase();
                // ONLY show orders that are actually in progress for THIS purchase
                return ['pending', 'paid', 'awaiting_shipping', 'shipped', 'delivered'].includes(orderStatus);
            }) || []).map(order => {
                const listing = order.listing ? mergeOrderMoments(order.listing, order) : null;
                return {
                    ...order,
                    listing: listing ? tagWithLive(listing) : null
                };
            }).filter(o => o.listing !== null); // safety
            setMyOrders(activeMyOrders as any || []);

            // History: Purchased Items
            const purchasedHistory = (ordersData?.filter(order =>
                (order.status || '').toLowerCase() === 'completed'
            ) || []).map(order => {
                const listing = order.listing ? mergeOrderMoments(order.listing, order) : null;
                return {
                    ...order,
                    listing: listing ? tagWithLive(listing) : null
                };
            });
            setHistoryPurchased(purchasedHistory as any);

            // Workspace Tab: Aggregated View
            const workspaceListings = (activeItemsRaw?.filter(item => {
                // Mandatory Filter: Must be Active, Display, or Draft (or Completed as fallback)
                const isCorrectStatus = ['Active', 'Display', 'Draft', 'Completed', 'completed'].includes(item.status);

                // Extra Protection: If it's a purchased clone (has origin_order_id), 
                // it MUST have a completed order to show up in Workspace.
                // If it's not a clone (origin_order_id is null), it's a seller's item, show normally.
                const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
                const isTransactionComplete = !item.origin_order_id || (originOrder?.status === 'completed');

                return isCorrectStatus && isTransactionComplete;
            }) || []).map(item => {
                // Self-Healing: Merge moment_snapshot from origin_order into history if missing
                let originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;

                // Fallback: If origin_order is missing link, look for my purchase order in related orders
                if (!originOrder && item.orders) {
                    const relatedOrders = Array.isArray(item.orders) ? item.orders : [item.orders];
                    const myPurchase = relatedOrders.find((o: any) =>
                        o.buyer_id === user.id &&
                        (o.status === 'completed' || o.status === 'shipped' || o.status === 'paid' || o.status === 'delivered')
                    );
                    if (myPurchase) {
                        originOrder = myPurchase;
                    }
                }

                return mergeOrderMoments(item, originOrder);
            }).map(tagWithLive);

            // Archive Tab
            const archiveListings = (archivedItemsRaw || []).map(tagWithLive);
            setArchivedItems(archiveListings);

            const aggregated = [
                ...workspaceListings.map(item => ({ type: 'listed', ...item }))
            ];
            setShowcaseItems(aggregated);

        } catch (error) {
            console.error('Failed to fetch data:', error);
        } finally {
            setLoading(false);
        }
    };


    const handleDeleteCollectionItem = async (id: string) => {
        if (!confirm('このアイテムをアーカイブしますか？履歴タブに移動します。')) return;

        try {
            await deleteItem(id);
            fetchData();
        } catch (error) {
            console.error('Failed to archive item:', error);
            alert('アーカイブに失敗しました');
        }
    };

    const handleRestoreCollectionItem = async (id: string) => {
        if (!confirm('このアイテムをコレクションに復元しますか？')) return;

        try {
            await restoreItem(id);
            fetchData();
        } catch (error) {
            console.error('Failed to restore item:', error);
            alert('復元に失敗しました');
        }
    };

    const handleToggleDisplay = async (id: string, currentStatus: string) => {
        let newStatus = 'Draft';
        if (currentStatus === 'Draft') newStatus = 'Display';
        if (currentStatus === 'Active') newStatus = 'Display'; // Active -> Display
        if (currentStatus === 'Display') newStatus = 'Draft';

        const supabase = createClient();

        const { error } = await supabase
            .from('listing_items')
            .update({
                status: newStatus,
                deleted_at: null // Restoration safety
            })
            .eq('id', id);

        if (error) {
            console.error('Failed to update status:', error);
            alert('ステータスの変更に失敗しました');
        } else {
            fetchData();
        }
    };

    const handleCancelListing = async (id: string) => {
        if (!confirm('この出品を取り消しますか？下書きに戻ります。')) return;

        const supabase = createClient();

        try {
            // Mark listing as Draft (Soft Delete from Marketplace, but keeps in DB)
            const { error: updateError } = await supabase
                .from('listing_items')
                .update({
                    status: 'Draft',
                    deleted_at: null // Restoration safety 
                })
                .eq('id', id);

            if (updateError) throw updateError;

            fetchData();

        } catch (error) {
            console.error('Failed to cancel listing:', error);
            alert('出品の取り消しに失敗しました');
        }
    };

    const handleShipItem = async (listingId: string) => {
        if (!confirm('出荷準備が完了しましたか？')) return;

        const supabase = createClient();
        const { error } = await supabase
            .from('listing_items')
            .update({ status: 'Shipped' })
            .eq('id', listingId);

        if (error) {
            console.error('Failed to ship item:', error);
            alert('出荷更新に失敗しました');
        } else {
            fetchData();
        }
    };



    const formatDate = (dateString?: string) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
    };

    useEffect(() => {
        fetchData();
    }, []);

    // Filter Logic for Workspace
    const filteredShowcaseItems = showcaseItems.filter(item => {
        if (filter === 'All') return true;
        if (filter === 'Draft') return item.status === 'Draft';
        if (filter === 'Active') return item.status === 'Active';
        if (filter === 'Display') return item.status === 'Display';
        return true;
    });

    if (loading) {
        return (
            <div className="min-h-screen pt-32 pb-12 px-4 sm:px-6 lg:px-8 bg-brand-dark">
                <div className="max-w-6xl mx-auto">
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                        {[...Array(10)].map((_, i) => (
                            <SkeletonCard key={i} />
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    if (!user && !loading) return null;

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-12">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-heading font-bold text-white">マイコレクション</h1>
                    <div className="flex gap-4">
                        <Link
                            href={`/profile/${user.id}`}
                            className="px-4 py-2 bg-brand-platinum/10 text-brand-platinum border border-brand-platinum/20 rounded-lg hover:bg-brand-platinum/20 transition-all font-bold text-sm flex items-center gap-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            公開プロフィールを見る
                        </Link>
                        <button
                            onClick={() => setIsModalOpen(true)}
                            className="px-4 py-2 bg-brand-gold/10 text-brand-gold border border-brand-gold/20 rounded-lg hover:bg-brand-gold/20 transition-all font-bold text-sm flex items-center gap-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            カードを追加
                        </button>
                    </div>
                </div>

                <div className="glass-panel-premium shadow-2xl rounded-2xl border border-white/10">
                    <div className="border-b border-brand-platinum/10">
                        <nav className="-mb-px flex" aria-label="Tabs">
                            <button
                                onClick={() => setActiveTab('showcase')}
                                className={`${activeTab === 'showcase'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                ワークスペース
                            </button>
                            <button
                                onClick={() => setActiveTab('listings')}
                                className={`${activeTab === 'listings'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                出品中
                            </button>
                            <button
                                onClick={() => setActiveTab('orders')}
                                className={`${activeTab === 'orders'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                購入中
                            </button>
                            <button
                                onClick={() => setActiveTab('history')}
                                className={`${activeTab === 'history'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                取引履歴
                            </button>
                            <button
                                onClick={() => setActiveTab('archive')}
                                className={`${activeTab === 'archive'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                アーカイブ
                            </button>
                        </nav>
                    </div>

                    <div className="p-6 min-h-[400px]">
                        {activeTab === 'showcase' && (
                            <>
                                {/* Filter Pills */}
                                <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                    {['All', 'Draft', 'Active', 'Display'].map((f) => (
                                        <button
                                            key={f}
                                            onClick={() => setFilter(f as any)}
                                            className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap ${filter === f
                                                ? 'bg-brand-blue text-white shadow-lg shadow-brand-blue/20'
                                                : 'bg-brand-dark-light border border-brand-platinum/10 text-brand-platinum/60 hover:bg-brand-platinum/10 hover:text-white'
                                                }`}
                                        >
                                            {f}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                    {filteredShowcaseItems.map((item, idx) => (
                                        <ShowcaseCard
                                            key={idx}
                                            item={item}
                                            type={item.type as any} // Pass type 'listed' or 'purchased'
                                            onDelete={handleDeleteCollectionItem}
                                            onCancel={handleCancelListing}
                                            onToggleDisplay={handleToggleDisplay}
                                            is_live_moment={item.is_live_moment || isDebugLive}
                                            live_moments={item.live_moments} // New prop
                                            moment_created_at={item.moment_created_at}
                                        />
                                    ))}
                                    {filteredShowcaseItems.length === 0 && (
                                        <div className="col-span-full flex flex-col items-center justify-center py-12 text-brand-platinum/50">
                                            <svg className="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                            <p>「{filter}」にアイテムが見つかりません。</p>
                                            {filter === 'All' && (
                                                <button onClick={() => setIsModalOpen(true)} className="mt-4 text-brand-blue hover:text-brand-blue-glow">最初のカードを追加する</button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'listings' && (
                            <div className="grid grid-cols-1 gap-4">
                                {myListings.length === 0 ? (
                                    <div className="text-center py-12 text-brand-platinum/50">
                                        <p>進行中の販売はありません。</p>
                                        <p className="text-sm mt-2">出品中のアイテムはワークスペースにあります。</p>
                                    </div>
                                ) : (
                                    myListings.map(item => {
                                        // Handle Supabase relation (Array vs Object) and multiple orders
                                        // @ts-ignore
                                        const order = item.orders ? (
                                            Array.isArray(item.orders)
                                                ? (item.orders.find((o: any) => !['completed', 'cancelled'].includes((o.status || '').toLowerCase())) || item.orders[0])
                                                : item.orders
                                        ) : null;

                                        return (
                                            <div key={item.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5">
                                                <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light">
                                                    {item.images?.[0] ? (
                                                        <img src={item.images[0]} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className="text-white font-bold">{item.player_name || 'Unknown Item'}</h3>
                                                            <p className="text-brand-platinum/60 text-sm">{item.status}</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {(item.status === 'AwaitingShipment' || item.status === 'TransactionPending' || item.status === 'Shipped') && (
                                                                order ? (
                                                                    <Link
                                                                        href={(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id)
                                                                            ? `/orders/sell/${order.id}`
                                                                            : `/orders/buy/${order.id}`}
                                                                        className={`px-3 py-1 text-xs font-bold rounded-lg transition-colors shadow-lg ${(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id)
                                                                            ? "text-brand-dark bg-brand-blue hover:bg-brand-blue-light shadow-brand-blue/20"
                                                                            : "text-brand-dark bg-brand-gold hover:bg-brand-gold-light shadow-brand-gold/20"
                                                                            }`}
                                                                    >
                                                                        {(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id) ? "受注管理" : "注文を見る"}
                                                                    </Link>
                                                                ) : (
                                                                    <span className="text-xs text-brand-platinum/40 italic">同期中...</span>
                                                                )
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === 'orders' && (
                            <div className="grid grid-cols-1 gap-4">
                                {myOrders.length === 0 ? (
                                    <div className="text-center py-12 text-brand-platinum/50">
                                        <p>進行中の購入はありません。</p>
                                    </div>
                                ) : (
                                    myOrders.map(order => (
                                        <div key={order.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5">
                                            <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light">
                                                {order.listing?.images?.[0] ? (
                                                    <img src={order.listing.images[0]} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="text-white font-bold">{order.listing?.player_name || 'Unknown Item'}</h3>
                                                        <p className="text-brand-platinum/60 text-sm">
                                                            {order.status === 'shipped' ? '配送中' :
                                                                order.status === 'completed' ? '受取完了' :
                                                                    order.status === 'paid' || order.status === 'awaiting_shipping' ? '出荷待ち' :
                                                                        order.status === 'pending' ? '処理中' :
                                                                            '購入済み'}
                                                        </p>
                                                    </div>
                                                    {['paid', 'awaiting_shipping', 'shipped', 'delivered'].includes(order.status?.toLowerCase()) ? (
                                                        <Link
                                                            href={`/orders/buy/${order.id}`}
                                                            className={`px-3 py-1 text-xs font-bold rounded-lg transition-colors shadow-lg ${order.status === 'shipped'
                                                                ? 'text-brand-dark bg-brand-gold hover:bg-brand-gold-light shadow-brand-gold/20'
                                                                : 'text-brand-platinum/60 bg-brand-dark-light border border-brand-platinum/10'
                                                                }`}
                                                        >
                                                            {order.status === 'shipped' ? '確認・受取' : '注文を見る'}
                                                        </Link>
                                                    ) : (
                                                        <span
                                                            className="px-3 py-1 text-xs font-bold text-brand-platinum/40 bg-brand-dark-light border border-brand-platinum/10 rounded-lg cursor-not-allowed"
                                                        >
                                                            処理中
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div>
                                <div className="flex gap-4 mb-6 border-b border-brand-platinum/10 pb-4">
                                    <button
                                        onClick={() => setHistoryTab('sold')}
                                        className={`text-sm font-bold transition-colors ${historyTab === 'sold' ? 'text-brand-blue' : 'text-brand-platinum/60 hover:text-brand-platinum'
                                            }`}
                                    >
                                        販売履歴
                                    </button>
                                    <button
                                        onClick={() => setHistoryTab('purchased')}
                                        className={`text-sm font-bold transition-colors ${historyTab === 'purchased' ? 'text-brand-blue' : 'text-brand-platinum/60 hover:text-brand-platinum'
                                            }`}
                                    >
                                        購入履歴
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                    {historyTab === 'sold' ? (
                                        historySold.length === 0 ? (
                                            <div className="text-center py-12 text-brand-platinum/50">
                                                <p>販売履歴はありません。</p>
                                            </div>
                                        ) : (
                                            historySold.map(item => (
                                                <div key={item.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5 opacity-75">
                                                    <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light grayscale">
                                                        {item.images?.[0] ? (
                                                            <img src={item.images[0]} className="w-full h-full object-cover" />
                                                        ) : (
                                                            <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="text-white font-bold">{item.player_name || 'Unknown Item'}</h3>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <p className="text-brand-platinum/60 text-xs italic">販売完了</p>
                                                                    {/* @ts-ignore */}
                                                                    {item.orders && (
                                                                        <span className="text-[10px] px-2 py-0.5 rounded-full bg-brand-platinum/10 text-brand-platinum/40">
                                                                            {/* @ts-ignore */}
                                                                            {formatDate(Array.isArray(item.orders) ? item.orders[0]?.completed_at : item.orders?.completed_at)}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="text-brand-gold font-bold">
                                                                {/* @ts-ignore */}
                                                                ¥{item.orders?.total_amount?.toLocaleString() || item.price?.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )
                                    ) : (
                                        historyPurchased.length === 0 ? (
                                            <div className="text-center py-12 text-brand-platinum/50">
                                                <p>購入履歴はありません。</p>
                                            </div>
                                        ) : (
                                            historyPurchased.map(order => (
                                                <div key={order.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5 opacity-75">
                                                    <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light grayscale">
                                                        <img src={order.listing?.images[0]} className="w-full h-full object-cover" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="text-white font-bold">{order.listing?.player_name || 'Unknown Item'}</h3>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <p className="text-brand-platinum/60 text-xs italic">購入完了</p>
                                                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-brand-platinum/10 text-brand-platinum/40">
                                                                        {(order as any).completed_at ? formatDate((order as any).completed_at) : formatDate(order.created_at)}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="text-brand-gold font-bold">
                                                                ¥{order.total_amount?.toLocaleString() || order.listing?.price?.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'archive' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {archivedItems.map((item) => (
                                    <ShowcaseCard
                                        key={item.id}
                                        item={item}
                                        isArchived={true}
                                        onRestore={handleRestoreCollectionItem}
                                        onDelete={handleDeleteCollectionItem} // Optional: if physical delete ever needed
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                        live_moments={item.live_moments} // New prop
                                        moment_created_at={item.moment_created_at}
                                    />
                                ))}
                                {archivedItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-12 text-brand-platinum/50">
                                        <svg className="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                                        <p>アーカイブは空です。</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
                <Footer />
                <AddToShowcaseModal
                    isOpen={isModalOpen}
                    onClose={() => setIsModalOpen(false)}
                    onAdded={fetchData}
                />

                {
                    showAnimation && (
                        <PurchaseAnimation
                            onComplete={() => {
                                setShowAnimation(false);
                                fetchData();
                            }}
                        />
                    )
                }
            </div>
        </div>
    );
}

export default function MyPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <MyPageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/community/page.tsx">
'use client';

import Footer from '../../components/Footer';

export default function CommunityPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full text-center">
                <div className="glass-panel-premium p-12 rounded-2xl shadow-2xl inline-block max-w-2xl">
                    <div className="w-20 h-20 bg-brand-gold/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-brand-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h1 className="text-4xl font-heading font-bold text-white mb-4">Community Hub</h1>
                    <p className="text-brand-platinum/60 text-lg mb-8">
                        Connect with other collectors, discuss trends, and show off your showcase.
                    </p>
                    <button className="px-8 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-xl transition-all shadow-lg shadow-brand-blue/20">
                        Join Discord
                    </button>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/debug-admin/page.tsx">
import { createClient } from '@/utils/supabase/server';

export default async function DebugAdminPage() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    const adminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || 'NOT SET';
    // const publicAdminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || 'NOT SET'; // Removed redundancy
    const adminEmailsList = adminEmailsRaw.split(/[,;|]+/).map(e => e.trim().toLowerCase());

    const currentUserEmail = user?.email?.toLowerCase() || 'NOT LOGGED IN';
    const isMatched = user?.email ? adminEmailsList.includes(currentUserEmail) : false;

    return (
        <div style={{ padding: '40px', fontFamily: 'monospace', backgroundColor: '#111', color: '#eee', minHeight: '100vh' }}>
            <h1 style={{ color: '#FFD700' }}>Admin Authorization Debug</h1>
            <div style={{ backgroundColor: '#222', padding: '20px', borderRadius: '8px', border: '1px solid #444' }}>
                <p><strong>Logged in as:</strong> {user?.email || 'None'}</p>
                <p><strong>Environment ADMIN_EMAILS:</strong> {adminEmailsRaw}</p>
                <p><strong>Parsed Admin List:</strong> {JSON.stringify(adminEmailsList)}</p>
                <hr style={{ border: '0', borderTop: '1px solid #444', margin: '20px 0' }} />
                <p style={{ fontSize: '1.5rem' }}>
                    <strong>Result:</strong> {isMatched ? <span style={{ color: '#4ade80' }}>MATCHED (ACCESS GRANTED)</span> : <span style={{ color: '#f87171' }}>MISMATCH (ACCESS DENIED)</span>}
                </p>
            </div>

            <div style={{ marginTop: '40px', fontSize: '0.8rem', color: '#888' }}>
                <p>Possible causes for mismatch:</p>
                <ul>
                    <li>The email in ADMIN_EMAILS has a typo or extra space.</li>
                    <li>Vercel environment variables are not yet applied (requires redeploy).</li>
                    <li>Lowercase/Uppercase mismatch (the debug above normalizes to lowercase).</li>
                </ul>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/listings/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useParams, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import { createClient } from '../../../utils/supabase/client';
import Footer from '../../../components/Footer';
import { ListingItem } from '../../../types';
import AddToShowcaseModal from '../../../components/AddToShowcaseModal';
import MomentHistoryPanel from '../../../components/MomentHistoryPanel';

export default function ListingDetail() {
    const params = useParams();
    const searchParams = useSearchParams();
    const id = params?.id as string;
    const isDebugLive = searchParams.get('live') === 'true';

    const [user, setUser] = useState<any>(null);
    const [listing, setListing] = useState<ListingItem | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [selectedImage, setSelectedImage] = useState<string | null>(null);
    const [isEditModalOpen, setIsEditModalOpen] = useState(false);

    // Live Moment Logic
    const [isLiveActive, setIsLiveActive] = useState(false);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [momentsWithTime, setMomentsWithTime] = useState<any[]>([]);

    useEffect(() => {
        if (activeMoments.length === 0 && !isDebugLive) {
            setIsLiveActive(false);
            return;
        }

        setIsLiveActive(true);

        const updateTimers = () => {
            const now = new Date().getTime();
            const updated = activeMoments.map(m => {
                const createdTime = new Date(m.created_at).getTime();
                const end = createdTime + 60 * 60 * 1000;
                const distance = end - now;
                let timeLeft = '00:00';
                if (distance > 0) {
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timeLeft = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return { ...m, timeLeft, endTime: end };
            });

            setMomentsWithTime(updated);

            const hasOngoing = updated.some(m => (m.endTime - now) > 0);
            setIsLiveActive(isDebugLive || hasOngoing);
        };

        updateTimers();
        const timer = setInterval(updateTimers, 1000);
        return () => clearInterval(timer);
    }, [activeMoments, isDebugLive]);

    // Derived state for pure visual toggle
    const isLiveMoment = isLiveActive;

    const fetchListingAndUser = async () => {
        const supabase = createClient();

        // Fetch User
        const { data: { user } = { user: null } } = await supabase.auth.getUser();
        setUser(user);

        // Use the id from the outer scope (useParams hook)
        if (!id) return;

        try {
            const { data, error } = await supabase
                .from('listing_items')
                .select('*, seller:profiles(*), origin_order:orders!origin_order_id(id, status, moment_snapshot), related_orders:orders!listing_id(id, buyer_id, status, moment_snapshot)')
                .eq('id', id)
                .single();

            if (error) {
                throw error;
            }

            // Self-Healing Moment Logic
            let listingData = data as any;
            let originOrder = Array.isArray(listingData.origin_order) ? listingData.origin_order[0] : listingData.origin_order;

            // Fallback: If origin_order is missing, look for a completed order where I am the buyer
            if (!originOrder && user && listingData.related_orders) {
                const myPurchase = listingData.related_orders.find((o: any) =>
                    o.buyer_id === user.id &&
                    (o.status === 'completed' || o.status === 'shipped' || o.status === 'paid' || o.status === 'delivered')
                );
                if (myPurchase) {
                    originOrder = myPurchase;
                }
            }

            if (originOrder && originOrder.moment_snapshot) {
                const snapshots = Array.isArray(originOrder.moment_snapshot) ? originOrder.moment_snapshot : [originOrder.moment_snapshot];
                const history = Array.isArray(listingData.moment_history) ? listingData.moment_history : [];

                const missingSnapshots = snapshots.filter((sn: any) =>
                    !history.some((h: any) => (h.moment_id === sn.id) || (h.id === sn.id))
                );

                if (missingSnapshots.length > 0) {
                    listingData = {
                        ...listingData,
                        moment_history: [
                            ...history,
                            ...missingSnapshots.map((sn: any) => ({
                                moment_id: sn.id,
                                timestamp: sn.created_at || new Date().toISOString(),
                                title: sn.title,
                                player_name: sn.player_name,
                                intensity: sn.intensity,
                                description: sn.description,
                                match_result: sn.match_result,
                                owner_at_time: originOrder.id,
                                status: 'finalized'
                            }))
                        ]
                    };
                }
            }

            setListing(listingData);
            if (data.images && data.images.length > 0) {
                setSelectedImage(data.images[0]);
            }

            // CHECK LIVE MOMENTS
            const now = new Date();
            const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();
            const listingPlayerName = (data.player_name || '').toLowerCase();

            const { data: moments } = await supabase
                .from('live_moments')
                .select('*')
                .gt('created_at', lookback)
                .order('created_at', { ascending: false });

            if (moments && moments.length > 0) {
                const matched = moments.filter(m => {
                    const activePlayer = (m.player_name || '').toLowerCase();
                    if (listingPlayerName.includes(activePlayer)) return true;
                    if (activePlayer.includes(listingPlayerName)) return true;
                    return false;
                });

                setActiveMoments(matched);
            } else {
                setActiveMoments([]);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchListingAndUser();
    }, [id]);

    const handleEditSuccess = () => {
        setIsEditModalOpen(false);
        window.location.reload();
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (error || !listing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-brand-dark">
                <div className="text-red-500 text-xl font-semibold mb-4 bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error || 'Listing not found'}</div>
                <Link href="/" className="text-brand-blue hover:text-brand-blue-glow hover:underline transition-colors">
                    Back to Market
                </Link>
            </div>
        );
    }

    // Helper to get seller display name
    const getSellerName = (seller: any) => {
        if (!seller) return 'Unknown Seller';
        return seller.display_name || seller.name || 'Trading Card Collector';
    };

    return (
        <div className="min-h-screen bg-brand-dark pt-32 pb-32 px-4 sm:px-6 lg:px-8 flex flex-col">
            <div className="max-w-7xl mx-auto w-full flex-1">
                <nav className="mb-8">
                    <Link href="/market" className="text-brand-platinum hover:text-white font-medium flex items-center transition-colors group">
                        <span className="mr-2 group-hover:-translate-x-1 transition-transform">←</span> マーケットに戻る
                    </Link>
                </nav>

                <div className={`glass-panel-premium rounded-2xl shadow-2xl overflow-hidden border ${isLiveMoment ? 'border-brand-gold/50' : 'border-white/10'} transition-colors duration-500`}>
                    <div className="md:flex">
                        {/* Image Gallery Section */}
                        <div className="md:w-1/2 p-2 md:p-8 bg-brand-dark-light/50 relative overflow-hidden">
                            {/* Live Moment Ambient Background */}
                            {isLiveMoment && (
                                <div className="absolute inset-0 z-0">
                                    <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-br from-brand-gold/5 to-transparent mix-blend-overlay pointer-events-none" />
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-brand-gold/10 blur-[100px] animate-pulse-slow pointer-events-none" />
                                </div>
                            )}

                            <motion.div
                                className={`mb-6 aspect-[2/3] relative rounded-xl bg-brand-dark group perspective-[1000px] z-10`}
                                animate={isLiveMoment ? {
                                    boxShadow: [
                                        "0 0 20px rgba(255, 69, 0, 0.3)",
                                        "0 0 50px rgba(255, 69, 0, 0.6)",
                                        "0 0 20px rgba(255, 69, 0, 0.3)"
                                    ],
                                    borderColor: [
                                        "rgba(255, 69, 0, 0.4)",
                                        "rgba(255, 69, 0, 1)",
                                        "rgba(255, 69, 0, 0.4)"
                                    ]
                                } : {}}
                                transition={{
                                    duration: 2,
                                    repeat: Infinity,
                                    ease: "easeInOut"
                                }}
                                style={{
                                    borderWidth: isLiveMoment ? '2px' : '1px',
                                    borderStyle: 'solid',
                                    borderColor: isLiveMoment ? '#FF4500' : 'rgba(255, 255, 255, 0.05)'
                                }}
                            >
                                {/* Live Moment Badges */}
                                {isLiveActive && (
                                    <div className="absolute top-4 left-4 z-50 flex flex-col gap-2">
                                        {isDebugLive && momentsWithTime.length === 0 && (
                                            <div className="relative">
                                                <div className="absolute inset-0 bg-red-600 blur-lg opacity-50 animate-pulse"></div>
                                                <div className="relative px-3 py-1 bg-gradient-to-r from-red-600 to-red-500 text-white text-[10px] font-bold tracking-widest uppercase rounded shadow-lg border border-white/30 flex items-center gap-2">
                                                    <span className="text-sm">🔥</span>
                                                    DEBUG LIVE
                                                    <span className="ml-2 pl-2 border-l border-white/20 font-mono text-xs">60:00</span>
                                                </div>
                                            </div>
                                        )}
                                        {momentsWithTime.map((m) => (
                                            <div key={m.id} className="relative">
                                                <div className="absolute inset-0 bg-red-600 blur-lg opacity-50 animate-pulse"></div>
                                                <div className="relative px-3 py-1 bg-gradient-to-r from-red-600 to-red-500 text-white text-[10px] font-bold tracking-widest uppercase rounded shadow-lg border border-white/30 flex items-center gap-2">
                                                    <span className="text-sm">🔥</span>
                                                    {m.title || 'LIVE MOMENT'}
                                                    <span className="ml-2 pl-2 border-l border-white/20 font-mono text-xs">{m.timeLeft}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${selectedImage === listing.images[1] ? '[transform:rotateY(180deg)]' : ''}`}>
                                    {/* Front Image (Image 0) */}
                                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] rounded-xl overflow-hidden shadow-2xl">
                                        {listing.images && listing.images.length > 0 ? (
                                            <>
                                                <Image
                                                    src={listing.images[0]}
                                                    alt={listing.player_name || "Card Image"}
                                                    fill
                                                    sizes="(max-width: 768px) 100vw, 50vw"
                                                    className="object-contain p-0 md:p-4 bg-brand-dark-light/50"
                                                />
                                                {/* Inner Glow Overlay */}
                                                {isLiveMoment && (
                                                    <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_50px_rgba(255,215,0,0.3)] rounded-xl mix-blend-overlay" />
                                                )}
                                            </>
                                        ) : (
                                            <div className="flex items-center justify-center h-full text-brand-platinum/30">No Image</div>
                                        )}
                                    </div>

                                    {/* Back Image (Image 1) */}
                                    {listing.images && listing.images.length > 1 && (
                                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] rounded-xl overflow-hidden shadow-2xl bg-brand-dark-light/50">
                                            <Image
                                                src={listing.images[1]}
                                                alt={`${listing.player_name || ''} Back`}
                                                fill
                                                sizes="(max-width: 768px) 100vw, 50vw"
                                                className="object-contain p-4"
                                            />
                                        </div>
                                    )}
                                </div>

                                {/* Glow Effect Behind Image (Enhanced for Live Moment) */}
                                <div className={`absolute inset-0 blur-3xl -z-10 ${isLiveMoment ? 'bg-brand-gold/20' : 'bg-brand-blue/5'}`}></div>
                            </motion.div>

                            {/* Thumbnails */}
                            {listing.images && listing.images.length > 1 && (
                                <div className="flex space-x-4 overflow-x-auto pb-2 scrollbar-hide">
                                    {listing.images.map((img: string, index: number) => (
                                        <button
                                            key={index}
                                            onClick={() => setSelectedImage(img)}
                                            className={`w-20 h-28 flex-shrink-0 rounded-lg border-2 overflow-hidden transition-all ${selectedImage === img ? 'border-brand-blue shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'border-transparent opacity-60 hover:opacity-100'}`}
                                        >
                                            <div className="relative w-full h-full">
                                                <Image
                                                    src={img}
                                                    alt={`View ${index + 1}`}
                                                    fill
                                                    sizes="80px"
                                                    className="object-cover"
                                                />
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Product Details Section */}
                        <div className="md:w-1/2 p-10 flex flex-col">
                            <div className="mb-8">
                                {/* Active Moment Context Box */}
                                {momentsWithTime.length > 0 && (
                                    <div className="flex flex-col gap-4 mb-6">
                                        {momentsWithTime.map((m) => (
                                            <div key={m.id} className="p-4 rounded-xl bg-gradient-to-r from-red-900/40 to-black border border-red-500/30 relative overflow-hidden group/live shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                                                <div className="absolute top-0 right-0 p-2 opacity-10">
                                                    <svg className="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 1012.12 15.12z" clipRule="evenodd" /></svg>
                                                </div>
                                                <div className="relative z-10">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="relative flex h-2 w-2">
                                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                                            <span className="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                                                        </span>
                                                        <p className="text-red-400 text-xs font-bold tracking-widest uppercase">HAPPENING NOW</p>
                                                        <span className="text-brand-platinum/40 text-xs">•</span>
                                                        <p className="text-brand-platinum/60 text-xs font-mono">{m.match_result || 'Live Match'}</p>
                                                    </div>
                                                    <h3 className="text-white font-bold text-lg mb-1 leading-tight">{m.title}</h3>
                                                    <p className="text-brand-platinum/80 text-sm line-clamp-2">{m.description}</p>
                                                    <div className="mt-3 flex items-center gap-3">
                                                        <div className="px-2 py-0.5 bg-red-500/20 rounded border border-red-500/30">
                                                            <span className="text-[10px] text-red-400 font-bold font-mono">{m.timeLeft} REMAINING</span>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {[...Array(m.intensity || 1)].map((_, i) => (
                                                                <span key={i} className="text-red-500 text-xs">🔥</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className="flex items-center space-x-3 mb-4">
                                    <span className="px-3 py-1 rounded-full text-xs font-bold bg-brand-blue/10 text-brand-blue border border-brand-blue/20 uppercase tracking-wider">
                                        {listing.team || 'Unknown Team'}
                                    </span>
                                    {listing.is_rookie && (
                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-brand-gold/10 text-brand-gold border border-brand-gold/20 uppercase tracking-wider animate-pulse-slow">
                                            Rookie Card
                                        </span>
                                    )}
                                    {listing.is_autograph && (
                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-purple-500/10 text-purple-400 border border-purple-500/20 uppercase tracking-wider">
                                            Autograph
                                        </span>
                                    )}
                                </div>
                                <h1 className="text-4xl md:text-5xl font-heading font-bold text-white mb-2 text-glow">{listing.player_name || 'Unknown Player'}</h1>
                                <p className="text-xl text-brand-platinum/80 font-light">{listing.year} {listing.manufacturer} {listing.series_name || ''}</p>
                                <p className="text-brand-platinum/50 mt-2 text-sm">
                                    Card #{listing.card_number || '---'}
                                    {listing.serial_number && ` • SN: ${listing.serial_number}`}
                                    {listing.variation && ` • ${listing.variation}`}
                                </p>

                                {/* Seller Info */}
                                <div className="flex items-center gap-3 mt-4 pt-4 border-t border-brand-platinum/10">
                                    <div className="w-10 h-10 rounded-full bg-brand-platinum/10 overflow-hidden relative">
                                        <Image
                                            src={listing.seller?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${listing.seller?.display_name || listing.seller?.email || 'Seller'}`}
                                            alt="Seller"
                                            fill
                                            className="object-cover"
                                        />
                                    </div>
                                    <div>
                                        <p className="text-xs text-brand-platinum/50 uppercase tracking-wider">出品者</p>
                                        <Link href={`/profile/${listing.seller_id}`} className="text-white font-medium hover:text-brand-blue transition-colors">
                                            {getSellerName(listing.seller)}
                                        </Link>
                                    </div>
                                </div>
                            </div>

                            {/* --- Product Details (Spec Sheet) --- */}
                            <div className="border-t border-brand-platinum/10 py-6">
                                <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-4">商品詳細 (Product Details)</h3>
                                <dl className="grid grid-cols-2 gap-x-4 gap-y-4 text-sm">
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">チーム (Team)</dt>
                                        <dd className="font-medium text-white">{listing.team || '---'}</dd>
                                    </div>
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">年度 (Year)</dt>
                                        <dd className="font-medium text-white">{listing.year || '---'}</dd>
                                    </div>
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">ブランド (Brand)</dt>
                                        <dd className="font-medium text-white">{listing.manufacturer || '---'}</dd>
                                    </div>
                                    {listing.variation && (
                                        <div className="col-span-1">
                                            <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">バリエーション</dt>
                                            <dd className="font-medium text-white">{listing.variation}</dd>
                                        </div>
                                    )}
                                    {listing.serial_number && (
                                        <div className="col-span-1">
                                            <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">シリアル番号</dt>
                                            <dd className="font-mono text-brand-gold">{listing.serial_number}</dd>
                                        </div>
                                    )}
                                </dl>
                            </div>

                            {/* --- Description --- */}
                            {listing.description && (
                                <div className="border-t border-brand-platinum/10 py-6">
                                    <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-3">商品説明 (Description)</h3>
                                    <p className="text-brand-platinum/80 leading-relaxed whitespace-pre-wrap">{listing.description}</p>
                                </div>
                            )}

                            <div className="border-t border-brand-platinum/10 py-8">
                                <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-6">状態・グレーディング (Condition)</h3>
                                <div className="grid grid-cols-2 gap-y-6 gap-x-4">
                                    <div>
                                        <p className="text-xs text-brand-platinum/50 uppercase mb-1">鑑定有無 (Graded)</p>
                                        <p className="font-medium text-white text-lg">{listing.condition_grading.is_graded ? 'あり (Yes)' : 'なし (No)'}</p>
                                    </div>
                                    {!listing.condition_grading.is_graded && (
                                        <div>
                                            <p className="text-xs text-brand-platinum/50 uppercase mb-1">状態 (Condition)</p>
                                            <p className="font-medium text-white text-lg">{listing.condition_rating || listing.condition_grading.service || '---'}</p>
                                        </div>
                                    )}
                                    {listing.condition_grading.is_graded && (
                                        <>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">鑑定機関 (Service)</p>
                                                <p className="font-medium text-white text-lg">{listing.condition_grading.service}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">グレード点数 (Score)</p>
                                                <p className="font-heading font-bold text-3xl text-brand-blue text-glow">{listing.condition_grading.score}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">証明番号 (Cert #)</p>
                                                <p className="font-mono text-sm text-brand-platinum">{listing.condition_grading.certification_number}</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* --- Moment History Timeline --- */}
                            {(() => {
                                // Merge Active (Live) Moments into the history for display
                                const displayHistory = [...(listing.moment_history || [])];

                                // Inject Active Moments for ALL listings (including owned)
                                // This encourages owners to sell when a card is "hot" (Live).
                                // [RESTORED & REFINED] Per user request (Step 7743), we restore this injection BUT with a check.
                                // If the Active Moment matches a moment captured in the Purchase Snapshot (origin_order),
                                // we treat it as "Real" (is_virtual: false), allowing the owner to write memories.
                                // Otherwise, it implies a Future Event (Opportunity), so we treat it as "Virtual" (Read-only).

                                const originOrder = listing.origin_order ? (Array.isArray(listing.origin_order) ? listing.origin_order[0] : listing.origin_order) : null;
                                const snapshotIds = originOrder && originOrder.moment_snapshot
                                    ? (Array.isArray(originOrder.moment_snapshot) ? originOrder.moment_snapshot.map((s: any) => s.id) : [originOrder.moment_snapshot.id])
                                    : [];

                                activeMoments.forEach(am => {
                                    const isAlreadyAccountedFor = displayHistory.some((m: any) =>
                                        (m.moment_id === am.id) || (m.id === am.id)
                                    );

                                    if (!isAlreadyAccountedFor) {
                                        // Check if this active moment was captured in the purchase snapshot
                                        const isCapturedInSnapshot = snapshotIds.includes(am.id);

                                        // [CHANGED] Strictly HIDE virtual moments from the history list.
                                        // Only show active moments if they are part of the OWNED history (captured in snapshot).
                                        if (isCapturedInSnapshot) {
                                            displayHistory.push({
                                                id: am.id,
                                                moment_id: am.id,
                                                title: am.title,
                                                description: am.description,
                                                timestamp: am.created_at,
                                                status: 'live', // Mark as live
                                                player_name: am.player_name,
                                                intensity: am.intensity,
                                                match_result: am.match_result,
                                                is_virtual: false // It is real/owned
                                            } as any);
                                        }
                                    }
                                });

                                return (
                                    <MomentHistoryPanel
                                        history={displayHistory}
                                        itemId={listing.id}
                                        isOwner={user?.id === listing.seller_id}
                                        onSuccess={fetchListingAndUser}
                                    />
                                );
                            })()}

                            <div className="border-t border-brand-platinum/10 pt-8 mt-auto">
                                <div className="flex items-end justify-between mb-8">
                                    <div>
                                        <p className="text-sm text-brand-platinum/50 uppercase tracking-wider mb-1">
                                            {listing.status === 'Display' ? 'ステータス' : '現在価格'}
                                        </p>
                                        {listing.status === 'Display' ? (
                                            <span className="px-4 py-2 rounded-lg bg-brand-platinum/10 border border-brand-platinum/20 text-white font-bold tracking-wider">
                                                展示のみ (Display Only)
                                            </span>
                                        ) : (
                                            <p className="text-5xl font-heading font-bold text-brand-gold text-gold-glow tracking-tight">
                                                ¥{listing.price?.toLocaleString() ?? '---'}
                                            </p>
                                        )}
                                    </div>
                                </div>

                                {user?.id === listing.seller_id ? (
                                    <div className="bg-brand-dark-light/50 p-6 rounded-xl text-center border border-brand-platinum/10">
                                        <p className="text-brand-platinum font-medium">あなたの出品商品です。</p>
                                        <button
                                            onClick={() => setIsEditModalOpen(true)}
                                            className="mt-4 text-brand-blue hover:text-brand-blue-glow text-sm font-bold uppercase tracking-wider transition-colors"
                                        >
                                            出品を編集
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        {listing.status === 'Active' ? (
                                            <>
                                                <Link
                                                    href={`/checkout/${listing.id}`}
                                                    className="block w-full bg-brand-blue hover:bg-brand-blue-glow text-white text-xl font-bold py-5 rounded-xl transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:shadow-[0_0_40px_rgba(59,130,246,0.6)] hover:scale-[1.02] text-center"
                                                >
                                                    購入手続きへ
                                                </Link>
                                                <div className="flex items-center justify-center mt-6 gap-2 text-brand-platinum/40 text-sm">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                                    Secure transaction via Stripe
                                                </div>
                                            </>
                                        ) : (
                                            <div className="bg-brand-dark-light/30 p-6 rounded-xl text-center border border-brand-platinum/5">
                                                <p className="text-brand-platinum/60">
                                                    この商品は{listing.status === 'Display' ? '展示のみで' : '現在'}購入できません。
                                                </p>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <Footer />

            <AddToShowcaseModal
                isOpen={isEditModalOpen}
                onClose={() => setIsEditModalOpen(false)}
                onAdded={handleEditSuccess}
                mode="edit"
                initialData={listing}
            />
        </div>
    );
}
</file>

<file path="frontend/app/login/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';

import { Suspense } from 'react';

function LoginForm() {
    const [email, setEmail] = useState('demo@example.com');
    const [password, setPassword] = useState('password');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const router = useRouter();
    const searchParams = useSearchParams();

    useEffect(() => {
        if (searchParams.get('registered') === 'true') {
            // Optional: Show a success message if redirected from registration
        }
    }, [searchParams]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
            const supabase = createClient();
            const { error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                setError(error.message);
            } else {
                window.location.href = '/';
            }
        } catch (err) {
            setError('予期せぬエラーが発生しました');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="glass-panel-premium p-8 rounded-2xl shadow-2xl border border-white/10">
            <form className="space-y-6" onSubmit={handleSubmit}>
                {error && (
                    <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl text-sm">
                        {error}
                    </div>
                )}

                {searchParams.get('registered') === 'true' && !error && (
                    <div className="bg-green-500/10 border border-green-500/20 text-green-400 px-4 py-3 rounded-xl text-sm">
                        アカウント作成が完了しました。ログインしてください。
                    </div>
                )}

                <div>
                    <label htmlFor="email" className="block text-sm font-medium text-brand-platinum mb-2">
                        メールアドレス (Email)
                    </label>
                    <input
                        id="email"
                        name="email"
                        type="email"
                        autoComplete="email"
                        required
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                        placeholder="name@example.com"
                    />
                </div>

                <div>
                    <label htmlFor="password" className="block text-sm font-medium text-brand-platinum mb-2">
                        パスワード (Password)
                    </label>
                    <input
                        id="password"
                        name="password"
                        type="password"
                        autoComplete="current-password"
                        required
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                        placeholder="••••••••"
                    />
                </div>

                <div>
                    <button
                        type="submit"
                        disabled={loading}
                        className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                        {loading ? 'ログイン処理中...' : 'ログイン'}
                    </button>
                </div>
            </form>

            <div className="mt-6 text-center">
                <p className="text-sm text-brand-platinum/60">
                    アカウントをお持ちでない場合は{' '}
                    <Link href="/register" className="font-medium text-brand-blue hover:text-brand-blue-glow transition-colors">
                        新規登録
                    </Link>
                </p>
            </div>
        </div>
    );
}

export default function LoginPage() {
    return (
        <div className="min-h-screen flex flex-col">
            <div className="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div className="max-w-md w-full space-y-8">
                    <div className="text-center">
                        <Link href="/" className="inline-block mb-6 group">
                            <span className="font-heading text-4xl font-bold tracking-tighter text-white group-hover:text-glow transition-all">
                                TC<span className="text-brand-gold text-gold-glow">.APP</span>
                            </span>
                        </Link>
                        <h2 className="text-3xl font-heading font-bold text-white">
                            おかえりなさい
                        </h2>
                        <p className="mt-2 text-brand-platinum/60">
                            コレクションにアクセスするにはログインしてください。
                        </p>
                    </div>

                    <Suspense fallback={<div className="text-center text-white">読み込み中...</div>}>
                        <LoginForm />
                    </Suspense>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/market/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import CardListing from '../../components/CardListing';
import Footer from '../../components/Footer';
import { ListingItem, Team } from '../../types';

function MarketPageContent() {
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const [listings, setListings] = useState<ListingItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    // Search & Filter State
    const [searchQuery, setSearchQuery] = useState(searchParams.get('search') || '');
    const [selectedTeam, setSelectedTeam] = useState<string>('');
    const [sortOrder, setSortOrder] = useState('newest');

    // Debounce search
    const [debouncedSearch, setDebouncedSearch] = useState(searchQuery);

    useEffect(() => {
        const timer = setTimeout(() => {
            setDebouncedSearch(searchQuery);
        }, 500);
        return () => clearTimeout(timer);
    }, [searchQuery]);

    useEffect(() => {
        const fetchListings = async () => {
            setLoading(true);
            try {
                const supabase = createClient();
                const now = new Date();
                const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();

                // 1. Fetch Active Live Moments
                const { data: activeMoments } = await supabase
                    .from('live_moments')
                    .select('player_name, created_at')
                    .gt('created_at', lookback);

                // Store full objects for time calculation
                const momentsData = activeMoments || [];

                const activePlayers = Array.from(new Set(momentsData?.map(m => (m.player_name || '').toLowerCase().trim()) || []));
                console.log("Active Players (Live):", activePlayers);

                // Helper to build base query with filters
                const buildBaseQuery = () => {
                    let q = supabase
                        .from('listing_items')
                        .select('*')
                        .eq('status', 'Active');

                    if (selectedTeam) {
                        q = q.eq('team', selectedTeam);
                    }
                    return q;
                };

                let finalData: any[] = [];

                if (sortOrder === 'newest' && activePlayers.length > 0) {
                    // --- Priority Logic ---

                    // A. Fetch Priority Listings (Matches Active Players)
                    // A. Fetch Priority Listings (Matches Active Players)
                    let pQuery = buildBaseQuery()
                        .in('player_name', activePlayers)
                        .order('created_at', { ascending: false });

                    // B. Fetch Regular Listings (Non-Active Players)
                    const activePlayersList = `(${activePlayers.map(p => `"${p}"`).join(',')})`;
                    let rQuery = buildBaseQuery()
                        .not('player_name', 'in', activePlayersList)
                        .order('created_at', { ascending: false });

                    // Execute in parallel
                    const [pRes, rRes] = await Promise.all([pQuery, rQuery]);

                    if (pRes.error) throw pRes.error;
                    if (rRes.error) throw rRes.error;

                    finalData = [...(pRes.data || []), ...(rRes.data || [])];

                } else {
                    // --- Standard Logic ---
                    let query = buildBaseQuery();

                    if (sortOrder === 'newest') {
                        query = query.order('created_at', { ascending: false });
                    } else if (sortOrder === 'price_asc') {
                        query = query.order('price', { ascending: true, nullsFirst: false });
                    } else if (sortOrder === 'price_desc') {
                        query = query.order('price', { ascending: false, nullsFirst: false });
                    }

                    const { data, error } = await query;
                    if (error) throw error;
                    finalData = data || [];
                }

                // Client-side Text Search (as before)
                if (debouncedSearch) {
                    const lowerSearch = debouncedSearch.toLowerCase();
                    finalData = finalData.filter((item: any) =>
                        (item.player_name || '').toLowerCase().includes(lowerSearch) ||
                        (item.manufacturer || '').toLowerCase().includes(lowerSearch) ||
                        (item.series_name || '').toLowerCase().includes(lowerSearch)
                    );
                }

                // INJECT LIVE MOMENT FLAG
                // This ensures the CardListing receives true if player is in the active list (Case Insensitive & Fuzzy)
                finalData = finalData.map((item: any) => {
                    const itemName = (item.player_name || '').toLowerCase();

                    // Find all matching moments (Multiple Moments Support)
                    const matchedMoments = momentsData.filter((m: any) => {
                        const p1 = (m.player_name || '').toLowerCase();
                        if (itemName.includes(p1)) return true;
                        if (p1.includes(itemName)) return true;
                        return false;
                    });

                    // Store all end times as an array
                    const liveMoments = matchedMoments.map((m: any) => {
                        let endTime = null;
                        if (m.created_at) {
                            const created = new Date(m.created_at).getTime();
                            if (!isNaN(created)) {
                                endTime = created + 60 * 60 * 1000;
                            }
                        }
                        return {
                            id: m.id,
                            title: m.title,
                            endTime: endTime
                        };
                    }).filter(m => m.endTime !== null);

                    return {
                        ...item,
                        is_live_moment: liveMoments.length > 0,
                        live_moments: liveMoments
                    };
                });

                setListings(finalData);

            } catch (err) {
                console.error(err);
                setError(err instanceof Error ? err.message : 'An unknown error occurred');
            } finally {
                setLoading(false);
            }
        };

        fetchListings();
    }, [debouncedSearch, selectedTeam, sortOrder]);

    const teams: Team[] = ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"];

    const teamDisplayNames: Record<Team, string> = {
        Giants: "読売ジャイアンツ",
        Tigers: "阪神タイガース",
        Dragons: "中日ドラゴンズ",
        Swallows: "ヤクルトスワローズ",
        Carp: "広島カープ",
        BayStars: "横浜ベイスターズ",
        Hawks: "ソフトバンクホークス",
        Fighters: "日本ハムファイターズ",
        Marines: "千葉ロッテマリーンズ",
        Buffaloes: "オリックスバファローズ",
        Eagles: "楽天イーグルス",
        Lions: "埼玉西武ライオンズ",
        SamuraiJapan: "侍ジャパン",
        Other: "その他"
    };

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pb-20">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full">
                <div className="mb-8">
                    <h1 className="text-4xl font-heading font-bold text-white mb-2">マーケット</h1>
                    <p className="text-brand-platinum/60">プレミアムなプロ野球カードを探そう</p>
                </div>

                {/* Search & Filter Bar */}
                <div className="glass-panel-premium p-6 rounded-2xl shadow-2xl mb-12 animate-fade-in-up">
                    <div className="flex flex-col md:flex-row gap-4 items-center">
                        {/* Search Input */}
                        <div className="flex-1 w-full">
                            <label htmlFor="search" className="sr-only">Search</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg className="h-5 w-5 text-brand-platinum/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input
                                    type="text"
                                    id="search"
                                    placeholder="選手名、シリーズ名、年度で検索..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="block w-full pl-10 pr-3 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                />
                            </div>
                        </div>

                        {/* Team Filter */}
                        <div className="w-full md:w-48">
                            <label htmlFor="team" className="sr-only">Team</label>
                            <select
                                id="team"
                                value={selectedTeam}
                                onChange={(e) => setSelectedTeam(e.target.value)}
                                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
                            >
                                <option value="">すべてのチーム</option>
                                {teams.map((team) => (
                                    <option key={team} value={team}>{teamDisplayNames[team]}</option>
                                ))}
                            </select>
                        </div>

                        {/* Sort Order */}
                        <div className="w-full md:w-48">
                            <label htmlFor="sort" className="sr-only">Sort</label>
                            <select
                                id="sort"
                                value={sortOrder}
                                onChange={(e) => setSortOrder(e.target.value)}
                                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
                            >
                                <option value="newest">新着順</option>
                                <option value="price_asc">価格: 安い順</option>
                                <option value="price_desc">価格: 高い順</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* Listings Grid */}
                <div className="mb-12">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-heading font-bold text-white">出品一覧</h2>
                        <span className="text-brand-platinum/60 text-sm">{listings.length} 件見つかりました</span>
                    </div>

                    {loading ? (
                        <div className="min-h-[400px] flex items-center justify-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
                        </div>
                    ) : error ? (
                        <div className="min-h-[400px] flex items-center justify-center">
                            <div className="text-red-500 text-xl font-semibold bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error}</div>
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6">
                                {listings.map((item) => (
                                    <CardListing
                                        key={item.id}
                                        item={item}
                                        isLiveMoment={(item as any).is_live_moment || isDebugLive}
                                        liveMoments={(item as any).live_moments}
                                    />
                                ))}
                            </div>

                            {listings.length === 0 && (
                                <div className="text-center py-20 bg-brand-dark-light/30 rounded-2xl border border-brand-platinum/5">
                                    <p className="text-brand-platinum/50 text-lg">該当する出品が見つかりませんでした。</p>
                                    <button
                                        onClick={() => { setSearchQuery(''); setSelectedTeam(''); }}
                                        className="mt-4 text-brand-blue hover:text-brand-blue-glow font-medium"
                                    >
                                        フィルターをクリア
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                </div>
            </div>

            <Footer />
        </div>
    );
}

export default function MarketPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <MarketPageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/orders/[id]/success/page.tsx">
'use client';

import { useParams } from 'next/navigation';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import Image from 'next/image';
import { createClient } from '../../../../utils/supabase/client';
import { getBuyerItemByOrder } from '../../../../app/actions/item';
import MomentHistoryPanel from '../../../../components/MomentHistoryPanel';

export default function OrderSuccessPage() {
    const params = useParams();
    const id = params.id as string;

    const [order, setOrder] = useState<any>(null);
    const [buyerItem, setBuyerItem] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [retryCount, setRetryCount] = useState(0);
    const [user, setUser] = useState<any>(null);

    const fetchData = async () => {
        const supabase = createClient();

        // 0. Fetch User
        const { data: { user: userData } } = await supabase.auth.getUser();
        setUser(userData);

        // 1. Fetch order with listing details
        const { data: orderData } = await supabase
            .from('orders')
            .select('*, listing:listing_items!listing_id(*)')
            .eq('id', id)
            .single();

        if (orderData) {
            setOrder(orderData);

            // 2. Detect Active Live Moment for this player
            const playerName = orderData.listing?.player_name;
            if (playerName) {
                const now = new Date();
                const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();
                const listingPlayerName = playerName.toLowerCase();

                const { data: moments } = await supabase
                    .from('live_moments')
                    .select('*')
                    .gt('created_at', lookback)
                    .order('created_at', { ascending: false });

                if (moments) {
                    const matched = moments.filter(m => {
                        const activePlayer = (m.player_name || '').toLowerCase();
                        return listingPlayerName.includes(activePlayer) || activePlayer.includes(listingPlayerName);
                    });
                    setActiveMoments(matched);
                }
            }

            // 3. Try to find the buyer's cloned item
            const item = await getBuyerItemByOrder(id);
            if (item) {
                setBuyerItem(item);
            }
        }
        setLoading(false);
    };

    useEffect(() => {
        if (id) {
            fetchData();
        }
    }, [id]);

    // Polling for buyerItem (Stripe Webhook might be slow)
    useEffect(() => {
        if (id && !buyerItem && retryCount < 150 && !loading) {
            const timer = setTimeout(() => {
                console.log(`Polling for buyer item (Attempt ${retryCount + 1}/150)...`);
                setRetryCount(prev => prev + 1);
                fetchData();
            }, 2000); // Poll every 2 seconds
            return () => clearTimeout(timer);
        }
    }, [id, buyerItem, retryCount, loading]);

    if (loading && retryCount === 0) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    const listing = order?.listing;

    return (
        <div className="min-h-screen bg-brand-dark py-12 px-4 sm:px-6 lg:px-8 flex flex-col items-center">
            <div className="w-full max-w-2xl">
                <div className="glass-panel-premium py-10 px-6 sm:px-10 shadow-2xl rounded-2xl text-center border border-white/10 relative overflow-hidden">
                    {/* Decorative Background */}
                    <div className="absolute -top-24 -right-24 w-64 h-64 bg-brand-blue/10 rounded-full blur-[80px]"></div>
                    <div className="absolute -bottom-24 -left-24 w-64 h-64 bg-brand-gold/5 rounded-full blur-[80px]"></div>

                    <div className="relative z-10">
                        <div className="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-brand-blue/20 mb-6 border border-brand-blue/30 shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                            <svg className="h-10 w-10 text-brand-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>

                        <h2 className="text-3xl font-heading font-bold text-white mb-2 tracking-tight">Purchase Successful!</h2>
                        <p className="text-brand-platinum/60 mb-8 max-w-md mx-auto">
                            Thank you for your order. Your transaction has been completed and the card is now part of your collection.
                        </p>

                        {/* Order ID Box */}
                        <div className="bg-black/40 rounded-xl p-4 mb-8 border border-white/5 inline-block mx-auto">
                            <p className="text-[10px] text-brand-platinum/40 uppercase tracking-widest mb-1 font-bold">Order ID</p>
                            <p className="font-mono text-xs text-brand-blue-glow break-all px-4">{id}</p>
                        </div>

                        {/* Card Details Summary */}
                        {listing && (
                            <div className="bg-brand-dark-light/40 rounded-2xl p-6 mb-8 border border-brand-gold/20 flex flex-col sm:flex-row items-center gap-6 text-left group">
                                <div className="relative w-32 h-44 flex-shrink-0 rounded-lg overflow-hidden border border-white/10 shadow-xl group-hover:border-brand-gold/50 transition-colors">
                                    <Image
                                        src={listing.images?.[0] || '/placeholder-card.png'}
                                        alt={listing.player_name || 'Card'}
                                        fill
                                        className="object-cover"
                                    />
                                </div>
                                <div className="flex-1">
                                    <p className="text-brand-gold text-xs font-bold uppercase tracking-widest mb-1">Newly Acquired</p>
                                    <h3 className="text-2xl font-bold text-white mb-1">{listing.player_name}</h3>
                                    <p className="text-brand-platinum/70 text-sm mb-4">
                                        {listing.year} {listing.manufacturer} {listing.series_name}
                                    </p>
                                    <div className="flex flex-wrap gap-2">
                                        <span className="px-2 py-1 bg-white/5 rounded text-[10px] font-bold text-brand-platinum/50 border border-white/10">#{listing.card_number}</span>
                                        {listing.is_rookie && <span className="px-2 py-1 bg-brand-gold/10 rounded text-[10px] font-bold text-brand-gold border border-brand-gold/20">ROOKIE</span>}
                                        <span className="px-2 py-1 bg-brand-blue/10 rounded text-[10px] font-bold text-brand-blue border border-brand-blue/20 uppercase">{listing.condition_grading?.score || 'RAW'}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Moment History (Legendary Log) */}
                        <div className="text-left mb-8 border-t border-white/5 pt-8">
                            <h3 className="text-xs font-bold text-brand-platinum/40 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-brand-gold animate-pulse"></span>
                                {buyerItem ? "Start Your Card's Legend" : (retryCount < 10 ? "Preparing your card for memories..." : "Recording delayed - You can add memories later in Collection")}
                            </h3>
                            {(() => {
                                let displayHistory = [...(buyerItem?.history || listing?.moment_history || [])];

                                // Virtual Moment Injection: 
                                // Check if active live moments are captured in the snapshot (Owned) or are new (Virtual).
                                const snapshotIds = order?.moment_snapshot
                                    ? (Array.isArray(order.moment_snapshot) ? order.moment_snapshot.map((s: any) => s.id) : [order.moment_snapshot.id])
                                    : [];

                                activeMoments.forEach(am => {
                                    if (!displayHistory.some(m => m.moment_id === am.id)) {
                                        // If this active moment is in the snapshot, it's REAL (Owned History), so allow editing.
                                        const isCaptured = snapshotIds.includes(am.id);
                                        const isVirtual = !isCaptured;

                                        displayHistory.push({
                                            moment_id: am.id,
                                            title: am.title,
                                            description: am.description,
                                            timestamp: am.created_at,
                                            status: 'live',
                                            player_name: am.player_name,
                                            intensity: am.intensity,
                                            match_result: am.match_result,
                                            is_virtual: isVirtual
                                        });
                                    }
                                });

                                if (displayHistory.length === 0 && !buyerItem) {
                                    return (
                                        <div className="p-8 rounded-xl bg-white/5 border border-dashed border-white/10 text-center">
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-brand-gold mb-2"></div>
                                            <p className="text-xs text-brand-platinum/30 uppercase tracking-widest">
                                                {retryCount < 10 ? "Syncing Ownership..." : "Sync taking longer than expected"}
                                            </p>
                                        </div>
                                    );
                                }

                                return (
                                    <MomentHistoryPanel
                                        history={displayHistory}
                                        itemId={buyerItem?.id || undefined}
                                        isOwner={!!(user && order && user.id === order.buyer_id)}
                                        onSuccess={fetchData}
                                    />
                                );
                            })()}
                        </div>

                        {/* Navigation Buttons */}
                        <div className="flex flex-col sm:flex-row gap-4 mt-10">
                            <Link
                                href="/collection"
                                className="flex-1 flex justify-center items-center py-4 px-6 rounded-xl text-sm font-bold text-white bg-white/5 hover:bg-white/10 border border-white/10 transition-all hover:scale-[1.02] active:scale-[0.98]"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                Go to Collection
                            </Link>
                            <Link
                                href="/market"
                                className="flex-1 flex justify-center items-center py-4 px-6 border border-transparent rounded-xl shadow-[0_0_20px_rgba(59,130,246,0.3)] text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow transition-all hover:scale-[1.02] active:scale-[0.98]"
                            >
                                Back to Market
                                <svg className="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </Link>
                        </div>

                        <p className="mt-8 text-[10px] text-brand-platinum/30 uppercase tracking-[0.2em] font-light">
                            Secured and Verified by Stadium Card Chain
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/orders/buy/[id]/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation';
import MomentHistoryPanel from '../../../../components/MomentHistoryPanel';
import { createClient } from '../../../../utils/supabase/client';
import { markAsReceived, getBuyerOrderDetails } from '../../../actions/order';
import { getBuyerItemByOrder } from '../../../actions/item';

interface OrderDetail {
    id: string;
    buyer_id: string;
    status: string;
    listing: {
        title: string;
        player_name: string;
        images: string[];
        price: number;
        seller_id: string;
        moment_history?: any[];
    };
    created_at: string;
    tracking_number?: string;
    carrier?: string;
    shipped_at?: string;
    completed_at?: string;
    moment_snapshot?: any | null; // Can be object or array
}

export default function BuyerOrderPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const [order, setOrder] = useState<OrderDetail | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);
    const [buyerItem, setBuyerItem] = useState<{ id: string; history: any[] } | null>(null);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [retryCount, setRetryCount] = useState(0);
    const [user, setUser] = useState<any>(null);

    const fetchOrder = async () => {
        try {
            const supabase = createClient();
            const { data: { user: userData } } = await supabase.auth.getUser();
            setUser(userData);

            const data = await getBuyerOrderDetails(id);
            setOrder(data as any);
            setLoading(false);

            if (data) {
                // 1. Fetch buyer's copy if paid, shipped or completed
                if (['paid', 'shipped', 'completed', 'AwaitingShipment'].includes(data.status)) {
                    const itemData = await getBuyerItemByOrder(id);
                    if (itemData) setBuyerItem(itemData);
                }

                // 2. Detect Active Live Moment: Removed.
                // We rely strictly on snapshots captured at checkout creation.
            }
        } catch (error: any) {
            console.error('Fetch Order Error:', error);
            alert(error.message || 'Order not found');
            router.push('/collection');
        }
    };

    useEffect(() => {
        fetchOrder();
    }, [id, router]);

    // Polling for buyerItem (Stripe Webhook might be slow)
    useEffect(() => {
        if (id && !buyerItem && retryCount < 150 && !loading) {
            const timer = setTimeout(() => {
                console.log(`Polling for buyer item (Attempt ${retryCount + 1}/150)...`);
                setRetryCount(prev => prev + 1);
                fetchOrder();
            }, 2000); // Poll every 2 seconds
            return () => clearTimeout(timer);
        }
    }, [id, buyerItem, retryCount, loading]);

    const handleReceive = async () => {
        if (!confirm('Have you received the item? This will complete the transaction and release funds to the seller.')) return;

        setSubmitting(true);
        try {
            await markAsReceived(id);
            alert('Transaction Completed!');
            window.location.reload();
        } catch (error: any) {
            alert(error.message || 'Failed to update status');
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-white">Loading...</div>;
    if (!order) return null;

    return (
        <div className="min-h-screen bg-brand-dark text-white pt-24 pb-12 px-4">
            <div className="max-w-2xl mx-auto glass-panel-premium rounded-2xl p-8 border border-white/10">
                <h1 className="text-2xl font-bold font-heading mb-6 flex items-center justify-between">
                    <span>Order Status</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider
                        ${order.status === 'completed' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                            order.status === 'shipped' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                                'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'}`}>
                        {order.status.replace('_', ' ')}
                    </span>
                </h1>

                {/* Moment Certificates */}
                {order.moment_snapshot && (
                    <div className="flex flex-col gap-4 mb-8">
                        {(Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot]).map((moment: any, idx: number) => (
                            <div key={moment.id || idx} className="relative overflow-hidden rounded-xl p-[2px] bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 animate-gradient-xy shadow-[0_0_20px_rgba(234,179,8,0.3)]">
                                <div className="bg-black/90 rounded-[10px] p-6 relative overflow-hidden backdrop-blur-xl">
                                    {/* Decorative Background Elements */}
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 blur-[50px] rounded-full pointer-events-none" />
                                    <div className="absolute bottom-0 left-0 w-32 h-32 bg-red-500/10 blur-[50px] rounded-full pointer-events-none" />

                                    <div className="relative z-10 flex flex-col md:flex-row md:items-center gap-4 md:gap-6">
                                        <div className="flex-shrink-0 w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-red-600 flex items-center justify-center text-3xl shadow-lg">
                                            🏆
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-xs font-bold uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">
                                                    Moment Captured / 伝説の瞬間
                                                </span>
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${moment.is_finalized ? 'bg-green-500' : 'bg-red-500 animate-pulse'} text-white`}>
                                                    {moment.is_finalized ? 'MATCH END' : 'LIVE'}
                                                </span>
                                            </div>
                                            <h3 className="text-xl font-bold text-white mb-1">
                                                {moment.title}
                                            </h3>
                                            <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-brand-platinum/80">
                                                <span className="flex items-center gap-1">
                                                    <span className="text-brand-gold">Player:</span> {moment.player_name}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <span className="text-brand-gold">Time:</span> {new Date(moment.created_at).toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div className="mt-2 text-xs text-center text-brand-platinum/60 italic font-serif">
                            "このカードは、これらの歴史的瞬間の熱狂の中で取引されました。"
                        </div>
                    </div>
                )}

                {/* Item Summary */}
                <div className="flex gap-4 mb-8 bg-white/5 p-4 rounded-xl border border-white/5">
                    {order.listing.images?.[0] && (
                        <div className="w-20 h-28 relative rounded overflow-hidden">
                            <img src={order.listing.images[0]} alt="Item" className="object-cover w-full h-full" />
                        </div>
                    )}
                    <div>
                        <h2 className="font-bold text-lg">{order.listing.player_name}</h2>
                        <p className="text-brand-platinum/60 text-sm">{order.listing.title}</p>
                        <p className="text-brand-gold font-mono mt-1">¥{order.listing.price.toLocaleString()}</p>
                    </div>
                </div>

                {/* Tracking Info */}
                {(order.status === 'shipped' || order.status === 'completed') && (
                    <div className="mb-8 p-6 bg-brand-blue/5 border border-brand-blue/10 rounded-xl">
                        <h3 className="text-brand-blue font-bold mb-4 flex items-center gap-2">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            Shipment Details
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <p className="text-xs text-brand-platinum/60 uppercase">Carrier</p>
                                <p className="font-bold text-lg">{order.carrier || 'Not specified'}</p>
                            </div>
                            <div>
                                <p className="text-xs text-brand-platinum/60 uppercase">Tracking Number</p>
                                <p className="font-mono text-lg tracking-wider">{order.tracking_number || 'No tracking number'}</p>
                            </div>
                        </div>
                        {order.shipped_at && (
                            <p className="text-xs text-brand-platinum/40 mt-4 text-right">Shipped: {new Date(order.shipped_at).toLocaleString()}</p>
                        )}
                    </div>
                )}

                {/* Moment History Logic */}
                {(() => {
                    const displayHistory = [...(buyerItem?.history || order.listing?.moment_history || [])];

                    // 1. Snapshot Injection: Moments captured at time of purchase
                    // These should ALWAYS be visible throughout the order lifecycle.
                    const snapshots = order.moment_snapshot ? (Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot]) : [];
                    snapshots.forEach((sm: any) => {
                        if (!displayHistory.some((m: any) => (m.moment_id === sm.id) || (m.id === sm.id))) {
                            displayHistory.push({
                                ...sm,
                                moment_id: sm.id,
                                status: 'recorded', // Mark as recorded (historical but confirmed)
                                is_snapshot: true
                            });
                        }
                    });

                    // 2. Virtual Moment Injection: Removed as per user request.
                    // Only moments captured in the snapshot (at checkout time) should be displayed.
                    if (displayHistory.length === 0) {
                        if (!buyerItem && retryCount < 10 && ['paid', 'shipped', 'completed'].includes(order.status)) {
                            return (
                                <div className="p-8 rounded-xl bg-white/5 border border-dashed border-white/10 text-center mb-8">
                                    <div className="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-brand-gold mb-2"></div>
                                    <p className="text-xs text-brand-platinum/30 uppercase tracking-widest">
                                        Preparing your card for memories...
                                    </p>
                                </div>
                            );
                        }
                        return null;
                    }

                    return (
                        <>
                            {/* Memory Tagging CTA */}
                            {['paid', 'shipped', 'completed'].includes(order.status) && (
                                <div className="mb-8 p-6 rounded-2xl bg-gradient-to-br from-brand-gold/20 via-brand-gold/5 to-transparent border border-brand-gold/30 relative overflow-hidden group shadow-xl">
                                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                        <span className="text-6xl text-brand-gold">✍️</span>
                                    </div>
                                    <div className="relative z-10 text-center">
                                        <h3 className="text-lg font-bold text-white mb-2">
                                            <span className="text-brand-gold">Legendary History</span> - あなたの想い出を刻みませんか？
                                        </h3>
                                        <p className="text-sm text-brand-platinum/70 leading-relaxed max-w-lg mx-auto">
                                            下記の「Legendary History」セクションの各瞬間の横にあるボタン <span className="inline-block p-1 bg-white/10 rounded-md"><svg className="w-3 h-3 text-brand-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></span> から、<br />
                                            あなただけのストーリーや想い出をカードに刻むことができます。
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* History Panel */}
                            <div id="history-panel">
                                <MomentHistoryPanel
                                    history={displayHistory}
                                    itemId={buyerItem?.id || undefined}
                                    isOwner={!!(user && order && user.id === order.buyer_id)}
                                    onSuccess={fetchOrder}
                                />
                            </div>
                        </>
                    );
                })()}

                {/* Action Area */}
                {order.status === 'shipped' ? (
                    <div className="mb-8">
                        <div className="p-4 bg-brand-gold/10 border border-brand-gold/20 rounded-lg text-brand-gold mb-4 text-sm">
                            Please confirm receiving the item only after verifying its condition. This action is irreversible.
                        </div>
                        <button
                            onClick={handleReceive}
                            disabled={submitting}
                            className="w-full bg-brand-gold text-brand-dark font-bold py-4 rounded-xl hover:bg-brand-gold/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-brand-gold/20"
                        >
                            {submitting ? 'Processing...' : 'I Received the Item (Complete Transaction)'}
                        </button>
                    </div>
                ) : order.status === 'completed' ? (
                    <div className="mb-8 p-6 bg-green-500/10 border border-green-500/20 rounded-xl text-center">
                        <h3 className="text-green-400 font-bold text-xl mb-2">Transaction Completed</h3>
                        <p className="text-brand-platinum/60 text-sm">Thank you for your purchase.</p>
                    </div>
                ) : order.status === 'processing' || order.status === 'open' || order.status === 'pending' ? (
                    <div className="mb-8 p-6 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-center">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-yellow-500 mb-4"></div>
                        <h3 className="text-yellow-400 font-bold text-xl mb-2">Payment Processing</h3>
                        <p className="text-brand-platinum/60 text-sm">
                            We are confirming your payment. This typically takes a few moments.<br />
                            Once confirmed, you will be able to record your moments.
                        </p>
                        <button onClick={() => window.location.reload()} className="mt-4 text-xs text-yellow-500/80 hover:text-yellow-400 underline">
                            Check Status Again
                        </button>
                    </div>
                ) : (
                    <div className="mb-8 p-6 bg-white/5 border border-white/10 rounded-xl text-center text-brand-platinum/60">
                        Waiting for seller to ship...
                    </div>
                )}

                <button onClick={() => router.back()} className="text-brand-platinum hover:text-white transition-colors text-sm">
                    &larr; Back to Collection
                </button>
            </div>
        </div >
    );
}
</file>

<file path="frontend/app/orders/sell/[id]/page.tsx">
'use client';

import { useEffect, useState, use } from 'react'; // React 19: use() for params
import { useRouter } from 'next/navigation';
import { createClient } from '../../../../utils/supabase/client';
import { markAsShipped, getSellerOrderDetails } from '../../../actions/order';
import { SellerOrderDetail } from '../../../../types/index';



export default function SellerOrderPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const [order, setOrder] = useState<SellerOrderDetail | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);

    // Form State
    const [trackingNumber, setTrackingNumber] = useState('');
    const [carrier, setCarrier] = useState('');

    useEffect(() => {
        const fetchOrder = async () => {
            // No need to check user here, Server Action checks it.
            // But we might need standard auth check for redirect? 
            // Better to let SA throw error.

            try {
                const data = await getSellerOrderDetails(id);
                setOrder(data as SellerOrderDetail);
                setLoading(false);
            } catch (error: any) {
                console.error('Fetch Order Error:', error);
                alert(error.message || 'Order not found');
                router.push('/collection');
            }
        };
        fetchOrder();
    }, [id, router]);

    const handleShip = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!confirm('Mark as shipped? This will notify the buyer.')) return;

        setSubmitting(true);
        try {
            await markAsShipped(id, trackingNumber, carrier);
            alert('Order mark as shipped!');
            // Refresh
            window.location.reload();
        } catch (error: any) {
            alert(error.message || 'Failed to update status');
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-white">Loading...</div>;
    if (!order) return null;

    // Resolve Shipping Address (Snapshot vs Legacy columns)
    const shippingInfo = order.shipping_address_snapshot || {
        name: order.shipping_name || 'Unknown',
        postal_code: order.shipping_postal_code || '',
        address: order.shipping_address || '',
        phone: order.shipping_phone || ''
    };

    return (
        <div className="min-h-screen bg-brand-dark text-white pt-24 pb-12 px-4">
            <div className="max-w-2xl mx-auto glass-panel-premium rounded-2xl p-8 border border-white/10">
                <h1 className="text-2xl font-bold font-heading mb-6 flex items-center justify-between">
                    <span>Manage Order</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider
                        ${order.status === 'completed' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                            order.status === 'shipped' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                                order.status === 'awaiting_shipping' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :
                                    'bg-gray-500/20 text-gray-400'}`}>
                        {order.status.replace('_', ' ')}
                    </span>
                </h1>

                {/* Item Summary */}
                <div className="flex gap-4 mb-8 bg-white/5 p-4 rounded-xl border border-white/5">
                    {order.listing.images?.[0] && (
                        <div className="w-20 h-28 relative rounded overflow-hidden">
                            <img src={order.listing.images[0]} alt="Item" className="object-cover w-full h-full" />
                        </div>
                    )}
                    <div>
                        <h2 className="font-bold text-lg">{order.listing.player_name}</h2>
                        <p className="text-brand-platinum/60 text-sm">{order.listing.title}</p>
                        <p className="text-brand-gold font-mono mt-1">¥{(order.listing.price || 0).toLocaleString()}</p>
                    </div>
                </div>

                {/* Financial Summary */}
                <div className="mb-8 p-6 rounded-xl bg-white/5 border border-white/10 space-y-4">
                    <h3 className="text-sm font-bold text-brand-platinum/60 uppercase tracking-widest mb-2 font-heading">会計明細 (Financial Summary)</h3>

                    <div className="space-y-3">
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">注文日時 (Ordered At)</span>
                            <span className="text-white font-mono">{new Date(order.created_at).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">販売価格 (Sale Price)</span>
                            <span className="text-white font-bold">¥{(order.total_amount || 0).toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">販売手数料 (Platform Fee 10%)</span>
                            <span className="text-red-400">-¥{Math.floor((order.total_amount || 0) * 0.1).toLocaleString()}</span>
                        </div>
                        <div className="pt-3 border-t border-white/10 flex justify-between items-center">
                            <span className="text-brand-gold font-bold">振込予定金額 (Seller Net)</span>
                            <span className="text-brand-gold text-xl font-bold font-heading">¥{Math.floor((order.total_amount || 0) * 0.9).toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="mt-4 p-3 bg-brand-blue/10 border border-brand-blue/20 rounded-lg">
                        <p className="text-xs text-brand-blue leading-relaxed">
                            ※ <strong>配送料は出品者（販売者）負担</strong>となります。発送時に配送業者へお支払いください。
                        </p>
                    </div>
                </div>

                {/* Shipping Action Area */}
                {order.status === 'awaiting_shipping' || order.status === 'paid' ? (
                    <div className="mb-8">

                        {/* Privacy Warning Banner */}
                        <div className="bg-red-900/20 border border-red-600/50 rounded-xl p-4 mb-6 flex gap-4 items-start">
                            <div className="text-2xl">⚠️</div>
                            <div>
                                <h4 className="font-bold text-red-500 mb-1 text-sm uppercase tracking-wider">個人情報の取り扱いについて (Strictly Prohibited)</h4>
                                <p className="text-sm text-red-200/80 leading-relaxed">
                                    表示されている購入者の氏名・住所は、<span className="font-bold text-white">商品の発送目的以外での利用を固く禁じます。</span> SNSへの投稿や第三者への共有、取引終了後の利用は法律により罰せられる可能性があります。
                                </p>
                            </div>
                        </div>

                        <div className="bg-brand-blue/10 border border-brand-blue/20 p-6 rounded-xl mb-6">
                            <h3 className="text-brand-blue font-bold mb-4 flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                Shipping Address
                            </h3>
                            <div className="text-sm space-y-1">
                                <p className="font-bold text-lg">{shippingInfo.name}</p>
                                <p>〒{shippingInfo.postal_code}</p>
                                <p>{shippingInfo.address}</p>
                                <p className="text-brand-platinum/60 mt-2">Phone: {shippingInfo.phone}</p>
                            </div>

                        </div>

                        <form onSubmit={handleShip} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-brand-platinum mb-1">Carrier (Optional)</label>
                                <input
                                    type="text"
                                    value={carrier}
                                    onChange={(e) => setCarrier(e.target.value)}
                                    placeholder="e.g. Yamato, Japan Post"
                                    className="w-full bg-brand-dark-light border border-brand-platinum/20 rounded-lg px-4 py-3 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold outline-none transition-all"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-brand-platinum mb-1">Tracking Number (Optional)</label>
                                <input
                                    type="text"
                                    value={trackingNumber}
                                    onChange={(e) => setTrackingNumber(e.target.value)}
                                    placeholder="e.g. 1234-5678-9012"
                                    className="w-full bg-brand-dark-light border border-brand-platinum/20 rounded-lg px-4 py-3 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold outline-none transition-all"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={submitting}
                                className="w-full bg-brand-gold text-brand-dark font-bold py-4 rounded-xl hover:bg-brand-gold/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4"
                            >
                                {submitting ? 'Processing...' : 'Notify Shipment'}
                            </button>
                        </form>
                    </div>
                ) : (
                    <div className="mb-8 p-6 bg-white/5 rounded-xl border border-white/10 text-center">
                        <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-500/20 text-green-400 mb-4">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        </div>
                        <h3 className="text-xl font-bold mb-2">Item Shipped</h3>
                        {order.shipped_at && <p className="text-sm text-brand-platinum/60 mb-4">Shipped on {new Date(order.shipped_at).toLocaleDateString()}</p>}

                        {(order.carrier || order.tracking_number) && (
                            <div className="text-left bg-black/20 p-4 rounded-lg inline-block w-full text-sm">
                                {order.carrier && <p><span className="text-brand-platinum/60">Carrier:</span> {order.carrier}</p>}
                                {order.tracking_number && <p><span className="text-brand-platinum/60">Tracking:</span> {order.tracking_number}</p>}
                            </div>
                        )}
                    </div>
                )}

                <button onClick={() => router.back()} className="text-brand-platinum hover:text-white transition-colors text-sm">
                    &larr; Back to Collection
                </button>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/payouts/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { createClient } from '../../utils/supabase/client';
import Footer from '../../components/Footer';
import {
    getAvailableBalance,
    registerBankAccount,
    requestPayout,
    getPayoutHistory,
    getBankAccount,
    updateProfileKana,
    getProfileKana,
    getSalesHistory
} from '../actions/payout';
import { BankAccount, Payout, SalesHistoryItem } from '../../types';

import { useZengin, Bank, Branch } from '../../hooks/useZengin';

export default function PayoutPage() {
    const [loading, setLoading] = useState(true);
    const [userId, setUserId] = useState<string | null>(null);

    // Data State
    const [balanceData, setBalanceData] = useState({ available: 0, totalEarnings: 0, totalFees: 0, withdrawn: 0, orderCount: 0 });
    const [bankAccount, setBankAccount] = useState<BankAccount | null>(null);
    const [payoutHistory, setPayoutHistory] = useState<Payout[]>([]);
    const [profileKana, setProfileKana] = useState<string | null>(null);
    const [salesHistory, setSalesHistory] = useState<SalesHistoryItem[]>([]);
    const [showAllSales, setShowAllSales] = useState(false);

    // Form State
    const [payoutAmount, setPayoutAmount] = useState<number>(0);
    const [settingBank, setSettingBank] = useState(false); // Modal toggle

    // Zengin Hook
    const { banks, branches, fetchBranches, loadingBanks, loadingBranches } = useZengin();

    // Bank Selection State
    const [selectedBank, setSelectedBank] = useState<Bank | null>(null);
    const [selectedBranch, setSelectedBranch] = useState<Branch | null>(null);
    const [bankSearch, setBankSearch] = useState('');
    const [branchSearch, setBranchSearch] = useState('');
    const [showBankList, setShowBankList] = useState(false);
    const [showBranchList, setShowBranchList] = useState(false);

    // Bank Form
    const [bankForm, setBankForm] = useState({
        bankName: '',
        bankCode: '',
        branchName: '',
        branchCode: '',
        accountType: 'ordinary' as 'ordinary' | 'current',
        accountNumber: '',
        accountHolderName: ''
    });

    const [fieldErrors, setFieldErrors] = useState({
        bankName: false,
        branchName: false,
        accountNumber: false
    });

    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const [successMsg, setSuccessMsg] = useState<string | null>(null);

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                setUserId(user.id);
                await refreshData(user.id);
            }
            setLoading(false);
        };
        init();
    }, []);

    // Auto-heal legacy data: If we have bank name but no code, try to find it in loaded banks
    useEffect(() => {
        if (bankAccount && !bankAccount.bank_code && banks.length > 0 && !selectedBank) {
            const match = banks.find(b => b.name === bankAccount.bank_name);
            if (match) {
                console.log("Auto-healing bank code for:", match.name);
                // Update local form state (this doesn't save to DB until they click Register)
                setBankForm(prev => ({ ...prev, bankCode: match.code }));
                setSelectedBank(match);
                fetchBranches(match.code);
            }
        }
    }, [bankAccount, banks, selectedBank]);

    const refreshData = async (uid: string) => {
        try {
            const [bal, bank, hist, kana, sales] = await Promise.all([
                getAvailableBalance(uid),
                getBankAccount(uid),
                getPayoutHistory(uid),
                getProfileKana(uid),
                getSalesHistory(uid)
            ]);
            setBalanceData(bal);
            setBankAccount(bank);
            setPayoutHistory(hist || []);
            setProfileKana(kana);
            setSalesHistory(sales || []);

            // Pre-fill bank form if exists
            if (bank) {
                setBankForm({
                    bankName: bank.bank_name,
                    bankCode: bank.bank_code || '',
                    branchName: bank.branch_name,
                    branchCode: bank.branch_code || '',
                    accountType: bank.account_type as 'ordinary' | 'current',
                    accountNumber: bank.account_number,
                    accountHolderName: bank.account_holder_name
                });

                // Initialize input search fields
                setBankSearch(bank.bank_name);
                setBranchSearch(bank.branch_name);

                // Set Selected Bank if code exists (for branch enabling)
                if (bank.bank_code) {
                    setSelectedBank({ code: bank.bank_code, name: bank.bank_name, kana: '', hira: '', roma: '' } as Bank);
                    // Fetch branches for this code so user can edit branch immediately if needed
                    fetchBranches(bank.bank_code);
                }
            }
        } catch (err) {
            console.error(err);
        }
    };

    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleRegisterBank = async () => {
        if (!userId || isSubmitting) return;

        // Reset errors
        setFieldErrors({ bankName: false, branchName: false, accountNumber: false });
        setErrorMsg(null);

        const newErrors = {
            bankName: !bankForm.bankName.trim(),
            branchName: !bankForm.branchName.trim(),
            accountNumber: !bankForm.accountNumber.trim() || bankForm.accountNumber.length !== 7
        };

        if (newErrors.bankName || newErrors.branchName || newErrors.accountNumber) {
            setFieldErrors(newErrors);
            if (newErrors.accountNumber && bankForm.accountNumber.length !== 7 && bankForm.accountNumber.trim()) {
                setErrorMsg("Account Number must be exactly 7 digits.");
            } else {
                setErrorMsg("Please fill in all highlighted fields.");
            }
            return;
        }

        setIsSubmitting(true);
        try {
            setErrorMsg(null);
            // 1. Register Bank
            await registerBankAccount(userId, bankForm);

            // 2. Close Modal Immediately for responsiveness
            setSettingBank(false);
            setSuccessMsg("Bank account registered successfully.");

            // 3. Refresh Data in Background
            await refreshData(userId);

        } catch (err: any) {
            setErrorMsg(err.message);
            // If failed, keep modal open to show error
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleRequestPayout = async () => {
        if (!userId) return;

        if (payoutAmount < 1000) {
            setErrorMsg("Minimum payout amount is ¥1,000.");
            return;
        }

        try {
            setErrorMsg(null);
            await requestPayout(userId, payoutAmount);
            await refreshData(userId);
            setPayoutAmount(0);
            setSuccessMsg("Payout requested successfully.");
        } catch (err: any) {
            setErrorMsg(err.message);
        }
    };

    // Filter Banks
    const filteredBanks = banks.filter(b =>
        b.name.includes(bankSearch) ||
        b.code.includes(bankSearch) ||
        b.kana.includes(bankSearch)
    );

    // Filter Branches
    const filteredBranches = branches.filter(b =>
        b.name.includes(branchSearch) ||
        b.code.includes(branchSearch) ||
        b.kana.includes(branchSearch)
    );

    const selectBank = (bank: Bank) => {
        setSelectedBank(bank);
        setBankForm(prev => ({ ...prev, bankName: bank.name, bankCode: bank.code, branchName: '', branchCode: '' }));
        setFieldErrors(prev => ({ ...prev, bankName: false }));
        setBankSearch(bank.name);
        setShowBankList(false);
        fetchBranches(bank.code);
        setBranchSearch('');
        setSelectedBranch(null);
    };

    const selectBranch = (branch: Branch) => {
        setSelectedBranch(branch);
        setBankForm(prev => ({ ...prev, branchName: branch.name, branchCode: branch.code }));
        setFieldErrors(prev => ({ ...prev, branchName: false }));
        setBranchSearch(branch.name);
        setShowBranchList(false);
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-brand-gold">Loading...</div>;
    if (!userId) return <div className="min-h-screen bg-brand-dark p-10 text-white">Please Log In</div>;

    const displayHolderName = profileKana ? profileKana.replace(/[\s\u3000]+/g, '') : '';

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pt-32 pb-12">
            <div className="max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 flex-1">

                <h1 className="text-3xl font-heading font-bold text-white mb-8 border-b border-white/10 pb-4">
                    売上管理
                </h1>

                {errorMsg && (
                    <div className="mb-6 p-4 bg-red-500/10 border border-red-500/30 text-red-500 rounded-lg">
                        {errorMsg}
                    </div>
                )}
                {successMsg && (
                    <div className="mb-6 p-4 bg-green-500/10 border border-green-500/30 text-green-500 rounded-lg">
                        {successMsg}
                    </div>
                )}

                {/* --- 1. Dashboard: Balance --- */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div className="p-6 rounded-2xl bg-brand-dark-light/50 border border-brand-gold/20 shadow-[0_0_30px_rgba(234,179,8,0.05)]">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">振込可能残高</p>
                        <p className="text-4xl text-brand-gold font-heading font-bold">
                            ¥{balanceData.available.toLocaleString()}
                        </p>
                    </div>
                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/5">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">累計収益</p>
                        <p className="text-2xl text-white font-heading font-bold">
                            ¥{balanceData.totalEarnings.toLocaleString()}
                        </p>
                        <p className="text-xs text-brand-platinum/50 mt-1">
                            {balanceData.orderCount}件の取引 / 手数料 ¥{balanceData.totalFees.toLocaleString()}
                        </p>
                    </div>
                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/5">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">出金済み/申請中</p>
                        <p className="text-2xl text-white font-heading font-bold">
                            ¥{balanceData.withdrawn.toLocaleString()}
                        </p>
                    </div>
                </div>

                {/* --- 1.5. Sales History --- */}
                <div className="mb-10">
                    <h2 className="text-xl font-bold text-white mb-4">売上明細</h2>
                    <div className="rounded-xl overflow-hidden border border-white/10">
                        {/* Desktop Table */}
                        <div className="hidden md:block">
                            <table className="w-full text-left text-sm text-brand-platinum">
                                <thead className="bg-brand-dark-light/50 text-brand-platinum/60 uppercase text-xs">
                                    <tr>
                                        <th className="px-4 py-3">カード</th>
                                        <th className="px-4 py-3">選手名 / シリーズ</th>
                                        <th className="px-4 py-3">販売日</th>
                                        <th className="px-4 py-3 text-right">販売価格</th>
                                        <th className="px-4 py-3 text-right">手数料</th>
                                        <th className="px-4 py-3 text-right">純収益</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-white/5">
                                    {salesHistory.length === 0 ? (
                                        <tr><td colSpan={6} className="px-6 py-8 text-center opacity-50">販売履歴はまだありません</td></tr>
                                    ) : (
                                        (showAllSales ? salesHistory : salesHistory.slice(0, 10)).map(sale => (
                                            <tr key={sale.orderId} className="hover:bg-white/5">
                                                <td className="px-4 py-3">
                                                    {sale.listing?.image ? (
                                                        // eslint-disable-next-line @next/next/no-img-element
                                                        <img src={sale.listing.image} alt="" className="w-10 h-14 object-cover rounded" />
                                                    ) : (
                                                        <div className="w-10 h-14 bg-brand-dark-light rounded flex items-center justify-center text-brand-platinum/30">
                                                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <p className="text-white font-medium">{sale.listing?.playerName || '不明'}</p>
                                                    <p className="text-xs text-brand-platinum/50">
                                                        {[sale.listing?.year, sale.listing?.manufacturer].filter(Boolean).join(' ')}
                                                    </p>
                                                </td>
                                                <td className="px-4 py-3 text-brand-platinum/70">
                                                    {new Date(sale.completedAt).toLocaleDateString('ja-JP')}
                                                </td>
                                                <td className="px-4 py-3 text-right text-white font-mono">
                                                    ¥{sale.saleAmount.toLocaleString()}
                                                </td>
                                                <td className="px-4 py-3 text-right text-red-400 text-xs">
                                                    -¥{sale.platformFee.toLocaleString()} ({Math.round(sale.feeRate * 100)}%)
                                                </td>
                                                <td className="px-4 py-3 text-right text-brand-gold font-bold font-mono">
                                                    ¥{sale.netEarning.toLocaleString()}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Mobile Cards */}
                        <div className="md:hidden divide-y divide-white/5">
                            {salesHistory.length === 0 ? (
                                <p className="px-6 py-8 text-center opacity-50">販売履歴はまだありません</p>
                            ) : (
                                (showAllSales ? salesHistory : salesHistory.slice(0, 10)).map(sale => (
                                    <div key={sale.orderId} className="p-4 hover:bg-white/5">
                                        <div className="flex items-center gap-3 mb-2">
                                            {sale.listing?.image ? (
                                                // eslint-disable-next-line @next/next/no-img-element
                                                <img src={sale.listing.image} alt="" className="w-10 h-14 object-cover rounded" />
                                            ) : (
                                                <div className="w-10 h-14 bg-brand-dark-light rounded flex items-center justify-center text-brand-platinum/30">
                                                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                </div>
                                            )}
                                            <div className="flex-1">
                                                <p className="text-white font-medium">{sale.listing?.playerName || '不明'}</p>
                                                <p className="text-xs text-brand-platinum/50">
                                                    {[sale.listing?.year, sale.listing?.manufacturer].filter(Boolean).join(' ')}
                                                </p>
                                            </div>
                                            <p className="text-brand-gold font-bold">¥{sale.netEarning.toLocaleString()}</p>
                                        </div>
                                        <div className="flex justify-between text-xs text-brand-platinum/60">
                                            <span>{new Date(sale.completedAt).toLocaleDateString('ja-JP')}</span>
                                            <span>販売 ¥{sale.saleAmount.toLocaleString()} / 手数料 -¥{sale.platformFee.toLocaleString()}</span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Show All Button */}
                        {salesHistory.length > 10 && !showAllSales && (
                            <div className="p-4 border-t border-white/5 text-center">
                                <button
                                    onClick={() => setShowAllSales(true)}
                                    className="text-brand-blue hover:text-brand-blue-glow text-sm font-medium"
                                >
                                    すべて表示（全{salesHistory.length}件）
                                </button>
                            </div>
                        )}
                    </div>
                </div>

                {/* --- 2. Bank Settings & Profile Name --- */}
                <div className="mb-10">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white">口座登録</h2>
                        {!bankAccount && (
                            <button
                                onClick={() => setSettingBank(true)}
                                className="px-4 py-2 bg-brand-blue/10 text-brand-blue border border-brand-blue/30 rounded-lg hover:bg-brand-blue/20 transition-all font-bold text-sm"
                            >
                                口座を登録
                            </button>
                        )}
                        {bankAccount && (
                            <button
                                onClick={() => setSettingBank(true)}
                                className="px-4 py-2 bg-brand-platinum/10 text-brand-platinum border border-brand-platinum/20 rounded-lg hover:bg-brand-platinum/20 transition-all font-bold text-sm"
                            >
                                口座を編集
                            </button>
                        )}
                    </div>

                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/10">
                        {bankAccount ? (
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><span className="text-brand-platinum/50 block">金融機関</span> <span className="text-white">{bankAccount.bank_name}</span></div>
                                <div><span className="text-brand-platinum/50 block">支店</span> <span className="text-white">{bankAccount.branch_name}</span></div>
                                <div><span className="text-brand-platinum/50 block">種別</span> <span className="text-white">{bankAccount.account_type === 'ordinary' ? '普通' : '当座'}</span></div>
                                <div><span className="text-brand-platinum/50 block">口座番号</span> <span className="text-white">****{bankAccount.account_number.slice(-4)}</span></div>
                                <div className="col-span-2 border-t border-white/5 pt-2 mt-2">
                                    <span className="text-brand-platinum/50 block">名義人</span>
                                    <span className="text-brand-gold font-mono">{bankAccount.account_holder_name}</span>
                                </div>
                            </div>
                        ) : (
                            <p className="text-brand-platinum/50 italic">口座情報が登録されていません。</p>
                        )}
                    </div>
                </div>

                {/* --- 3. Withdraw Action --- */}
                <div className="mb-10 p-6 rounded-2xl bg-brand-dark-light/30 border border-white/10">
                    <h2 className="text-xl font-bold text-white mb-4">出金申請</h2>
                    <div className="flex flex-col md:flex-row gap-6 items-start md:items-end">
                        <div className="flex-1 w-full">
                            <label className="block text-brand-platinum/60 text-xs uppercase mb-2">出金希望額</label>
                            <input
                                type="number"
                                value={payoutAmount || ''}
                                onChange={(e) => setPayoutAmount(Math.max(0, parseInt(e.target.value) || 0))}
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-lg px-4 py-3 text-white focus:border-brand-gold focus:outline-none mb-2"
                                placeholder="最低 ￥1,000"
                            />

                            {/* Fee Calculation Display */}
                            <div className="bg-brand-dark p-3 rounded-lg border border-white/5 text-sm space-y-1">
                                <div className="flex justify-between text-brand-platinum/60">
                                    <span>出金希望額:</span>
                                    <span>￥{payoutAmount.toLocaleString()}</span>
                                </div>
                                <div className="flex justify-between text-brand-platinum/60">
                                    <span>振込手数料:</span>
                                    {/* Fee Rule: If Input >= 30,000, 0. Else 250. */}
                                    <span className="text-red-400">
                                        {(payoutAmount >= 30000) ? '￥0' : '￥250'}
                                    </span>
                                </div>
                                <div className="border-t border-white/10 my-1"></div>
                                <div className="flex justify-between font-bold text-white">
                                    <span>合計減算額:</span>
                                    <span className="text-brand-gold">
                                        ￥{(payoutAmount + (payoutAmount >= 30000 ? 0 : 250)).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <p className="text-[10px] text-brand-platinum/50 mt-2">
                                ※ 振込手数料￥250。￥30,000以上の出金で無料。
                            </p>
                        </div>

                        <button
                            onClick={handleRequestPayout}
                            disabled={
                                !bankAccount ||
                                payoutAmount < 1000 ||
                                (payoutAmount + (payoutAmount >= 30000 ? 0 : 250)) > balanceData.available
                            }
                            className="w-full md:w-auto bg-brand-gold text-brand-dark font-bold px-8 py-3 rounded-lg hover:bg-brand-gold-light disabled:opacity-50 disabled:cursor-not-allowed transition-colors h-[50px]"
                        >
                            出金を申請
                        </button>
                    </div>
                    {(!bankAccount) && <p className="text-red-400 text-xs mt-2">先に口座情報を登録してください。</p>}
                    {/* Error if Total > Balance */}
                    {((payoutAmount + (payoutAmount >= 30000 ? 0 : 250)) > balanceData.available) &&
                        <p className="text-red-400 text-xs mt-2">残高が不足しています。</p>}
                    {(payoutAmount > 0 && payoutAmount < 1000) && <p className="text-red-400 text-xs mt-2">最低出金額は￥1,000です。</p>}
                </div>

                {/* --- 4. History --- */}
                <div>
                    <h2 className="text-xl font-bold text-white mb-4">出金履歴</h2>
                    <div className="rounded-xl overflow-hidden border border-white/10">
                        <table className="w-full text-left text-sm text-brand-platinum">
                            <thead className="bg-brand-dark-light/50 text-brand-platinum/60 uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-3">日付</th>
                                    <th className="px-6 py-3">金額</th>
                                    <th className="px-6 py-3">ステータス</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {payoutHistory.length === 0 ? (
                                    <tr><td colSpan={3} className="px-6 py-8 text-center opacity-50">出金履歴はありません</td></tr>
                                ) : (
                                    payoutHistory.map(p => (
                                        <tr key={p.id} className="hover:bg-white/5">
                                            <td className="px-6 py-4">{new Date(p.created_at).toLocaleDateString('ja-JP')}</td>
                                            <td className="px-6 py-4 text-white font-mono">￥{p.amount.toLocaleString()}</td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 rounded text-xs border ${p.status === 'paid' ? 'border-green-500/30 text-green-400 bg-green-500/10' :
                                                    p.status === 'rejected' ? 'border-red-500/30 text-red-400 bg-red-500/10' :
                                                        'border-yellow-500/30 text-yellow-400 bg-yellow-500/10'
                                                    }`}>
                                                    {p.status === 'paid' ? '振込済' : p.status === 'rejected' ? '却下' : '申請中'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <Footer />

            {/* --- Modals --- */}
            {settingBank && (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="bg-brand-dark-light border border-white/10 rounded-t-2xl sm:rounded-2xl w-full max-w-md p-6 shadow-2xl h-[90vh] sm:h-auto overflow-y-auto">
                        <h3 className="text-xl font-bold text-white mb-4 border-b border-white/10 pb-2">Bank Account</h3>

                        {!profileKana ? (
                            /* BLOCKER VIEW */
                            <div className="py-8 flex flex-col items-center text-center space-y-4">
                                <div className="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
                                </div>
                                <h4 className="text-lg font-bold text-white">Profile Name Required</h4>
                                <p className="text-brand-platinum/80 text-sm">
                                    To register a bank account, you must first set your <strong>Real Name (Katakana)</strong> in your profile.<br />
                                    This ensures the name matches your bank account holder name.
                                </p>
                                <a href="/profile" className="mt-4 px-6 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-xl w-full">
                                    Go to Profile Settings
                                </a>
                                <button onClick={() => setSettingBank(false)} className="text-brand-platinum text-sm hover:text-white mt-4">
                                    Close
                                </button>
                            </div>
                        ) : (
                            /* FORM VIEW */
                            <div className="space-y-5">
                                {/* 1. Bank Name Combobox */}
                                <div className="relative">
                                    <label className={`block text-xs mb-1 ${fieldErrors.bankName ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Bank Name <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className={`w-full bg-brand-dark border rounded-lg p-3 text-white focus:outline-none transition-colors ${fieldErrors.bankName ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                        placeholder="Search bank name or code..."
                                        value={bankSearch}
                                        onChange={e => {
                                            const val = e.target.value;
                                            setBankSearch(val);
                                            setShowBankList(true);
                                            setFieldErrors(prev => ({ ...prev, bankName: false }));

                                            // Live match or update text
                                            const match = banks.find(b => b.name === val || b.code === val);
                                            if (match) {
                                                setSelectedBank(match);
                                                setBankForm(prev => ({ ...prev, bankName: match.name, bankCode: match.code, branchName: '', branchCode: '' }));
                                                fetchBranches(match.code);
                                                setBranchSearch('');
                                                setSelectedBranch(null);
                                            } else {
                                                setSelectedBank(null);
                                                setBankForm(prev => ({ ...prev, bankName: val, bankCode: '' }));
                                                // If loose text, we can't fetch branches yet or ensure validity, but we save the text.
                                            }
                                        }}
                                        onFocus={() => setShowBankList(true)}
                                    />
                                    {showBankList && (
                                        <div className="absolute z-50 top-full left-0 w-full max-h-60 overflow-y-auto bg-brand-dark border border-brand-platinum/20 rounded-lg mt-1 shadow-xl">
                                            {loadingBanks ? <div className="p-3 text-xs text-brand-platinum">Loading banks...</div> :
                                                filteredBanks.length === 0 ? <div className="p-3 text-xs text-brand-platinum">No banks found.</div> :
                                                    filteredBanks.map(bank => (
                                                        <button
                                                            key={bank.code}
                                                            className="w-full text-left px-4 py-3 hover:bg-white/5 border-b border-white/5 last:border-0 text-sm text-white"
                                                            onClick={() => selectBank(bank)}
                                                        >
                                                            <span className="text-brand-platinum/60 mr-2 text-xs">{bank.code}</span>
                                                            {bank.name}
                                                        </button>
                                                    ))
                                            }
                                        </div>
                                    )}
                                </div>

                                {/* 2. Branch Name Combobox */}
                                <div className="relative">
                                    <label className={`block text-xs mb-1 ${fieldErrors.branchName ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Branch Name <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className={`w-full bg-brand-dark border rounded-lg p-3 text-white focus:outline-none transition-colors ${!selectedBank ? 'opacity-50 cursor-not-allowed' : ''} ${fieldErrors.branchName ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                        placeholder="Search branch name or code..."
                                        value={branchSearch}
                                        onChange={e => {
                                            const val = e.target.value;
                                            setBranchSearch(val);
                                            setShowBranchList(true);
                                            setFieldErrors(prev => ({ ...prev, branchName: false }));

                                            // Live match branch
                                            if (selectedBank) {
                                                // Need to search in 'branches' if available? 'branches' are loaded for selectedBank.
                                                // Since filteredBranches is derived from branches, we can search branches.
                                                const match = branches.find(b => b.name === val || b.code === val);
                                                if (match) {
                                                    setSelectedBranch(match);
                                                    setBankForm(prev => ({ ...prev, branchName: match.name, branchCode: match.code }));
                                                } else {
                                                    setSelectedBranch(null);
                                                    setBankForm(prev => ({ ...prev, branchName: val, branchCode: '' }));
                                                }
                                            }
                                        }}
                                        onFocus={() => setShowBranchList(true)}
                                        disabled={!selectedBank}
                                    />
                                    {showBranchList && selectedBank && (
                                        <div className="absolute z-50 top-full left-0 w-full max-h-60 overflow-y-auto bg-brand-dark border border-brand-platinum/20 rounded-lg mt-1 shadow-xl">
                                            {loadingBranches ? <div className="p-3 text-xs text-brand-platinum">Loading branches...</div> :
                                                filteredBranches.length === 0 ? <div className="p-3 text-xs text-brand-platinum">No branches found.</div> :
                                                    filteredBranches.map(branch => (
                                                        <button
                                                            key={branch.code}
                                                            className="w-full text-left px-4 py-3 hover:bg-white/5 border-b border-white/5 last:border-0 text-sm text-white"
                                                            onClick={() => selectBranch(branch)}
                                                        >
                                                            <span className="text-brand-platinum/60 mr-2 text-xs">{branch.code}</span>
                                                            {branch.name}
                                                        </button>
                                                    ))
                                            }
                                        </div>
                                    )}
                                </div>

                                {/* 3. Type & Number */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-brand-platinum/60 mb-1">Type</label>
                                        <select className="w-full bg-brand-dark border border-brand-platinum/20 rounded-lg p-3 text-white outline-none"
                                            value={bankForm.accountType} onChange={e => setBankForm(prev => ({ ...prev, accountType: e.target.value as any }))}>
                                            <option value="ordinary">普通 (Ordinary)</option>
                                            <option value="current">当座 (Current)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className={`block text-xs mb-1 ${fieldErrors.accountNumber ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Number (7 digits) <span className="text-red-400">*</span></label>
                                        <input type="text"
                                            className={`w-full bg-brand-dark border rounded-lg p-3 text-white outline-none font-mono transition-colors ${fieldErrors.accountNumber ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                            placeholder="1234567"
                                            maxLength={7}
                                            value={bankForm.accountNumber}
                                            onChange={e => {
                                                const val = e.target.value.replace(/[^0-9]/g, '');
                                                setBankForm(prev => ({ ...prev, accountNumber: val }));
                                                setFieldErrors(prev => ({ ...prev, accountNumber: false }));
                                            }} />
                                    </div>
                                </div>

                                {/* 4. Holder Name (Read Only with Sync) */}
                                <div>
                                    <label className="block text-xs text-brand-platinum/60 mb-1">Account Holder Name (Auto-Synced) <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className="w-full bg-brand-dark/50 border border-brand-platinum/10 rounded-lg p-3 text-brand-platinum font-mono cursor-not-allowed"
                                        value={displayHolderName}
                                        readOnly
                                        title="Synced with Profile"
                                    />
                                    <div className="mt-2 p-2 bg-blue-500/10 border border-blue-500/20 rounded text-[10px] text-blue-300 flex items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mt-[1px] flex-shrink-0"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="16" y2="12" /><line x1="12" x2="12.01" y1="8" y2="8" /></svg>
                                        <span>
                                            Name is synced from your profile.<br />
                                            To change it, please update your <a href="/profile" className="underline hover:text-white font-bold">Profile Settings</a>.
                                        </span>
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button onClick={() => setSettingBank(false)} className="flex-1 py-3 border border-white/10 text-brand-platinum rounded-xl hover:bg-white/5 transition-all text-sm font-bold">Cancel</button>
                                    <button onClick={handleRegisterBank} disabled={isSubmitting} className="flex-1 py-3 bg-brand-gold text-brand-dark font-bold rounded-xl hover:bg-brand-gold-light transition-all text-sm shadow-lg shadow-brand-gold/10 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {isSubmitting ? 'Processing...' : 'Register Bank'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/app/profile/[userId]/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { createClient } from '@/utils/supabase/client';
import { useParams, useSearchParams } from 'next/navigation';
import ShowcaseCard from '@/components/ShowcaseCard';
import SkeletonCard from '@/components/SkeletonCard';
import Image from 'next/image';
import Footer from '../../../components/Footer';

function ProfilePageContent() {
    const params = useParams();
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const userId = params.userId as string;
    const [profile, setProfile] = useState<any>(null);
    const [activeTab, setActiveTab] = useState<'showcase' | 'selling'>('showcase');
    const [displayItems, setDisplayItems] = useState<any[]>([]);
    const [activeItems, setActiveItems] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            if (!userId) return;
            setLoading(true);
            const supabase = createClient();

            try {
                // Fetch Profile
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (profileError) throw profileError;
                setProfile(profileData);

                // Fetch Public Items (Display & Active)
                const { data: itemsData, error: itemsError } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('seller_id', userId)
                    .in('status', ['Display', 'Active']);

                if (itemsError) throw itemsError;

                // Split items by status
                const display = itemsData?.filter(item => item.status === 'Display') || [];
                const active = itemsData?.filter(item => item.status === 'Active') || [];

                setDisplayItems(display);
                setActiveItems(active);

            } catch (error) {
                console.error('Failed to fetch profile data:', error);
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [userId]);

    const handleShare = () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('Profile URL copied to clipboard!');
        });
    };

    if (loading) {
        return (
            <div className="min-h-screen pt-32 pb-12 px-4 sm:px-6 lg:px-8 bg-brand-dark relative overflow-hidden">
                <div className="max-w-6xl mx-auto relative z-10">
                    {/* Header Skeleton */}
                    <div className="flex flex-col md:flex-row items-center md:items-end gap-8 mb-12 p-8 rounded-2xl bg-white/5 border border-white/10 animate-pulse">
                        <div className="w-32 h-32 rounded-full bg-brand-platinum/10"></div>
                        <div className="flex-1 w-full space-y-4">
                            <div className="h-8 bg-brand-platinum/10 rounded w-1/2 mx-auto md:mx-0"></div>
                            <div className="h-4 bg-brand-platinum/10 rounded w-1/3 mx-auto md:mx-0"></div>
                        </div>
                    </div>
                    {/* Grid Skeleton */}
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                        {[...Array(5)].map((_, i) => (
                            <SkeletonCard key={i} />
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    if (!profile) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark text-white">
                User not found.
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute top-0 left-0 w-full h-[400px] bg-gradient-to-b from-brand-blue/10 to-transparent pointer-events-none"></div>
            <div className="absolute -top-20 -right-20 w-96 h-96 bg-brand-gold/5 rounded-full blur-3xl pointer-events-none"></div>

            <div className="flex-1 w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-12 relative z-10">
                {/* Profile Header */}
                <div className="flex flex-col md:flex-row items-center md:items-end gap-8 mb-12 p-8 rounded-2xl bg-white/5 border border-white/10 shadow-2xl backdrop-blur-md relative overflow-hidden group">
                    {/* Header Background Glow */}
                    <div className="absolute inset-0 bg-gradient-to-r from-brand-blue/10 via-transparent to-brand-gold/5 opacity-50 group-hover:opacity-100 transition-opacity duration-700"></div>

                    {/* Avatar */}
                    <div className="relative">
                        <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-brand-gold/50 shadow-[0_0_20px_rgba(234,179,8,0.3)] relative z-10 bg-brand-dark">
                            {profile.avatar_url ? (
                                <Image
                                    src={profile.avatar_url}
                                    alt={profile.name}
                                    fill
                                    sizes="128px"
                                    className="object-cover"
                                />
                            ) : (
                                <div className="w-full h-full bg-brand-platinum/10 flex items-center justify-center text-brand-platinum/40">
                                    <svg className="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                </div>
                            )}
                        </div>
                        {/* Avatar Glow */}
                        <div className="absolute inset-0 rounded-full bg-brand-gold/20 blur-xl -z-10 scale-110"></div>
                    </div>

                    {/* User Info */}
                    <div className="flex-1 text-center md:text-left z-10">
                        <h1 className="text-4xl md:text-5xl font-heading font-bold text-white mb-2 tracking-tight drop-shadow-lg">
                            {profile.name || 'Anonymous User'}
                        </h1>
                        <div className="flex items-center justify-center md:justify-start gap-4 text-brand-platinum/80 text-sm font-mono">
                            <span className="flex items-center gap-1">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                Member since {new Date(profile.created_at).getFullYear()}
                            </span>
                            <span className="w-1 h-1 rounded-full bg-brand-platinum/40"></span>
                            <span className="flex items-center gap-1 text-brand-gold">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                {displayItems.length} Items Displayed
                            </span>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="z-10">
                        <button
                            onClick={handleShare}
                            className="px-6 py-2.5 bg-white/10 hover:bg-white/20 text-white border border-white/20 rounded-full transition-all font-bold text-sm flex items-center gap-2 backdrop-blur-sm group/btn"
                        >
                            <svg className="w-5 h-5 group-hover/btn:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                            Share Profile
                        </button>
                    </div>
                </div>

                {/* Tabs & Content */}
                <div className="glass-panel-premium shadow-2xl overflow-hidden rounded-2xl border border-white/10">
                    <div className="border-b border-brand-platinum/10">
                        <nav className="-mb-px flex" aria-label="Tabs">
                            <button
                                onClick={() => setActiveTab('showcase')}
                                className={`${activeTab === 'showcase'
                                    ? 'border-brand-blue text-brand-blue-glow bg-brand-blue/5'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30 hover:bg-white/5'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Showcase ({displayItems.length})
                            </button>
                            <button
                                onClick={() => setActiveTab('selling')}
                                className={`${activeTab === 'selling'
                                    ? 'border-brand-blue text-brand-blue-glow bg-brand-blue/5'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30 hover:bg-white/5'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                For Sale ({activeItems.length})
                            </button>
                        </nav>
                    </div>

                    <div className="p-6 min-h-[400px]">
                        {activeTab === 'showcase' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {displayItems.map((item, idx) => (
                                    <ShowcaseCard
                                        key={idx}
                                        item={item}
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                    // No action props passed, so buttons will be hidden
                                    />
                                ))}
                                {displayItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-20 text-brand-platinum/50 border-2 border-dashed border-brand-platinum/10 rounded-xl">
                                        <svg className="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                        <p className="font-bold text-lg">No items in Showcase</p>
                                        <p className="text-sm mt-1 opacity-70">This user hasn't displayed any items yet.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'selling' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {activeItems.map((item, idx) => (
                                    <ShowcaseCard
                                        key={idx}
                                        item={item}
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                    // No action props passed, so buttons will be hidden
                                    />
                                ))}
                                {activeItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-20 text-brand-platinum/50 border-2 border-dashed border-brand-platinum/10 rounded-xl">
                                        <svg className="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                        <p className="font-bold text-lg">No items for sale</p>
                                        <p className="text-sm mt-1 opacity-70">This user has no active listings.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}

export default function ProfilePage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <ProfilePageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/profile/page.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { getAvailableBalance } from '../../app/actions/payout';
import OrderHistory from '../../components/OrderHistory';
// import { createClient } from '@/utils/supabase/client';

export default function ProfilePage() {
    const [user, setUser] = useState<any>(null);
    const [profile, setProfile] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const router = useRouter();

    const [activeTab, setActiveTab] = useState<'purchases' | 'sales'>('purchases');
    const [isEditing, setIsEditing] = useState(false);
    const [editDisplayName, setEditDisplayName] = useState('');
    const [editFirstName, setEditFirstName] = useState('');
    const [editLastName, setEditLastName] = useState('');
    const [editEmail, setEditEmail] = useState('');
    const [editPostalCode, setEditPostalCode] = useState('');
    const [editAddressLine1, setEditAddressLine1] = useState('');
    const [editAddressLine2, setEditAddressLine2] = useState('');
    const [editPhoneNumber, setEditPhoneNumber] = useState('');
    const [editRealNameKana, setEditRealNameKana] = useState('');
    const [balance, setBalance] = useState<number | null>(null);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        const fetchUserAndProfile = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                router.push('/login');
                return;
            }

            setUser(user);
            setEditEmail(user.email || '');

            // Fetch profile
            const { data: profileData } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profileData) {
                setProfile(profileData);
                setEditDisplayName(profileData.display_name || profileData.name || user.user_metadata?.name || '');
                setEditFirstName(profileData.first_name || '');
                setEditLastName(profileData.last_name || '');
                setEditPostalCode(profileData.postal_code || '');
                setEditAddressLine1(profileData.address_line1 || '');
                setEditAddressLine2(profileData.address_line2 || '');
                setEditPhoneNumber(profileData.phone_number || '');
                setEditRealNameKana(profileData.real_name_kana || '');
            } else {
                setEditDisplayName(user.user_metadata?.name || '');
            }

            // Fetch Balance
            try {
                const balanceData = await getAvailableBalance(user.id);
                setBalance(balanceData.available);
            } catch (e) {
                console.error("Failed to load balance", e);
                setBalance(0);
            }

            setLoading(false);
        };

        fetchUserAndProfile();
    }, [router]);

    const handleSave = async () => {
        if (!user?.id) return;
        setSaving(true);
        try {
            const supabase = createClient();

            // Sanitize: Remove all spaces (half/full width) from Kana
            const sanitizedKana = editRealNameKana.replace(/[\s\u3000]+/g, '');

            // Validate: Must be Full-width Katakana if provided
            if (sanitizedKana && !/^[\u30A0-\u30FF]+$/.test(sanitizedKana)) {
                alert('Real Name (Kana) must be in full-width Katakana only (no Kanji, Hiragana, or Latin letters).');
                setSaving(false);
                return;
            }

            // Update Profile Table
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: user.id,
                    display_name: editDisplayName,
                    first_name: editFirstName,
                    last_name: editLastName,
                    // name: editDisplayName, // Optional: duplicate to name for compat
                    email: user.email,
                    postal_code: editPostalCode,
                    address_line1: editAddressLine1,
                    address_line2: editAddressLine2,
                    phone_number: editPhoneNumber,
                    real_name_kana: sanitizedKana,
                    updated_at: new Date().toISOString(),
                });

            if (profileError) throw profileError;

            // Update Auth Metadata (optional, but good for consistency)
            /* const { error: authError } = await supabase.auth.updateUser({
                data: { name: editDisplayName },
            }); */

            // if (authError) throw authError;

            setProfile({
                ...profile,
                display_name: editDisplayName,
                first_name: editFirstName,
                last_name: editLastName,
                postal_code: editPostalCode,
                address_line1: editAddressLine1,
                address_line2: editAddressLine2,
                phone_number: editPhoneNumber,
                real_name_kana: sanitizedKana
            });
            setIsEditing(false);
            setEditRealNameKana(sanitizedKana); // Update state to sanitized version
            alert('Profile updated successfully!');

        } catch (error) {
            console.error(error);
            alert('Failed to update profile.');
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-brand-dark flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (!user) {
        return null;
    }

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 container mx-auto px-4 py-24 sm:px-6 lg:px-8">
                <div className="max-w-3xl mx-auto space-y-8">
                    {/* Header Section */}
                    <div className="text-center space-y-4">
                        <h1 className="text-4xl font-heading font-bold text-white tracking-tight">
                            My Profile
                        </h1>
                        <p className="text-brand-platinum/60">
                            Manage your account settings and view your activity.
                        </p>
                    </div>

                    {/* Profile Card */}
                    <div className="glass-panel p-8 rounded-3xl shadow-2xl border border-brand-platinum/10 relative overflow-hidden group">
                        {/* Background Decoration */}
                        <div className="absolute top-0 right-0 w-64 h-64 bg-brand-blue/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none group-hover:bg-brand-blue/20 transition-all duration-700"></div>

                        <div className="relative z-10 flex flex-col md:flex-row items-start gap-8">
                            {/* Avatar */}
                            <div className="relative flex-shrink-0 mx-auto md:mx-0">
                                <div className="w-32 h-32 rounded-full bg-gradient-to-br from-brand-blue to-brand-blue-glow p-[2px] shadow-lg shadow-brand-blue/20">
                                    <div className="w-full h-full rounded-full bg-brand-dark-light overflow-hidden">
                                        <img
                                            src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user?.email || 'Guest'}`}
                                            alt="Profile"
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                </div>
                                <div className="absolute bottom-0 right-0 w-8 h-8 bg-green-500 rounded-full border-4 border-brand-dark-light flex items-center justify-center" title="Active">
                                    <div className="w-full h-full rounded-full animate-pulse bg-green-400/50"></div>
                                </div>
                            </div>

                            {/* Info */}
                            <div className="flex-1 text-center md:text-left space-y-4 w-full">
                                {isEditing ? (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-1 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Nickname (Display Name)</label>
                                                <input
                                                    type="text"
                                                    value={editDisplayName}
                                                    onChange={(e) => setEditDisplayName(e.target.value)}
                                                    placeholder="e.g. CardMaster2024"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Last Name (姓)</label>
                                                    <input
                                                        type="text"
                                                        value={editLastName}
                                                        onChange={(e) => setEditLastName(e.target.value)}
                                                        placeholder="山田"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">First Name (名)</label>
                                                    <input
                                                        type="text"
                                                        value={editFirstName}
                                                        onChange={(e) => setEditFirstName(e.target.value)}
                                                        placeholder="太郎"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                            </div>

                                            {/* Real Name Kana Input */}
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Real Name (カタカナ) <span className="text-red-400 text-xs">*Required for Payouts</span></label>
                                                <input
                                                    type="text"
                                                    value={editRealNameKana}
                                                    onChange={(e) => setEditRealNameKana(e.target.value)}
                                                    placeholder="ヤマダタロウ"
                                                    pattern="^[\u30A0-\u30FF]+$"
                                                    title="Full-width Katakana only"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                                <p className="text-[10px] text-brand-platinum/50 mt-1">※ 銀行口座名義と一致させてください (姓と名の間のスペースなし)</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Email</label>
                                                <input
                                                    type="email"
                                                    value={editEmail}
                                                    onChange={(e) => setEditEmail(e.target.value)}
                                                    disabled
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white/50 cursor-not-allowed focus:outline-none"
                                                />
                                            </div>
                                        </div>

                                        <div className="border-t border-brand-platinum/10 pt-4 mt-4">
                                            <h3 className="text-white font-bold mb-3">Shipping Address (配送先住所)</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Postal Code (郵便番号)</label>
                                                    <input
                                                        type="text"
                                                        value={editPostalCode}
                                                        onChange={(e) => setEditPostalCode(e.target.value)}
                                                        placeholder="123-4567"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Phone Number (電話番号)</label>
                                                    <input
                                                        type="tel"
                                                        value={editPhoneNumber}
                                                        onChange={(e) => setEditPhoneNumber(e.target.value)}
                                                        placeholder="090-1234-5678"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                            </div>
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Address Line 1 (都道府県・市区町村)</label>
                                                <input
                                                    type="text"
                                                    value={editAddressLine1}
                                                    onChange={(e) => setEditAddressLine1(e.target.value)}
                                                    placeholder="Tokyo, Minato-ku"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Address Line 2 (番地・建物名)</label>
                                                <input
                                                    type="text"
                                                    value={editAddressLine2}
                                                    onChange={(e) => setEditAddressLine2(e.target.value)}
                                                    placeholder="Roppongi 1-2-3, Hills Tower 4F"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <h2 className="text-2xl font-bold text-white mb-1">
                                            {profile?.display_name || editDisplayName || 'No Nickname'}
                                        </h2>
                                        <p className="text-brand-platinum/60 font-mono text-sm mb-4">
                                            @{profile?.email?.split('@')[0] || 'username'}
                                        </p>

                                        {(profile?.address_line1 || profile?.postal_code || profile?.real_name_kana) && (
                                            <div className="bg-brand-dark-light/30 p-4 rounded-xl border border-brand-platinum/10 text-left">
                                                <h3 className="text-xs font-bold text-brand-platinum uppercase tracking-wider mb-2">Shipping Information</h3>
                                                <p className="text-white text-sm font-bold mb-1">
                                                    {profile.last_name} {profile.first_name}
                                                    {profile.real_name_kana && <span className="text-xs font-normal text-brand-platinum/60 ml-2">({profile.real_name_kana})</span>}
                                                </p>
                                                <p className="text-brand-platinum/80 text-sm">
                                                    〒{profile.postal_code}<br />
                                                    {profile.address_line1}<br />
                                                    {profile.address_line2}<br />
                                                    {profile.phone_number && <span className="text-brand-platinum/60 mt-1 block">{profile.phone_number}</span>}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {!isEditing && (
                                    <div className="flex flex-wrap justify-center md:justify-start gap-3">
                                        <span className="px-3 py-1 rounded-full bg-brand-blue/10 text-brand-blue text-xs font-bold border border-brand-blue/20">
                                            MEMBER
                                        </span>
                                        <span className="px-3 py-1 rounded-full bg-brand-gold/10 text-brand-gold text-xs font-bold border border-brand-gold/20">
                                            EARLY ADOPTER
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Actions */}
                            <div className="flex flex-col gap-3 w-full md:w-auto">
                                {isEditing ? (
                                    <>
                                        <button
                                            onClick={handleSave}
                                            disabled={saving}
                                            className="px-6 py-2 rounded-xl bg-brand-blue hover:bg-brand-blue-glow text-white font-bold text-sm shadow-lg shadow-brand-blue/20 transition-all text-center disabled:opacity-50"
                                        >
                                            {saving ? 'Saving...' : 'Save Changes'}
                                        </button>
                                        <button
                                            onClick={() => setIsEditing(false)}
                                            disabled={saving}
                                            className="px-6 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm border border-white/10 transition-all"
                                        >
                                            Cancel
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button
                                            onClick={() => setIsEditing(true)}
                                            className="px-6 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm border border-white/10 transition-all"
                                        >
                                            Edit Profile
                                        </button>
                                        <Link href="/collection" className="px-6 py-2 rounded-xl bg-brand-blue hover:bg-brand-blue-glow text-white font-bold text-sm shadow-lg shadow-brand-blue/20 transition-all text-center">
                                            My Collection
                                        </Link>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Wallet Card */}
                    <div className="bg-gradient-to-r from-gray-900 to-black border border-yellow-600/50 rounded-3xl p-8 shadow-2xl relative overflow-hidden group">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-yellow-600/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none group-hover:bg-yellow-600/20 transition-all duration-700"></div>

                        <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div>
                                <h3 className="text-yellow-600/80 text-sm font-bold tracking-widest uppercase mb-1">Current Balance / 売上金残高</h3>
                                <div className="text-4xl md:text-5xl font-heading font-bold text-white tracking-tight flex items-baseline gap-2">
                                    <span className="text-2xl text-white/50">¥</span>
                                    {balance !== null ? balance.toLocaleString() : '---'}
                                </div>
                            </div>

                            <Link
                                href="/payouts"
                                className="px-8 py-3 rounded-full bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-black font-bold shadow-lg shadow-yellow-600/20 transition-all transform hover:scale-105"
                            >
                                Withdraw / 出金申請
                            </Link>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {[
                            { label: 'Total Listings', value: '0', icon: '📋' },
                            { label: 'Sales', value: '¥0', icon: '💰' },
                            { label: 'Purchases', value: '0', icon: '🛍️' },
                        ].map((stat, i) => (
                            <div key={i} className="glass-panel p-6 rounded-2xl border border-brand-platinum/5 hover:border-brand-platinum/20 transition-all group">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-brand-platinum/60 text-sm font-bold">{stat.label}</span>
                                    <span className="text-xl group-hover:scale-110 transition-transform">{stat.icon}</span>
                                </div>
                                <div className="text-2xl font-heading font-bold text-white group-hover:text-brand-blue-glow transition-colors">
                                    {stat.value}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Transaction History */}
                    <div className="space-y-6 pt-8 border-t border-brand-platinum/10">
                        <div className="flex items-center gap-8 border-b border-brand-platinum/10">
                            <button
                                onClick={() => setActiveTab('purchases')}
                                className={`pb-3 text-sm font-bold tracking-wider transition-all border-b-2 ${activeTab === 'purchases' ? 'text-white border-brand-blue' : 'text-brand-platinum/40 border-transparent hover:text-brand-platinum'}`}
                            >
                                Purchases (購入履歴)
                            </button>
                            <button
                                onClick={() => setActiveTab('sales')}
                                className={`pb-3 text-sm font-bold tracking-wider transition-all border-b-2 ${activeTab === 'sales' ? 'text-white border-brand-gold' : 'text-brand-platinum/40 border-transparent hover:text-brand-platinum'}`}
                            >
                                Sales (販売履歴)
                            </button>
                        </div>

                        <div className="min-h-[200px]">
                            <OrderHistory mode={activeTab === 'purchases' ? 'buy' : 'sell'} />
                        </div>
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/register/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { sendWelcomeEmail } from '../actions/send-email';

export default function RegisterPage() {
    const router = useRouter();
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState<string | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            const supabase = createClient();
            const { error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        name: name,
                    },
                },
            });

            if (error) {
                throw error;
            }

            // Send Welcome Email
            await sendWelcomeEmail(email, name);

            // Redirect to login page after successful registration
            router.push('/login?registered=true');
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An error occurred');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div className="max-w-md w-full space-y-8">
                    <div className="text-center">
                        <Link href="/" className="inline-block mb-6 group">
                            <span className="font-heading text-4xl font-bold tracking-tighter text-white group-hover:text-glow transition-all">
                                TC<span className="text-brand-blue">.APP</span>
                            </span>
                        </Link>
                        <h2 className="text-3xl font-heading font-bold text-white">
                            Create your account
                        </h2>
                        <p className="mt-2 text-brand-platinum/60">
                            Join the premium marketplace for collectors.
                        </p>
                    </div>

                    <div className="glass-panel p-8 rounded-2xl shadow-2xl border border-brand-platinum/10">
                        <form className="space-y-6" onSubmit={handleSubmit}>
                            {error && (
                                <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl text-sm">
                                    {error}
                                </div>
                            )}

                            <div>
                                <label htmlFor="name" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Nickname
                                </label>
                                <input
                                    id="name"
                                    name="name"
                                    type="text"
                                    required
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="CardMaster2024"
                                />
                            </div>

                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Email address
                                </label>
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    autoComplete="email"
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="name@example.com"
                                />
                            </div>

                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Password
                                </label>
                                <input
                                    id="password"
                                    name="password"
                                    type="password"
                                    autoComplete="new-password"
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="••••••••"
                                />
                            </div>

                            <div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {loading ? 'Creating account...' : 'Sign up'}
                                </button>
                            </div>
                        </form>

                        <div className="mt-6 text-center">
                            <p className="text-sm text-brand-platinum/60">
                                Already have an account?{' '}
                                <Link href="/login" className="font-medium text-brand-blue hover:text-brand-blue-glow transition-colors">
                                    Sign in
                                </Link>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/sell/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Footer from '../../components/Footer';
import PremiumCardImage from '../../components/PremiumCardImage';
import MarketPriceLinks from '../../components/MarketPriceLinks';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

// --- Data Constants ---
const MLB_TEAMS = [
    "アリゾナ・ダイヤモンドバックス", "アトランタ・ブレーブス", "ボルチモア・オリオールズ", "ボストン・レッドソックス", "シカゴ・カブス",
    "シカゴ・ホワイトソックス", "シンシナティ・レッズ", "クリーブランド・ガーディアンズ", "コロラド・ロッキーズ", "デトロイト・タイガース",
    "ヒューストン・アストロズ", "カンザスシティ・ロイヤルズ", "ロサンゼルス・エンゼルス", "ロサンゼルス・ドジャース", "マイアミ・マーリンズ",
    "ミルウォーキー・ブルワーズ", "ミネソタ・ツインズ", "ニューヨーク・メッツ", "ニューヨーク・ヤンキース", "オークランド・アスレチックス",
    "フィラデルフィア・フィリーズ", "ピッツバーグ・パイレーツ", "サンディエゴ・パドレス", "サンフランシスコ・ジャイアンツ", "シアトル・マリナーズ",
    "セントルイス・カージナルス", "タンパベイ・レイズ", "テキサス・レンジャーズ", "トロント・ブルージェイズ", "ワシントン・ナショナルズ"
];

const NPB_TEAMS = [
    "読売ジャイアンツ", "阪神タイガース", "中日ドラゴンズ", "横浜DeNAベイスターズ", "広島東洋カープ", "東京ヤクルトスワローズ",
    "福岡ソフトバンクホークス", "千葉ロッテマリーンズ", "埼玉西武ライオンズ", "東北楽天ゴールデンイーグルス", "北海道日本ハムファイターズ", "オリックス・バファローズ", "日本代表", "その他"
];

const CARD_BRANDS = [
    "Topps", "Panini", "Upper Deck", "BBM", "EPOCH", "Leaf", "Bowman", "Fleer", "Donruss", "Score", "Select", "Prizm", "Chrome", "Finest", "Other", "Unknown"
];

// Generate Year Options (1950 - Current+1)
const CURRENT_YEAR = new Date().getFullYear();
const YEARS = Array.from({ length: CURRENT_YEAR - 1949 }, (_, i) => (CURRENT_YEAR + 1 - i).toString());

// --- Zod Schema Definition ---
const listingSchema = z.object({
    // --- Section 1: Basic Info (AI-Assisted) ---
    playerName: z.string().min(1, "選手名は必須です"),
    team: z.string().min(1, "球団名は必須です"),
    // Year can be "Unknown" (empty string in UI logic?) or a year string.
    // If user selects "Unknown", value might be empty.
    year: z.string().optional(),
    brand: z.string().min(1, "ブランドは必須です"),

    // --- Section 2: Features & Rarity ---
    variation: z.string().optional(),
    serialNumber: z.string().optional(),
    isRookie: z.boolean().default(false),
    isAutograph: z.boolean().default(false),

    // --- Section 3: Condition & Grading ---
    isGraded: z.boolean().default(false),
    gradingCompany: z.string().optional(),
    grade: z.string().optional(),
    certificationNumber: z.string().optional(),
    condition: z.string().optional(),

    // --- Section 4: Other ---
    price: z.number().min(1, "価格は必須です"),
    description: z.string().optional(),
    images: z.array(z.string()).min(1, "画像は少なくとも1枚必要です"),
}).superRefine((data, ctx) => {
    if (!data.isGraded && !data.condition) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "コンディションを選択してください",
            path: ["condition"],
        });
    }
});

type ListingFormData = z.infer<typeof listingSchema>;

function SellContent() {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const [user, setUser] = useState<any>(null);
    const router = useRouter();

    const searchParams = useSearchParams();
    const source = searchParams.get('source');
    const sourceId = searchParams.get('id');
    const sourceType = searchParams.get('type');

    // UI State
    const [uploading, setUploading] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    const [submitting, setSubmitting] = useState(false);
    const [formError, setFormError] = useState<string | null>(null);
    const [aiFeedback, setAiFeedback] = useState<string | null>(null);
    const [isDragging, setIsDragging] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const [hasAnalyzed, setHasAnalyzed] = useState(false); // New state to track analysis

    // Country logic (Default JP)
    const [country, setCountry] = useState<'USA' | 'JP'>('JP');

    // Image Selection for AI
    const [selectedImageIndices, setSelectedImageIndices] = useState<number[]>([0]);

    // Drag State
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null);

    // AI Suggestions Data
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const [suggestedData, setSuggestedData] = useState<any>(null);



    // React Hook Form
    const {
        register,
        handleSubmit,
        setValue,
        getValues,
        watch,
        formState: { errors },
        reset
    } = useForm<ListingFormData>({
        // @ts-expect-error - Resolver type mismatch due to optional default values vs required schema
        resolver: zodResolver(listingSchema),
        defaultValues: {
            playerName: '',
            team: '',
            year: '',
            brand: '', // Default to Unknown (empty string matches "Select Brand..." disabled option)
            variation: '',
            serialNumber: '',
            isRookie: false,
            isAutograph: false,
            isGraded: false,
            gradingCompany: 'PSA',
            grade: '10',
            certificationNumber: '',

            condition: '', // Default to empty to force selection
            price: 0,
            description: '',
            images: [],
        }
    });

    const images = watch('images');
    const isGraded = watch('isGraded');

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            if (source === 'collection' && sourceId && user) {
                try {
                    const { data: listingData } = await supabase.from('listing_items').select('*').eq('id', sourceId).single();
                    if (listingData) {
                        // Resell Logic: If I am not the seller, treat as New Listing (Clone data, but INSERT new)
                        // If I AM the seller, treat as Edit (UPDATE existing)
                        setIsEditing(listingData.seller_id === user.id);
                        setHasAnalyzed(true); // Editing implies analysis/data exists
                        reset({
                            playerName: listingData.player_name || '',
                            team: listingData.team || '',
                            year: listingData.year?.toString() || '',
                            brand: listingData.manufacturer || 'Unknown',
                            variation: listingData.variation || '',
                            serialNumber: listingData.serial_number || '',
                            isRookie: listingData.is_rookie || false,
                            isAutograph: listingData.is_autograph || false,
                            isGraded: listingData.condition_grading?.is_graded || false,
                            gradingCompany: listingData.condition_grading?.service || 'PSA',
                            grade: listingData.condition_grading?.score?.toString() || '10',
                            certificationNumber: listingData.condition_grading?.certification_number || '',
                            condition: listingData.condition_rating || 'Near Mint',
                            price: listingData.price || 0,
                            description: listingData.description || '',
                            images: listingData.images || [],
                        });

                        // Infer country
                        if (listingData.team && MLB_TEAMS.includes(listingData.team)) {
                            setCountry('USA');
                        } else {
                            setCountry('JP');
                        }
                    }
                } catch (err) {
                    console.error("Failed to load source", err);
                }
            }
        };
        init();
    }, [source, sourceId, sourceType, reset]);

    const uploadFiles = async (files: FileList) => {
        setUploading(true);
        const supabase = createClient();
        const uploadedUrls: string[] = [];

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                uploadedUrls.push(publicUrl);
            }

            const currentImages = getValues('images') || [];
            const newImages = [...currentImages, ...uploadedUrls];
            setValue('images', newImages);

            if (currentImages.length === 0 && uploadedUrls.length > 0) {
                setSelectedImageIndices([0]);
            }

        } catch (err: any) {
            console.error("Upload Error Details:", err);
            const msg = err?.message || err?.error_description || JSON.stringify(err);
            setFormError(`Upload Failed: ${msg}`);
        } finally {
            setUploading(false);
        }
    };

    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.files || e.target.files.length === 0) return;
        await uploadFiles(e.target.files);
    };

    const handleDrop = async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            await uploadFiles(e.dataTransfer.files);
        }
    };

    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    };

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    };

    const toggleImageSelection = (index: number) => {
        if (selectedImageIndices.includes(index)) {
            setSelectedImageIndices(prev => prev.filter(i => i !== index));
        } else {
            setSelectedImageIndices(prev => [...prev, index]);
        }
    };

    const removeImage = (index: number) => {
        const currentImages = getValues('images');
        const newImages = currentImages.filter((_, i) => i !== index);
        setValue('images', newImages);
        setSelectedImageIndices(prev => prev.filter(i => i !== index).map(i => i > index ? i - 1 : i));
    };

    // --- Drag & Drop Reordering ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = "move";
    };

    const handleDragEnter = (e: React.DragEvent, index: number) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;

        // Optimistic Reordering 
        const currentImages = getValues('images');
        const newImages = [...currentImages];
        const item = newImages[draggedIndex];
        newImages.splice(draggedIndex, 1);
        newImages.splice(index, 0, item);

        setValue('images', newImages);
        setDraggedIndex(index);
    };

    const handleDragEnd = () => {
        setDraggedIndex(null);
    };


    const analyzeImage = async () => {
        const currentImages = getValues('images');
        if (!currentImages || currentImages.length === 0) return;
        if (selectedImageIndices.length === 0) {
            setFormError("Please select at least one image to analyze.");
            return;
        }

        setAnalyzing(true);
        setAiFeedback(null);
        setFormError(null);
        setSuggestedData(null);


        try {
            const imageIndex = selectedImageIndices[0];
            const imageUrl = currentImages[imageIndex];

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const reader = new FileReader();

            reader.onloadend = async () => {
                const base64data = reader.result;
                try {
                    const apiRes = await fetch('/api/analyze-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64data }),
                    });

                    if (!apiRes.ok) {
                        const errorData = await apiRes.json().catch(() => ({}));
                        throw new Error(errorData.error || `AI Analysis failed with status ${apiRes.status}`);
                    }
                    const data = await apiRes.json();

                    const missingFields = [];
                    if (!data.playerName?.value) missingFields.push('Player Name');
                    if (!data.year?.value) missingFields.push('Year');

                    const hasAnalysis = missingFields.length < 2;

                    if (!hasAnalysis) {
                        setFormError("AI could not identify Player or Year. Please fill in manually.");
                        setAnalyzing(false);
                        return;
                    }

                    setSuggestedData(data);
                    setHasAnalyzed(true);

                    if (data.playerName?.value) setValue('playerName', data.playerName.value);
                    if (data.year?.value) setValue('year', data.year.value);

                    if (data.variation?.value) setValue('variation', data.variation.value);
                    if (data.serialNumber?.value) setValue('serialNumber', data.serialNumber.value);
                    if (data.isRookie?.value === 'true') setValue('isRookie', true);
                    if (data.isAutograph?.value === 'true') setValue('isAutograph', true);

                    if (data.isGraded?.value === 'true') {
                        setValue('isGraded', true);
                        if (data.gradingCompany?.value) setValue('gradingCompany', data.gradingCompany.value);
                        if (data.grade?.value) setValue('grade', data.grade.value);
                    } else if (data.condition?.value) {
                        setValue('condition', data.condition.value);
                    }

                    // Handle Parallel/Variation logic
                    let variationVal = data.variation?.value || '';
                    if (data.parallelType?.value) {
                        variationVal = variationVal ? `${variationVal} / ${data.parallelType.value}` : data.parallelType.value;
                    }
                    if (variationVal) setValue('variation', variationVal);



                } catch (err) {
                    console.error(err);
                    setFormError('Failed to analyze image.');
                } finally {
                    setAnalyzing(false);
                }
            };
            reader.readAsDataURL(blob);
        } catch (err) {
            console.error(err);
            setFormError('Could not process image.');
            setAnalyzing(false);
        }
    };

    const onSubmit = async (formData: ListingFormData) => {
        if (!user?.id) {
            setFormError("You must be logged in to sell items.");
            return;
        }
        setSubmitting(true);
        setFormError(null);

        try {
            const supabase = createClient();
            const listingData = {
                // catalog_id: null, // Removed
                player_name: formData.playerName,
                team: formData.team,
                year: parseInt(formData.year || '') || null, // Handle Unknown/Empty as null
                manufacturer: formData.brand,

                price: formData.price,
                images: formData.images,
                condition_grading: {
                    is_graded: formData.isGraded,
                    service: formData.isGraded ? formData.gradingCompany : "None",
                    score: formData.isGraded ? parseFloat(formData.grade || '0') : null,
                    certification_number: formData.isGraded ? formData.certificationNumber : null
                },
                variation: formData.variation,
                serial_number: formData.serialNumber,
                is_rookie: formData.isRookie,
                is_autograph: formData.isAutograph,
                description: formData.description,
                condition_rating: !formData.isGraded ? formData.condition : null,
                deleted_at: null, // Clear archived status if listed
                status: 'Active'
            };

            if (isEditing && sourceId) {
                const { error: updateError } = await supabase
                    .from('listing_items')
                    .update(listingData)
                    .eq('id', sourceId);
                if (updateError) throw updateError;
                router.push(`/listings/${sourceId}`);
            } else {
                const { data: listing, error: insertError } = await supabase
                    .from('listing_items')
                    .insert({ ...listingData, seller_id: user.id })
                    .select()
                    .single();
                if (insertError) throw insertError;

                if (source === 'collection' && sourceType === 'manual') {
                    await supabase.from('user_collections').delete().eq('id', sourceId);
                }
                router.push(`/listings/${listing.id}`);
            }

        } catch (err: any) {
            console.error("Submission Error:", err);
            // Supabase errors might be objects with a 'message' property but not instances of Error
            const msg = err?.message || err?.error_description || (typeof err === 'string' ? err : 'An error occurred');
            setFormError(msg);
            setSubmitting(false);
        }
    };

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const renderChip = (label: string, fieldData: any, fieldName: keyof ListingFormData) => {
        if (!fieldData?.value) return (
            <span className="text-xs text-red-400 font-mono ml-2 border border-red-500/20 px-2 py-0.5 rounded-full bg-red-500/10">Unknown</span>
        );
        const isHigh = fieldData.confidence === 'High';
        return (
            <button
                type="button"
                onClick={() => setValue(fieldName, fieldData.value)}
                className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium border transition-all hover:scale-105 active:scale-95 ${isHigh
                    ? 'bg-blue-500/20 text-blue-200 border-blue-500/50 hover:bg-blue-500/30'
                    : 'bg-brand-gold/10 text-brand-gold border-brand-gold/30 hover:bg-brand-gold/20'
                    }`}
            >
                {isHigh && <span>✨</span>}
                <span className="opacity-70">{label}:</span>
                <span className="font-bold">{fieldData.value}</span>
            </button>
        );
    };

    return (
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full">
            <div className="md:flex md:items-center md:justify-between mb-8">
                <div className="flex-1 min-w-0">
                    <h2 className="text-3xl font-heading font-bold leading-7 text-white sm:text-4xl sm:truncate drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                        新規出品
                    </h2>
                    <p className="mt-2 text-brand-platinum/60">カード画像をアップロードすると、AIが自動で情報を読み取ります</p>
                </div>
            </div>

            <div className="glass-panel-premium rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative">
                <div className="absolute top-0 right-0 w-64 h-64 bg-brand-gold/5 rounded-full blur-3xl -z-10"></div>
                <div className="absolute bottom-0 left-0 w-64 h-64 bg-brand-blue/5 rounded-full blur-3xl -z-10"></div>

                {/* eslint-disable-next-line @typescript-eslint/no-explicit-any */}
                <form onSubmit={handleSubmit(onSubmit as any)} className="p-8 space-y-12">

                    {/* --- 0. Image Upload --- */}
                    <div className="mb-6">
                        <label
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                            className={`group relative flex flex-col items-center justify-center w-full h-80 border-2 border-dashed rounded-2xl transition-all cursor-pointer ${uploading ? 'opacity-50 cursor-not-allowed' : ''
                                } ${isDragging
                                    ? 'border-brand-gold bg-brand-gold/10 scale-[1.02]'
                                    : 'border-brand-platinum/20 hover:border-brand-gold/50 hover:bg-brand-gold/5'
                                }`}
                        >
                            {images.length > 0 ? (
                                <div className="w-full h-full relative p-4 flex items-center justify-center">
                                    <PremiumCardImage src={images[0]} alt="Main upload" className="max-h-full object-contain rounded-lg shadow-2xl" />
                                    <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-2xl">
                                        <p className="text-white font-bold">画像を追加 / 変更</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg className={`w-12 h-12 mb-4 transition-colors ${isDragging ? 'text-brand-gold' : 'text-brand-platinum/50 group-hover:text-brand-gold'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    <p className={`mb-2 text-lg ${isDragging ? 'text-white' : 'text-brand-platinum group-hover:text-white'}`}><span className="font-bold">カード画像をアップロード</span></p>
                                    <p className="text-sm text-brand-platinum/50">複数枚のアップロードに対応</p>
                                </div>
                            )}
                            <input
                                type="file"
                                accept="image/*"
                                multiple
                                className="hidden"
                                onChange={handleImageUpload}
                                disabled={uploading}
                            />
                            {uploading && (
                                <div className="absolute inset-0 bg-brand-dark/80 flex items-center justify-center rounded-2xl backdrop-blur-sm">
                                    <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-brand-gold"></div>
                                </div>
                            )}
                        </label>

                        {/* Thumbnail Grid & Tools */}
                        <div className="flex justify-between items-start mt-4">
                            <div className="flex gap-2 overflow-x-auto pb-2 flex-1 items-center">
                                {images.map((url, idx) => (
                                    <div
                                        key={idx}
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, idx)}
                                        onDragEnter={(e) => handleDragEnter(e, idx)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={(e) => e.preventDefault()}
                                        onClick={() => toggleImageSelection(idx)}
                                        className={`relative w-20 h-28 flex-shrink-0 rounded-lg overflow-hidden border-2 cursor-pointer transition-all ${selectedImageIndices.includes(idx)
                                            ? 'border-brand-gold shadow-[0_0_10px_rgba(212,175,55,0.5)] scale-105'
                                            : 'border-brand-platinum/20 opacity-70 hover:opacity-100'
                                            } group`}
                                        style={{
                                            opacity: draggedIndex === idx ? 0.5 : 1,
                                            transform: draggedIndex === idx ? 'scale(1.05)' : 'scale(1)',
                                        }}
                                    >
                                        {/* eslint-disable-next-line @next/next/no-img-element */}
                                        <img src={url} alt={`View ${idx + 1}`} className="w-full h-full object-cover" />
                                        {selectedImageIndices.includes(idx) && (
                                            <div className="absolute top-1 right-1 w-4 h-4 bg-brand-gold rounded-full flex items-center justify-center shadow-md">
                                                <svg className="w-3 h-3 text-brand-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>
                                            </div>
                                        )}
                                        {/* Delete Button (Hover) */}
                                        <div className="absolute top-0 left-0 w-full h-full bg-black/40 hidden group-hover:flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); removeImage(idx); }}
                                                className="bg-red-500 rounded-full p-1 text-white hover:bg-red-600"
                                                title="Delete Image"
                                            >
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {images.length > 0 && (
                                <div className="flex flex-col items-end gap-2 ml-4">
                                    <button
                                        type="button"
                                        onClick={analyzeImage}
                                        disabled={analyzing}
                                        className="bg-brand-gold text-brand-dark font-bold px-5 py-2 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center gap-2 whitespace-nowrap"
                                    >
                                        {analyzing ? <div className="w-4 h-4 border-2 border-brand-dark border-t-transparent rounded-full animate-spin" /> : <span>✨ AI解析を実行</span>}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- Form Sections (Revealed after Analysis) --- */}
                    {hasAnalyzed && (
                        <div className="space-y-12 animate-fade-in-up">
                            {/* --- Section 1: Basic Info --- */}
                            <section>
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-brand-gold/20 flex items-center justify-center text-brand-gold text-sm">1</span>
                                    Basic Info (基本情報)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Player Name */}
                                    <div className="md:col-span-2">
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">選手名 <span className="text-red-500">*</span></label>
                                            {suggestedData && renderChip("AI", suggestedData.playerName, 'playerName')}
                                        </div>
                                        <input {...register('playerName')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:ring-2 focus:ring-brand-blue" placeholder="大谷翔平 (Shohei Ohtani)" />
                                        {errors.playerName && <p className="text-red-400 text-xs mt-1">{errors.playerName.message}</p>}
                                    </div>

                                    {/* Year Dropdown */}
                                    <div>
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">発行年 <span className="text-red-500">*</span></label>
                                            {suggestedData && renderChip("AI", suggestedData.year, 'year')}
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('year')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>年を選択...</option>
                                                <option value="Unknown">Unknown (不明)</option>
                                                {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                        {errors.year && <p className="text-red-400 text-xs mt-1">{errors.year.message}</p>}
                                    </div>

                                    {/* Brand (Catalog) */}
                                    <div>
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">Brand <span className="text-red-500">*</span></label>
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('brand')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>ブランドを選択...</option>
                                                {CARD_BRANDS.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                        {errors.brand && <p className="text-red-400 text-xs mt-1">{errors.brand.message}</p>}
                                    </div>

                                    {/* Team (Localized) */}
                                    <div className="md:col-span-2">
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">Team <span className="text-red-500">*</span></label>
                                        </div>

                                        <div className="flex gap-4">
                                            {/* Country Select */}
                                            <div className="w-1/3">
                                                <select
                                                    value={country}
                                                    onChange={(e) => setCountry(e.target.value as 'USA' | 'JP')}
                                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                                >
                                                    <option value="JP">🇯🇵 NPB (日本)</option>
                                                    <option value="USA">🇺🇸 MLB (米国)</option>
                                                </select>
                                            </div>

                                            {/* Catalog Select */}
                                            <div className="flex-1 relative">
                                                <select
                                                    {...register('team')}
                                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                                >
                                                    <option value="" disabled>チームを選択...</option>
                                                    {(country === 'USA' ? MLB_TEAMS : NPB_TEAMS).map(team => (
                                                        <option key={team} value={team}>{team}</option>
                                                    ))}
                                                    <option value="Other">その他</option>
                                                    <option value="Unknown">Unknown (不明)</option>
                                                </select>
                                                <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                </div>
                                            </div>
                                        </div>
                                        {errors.team && <p className="text-red-400 text-xs mt-1">{errors.team.message}</p>}
                                    </div>
                                </div>
                            </section>

                            {/* --- Section 2: Features & Rarity --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-brand-blue/20 flex items-center justify-center text-brand-blue text-sm">2</span>
                                    Features & Rarity (特徴・レアリティ)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Variation */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">バリエーション</label>
                                            {suggestedData && renderChip("AI", suggestedData.variation, 'variation')}
                                        </div>
                                        <input {...register('variation')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="例: Black Refractor" />
                                    </div>

                                    {/* Serial */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">シリアル番号</label>
                                            {suggestedData && renderChip("AI", suggestedData.serialNumber, 'serialNumber')}
                                        </div>
                                        <input {...register('serialNumber')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="例: 01/10" />
                                    </div>

                                    {/* Flags */}
                                    <div className="md:col-span-2 flex gap-8 pt-2">
                                        <label className="flex items-center gap-3 cursor-pointer group">
                                            <input type="checkbox" {...register('isRookie')} className="w-5 h-5 rounded border-brand-platinum/20 bg-brand-dark text-brand-gold focus:ring-brand-gold" />
                                            <span className="text-white group-hover:text-brand-gold transition-colors">ルーキーカード (RC)</span>
                                        </label>
                                        <label className="flex items-center gap-3 cursor-pointer group">
                                            <input type="checkbox" {...register('isAutograph')} className="w-5 h-5 rounded border-brand-platinum/20 bg-brand-dark text-brand-gold focus:ring-brand-gold" />
                                            <span className="text-white group-hover:text-brand-gold transition-colors">直筆サイン入り (Auto)</span>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            {/* --- Section 3: Condition & Grading --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-sm">3</span>
                                    Condition (状態)
                                </h3>

                                {/* Graded Toggle */}
                                <div className="flex items-center mb-6 p-4 rounded-xl bg-brand-dark-light/30 border border-white/5 cursor-pointer" onClick={() => setValue('isGraded', !isGraded)}>
                                    <div className={`w-6 h-6 rounded border flex items-center justify-center mr-4 transition-all ${isGraded ? 'bg-brand-gold border-brand-gold' : 'border-brand-platinum/30'}`}>
                                        {isGraded && <svg className="w-4 h-4 text-brand-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                    </div>
                                    <span className="text-white font-bold">鑑定済みですか？ (PSA/BGSなど)</span>
                                </div>

                                {isGraded ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in-up">
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">鑑定会社</label>
                                                {suggestedData && renderChip("AI", suggestedData.gradingCompany, 'gradingCompany')}
                                            </div>
                                            <select {...register('gradingCompany')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white">
                                                <option value="PSA">PSA</option>
                                                <option value="BGS">BGS</option>
                                                <option value="SGC">SGC</option>
                                                <option value="CGC">CGC</option>
                                                <option value="ARS">ARS</option>
                                            </select>
                                        </div>
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">グレード (点数)</label>
                                                {suggestedData && renderChip("AI", suggestedData.grade, 'grade')}
                                            </div>
                                            <input {...register('grade')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="10" />
                                        </div>

                                        {/* Certification Number */}
                                        <div className="md:col-span-2">
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">証明番号 (任意)</label>
                                            </div>
                                            <input {...register('certificationNumber')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="12345678" />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="animate-fade-in-up">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">未鑑定カードの状態</label>
                                            {suggestedData && renderChip("AI", suggestedData.condition, 'condition')}
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('condition')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>状態を選択...</option>
                                                <option value="Gem Mint">Gem Mint (完品)</option>
                                                <option value="Mint">Mint (美品)</option>
                                                <option value="Near Mint">Near Mint (準美品)</option>
                                                <option value="Excellent">Excellent (良品)</option>
                                                <option value="Very Good">Very Good (可)</option>
                                                <option value="Poor">Poor (難あり)</option>
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </section>

                            {/* --- Section 4: Other --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-sm">4</span>
                                    Price & Note (価格・詳細)
                                </h3>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-sm font-medium text-brand-platinum mb-2 block">商品説明 / 詳細メモ</label>
                                        <textarea {...register('description')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white h-24" placeholder="傷の状態や特徴など..." />
                                    </div>

                                    <div>



                                        {/* External Market Links */}
                                        {suggestedData && (
                                            <div className="mb-6">
                                                <MarketPriceLinks
                                                    initialQuery={[
                                                        suggestedData.year?.value,
                                                        suggestedData.brand?.value,
                                                        suggestedData.playerName?.value,
                                                        suggestedData.cardNumber?.value,
                                                        // suggestedData.variation?.value // Optional: might be too specific
                                                    ].filter(Boolean).join(' ')}
                                                />
                                            </div>
                                        )}

                                        <label className="text-sm font-bold text-brand-gold tracking-wider mb-2 block uppercase">販売価格 (円) <span className="text-red-500">*</span></label>
                                        <div className="relative">
                                            <span className="absolute left-4 top-3.5 text-brand-platinum">¥</span>
                                            <input
                                                type="number"
                                                {...register('price', { valueAsNumber: true })}
                                                className="block w-full pl-8 pr-4 py-3 rounded-xl bg-brand-dark-light/80 border border-brand-platinum/20 text-white font-heading text-lg"
                                                placeholder="5000"
                                            />
                                            {errors.price && <p className="text-red-400 text-xs mt-1">{errors.price.message}</p>}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            {/* Status Feedback */}
                            {
                                aiFeedback && (
                                    <div className="rounded-xl bg-green-500/10 p-4 border border-green-500/20 flex items-center gap-3 animate-fade-in-up">
                                        <svg className="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                        <p className="text-sm text-green-300 font-medium">{aiFeedback}</p>
                                    </div>
                                )
                            }
                            {
                                formError && (
                                    <div className="rounded-xl bg-red-500/10 p-4 border border-red-500/20 flex items-center gap-3 animate-shake">
                                        <svg className="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <p className="text-sm text-red-300 font-medium">{formError}</p>
                                    </div>
                                )
                            }

                            {/* Submit Button */}
                            <div className="pt-6">
                                <button
                                    type="submit"
                                    disabled={submitting}
                                    className={`w-full flex justify-center items-center gap-2 py-4 px-6 border border-transparent rounded-xl shadow-lg shadow-brand-blue/20 text-lg font-bold text-white bg-gradient-to-r from-brand-blue to-brand-blue-glow hover:from-brand-blue-glow hover:to-brand-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${submitting ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {submitting ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>出品中...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>出品する</span>
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    )}

                </form >
            </div >
        </div >
    );
}

export default function SellPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <Suspense fallback={<div className="min-h-screen flex items-center justify-center text-white">Loading...</div>}>
                <SellContent />
            </Suspense>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/error.tsx">
'use client';

import { useEffect } from 'react';

export default function Error({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    useEffect(() => {
        console.error(error);
    }, [error]);

    return (
        <div className="min-h-screen flex items-center justify-center bg-brand-dark relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute inset-0 z-0">
                <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-red-500/5 rounded-full blur-[100px]"></div>
                <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-brand-blue/5 rounded-full blur-[100px]"></div>
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10 bg-center"></div>
            </div>

            <div className="relative z-10 text-center px-4 max-w-lg mx-auto">
                <div className="mb-8 flex justify-center">
                    <div className="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/20 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
                        <svg className="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                </div>
                <h2 className="text-3xl font-heading font-bold text-white mb-4">エラーが発生しました</h2>
                <p className="text-brand-platinum/60 mb-8 text-lg">{error.message || "予期しないエラーが発生しました。再度お試しください。"}</p>
                <button
                    onClick={() => reset()}
                    className="px-8 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-full transition-all shadow-lg hover:shadow-brand-blue/30"
                >
                    再試行
                </button>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/global-error.tsx">
'use client';

import './globals.css';


export default function GlobalError({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    return (
        <html>
            <body className="bg-brand-dark text-white">
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="text-center">
                        <h2 className="text-2xl font-bold mb-4">Something went wrong!</h2>
                        <p className="text-brand-platinum/60 mb-6">{error.message}</p>
                        <button
                            onClick={() => reset()}
                            className="px-4 py-2 bg-brand-blue rounded-lg hover:bg-brand-blue-glow transition-colors"
                        >
                            Try again
                        </button>
                    </div>
                </div>
            </body>
        </html>
    );
}
</file>

<file path="frontend/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    @apply bg-brand-dark;
  }

  body {
    @apply text-white font-sans antialiased relative min-h-screen overflow-x-hidden;
    background-color: transparent;
    background-image:
      radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
      linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 100% 100%, 40px 40px, 40px 40px;
    background-position: center top, center top, center top;
    background-repeat: no-repeat, repeat, repeat;
  }

  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/bg-stadium.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.2;
    z-index: -1;
    pointer-events: none;
    mix-blend-mode: screen;
  }
}

@layer utilities {
  .glass-panel {
    @apply bg-brand-dark-light/70 backdrop-blur-xl border border-white/10 shadow-2xl;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
  }

  .glass-panel-premium {
    @apply bg-brand-dark-light/80 backdrop-blur-xl border-t border-l border-white/10 border-b border-r border-black/30 shadow-2xl;
    box-shadow:
      0 4px 30px rgba(0, 0, 0, 0.5),
      inset 0 0 0 1px rgba(255, 215, 0, 0.05);
    /* Subtle gold inset */
  }

  .text-glow {
    text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
  }

  .text-gold-glow {
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
  }

  .card-hover {
    @apply transition-all duration-300 hover:scale-105 hover:-translate-y-2 hover:shadow-2xl hover:shadow-brand-blue/20 hover:border-brand-blue/40;
  }

  .card-hover-premium {
    @apply transition-all duration-500 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl hover:shadow-brand-gold/20 hover:border-brand-gold/40;
  }
}
</file>

<file path="frontend/app/layout.tsx">
import type { Metadata, Viewport } from "next";
import { Inter, Outfit } from "next/font/google";
import "./globals.css";
import Link from "next/link";
// import { Providers } from "./providers";
import Header from "../components/Header";
import LiveMomentListener from "../components/LiveMomentListener";
import DevTools from "../components/DevTools";

const inter = Inter({ subsets: ["latin"], variable: "--font-inter" });
const outfit = Outfit({ subsets: ["latin"], variable: "--font-outfit" });

export const metadata: Metadata = {
  title: "Baseball Card Market",
  description: "Trading platform for baseball cards",
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${inter.variable} ${outfit.variable} font-sans text-white antialiased`}>
        {/* <Providers> */}
        <Header />
        <LiveMomentListener />
        <DevTools />
        <main>{children}</main>
        {/* </Providers> */}
      </body>
    </html>
  );
}
</file>

<file path="frontend/app/not-found.tsx">
'use client';

import Link from 'next/link';

export default function NotFound() {
    return (
        <div className="min-h-screen flex items-center justify-center bg-brand-dark relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute inset-0 z-0">
                <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-brand-blue/10 rounded-full blur-[100px]"></div>
                <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-brand-gold/5 rounded-full blur-[100px]"></div>
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10 bg-center"></div>
            </div>

            <div className="relative z-10 text-center px-4">
                <h1 className="text-9xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-br from-brand-platinum to-brand-dark-light opacity-50 mb-0 leading-none select-none">
                    404
                </h1>
                <div className="-mt-12 mb-8 relative">
                    <h2 className="text-3xl md:text-4xl font-heading font-bold text-white mb-4 drop-shadow-lg">
                        ページが見つかりません
                    </h2>
                    <p className="text-brand-platinum/60 max-w-md mx-auto text-lg mb-8">
                        お探しのカードが見つかりませんでした。
                    </p>
                </div>

                <Link
                    href="/"
                    className="inline-flex items-center gap-2 px-8 py-4 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-full transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:scale-105"
                >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    ホームへ戻る
                </Link>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation'; // Added
import HeroSection from '../components/HeroSection';
import CardListing from '../components/CardListing';
import Footer from '../components/Footer';
import SkeletonCard from '../components/SkeletonCard';
import { ListingItem, Team } from '../types';

import { createClient } from '../utils/supabase/client';

function HomeContent() {
  const searchParams = useSearchParams(); // Added
  const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

  const [listings, setListings] = useState<ListingItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Search & Filter State
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedTeam, setSelectedTeam] = useState<string>('');
  const [sortOrder, setSortOrder] = useState('newest');

  // Debounce search
  const [debouncedSearch, setDebouncedSearch] = useState(searchQuery);

  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(searchQuery);
    }, 500);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  useEffect(() => {
    const fetchListings = async () => {
      setLoading(true);
      try {
        const supabase = createClient();
        let query = supabase
          .from('listing_items')
          .select('*')
          .eq('status', 'Active');

        if (debouncedSearch) {
          // Note: This is a simple search. For better search, use text search capabilities or join with catalog
          // Since we can't easily filter on joined table fields with simple syntax in one go without embedding, 
          // we might need to rely on client side filtering or more complex queries.
          // For now, let's assume we filter by catalog fields if possible, but Supabase JS client filtering on joined tables is tricky.
          // A common workaround is !inner join or text search.
          // Let's try to filter by player_name in catalog if possible, but standard select doesn't support filtering on joined relation easily in top level.
          // We will fetch all and filter client side for search if it's small, or use a specific RPC or search index.
          // Given the constraints, let's try to use the 'search' param if we had an RPC, but we don't.
          // Let's just fetch active listings and filter client side for the demo if the dataset is small, 
          // OR use the text search on a view.
          // For this migration, I'll implement a basic fetch and client-side filter for the search text to be safe, 
          // or try to use `!inner` to filter by catalog team/player.

          // Using !inner to filter by catalog properties
          // query = query.not('catalog', 'is', null); // Ensure catalog exists
        }

        if (selectedTeam) {
          // This requires filtering on the joined 'catalog' table.
          // Supabase supports this with: .eq('catalog.team', selectedTeam) if using JSON or specific syntax, 
          // but strictly typed client might complain.
          // Let's use the !inner hint if we can, or just fetch and filter.
          // For simplicity and reliability in this migration without changing schema:
          // We will fetch more and filter in memory, OR we assume the user has set up RLS/Views.
          // Actually, let's try to use the foreign key filter syntax:
          // .eq('catalog.team', selectedTeam) works if we use !inner in select: select('*, catalog!inner(*)')
          // But let's stick to a simpler approach: Fetch active items and filter.
        }

        // Sorting
        if (sortOrder === 'newest') {
          query = query.order('created_at', { ascending: false });
        } else if (sortOrder === 'price_asc') {
          query = query.order('price', { ascending: true });
        } else if (sortOrder === 'price_desc') {
          query = query.order('price', { ascending: false });
        }

        const { data, error } = await query;

        if (error) throw error;

        let filteredData = data as any[];

        // Client-side filtering for Search and Team (since simple join filtering is complex in JS client without specific setup)
        if (debouncedSearch) {
          const lowerSearch = debouncedSearch.toLowerCase();
          filteredData = filteredData.filter(item => {
            const playerName = item.player_name || '';
            const manufacturer = item.manufacturer || '';
            const series = item.variation || item.series_name || '';

            return (
              playerName.toLowerCase().includes(lowerSearch) ||
              manufacturer.toLowerCase().includes(lowerSearch) ||
              series.toLowerCase().includes(lowerSearch)
            );
          });
        }

        if (selectedTeam) {
          filteredData = filteredData.filter(item => {
            const team = item.team;
            return team === selectedTeam;
          });
        }

        setListings(filteredData);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'An unknown error occurred');
      } finally {
        setLoading(false);
      }
    };

    fetchListings();
  }, [debouncedSearch, selectedTeam, sortOrder]);

  const teams: Team[] = ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"];

  return (
    <div className="min-h-screen bg-brand-dark flex flex-col">
      <HeroSection />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-20 relative z-20 flex-1 w-full">
        {/* Search & Filter Bar */}
        <div className="glass-panel-premium p-6 rounded-2xl shadow-2xl mb-12 animate-fade-in-up">
          <div className="flex flex-col md:flex-row gap-4 items-center">
            {/* Search Input */}
            <div className="flex-1 w-full">
              <label htmlFor="search" className="sr-only">Search</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg className="h-5 w-5 text-brand-platinum/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                </div>
                <input
                  type="text"
                  id="search"
                  placeholder="選手名、シリーズ、年代などで検索..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="block w-full pl-10 pr-3 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                />
              </div>
            </div>

            {/* Team Filter */}
            <div className="w-full md:w-48">
              <label htmlFor="team" className="sr-only">Team</label>
              <select
                id="team"
                value={selectedTeam}
                onChange={(e) => setSelectedTeam(e.target.value)}
                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
              >
                <option value="">全チーム</option>
                {teams.map((team) => (
                  <option key={team} value={team}>{team}</option>
                ))}
              </select>
            </div>

            {/* Sort Order */}
            <div className="w-full md:w-48">
              <label htmlFor="sort" className="sr-only">Sort</label>
              <select
                id="sort"
                value={sortOrder}
                onChange={(e) => setSortOrder(e.target.value)}
                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
              >
                <option value="newest">新着順</option>
                <option value="price_asc">価格が安い順</option>
                <option value="price_desc">価格が高い順</option>
              </select>
            </div>
          </div>
        </div>

        {/* Listings Grid */}
        <div className="mb-12">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-3xl font-heading font-bold text-white">Latest Arrivals</h2>
            <span className="text-brand-platinum/60 text-sm">{listings.length} 件</span>
          </div>

          {loading ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
              {[...Array(8)].map((_, i) => (
                <SkeletonCard key={i} />
              ))}
            </div>
          ) : error ? (
            <div className="min-h-[400px] flex items-center justify-center">
              <div className="text-red-500 text-xl font-semibold bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error}</div>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                {listings.map((item) => (
                  <CardListing key={item.id} item={item} isLiveMoment={isDebugLive} />
                ))}
              </div>

              {listings.length === 0 && (
                <div className="text-center py-20 bg-brand-dark-light/30 rounded-2xl border border-brand-platinum/5">
                  <p className="text-brand-platinum/50 text-lg">条件に一致するカードが見つかりませんでした。</p>
                  <button
                    onClick={() => { setSearchQuery(''); setSelectedTeam(''); }}
                    className="mt-4 text-brand-blue hover:text-brand-blue-glow font-medium"
                  >
                    条件をクリア
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      </div>

      <Footer />
    </div>
  );
}

export default function Home() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
      <HomeContent />
    </Suspense>
  );
}
</file>

<file path="frontend/components/emails/OrderConfirmationEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderConfirmationEmailProps {
    buyerName?: string;
    productName?: string;
    orderUrl?: string;
    price?: number;
}

export const OrderConfirmationEmail = ({
    buyerName = "Collector",
    productName = "Your New Card",
    orderUrl = "http://localhost:3000/orders/buy",
    price = 0,
}: OrderConfirmationEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Order Confirmed: {productName}</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Order Confirmed!
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                Thank you for your purchase, {buyerName}.
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] font-mono text-[16px] font-bold text-center mt-2">
                                ¥{price.toLocaleString()}
                            </Text>

                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The seller has been notified and will ship your item soon.
                                You will receive another email when it ships.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                VIEW ORDER
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderConfirmationEmail;
</file>

<file path="frontend/components/emails/OrderReceivedEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderReceivedEmailProps {
    sellerName?: string;
    productName?: string;
    payoutUrl?: string; // Link to payout page
}

export const OrderReceivedEmail = ({
    sellerName = "Seller",
    productName = "Your Item",
    payoutUrl = "http://localhost:3000/payouts",
}: OrderReceivedEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Transaction Complete: Funds Added</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Transaction Complete, {sellerName}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The buyer has received your item:
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] text-[14px] font-bold text-center mt-6">
                                The sales proceeds have been added to your balance.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={payoutUrl}
                            >
                                VIEW BALANCE
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderReceivedEmail;
</file>

<file path="frontend/components/emails/OrderShippedEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderShippedEmailProps {
    buyerName?: string;
    productName?: string;
    trackingNumber?: string;
    carrier?: string;
    orderUrl?: string; // Link to order detail
    baseUrl?: string;
}

export const OrderShippedEmail = ({
    buyerName = "Collector",
    productName = "Your Item",
    trackingNumber,
    carrier,
    orderUrl = "http://localhost:3000/orders",
}: OrderShippedEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Your order has been shipped!</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Your Item is on the Way, {buyerName}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The following item has been shipped:
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>

                            {(trackingNumber || carrier) && (
                                <Section className="mt-4 p-4 bg-white/5 rounded border border-white/10 text-center">
                                    {carrier && (
                                        <Text className="text-[#E5E4E2] text-[14px] m-0">
                                            Carrier: {carrier}
                                        </Text>
                                    )}
                                    {trackingNumber && (
                                        <Text className="text-[#FFD700] text-[16px] font-mono m-0 mt-1">
                                            Tracking: {trackingNumber}
                                        </Text>
                                    )}
                                </Section>
                            )}

                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                VIEW ORDER STATUS
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Please click "Received" when the item arrives.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderShippedEmail;
</file>

<file path="frontend/components/emails/PayoutRequestEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface PayoutRequestEmailProps {
    userName?: string;
    amount?: number;
    payoutId?: string;
    adminUrl?: string;
}

export const PayoutRequestEmail = ({
    userName = "User",
    amount = 0,
    payoutId = "",
    adminUrl = "http://localhost:3000/admin/payouts",
}: PayoutRequestEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>New Payout Request: ¥{amount.toLocaleString()}</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-2xl font-bold text-center tracking-widest p-0 my-0">
                                ADMIN NOTIFICATION
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[18px] font-normal text-center p-0 my-0 mx-0">
                                New Payout Request
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                User <strong>{userName}</strong> has requested a payout.
                            </Text>
                            <Text className="text-[#FFD700] font-mono text-[24px] font-bold text-center mt-4">
                                ¥{amount.toLocaleString()}
                            </Text>

                            <Text className="text-[#6B7280] text-[12px] text-center mt-2">
                                ID: {payoutId}
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={adminUrl}
                            >
                                REVIEW PAYOUTS
                            </Button>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default PayoutRequestEmail;
</file>

<file path="frontend/components/emails/ShippingRequestEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface ShippingRequestEmailProps {
    sellerName?: string;
    productName?: string;
    orderUrl?: string;
}

export const ShippingRequestEmail = ({
    sellerName = "Seller",
    productName = "Your Item",
    orderUrl = "http://localhost:3000/orders/sell",
}: ShippingRequestEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Action Required: Your item has been sold!</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Item Sold!
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                Great news, {sellerName}. Your item has been purchased.
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] text-[14px] font-bold text-center mt-6">
                                Please ship the item to the buyer.
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-2">
                                Check the shipping address and enter the tracking number on your dashboard.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                MANAGE ORDER
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default ShippingRequestEmail;
</file>

<file path="frontend/components/emails/WelcomeEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface WelcomeEmailProps {
    userFirstname?: string;
    baseUrl?: string;
}

export const WelcomeEmail = ({
    userFirstname = "Member",
    baseUrl = "http://localhost:3000",
}: WelcomeEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Welcome to the Stadium Card Exclusive Club.</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Welcome to the Elite, {userFirstname}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                You have successfully joined the premier marketplace for high-end baseball cards.
                                Prepare to collect moments that define history.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={`${baseUrl}/market`}
                            >
                                EXPLORE THE COLLECTION
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                © 2024 Stadium Card Team. All rights reserved.<br />
                                This is a system generated message.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default WelcomeEmail;
</file>

<file path="frontend/components/AddToShowcaseModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '../utils/supabase/client';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

// --- Data Constants (Mirrored from SellPage) ---
const MLB_TEAMS = [
    "アリゾナ・ダイヤモンドバックス", "アトランタ・ブレーブス", "ボルチモア・オリオールズ", "ボストン・レッドソックス", "シカゴ・カブス",
    "シカゴ・ホワイトソックス", "シンシナティ・レッズ", "クリーブランド・ガーディアンズ", "コロラド・ロッキーズ", "デトロイト・タイガース",
    "ヒューストン・アストロズ", "カンザスシティ・ロイヤルズ", "ロサンゼルス・エンゼルス", "ロサンゼルス・ドジャース", "マイアミ・マーリンズ",
    "ミルウォーキー・ブルワーズ", "ミネソタ・ツインズ", "ニューヨーク・メッツ", "ニューヨーク・ヤンキース", "オークランド・アスレチックス",
    "フィラデルフィア・フィリーズ", "ピッツバーグ・パイレーツ", "サンディエゴ・パドレス", "サンフランシスコ・ジャイアンツ", "シアトル・マリナーズ",
    "セントルイス・カージナルス", "タンパベイ・レイズ", "テキサス・レンジャーズ", "トロント・ブルージェイズ", "ワシントン・ナショナルズ"
];

const NPB_TEAMS = [
    "読売ジャイアンツ", "阪神タイガース", "中日ドラゴンズ", "横浜DeNAベイスターズ", "広島東洋カープ", "東京ヤクルトスワローズ",
    "福岡ソフトバンクホークス", "千葉ロッテマリーンズ", "埼玉西武ライオンズ", "東北楽天ゴールデンイーグルス", "北海道日本ハムファイターズ", "オリックス・バファローズ", "日本代表", "その他"
];

const CARD_BRANDS = [
    "Topps", "Panini", "Upper Deck", "BBM", "EPOCH", "Leaf", "Bowman", "Fleer", "Donruss", "Score", "Select", "Prizm", "Chrome", "Finest", "Other", "Unknown"
];

const CURRENT_YEAR = new Date().getFullYear();
const YEARS = Array.from({ length: CURRENT_YEAR - 1949 }, (_, i) => (CURRENT_YEAR + 1 - i).toString());

// --- Zod Schema ---
const collectionSchema = z.object({
    playerName: z.string().min(1, "Player name is required"),
    team: z.string().min(1, "Team is required"),
    year: z.string().optional(),
    brand: z.string().min(1, "Brand is required"),
    variation: z.string().optional(),
    serialNumber: z.string().optional(),
    isRookie: z.boolean().optional(),
    isAutograph: z.boolean().optional(),
    isGraded: z.boolean().optional(),
    gradingCompany: z.string().optional(),
    grade: z.string().optional(),
    certificationNumber: z.string().optional(),
    condition: z.string().optional(),
    images: z.array(z.string()).min(1, "At least one image is required"),
    status: z.enum(['Draft', 'Active', 'Display', 'Sold']),
    price: z.string().optional(),
}).superRefine((data, ctx) => {
    if (data.status === 'Active' && (!data.price || isNaN(parseInt(data.price)))) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Price is required for active listings",
            path: ["price"],
        });
    }
    if (!data.isGraded && !data.condition) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Condition is required for raw cards",
            path: ["condition"],
        });
    }
});

type CollectionFormData = z.infer<typeof collectionSchema>;

interface AddToShowcaseModalProps {
    isOpen: boolean;
    onClose: () => void;
    onAdded: () => void;
    mode?: 'add' | 'edit';
    initialData?: any;
}

export default function AddToShowcaseModal({ isOpen, onClose, onAdded, mode = 'add', initialData }: AddToShowcaseModalProps) {
    const [images, setImages] = useState<string[]>([]);
    const [selectedImageIndices, setSelectedImageIndices] = useState<number[]>([]);
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null);
    const [uploading, setUploading] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    const [hasAnalyzed, setHasAnalyzed] = useState(false);
    const [suggestedData, setSuggestedData] = useState<any>(null);
    const [country, setCountry] = useState<'USA' | 'JP'>('USA');
    const [isDragging, setIsDragging] = useState(false);

    const {
        register,
        handleSubmit,
        setValue,
        getValues,
        watch,
        reset,
        formState: { errors, isSubmitting }
    } = useForm<CollectionFormData>({
        resolver: zodResolver(collectionSchema),
        defaultValues: {
            playerName: '',
            team: '',
            year: '',
            brand: 'Unknown',
            variation: '',
            serialNumber: '',
            isRookie: false,
            isAutograph: false,
            isGraded: false,
            gradingCompany: 'PSA',
            grade: '10',
            certificationNumber: '',
            condition: '',
            images: [],
            status: 'Draft',
            price: '',
        }
    });

    const status = watch('status');

    const isGraded = watch('isGraded');

    useEffect(() => {
        if (isOpen) {
            reset();
            setHasAnalyzed(false);
            setSuggestedData(null);
            setCountry('USA');

            if (mode === 'edit' && initialData) {
                // Populate for Edit with Catalog Fallback
                setValue('playerName', initialData.player_name || '');
                setValue('team', initialData.team || '');
                setValue('year', (initialData.year || '').toString());
                setValue('brand', initialData.manufacturer || 'Unknown');
                setValue('variation', initialData.variation || ''); // Variation usually not in catalog base
                setValue('serialNumber', initialData.serial_number || '');
                setValue('isRookie', initialData.is_rookie || false);
                setValue('isAutograph', initialData.is_autograph || false);

                // Images
                const existingImages = initialData.images || [];
                setImages(existingImages);
                setValue('images', existingImages);

                // Grading / Condition
                if (initialData.condition_grading?.is_graded) {
                    setValue('isGraded', true);
                    setValue('gradingCompany', initialData.condition_grading.service || 'PSA');
                    setValue('grade', initialData.condition_grading.score?.toString() || '10');
                    setValue('certificationNumber', initialData.condition_grading.certification_number || '');
                } else {
                    setValue('isGraded', false);
                    setValue('condition', initialData.condition_rating || '');
                }

                // Status & Price
                setValue('status', initialData.status as any || 'Draft');
                setValue('price', initialData.price ? initialData.price.toString() : '');
            } else {
                // Reset for Add
                setImages([]);
                setSelectedImageIndices([]);
            }
        }
    }, [isOpen, reset, mode, initialData, setValue]);

    const uploadFiles = async (files: FileList) => {
        setUploading(true);
        const newUrls: string[] = [];
        const supabase = createClient();

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                newUrls.push(publicUrl);
            }

            const currentImages = getValues('images') || [];
            const updatedImages = [...currentImages, ...newUrls];
            setImages(updatedImages);
            setValue('images', updatedImages);

            if (currentImages.length === 0 && newUrls.length > 0) {
                setSelectedImageIndices([0]);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to upload image(s)');
        } finally {
            setUploading(false);
        }
    };

    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.files || e.target.files.length === 0) return;
        await uploadFiles(e.target.files);
    };

    const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); setIsDragging(true); };
    const handleDragLeave = (e: React.DragEvent) => { e.preventDefault(); setIsDragging(false); };
    const handleDrop = async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        if (e.dataTransfer.files?.length > 0) await uploadFiles(e.dataTransfer.files);
    };

    const removeImage = (index: number) => {
        const newImages = images.filter((_, i) => i !== index);
        setImages(newImages);
        setValue('images', newImages);
        setSelectedImageIndices(prev => prev.filter(i => i !== index).map(i => i > index ? i - 1 : i));
    };

    const toggleImageSelection = (index: number) => {
        if (selectedImageIndices.includes(index)) {
            setSelectedImageIndices(prev => prev.filter(i => i !== index));
        } else {
            setSelectedImageIndices(prev => [...prev, index]);
        }
    };

    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = "move";
    };

    const handleDragEnter = (e: React.DragEvent, index: number) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;

        const currentImages = [...images];
        const item = currentImages[draggedIndex];
        currentImages.splice(draggedIndex, 1);
        currentImages.splice(index, 0, item);

        setImages(currentImages);
        setValue('images', currentImages);
        setDraggedIndex(index);
    };

    const handleDragEnd = () => {
        setDraggedIndex(null);
    };

    const analyzeImage = async () => {
        if (images.length === 0) return;
        if (selectedImageIndices.length === 0) {
            alert("Please select at least one image to analyze.");
            return;
        }

        setAnalyzing(true);
        try {
            const imageIndex = selectedImageIndices[0];
            const imageUrl = images[imageIndex];

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64data = reader.result;
                const apiRes = await fetch('/api/analyze-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64data }),
                });
                if (!apiRes.ok) throw new Error('AI Analysis failed');
                const data = await apiRes.json();

                setSuggestedData(data);
                setHasAnalyzed(true);

                // Populate Form
                if (data.playerName?.value) setValue('playerName', data.playerName.value);
                if (data.year?.value) setValue('year', data.year.value);
                if (data.variation?.value) setValue('variation', data.variation.value);
                if (data.serialNumber?.value) setValue('serialNumber', data.serialNumber.value);
                if (data.isRookie?.value === 'true') setValue('isRookie', true);
                if (data.isAutograph?.value === 'true') setValue('isAutograph', true);
                if (data.isGraded?.value === 'true') {
                    setValue('isGraded', true);
                    if (data.gradingCompany?.value) setValue('gradingCompany', data.gradingCompany.value);
                    if (data.grade?.value) setValue('grade', data.grade.value);
                } else if (data.condition?.value) {
                    setValue('condition', data.condition.value);
                }
            };
            reader.readAsDataURL(blob);
        } catch (err) {
            console.error(err);
            alert('AI Analysis failed');
        } finally {
            setAnalyzing(false);
        }
    };

    const onSubmit = async (formData: CollectionFormData) => {
        try {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) throw new Error('Not authenticated');

            const listingData = {
                seller_id: user.id,
                // catalog_id: null, // Removed
                player_name: formData.playerName,
                team: formData.team,
                year: parseInt(formData.year || '0') || null,
                manufacturer: formData.brand,
                variation: formData.variation,
                serial_number: formData.serialNumber,
                is_rookie: formData.isRookie || false,
                is_autograph: formData.isAutograph || false,
                images: formData.images,

                status: formData.status,
                price: formData.price ? parseInt(formData.price) : null,
                condition_grading: {
                    is_graded: formData.isGraded || false,
                    service: formData.isGraded ? formData.gradingCompany : "None",
                    score: formData.isGraded ? parseFloat(formData.grade || '0') : null,
                    certification_number: formData.isGraded ? formData.certificationNumber : null
                },
                condition_rating: !formData.isGraded ? formData.condition : null,
                deleted_at: null, // Clear archived status if edited/added
            };

            if (mode === 'edit' && initialData?.id) {
                // UPDATE
                const { error } = await supabase
                    .from('listing_items')
                    .update(listingData)
                    .eq('id', initialData.id);

                if (error) throw error;
            } else {
                // INSERT
                const { error } = await supabase.from('listing_items').insert(listingData);
                if (error) throw error;
            }

            onAdded();
            onClose();
        } catch (err: any) {
            console.error(err);
            alert('Failed to save to collection: ' + (err.message || 'Unknown error'));
        }
    };

    const renderChip = (label: string, fieldData: any, fieldName: keyof CollectionFormData) => {
        if (!fieldData?.value) return null;
        return (
            <button
                type="button"
                onClick={() => setValue(fieldName, fieldData.value)}
                className="ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-brand-gold/10 text-brand-gold border border-brand-gold/30 hover:bg-brand-gold/20"
            >
                AI: {fieldData.value}
            </button>
        );
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md overflow-y-auto">
            <div className="glass-panel-premium border border-white/10 rounded-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto shadow-2xl">
                <button onClick={onClose} className="absolute top-4 right-4 text-brand-platinum/50 hover:text-white transition-colors z-10 p-2 hover:bg-white/5 rounded-full">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>

                <h2 className="text-2xl font-heading font-bold text-white mb-6 flex items-center gap-3">
                    <span className="w-1 h-8 bg-brand-gold rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]"></span>
                    {mode === 'edit' ? 'Edit Collection Item' : 'Add to Collection'}
                </h2>

                {/* --- Image Upload (Step 1) --- */}
                <div className="mb-6">
                    <label
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        className={`group relative flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-xl transition-all duration-300 cursor-pointer overflow-hidden ${uploading ? 'opacity-50 cursor-not-allowed' : ''} ${isDragging ? 'border-brand-gold bg-brand-gold/10 scale-[1.02]' : 'border-brand-platinum/20 hover:border-brand-gold/50 hover:bg-brand-gold/5 bg-black/20'}`}
                    >
                        <div className="flex flex-col items-center justify-center">
                            <div className="w-12 h-12 mb-3 rounded-full bg-brand-platinum/5 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                <svg className="w-6 h-6 text-brand-platinum/50 group-hover:text-brand-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </div>
                            <p className="text-sm text-brand-platinum font-medium">Click or Drag to Upload</p>
                            <p className="text-xs text-brand-platinum/50 mt-1">Supports Multiple JPG, PNG</p>
                        </div>
                        <input type="file" accept="image/*" multiple className="hidden" onChange={handleImageUpload} disabled={uploading} />
                        {uploading && <div className="absolute inset-0 bg-brand-dark/80 backdrop-blur-sm flex items-center justify-center rounded-xl"><div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-brand-gold"></div></div>}
                    </label>



                    {/* Thumbnails Grid */}
                    {(images.length > 0 || (mode === 'edit' && images.length > 0)) && (
                        <div className="grid grid-cols-5 gap-2 mt-4">
                            {images.map((img, idx) => (
                                <div
                                    key={idx}
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, idx)}
                                    onDragEnter={(e) => handleDragEnter(e, idx)}
                                    onDragEnd={handleDragEnd}
                                    onDragOver={(e) => e.preventDefault()}
                                    onClick={() => toggleImageSelection(idx)}
                                    className={`relative aspect-[3/4] group cursor-pointer transition-transform ${draggedIndex === idx ? 'opacity-50 scale-105' : ''}`}
                                >
                                    {/* eslint-disable-next-line @next/next/no-img-element */}
                                    <img
                                        src={img}
                                        alt={`Thumbnail ${idx}`}
                                        className={`w-full h-full object-cover rounded-md border transition-all ${selectedImageIndices.includes(idx) ? 'border-brand-gold ring-2 ring-brand-gold/30' : 'border-white/10'}`}
                                    />
                                    {selectedImageIndices.includes(idx) && (
                                        <div className="absolute top-1 right-1 w-4 h-4 bg-brand-gold rounded-full flex items-center justify-center shadow-md">
                                            <svg className="w-3 h-3 text-brand-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>
                                        </div>
                                    )}
                                    <button
                                        type="button"
                                        onClick={(e) => { e.stopPropagation(); removeImage(idx); }}
                                        className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {images.length > 0 && !hasAnalyzed && (
                        <div className="mt-6 flex justify-center">
                            <button
                                onClick={analyzeImage}
                                disabled={analyzing}
                                className="bg-gradient-to-r from-brand-gold to-yellow-400 text-brand-dark font-bold px-8 py-3 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.3)] hover:shadow-[0_0_30px_rgba(234,179,8,0.5)] hover:scale-105 transition-all flex items-center gap-2 text-lg"
                            >
                                {analyzing ? <div className="w-5 h-5 border-2 border-brand-dark border-t-transparent rounded-full animate-spin" /> : <span>✨ AI Auto-Analysis</span>}
                            </button>
                        </div>
                    )}
                </div>

                {/* --- Form (Revealed after Analysis or in Edit Mode) --- */}
                {(hasAnalyzed || mode === 'edit') && (
                    <form onSubmit={handleSubmit(onSubmit as any)} className="space-y-6 animate-fade-in-up">
                        {/* Basic Info */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Player Name {suggestedData && renderChip("AI", suggestedData.playerName, 'playerName')}</label>
                                <input {...register('playerName')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. Shohei Ohtani" />
                                {errors.playerName && <p className="text-red-400 text-xs mt-1">{errors.playerName.message}</p>}
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Year {suggestedData && renderChip("AI", suggestedData.year, 'year')}</label>
                                <div className="relative">
                                    <select {...register('year')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="" disabled>Select Year</option>
                                        <option value="Unknown">Unknown</option>
                                        {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Brand</label>
                                <div className="relative">
                                    <select {...register('brand')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="Unknown">Unknown</option>
                                        {CARD_BRANDS.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>
                        </div>

                        {/* Team Selection */}
                        <div>
                            <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Team</label>
                            <div className="flex gap-2">
                                <div className="relative w-1/3">
                                    <select value={country} onChange={(e) => setCountry(e.target.value as any)} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                        <option value="JP">🇯🇵 NPB</option>
                                        <option value="USA">🇺🇸 MLB</option>
                                    </select>
                                    <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                </div>
                                <div className="flex-1 relative">
                                    <select {...register('team')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="" disabled>Select Team</option>
                                        {(country === 'USA' ? MLB_TEAMS : NPB_TEAMS).map(t => <option key={t} value={t}>{t}</option>)}
                                        <option value="Other">Other</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>
                            {errors.team && <p className="text-red-400 text-xs mt-1">{errors.team.message}</p>}
                        </div>

                        {/* Features */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Variation</label>
                                <input {...register('variation')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. Gold Refractor" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Serial #</label>
                                <input {...register('serialNumber')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. 05/10" />
                            </div>
                        </div>
                        <div className="flex gap-6 p-4 bg-black/20 rounded-xl border border-white/5">
                            <label className="flex items-center gap-3 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isRookie')} className="peer sr-only" />
                                    <div className="w-5 h-5 border-2 border-brand-platinum/30 rounded bg-brand-dark peer-checked:bg-brand-gold peer-checked:border-brand-gold transition-all"></div>
                                    <svg className="absolute w-3 h-3 text-brand-dark left-1 top-1 opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <span className="text-sm font-bold text-brand-platinum group-hover:text-white transition-colors">Rookie (RC)</span>
                            </label>
                            <label className="flex items-center gap-3 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isAutograph')} className="peer sr-only" />
                                    <div className="w-5 h-5 border-2 border-brand-platinum/30 rounded bg-brand-dark peer-checked:bg-brand-gold peer-checked:border-brand-gold transition-all"></div>
                                    <svg className="absolute w-3 h-3 text-brand-dark left-1 top-1 opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <span className="text-sm font-bold text-brand-platinum group-hover:text-white transition-colors">Autograph</span>
                            </label>
                        </div>

                        {/* Condition */}
                        <div className="border-t border-brand-platinum/10 pt-6">
                            <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                Condition & Grading
                            </h3>
                            <label className="flex items-center gap-3 mb-5 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isGraded')} className="peer sr-only" />
                                    <div className="w-10 h-6 bg-brand-dark border border-brand-platinum/30 rounded-full peer-checked:bg-brand-green/20 peer-checked:border-brand-green/50 transition-all"></div>
                                    <div className="absolute left-1 top-1 w-4 h-4 bg-brand-platinum rounded-full peer-checked:translate-x-4 peer-checked:bg-brand-green transition-all shadow-sm"></div>
                                </div>
                                <span className="text-sm font-medium text-white">Professionally Graded Listing</span>
                            </label>

                            {isGraded ? (
                                <div className="grid grid-cols-3 gap-3 animate-fade-in-up">
                                    <div className="relative">
                                        <select {...register('gradingCompany')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                            <option value="PSA">PSA</option>
                                            <option value="BGS">BGS</option>
                                            <option value="CGC">CGC</option>
                                            <option value="SGC">SGC</option>
                                        </select>
                                        <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                    </div>
                                    <div className="relative">
                                        <select {...register('grade')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                            <option value="10">10</option>
                                            <option value="9.5">9.5</option>
                                            <option value="9">9</option>
                                            <option value="8">8</option>
                                            <option value="Authentic">Auth</option>
                                        </select>
                                        <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                    </div>
                                    <input {...register('certificationNumber')} className="bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm placeholder:text-brand-platinum/30" placeholder="Cert #" />
                                </div>
                            ) : (
                                <div className="animate-fade-in-up">
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Card Condition {suggestedData && renderChip("AI", suggestedData.condition, 'condition')}</label>
                                    <div className="relative">
                                        <select {...register('condition')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 transition-all">
                                            <option value="" disabled>Select Condition...</option>
                                            <option value="Gem Mint">Gem Mint</option>
                                            <option value="Mint">Mint</option>
                                            <option value="Near Mint">Near Mint</option>
                                            <option value="Excellent">Excellent</option>
                                            <option value="Very Good">Very Good</option>
                                            <option value="Poor">Poor</option>
                                        </select>
                                        <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                    </div>
                                    {errors.condition && <p className="text-red-400 text-xs mt-1">{errors.condition.message}</p>}
                                </div>
                            )}
                        </div>

                        {/* Status and Price Section */}
                        <div className="border-t border-brand-platinum/10 pt-6">
                            <h3 className="text-sm font-bold text-white mb-4">Listing Status & Price</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Status</label>
                                    <div className="relative">
                                        <select {...register('status')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 transition-all">
                                            <option value="Draft">Draft (Private)</option>
                                            <option value="Display">Showcase (Public Display)</option>
                                            <option value="Active">Active Listing (For Sale)</option>
                                        </select>
                                        <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Price (¥) {status === 'Active' && <span className="text-red-400">*</span>}</label>
                                    <input
                                        type="number"
                                        {...register('price')}
                                        disabled={status !== 'Active'}
                                        placeholder={status === 'Active' ? "Required" : "Optional"}
                                        className={`w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30 ${status !== 'Active' ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    />
                                    {errors.price && <p className="text-red-400 text-xs mt-1">{errors.price.message}</p>}
                                </div>
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="w-full py-4 bg-gradient-to-r from-brand-blue to-blue-600 hover:from-brand-blue-glow hover:to-blue-500 text-white font-bold rounded-xl transition-all disabled:opacity-50 mt-8 shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:shadow-[0_0_30px_rgba(59,130,246,0.5)] transform hover:scale-[1.01] active:scale-[0.99]"
                        >
                            {isSubmitting ? (
                                <div className="flex items-center justify-center gap-2">
                                    <span>{mode === 'edit' ? 'Save Changes' : 'Adding...'}</span>
                                </div>
                            ) : (mode === 'edit' ? 'Save Changes' : (status === 'Active' ? 'List for Sale' : 'Add to Collection'))}
                        </button>
                    </form>
                )}
            </div>
        </div >
    );
}
</file>

<file path="frontend/components/CardListing.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { useState, useEffect, memo } from 'react';
import { motion } from 'framer-motion';
import { ListingItem } from '../types';
import MomentHistoryBadge from './MomentHistoryBadge';

interface LiveMomentInfo {
    id: string;
    title: string;
    endTime: number;
}

interface ListingItemProps {
    item: ListingItem;
    isLiveMoment?: boolean; // Debug/Live prop
    liveMoments?: LiveMomentInfo[];
}

const EMPTY_LIVE_MOMENTS: LiveMomentInfo[] = [];

const CardListing = memo(({ item, isLiveMoment = false, liveMoments = EMPTY_LIVE_MOMENTS }: ListingItemProps) => {
    const isSold = item.status !== 'Active';
    const [isFlipped, setIsFlipped] = useState(false);
    const hasBackImage = item.images && item.images.length > 1;

    // Multiple Countdown Logic
    const [momentsWithTime, setMomentsWithTime] = useState<(LiveMomentInfo & { timeLeft: string })[]>([]);
    // Initialize with correct value to avoid immediate useEffect setState
    const [isLiveActive, setIsLiveActive] = useState(isLiveMoment || liveMoments.length > 0);

    useEffect(() => {
        // BAIL if nothing to track
        if (!isLiveMoment && liveMoments.length === 0) {
            setIsLiveActive(prev => prev !== false ? false : prev);
            setMomentsWithTime(prev => prev.length !== 0 ? [] : prev);
            return;
        }

        const updateTimers = () => {
            const now = new Date().getTime();
            let anyActive = false;

            const updatedMoments = liveMoments.map((m: LiveMomentInfo) => {
                const distance = m.endTime - now;
                let timeLeft = '00:00';
                if (distance > 0) {
                    anyActive = true;
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timeLeft = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return { ...m, timeLeft };
            });

            // Deep comparison to avoid redundant renders
            setMomentsWithTime(prev => {
                const isSame = prev.length === updatedMoments.length &&
                    prev.every((p, i) => p.timeLeft === updatedMoments[i].timeLeft && p.id === updatedMoments[i].id);
                return isSame ? prev : updatedMoments;
            });

            const nextLiveActive = isLiveMoment || anyActive;
            setIsLiveActive(prev => prev !== nextLiveActive ? nextLiveActive : prev);
        };

        updateTimers();
        const timer = setInterval(updateTimers, 1000);
        return () => clearInterval(timer);
    }, [isLiveMoment, liveMoments]);

    const handleFlip = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsFlipped(!isFlipped);
    };

    const cardContent = (
        <motion.div
            className={`glass-panel rounded-xl overflow-hidden card-hover h-full flex flex-col relative ${isSold ? 'grayscale-[0.5]' : ''}`}
            animate={isLiveActive ? {
                boxShadow: [
                    "0 0 15px rgba(255, 69, 0, 0.2)",
                    "0 0 30px rgba(255, 69, 0, 0.6)",
                    "0 0 15px rgba(255, 69, 0, 0.2)"
                ],
                borderColor: [
                    "rgba(255, 69, 0, 0.4)",
                    "rgba(255, 69, 0, 1)",
                    "rgba(255, 69, 0, 0.4)"
                ]
            } : {}}
            transition={{
                duration: 2,
                repeat: Infinity,
                ease: "easeInOut"
            }}
            style={{
                borderColor: isLiveActive ? '#FFD700' : ''
            }}
        >
            {/* Image Section */}
            <div className="relative h-72 bg-brand-dark-light group/image perspective-[1000px]">
                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${isFlipped && hasBackImage ? '[transform:rotateY(180deg)]' : ''}`}>
                    {/* Front Image */}
                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden]">
                        {item.images && item.images.length > 0 ? (
                            <Image
                                src={item.images[0]}
                                alt={item.player_name || 'Card Image'}
                                fill
                                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                                className="object-cover"
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full text-brand-platinum/30">
                                画像なし
                            </div>
                        )}
                        {/* Live Moment Inner Glow */}
                        {isLiveActive && (
                            <div className="absolute inset-0 shadow-[inset_0_0_30px_rgba(255,215,0,0.3)] mix-blend-overlay pointer-events-none" />
                        )}
                    </div>

                    {/* Back Image */}
                    {hasBackImage && (
                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] bg-brand-dark-light">
                            <Image
                                src={item.images[1]}
                                alt={`${item.player_name || ''} Back`}
                                fill
                                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                                className="object-cover"
                            />
                        </div>
                    )}
                </div>

                {/* Flip Button (Manual) */}
                {hasBackImage && !isSold && (
                    <button
                        onClick={handleFlip}
                        className="absolute bottom-3 right-3 z-20 p-2 rounded-full bg-black/60 text-white hover:bg-brand-blue hover:text-white transition-colors backdrop-blur-sm border border-white/10"
                        title="カードを裏返す"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                )}

                {/* SOLD Overlay */}
                {isSold && (
                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-10 [backface-visibility:hidden]">
                        <div className="border-4 border-red-500 text-red-500 font-bold text-3xl px-6 py-2 transform -rotate-12 tracking-widest uppercase">
                            SOLD
                        </div>
                    </div>
                )}

                {/* Badges */}
                <div className="absolute top-3 right-3 flex flex-col gap-2 items-end z-20 [backface-visibility:hidden]">
                    {isLiveActive && (
                        <div className="flex flex-col gap-1.5 items-end">
                            {/* Priority Header for Debug/Global Live */}
                            {isLiveMoment && momentsWithTime.length === 0 && (
                                <div className="px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold tracking-wider rounded shadow-lg shadow-red-600/40 border border-white/20 flex items-center gap-1.5 animate-pulse">
                                    <span className="text-sm">🔥</span>
                                    LIVE
                                    <span className="ml-1 pl-1 border-l border-white/20 font-mono">60:00</span>
                                </div>
                            )}

                            {/* Individual Moment Countdowns */}
                            {momentsWithTime.map((m) => (
                                <div key={m.id} className="px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold tracking-wider rounded shadow-lg shadow-red-600/40 border border-white/20 flex items-center gap-1.5 animate-pulse">
                                    <span className="text-sm">🔥</span>
                                    {m.title || 'LIVE'}
                                    <span className="ml-1 pl-1 border-l border-white/20 font-mono">{m.timeLeft}</span>
                                </div>
                            ))}
                        </div>
                    )}
                    <span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded border border-white/10">
                        {item.year} {item.manufacturer}
                    </span>
                    {item.is_rookie && (
                        <span className="bg-brand-gold text-brand-dark text-xs font-bold px-2 py-1 rounded shadow-lg shadow-brand-gold/20 animate-pulse-slow">
                            RC
                        </span>
                    )}
                </div>
            </div>

            {/* Content Section */}
            <div className="p-5 flex-1 flex flex-col bg-gradient-to-b from-transparent to-black/40">
                <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold tracking-wider uppercase bg-brand-blue/20 text-brand-blue border border-brand-blue/30">
                            {item.team}
                        </span>
                        <MomentHistoryBadge history={item.moment_history} />

                    </div>

                    <h2 className="font-heading text-lg font-bold text-white mb-1 group-hover:text-brand-blue-glow transition-colors truncate">
                        {item.player_name}
                    </h2>
                    <p className="text-xs text-brand-platinum/50 font-mono">
                        {item.variation || item.series_name} {item.card_number ? `#${item.card_number}` : ''}
                    </p>
                </div>

                <div className="mt-auto pt-4 border-t border-brand-platinum/10 grid grid-cols-2 gap-4">
                    <div>
                        <p className="text-[10px] text-brand-platinum/50 uppercase tracking-wider mb-1">価格</p>
                        <div className="flex items-center gap-1.5">
                            <div className="w-4 h-4 rounded-full bg-brand-gold flex items-center justify-center shadow-[0_0_10px_rgba(234,179,8,0.5)]">
                                <span className="text-[10px] text-brand-dark font-bold">¥</span>
                            </div>
                            <p className="font-heading text-lg font-bold text-white group-hover:text-brand-gold transition-colors">
                                {item.price?.toLocaleString() ?? '---'}
                            </p>
                        </div>
                    </div>
                    {!isSold && (
                        <div className="text-right border-l border-brand-platinum/10 pl-4">
                            <p className="text-[10px] text-brand-platinum/50 uppercase tracking-wider mb-1">ステータス</p>
                            <div className="flex items-center justify-end gap-1.5 text-brand-blue-glow">
                                <span className="font-mono text-sm font-medium">出品中</span>
                            </div>
                        </div>
                    )}
                </div>
            </div>



            {/* Hover Glow Effect */}
            <div className="absolute inset-0 border-2 border-brand-blue/0 group-hover:border-brand-blue/50 rounded-xl transition-all duration-300 pointer-events-none"></div>
        </motion.div>
    );

    if (isSold) {
        return (
            <div className="block group cursor-not-allowed opacity-80">
                {cardContent}
            </div>
        );
    }

    return (
        <Link href={`/listings/${item.id}`} className="block group">
            {cardContent}
        </Link>
    );
});

export default CardListing;
</file>

<file path="frontend/components/DevTools.tsx">
'use client';

import { createClient } from '../utils/supabase/client';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

const TEST_ACCOUNTS = [
    { email: 'seller@test.com', password: 'password123', label: 'Seller' },
    { email: 'buyer1@test.com', password: 'password123', label: 'Buyer 1' },
    { email: 'buyer2@test.com', password: 'password123', label: 'Buyer 2' },
];

export default function DevTools() {
    // Only show in dev environment (or via feature flag)
    // In Next.js, process.env.NODE_ENV is reliable.
    // However, sometimes it is 'production' even on staging effectively.
    // We can double check if we are on localhost window side or just assume dev.
    const [isOpen, setIsOpen] = useState(false);
    const [status, setStatus] = useState('');
    const supabase = createClient();
    const router = useRouter();

    if (process.env.NODE_ENV === 'production') return null;

    const handleLogin = async (email: string, pass: string) => {
        setStatus(`Logging in as ${email}...`);
        await supabase.auth.signOut();
        const { error } = await supabase.auth.signInWithPassword({
            email,
            password: pass
        });

        if (error) {
            setStatus('Login Failed: ' + error.message);
        } else {
            setStatus('Logged In! Refresing...');
            router.refresh();
            // Force reload to update server components properly
            window.location.href = '/collection';
        }
    };

    const handleCreateLiveMoment = async () => {
        setStatus('Creating Live Moment...');
        try {
            const res = await fetch('/api/dev/moment', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                setStatus(`Moment Created: ${data.moment.title}`);
                router.refresh();
            } else {
                setStatus('Failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e: any) {
            setStatus('Error: ' + e.message);
        }
    };

    return (
        <div className="fixed bottom-4 right-4 z-[9999] font-sans">
            {!isOpen ? (
                <button
                    onClick={() => setIsOpen(true)}
                    className="bg-purple-600/80 hover:bg-purple-600 text-white p-2 rounded-full shadow-lg border border-white/20 backdrop-blur-md text-xs font-bold"
                >
                    🛠️ DEV
                </button>
            ) : (
                <div className="bg-black/90 text-white p-4 rounded-lg shadow-2xl border border-purple-500/50 w-64 backdrop-blur-xl">
                    <div className="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                        <span className="font-bold text-purple-400 text-xs tracking-widest">DEV TOOLS</span>
                        <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-white">✕</button>
                    </div>

                    <div className="space-y-2">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Quick Login</p>
                        <div className="grid grid-cols-2 gap-2">
                            {TEST_ACCOUNTS.map((acc) => (
                                <button
                                    key={acc.email}
                                    onClick={() => handleLogin(acc.email, acc.password)}
                                    className="px-2 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-xs border border-gray-700 hover:border-purple-500/50 transition-all text-left truncate"
                                    title={acc.email}
                                >
                                    {acc.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="mt-4 pt-4 border-t border-gray-800 space-y-2">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Actions</p>
                        <button
                            onClick={handleCreateLiveMoment}
                            className="w-full py-1.5 bg-blue-900/40 hover:bg-blue-900/60 rounded text-xs border border-blue-500/30 text-blue-200"
                        >
                            + Live Moment (Use Script)
                        </button>
                    </div>

                    {status && (
                        <div className="mt-3 text-[10px] text-yellow-400 bg-yellow-900/20 p-2 rounded border border-yellow-500/20">
                            {status}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/components/Footer.tsx">
import Link from 'next/link';

export default function Footer() {
    return (
        <footer className="bg-brand-dark relative mt-20">
            {/* Top Gradient Line */}
            <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-brand-platinum/20 to-transparent"></div>
            <div className="absolute top-[-1px] left-1/4 right-1/4 h-[1px] bg-gradient-to-r from-transparent via-brand-blue/50 to-transparent blur-sm"></div>

            <div className="py-12 relative z-10">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div className="col-span-1 md:col-span-2">
                            <Link href="/" className="flex items-center gap-2 mb-4">
                                <span className="font-heading text-2xl font-bold tracking-tighter text-white">
                                    BigLuck<span className="text-brand-blue">Stadium</span>
                                </span>
                            </Link>
                            <p className="text-brand-platinum/60 max-w-sm">
                                プロ野球トレーディングカードのプレミアムマーケットプレイス。
                                安心して売買・コレクションをお楽しみください。
                            </p>
                        </div>

                        <div>
                            <h3 className="font-heading font-bold text-white mb-4">マーケット</h3>
                            <ul className="space-y-2">
                                <li><Link href="/" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">出品一覧</Link></li>
                                <li><Link href="/sell" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">出品する</Link></li>
                                <li><Link href="/catalog" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">カードカタログ</Link></li>
                            </ul>
                        </div>

                        <div>
                            <h3 className="font-heading font-bold text-white mb-4">サポート</h3>
                            <ul className="space-y-2">
                                <li><Link href="/help" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">ヘルプセンター</Link></li>
                                <li><Link href="/terms" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">利用規約</Link></li>
                                <li><Link href="/privacy" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">プライバシーポリシー</Link></li>
                            </ul>
                        </div>
                    </div>

                    <div className="mt-12 pt-8 border-t border-brand-platinum/10 text-center text-brand-platinum/40 text-sm">
                        &copy; {new Date().getFullYear()} BigLuckStadium. All rights reserved.
                    </div>
                </div>
            </div>
        </footer>
    );
}
</file>

<file path="frontend/components/Header.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { usePathname, useRouter } from 'next/navigation';
import { createClient } from '../utils/supabase/client';

export default function Header() {
    const [user, setUser] = useState<any>(null);
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const pathname = usePathname();
    const router = useRouter();
    const supabase = createClient();

    useEffect(() => {
        const getUser = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);
        };
        getUser();

        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
    }, []);

    const handleSignOut = async () => {
        await supabase.auth.signOut();
        setUser(null);
        router.push('/');
        router.refresh();
    };

    const NAV_ITEMS = [
        { name: 'マーケット', path: '/market' },
        { name: 'コレクション', path: '/collection' },
        { name: 'オークション', path: '/auctions' },
        { name: 'コミュニティ', path: '/community' },
    ];

    return (
        <header className="fixed top-0 left-0 w-full z-50 p-4 md:p-6 pointer-events-none flex flex-col items-center">
            <div className="pointer-events-auto w-full md:max-w-4xl bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-full px-4 py-3 shadow-2xl flex items-center justify-between">
                {/* Logo */}
                <Link href="/" className="flex items-center gap-2 group">
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-blue to-brand-blue-glow flex items-center justify-center shadow-lg shadow-brand-blue/20 group-hover:shadow-brand-blue/40 transition-all">
                        <span className="font-heading font-bold text-white text-sm">BLS</span>
                    </div>
                    <span className="font-heading font-bold text-lg text-white tracking-tight hidden md:block">
                        BigLuckStadium
                    </span>
                </Link>

                {/* Desktop Navigation */}
                <nav className="hidden md:flex items-center gap-1">
                    {NAV_ITEMS.map((item) => (
                        <Link
                            key={item.name}
                            href={item.path}
                            className={`px-4 py-2 rounded-full text-xs font-bold tracking-widest transition-all ${pathname === item.path
                                ? 'bg-brand-blue/20 text-brand-blue border border-brand-blue/20 shadow-[0_0_10px_rgba(59,130,246,0.2)]'
                                : 'text-brand-platinum/60 hover:text-white hover:bg-white/5'
                                }`}
                        >
                            {item.name}
                        </Link>
                    ))}
                </nav>

                {/* Actions */}
                <div className="flex items-center gap-3">
                    {user && (
                        <Link
                            href="/sell"
                            className="hidden md:flex items-center gap-2 px-4 py-2 bg-brand-gold text-brand-dark rounded-full text-xs font-bold hover:bg-white transition-colors shadow-lg shadow-brand-gold/20"
                        >
                            <span>出品する</span>
                        </Link>
                    )}

                    {/* User Profile (Desktop Only) */}
                    <div className="relative group hidden md:block">
                        <button
                            className="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center transition-all"
                        >
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-platinum to-brand-platinum/50 overflow-hidden relative">
                                <Image
                                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user?.email || 'Guest'}`}
                                    alt="User"
                                    fill
                                    className="object-cover"
                                />
                            </div>
                        </button>

                        {/* Dropdown Menu (Desktop) */}
                        <div className="absolute top-full right-0 mt-2 w-48 bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                            <div className="p-2 space-y-1">
                                {user ? (
                                    <>
                                        <div className="px-3 py-2 text-xs text-brand-platinum/60 border-b border-white/5 mb-1">
                                            ログイン中:<br />
                                            <span className="text-white font-bold truncate block">{user.email}</span>
                                        </div>
                                        <Link href="/profile" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                            マイページ
                                        </Link>
                                        <Link href="/collection" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                            マイコレクション
                                        </Link>
                                        <Link href="/payouts" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
                                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
                                                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
                                            </svg>
                                            売上・振込
                                        </Link>

                                        {/* Admin Link (Only for authorized emails) */}
                                        {(() => {
                                            const adminEmails = (process.env.NEXT_PUBLIC_ADMIN_EMAILS || '').split(',').map(e => e.trim().toLowerCase());
                                            if (user?.email && adminEmails.includes(user.email.toLowerCase())) {
                                                return (
                                                    <Link href="/admin" className="block px-3 py-2 rounded-lg bg-brand-gold/10 text-brand-gold hover:bg-brand-gold/20 text-xs font-bold transition-colors mt-2 text-center border border-brand-gold/20">
                                                        管理画面
                                                    </Link>
                                                );
                                            }
                                            return null;
                                        })()}
                                        <button
                                            onClick={handleSignOut}
                                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-red-500/10 text-sm text-red-400 hover:text-red-300 transition-colors"
                                        >
                                            ログアウト
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <>
                                            <Link href="/login" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                                ログイン
                                            </Link>
                                            <Link href="/register" className="block px-3 py-2 rounded-lg hover:bg-brand-blue/10 text-sm text-brand-blue hover:text-brand-blue-glow transition-colors">
                                                新規登録
                                            </Link>
                                        </>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Mobile Menu Toggle (Visible on Mobile only) */}
                    <button
                        onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                        className="md:hidden w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center transition-all bg-brand-dark text-white"
                        aria-label="Menu"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {isMobileMenuOpen ? (
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            ) : (
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" />
                            )}
                        </svg>
                    </button>
                </div>
            </div>

            {/* Mobile Menu Overlay */}
            {isMobileMenuOpen && (
                <div className="pointer-events-auto w-full md:max-w-4xl mt-2 bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl md:hidden flex flex-col gap-2 animate-fade-in-up">
                    {NAV_ITEMS.map((item) => (
                        <Link
                            key={item.name}
                            href={item.path}
                            onClick={() => setIsMobileMenuOpen(false)}
                            className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm"
                        >
                            {item.name}
                        </Link>
                    ))}
                    {user && (
                        <>
                            <Link href="/profile" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm">マイページ</Link>
                            <Link href="/payouts" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm">売上・振込設定</Link>
                            <Link href="/sell" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl bg-brand-gold/10 text-brand-gold font-bold text-sm text-center border border-brand-gold/20">出品する</Link>
                        </>
                    )}
                    {user ? (
                        <button onClick={() => { handleSignOut(); setIsMobileMenuOpen(false); }} className="p-3 rounded-xl bg-red-500/10 text-red-400 font-bold text-sm text-center border border-red-500/20 mt-2">ログアウト</button>
                    ) : (
                        <Link href="/login" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl bg-brand-blue/10 text-brand-blue font-bold text-sm text-center border border-brand-blue/20 mt-2">ログイン</Link>
                    )}
                </div>
            )}
        </header>
    );
}
</file>

<file path="frontend/components/HeroSection.tsx">
'use client';

import Link from 'next/link';
import { useEffect, useState } from 'react';
import { ListingItem } from '../types';

import { createClient } from '../utils/supabase/client';

export default function HeroSection() {
    const [user, setUser] = useState<any>(null);
    const [featuredCard, setFeaturedCard] = useState<ListingItem | null>(null);

    useEffect(() => {
        const fetchFeaturedAndUser = async () => {
            const supabase = createClient();

            // Fetch User
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            // Fetch Featured Card
            try {
                const { data, error } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('status', 'Active')
                    .not('price', 'is', null)
                    .order('price', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    setFeaturedCard(data[0] as any);
                }
            } catch (error) {
                console.error("Failed to fetch featured card:", error);
            }
        };
        fetchFeaturedAndUser();
    }, []);

    return (
        <section className="relative w-full min-h-[90vh] flex flex-col items-center justify-center bg-brand-dark pt-32 pb-48">
            {/* Spotlight Effects */}
            <div className="absolute inset-0 z-0 pointer-events-none">
                {/* Main Top Spotlight */}
                <div className="absolute top-[-20%] left-1/2 -translate-x-1/2 w-[800px] h-[800px] bg-brand-gold/20 rounded-full blur-[100px] opacity-60 animate-pulse-slow"></div>
                {/* Side Blue Glows */}
                <div className="absolute top-[20%] left-[-10%] w-[600px] h-[600px] bg-brand-blue/10 rounded-full blur-[120px]"></div>
                <div className="absolute top-[20%] right-[-10%] w-[600px] h-[600px] bg-brand-blue/10 rounded-full blur-[120px]"></div>
                {/* Grid Pattern */}
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-20 bg-center"></div>
            </div>

            {/* Floating Card Display */}
            <div className="relative z-10 mb-12 animate-float">
                <div className="relative w-64 h-96 md:w-80 md:h-[500px] rounded-2xl p-2 bg-gradient-to-b from-brand-platinum/20 to-brand-dark-light/80 backdrop-blur-md border border-brand-platinum/30 shadow-[0_0_50px_rgba(59,130,246,0.3)]">
                    {/* Spotlight Beam */}
                    <div className="absolute -top-[150%] left-1/2 -translate-x-1/2 w-[100px] h-[500px] bg-gradient-to-b from-white/20 via-brand-gold/10 to-transparent blur-xl rotate-[15deg] transform-origin-top animate-pulse-slow pointer-events-none z-20"></div>

                    {/* Inner Card Frame */}
                    <div className="w-full h-full rounded-xl overflow-hidden relative border border-brand-blue/30 bg-brand-dark-light group cursor-pointer">
                        {featuredCard ? (
                            <Link href={`/listings/${featuredCard.id}`}>
                                {/* Card Image */}
                                <div className="absolute inset-0 bg-gradient-to-br from-brand-dark-light to-brand-blue/20 flex items-center justify-center">
                                    {!featuredCard.images?.[0] && <span className="text-brand-platinum/20 font-heading text-6xl font-bold">TC</span>}
                                </div>
                                {featuredCard.images?.[0] && (
                                    <img
                                        src={featuredCard.images[0]}
                                        alt={featuredCard.player_name || 'Card Image'}
                                        className="w-full h-full object-cover opacity-90 transition-opacity group-hover:opacity-100"
                                    />
                                )}

                                {/* Holo Effect Overlay */}
                                <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50 group-hover:opacity-70 transition-opacity"></div>

                                {/* Shimmer Effect */}
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer pointer-events-none"></div>

                                {/* Card Details Overlay */}
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <p className="text-brand-gold text-xs font-bold tracking-widest mb-1 uppercase">
                                                {'注目'}
                                            </p>
                                            <h3 className="text-white font-heading text-xl font-bold leading-tight">
                                                {featuredCard.player_name || '選手名不明'}
                                            </h3>
                                            <p className="text-brand-platinum/80 text-xs mt-1">
                                                {featuredCard.year || ''} {featuredCard.manufacturer || ''}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-brand-gold text-gold-glow text-lg font-bold">
                                                ¥{featuredCard.price?.toLocaleString() ?? '---'}
                                            </p>
                                            {featuredCard.condition_grading?.is_graded && (
                                                <p className="text-brand-platinum/60 text-[10px] uppercase">
                                                    {featuredCard.condition_grading.service} {featuredCard.condition_grading.score}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </Link>
                        ) : (
                            // Loading / Placeholder State
                            <div className="w-full h-full flex items-center justify-center bg-brand-dark-light">
                                <div className="animate-pulse flex flex-col items-center">
                                    <div className="h-12 w-12 border-2 border-brand-blue border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <p className="text-brand-platinum/50 text-sm">読み込み中...</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Outer Glow Ring */}
                    <div className="absolute -inset-4 border border-brand-blue/20 rounded-3xl -z-10 animate-pulse-slow"></div>
                    <div className="absolute -inset-1 bg-gradient-to-b from-brand-gold/20 to-transparent rounded-2xl -z-10 blur-md"></div>
                    {/* Rotating Glow */}
                    <div className="absolute -inset-[100%] bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,215,0,0.1)_90deg,transparent_180deg)] rounded-full animate-rotate-slow -z-20 opacity-50 blur-2xl"></div>
                </div>
            </div>

            <div className="relative z-10 container mx-auto px-4 text-center">
                <h1 className="font-heading text-5xl md:text-7xl font-bold mb-4 tracking-tight animate-fade-in-up">
                    <span className="text-brand-gold drop-shadow-[0_0_15px_rgba(234,179,8,0.3)]">THE FUTURE OF TRADING.</span><br />
                    <span className="text-brand-blue drop-shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                        COLLECT THE UNTOUCHABLE.
                    </span>
                </h1>

                <p className="text-brand-platinum/80 text-lg md:text-xl mb-10 max-w-2xl mx-auto animate-fade-in-up delay-200">
                    次世代のトレーディングカード体験を。
                    真贋証明、取引、コレクション展示をプレミアムなプラットフォームで。
                </p>

                <div className="flex flex-col md:flex-row gap-6 justify-center">
                    {user ? (
                        <Link
                            href="/market"
                            className="group relative px-8 py-4 bg-brand-blue text-white font-bold rounded-full overflow-hidden transition-all hover:scale-105 shadow-[0_0_20px_rgba(59,130,246,0.5)]"
                        >
                            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                            <span className="relative z-10">マーケットを見る</span>
                        </Link>
                    ) : (
                        <>
                            <Link
                                href="/register"
                                className="group relative px-8 py-4 bg-brand-gold text-brand-dark font-bold rounded-full overflow-hidden transition-all hover:scale-105 shadow-[0_0_20px_rgba(234,179,8,0.3)]"
                            >
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                                <span className="relative z-10">無料で始める</span>
                            </Link>
                            <Link
                                href="/login"
                                className="px-8 py-4 bg-white/5 text-white font-bold rounded-full border border-white/10 hover:bg-white/10 transition-all hover:scale-105 backdrop-blur-md"
                            >
                                ログイン
                            </Link>
                        </>
                    )}
                </div>
            </div>
        </section>
    );
}
</file>

<file path="frontend/components/LiveMomentListener.tsx">
"use client";

import { useEffect, useState } from "react";
import { createBrowserClient } from "@supabase/ssr";
import LiveMomentToast, { LiveMomentData } from "./LiveMomentToast";

export default function LiveMomentListener() {
    const [moment, setMoment] = useState<LiveMomentData | null>(null);

    // Initialize Supabase Client (Stable outside effect if possible, or memoized)
    // For simplicity and stability in App Router, we can initialize it once
    const [supabase] = useState(() => createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key'
    ));

    useEffect(() => {
        // Subscribe to INSERT events on 'live_moments' table
        const channel = supabase
            .channel("live-moments-channel")
            .on(
                "postgres_changes",
                {
                    event: "INSERT",
                    schema: "public",
                    table: "live_moments",
                },
                (payload) => {
                    const newMoment = payload.new as LiveMomentData;

                    // Trigger Toast
                    setMoment(newMoment);

                    // Auto-hide after 8 seconds (longer for reading)
                    setTimeout(() => {
                        setMoment(null);
                    }, 8000);
                }
            )
            .subscribe();

        // Cleanup subscription
        return () => {
            supabase.removeChannel(channel);
        };
    }, [supabase]);

    return (
        <LiveMomentToast
            data={moment}
            onDismiss={() => setMoment(null)}
        />
    );
}
</file>

<file path="frontend/components/LiveMomentToast.tsx">
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import { AnimatePresence, motion } from "framer-motion";

export type LiveMomentData = {
    id: string;
    player_name: string;
    type: "HOMERUN" | "BIG_PLAY" | "VICTORY" | "RECORD_BREAK" | "system_notice";
    title: string;
    description?: string;
    intensity: number; // 1-5
};

interface LiveMomentToastProps {
    data: LiveMomentData | null;
    onDismiss: () => void;
}

export default function LiveMomentToast({ data, onDismiss }: LiveMomentToastProps) {
    const router = useRouter();

    if (!data) return null;

    // Determine colors based on intensity/type
    // User Request: Make ALL notifications Gold (Premium Look)
    const isGold = true;

    // Base styles
    const containerClasses = isGold
        ? "bg-gradient-to-r from-brand-gold/90 to-brand-gold-glow/90 border-brand-gold text-brand-dark"
        : "bg-brand-dark-light/95 border-brand-blue/30 text-white backdrop-blur-xl";

    const handleClick = () => {
        router.push(`/market?search=${encodeURIComponent(data.player_name)}&sort=newest`);
        onDismiss();
    };

    return (
        <AnimatePresence>
            <div className="fixed top-24 right-4 md:right-8 z-[100] w-full max-w-sm pointer-events-none">
                <motion.div
                    initial={{ opacity: 0, y: -50, scale: 0.9 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, x: 100, scale: 0.9 }}
                    transition={{ type: "spring", stiffness: 300, damping: 25 }}
                    onClick={handleClick}
                    className={`
                        pointer-events-auto p-4 rounded-xl border shadow-2xl overflow-hidden relative cursor-pointer group
                        ${containerClasses}
                        hover:scale-105 transition-transform duration-300
                    `}
                >
                    {/* Intensity Particles/Glow (Simplified CSS) */}
                    {isGold && (
                        <div className="absolute inset-0 bg-[url('/noise.png')] opacity-10 mix-blend-overlay" />
                    )}
                    {data.intensity === 5 && (
                        <div className="absolute inset-0 animate-pulse bg-brand-gold/20 z-0" />
                    )}

                    <div className="relative z-10 flex flex-col gap-1">
                        <div className="flex items-center justify-between">
                            <span className={`text-[10px] font-bold tracking-widest uppercase px-2 py-0.5 rounded-full border ${isGold ? 'border-brand-dark/20 bg-brand-dark/10' : 'border-white/10 bg-white/5'}`}>
                                {data.type.replace('_', ' ')}
                            </span>
                            <button
                                onClick={(e) => { e.stopPropagation(); onDismiss(); }}
                                className="opacity-60 hover:opacity-100 p-1"
                            >
                                ×
                            </button>
                        </div>

                        <h4 className={`font-heading font-bold text-lg leading-tight mt-1 ${isGold ? 'text-brand-dark' : 'text-white'}`}>
                            {data.title}
                        </h4>

                        <p className={`text-sm font-bold opacity-80 ${isGold ? 'text-brand-dark' : 'text-brand-platinum'}`}>
                            {data.player_name}
                        </p>

                        {data.description && (
                            <p className={`text-xs mt-1 leading-relaxed ${isGold ? 'text-brand-dark/80' : 'text-brand-platinum/60'}`}>
                                {data.description}
                            </p>
                        )}

                        {/* CTA Button */}
                        <div className="mt-3 flex justify-end">
                            <span className={`text-[10px] font-bold uppercase tracking-wider flex items-center gap-1 ${isGold ? 'text-brand-dark group-hover:underline' : 'text-white'}`}>
                                カードを見る
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                            </span>
                        </div>
                    </div>
                </motion.div>
            </div>
        </AnimatePresence>
    );
}
</file>

<file path="frontend/components/MarketPriceLinks.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Search, ExternalLink, ShoppingBag, Gavel, Globe } from 'lucide-react';

interface MarketPriceLinksProps {
    initialQuery: string;
}

export default function MarketPriceLinks({ initialQuery }: MarketPriceLinksProps) {
    const [query, setQuery] = useState(initialQuery);

    // Sync state if prop changes (e.g. AI re-analyzes)
    useEffect(() => {
        setQuery(initialQuery);
    }, [initialQuery]);

    const openSearch = (urlTemplate: string) => {
        if (!query.trim()) return;
        const encodedQuery = encodeURIComponent(query.trim());
        const url = urlTemplate.replace('{encodedQuery}', encodedQuery);
        window.open(url, '_blank', 'noopener,noreferrer');
    };

    return (
        <div className="glass-panel p-4 rounded-xl border border-white/10 animate-fade-in-up">
            <div className="flex flex-col gap-3">
                <div className="flex justify-between items-center">
                    <label className="text-sm font-bold text-brand-platinum flex items-center gap-2">
                        <Search className="w-4 h-4" />
                        相場をチェック (参考)
                    </label>
                </div>

                {/* Editable Query Input */}
                <div className="relative">
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-brand-blue/50 transition-colors"
                        placeholder="キーワードを入力 (例: 大谷翔平 2024)"
                    />
                    <div className="absolute right-3 top-2.5 pointer-events-none">
                        <span className="text-xs text-brand-platinum/50">キーワードを編集</span>
                    </div>
                </div>

                {/* Market Buttons */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-1">
                    {/* Mercari */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://jp.mercari.com/search?keyword={encodedQuery}&status=sold_out_processing,sold_out')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all text-sm font-medium group"
                    >
                        <ShoppingBag className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>Mercari</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>

                    {/* Yahoo Auction */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://auctions.yahoo.co.jp/search/search?p={encodedQuery}&aucmaxprice=999999999&istatus=2')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500/20 transition-all text-sm font-medium group"
                    >
                        <Gavel className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>Yahoo!</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>

                    {/* eBay */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://www.ebay.com/sch/i.html?_nkw={encodedQuery}&LH_Sold=1')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 transition-all text-sm font-medium group"
                    >
                        <Globe className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>eBay</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/MomentHistoryBadge.tsx">
import React from 'react';

interface MomentHistoryBadgeProps {
    history?: any[];
    liveCount?: number;
}

export default function MomentHistoryBadge({ history, liveCount = 0 }: MomentHistoryBadgeProps) {
    const historyCount = history?.length || 0;
    const total = historyCount + liveCount;

    if (total === 0) return null;

    return (
        <div className="bg-orange-500/90 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-orange-300 shadow-sm backdrop-blur-sm">
            <span className="text-[10px]">🏆</span>
            <span>{total} Moments</span>
        </div>
    );
}
</file>

<file path="frontend/components/MomentHistoryPanel.tsx">
import { addMomentMemory, editMomentMemory, deleteMomentMemory, toggleHideMoment, toggleHideMomentMemory } from '../app/actions/item';
import { createClient } from '../utils/supabase/client';
import { useEffect, useState } from 'react';

interface MomentHistoryPanelProps {
    history?: any[];
    itemId?: string;
    isOwner?: boolean;
    onSuccess?: () => void;
}

export default function MomentHistoryPanel({ history, itemId, isOwner, onSuccess }: MomentHistoryPanelProps) {
    // State for managing the modal
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [targetMomentIndex, setTargetMomentIndex] = useState<number | null>(null);
    const [targetMomentId, setTargetMomentId] = useState<string | undefined>(undefined);

    // If editing an existing memory
    const [editingMemoryId, setEditingMemoryId] = useState<string | null>(null);

    const [noteContent, setNoteContent] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [currentUser, setCurrentUser] = useState<any>(null);
    const [expandedMemoryIds, setExpandedMemoryIds] = useState<string[]>([]);

    const togglePeek = (memoryId: string) => {
        setExpandedMemoryIds(prev =>
            prev.includes(memoryId)
                ? prev.filter(id => id !== memoryId)
                : [...prev, memoryId]
        );
    };

    useEffect(() => {
        const fetchUser = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setCurrentUser(user);
        };
        fetchUser();
    }, []);

    if (!history || !Array.isArray(history) || history.length === 0) return null;

    // --- Actions ---

    const openAddModal = (index: number, moment: any) => {
        if (!itemId) {
            alert('購入者情報を同期中です。1分ほどお待ちください。 (Possession syncing...)');
            return;
        }
        setTargetMomentIndex(index);
        setTargetMomentId(moment.moment_id);
        setEditingMemoryId(null); // Adding new
        setNoteContent('');
        setIsModalOpen(true);
    };

    const openEditModal = (index: number, moment: any, memory: any) => {
        if (!itemId) return;
        setTargetMomentIndex(index);
        setTargetMomentId(moment.moment_id);
        setEditingMemoryId(memory.id);
        setNoteContent(memory.text || '');
        setIsModalOpen(true);
    };

    const handleSave = async () => {
        if (!itemId || targetMomentIndex === null) return;

        setIsSubmitting(true);
        try {
            // Note: history is displayed reversed, so we need original index if using array index
            // But we prefer momentId if available. Let's pass array index as fallback.
            // Re-calculate original index from the displayed index (which comes from the mapped reversed slice?)
            // Wait, the map below uses `history.slice().reverse().map(...)`.
            // So `index` passed here is the Display Index.
            // Original Index = (Length - 1) - Display Index.
            const originalIndex = history.length - 1 - targetMomentIndex;

            if (editingMemoryId) {
                await editMomentMemory(itemId, originalIndex, editingMemoryId, noteContent, targetMomentId);
            } else {
                await addMomentMemory(itemId, originalIndex, noteContent, targetMomentId);
            }

            setIsModalOpen(false);
            if (onSuccess) onSuccess();
        } catch (error: any) {
            alert(error.message || 'Failed to save note');
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleDelete = async (displayIndex: number, moment: any, memoryId: string) => {
        if (!itemId) return;

        const originalIndex = history.length - 1 - displayIndex;
        const memory = moment.memories?.find((m: any) => m.id === memoryId);
        if (!memory) return;

        if (!confirm("このメッセージを完全に消去しますか？ この操作は取り消せません。")) return;

        try {
            await deleteMomentMemory(itemId, originalIndex, memoryId, moment.moment_id);
            if (onSuccess) onSuccess();
        } catch (err: any) { alert(err.message); }
    };

    const handleToggleHide = async (displayIndex: number, moment: any, memoryId: string) => {
        if (!itemId) return;
        const originalIndex = history.length - 1 - displayIndex;
        try {
            await toggleHideMomentMemory(itemId, originalIndex, memoryId, moment.moment_id);
            if (onSuccess) onSuccess();
        } catch (err: any) {
            alert(err.message);
        }
    };

    return (
        <div className="border-t border-brand-platinum/10 py-8">
            <div className="flex items-center justify-between mb-6">
                <h3 className="text-xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-gold via-white to-brand-gold animate-shimmer bg-[length:200%_100%] uppercase tracking-widest flex items-center gap-3">
                    <span className="text-2xl">⚡</span>
                    Legendary History / 伝説の記録
                </h3>
                <div className="px-4 py-1.5 rounded-full bg-gradient-to-r from-orange-500 to-red-600 text-white text-xs font-bold uppercase tracking-wider flex items-center gap-2 shadow-[0_0_15px_rgba(234,88,12,0.4)] border border-white/20">
                    <span>🏆</span>
                    {history.length} Moments
                </div>
            </div>

            <div className="space-y-6">
                {history.slice().reverse().map((moment: any, index: number) => (
                    <div
                        key={index}
                        className="relative overflow-hidden rounded-xl bg-gradient-to-br from-gray-900 via-black to-gray-800 border border-amber-400/30 p-1 group hover:border-amber-400/60 transition-all duration-500 hover:shadow-[0_0_20px_rgba(251,191,36,0.15)]"
                    >
                        {/* Background Effects */}
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20 pointer-events-none mix-blend-overlay"></div>
                        <div className="absolute -right-20 -top-20 w-64 h-64 bg-amber-500/10 rounded-full blur-[80px] group-hover:bg-amber-500/20 transition-colors duration-500"></div>

                        <div className="relative bg-black/40 backdrop-blur-sm rounded-lg p-5 md:p-6 flex flex-col md:flex-row gap-6 items-start md:items-center">

                            {/* Icon / Intensity Badge */}
                            <div className="flex-shrink-0">
                                <div className="w-16 h-16 rounded-xl bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center shadow-lg border border-white/20 transform group-hover:scale-105 transition-transform duration-300">
                                    <div className="text-3xl filter drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]">
                                        {moment.intensity >= 90 ? '🔥' : '⚾'}
                                    </div>
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="flex-1 w-full">
                                <div className="flex flex-wrap items-center justify-between gap-2 mb-2">
                                    <span className="text-xs font-mono text-amber-500/80 tracking-widest uppercase flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
                                        {new Date(moment.timestamp).toLocaleDateString()}
                                    </span>

                                    <div className="flex items-center gap-2">
                                        {/* Status Badge */}
                                        {(() => {
                                            const now = new Date().getTime();
                                            const momentTime = new Date(moment.timestamp).getTime();
                                            const isRecent = now - momentTime < 60 * 60 * 1000;
                                            const isFinalized = moment.status === 'finalized';

                                            if (isFinalized) {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/10 text-green-400 border border-green-500/20 uppercase">Match End</span>;
                                            } else if (isRecent) {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-red-500/20 text-red-500 border border-red-500/30 animate-pulse uppercase flex items-center gap-1"><span className="w-1.5 h-1.5 bg-red-500 rounded-full"></span>Live</span>;
                                            } else {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500/10 text-orange-400 border border-orange-500/20 uppercase">Live End</span>;
                                            }
                                        })()}
                                    </div>
                                </div>

                                <h4 className="text-xl md:text-2xl font-bold text-white mb-2 group-hover:text-amber-400 transition-colors duration-300">
                                    {moment.title}
                                </h4>

                                <p className="text-sm text-gray-300 mb-3 leading-relaxed">
                                    {moment.description}
                                </p>

                                {/* ---------------- Memories Section ---------------- */}
                                <div className="mt-6 space-y-4">

                                    {/* Legacy Note Support */}
                                    {moment.user_note && (
                                        <div className="p-3 rounded-lg bg-white/5 border border-white/10 relative group/note">
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] text-brand-gold uppercase tracking-wider font-bold">Previous Note</span>
                                                <span className="text-[10px] text-gray-500">{new Date(moment.note_updated_at || moment.timestamp).toLocaleDateString()}</span>
                                            </div>
                                            <p className="text-sm text-gray-300 italic font-serif leading-relaxed">"{moment.user_note}"</p>
                                        </div>
                                    )}

                                    {/* New Memories Array */}
                                    {moment.memories && Array.isArray(moment.memories) && moment.memories.map((memory: any) => {
                                        const isAuthor = currentUser?.id === memory.author_id;
                                        const canManage = isAuthor || isOwner;

                                        // New Visibility Logic:
                                        // 1. If visible -> Show to everyone
                                        // 2. If hidden -> Show placeholder to everyone, show content ONLY to Owner, Author, OR if the user is "peeking"
                                        const isPeeking = expandedMemoryIds.includes(memory.id);
                                        const showContent = !memory.is_hidden || canManage || isPeeking;

                                        return (
                                            <div key={memory.id} className={`rounded-xl border relative group/mem transition-all duration-300 ${memory.is_hidden ? 'p-2 bg-black/40 border-white/5 opacity-50' : 'p-4 bg-brand-gold/5 border-brand-gold/20'}`}>
                                                {/* Header / Info Line */}
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-6 h-6 rounded-full bg-gradient-to-br from-gray-700 to-black border border-white/20 flex items-center justify-center text-[10px] font-bold text-white">
                                                            {memory.author_name ? memory.author_name[0] : 'U'}
                                                        </div>
                                                        <span className="text-xs text-brand-platinum font-bold">{memory.author_name}</span>
                                                        {memory.is_hidden && (
                                                            <span className="text-[10px] text-gray-500 font-mono italic">
                                                                (Private History - Hidden)
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-[10px] text-brand-platinum/40 font-mono">
                                                            {new Date(memory.created_at).toLocaleDateString()}
                                                        </span>
                                                        {/* Inline Actions for Hidden state (Unhide - Owner/Author only) */}
                                                        {memory.is_hidden && canManage && (
                                                            <button
                                                                onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                className="text-[10px] uppercase font-bold text-brand-gold hover:underline"
                                                            >
                                                                Unhide
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Body */}
                                                <div className="mt-2 animate-fade-in text-left">
                                                    {(showContent && !memory.is_hidden) || (isPeeking) ? (
                                                        <>
                                                            <p className={`text-sm italic font-serif leading-relaxed pl-2 border-l-2 ${memory.is_hidden ? 'text-gray-500 border-gray-700 font-sans' : 'text-brand-gold/90 border-brand-gold/30'}`}>
                                                                {memory.text}
                                                            </p>
                                                            {/* Actions for visible/owner/author context */}
                                                            <div className="flex gap-2 justify-end mt-2 opacity-0 group-hover/mem:opacity-100 transition-opacity">
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => openEditModal(index, moment, memory)}
                                                                        className="text-[10px] uppercase font-bold text-brand-gold hover:underline"
                                                                    >
                                                                        Edit
                                                                    </button>
                                                                )}
                                                                {canManage && (
                                                                    <button
                                                                        onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-brand-platinum/60 hover:text-white hover:underline"
                                                                    >
                                                                        {memory.is_hidden ? 'Unhide' : 'Hide'}
                                                                    </button>
                                                                )}
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => handleDelete(index, moment, memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-red-500/60 hover:text-red-400 hover:underline"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                )}
                                                                {/* Close Peek button */}
                                                                {isPeeking && (
                                                                    <button
                                                                        onClick={() => togglePeek(memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-gray-500 hover:underline"
                                                                    >
                                                                        Close
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div className="flex items-center justify-between pl-2 border-l border-white/10">
                                                            <p className="text-[10px] text-brand-platinum/20 italic">
                                                                想い出の内容は非表示に設定されています。
                                                            </p>
                                                            <div className="flex gap-3">
                                                                {canManage && (
                                                                    <button
                                                                        onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                        className="text-[10px] text-brand-gold/60 hover:text-brand-gold font-bold uppercase tracking-wider"
                                                                    >
                                                                        Unhide
                                                                    </button>
                                                                )}
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => handleDelete(index, moment, memory.id)}
                                                                        className="text-[10px] text-red-500/40 hover:text-red-500 font-bold uppercase tracking-wider"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={() => togglePeek(memory.id)}
                                                                    className="text-[10px] text-brand-gold/60 hover:text-brand-gold font-bold uppercase tracking-wider"
                                                                >
                                                                    内容を確認する (Peek)
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {/* Add Button */}
                                    {isOwner && !moment.is_virtual && (
                                        <button
                                            onClick={() => openAddModal(index, moment)}
                                            className="w-full py-2 rounded-lg border border-dashed border-white/20 text-white/40 text-xs hover:bg-white/5 hover:text-brand-gold hover:border-brand-gold/30 transition-all flex items-center justify-center gap-2"
                                        >
                                            <span>✍️</span> 想い出を記録する
                                        </button>
                                    )}
                                    {isOwner && moment.is_virtual && (
                                        <div className="w-full py-2 rounded-lg border border-dashed border-white/10 text-brand-platinum/20 text-[10px] text-center italic select-none">
                                            ※所有者に関連付けられていないため記録できません
                                        </div>
                                    )}
                                </div>

                                {/* Match Result */}
                                {moment.match_result && (
                                    <div className="inline-flex items-center gap-3 bg-white/5 border border-white/10 rounded-lg px-4 py-2 mt-4">
                                        <span className="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Result</span>
                                        <span className="text-sm font-mono font-bold text-amber-300 tracking-wide">
                                            {moment.match_result}
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl animate-fade-in">
                    <div className="glass-panel-premium border border-brand-gold/30 rounded-2xl w-full max-w-md p-6 shadow-2xl relative overflow-hidden">
                        <div className="absolute -top-24 -right-24 w-48 h-48 bg-brand-gold/20 rounded-full blur-[60px]"></div>
                        <h2 className="text-xl font-heading font-bold text-white mb-2 flex items-center gap-2">
                            <span className="text-brand-gold">✍️</span> {editingMemoryId ? 'Edit Memory' : 'New Memory'}
                        </h2>
                        <p className="text-xs text-brand-platinum/50 mb-6 uppercase tracking-widest">この瞬間の想い出をカードに刻む</p>

                        <div className="relative">
                            <textarea
                                value={noteContent}
                                onChange={(e) => setNoteContent(e.target.value.substring(0, 140))}
                                className="w-full bg-black/40 border border-white/10 rounded-xl p-4 text-white text-sm focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all min-h-[120px] placeholder:text-white/20 font-serif italic"
                                placeholder="例: 現地で観戦していました！一生の宝物にします。"
                            />
                            <div className="absolute bottom-3 right-3 text-[10px] font-mono text-white/30">
                                {noteContent.length}/140
                            </div>
                        </div>

                        <div className="flex gap-3 mt-8">
                            <button
                                onClick={() => setIsModalOpen(false)}
                                className="flex-1 py-3 rounded-xl border border-white/10 text-white font-bold text-sm hover:bg-white/5 transition-colors"
                            >
                                CANCEL
                            </button>
                            <button
                                onClick={handleSave}
                                disabled={isSubmitting}
                                className="flex-1 py-3 rounded-xl bg-gradient-to-r from-brand-gold to-orange-500 text-brand-dark font-bold text-sm hover:scale-[1.02] active:scale-[0.98] transition-all shadow-lg shadow-brand-gold/20 disabled:opacity-50"
                            >
                                {isSubmitting ? 'SAVING...' : 'SAVE MEMORY'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <div className="mt-4 text-center">
                <p className="text-[10px] text-gray-600 uppercase tracking-[0.2em] font-light">
                    Verified by Stadium Card Chain
                </p>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/OrderHistory.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { getSellerOrders, getBuyerOrders } from '../app/actions/order';

export default function OrderHistory({ mode }: { mode: 'buy' | 'sell' }) {
    const [orders, setOrders] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchOrders = async () => {
            try {
                const data = mode === 'sell' ? await getSellerOrders() : await getBuyerOrders();
                setOrders(data);
            } catch (error) {
                console.error('Failed to fetch orders', error);
            } finally {
                setLoading(false);
            }
        };
        fetchOrders();
    }, [mode]);

    if (loading) {
        return (
            <div className="flex justify-center p-8">
                <div className="w-6 h-6 border-2 border-brand-blue border-t-transparent rounded-full animate-spin"></div>
            </div>
        );
    }

    if (orders.length === 0) {
        return (
            <div className="p-8 text-center border border-white/5 rounded-2xl bg-white/5">
                <p className="text-brand-platinum/60">
                    {mode === 'sell' ? 'You have no sales yet.' : 'You have no purchases yet.'}
                </p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {orders.map((order) => (
                <Link
                    key={order.id}
                    href={`/orders/${mode}/${order.id}`}
                    className="block group relative overflow-hidden rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all p-4"
                >
                    <div className="flex gap-4 items-center">
                        {/* Image */}
                        <div className="w-16 h-20 bg-black/20 rounded-lg overflow-hidden flex-shrink-0">
                            {order.listing?.images?.[0] ? (
                                <img
                                    src={order.listing.images[0]}
                                    alt={order.listing.title}
                                    className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center text-2xl">🃏</div>
                            )}
                        </div>

                        {/* Details */}
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-1">
                                <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full border ${getStatusStyle(order.status)}`}>
                                    {order.status.replace('_', ' ')}
                                </span>
                                <span className="text-xs text-brand-platinum/60 font-mono">
                                    {new Date(order.created_at).toLocaleDateString()}
                                </span>
                            </div>
                            <h3 className="font-bold text-white truncate text-sm mb-0.5">
                                {order.listing?.player_name || order.listing?.series_name || 'Unknown Item'}
                            </h3>
                            <p className="text-xs text-brand-platinum/60 truncate">
                                {order.listing?.title}
                            </p>
                            <div className="mt-2 text-brand-gold font-mono text-sm font-bold">
                                ¥{(order.total_amount || 0).toLocaleString()}
                            </div>
                        </div>

                        {/* Arrow */}
                        <div className="text-brand-platinum/20 group-hover:text-white transition-colors">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </div>
                </Link>
            ))}
        </div>
    );
}

function getStatusStyle(status: string) {
    switch (status) {
        case 'paid':
        case 'awaiting_shipping':
            return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
        case 'shipped':
            return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
        case 'completed':
            return 'bg-green-500/20 text-green-400 border-green-500/30';
        default:
            return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }
}
</file>

<file path="frontend/components/PremiumCardImage.tsx">
import React from 'react';
import Image from 'next/image';

interface PremiumCardImageProps {
    src: string;
    alt: string;
    className?: string;
}

const PremiumCardImage: React.FC<PremiumCardImageProps> = ({ src, alt, className = '' }) => {
    return (
        <div className={`relative overflow-hidden rounded-xl group ${className}`}>
            {/* Base Image with Filters */}
            <Image
                src={src}
                alt={alt}
                fill
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                className="object-cover filter contrast-110 saturate-125"
            />

            {/* Gold Frame Overlay */}
            <div className="absolute inset-0 border-[6px] border-brand-gold rounded-xl pointer-events-none shadow-[inset_0_0_20px_rgba(255,215,0,0.5)] z-10"></div>

            {/* Holographic Sheen Animation */}
            <div className="absolute inset-0 pointer-events-none z-20 overflow-hidden">
                <div className="absolute inset-0 w-[200%] h-[200%] bg-gradient-to-br from-transparent via-white/30 to-transparent animate-shimmer-diagonal mix-blend-overlay"></div>
            </div>

            {/* Optional: Glass reflection effect */}
            <div className="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent opacity-50 pointer-events-none z-10"></div>
        </div>
    );
};

export default PremiumCardImage;
</file>

<file path="frontend/components/PurchaseAnimation.tsx">
'use client';

import { useEffect, useState } from 'react';

interface PurchaseAnimationProps {
    onComplete: () => void;
}

export default function PurchaseAnimation({ onComplete }: PurchaseAnimationProps) {
    const [stage, setStage] = useState<'start' | 'flash' | 'reveal' | 'end'>('start');

    useEffect(() => {
        // Sequence of animation
        const timer1 = setTimeout(() => setStage('flash'), 500);
        const timer2 = setTimeout(() => setStage('reveal'), 1500);
        const timer3 = setTimeout(() => setStage('end'), 4000);
        const timer4 = setTimeout(onComplete, 4500);

        return () => {
            clearTimeout(timer1);
            clearTimeout(timer2);
            clearTimeout(timer3);
            clearTimeout(timer4);
        };
    }, [onComplete]);

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-xl">
            {/* Background Rays */}
            <div className={`absolute inset-0 flex items-center justify-center transition-opacity duration-1000 ${stage === 'start' ? 'opacity-0' : 'opacity-100'}`}>
                <div className="w-[200vw] h-[200vw] bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,215,0,0.1)_20deg,transparent_40deg,rgba(255,215,0,0.1)_60deg,transparent_80deg,rgba(255,215,0,0.1)_100deg,transparent_120deg,rgba(255,215,0,0.1)_140deg,transparent_160deg,rgba(255,215,0,0.1)_180deg,transparent_200deg,rgba(255,215,0,0.1)_220deg,transparent_240deg,rgba(255,215,0,0.1)_260deg,transparent_280deg,rgba(255,215,0,0.1)_300deg,transparent_320deg,rgba(255,215,0,0.1)_340deg,transparent_360deg)] animate-[spin_20s_linear_infinite]"></div>
            </div>

            {/* Flash Effect */}
            <div className={`absolute inset-0 bg-white transition-opacity duration-300 pointer-events-none ${stage === 'flash' ? 'opacity-80' : 'opacity-0'}`}></div>

            {/* Content */}
            <div className={`relative flex flex-col items-center transform transition-all duration-1000 ${stage === 'reveal' ? 'scale-100 opacity-100' : 'scale-50 opacity-0'}`}>
                <div className="text-6xl mb-8 animate-bounce">🎉</div>
                <h2 className="text-4xl md:text-6xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-gold via-white to-brand-gold animate-pulse text-center">
                    ORDER COMPLETED!
                </h2>
                <p className="mt-4 text-brand-platinum text-xl text-center max-w-md">
                    Congratulations! You have successfully received your item.
                </p>

                {/* Particles/Confetti (Simplified CSS) */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full pointer-events-none">
                    {[...Array(12)].map((_, i) => (
                        <div key={i} className="absolute top-1/2 left-1/2 w-2 h-2 bg-brand-gold rounded-full animate-ping" style={{
                            animationDelay: `${i * 0.1}s`,
                            transform: `rotate(${i * 30}deg) translate(100px)`
                        }}></div>
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/ShowcaseCard.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';

interface ICard {
    id: string;
    // catalog_id, catalog removed
    player_name?: string | null;
    year?: number | null;
    manufacturer?: string | null;
    team?: string | null;
    images?: string[];
    is_rookie?: boolean;
    is_autograph?: boolean;
    price?: number | null;
    status?: string | null;
    variation?: string | null;
    series_name?: string | null;
    card_number?: string | null;
    moment_history?: any[];
    moment_created_at?: string | null;
}

import MomentHistoryBadge from './MomentHistoryBadge';
interface ShowcaseItemProps {
    item: ICard;
    type?: 'listed' | 'purchased'; // To distinguish in aggregated view
    variant?: 'default' | 'live-moment';
    is_live_moment?: boolean; // Added flag
    live_moments?: any[]; // Array for multiple moments
    onDelete?: (id: string) => void;
    onCancel?: (id: string) => void;
    onToggleDisplay?: (id: string, currentStatus: string) => void;
    onClone?: (id: string) => void;
    onRestore?: (id: string) => void;
    isArchived?: boolean;
    moment_created_at?: string | null;
}

export default function ShowcaseCard({ item, type, variant = 'default', is_live_moment, live_moments = [], onDelete, onCancel, onToggleDisplay, onClone, onRestore, isArchived, moment_created_at }: ShowcaseItemProps) {
    const [isFlipped, setIsFlipped] = useState(false);
    const hasBackImage = item.images && item.images.length > 1;
    // Use prop if provided, otherwise fallback to variant (for backward compatibility or explicit override)
    const isLiveMoment = is_live_moment || variant === 'live-moment' || live_moments.length > 0;

    // Countdown logic for multiple moments
    const [momentsWithTime, setMomentsWithTime] = useState<any[]>([]);
    const [isLiveActive, setIsLiveActive] = useState(isLiveMoment);

    useEffect(() => {
        if (isLiveMoment) {
            // Normalize moments: use live_moments array or fallback to single moment_created_at
            let sourceMoments = [...live_moments];
            if (sourceMoments.length === 0 && (is_live_moment || variant === 'live-moment')) {
                sourceMoments.push({
                    id: 'temp-' + item.id,
                    created_at: moment_created_at || new Date().toISOString(),
                    title: 'Live Moment'
                });
            }

            const updateTimers = () => {
                const now = new Date().getTime();
                const updated = sourceMoments.map(m => {
                    const startTime = new Date(m.created_at).getTime();
                    const endTime = startTime + 60 * 60 * 1000;
                    const distance = endTime - now;

                    if (distance > 0) {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        return {
                            ...m,
                            timeLeft: `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                            isExpired: false
                        };
                    }
                    return { ...m, timeLeft: '00:00', isExpired: true };
                });

                setMomentsWithTime(updated);
                setIsLiveActive(updated.some(m => !m.isExpired));
            };

            updateTimers();
            const timerId = setInterval(updateTimers, 1000);
            return () => clearInterval(timerId);
        } else {
            setMomentsWithTime([]);
            setIsLiveActive(false);
        }
    }, [isLiveMoment, live_moments, is_live_moment, variant, moment_created_at, item.id]);

    const handleFlip = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsFlipped(!isFlipped);
    };

    return (
        <motion.div
            className={`group relative flex flex-col rounded-xl overflow-hidden border transition-all duration-500 bg-brand-dark-light/50`}
            animate={isLiveActive ? {
                boxShadow: [
                    "0 0 15px rgba(255, 215, 0, 0.2)",
                    "0 0 30px rgba(255, 215, 0, 0.5)",
                    "0 0 15px rgba(255, 215, 0, 0.2)"
                ],
                borderColor: [
                    "rgba(255, 215, 0, 0.4)",
                    "rgba(255, 215, 0, 1)",
                    "rgba(255, 215, 0, 0.4)"
                ]
            } : {}}
            transition={{
                duration: 3,
                repeat: Infinity,
                ease: "easeInOut"
            }}
            whileHover={{ scale: 1.02 }}
            style={{
                borderColor: isLiveActive ? '#FFD700' : 'rgba(255, 255, 255, 0.1)'
            }}
        >

            {/* Main Clickable Link Overlay */}
            <Link href={`/listings/${item.id}`} className="absolute inset-0 z-10" />

            {/* Live Moment Badge */}
            {isLiveActive && (
                <div className="absolute top-0 left-0 z-30 w-full overflow-hidden h-full pointer-events-none p-3 space-y-2">
                    {momentsWithTime.filter(m => !m.isExpired).map((m, idx) => (
                        <div key={m.id || idx} className="relative px-2 py-0.5 bg-brand-gold text-brand-dark text-[10px] font-bold tracking-wider rounded shadow-lg shadow-brand-gold/20 border border-white/20 flex items-center gap-1.5 z-50 animate-pulse w-fit">
                            <span className="w-1.5 h-1.5 rounded-full bg-red-600 animate-ping" />
                            LIVE
                            <span className="ml-1 pl-1 border-l border-brand-dark/20 font-mono">{m.timeLeft}</span>
                        </div>
                    ))}
                    {/* Corner Glow Effect */}
                    <div className="absolute -top-10 -left-10 w-20 h-20 bg-brand-gold/30 blur-2xl rounded-full"></div>
                    <div className="absolute -bottom-10 -right-10 w-20 h-20 bg-brand-gold/30 blur-2xl rounded-full"></div>
                </div>
            )}
            {/* Card Image Area */}
            <div className="relative aspect-[3/4] w-full perspective-[1000px]">
                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${isFlipped && (hasBackImage || isLiveActive || (item.moment_history && item.moment_history.length > 0)) ? '[transform:rotateY(180deg)]' : ''}`}>
                    {/* Front Image */}
                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden]">
                        {item.images && item.images[0] ? (
                            <Image
                                src={item.images[0]}
                                alt={item.player_name || 'Card Image'}
                                fill
                                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
                                className="object-cover"
                            />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">No Image</div>
                        )}
                        {/* Live Moment Inner Glow */}
                        {isLiveActive && (
                            <div className="absolute inset-0 shadow-[inset_0_0_30px_rgba(255,215,0,0.3)] mix-blend-overlay pointer-events-none" />
                        )}
                    </div>

                    {/* Back Image */}
                    {hasBackImage && (
                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] bg-brand-dark-light relative">
                            <Image
                                src={(item.images && item.images[1]) || ''}
                                alt={`${item.player_name || ''} Back`}
                                fill
                                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
                                className="object-cover"
                            />

                            {/* Live Moment Stats Overlay / Latest Stamped Moment */}
                            {(isLiveActive || (item.moment_history && item.moment_history.length > 0)) && (
                                <div className="absolute inset-0 bg-black/70 flex flex-col justify-center items-center p-4 text-center">
                                    <div className="border-2 border-brand-gold/50 p-3 rounded-lg bg-black/40 backdrop-blur-md w-full">
                                        <h4 className="text-brand-gold font-heading font-bold text-sm mb-2 tracking-widest border-b border-brand-gold/30 pb-1">
                                            {isLiveActive ? 'LIVE MOMENT DATA' : 'STAMPED MOMENT'}
                                        </h4>
                                        {(() => {
                                            const activeMoment = momentsWithTime.find(m => !m.isExpired);
                                            // Prioritize moments with memories, or fallback to the absolute latest
                                            const history = item.moment_history || [];
                                            const memoryMoment = history.slice().reverse().find((m: any) => m.memories && m.memories.length > 0);

                                            const latestMoment = memoryMoment || (history.length > 0 ? history[history.length - 1] : activeMoment);

                                            if (!latestMoment) return null;

                                            return (
                                                <div className="space-y-2 text-[10px] font-mono">
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">TITLE</span>
                                                        <span className="text-white font-bold truncate max-w-[100px]" title={latestMoment.title || 'ACTIVE'}>
                                                            {latestMoment.title || 'ACTIVE NOW'}
                                                        </span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">PLAYER</span>
                                                        <span className="text-white font-bold">{latestMoment.player_name || item.player_name || '---'}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">TIME</span>
                                                        <span className="text-white font-bold">
                                                            {latestMoment.timestamp ? new Date(latestMoment.timestamp).toLocaleDateString() : (latestMoment.created_at ? new Date(latestMoment.created_at).toLocaleDateString() : new Date().toLocaleDateString())}
                                                        </span>
                                                    </div>
                                                    <div className="pt-2 border-t border-brand-platinum/10">
                                                        <div className="text-brand-gold font-bold mb-1 uppercase text-[9px]">
                                                            {latestMoment.description?.substring(0, 30) || 'CAPTURING LIVE EVENT...'}
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 text-[9px]">
                                                            <div className="bg-brand-platinum/10 rounded p-1">
                                                                <div className="text-brand-platinum/50 uppercase">INTENSITY</div>
                                                                <div className="text-white font-bold">{latestMoment.intensity || '--'}</div>
                                                            </div>
                                                            <div className="bg-brand-platinum/10 rounded p-1">
                                                                <div className="text-brand-platinum/50 uppercase">RESULT</div>
                                                                <div className="text-white font-bold truncate">{latestMoment.match_result || '---'}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* Flip Button */}
                {(hasBackImage || isLiveActive || (item.moment_history && item.moment_history.length > 0)) && (
                    <button
                        onClick={handleFlip}
                        className="absolute top-2 right-2 z-20 p-1.5 rounded-full bg-black/60 text-white hover:bg-brand-blue hover:text-white transition-colors backdrop-blur-sm border border-white/10"
                        title="Flip Card"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                )}
            </div>

            {/* Footer Area: Info & Actions */}
            <div className="p-3 bg-brand-dark-light border-t border-brand-platinum/5 flex flex-col gap-2">
                {/* Info */}
                <div className="flex justify-between items-start">
                    <div className="overflow-hidden">
                        <p className="text-white font-bold text-sm truncate" title={item.player_name || 'Unknown'}>{item.player_name || 'Unknown'}</p>
                        <p className="text-brand-platinum/70 text-xs truncate">{item.year || ''} {item.manufacturer || ''}</p>
                    </div>
                    {/* Moment History Badge */}
                    <MomentHistoryBadge
                        history={item.moment_history}
                        liveCount={0} // Disabled per user request (Step 7712)
                    />
                </div>

                {/* Status & Price */}
                <div className="flex justify-between items-center min-h-[20px]">
                    {type === 'purchased' ? (
                        <span className="text-[10px] px-2 py-0.5 rounded-full border bg-green-500/10 border-green-500/30 text-green-400 font-medium tracking-wide">
                            PURCHASED
                        </span>
                    ) : (
                        <>
                            {item.status === 'Active' ? (
                                <div className="flex items-center gap-1.5">
                                    <div className="w-4 h-4 rounded-full bg-brand-gold flex items-center justify-center shadow-[0_0_8px_rgba(234,179,8,0.4)]">
                                        <span className="text-[9px] text-brand-dark font-bold">¥</span>
                                    </div>
                                    <span className="font-heading font-bold text-white text-base tracking-tight">
                                        {item.price?.toLocaleString() ?? '---'}
                                    </span>
                                </div>
                            ) : (
                                <span className={`text-[10px] px-2 py-0.5 rounded-full border font-medium tracking-wide ${item.status === 'Sold' || item.status === 'Completed' || item.status === 'Delivered' ? 'bg-red-500/10 border-red-500/30 text-red-400' :
                                    item.status === 'Display' ? 'bg-brand-blue/10 border-brand-blue/30 text-brand-blue-glow' :
                                        'bg-brand-platinum/10 border-brand-platinum/20 text-brand-platinum/60'
                                    } `}>
                                    {item.status === 'Sold' || item.status === 'Completed' || item.status === 'Delivered' ? 'SOLD' :
                                        item.status === 'Display' ? 'DISPLAY' :
                                            (item.status || '').toUpperCase()}
                                </span>
                            )}
                        </>
                    )}
                </div>

                {/* Action Buttons Row */}
                <div className="relative z-20 flex items-center justify-end gap-2 pt-3 mt-1 border-t border-brand-platinum/10">
                    {/* Toggle Display Status Button */}
                    {!isArchived && (((item.status === 'Draft' || item.status === 'Display' || item.status === 'Active') && onToggleDisplay) || (type === 'purchased' && onClone)) ? (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (type === 'purchased' && onClone) {
                                        onClone(item.id);
                                    } else if (onToggleDisplay) {
                                        onToggleDisplay(item.id, item.status || '');
                                    }
                                }}
                                className={`p-2 rounded-lg border transition-all duration-300 ${item.status === 'Display'
                                    ? 'bg-brand-blue/10 border-brand-blue/40 text-brand-blue hover:bg-brand-blue/20 hover:border-brand-blue'
                                    : 'bg-brand-platinum/5 border-brand-platinum/10 text-brand-platinum/40 hover:bg-brand-platinum/10 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } `}
                            >
                                {item.status === 'Display' ? (
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                ) : (
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.243M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                                )}
                            </button>
                            <div className="absolute center-x bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                {item.status === 'Display' ? "非公開にする" :
                                    (item.status === 'Active' ? "Displayに変更" :
                                        (type === 'purchased' ? "Displayに追加 (Clone)" : "公開する"))}
                            </div>
                        </div>
                    ) : null}

                    {/* List Button (For Draft/Display OR Purchased) */}
                    {(item.status === 'Draft' || item.status === 'Display' || type === 'purchased') && (
                        <Link
                            href={`/sell?source=collection&id=${item.id}`}
                            className="group/tooltip relative p-2 bg-brand-gold/10 hover:bg-brand-gold/20 text-brand-gold rounded-lg border border-brand-gold/30 hover:border-brand-gold/50 transition-all duration-300"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                出品する
                            </div>
                        </Link>
                    )}

                    {/* Cancel Listing Button (for Active items) */}
                    {!isArchived && item.status === 'Active' && onCancel && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onCancel(item.id);
                                }}
                                className="p-2 bg-brand-platinum/5 hover:bg-red-500/20 text-brand-platinum/60 hover:text-red-400 rounded-lg border border-brand-platinum/10 hover:border-red-500/30 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                出品取り消し
                            </div>
                        </div>
                    )}

                    {/* Restore Button (Archive only) */}
                    {isArchived && onRestore && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onRestore(item.id);
                                }}
                                className="p-2 bg-green-500/10 hover:bg-green-500/20 text-green-500 rounded-lg border border-green-500/30 hover:border-green-500/50 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                コレクションに戻す
                            </div>
                        </div>
                    )}

                    {/* Delete Button (Normal view only, or Archive if physical delete allowed) */}
                    {!isArchived && onDelete && (item.status === 'Draft' || item.status === 'Display') && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onDelete(item.id);
                                }}
                                className="p-2 bg-brand-platinum/5 hover:bg-red-500/20 text-brand-platinum/40 hover:text-red-400 rounded-lg border border-brand-platinum/10 hover:border-red-500/30 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                削除 (アーカイブ)
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </motion.div>
    );
}
</file>

<file path="frontend/components/SkeletonCard.tsx">
export default function SkeletonCard() {
    return (
        <div className="relative group w-full aspect-[3/4] rounded-xl overflow-hidden bg-brand-dark-light border border-white/5 animate-pulse">
            {/* Shimmer Effect */}
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_1.5s_infinite]"></div>

            <div className="h-full flex flex-col justify-end p-3">
                <div className="space-y-2">
                    <div className="h-4 bg-brand-platinum/10 rounded w-3/4"></div>
                    <div className="h-3 bg-brand-platinum/10 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/hooks/useZengin.ts">
import { useState, useEffect } from 'react';

export interface Bank {
    code: string;
    name: string;
    kana: string;
    hira: string;
    roma: string;
}

export interface Branch {
    code: string;
    name: string;
    kana: string;
    hira: string;
    roma: string;
}

const ZENGIN_BASE_URL = 'https://zengin-code.github.io/api';

export function useZengin() {
    const [banks, setBanks] = useState<Bank[]>([]);
    const [branches, setBranches] = useState<Branch[]>([]);
    const [loadingBanks, setLoadingBanks] = useState(false);
    const [loadingBranches, setLoadingBranches] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Fetch All Banks on mount
    useEffect(() => {
        const fetchBanks = async () => {
            setLoadingBanks(true);
            try {
                const res = await fetch(`${ZENGIN_BASE_URL}/banks.json`);
                if (!res.ok) throw new Error('Failed to fetch bank data');
                const data = await res.json();
                // The data is an object where keys are codes, or array? 
                // Zengin data format: { "0001": { code: "0001", name: "みずほ", ... }, ... }
                // Convert to array
                const bankList = Object.values(data) as Bank[];
                setBanks(bankList);
            } catch (err: any) {
                console.error(err);
                setError('Failed to load bank list.');
            } finally {
                setLoadingBanks(false);
            }
        };
        fetchBanks();
    }, []);

    // Fetch Branches for a specific bank
    const fetchBranches = async (bankCode: string) => {
        if (!bankCode) {
            setBranches([]);
            return;
        }
        setLoadingBranches(true);
        setBranches([]); // Clear previous
        try {
            const res = await fetch(`${ZENGIN_BASE_URL}/branches/${bankCode}.json`);
            if (!res.ok) throw new Error('Failed to fetch branch data');
            const data = await res.json();
            const branchList = Object.values(data) as Branch[];
            setBranches(branchList);
        } catch (err: any) {
            console.error(err);
            // Some banks might not have branch data in this simplified API or URL issue
            // But typical zengin-data supports major banks.
            setError(`Failed to load branches for bank ${bankCode}`);
            setBranches([]);
        } finally {
            setLoadingBranches(false);
        }
    };

    return {
        banks,
        branches,
        fetchBranches,
        loadingBanks,
        loadingBranches,
        error
    };
}
</file>

<file path="frontend/lib/resend.ts">
import { Resend } from 'resend';

// Initialize Resend client
const apiKey = process.env.RESEND_API_KEY;

if (!apiKey) {
    console.warn("⚠️  RESEND_API_KEY is not defined in process.env. Email sending will fail.");
    console.log("Current NODE_ENV:", process.env.NODE_ENV);
} else {
    console.log("✅ RESEND_API_KEY is loaded (starts with " + apiKey.substring(0, 3) + ")");
}

export const resend = new Resend(apiKey || 're_123_placeholder');
</file>

<file path="frontend/lib/stripe.ts">
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
    apiVersion: '2025-11-17.clover', // Latest API version
    typescript: true,
});
</file>

<file path="frontend/lib/teams.ts">
export const TEAM_GROUPS = [
    {
        label: "ア・リーグ 東地区",
        teams: [
            { code: 'BAL', name: 'オリオールズ' },
            { code: 'BOS', name: 'レッドソックス' },
            { code: 'NYY', name: 'ヤンキース' },
            { code: 'TB', name: 'レイズ' },
            { code: 'TOR', name: 'ブルージェイズ' },
        ]
    },
    {
        label: "ア・リーグ 中地区",
        teams: [
            { code: 'CWS', name: 'ホワイトソックス' },
            { code: 'CLE', name: 'ガーディアンズ' },
            { code: 'DET', name: 'タイガース' },
            { code: 'KC', name: 'ロイヤルズ' },
            { code: 'MIN', name: 'ツインズ' },
        ]
    },
    {
        label: "ア・リーグ 西地区",
        teams: [
            { code: 'HOU', name: 'アストロズ' },
            { code: 'LAA', name: 'エンゼルス' },
            { code: 'OAK', name: 'アスレチックス' },
            { code: 'SEA', name: 'マリナーズ' },
            { code: 'TEX', name: 'レンジャーズ' },
        ]
    },
    {
        label: "ナ・リーグ 東地区",
        teams: [
            { code: 'ATL', name: 'ブレーブス' },
            { code: 'MIA', name: 'マーリンズ' },
            { code: 'NYM', name: 'メッツ' },
            { code: 'PHI', name: 'フィリーズ' },
            { code: 'WSH', name: 'ナショナルズ' },
        ]
    },
    {
        label: "ナ・リーグ 中地区",
        teams: [
            { code: 'CHC', name: 'カブス' },
            { code: 'CIN', name: 'レッズ' },
            { code: 'MIL', name: 'ブリュワーズ' },
            { code: 'PIT', name: 'パイレーツ' },
            { code: 'STL', name: 'カージナルス' },
        ]
    },
    {
        label: "ナ・リーグ 西地区",
        teams: [
            { code: 'AZ', name: 'ダイヤモンドバックス' },
            { code: 'COL', name: 'ロッキーズ' },
            { code: 'LAD', name: 'ドジャース' },
            { code: 'SD', name: 'パドレス' },
            { code: 'SF', name: 'ジャイアンツ' },
        ]
    },
    {
        label: "NPB セ・リーグ",
        teams: [
            { code: "YG", name: "巨人 (Giants)" },
            { code: "T", name: "阪神 (Tigers)" },
            { code: "DB", name: "DeNA (BayStars)" },
            { code: "C", name: "広島 (Carp)" },
            { code: "S", name: "ヤクルト (Swallows)" },
            { code: "D", name: "中日 (Dragons)" },
        ]
    },
    {
        label: "NPB パ・リーグ",
        teams: [
            { code: "H", name: "ソフトバンク (Hawks)" },
            { code: "F", name: "日本ハム (Fighters)" },
            { code: "M", name: "ロッテ (Marines)" },
            { code: "E", name: "楽天 (Eagles)" },
            { code: "L", name: "西武 (Lions)" },
            { code: "B", name: "オリックス (Buffaloes)" },
        ]
    },
    {
        label: "ナショナルチーム",
        teams: [
            { code: "JPN", name: "侍ジャパン (Samurai Japan)" },
            { code: "USA", name: "アメリカ代表 (USA)" },
            { code: "DOM", name: "ドミニカ代表 (Dominican Rep.)" },
            { code: "KOR", name: "韓国代表 (Korea)" },
        ]
    }
];
</file>

<file path="frontend/migrations/03_add_order_status.sql">
ｍ
</file>

<file path="frontend/migrations/04_expand_listing_items.sql">
-- Add columns to listing_items to support detailed card information
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS variation text,
ADD COLUMN IF NOT EXISTS serial_number text,
ADD COLUMN IF NOT EXISTS is_rookie boolean default false,
ADD COLUMN IF NOT EXISTS is_autograph boolean default false,
ADD COLUMN IF NOT EXISTS description text,
ADD COLUMN IF NOT EXISTS condition_rating text; -- For raw card condition (e.g. Near Mint)

-- Comment on columns
COMMENT ON COLUMN public.listing_items.variation IS 'Variant of the card (e.g. Refractor, Gold)';
COMMENT ON COLUMN public.listing_items.serial_number IS 'Serial number printed on card (e.g. 10/50)';
COMMENT ON COLUMN public.listing_items.condition_rating IS 'Condition string for raw cards, separate from graded info in condition_grading jsonb';
</file>

<file path="frontend/migrations/05_decouple_catalog.sql">
-- Make catalog_id nullable to allow manual listings without catalog entry
ALTER TABLE public.listing_items ALTER COLUMN catalog_id DROP NOT NULL;

-- Add columns for manual entry (Basic Info)
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS player_name text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS team text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS year integer;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS manufacturer text;

-- Comment: These fields will be populated if catalog_id is null (or as overrides)
</file>

<file path="frontend/migrations/06_backfill_and_remove_catalog.sql">
-- 1. Add missing specific columns from catalog to listing_items
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS card_number text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS series_name text;

-- 2. Backfill data: Copy from card_catalogs to listing_items where listing_items fields are null
-- We use COALESCE to keep existing overrides, or just unconditional copy if the target is null.
-- Actually, if mode was "add", target is likely null. If "edit" override, target has value.
-- We only fill where target is NULL to respect potential manual edits (though previous logic didn't really support edits well until now).
-- Safe bet: Fill where NULL.

UPDATE public.listing_items
SET
    player_name = COALESCE(public.listing_items.player_name, c.player_name),
    team = COALESCE(public.listing_items.team, c.team::text),
    year = COALESCE(public.listing_items.year, c.year),
    manufacturer = COALESCE(public.listing_items.manufacturer, c.manufacturer::text),
    is_rookie = COALESCE(public.listing_items.is_rookie, c.is_rookie),
    -- New columns
    card_number = COALESCE(public.listing_items.card_number, c.card_number),
    series_name = COALESCE(public.listing_items.series_name, c.series_name)
    -- rarity? We map 'Autograph' rarity to is_autograph=true if needed, but is_autograph is likely set manually or default false.
    -- Let's check rarity. If catalog says Autograph, we should probably ensure is_autograph is true?
    -- is_autograph = CASE WHEN c.rarity = 'Autograph' THEN true ELSE public.listing_items.is_autograph END
FROM public.card_catalogs c
WHERE public.listing_items.catalog_id = c.id;


-- 1b. Add missing columns to user_collections (assuming it follows similar structure or needs these to hold data)
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS player_name text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS team text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS year integer;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS manufacturer text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS card_number text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS series_name text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS is_rookie boolean;
-- Add other cols if user_collections is used for rich display, otherwise basic info might suffice.

-- 2b. Backfill user_collections
UPDATE public.user_collections
SET
    player_name = COALESCE(public.user_collections.player_name, c.player_name),
    team = COALESCE(public.user_collections.team, c.team::text),
    year = COALESCE(public.user_collections.year, c.year),
    manufacturer = COALESCE(public.user_collections.manufacturer, c.manufacturer::text),
    card_number = COALESCE(public.user_collections.card_number, c.card_number),
    series_name = COALESCE(public.user_collections.series_name, c.series_name),
    is_rookie = COALESCE(public.user_collections.is_rookie, c.is_rookie)
FROM public.card_catalogs c
WHERE public.user_collections.catalog_id = c.id;

-- 3. Drop Foreign Key Constraints
ALTER TABLE public.listing_items DROP CONSTRAINT IF EXISTS listing_items_catalog_id_fkey;
ALTER TABLE public.user_collections DROP CONSTRAINT IF EXISTS user_collections_catalog_id_fkey;

-- 4. Drop catalog_id columns
ALTER TABLE public.listing_items DROP COLUMN IF EXISTS catalog_id;
ALTER TABLE public.user_collections DROP COLUMN IF EXISTS catalog_id;

-- 5. Drop card_catalogs table
DROP TABLE IF EXISTS public.card_catalogs CASCADE;
</file>

<file path="frontend/migrations/07_update_complete_order_rpc.sql">
-- Migration: Update complete_order RPC to remove catalog_id dependency
-- Created at: 2025-12-11

CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Update listing status to Completed
  UPDATE listing_items
  SET status = 'Completed'
  WHERE id = p_listing_id;

  -- Update order status to completed
  UPDATE orders
  SET status = 'completed'
  WHERE listing_id = p_listing_id;
END;
$$;
</file>

<file path="frontend/migrations/08_payout_system.sql">
-- Migration: Add Payout System Tables and Columns
-- Created at: 2025-12-12

-- 1. Add real_name_kana to profiles
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS real_name_kana text;

-- 2. Create bank_accounts table
CREATE TABLE IF NOT EXISTS public.bank_accounts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    bank_name text NOT NULL,
    branch_name text NOT NULL,
    account_type text NOT NULL, -- 'ordinary' (普通) or 'current' (当座)
    account_number text NOT NULL,
    account_holder_name text NOT NULL, -- Kana Only
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT bank_accounts_user_id_key UNIQUE (user_id) -- One active account per user for simplicity initially
);

-- 3. Create payouts table
CREATE TABLE IF NOT EXISTS public.payouts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    amount integer NOT NULL,
    status text NOT NULL DEFAULT 'pending', -- pending, paid, rejected
    created_at timestamptz DEFAULT now(),
    processed_at timestamptz
);

-- Enable RLS
ALTER TABLE public.bank_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payouts ENABLE ROW LEVEL SECURITY;

-- Policies for bank_accounts
CREATE POLICY "Users can view own bank account" 
    ON public.bank_accounts FOR SELECT 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own bank account" 
    ON public.bank_accounts FOR INSERT 
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own bank account" 
    ON public.bank_accounts FOR UPDATE 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own bank account" 
    ON public.bank_accounts FOR DELETE 
    USING (auth.uid() = user_id);

-- Policies for payouts
CREATE POLICY "Users can view own payouts" 
    ON public.payouts FOR SELECT 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own payouts" 
    ON public.payouts FOR INSERT 
    WITH CHECK (auth.uid() = user_id);

-- Only admins/service role can update payouts (e.g. to 'paid'), users cannot.
</file>

<file path="frontend/migrations/09_add_shipping_to_orders.sql">
-- Add shipping details to orders table
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS shipping_name text,
ADD COLUMN IF NOT EXISTS shipping_postal_code text,
ADD COLUMN IF NOT EXISTS shipping_address text,
ADD COLUMN IF NOT EXISTS shipping_phone text;

COMMENT ON COLUMN public.orders.shipping_name IS 'Snapshot of shipping name at purchase time';
COMMENT ON COLUMN public.orders.shipping_address IS 'Snapshot of full address at purchase time';
</file>

<file path="frontend/migrations/10_add_bank_codes.sql">
-- Add bank_code and branch_code to bank_accounts
ALTER TABLE public.bank_accounts 
ADD COLUMN IF NOT EXISTS bank_code text,
ADD COLUMN IF NOT EXISTS branch_code text;

-- Ideally make them NOT NULL after backfill, but for now allow null or rely on app logic
</file>

<file path="frontend/migrations/11_add_payout_fee.sql">
-- Migration: Add fee and payout_amount to payouts table
alter table public.payouts
add column if not exists fee integer not null default 0,
add column if not exists payout_amount integer;

-- Backfill payout_amount for existing records (assume fee was 0)
update public.payouts
set payout_amount = amount
where payout_amount is null;

-- Now make payout_amount NOT NULL
alter table public.payouts
alter column payout_amount set not null;
</file>

<file path="frontend/migrations/12_enhance_orders.sql">
-- Migration: Enhance orders table for Fulfillment Workflow
-- Created at: 2025-12-12

-- 1. Add Shipment Columns
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS shipping_address_snapshot jsonb, -- { name, postal_code, address, phone }
ADD COLUMN IF NOT EXISTS tracking_number text,
ADD COLUMN IF NOT EXISTS carrier text,
ADD COLUMN IF NOT EXISTS shipped_at timestamptz,
ADD COLUMN IF NOT EXISTS completed_at timestamptz;

-- 1.5 Normalize Existing Statuses (Fixing 23514 violation)
-- Convert PascalCase or legacy values to snake_case allowed values
UPDATE public.orders SET status = 'pending' WHERE status = 'TransactionPending';
UPDATE public.orders SET status = 'awaiting_shipping' WHERE status = 'AwaitingShipment';
UPDATE public.orders SET status = 'shipped' WHERE status = 'Shipped';
UPDATE public.orders SET status = 'completed' WHERE status = 'Delivered';
-- Fallback for any other unmapped values if necessary, or let it fail if unknown.
-- Assuming 'paid' might be 'Paid'
UPDATE public.orders SET status = 'paid' WHERE status = 'Paid';

-- 2. Add Status Check Constraint
-- Allow: pending, awaiting_shipping, shipped, completed, cancelled, (and 'paid' for legacy/compatibility if needed)
-- Renaming 'paid' to 'awaiting_shipping' is ideal, but for now we accept both or assume 'paid' -> 'awaiting_shipping' logic in app.
ALTER TABLE public.orders
DROP CONSTRAINT IF EXISTS orders_status_check;

ALTER TABLE public.orders
ADD CONSTRAINT orders_status_check 
CHECK (status IN ('pending', 'paid', 'awaiting_shipping', 'shipped', 'completed', 'cancelled', 'returned'));

-- 3. Comments
COMMENT ON COLUMN public.orders.shipping_address_snapshot IS 'Fixed address snapshot at time of purchase';
COMMENT ON COLUMN public.orders.tracking_number IS 'Shipment tracking number';
COMMENT ON COLUMN public.orders.shipped_at IS 'Timestamp when seller marked as shipped';
COMMENT ON COLUMN public.orders.completed_at IS 'Timestamp when buyer received item';

-- 4. Enable RLS and Add Policies
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to avoid conflicts if re-running
DROP POLICY IF EXISTS "Users can view their own purchases" ON public.orders;
DROP POLICY IF EXISTS "Users can view orders for their items" ON public.orders;
DROP POLICY IF EXISTS "Buyers can view their orders" ON public.orders;
DROP POLICY IF EXISTS "Sellers can view their orders" ON public.orders;

-- Policy: Users can view orders where they are the Buyer
CREATE POLICY "Buyers can view their orders"
ON public.orders FOR SELECT
USING (auth.uid() = buyer_id);

-- Policy: Users can view orders where they are the Seller (via listing_items join)
-- Optimized with EXISTS
CREATE POLICY "Sellers can view their orders"
ON public.orders FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM public.listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);

-- Note: No UPDATE/INSERT policies for public users. 
-- Updates must be done via Server Actions (Service Role) or RPC (Security Definer).
</file>

<file path="frontend/migrations/13_fix_listing_rls.sql">
-- Migration: Fix Listing Items RLS for Sellers
-- Created at: 2025-12-12
-- Goal: Ensure sellers can view their own items (even if not Active), 
-- which is required for the orders RLS policy to work.

ALTER TABLE public.listing_items ENABLE ROW LEVEL SECURITY;

-- 1. Policy: Users can view their own items (All statuses)
DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;

CREATE POLICY "Users can view own items"
ON public.listing_items FOR SELECT
USING (auth.uid() = seller_id);

-- 2. Policy: Public can view Active items (re-affirming existing or creating if missing)
-- (We use separate names to not conflict if "Enable read access for all users" exists for everything)
-- Assuming there might be an existing policy "Enable read access for all users" which might be filtering by status.
-- We add "Users can view own items" which is permissive for the owner. 
-- PostgREST combines policies with OR. So if one allows, access is granted.
</file>

<file path="frontend/migrations/14_add_live_moments.sql">
-- Migration: Add Live Moments Table
-- Created for Admin Dashboard Feature

create table if not exists public.live_moments (
    id uuid default gen_random_uuid() primary key,
    player_name text not null,
    title text not null,
    description text,
    intensity integer not null default 1, check (intensity >= 1 and intensity <= 5),
    created_at timestamptz default now()
);

-- RLS
alter table public.live_moments enable row level security;

-- Policy: Everyone can view
create policy "Live moments are viewable by everyone" 
    on public.live_moments for select 
    using (true);

-- Policy: Only Admins can insert/update (Enforced by App Logic using Service Role, so we deny here for standard users)
-- No INSERT/UPDATE policy for public/authenticated users means default deny.
</file>

<file path="frontend/migrations/15_add_moment_snapshot.sql">
-- Migration: Add Moment Snapshot to Orders
-- Created at: 2025-12-16
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS moment_snapshot jsonb;
COMMENT ON COLUMN public.orders.moment_snapshot IS 'Snapshot of the active Live Moment at the time of purchase (if any).';
</file>

<file path="frontend/migrations/16_add_moment_history.sql">
-- Migration: Add Moment History to Listing Items
-- Created at: 2025-12-16
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS moment_history jsonb DEFAULT '[]'::jsonb;
COMMENT ON COLUMN public.listing_items.moment_history IS 'Array of Live Moments this card has experienced during transactions.';
</file>

<file path="frontend/migrations/17_add_match_result_to_live_moments.sql">
-- Migration: Add Match Result to Live Moments
-- Created at: 2025-12-16
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS match_result text;
COMMENT ON COLUMN public.live_moments.match_result IS 'Score or Matchup details (e.g. "LAD 6 - 3 NYY")';
</file>

<file path="frontend/migrations/18_add_is_finalized_to_live_moments.sql">
-- Migration: Add Finalized Flag to Live Moments
-- Created at: 2025-12-16
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS is_finalized boolean DEFAULT false;
COMMENT ON COLUMN public.live_moments.is_finalized IS 'True if the match event has concluded and score is final.';
</file>

<file path="frontend/migrations/21_add_soft_delete_to_listings.sql">
-- Migration: Add Soft Delete to listing_items
-- Created: 2025-12-19
-- 1. Add deleted_at column
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS deleted_at timestamptz DEFAULT NULL;
-- 2. Update RLS Policies to Respect deleted_at
-- Standard read policy usually filters by status='Active'.
-- We need to ensure that deleted items are NOT visible even if status is Active (unexpected but possible).
-- Note: We have "Enable read access for all users" policy likely for Active items.
-- Let's check existing policies and update the one that exposes Active items.
-- 3. Policy: Public can only view ACTIVE and NOT DELETED items
-- (Replacing or Refining existing public read policy)
DROP POLICY IF EXISTS "Enable read access for all users" ON public.listing_items;
CREATE POLICY "Public can view active non-deleted items" ON public.listing_items FOR
SELECT USING (
        status = 'Active'
        AND deleted_at IS NULL
    );
-- 4. Policy: Users can view their OWN items (Including Deleted/Draft/etc)
-- This allows the "Archive" tab to work for the owner.
DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;
CREATE POLICY "Users can view own items" ON public.listing_items FOR
SELECT USING (auth.uid() = seller_id);
-- 5. Update Update/Delete policies (Owners only, non-deleted items)
DROP POLICY IF EXISTS "Users can update own items" ON public.listing_items;
CREATE POLICY "Users can update own items" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
-- Owners can update even if deleted (to restore)
DROP POLICY IF EXISTS "Users can delete own items" ON public.listing_items;
CREATE POLICY "Users can delete own items" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
-- Keep physical delete for now but actions will use soft delete
</file>

<file path="frontend/migrations/22_add_origin_order_id_to_listings.sql">
-- Add origin_order_id to track which order created this cloned item
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS origin_order_id uuid REFERENCES public.orders(id);
-- Create index for faster lookup
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Comment on column
COMMENT ON COLUMN public.listing_items.origin_order_id IS 'Reference to the order that created this cloned/buyer copy';
</file>

<file path="frontend/migrations/23_add_incoming_to_listing_status_enum.sql">
-- Add 'Incoming' to listing_status_enum to support purchased items in transit
-- This is necessary because the column is an ENUM and 'Incoming' was newly introduced.
ALTER TYPE public.listing_status_enum
ADD VALUE IF NOT EXISTS 'Incoming';
</file>

<file path="frontend/migrations/24_add_seller_id_to_orders.sql">
-- Add seller_id to orders table to maintain transaction history
-- This is necessary for the Ownership Transfer model where the card moves to the buyer.
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS seller_id uuid REFERENCES public.profiles(id);
-- Optional: Populate existing orders with listing.seller_id to prevent data loss in history
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL;
</file>

<file path="frontend/migrations/25_fix_selling_view_rls.sql">
-- Migration: Fix RLS for Persistent ID Model (Ownership Transfer)
-- This ensures sellers can see items they've sold even after the card's seller_id changes to the buyer.
-- 1. Update Orders RLS
-- Previous policy relied on joining listing_items.seller_id, which now points to the buyer.
-- Use the new orders.seller_id column instead.
DROP POLICY IF EXISTS "Sellers can view their orders" ON public.orders;
CREATE POLICY "Sellers can view their orders" ON public.orders FOR
SELECT USING (auth.uid() = seller_id);
-- 2. Update Listing Items RLS
-- Allow former sellers to view the physical card details if they are the seller_id on an associated order.
-- This is necessary for the "History" tab and "Manage Order" page.
DROP POLICY IF EXISTS "Sellers can view sold items" ON public.listing_items;
CREATE POLICY "Sellers can view sold items" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
-- Ensure current owners can always see their items (existing policy)
-- DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;
-- (Keep existing "Users can view own items" as it covers the current owner)
-- 3. Data Integrity Fix
-- Ensure any orders created during the transition have the correct seller_id 
-- if they were missed by the webhook logic during the update.
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL
    AND l.seller_id != o.buyer_id;
-- Only fill if the card hasn't been transferred yet or we can deduce it.
-- Note: If the card WAS already transferred, l.seller_id is the buyer. 
-- In that case, we might need manual recovery or rely on timestamps, but for most immediate cases this is safe.
</file>

<file path="frontend/migrations/26_fix_buyer_seller_visibility.sql">
-- Migration: Fix Buyer/Seller Visibility in Persistent ID Model
-- Ensures Buyers can see items they are purchasing and Sellers see all sold items.
-- 1. Listing Items RLS for Buyers
-- Allow buyers of an active order to view the physical card details.
-- This is necessary because the card's seller_id hasn't updated to them yet in transit.
DROP POLICY IF EXISTS "Buyers can view items in transit" ON public.listing_items;
CREATE POLICY "Buyers can view items in transit" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
-- 2. Ensure Sellers can view items they ever sold (via associated order)
-- (Already in 25, but re-affirming or ensuring it works with any order status)
DROP POLICY IF EXISTS "Sellers can view sold history" ON public.listing_items;
CREATE POLICY "Sellers can view sold history" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
-- 3. Comprehensive Data Backfill
-- Ensure every order has a seller_id populated from the listing's perspective at that time.
-- This is critical for RLS 'auth.uid() = seller_id' to work safely.
DO $$ BEGIN
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL;
END $$;
</file>

<file path="frontend/migrations/27_fix_rls_recursion.sql">
-- Migration: Mandatory RLS Purge & Recursion Break
-- This migration dynamically finds and drops EVERY policy on orders and listing_items
-- before setting up clean, non-recursive rules. This is the guaranteed fix.
DO $$
DECLARE pol RECORD;
BEGIN -- 1. Dynamically drop all existing policies on relevant tables
FOR pol IN (
    SELECT policyname,
        tablename
    FROM pg_policies
    WHERE schemaname = 'public'
        AND tablename IN ('listing_items', 'orders')
) LOOP EXECUTE format(
    'DROP POLICY IF EXISTS %I ON %I',
    pol.policyname,
    pol.tablename
);
END LOOP;
END $$;
-- 2. Orders Re-definition (Non-Recursive)
-- Use ONLY direct column checks. NO JOINS.
CREATE POLICY "Orders_Buyer_Access" ON public.orders FOR
SELECT USING (buyer_id = auth.uid());
CREATE POLICY "Orders_Seller_Access" ON public.orders FOR
SELECT USING (seller_id = auth.uid());
-- 3. Listing Items Re-definition
-- A. Public (No Join)
CREATE POLICY "Listings_Public_Access" ON public.listing_items FOR
SELECT USING (status = 'Active');
-- B. Owner (No Join)
CREATE POLICY "Listings_Owner_Access" ON public.listing_items FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
-- C. Historical Seller & Transit Buyer (Checks orders)
-- This is now SAFE because orders policies have zero dependencies.
CREATE POLICY "Listings_SoldHistory_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
CREATE POLICY "Listings_InTransit_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
</file>

<file path="frontend/migrations/28_restore_mutation_rls.sql">
-- Migration: Restore Insert/Update RLS Policies
-- Migration 27 purged everything to break recursion. Now we restore necessary mutation access.
-- 1. Orders Mutation Policies
-- Allow buyers to create their own orders
DROP POLICY IF EXISTS "Orders_Buyer_Insert" ON public.orders;
CREATE POLICY "Orders_Buyer_Insert" ON public.orders FOR
INSERT WITH CHECK (auth.uid() = buyer_id);
-- Allow buyers to update their own pending orders (e.g. shipping info, snapshot refresh)
DROP POLICY IF EXISTS "Orders_Buyer_Update" ON public.orders;
CREATE POLICY "Orders_Buyer_Update" ON public.orders FOR
UPDATE USING (auth.uid() = buyer_id) WITH CHECK (auth.uid() = buyer_id);
-- 2. Listing Items Mutation Policies
-- Allow users to create new listings
DROP POLICY IF EXISTS "Listings_Owner_Insert" ON public.listing_items;
CREATE POLICY "Listings_Owner_Insert" ON public.listing_items FOR
INSERT WITH CHECK (auth.uid() = seller_id);
-- Allow owners to update/delete their own items
DROP POLICY IF EXISTS "Listings_Owner_Update" ON public.listing_items;
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
DROP POLICY IF EXISTS "Listings_Owner_Delete" ON public.listing_items;
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
</file>

<file path="frontend/migrations/29_fix_workspace_visibility.sql">
-- Migration: Fix Workspace Visibility for Purchased Items
-- Status 'Completed' (old) or 'Draft' (new) should allow entry into Workspace.
-- Also updates complete_order RPC to set status to 'Draft' for new owner.
-- 1. Update the RPC to use 'Draft' (Owner Default) instead of 'Completed' (Transaction End)
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN -- Update listing status to Draft (makes it ownable/visible in Workspace but not listed)
UPDATE listing_items
SET status = 'Draft'
WHERE id = p_listing_id;
-- Update order status to completed
UPDATE orders
SET status = 'completed'
WHERE listing_id = p_listing_id;
END;
$$;
-- 2. Backfill existing 'Completed' items to 'Draft' to fix visibility for previous tests
UPDATE public.listing_items
SET status = 'Draft'
WHERE status = 'Completed';
</file>

<file path="frontend/migrations/30_self_healing_complete_order.sql">
-- Migration: Self-Healing complete_order RPC & Backfill
-- 2025-12-23: Ensure ownership transfer occurs even if webhook fails.
-- This RPC is triggered by markAsReceived (Buyer Action).
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE v_buyer_id uuid;
BEGIN -- 1. Find the buyer ID from the most recent order for this listing.
SELECT buyer_id INTO v_buyer_id
FROM orders
WHERE listing_id = p_listing_id
ORDER BY created_at DESC
LIMIT 1;
-- 2. Update listing status and FORCE ownership transfer to the buyer.
UPDATE listing_items
SET status = 'Draft',
    seller_id = COALESCE(v_buyer_id, seller_id),
    updated_at = NOW()
WHERE id = p_listing_id;
-- 3. Mark the order as completed.
UPDATE orders
SET status = 'completed',
    completed_at = NOW()
WHERE listing_id = p_listing_id
    AND status != 'completed';
END;
$$;
-- 4. Backfill existing 'Draft' or 'Completed' items that SHOULD be owned by the buyer
-- Fixes items that stuck in 'zombie' state (owned by seller but transaction finished)
UPDATE listing_items li
SET seller_id = o.buyer_id
FROM orders o
WHERE li.id = o.listing_id
    AND o.status = 'completed'
    AND li.seller_id = o.seller_id;
-- Only if owner is still the original seller
</file>

<file path="frontend/migrations/31_allow_multiple_orders_per_listing.sql">
-- Migration: Allow Multiple Orders per Listing (Persistent ID Support)
-- 2025-12-23: Remove absolute unique constraint and replace with partial unique index.
-- 1. Identify and Drop the existing unique constraint if it exists.
-- The name might be orders_listing_id_key (standard Postgres naming).
ALTER TABLE public.orders DROP CONSTRAINT IF EXISTS orders_listing_id_key;
-- 2. Create a Partial Unique Index.
-- This allows multiple COMPLETED or CANCELLED orders for the same item (buy/sell history),
-- but ensures only ONE active/pending transaction can exist at any given time.
CREATE UNIQUE INDEX IF NOT EXISTS unique_active_order_per_listing ON public.orders (listing_id)
WHERE (status NOT IN ('completed', 'cancelled'));
-- 3. Comment for clarity
COMMENT ON INDEX unique_active_order_per_listing IS 'Ensures only one active transaction per item, while allowing historical orders to coexist.';
</file>

<file path="frontend/migrations/32_setup_storage.sql">
-- Create a new storage bucket for card images
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true) on conflict (id) do nothing;
-- Set up access policies for the storage bucket
-- 1. Allow public read access to the bucket
create policy "Public Access" on storage.objects for
select using (bucket_id = 'card-images');
-- 2. Allow authenticated users to upload images
create policy "Authenticated users can upload images" on storage.objects for
insert with check (
        bucket_id = 'card-images'
        and auth.role() = 'authenticated'
    );
-- 3. Allow users to update/delete their own images
create policy "Users can update own images" on storage.objects for
update using (
        bucket_id = 'card-images'
        and auth.uid() = owner
    );
create policy "Users can delete own images" on storage.objects for delete using (
    bucket_id = 'card-images'
    and auth.uid() = owner
);
</file>

<file path="frontend/migrations/33_add_image_url_to_live_moments.sql">
-- Migration: Add image_url to live_moments
-- id: 33_add_image_url_to_live_moments
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS image_url text;
</file>

<file path="frontend/migrations/34_add_fee_columns_to_orders.sql">
-- 取引ごとの手数料情報を記録するカラムを追加
-- fee_rate: 適用された手数料率（0.10 = 10%）。キャンペーン時に変動可能。
-- platform_fee: 実際に控除された手数料額（円）
-- net_earnings: 売り手の純収益（total_amount - platform_fee）
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS fee_rate numeric(5, 4) DEFAULT 0.10,
    ADD COLUMN IF NOT EXISTS platform_fee integer DEFAULT 0,
    ADD COLUMN IF NOT EXISTS net_earnings integer DEFAULT 0;
COMMENT ON COLUMN public.orders.fee_rate IS '適用された手数料率。例: 0.10 = 10%, 0.05 = 5%キャンペーン';
COMMENT ON COLUMN public.orders.platform_fee IS 'プラットフォーム手数料額（円）';
COMMENT ON COLUMN public.orders.net_earnings IS '出品者の純収益（total_amount - platform_fee）';
-- 既存の完了済み注文をバックフィル（現行の10%ルールで埋める）
UPDATE public.orders
SET fee_rate = 0.10,
    platform_fee = FLOOR(total_amount * 0.10),
    net_earnings = total_amount - FLOOR(total_amount * 0.10)
WHERE status = 'completed'
    AND net_earnings = 0;
</file>

<file path="frontend/migrations/debug_helper.sql">
-- Migration: Debug Helper (Expose Policies)
-- Creates an RPC to list policies for debugging purposes.
CREATE OR REPLACE FUNCTION get_policies_debug() RETURNS TABLE (
        tablename text,
        policyname text,
        definition text
    ) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT p.tablename::text,
    p.policyname::text,
    p.definition::text
FROM pg_policies p
WHERE p.schemaname = 'public';
END;
$$;
</file>

<file path="frontend/migrations/debug_indexes.sql">
-- Migration: Debug Helper (Expose Indexes)
-- Creates an RPC to list indexes for debugging purposes.
CREATE OR REPLACE FUNCTION get_indexes_debug(p_table_name text) RETURNS TABLE (index_name text, index_definition text) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT i.indexname::text,
    i.indexdef::text
FROM pg_indexes i
WHERE i.tablename = p_table_name
    AND i.schemaname = 'public';
END;
$$;
</file>

<file path="frontend/migrations/debug_triggers.sql">
-- Migration: Debug Helper (Expose Triggers)
-- Creates an RPC to list triggers for debugging purposes.
CREATE OR REPLACE FUNCTION get_triggers_debug() RETURNS TABLE (
        trigger_name text,
        event_manipulation text,
        event_object_table text,
        action_statement text
    ) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT t.trigger_name::text,
    t.event_manipulation::text,
    t.event_object_table::text,
    t.action_statement::text
FROM information_schema.triggers t
WHERE t.event_object_schema = 'public';
END;
$$;
</file>

<file path="frontend/migrations/fix_schema_add_condition_rating.sql">
-- Comprehensive Fix: Add ALL potentially missing columns from Migration 04 AND 05

-- 1. Migration 04 Columns (Features & Condition)
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS variation text,
ADD COLUMN IF NOT EXISTS serial_number text,
ADD COLUMN IF NOT EXISTS is_rookie boolean default false,
ADD COLUMN IF NOT EXISTS is_autograph boolean default false,
ADD COLUMN IF NOT EXISTS description text,
ADD COLUMN IF NOT EXISTS condition_rating text;

-- 2. Migration 05 Columns (Basic Info & Decoupling)
ALTER TABLE public.listing_items ALTER COLUMN catalog_id DROP NOT NULL;

ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS player_name text,
ADD COLUMN IF NOT EXISTS team text,
ADD COLUMN IF NOT EXISTS year integer,
ADD COLUMN IF NOT EXISTS manufacturer text; -- This was the missing one reported

-- 3. Comments
COMMENT ON COLUMN public.listing_items.condition_rating IS 'Condition string for raw cards';
COMMENT ON COLUMN public.listing_items.manufacturer IS 'Brand/Manufacturer of the card';

-- 4. Force a schema cache reload
NOTIFY pgrst, 'reload schema';
</file>

<file path="frontend/migrations/production_setup.sql">
-- ======================================================================================
-- PRODUCTION DATABASE SETUP SCRIPT
-- Application: TC-APP (Trading Card App)
-- Generated at: 2026-01-27
--
-- This script consolidates all schema definitions, migrations, and RLS policies.
-- It is designed to be run on a FRESH Supabase instance.
-- ======================================================================================
-- 1. EXTENSIONS
create extension if not exists "uuid-ossp";
-- 2. ENUMS (Initial Definition)
create type manufacturer_enum as enum ('BBM', 'Calbee', 'Epoch', 'Topps_Japan', 'Topps');
create type team_enum as enum (
    'Giants',
    'Tigers',
    'Dragons',
    'Swallows',
    'Carp',
    'BayStars',
    'Hawks',
    'Fighters',
    'Marines',
    'Buffaloes',
    'Eagles',
    'Lions',
    'Dodgers'
);
create type rarity_enum as enum (
    'Common',
    'Rare',
    'Super Rare',
    'Parallel',
    'Autograph',
    'Patch',
    'Rookie',
    'Legend'
);
create type listing_status_enum as enum (
    'Draft',
    'Active',
    'TransactionPending',
    'AwaitingShipment',
    'Shipped',
    'Delivered',
    'Completed',
    'Cancelled'
);
-- Update Enum: Add 'Display', 'Sold', 'Incoming' (from update_status_enum.sql & migration 23)
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Display';
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Sold';
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Incoming';
-- 3. PROFILES Table
create table public.profiles (
    id uuid references auth.users on delete cascade not null primary key,
    email text unique not null,
    name text,
    avatar_url text,
    real_name_kana text,
    -- Added from migration 08
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);
alter table public.profiles enable row level security;
create policy "Public profiles are viewable by everyone." on public.profiles for
select using (true);
create policy "Users can insert their own profile." on public.profiles for
insert with check (auth.uid() = id);
create policy "Users can update their own profile." on public.profiles for
update using (auth.uid() = id);
-- 4. CARD CATALOGS (Deprecated but kept for reference if needed, largely replaced by loose listing items)
create table public.card_catalogs (
    id uuid default uuid_generate_v4() primary key,
    manufacturer manufacturer_enum not null,
    series_name text,
    player_name text not null,
    team team_enum not null,
    card_number text,
    rarity rarity_enum,
    is_rookie boolean default false,
    year integer,
    created_at timestamptz default now()
);
alter table public.card_catalogs enable row level security;
create policy "Catalog is viewable by everyone." on public.card_catalogs for
select using (true);
-- 5. LISTING ITEMS (Products)
create table public.listing_items (
    id uuid default uuid_generate_v4() primary key,
    catalog_id uuid references public.card_catalogs(id),
    -- Nullable in new schema (migration 05)
    seller_id uuid references public.profiles(id) not null,
    status listing_status_enum default 'Draft'::listing_status_enum not null,
    price integer,
    -- Nullable (migration update_status_enum.sql)
    images jsonb not null,
    condition_grading jsonb not null,
    -- Additional columns from migrations
    origin_order_id uuid,
    -- migration 22 (Recursive references added later)
    deleted_at timestamptz DEFAULT NULL,
    -- migration 21
    moment_history jsonb DEFAULT '[]'::jsonb,
    -- migration 16
    -- Expanded columns (migration 04 consolidated)
    player_name text,
    team text,
    year integer,
    manufacturer text,
    set_name text,
    card_number text,
    is_rookie boolean default false,
    is_autograph boolean default false,
    start_price integer,
    min_bid_price integer,
    condition_rating text,
    -- migration fix_schema
    variation text,
    serial_number text,
    description text,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);
-- Note: references for origin_order_id will be added after orders table creation
-- 6. ORDERS (Transaction History)
create table public.orders (
    id uuid default uuid_generate_v4() primary key,
    listing_id uuid references public.listing_items(id) not null,
    -- Unique constraint removed/modified in migration 31
    buyer_id uuid references public.profiles(id) not null,
    seller_id uuid references public.profiles(id),
    -- migration 24
    payment_method_id text not null,
    total_amount integer not null,
    status text not null check (
        status IN (
            'pending',
            'paid',
            'awaiting_shipping',
            'shipped',
            'completed',
            'cancelled',
            'returned'
        )
    ),
    -- migration 12
    -- Shipping Details (migration 09 & 12)
    tracking_number text,
    carrier text,
    shipped_at timestamptz,
    completed_at timestamptz,
    shipping_address_snapshot jsonb,
    shipping_name text,
    shipping_postal_code text,
    shipping_address text,
    shipping_phone text,
    -- Live Moments (migration 15)
    moment_snapshot jsonb,
    created_at timestamptz default now()
);
-- Add Circular Reference for listing_items
ALTER TABLE public.listing_items
ADD CONSTRAINT fk_origin_order FOREIGN KEY (origin_order_id) REFERENCES public.orders(id);
-- 7. BANK ACCOUNTS & PAYOUTS (migration 08 & 10 & 11)
CREATE TABLE IF NOT EXISTS public.bank_accounts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    bank_name text NOT NULL,
    branch_name text NOT NULL,
    account_type text NOT NULL,
    account_number text NOT NULL,
    account_holder_name text NOT NULL,
    bank_code text,
    -- migration 10
    branch_code text,
    -- migration 10
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);
CREATE TABLE IF NOT EXISTS public.payouts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    amount integer NOT NULL,
    fee integer not null default 0,
    -- migration 11
    payout_amount integer not null,
    -- migration 11
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz DEFAULT now(),
    processed_at timestamptz
);
-- 8. LIVE MOMENTS (migration 14, 17, 18)
create table if not exists public.live_moments (
    id uuid default gen_random_uuid() primary key,
    player_name text not null,
    title text not null,
    description text,
    intensity integer not null default 1 check (
        intensity >= 1
        and intensity <= 5
    ),
    match_result text,
    -- migration 17
    is_finalized boolean DEFAULT false,
    -- migration 18
    created_at timestamptz default now()
);
-- 9. INDICES
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Partial index from migration 31
CREATE UNIQUE INDEX IF NOT EXISTS unique_active_order_per_listing ON public.orders (listing_id)
WHERE (status NOT IN ('completed', 'cancelled'));
-- 10. ROW LEVEL SECURITY (Consolidated Final Policies - Migration 27 & 32 mostly)
-- A. Table Enablement
ALTER TABLE public.listing_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bank_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.live_moments ENABLE ROW LEVEL SECURITY;
-- B. Listings Policies (Non-Recursive)
-- Public Access
CREATE POLICY "Listings_Public_Access" ON public.listing_items FOR
SELECT USING (
        status = 'Active'
        AND deleted_at IS NULL
    );
-- Owner Access
CREATE POLICY "Listings_Owner_Access" ON public.listing_items FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (seller_id = auth.uid());
-- Transaction History Access (Sold & Bought)
CREATE POLICY "Listings_SoldHistory_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
CREATE POLICY "Listings_InTransit_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
-- C. Orders Policies
CREATE POLICY "Orders_Buyer_Access" ON public.orders FOR
SELECT USING (buyer_id = auth.uid());
CREATE POLICY "Orders_Seller_Access" ON public.orders FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Users can create orders" ON public.orders FOR
INSERT WITH CHECK (auth.uid() = buyer_id);
-- D. Bank & Payouts Policies
CREATE POLICY "Users can view own bank account" ON public.bank_accounts FOR
SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own bank account" ON public.bank_accounts FOR
INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own bank account" ON public.bank_accounts FOR
UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own bank account" ON public.bank_accounts FOR DELETE USING (auth.uid() = user_id);
CREATE POLICY "Users can view own payouts" ON public.payouts FOR
SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own payouts" ON public.payouts FOR
INSERT WITH CHECK (auth.uid() = user_id);
-- E. Live Moments Policies
CREATE POLICY "Live moments are viewable by everyone" on public.live_moments for
select using (true);
-- 11. STORAGE SETUP (Migration 32)
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true) on conflict (id) do nothing;
create policy "Public Access" on storage.objects for
select using (bucket_id = 'card-images');
create policy "Authenticated users can upload images" on storage.objects for
insert with check (
        bucket_id = 'card-images'
        and auth.role() = 'authenticated'
    );
create policy "Users can update own images" on storage.objects for
update using (
        bucket_id = 'card-images'
        and auth.uid() = owner
    );
create policy "Users can delete own images" on storage.objects for delete using (
    bucket_id = 'card-images'
    and auth.uid() = owner
);
-- 12. TRIGGERS & FUNCTIONS
-- Handle New User
create or replace function public.handle_new_user() returns trigger as $$ begin
insert into public.profiles (id, email, name)
values (
        new.id,
        new.email,
        new.raw_user_meta_data->>'name'
    );
return new;
end;
$$ language plpgsql security definer;
create trigger on_auth_user_created
after
insert on auth.users for each row execute procedure public.handle_new_user();
-- Self-Healing Complete Order (Migration 30)
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN -- Update listing status to Draft (makes it ownable/visible in Workspace but not listed)
UPDATE listing_items
SET status = 'Draft',
    updated_at = NOW()
WHERE id = p_listing_id;
-- Update order status to completed
UPDATE orders
SET status = 'completed',
    completed_at = NOW()
WHERE listing_id = p_listing_id;
END;
$$;
</file>

<file path="frontend/migrations/reset_data.sql">
-- Clean up data to reset environment
-- Run this in Supabase Dashboard SQL Editor
-- 1. Truncate Transaction Tables (Cascade to ensure dependent data is removed)
-- Note: 'messages' and 'notifications' omitted as they do not exist in current schema on staging.
-- If you added them manually, uncomment lines below:
-- TRUNCATE TABLE messages RESTART IDENTITY CASCADE;
-- TRUNCATE TABLE notifications RESTART IDENTITY CASCADE;
TRUNCATE TABLE orders RESTART IDENTITY CASCADE;
TRUNCATE TABLE listing_items RESTART IDENTITY CASCADE;
TRUNCATE TABLE live_moments RESTART IDENTITY CASCADE;
TRUNCATE TABLE payouts RESTART IDENTITY CASCADE;
-- Note: We generally do NOT delete auth.users to avoid breaking login sessions.
-- The seed script will check if users exist and reuse them if possible.
</file>

<file path="frontend/migrations/Untitled-3">

</file>

<file path="frontend/migrations/Untitled-4">
u
</file>

<file path="frontend/migrations/Untitled-5">

</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/test.html">
<!DOCTYPE html>
<html>
<body>
<h1>Vercel Test</h1>
<p>If you can see this, Vercel is serving static files correctly.</p>
</body>
</html>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/scripts/debug_14fb.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = '14fb9a60-8492-4969-893b-2e8c1668b48c';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        console.log('Listing Data:', order.listing ? 'Found' : 'MISSING');
        if (order.listing) {
            const l = Array.isArray(order.listing) ? order.listing[0] : order.listing;
            console.log(`Listing ID: ${l.id}, Player: ${l.player_name}`);
        }

        // 2. Check for Pinpoint Item
        const { data: pinItems } = await supabase
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', orderId);

        console.log(`Pinpoint Items found: ${pinItems?.length}`);
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_7575.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = '7575e260-6772-487b-83ea-e140e09c680a';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        // 2. Check for Pinpoint Item (origin_order_id)
        const { data: pinItems, error: pinError } = await supabase
            .from('listing_items')
            .select('id, origin_order_id, status, seller_id')
            .eq('origin_order_id', orderId);

        if (pinError) console.error('❌ Pinpoint Query Error:', pinError);
        console.log('Pinpoint Items found:', pinItems);

        // 3. Check for Fuzzy/Recent items for this buyer
        const { data: fuzzyItems } = await supabase
            .from('listing_items')
            .select('id, player_name, created_at, origin_order_id')
            .eq('seller_id', order.buyer_id)
            .order('created_at', { ascending: false })
            .limit(3);

        console.log('Recent Items for Buyer:', fuzzyItems);
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_c376.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = 'c376ca76-cd87-47af-93ed-2ab0f7dd7a86';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        // Log Listing Details
        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (listing) {
            console.log(`Original Listing: ${listing.id}, Status: ${listing.status}`);
        } else {
            console.log('❌ Original Listing MISSING or null');
        }

        // 2. Check for Pinpoint Item
        const { data: pinItems, error } = await supabase
            .from('listing_items')
            .select('id, origin_order_id, seller_id, status, deleted_at')
            .eq('origin_order_id', orderId);

        if (error) console.error("Query Error:", error);

        console.log(`Pinpoint Items found: ${pinItems?.length}`);
        if (pinItems && pinItems.length > 0) {
            pinItems.forEach(i => {
                console.log(`Item: ${i.id}, Seller: ${i.seller_id}, Origin: ${i.origin_order_id}, Status: ${i.status}`);
                console.log(`Match? Seller=${order.buyer_id === i.seller_id}, Origin=${orderId === i.origin_order_id}`);
            });
        }
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_moments.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function check() {
    console.log('--- FETCHING LATEST ORDERS for Roki Sasaki ---');
    const { data: orders } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .order('created_at', { ascending: false })
        .limit(5);

    for (const order of (orders || [])) {
        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (!listing || !listing.player_name.includes('Roki')) continue;

        console.log(`\nOrder ID: ${order.id}`);
        console.log(`Order Moment Snapshot: ${order.moment_snapshot?.title} (ID: ${order.moment_snapshot?.id})`);

        if (listing) {
            console.log(`Original Listing: ${listing.id}`);
            console.log('Original History:');
            listing.moment_history?.forEach((h: any, idx: number) => {
                console.log(`  [${idx}] ${h.title} (MomentID: ${h.moment_id})`);
            });
        }

        // Check Buyer Clone
        const { data: buyerItem } = await supabase
            .from('listing_items')
            .select('id, moment_history, seller_id')
            .eq('origin_order_id', order.id)
            .single();

        if (buyerItem) {
            console.log(`Buyer Clone Found: ${buyerItem.id}`);
            console.log('Moment History:');
            buyerItem.moment_history?.forEach((h: any, idx: number) => {
                console.log(`  [${idx}] ${h.title} (MomentID: ${h.moment_id}) - Author: ${h.owner_at_time}`);
            });
        } else {
            console.log('Buyer Clone MISSING');
        }
    }
}
check();
</file>

<file path="frontend/scripts/fix_sakamoto.ts">
import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import path from 'path';

// Load env from frontend/.env.local because that's where the new secret is (and likely other configs)
// Load env from .env.local in frontend root
dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase credentials');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function main() {
    console.log('Searching for Sakamoto moment...');

    const { data: moments, error } = await supabase
        .from('live_moments')
        .select('*')
        .ilike('player_name', '%坂本%')
        .ilike('title', '%2000%');

    if (error) {
        console.error('Error fetching moments:', error);
        return;
    }

    if (!moments || moments.length === 0) {
        console.log('No matching moment found.');
        return;
    }

    console.log(`Found ${moments.length} moment(s).`);

    for (const m of moments) {
        console.log(`Updating Moment: ${m.title} (${m.id})`);
        console.log(`Current Result: ${m.match_result}`);

        // Regex to replace content inside parentheses with '9回裏'
        // Or simply replace "Top 1st" if present.
        // User wants "9回裏".
        let newResult = m.match_result;

        // Strategy: Replace the text inside the last parentheses
        if (newResult.includes('(') && newResult.includes(')')) {
            newResult = newResult.replace(/\([^)]+\)$/, '(9回裏)');
        } else {
            // Append if not present?
            newResult = `${newResult} (9回裏)`;
        }

        console.log(`New Result: ${newResult}`);

        // Update live_moments
        const { error: updateError } = await supabase
            .from('live_moments')
            .update({ match_result: newResult })
            .eq('id', m.id);

        if (updateError) {
            console.error('Failed to update live_moments:', updateError);
        } else {
            console.log('✅ live_moments updated.');
        }

        // Also update history in listing_items (Sync)
        // Similar logic to finalizeMoment
        const { data: items, error: fetchError } = await supabase
            .from('listing_items')
            .select('id, moment_history')
            .contains('moment_history', JSON.stringify([{ moment_id: m.id }]));

        if (items && items.length > 0) {
            console.log(`Syncing ${items.length} cards...`);
            for (const item of items) {
                const history = item.moment_history as any[];
                const updatedHistory = history.map(h => {
                    if (h.moment_id === m.id) {
                        return { ...h, match_result: newResult };
                    }
                    return h;
                });

                await supabase
                    .from('listing_items')
                    .update({ moment_history: updatedHistory })
                    .eq('id', item.id);
            }
            console.log('✅ Cards synced.');
        }
    }
}

main();
</file>

<file path="frontend/scripts/seed.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';
import { randomUUID } from 'crypto';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// --- CONFIG ---
const TEST_USERS = [
    {
        email: 'seller@test.com',
        password: 'password123',
        name: 'Test Seller',
        address: {
            postal_code: '100-0005', address_line1: 'Tokyo Chiyoda-ku', address_line2: 'Marunouchi 1-1', phone_number: '090-1111-1111',
            display_name: 'Seller-san',
            first_name: 'Taro',
            last_name: 'Yamada'
        }
    },
    {
        email: 'buyer1@test.com',
        password: 'password123',
        name: 'Test Buyer 1',
        address: {
            postal_code: '530-0001', address_line1: 'Osaka Kita-ku', address_line2: 'Umeda 1-1', phone_number: '080-2222-2222',
            display_name: 'Buyer-kun 1',
            first_name: 'Jiro',
            last_name: 'Suzuki'
        }
    },
    {
        email: 'buyer2@test.com',
        password: 'password123',
        name: 'Test Buyer 2',
        address: {
            postal_code: '460-0008', address_line1: 'Aichi Nagoya-shi Naka-ku', address_line2: 'Sakae 3-5-12', phone_number: '070-3333-3333',
            display_name: 'Buyer-chan 2',
            first_name: 'Hanako',
            last_name: 'Sato'
        }
    },
];

const PLAYERS = [
    { name: 'Roki Sasaki', team: 'Marines', number: 17 },
    { name: 'Shohei Ohtani', team: 'Dodgers', number: 17 },
    { name: 'Munetaka Murakami', team: 'Swallows', number: 55 },
];

async function seed() {
    console.log('🌱 Starting Seed...');

    // 1. Create Users
    console.log('--- Creating Users ---');
    const userMap: Record<string, string> = {}; // email -> id

    for (const u of TEST_USERS) {
        const { data: { users } } = await supabase.auth.admin.listUsers();
        const existing = users.find(user => user.email === u.email);

        if (existing) {
            console.log(`User ${u.email} already exists: ${existing.id}`);
            userMap[u.email] = existing.id;
        } else {
            console.log(`Creating user ${u.email}...`);
            const { data, error } = await supabase.auth.admin.createUser({
                email: u.email,
                password: u.password,
                email_confirm: true,
                user_metadata: { full_name: u.name }
            });
            if (error) {
                console.error(`Failed to create ${u.email}:`, error.message);
            } else if (data.user) {
                userMap[u.email] = data.user.id;
            }
        }

        // Update Profile with Address
        if (userMap[u.email]) {
            const { error: pError } = await supabase
                .from('profiles')
                .update(u.address)
                .eq('id', userMap[u.email]);

            if (pError) console.error(`Failed to update profile for ${u.email}:`, pError.message);
            else console.log(`Updated profile address for ${u.email}`);
        }
    }

    const sellerId = userMap['seller@test.com'];
    const buyer1Id = userMap['buyer1@test.com'];
    const buyer2Id = userMap['buyer2@test.com'];

    if (!sellerId || !buyer1Id) {
        console.error('Failed to setup users');
        return;
    }

    // 3. Create Live Moments
    console.log('--- Creating Live Moments ---');
    const momentIds: string[] = [];
    const momentTemplates = [
        { title: '165km/h Fastball Info', desc: 'Japanese Record Speed!', intensity: 5, status: 'finalized', type: 'RECORD_BREAK' },
        { title: 'Dramatic Walk-off HR', desc: 'Bottom of the 9th, 2 outs.', intensity: 5, status: 'finalized', type: 'HOMERUN' },
        { title: 'Spectacular Diving Catch', desc: 'Saved the game!', intensity: 4, status: 'finalized', type: 'BIG_PLAY' },
        { title: '3000th Strikeout', desc: 'Legendary achievement.', intensity: 5, status: 'live', type: 'BIG_PLAY' }, // Active
        { title: 'Perfect Game Bid', desc: '8th inning completed.', intensity: 5, status: 'live', type: 'BIG_PLAY' }
    ];

    for (const t of momentTemplates) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];
        const { data: moment, error } = await supabase.from('live_moments').insert({
            title: `${player.name}: ${t.title}`,
            description: t.desc,
            player_name: player.name,
            intensity: t.intensity,
            is_finalized: t.status === 'finalized',
            match_result: t.status === 'finalized' ? 'WIN 3-2' : undefined,
            type: t.type
        }).select().single();

        if (error) console.error('Moment error:', error.message);
        else if (moment) {
            momentIds.push(moment.id);
            console.log(`Created moment: ${moment.id} (${t.title})`);
        }
    }

    // 4. Create Listings (Active)
    console.log('--- Creating Active Listings ---');
    const listingIds: string[] = [];

    for (let i = 0; i < 10; i++) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];
        const price = (Math.floor(Math.random() * 50) + 1) * 1000; // 1000 - 50000

        const { data: item, error } = await supabase.from('listing_items').insert({
            seller_id: sellerId,
            player_name: player.name,
            team: player.team,
            series_name: '2025 Legend Series',
            card_number: `LS-${String(i).padStart(3, '0')}`,
            price: price,
            status: 'Active',
            images: [`https://placehold.co/400x600/202020/FFF?text=${encodeURIComponent(player.name)}`],
            description: `Seeded Item #${i}. Mint condition.`,
            condition_grading: 'Gem Mint 10',
            condition_rating: 10,
            year: 2025,
            manufacturer: 'Stadium Card',
            is_live_moment: Math.random() > 0.5,
            moment_history: [] // Initially empty
        }).select().single();

        if (error) console.error('Listing error:', error.message);
        else if (item) listingIds.push(item.id);
    }

    // 5. Create Sold Listings & Orders (History)
    console.log('--- Creating Sold History ---');
    for (let i = 0; i < 3; i++) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];

        // Original Listing (Sold)
        const { data: original, error: lError } = await supabase.from('listing_items').insert({
            seller_id: sellerId,
            player_name: player.name,
            price: 5000,
            status: 'Completed', // Sold
            images: [`https://placehold.co/400x600/333/FFF?text=SOLD-${i}`],
            description: `Sold Item #${i}`,
            moment_history: []
        }).select().single();

        if (original) {
            // Buyer Item (Clone)
            const { data: item, error: cError } = await supabase.from('listing_items').insert({
                seller_id: buyer1Id,
                player_name: player.name,
                price: 0,
                status: 'Draft',
                moment_history: [
                    // Add a seeded memory
                    {
                        moment_id: momentIds[0] || 'seed-moment',
                        title: 'Seeded Memory',
                        timestamp: new Date().toISOString(),
                        memories: [
                            {
                                id: randomUUID(),
                                author_id: sellerId,
                                author_name: 'Test Seller',
                                text: 'Thank you for buying!',
                                created_at: new Date(Date.now() - 86400000).toISOString(),
                                is_hidden: false
                            },
                            {
                                id: randomUUID(),
                                author_id: buyer1Id,
                                author_name: 'Test Buyer 1',
                                text: 'Testing memory timeline array!',
                                created_at: new Date().toISOString(),
                                is_hidden: false
                            }
                        ]
                    }
                ]
            }).select().single();

            // Order Record
            if (item) {
                await supabase.from('orders').insert({
                    listing_id: original.id,
                    buyer_id: buyer1Id,
                    seller_id: sellerId, // Fix: Explicitly set seller_id
                    status: 'completed',
                    total_amount: 5000,
                    stripe_payment_intent_id: `pi_seed_${i}`,
                    shipping_address: { postal_code: "000-0000", line1: "Test City" }
                });
                console.log(`Created sold history for ${original.id}`);
            }
        }
    }

    console.log('✅ Seed Complete!');
}

seed().catch(e => console.error(e));
</file>

<file path="frontend/scripts/simulate_action.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function simulateAction() {
    const orderId = 'c376ca76-cd87-47af-93ed-2ab0f7dd7a86';
    console.log(`--- Simulating getBuyerItemByOrder for ${orderId} ---`);

    // 1. Get Order & Buyer
    const { data: order, error: oErr } = await supabaseAdmin
        .from('orders')
        .select('listing_id, buyer_id, created_at, status, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (oErr || !order) {
        console.error("Step 1 Failed: Order not found or ambiguous.", oErr);
        return;
    }
    console.log(`Step 1 Success: Order found. Buyer ID: ${order.buyer_id}`);

    const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    // Simulate Auto-Recovery Insert
    console.log("\n--- Testing Auto-Recovery Insert ---");
    const payload = {
        player_name: listing.player_name,
        team: listing.team,
        year: listing.year,
        manufacturer: listing.manufacturer,
        series_name: listing.series_name,
        card_number: listing.card_number,
        images: listing.images,
        condition_grading: listing.condition_grading,
        condition_rating: listing.condition_rating,
        variation: listing.variation,
        serial_number: listing.serial_number,
        is_rookie: listing.is_rookie,
        is_autograph: listing.is_autograph,
        description: listing.description,
        is_live_moment: listing.is_live_moment,
        seller_id: order.buyer_id, // Current User is Buyer
        status: 'Draft',
        price: 0,
        origin_order_id: orderId,
        moment_history: listing.moment_history || []
    };

    const { data: recoveredItem, error: recoveryError } = await supabaseAdmin
        .from('listing_items')
        .insert(payload)
        .select('id')
        .single();

    if (recoveryError) {
        console.error("❌ Insert Failed:", recoveryError);
        console.log("Payload:", payload);
    } else {
        console.log("✅ Insert Success:", recoveredItem.id);
    }
}

simulateAction();
</file>

<file path="frontend/scripts/test-gemini.ts">
import { config } from 'dotenv';
import path from 'path';

// Load env from frontend/.env.local (assuming that's where keys are)
// We need to resolve the path relative to where we run the script
// If running from root, path is frontend/.env.local
config({ path: path.resolve(process.cwd(), 'frontend/.env.local') });

const apiKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY;

if (!apiKey) {
    console.error('❌ GOOGLE_GENERATIVE_AI_API_KEY is missing from process.env');
    process.exit(1);
}

console.log('🔑 API Key found:', apiKey.slice(0, 5) + '...');

async function listModels() {
    const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
            console.error('❌ API Error:', data.error);
            return;
        }

        if (data.models) {
            console.log('✅ Available Models:');
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            data.models.forEach((m: any) => {
                // Filter for likely candidates
                if (m.name.includes('gemini')) {
                    console.log(`- ${m.name} (${m.supportedGenerationMethods})`);
                }
            });
        } else {
            console.log('⚠️ No models returned.', data);
        }

    } catch (e) {
        console.error('❌ Network/Fetch Error:', e);
    }
}

listModels();
</file>

<file path="frontend/types/index.ts">
export type Manufacturer = "BBM" | "Calbee" | "Epoch" | "Topps_Japan";
export type Team = "Giants" | "Tigers" | "Dragons" | "Swallows" | "Carp" | "BayStars" | "Hawks" | "Fighters" | "Marines" | "Buffaloes" | "Eagles" | "Lions" | "SamuraiJapan" | "Other";
export type Rarity = "Common" | "Rare" | "Super Rare" | "Parallel" | "Autograph" | "Patch";

export interface CardCatalog {
    id: string;
    manufacturer: Manufacturer;
    year: number;
    series_name?: string;
    player_name: string;
    team: Team;
    card_number?: string;
    rarity?: Rarity;
    is_rookie: boolean;
}

export interface ConditionGrading {
    is_graded: boolean;
    service: string;
    score?: number;
    certification_number?: string;
}

export interface Profile {
    id: string;
    email: string;
    display_name?: string;
    name?: string;
    first_name?: string;
    last_name?: string;
    avatar_url?: string;
    phone_number?: string;
    postal_code?: string;
    address_line1?: string;
    address_line2?: string;
    real_name_kana?: string;
}

export interface BankAccount {
    id: string;
    user_id: string;
    bank_name: string;
    bank_code?: string;
    branch_name: string;
    branch_code?: string;
    account_type: 'ordinary' | 'current';
    account_number: string;
    account_holder_name: string;
    created_at: string;
}

export interface Payout {
    id: string;
    user_id: string;
    amount: number;
    fee: number;
    payout_amount?: number;
    status: 'pending' | 'paid' | 'rejected';
    created_at: string;
    processed_at?: string;
}

export interface ListingItem {
    id: string;
    // catalog_id: string; // Removed
    price: number | null;
    images: string[];
    condition_grading: ConditionGrading;
    seller_id: string;
    status: string;

    // Flat Fields (Backfilled from Catalog)
    player_name: string | null; // Made nullable but effectively populated
    team: string | null;
    year: number | null;
    manufacturer: string | null;
    series_name?: string | null;
    card_number?: string | null;
    variation?: string | null;
    serial_number?: string | null;
    is_rookie?: boolean;
    is_autograph?: boolean;
    description?: string | null;
    condition_rating?: string | null;

    // catalog: CardCatalog | null; // Removed
    seller?: Profile; // Can be joined
    is_live_moment?: boolean;
    live_moments?: any[];
    moment_history?: MomentHistoryItem[];
    orders?: any[] | any; // Joined via Supabase
    origin_order?: any; // Joined via Supabase
}

export interface MomentHistoryItem {
    moment_id: string;
    timestamp: string;
    title: string;
    player_name: string;
    intensity: number;
    description?: string;
    match_result?: string;
    owner_at_time?: string;
    status?: 'pending' | 'finalized';
}

export interface SellerOrderDetail {
    id: string;
    status: string;
    listing: {
        id: string;
        title: string;
        seller_id: string;
        series_name: string;
        player_name: string;
        images: string[];
        price: number;
    };
    total_amount: number;
    created_at: string;
    // Snapshot of address at time of purchase
    shipping_address_snapshot: {
        name: string;
        postal_code: string;
        address: string;
        phone: string;
    } | null;
    // Legacy fallback columns
    shipping_name?: string;
    shipping_address?: string;
    shipping_postal_code?: string;
    shipping_phone?: string;

    // Shipment details
    tracking_number?: string;
    carrier?: string;
    shipped_at?: string;
    completed_at?: string;
}

export interface SalesHistoryItem {
    orderId: string;
    saleAmount: number;       // 販売価格
    feeRate: number;          // 適用された手数料率（0.10 = 10%）
    platformFee: number;      // 手数料額
    netEarning: number;       // 純収益
    completedAt: string;
    listing: {
        id: string;
        playerName: string;
        image: string | null;
        seriesName?: string;
        manufacturer?: string;
        year?: number;
    } | null;
}
</file>

<file path="frontend/utils/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key'
    )
}
</file>

<file path="frontend/utils/supabase/middleware.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key',
        {
            cookies: {
                get(name: string) {
                    return request.cookies.get(name)?.value
                },
                set(name: string, value: string, options: CookieOptions) {
                    request.cookies.set({
                        name,
                        value,
                        ...options,
                    })
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    response.cookies.set({
                        name,
                        value,
                        ...options,
                    })
                },
                remove(name: string, options: CookieOptions) {
                    request.cookies.set({
                        name,
                        value: '',
                        ...options,
                    })
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    response.cookies.set({
                        name,
                        value: '',
                        ...options,
                    })
                },
            },
        }
    )

    const { data: { user } } = await supabase.auth.getUser()

    // Admin Access Control
    if (request.nextUrl.pathname.startsWith('/admin')) {
        // Exclude diagnostic routes
        if (request.nextUrl.pathname.includes('debug')) {
            return response;
        }

        const adminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || '';
        const adminEmails = adminEmailsRaw
            .split(/[,;|]+/)
            .map(e => e.trim().toLowerCase())
            .filter(Boolean);

        const userEmail = user?.email?.toLowerCase();

        if (!user || !userEmail || !adminEmails.includes(userEmail)) {
            // Internal redirect to a specific error page if needed, but for now just console/home
            const reason = !user
                ? 'no_user'
                : !userEmail
                    ? 'no_email'
                    : `not_in_list`;

            // Create debug URL
            const debugUrl = new URL('/', request.url);
            debugUrl.searchParams.set('debug_error', 'admin_access_denied');
            debugUrl.searchParams.set('debug_reason', reason);
            debugUrl.searchParams.set('debug_email', userEmail || 'none');
            debugUrl.searchParams.set('debug_env_len', String(adminEmails.length));

            console.log(`[AUTH] Access Denied: User "${userEmail || 'none'}" not in admin list: [${adminEmails.join('|')}]`);
            return NextResponse.redirect(debugUrl)
        }
    }

    return response
}
</file>

<file path="frontend/utils/supabase/server.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key',
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options })
                    } catch (error) {
                        // The `set` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: '', ...options })
                    } catch (error) {
                        // The `delete` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/check_all_clones.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders:orders!origin_order_id(*)')
        .eq('seller_id', buyerId);

    console.log('--- All Items for Buyer2 ---');
    items?.forEach(item => {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        console.log(`Item: ${item.id}, Status: ${item.status}, Player: ${item.player_name}, OriginOrder: ${item.origin_order_id}, OrderStatus: ${order?.status}`);
    });
}

debug();
</file>

<file path="frontend/check_constraints.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data, error } = await supabaseAdmin.rpc('get_table_constraints', { t_name: 'listing_items' });
    if (error) {
        // Fallback: try querying information_schema
        const { data: constraints, error: cError } = await supabaseAdmin.from('information_schema.table_constraints').select('*').eq('table_name', 'listing_items');
        console.log('Constraints:', constraints);
    } else {
        console.log('Constraints:', data);
    }
}

// Since RLS might block information_schema, I will try a direct SQL query via a temporary function if needed, 
// but first let's see if I can just find it in migrations.
debug();
</file>

<file path="frontend/check_enum.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: enumValues, error } = await supabaseAdmin.rpc('get_enum_values', { enum_name: 'listing_status_enum' });
    if (error) {
         // Fallback SQL
         console.error('Error fetching enum:', error);
    } else {
        console.log('Enum values:', enumValues);
    }
}

debug();
</file>

<file path="frontend/check_images.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('id, player_name, price, images, origin_order_id')
        .ilike('player_name', '%Sasaki%');

    console.log('--- Sasaki Item Images ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Price: ${item.price}, Order: ${item.origin_order_id}, Image: ${item.images?.[0]?.substring(0, 50)}...`);
    });
}

debug();
</file>

<file path="frontend/check_item_details.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const itemId = '8e8eb573-060b-44e6-8436-e8008c9db422';
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', itemId)
        .single();

    console.log('--- Item 8e8eb573 Details ---');
    console.log(`Player: ${item.player_name}`);
    console.log(`Description: ${item.description}`);
    console.log(`Price: ${item.price}`);
    console.log(`OriginOrder: ${item.origin_order_id}`);
}

debug();
</file>

<file path="frontend/check_moments.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .ilike('player_name', '%Roki%');
    
    console.log('--- Roki Moments ---');
    console.log(moments);
}

debug();
</file>

<file path="frontend/check_order_prices.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(price, player_name)')
        .eq('buyer_id', '868187c0-f34f-47c7-9449-bc829a212cff');

    console.log('--- Orders for Buyer 2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order: ${o.id} | Status: ${o.status} | Price: ${listing?.price} | Player: ${listing?.player_name}`);
    });
}

debug();
</file>

<file path="frontend/check_original_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const listingId = '2dc382b1-881d-4c95-b228-8687c39d1548';
    const { data: listing } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', listingId)
        .single();

    console.log('--- Original 30k Listing ---');
    console.log(JSON.stringify(listing, null, 2));

    // Try to SIMULATE CLONING
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    const clonePayload = {
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            seller_id: buyerId,
            status: 'AwaitingShipment', // My new fallback
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
    };

    console.log('\n--- Simulating Insert ---');
    const { data: cloned, error: cloneError } = await supabaseAdmin
        .from('listing_items')
        .insert(clonePayload)
        .select('id')
        .single();

    if (cloneError) {
        console.error('INSERT FAILED:', cloneError.message, cloneError.code);
    } else {
        console.log('INSERT SUCCESS:', cloned.id);
    }
}

debug();
</file>

<file path="frontend/check_prices.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId);

    console.log('--- Items for Buyer2 ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, Player: ${item.player_name}, Price: ${item.price}, OriginOrder: ${item.origin_order_id}`);
    });
}

debug();
</file>

<file path="frontend/check_schema.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // 1. Check orders table columns
    const { data: orderSample } = await supabaseAdmin.from('orders').select('*').limit(1).single();
    console.log('--- Orders Table Columns ---');
    console.log(Object.keys(orderSample || {}));

    // 2. Check listing_items table columns
    const { data: itemSample } = await supabaseAdmin.from('listing_items').select('*').limit(1).single();
    console.log('\n--- Listing Items Table Columns ---');
    console.log(Object.keys(itemSample || {}));
}

debug();
</file>

<file path="frontend/check_seller.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const sellerId = '1380fba9-8aff-41c7-9a90-0e5752a63526';
    const { data: { user } } = await supabaseAdmin.auth.admin.getUserById(sellerId);
    console.log('Seller:', user?.email, user?.user_metadata?.full_name);
}

debug();
</file>

<file path="frontend/check_statuses.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // Get unique statuses from the table
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .select('status');
    
    if (data) {
        const statuses = Array.from(new Set(data.map(d => d.status)));
        console.log('Unique statuses found in DB:', statuses);
    }
}

debug();
</file>

<file path="frontend/cleanup_ohtani.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function cleanup() {
    const orderId = '8c637d61-eb0a-47c7-9434-4a8f95a69ed8';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    // 1. Find the card
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId)
        .eq('seller_id', buyerId)
        .single();

    if (item) {
        console.log('--- Current Item History ---');
        console.log(JSON.stringify(item.moment_history, null, 2));

        // The user says "Perfect Game Bid" was incorrectly added.
        // Snapshot for this order was "Dramatic Walk-off HR".
        // History should only have whatever was on the original card + Dramatic Walk-off HR.
        
        // Original card history (based on my earlier check of b0f042cd) was just "3000th Strikeout".
        const correctedHistory = [
            {
                "title": "Shohei Ohtani: 3000th Strikeout",
                "moment_id": "b9c3957d-8925-4a40-a0fa-4c6af0480ae9",
                "player_name": "Shohei Ohtani"
                // ... other fields simplified or restored
            },
            {
                "title": "Shohei Ohtani: Dramatic Walk-off HR",
                "moment_id": "52cded48-b34f-4ceb-ab42-078d4e0a708e",
                "player_name": "Shohei Ohtani",
                "owner_at_time": orderId,
                "status": "pending",
                "timestamp": new Date().toISOString()
            }
        ];

        console.log('\n--- Correcting History ---');
        const { error } = await supabaseAdmin
            .from('listing_items')
            .update({ moment_history: correctedHistory })
            .eq('id', item.id);
        
        if (!error) console.log('Fixed buyer copy!');
    }

    // 2. Clear contamination from original listing
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';
    const { data: original } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (original) {
        // Keep only the "3000th Strikeout" or whatever was there before.
        const cleanHistory = (original.moment_history || []).filter((m: any) => 
            m.moment_id === 'b9c3957d-8925-4a40-a0fa-4c6af0480ae9'
        );
        await supabaseAdmin.from('listing_items').update({ moment_history: cleanHistory }).eq('id', listingId);
        console.log('Cleaned original listing contamination!');
    }
}

cleanup();
</file>

<file path="frontend/debug_22k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 22000 && listing?.player_name?.includes('Ohtani');
    });

    if (specificOrder) {
        console.log('\n--- Found 22k Order ---');
        console.log('Order Snapshot:', JSON.stringify(specificOrder.moment_snapshot, null, 2));

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        items?.forEach(item => {
            console.log(`Item ID: ${item.id}, Status: ${item.status}`);
            console.log('Moment History:', JSON.stringify(item.moment_history, null, 2));
        });
    }

    // 3. Check Ohtani Moments
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .eq('player_name', 'Shohei Ohtani');
    
    console.log('\n--- All Ohtani Moments ---');
    console.log(moments);
}

debug();
</file>

<file path="frontend/debug_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 30000 && listing?.player_name?.includes('Sasaki');
    });

    if (specificOrder) {
        console.log('\n--- Found 30k Order ---');
        console.log('Order Status:', specificOrder.status);

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        items?.forEach(item => {
            console.log(`Item ID: ${item.id}, Status: ${item.status}, CreatedAt: ${item.created_at}`);
        });
    } else {
        console.log('\n30k Sasaki order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_39k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 39000 && listing?.player_name?.includes('Roki');
    });

    if (specificOrder) {
        console.log('\n--- Found 39k Order ---');
        console.log(specificOrder);

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        console.log(items);

        // 3. Try to RUN getBuyerItemByOrder via script to see error
        console.log('\n--- Triggering getBuyerItemByOrder ---');
        // I'll import it dynamically or just use direct logic to see what happens
        const { getBuyerItemByOrder } = await import('./app/actions/item');
        try {
            const result = await getBuyerItemByOrder(specificOrder.id);
            console.log('Recovery Result:', result);
        } catch (e) {
            console.error('Recovery Error:', e);
        }
    } else {
        console.log('Order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_all_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId)
        .is('deleted_at', null);
    
    console.log('--- All Items for Buyer2 ---');
    console.log(items);
}

debug();
</file>

<file path="frontend/debug_missing_card.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function debug() {
    // 1. Find buyer2
    const { data: profiles } = await supabaseAdmin
        .from('profiles')
        .select('id, display_name, email')
        .eq('email', 'buyer2@test.com');
    
    console.log('--- Profiles found ---');
    console.log(profiles);

    if (!profiles || profiles.length === 0) {
        console.log('Buyer not found.');
        return;
    }

    const buyerId = profiles[0].id;

    // 2. Find relevant orders
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('\n--- Recent Orders for Buyer ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Ohtani') && listing?.price === 3444;
    });

    if (specificOrder) {
        console.log('\n--- Found Specific Order ---');
        console.log(specificOrder);

        // 3. Find Cloned Item
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items for this Order ---');
        console.log(items);

        // 4. Find ANY items owned by this buyer with status Incoming or Draft
        const { data: allItems } = await supabaseAdmin
            .from('listing_items')
            .select('id, player_name, status, origin_order_id')
            .eq('seller_id', buyerId)
            .is('deleted_at', null);
        
        console.log('\n--- All Active Items for Buyer ---');
        console.log(allItems);
    } else {
        console.log('Specific Ohtani order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_roki.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function debug() {
    // 1. Find buyer2
    const { data: profiles } = await supabaseAdmin
        .from('profiles')
        .select('id, display_name, email')
        .eq('email', 'buyer2@test.com');
    
    if (!profiles || profiles.length === 0) {
        console.log('Buyer not found.');
        return;
    }

    const buyerId = profiles[0].id;

    // 2. Find relevant orders
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('\n--- Recent Orders for Buyer ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    // Check specific 15,000 order
    const missingOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Roki') && listing?.price === 15000;
    });

    // Check successful 2,000 order
    const okOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Roki') && listing?.price === 2000;
    });

    if (missingOrder) {
        console.log('\n--- Found Missing Order (15k) ---');
        console.log(missingOrder);
        const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', missingOrder.id);
        console.log('Clones for 15k:', items);
    }

    if (okOrder) {
        console.log('\n--- Found OK Order (2k) ---');
        console.log(okOrder);
        const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', okOrder.id);
        console.log('Clones for 2k:', items);
    }
}

debug();
</file>

<file path="frontend/debug_success_item.js">
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function debugSuccessItem() {
    console.log("--- Scanning Recent Orders (Large) ---");
    const { data: orders, error: orderErr } = await supabase
        .from('orders')
        .select('id, listing_id, buyer_id, created_at, status')
        .order('created_at', { ascending: false })
        .limit(20);

    if (orderErr) {
        console.error("Order Fetch Error:", orderErr);
        return;
    }

    for (const order of orders) {
        // Fetch original listing
        const { data: original } = await supabase
            .from('listing_items')
            .select('id, player_name, series_name, seller_id')
            .eq('id', order.listing_id)
            .single();

        if (!original) continue;
        if (!original.player_name.includes("山本")) continue; // Focus on Yamamoto for now

        console.log(`\nOrder: ${order.id}`);
        console.log(`Status: ${order.status} | Buyer: ${order.buyer_id} | Created: ${order.created_at}`);
        console.log(`Original Card: ${original.player_name} (${original.series_name}) | Seller: ${original.seller_id}`);

        // Look for current buyer's items
        const { data: buyerItems } = await supabase
            .from('listing_items')
            .select('id, seller_id, player_name, series_name, created_at')
            .eq('seller_id', order.buyer_id)
            .order('created_at', { ascending: false })
            .limit(20);

        console.log(`Buyer Items Found: ${buyerItems?.length || 0}`);
        if (buyerItems) {
            buyerItems.forEach(item => {
                const match = item.player_name?.trim() === original.player_name?.trim() &&
                    item.series_name?.trim() === original.series_name?.trim();
                console.log(` - [${match ? 'MATCH' : ' '} ] ${item.id} | ${item.player_name} | ${item.created_at}`);
            });
        }
    }
}

debugSuccessItem();
</file>

<file path="frontend/deep_check_8e8eb573.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const itemId = '8e8eb573-060b-44e6-8436-e8008c9db422';
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', itemId)
        .single();

    console.log('--- Item 8e8eb573 History ---');
    console.log(JSON.stringify(item.moment_history, null, 2));

    const orderId30k = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const has30k = item.moment_history?.some((m: any) => m.owner_at_time === orderId30k);
    console.log(`\nContains 30k Order ID: ${has30k}`);

    // Try to find the 30k order details
    const { data: order30k } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId30k)
        .single();
    
    console.log('\n--- 30k Order Details ---');
    console.log(`Status: ${order30k?.status}`);
    console.log(`ListingID: ${order30k?.listing_id}`);
}

debug();
</file>

<file path="frontend/dump_workspace.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const userId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // Emulate app/collection/page.tsx:fetchData
    const { data: listingsData } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders!listing_id(*), origin_order:orders!origin_order_id(status, id)')
        .eq('seller_id', userId)
        .is('deleted_at', null);

    console.log('--- Raw Items for Buyer 2 ---');
    listingsData?.forEach(item => {
        const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        console.log(`ID: ${item.id} | Status: ${item.status} | Player: ${item.player_name} | OriginOrder: ${item.origin_order_id} | OrderStatus: ${originOrder?.status}`);
    });

    console.log('\n--- Workspace Filter Results ---');
    const workspaceListings = listingsData?.filter(item => {
        const isCorrectStatus = ['Active', 'Display', 'Draft'].includes(item.status);
        const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        const isTransactionComplete = !item.origin_order_id || (originOrder?.status === 'completed');
        return isCorrectStatus && isTransactionComplete;
    });

    workspaceListings?.forEach(item => {
        console.log(`VISIBLE: ID: ${item.id} | Player: ${item.player_name}`);
    });
}

debug();
</file>

<file path="frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend/final_cleanup.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function cleanup() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2
    const orderId30k = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId);

    for (const item of (items || [])) {
        if (!item.moment_history) continue;
        
        const originalCount = item.moment_history.length;
        const cleaned = item.moment_history.filter((m: any) => m.owner_at_time !== orderId30k);
        
        if (cleaned.length !== originalCount && item.id !== 'd670a908-a901-464d-bc3e-929bc04f3830') {
            console.log(`Cleaning item ${item.id} (${item.player_name})...`);
            await supabaseAdmin
                .from('listing_items')
                .update({ moment_history: cleaned })
                .eq('id', item.id);
        }
    }
}

cleanup();
</file>

<file path="frontend/find_30k_card.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .ilike('player_name', '%Sasaki%')
        .eq('price', 30000);

    console.log('--- 30k Sasaki Cards found in DB ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, SellerID: ${item.seller_id}, Deletion: ${item.deleted_at}`);
    });

}

debug();
</file>

<file path="frontend/find_buyer1_clone.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = '1e449fd3-d389-4481-aa47-01e64b7d66a8';
    const { data: item } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', orderId).single();
    if (item) {
        console.log('--- Buyer 1 Clone ---');
        console.log(JSON.stringify(item, null, 2));
    } else {
        console.log('Buyer 1 clone not found.');
    }
}

debug();
</file>

<file path="frontend/find_buyer2.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: { users } } = await supabaseAdmin.auth.admin.listUsers();
    const buyer2 = users?.find(u => u.user_metadata?.full_name?.includes('Buyer 2') || u.email?.includes('buyer2'));
    if (buyer2) {
        console.log('Buyer 2 Found:', buyer2.id, buyer2.email);
    } else {
        console.log('Buyer 2 not found by Name/Email. Searching by my presumed ID...');
        const presumedId = '868187c0-f34f-47c7-9449-bc829a212cff';
        const target = users?.find(u => u.id === presumedId);
        if (target) {
            console.log('Found user with presumed ID:', target.id, target.email, target.user_metadata?.full_name);
        } else {
            console.log('No user found with presumed ID.');
        }
    }
}

debug();
</file>

<file path="frontend/find_sasaki_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders:orders!origin_order_id(*)')
        .eq('seller_id', buyerId)
        .ilike('player_name', '%Sasaki%');

    console.log('--- Sasaki Items for Buyer2 ---');
    items?.forEach(item => {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        console.log(`ID: ${item.id}, Status: ${item.status}, Price: ${item.price}, OriginOrder: ${item.origin_order_id}, OrderStatus: ${order?.status}`);
    });
}

debug();
</file>

<file path="frontend/find_sold_logic.ts">
import fs from 'fs';
import path from 'path';

const filePath = '/Users/jun_yoshida/Documents/my-pj/TC-APP/frontend/app/collection/page.tsx';
const content = fs.readFileSync(filePath, 'utf-8');

const regex = /\/\/\s*History:\s*Sold\s*Items[\s\S]*?setHistorySold/g;
const match = content.match(regex);
if (match) {
    console.log(match[0]);
} else {
    console.log('Not found');
}
</file>

<file path="frontend/find_specific_clone.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId);

    console.log(`--- Items for Order ${orderId} ---`);
    if (items && items.length > 0) {
        items.forEach(item => {
            console.log(`ID: ${item.id}, Status: ${item.status}, SellerID: ${item.seller_id}`);
        });
    } else {
        console.log('None found.');
    }
}

debug();
</file>

<file path="frontend/fix_buyer2_stuck_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function fix() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find items owned by buyer2 that have an origin_order_id and are 'Draft'
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders!origin_order_id(status)')
        .eq('seller_id', buyerId)
        .eq('status', 'Draft')
        .not('origin_order_id', 'is', null);

    console.log(`Checking ${items?.length} potential stuck items...`);

    for (const item of (items || [])) {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        if (order && order.status !== 'completed') {
            console.log(`Item ${item.id} (${item.player_name}) is Draft but Order ${item.origin_order_id} is ${order.status}. Moving to AwaitingShipment...`);
            await supabaseAdmin
                .from('listing_items')
                .update({ status: 'AwaitingShipment' })
                .eq('id', item.id);
        }
    }
}

fix();
</file>

<file path="frontend/fix_final.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function fix() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('seller_id', buyerId);
    
    for (const item of (items || [])) {
        if (item.player_name === 'Shohei Ohtani' && item.moment_history?.length > 1) {
            console.log(`Found Ohtani item ${item.id} with ${item.moment_history.length} moments.`);
            console.log('History:', JSON.stringify(item.moment_history, null, 2));

            // Remove "Perfect Game Bid" if it matches buyer1's order ID or is just extra
            const corrected = item.moment_history.filter((m: any) => 
                m.title !== 'Shohei Ohtani: Perfect Game Bid'
            );

            if (corrected.length !== item.moment_history.length) {
                console.log(`Correcting item ${item.id}...`);
                await supabaseAdmin.from('listing_items').update({ moment_history: corrected }).eq('id', item.id);
                console.log('DONE.');
            }
        }
    }
}

fix();
</file>

<file path="frontend/get_enum_values.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // We can't query enums directly via JS client usually, but we can try to trigger an error or use an RPC if available.
    // Alternatively, we can check the migrations or just try to insert a garbage value and read the error message which often lists valid values.
    const { error } = await supabaseAdmin
        .from('listing_items')
        .insert({ 
            player_name: 'TEST', 
            status: 'GARBAGE_VALUE_FOR_ERROR' 
        });
    
    if (error) {
        console.log('Error Message (should list valid values):', error.message);
    }
}

debug();
</file>

<file path="frontend/get_status_enum.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // Query to get enum name and values for a column
    const query = `
        SELECT 
            t.typname AS enum_name,  
            e.enumlabel AS enum_value
        FROM pg_type t 
        JOIN pg_enum e ON t.oid = e.enumtypid  
        JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
        WHERE t.typname = 'listing_status_enum';
    `;

    const { data, error } = await supabaseAdmin.rpc('run_sql_query', { query_text: query });
    if (error) {
        console.error('Error:', error);
        // If RPC not available, try to find in table columns
        const { data: cols } = await supabaseAdmin.from('information_schema.columns').select('udt_name').eq('table_name', 'listing_items').eq('column_name', 'status');
        console.log('Columns metadata:', cols);
    } else {
        console.log('Enum Details:', data);
    }
}

debug();
</file>

<file path="frontend/inspect_listing.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    console.log('--- Original Listing ---');
    console.log(JSON.stringify(listing?.moment_history, null, 2));

    const { data: clones } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', '8c637d61-eb0a-47c7-9434-4a8f95a69ed8');
    console.log('\n--- Direct Clones ---');
    console.log(JSON.stringify(clones?.map(c => ({ id: c.id, history: c.moment_history })), null, 2));

    const { data: allBuyerOhtani } = await supabaseAdmin.from('listing_items').select('*').eq('seller_id', buyerId).ilike('player_name', '%Ohtani%');
    console.log('\n--- All Buyer Ohtani Cards ---');
    console.log(JSON.stringify(allBuyerOhtani?.map(c => ({ id: c.id, price: c.price, history: c.moment_history })), null, 2));
}

debug();
</file>

<file path="frontend/list_buyer2_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId)
        .is('deleted_at', null);

    console.log('--- Items owned by Buyer2 ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, Price: ${item.price}, Player: ${item.player_name}, OriginOrder: ${item.origin_order_id}`);
    });
}

debug();
</file>

<file path="frontend/manual_recovery.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function recover() {
    const orderId = '747bf8d6-0889-47f5-90ef-c890542ce115';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';

    console.log('--- Starting Manual Recovery ---');

    // 1. Get original listing
    const { data: listing, error: lError } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', listingId)
        .single();
    
    if (lError || !listing) {
        console.error('Error fetching listing:', lError);
        return;
    }

    // 2. Insert clone
    const { data: recovered, error: rError } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (rError) {
        console.error('Error inserting clone:', rError);
    } else {
        console.log('--- Successfully Recovered Item ---');
        console.log(recovered);
    }
}

recover();
</file>

<file path="frontend/middleware.ts">
import { NextResponse, type NextRequest } from 'next/server'
import { updateSession } from './utils/supabase/middleware'

export async function middleware(request: NextRequest) {
    // 1. Basic Auth Logic
    const basicAuthUser = process.env.BASIC_AUTH_USER;
    const basicAuthPassword = process.env.BASIC_AUTH_PASSWORD;

    // Exclude Webhooks and Debug from Admin Check
    if (request.nextUrl.pathname.startsWith('/api/webhooks') ||
        request.nextUrl.pathname.startsWith('/debug-admin') ||
        request.nextUrl.pathname.startsWith('/api/debug-auth')) {
        return await updateSession(request);
    }

    if (basicAuthUser && basicAuthPassword) {
        const authHeader = request.headers.get('authorization');

        if (authHeader) {
            try {
                const authValue = authHeader.split(' ')[1];
                const decoded = atob(authValue);
                const firstColonIndex = decoded.indexOf(':');

                if (firstColonIndex !== -1) {
                    const user = decoded.substring(0, firstColonIndex);
                    const pwd = decoded.substring(firstColonIndex + 1);

                    // Case-insensitive user check for iOS auto-capitalization
                    if (user.toLowerCase() === basicAuthUser.toLowerCase() && pwd === basicAuthPassword) {
                        return await updateSession(request);
                    }
                }
            } catch (e) {
                console.error('Basic Auth decode error:', e);
            }
        }

        const userAgent = request.headers.get('user-agent') || '';
        const isFBorMessenger = userAgent.includes('FBAN') || userAgent.includes('FBAV');

        const responseHeaders: Record<string, string> = {
            'Content-Type': 'text/html; charset=utf-8',
            'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
        };

        // Do not send WWW-Authenticate for FB/Messenger to force custom HTML display
        if (!isFBorMessenger) {
            responseHeaders['WWW-Authenticate'] = 'Basic realm="Restricted"';
        }

        return new Response(`
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Authentication Required [v2]</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                        background-color: #f4f7f9;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        margin: 0;
                        color: #333;
                    }
                    .container {
                        background: white;
                        padding: 2rem;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                        max-width: 400px;
                        text-align: center;
                    }
                    h1 { font-size: 1.5rem; margin-bottom: 1rem; color: #000; }
                    p { line-height: 1.6; color: #666; font-size: 0.95rem; }
                    .warning {
                        background: #fff8e1;
                        border-left: 4px solid #ffb300;
                        padding: 10px;
                        margin: 20px 0;
                        text-align: left;
                        font-size: 0.85rem;
                    }
                    .btn {
                        display: inline-block;
                        margin-top: 20px;
                        padding: 12px 24px;
                        background: #0070f3;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>Authentication Required [v2]</h1>
                    <p>このページにアクセスするには認証が必要です。</p>
                    <div class="warning">
                        <strong>Messenger等をお使いの方へ:</strong><br>
                        アプリ内のブラウザでは認証画面が表示されない制約があります。右上のメニュー等から<strong>「ブラウザで開く」</strong>（SafariやChrome）を選択してください。
                    </div>
                    <p>通常はブラウザ側でログイン画面が表示されます。</p>
                </div>
            </body>
            </html>
        `, {
            status: 401,
            headers: responseHeaders,
        });
    }

    // 2. Standard Supabase Middleware
    return await updateSession(request);
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * Feel free to modify this pattern to include more paths.
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}
</file>

<file path="frontend/next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
    async rewrites() {
        const backendUrl = process.env.BACKEND_URL || 'http://127.0.0.1:8000';
        return [
            {
                source: '/api/proxy/:path*',
                destination: `${backendUrl}/:path*`,
            },
        ];
    },
    images: {
        dangerouslyAllowSVG: true,
        contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
        remotePatterns: [
            {
                protocol: 'https',
                hostname: '**',
            },
        ],
    },
};

module.exports = nextConfig;
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "seed": "tsx scripts/seed.ts"
  },
  "dependencies": {
    "@ai-sdk/google": "^2.0.45",
    "@anthropic-ai/sdk": "^0.73.0",
    "@hookform/resolvers": "^5.2.2",
    "@react-email/components": "^1.0.1",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.86.2",
    "ai": "^5.0.108",
    "framer-motion": "^12.23.25",
    "lucide-react": "^0.563.0",
    "next": "^16.0.7",
    "openai": "^6.18.0",
    "pg": "^8.16.3",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-hook-form": "^7.68.0",
    "resend": "^6.5.2",
    "stripe": "^20.0.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.19",
    "dotenv": "^17.2.3",
    "eslint": "^9.39.1",
    "eslint-config-next": "^16.0.7",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "ts-node": "^10.9.2",
    "tsx": "^4.21.0",
    "typescript": "^5"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
};
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/recover_39k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function recover() {
    const orderId = '22ffcc3d-92b3-409a-9455-02d688d801c5';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = 'fd35a791-acad-43e9-896b-26ac6fde589b';

    console.log('--- Starting Manual Recovery for 39k Sasaki ---');

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    const { data: recovered, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (error) {
        console.error('Manual Recovery Failed:', error);
    } else {
        console.log('Manual Recovery Success:', recovered);
    }
}

recover();
</file>

<file path="frontend/recover_sasaki.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function recover() {
    const orderId = '54ad7353-f758-4c9e-b115-773e59efe203';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = '642e6fda-9b31-4024-a97b-e2bb85cd0336';

    console.log('--- Starting Manual Recovery for 15k Sasaki ---');

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    const { data: recovered, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (error) {
        console.error('Manual Recovery Failed:', error);
    } else {
        console.log('Manual Recovery Success:', recovered);
    }
}

recover();
</file>

<file path="frontend/simulate_insert.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function simulate() {
    const orderId = '54ad7353-f758-4c9e-b115-773e59efe203';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = '642e6fda-9b31-4024-a97b-e2bb85cd0336';

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    console.log('Inserting clone for 15k Sasaki...');
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Incoming',
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('id')
        .single();
    
    if (error) {
        console.error('SIMULATED INSERT FAILED:', error);
    } else {
        console.log('SIMULATED INSERT SUCCESS:', data);
    }
}

simulate();
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        "./app/**/*.{js,ts,jsx,tsx,mdx}",
        "./components/**/*.{js,ts,jsx,tsx,mdx}",
    ],
    theme: {
        extend: {
            colors: {
                brand: {
                    dark: "#020408", // Deeper black/blue for background
                    "dark-light": "#0f172a",
                    blue: "#3b82f6",
                    "blue-glow": "#60a5fa",
                    gold: "#FFD700", // Bright Gold
                    bronze: "#CD7F32",
                    platinum: "#e2e8f0",
                },
            },
            fontFamily: {
                sans: ["var(--font-inter)", "sans-serif"],
                heading: ["var(--font-outfit)", "sans-serif"],
            },

            keyframes: {
                fadeInUp: {
                    "0%": { opacity: "0", transform: "translateY(10px)" },
                    "100%": { opacity: "1", transform: "translateY(0)" },
                },
                float: {
                    "0%, 100%": { transform: "translateY(0)" },
                    "50%": { transform: "translateY(-20px)" },
                },
                spotlight: {
                    "0%": { opacity: "0.5", transform: "scale(1)" },
                    "100%": { opacity: "1", transform: "scale(1.1)" },
                },
                shimmer: {
                    "0%": { backgroundPosition: "-200% 0" },
                    "100%": { backgroundPosition: "200% 0" },
                },
                "rotate-slow": {
                    "0%": { transform: "rotate(0deg)" },
                    "100%": { transform: "rotate(360deg)" },
                },
                shake: {
                    "0%, 100%": { transform: "translateX(0)" },
                    "10%, 30%, 50%, 70%, 90%": { transform: "translateX(-5px)" },
                    "20%, 40%, 60%, 80%": { transform: "translateX(5px)" },
                },
                "shimmer-diagonal": {
                    "0%": { transform: "translate(-100%, -100%) rotate(45deg)" },
                    "100%": { transform: "translate(100%, 100%) rotate(45deg)" },
                },
            },
            animation: {
                "fade-in-up": "fadeInUp 0.5s ease-out forwards",
                "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                "float": "float 6s ease-in-out infinite",
                "spotlight": "spotlight 2s ease-in-out infinite alternate",
                "shimmer": "shimmer 3s linear infinite",
                "rotate-slow": "rotate-slow 10s linear infinite",
                "shake": "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
                "shimmer-diagonal": "shimmer-diagonal 3s ease-in-out infinite",
            },
        },
    },
    plugins: [],
};
</file>

<file path="frontend/TC-APP.code-workspace">
{
	"folders": [
		{
			"path": ".."
		}
	],
	"settings": {}
}
</file>

<file path="frontend/test_action.ts">
import { getBuyerItemByOrder } from './app/actions/item';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

// Emulate user context if possible, but the action uses createServerClient which might fail in script.
// I will instead create a script that emulates the logic inside the action with admin rights.

import { createClient } from '@supabase/supabase-js';
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debug() {
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4'; // 30k Sasaki
    const userId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // Logic from getBuyerItemByOrder
    const { data: order } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (!order) return console.log('Order not found');

    const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
    
    // 3. Search for the buyer's copy using PINPOINT match
    const { data: pinpoint } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId)
        .eq('seller_id', userId)
        .maybeSingle();

    console.log('Pinpoint Match:', pinpoint?.id);

    // 4. Fallback search (Fuzzy matching)
    if (!pinpoint) {
        const orderAt = new Date(order.created_at);
        const bufferTime = new Date(orderAt.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString();

        const { data: results } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('seller_id', userId)
            .is('deleted_at', null)
            .not('status', 'in', '("Completed","Sold","Delivered")')
            .is('origin_order_id', null) // MY NEW FIX
            .gte('created_at', bufferTime);

        console.log('Fuzzy Match Results (with origin_order_id: null):', results?.length);

        // Try WITHOUT my fix to see what it would have done
        const { data: resultsOld } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('seller_id', userId)
            .is('deleted_at', null)
            .not('status', 'in', '("Completed","Sold","Delivered")')
            .gte('created_at', bufferTime);
        
        console.log('Fuzzy Match Results (WITHOUT fix):', resultsOld?.length);
        resultsOld?.forEach(r => {
            if (r.images?.[0] === listing.images?.[0]) {
                console.log(`FOUND OLD MATCH: ${r.id} | OriginOrder: ${r.origin_order_id}`);
            }
        });
    }
}

debug();
</file>

<file path="frontend/test_incoming.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function test() {
    console.log('Testing "Incoming" status...');
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: 'Enum Test',
            status: 'Incoming',
            seller_id: '868187c0-f34f-47c7-9449-bc829a212cff',
            price: 0,
            images: [],
            condition_grading: {}
        })
        .select('id')
        .single();
    
    if (error) {
        console.error('FAILED:', error.message);
    } else {
        console.log('SUCCESS! id:', data.id);
        // Clean up
        await supabaseAdmin.from('listing_items').delete().eq('id', data.id);
    }
}

test();
</file>

<file path="frontend/test.ts">
console.log('test')
</file>

<file path="frontend/trace_order.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = '1e449fd3-d389-4481-aa47-01e64b7d66a8';
    const { data: order } = await supabaseAdmin.from('orders').select('*, listing:listing_items!listing_id(*)').eq('id', orderId).single();
    console.log('--- Traced Order ---');
    console.log(JSON.stringify(order, null, 2));

    const { data: profiles } = await supabaseAdmin.from('profiles').select('*').eq('id', order?.buyer_id);
    console.log('\n--- Order Buyer ---');
    console.log(profiles);
}

debug();
</file>

<file path="frontend/trigger_recovery.ts">
import { getBuyerItemByOrder } from './app/actions/item';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

async function run() {
    const orderId = '747bf8d6-0889-47f5-90ef-c890542ce115';
    console.log(`Triggering recovery for Order: ${orderId}`);
    const result = await getBuyerItemByOrder(orderId);
    console.log('Result:', result);
}

run();
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="frontend/vercel.json">
{
    "framework": "nextjs",
    "buildCommand": "next build",
    "installCommand": "npm install",
    "outputDirectory": ".next"
}
</file>

<file path="frontend/verify_visibility.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function verify() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, origin_order:orders!origin_order_id(status)')
        .eq('seller_id', buyerId);

    console.log('--- Buyer 2 Items ---');
    items?.forEach(item => {
        const order = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        const willShowInWorkspace = ['Active', 'Display', 'Draft'].includes(item.status) && (!item.origin_order_id || order?.status === 'completed');
        
        console.log(`ID: ${item.id.substring(0,8)} | Player: ${item.player_name.padEnd(15)} | Status: ${item.status.padEnd(15)} | OrderStatus: ${(order?.status || 'N/A').padEnd(10)} | Visible: ${willShowInWorkspace}`);
    });
}

verify();
</file>

<file path="migrations/01_add_profile_name_fields.sql">
-- Add new columns for separating name types
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS display_name text,
ADD COLUMN IF NOT EXISTS first_name text,
ADD COLUMN IF NOT EXISTS last_name text;

-- Migrate existing 'name' to 'display_name' initially so it's not empty
UPDATE public.profiles 
SET display_name = name 
WHERE display_name IS NULL;
</file>

<file path="migrations/02_create_live_moments.sql">
-- ==============================================================================
-- Migration: 02_create_live_moments
-- Description: "Live Moment Engine" (リアルタイム通知基盤) 用のスキーマ定義
-- Author: Database Architect (Antigravity)
-- ==============================================================================

-- 1. Enum定義: moment_type
-- 設計思想: Enumを使用し、イベントタイプのデータ整合性を保証します。
-- 内部値は標準的な小文字（または英大文字）とし、UI側で必要に応じてフォーマットします。
CREATE TYPE moment_type AS ENUM (
    'HOMERUN',
    'BIG_PLAY',
    'VICTORY',
    'RECORD_BREAK',
    'system_notice'
);

-- 2. テーブル定義: live_moments
-- 設計思想:
-- - `player_name` は外部キー制約を持たせず TEXT とし、柔軟性を持たせます（現時点でplayersテーブルと密結合させない）。
-- - `metadata` は JSONB を採用し、"Antigravity"（将来の未知の要件）に対応できる柔軟性を確保します。
-- - `intensity` は演出の強度を決定します (1=控えめ, 5=最大級のGlowing/派手な演出)。
CREATE TABLE live_moments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    player_name TEXT NOT NULL,
    type moment_type NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    intensity INTEGER CHECK (intensity BETWEEN 1 AND 5) DEFAULT 1,
    metadata JSONB DEFAULT '{}'::jsonb
);

-- 3. セキュリティ (RLS)
-- 設計思想:
-- 「熱狂（Heartbeat）」データは全ユーザー（認証/未認証問わず）が読み取れるべきです。
-- これら運命的なイベントを書き込めるのは、システム管理者（Service Role）のみとします。
ALTER TABLE live_moments ENABLE ROW LEVEL SECURITY;

-- 全ユーザー（Authenticated & Anon）に読み取り権限を付与
CREATE POLICY "Public Read Access"
ON live_moments FOR SELECT
USING (true);

-- 書き込み権限は Service Role のみに制限
-- (Supabaseのデフォルト動作として、明示的なPolicyがない限りユーザーによるINSERT/UPDATE/DELETEは拒否されます)

-- 4. Realtime (リアルタイム機能) の有効化
-- 設計思想: フロントエンドはこのテーブルの INSERT を監視し、即座にアニメーションを発火させます。
-- `supabase_realtime` パブリケーションにこのテーブルを追加します。
alter publication supabase_realtime add table live_moments;

-- 5. シードデータ (動作確認用)
-- 設計思想: Intensity 5 の視覚効果を即座にテストするための、伝説的な瞬間データ。
INSERT INTO live_moments (player_name, type, title, description, intensity, metadata)
VALUES (
    '大谷 翔平',
    'HOMERUN',
    '大谷翔平、劇的なサヨナラ満塁ホームラン！今季40号達成！',
    '9回裏、2アウト満塁。ドジャースタジアムが揺れた歴史的瞬間。',
    5,
    '{
        "inning": "9th Bottom",
        "opponent": "Rays",
        "video_url": "https://example.com/moment/ohtani-40.mp4",
        "related_card_ids": []
    }'::jsonb
);
</file>

<file path="specs/data_model.yaml">
# Data Model Definition for Baseball Trading Card Platform
# Version: 1.0.0

models:
  # ---------------------------------------------------------
  # CardCatalog: カードそのもののマスターデータ（不変）
  # ---------------------------------------------------------
  CardCatalog:
    type: object
    description: "メーカーが発行したカードのカタログ情報。出品時の親データとなる。"
    properties:
      id:
        type: uuid
        primary_key: true
      manufacturer:
        type: string
        enum: ["BBM", "Calbee", "Epoch", "Topps_Japan"]
        description: "発行メーカー"
      year:
        type: integer
        example: 2024
        description: "発行年度"
      series_name:
        type: string
        example: "Genesis"
        description: "シリーズ名"
      card_number:
        type: string
        example: "G-01"
        description: "カード裏面の番号"
      player_name:
        type: string
        example: "大谷翔平"
        description: "選手名（漢字フルネーム推奨）"
      team:
        type: string
        enum: 
          - "Giants"    # 読売ジャイアンツ
          - "Tigers"    # 阪神タイガース
          - "Dragons"   # 中日ドラゴンズ
          - "Swallows"  # 東京ヤクルトスワローズ
          - "Carp"      # 広島東洋カープ
          - "BayStars"  # 横浜DeNAベイスターズ
          - "Hawks"     # 福岡ソフトバンクホークス
          - "Fighters"  # 北海道日本ハムファイターズ
          - "Marines"   # 千葉ロッテマリーンズ
          - "Buffaloes" # オリックス・バファローズ
          - "Eagles"    # 東北楽天ゴールデンイーグルス
          - "Lions"     # 埼玉西武ライオンズ
      rarity:
        type: string
        enum: ["Common", "Rare", "Super Rare", "Parallel", "Autograph", "Patch"]
      is_rookie:
        type: boolean
        default: false
        description: "ルーキーカードフラグ"

  # ---------------------------------------------------------
  # ListingItem: ユーザーが出品した個別の商品データ
  # ---------------------------------------------------------
  ListingItem:
    type: object
    description: "ユーザー間取引の対象となる具体的な出品アイテム"
    properties:
      id:
        type: uuid
        primary_key: true
      catalog_id:
        type: uuid
        foreign_key: "CardCatalog.id"
        description: "どのカタログのカードか"
      seller_id:
        type: uuid
        description: "出品ユーザーID"
      status:
        type: string
        enum: ["Draft", "Active", "TransactionPending", "Sold", "Cancelled", "Dispute"]
        default: "Draft"
      price:
        type: integer
        minimum: 100
        description: "出品価格（日本円）。100円以上必須。"
      images:
        type: array
        items: 
          type: string
          format: uri
        min_items: 2
        description: "画像URLリスト。表と裏の最低2枚が必要。"
      condition_grading:
        type: object
        description: "カードの状態または鑑定情報"
        properties:
          is_graded:
            type: boolean
            description: "鑑定済みかどうか"
          service:
            type: string
            enum: ["PSA", "BGS", "CGC", "ARS", "Raw"]
            description: "鑑定機関。未鑑定の場合はRaw。"
          score:
            type: number
            nullable: true
            example: 10
            description: "鑑定スコア"
          certification_number:
            type: string
            nullable: true
            description: "鑑定証明番号（PSA/BGS等の場合必須）"
      created_at:
        type: datetime
      updated_at:
        type: datetime
</file>

<file path="specs/openapi.yaml">
openapi: 3.0.3
info:
  title: Baseball Card Trading Platform API
  version: 1.0.0
  description: プロ野球カード取引プラットフォームのバックエンドAPI仕様

servers:
  - url: http://localhost:8000/v1
    description: Local Development Server

paths:
  # --- Catalog Endpoints ---
  /catalog/cards:
    get:
      summary: カタログ検索
      description: 条件に一致するカードカタログ情報を検索する
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: フリーワード検索（選手名など）
        - name: team
          in: query
          schema:
            type: string
            enum: ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"]
        - name: year
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: 検索結果リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardCatalog'

  # --- Market Endpoints ---
  /market/listings:
    get:
      summary: 出品一覧取得
      description: 特定のカタログIDに紐づく出品、または新着出品を取得する
      parameters:
        - name: catalog_id
          in: query
          schema:
            type: string
            format: uuid
        - name: sort
          in: query
          schema:
            type: string
            enum: ["price_asc", "price_desc", "newest"]
      responses:
        '200':
          description: 出品リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ListingItem'
    
    post:
      summary: 新規出品作成
      description: 新しいカードを出品する
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["catalog_id", "price", "images", "condition_grading"]
              properties:
                catalog_id:
                  type: string
                  format: uuid
                price:
                  type: integer
                  minimum: 100
                images:
                  type: array
                  items:
                    type: string
                  minItems: 2
                condition_grading:
                  $ref: '#/components/schemas/ConditionGrading'
      responses:
        '201':
          description: 出品作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListingItem'

  /market/orders:
    post:
      summary: 購入処理（注文作成）
      description: 出品されているアイテムを購入し、決済プロセスを開始する
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["listing_id", "payment_method_id"]
              properties:
                listing_id:
                  type: string
                  format: uuid
                payment_method_id:
                  type: string
      responses:
        '200':
          description: 注文受付完了
          content:
            application/json:
              schema:
                type: object
                properties:
                  order_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: "payment_processing"
        '409':
          description: コンフリクト（既に売り切れ、または決済処理中）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CardCatalog:
      type: object
      properties:
        id: { type: string, format: uuid }
        player_name: { type: string }
        team: { type: string }
        manufacturer: { type: string }
        year: { type: integer }
    
    ListingItem:
      type: object
      properties:
        id: { type: string, format: uuid }
        catalog_id: { type: string, format: uuid }
        price: { type: integer }
        status: { type: string }
        condition_grading: { $ref: '#/components/schemas/ConditionGrading' }
    
    ConditionGrading:
      type: object
      properties:
        service: { type: string }
        score: { type: number }
        certification_number: { type: string }

    ErrorResponse:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        detail: { type: string }
</file>

<file path="specs/state_machine.md">
# Listing Lifecycle State Machine

このドキュメントは、出品アイテム(`ListingItem`)の状態遷移ルールを定義します。
バックエンド実装時は、この遷移図以外のステータス変更を許可しないでください。

```mermaid
stateDiagram-v2
    [*] --> Draft: 新規作成(下書き)
    
    Draft --> Active: 出品公開(Publish)
    note right of Active: 検索結果に表示される状態
    
    Active --> Cancelled: 出品取り下げ
    Active --> TransactionPending: 購入リクエスト(Buy)
    
    state TransactionPending {
        [*] --> PaymentVerifying
        PaymentVerifying --> PaymentCaptured: 決済成功
        PaymentVerifying --> PaymentFailed: 決済失敗
    }
    
    TransactionPending --> Active: 決済失敗/タイムアウト(在庫戻し)
    TransactionPending --> Sold: 決済確定(在庫引き落とし完了)
    
    state Sold {
        [*] --> AwaitingShipment: 発送待ち
        AwaitingShipment --> Shipped: 発送通知(追跡番号登録)
        Shipped --> Delivered: 配達完了(配送業者API連携)
        Delivered --> Completed: 受取評価完了(取引終了)
    }
    
    Sold --> Dispute: トラブル報告(運営介入)
    Dispute --> Cancelled: 返金・キャンセル
    Dispute --> Completed: 調停・取引成立
</file>

<file path="supabase/migrations/20251220160000_add_origin_order_id.sql">
-- Add origin_order_id to track which order created this cloned item
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS origin_order_id uuid REFERENCES public.orders(id);
-- Create index for faster lookup
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Comment on column
COMMENT ON COLUMN public.listing_items.origin_order_id IS 'Reference to the order that created this cloned/buyer copy';
</file>

<file path="add_address_columns.sql">
-- Add address columns to profiles table
alter table public.profiles
add column if not exists postal_code text,
add column if not exists address_line1 text,
add column if not exists address_line2 text,
add column if not exists phone_number text;
</file>

<file path="add_columns.sql">
-- Add missing columns to orders table
alter table public.orders 
add column if not exists shipping_address text,
add column if not exists status text default 'Pending';
</file>

<file path="add_delete_policy_listings.sql">
-- Add delete policy for listing_items
create policy "Users can delete their own listings." 
on public.listing_items for delete 
using (auth.uid() = seller_id);
</file>

<file path="add_live_moment_column.sql">
ALTER TABLE listing_items ADD COLUMN is_live_moment BOOLEAN DEFAULT FALSE;
</file>

<file path="add_more_catalog_items.sql">
-- Add more sample data to card_catalogs
insert into public.card_catalogs (manufacturer, year, series_name, player_name, team, card_number, rarity, is_rookie)
values
  ('Topps', 2024, 'Chrome', 'Yoshinobu Yamamoto', 'Dodgers', '18', 'Rookie', true),
  ('Topps', 2024, 'Chrome', 'Shohei Ohtani', 'Dodgers', '17', 'Super Rare', false),
  ('BBM', 2023, 'Glory', 'Roki Sasaki', 'Marines', '17', 'Rare', false),
  ('BBM', 2023, 'Genesis', 'Munetaka Murakami', 'Swallows', '55', 'Super Rare', false),
  ('Epoch', 2022, 'Stars & Legends', 'Masataka Yoshida', 'Buffaloes', '7', 'Autograph', false),
  ('Topps_Japan', 2021, 'NPB Chrome', 'Seiya Suzuki', 'Carp', '51', 'Rare', false),
  ('Calbee', 2020, 'Pro Baseball Chips', 'Hayato Sakamoto', 'Giants', '6', 'Common', false),
  ('BBM', 2019, '1st Version', 'Koji Chikamoto', 'Tigers', '5', 'Rookie', true),
  ('Epoch', 2024, 'Premier', 'Shugo Maki', 'BayStars', '2', 'Patch', false),
  ('Topps', 2001, 'Traded', 'Ichiro Suzuki', 'Marines', '51', 'Rookie', true), -- Mariners mapped to Marines for enum compatibility or need new enum
  ('Topps', 2018, 'Update', 'Shohei Ohtani', 'Fighters', '17', 'Rookie', true); -- Angels mapped to Fighters for enum compatibility

-- Note: Team enum might need expansion if we want MLB teams properly. 
-- Current enum: Giants, Tigers, Dragons, Swallows, Carp, BayStars, Hawks, Fighters, Marines, Buffaloes, Eagles, Lions, Dodgers
</file>

<file path="apply_rls_policies.sql">
-- Enable RLS on tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE listing_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- Profiles Policies
CREATE POLICY "Public profiles are viewable by everyone" 
ON profiles FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" 
ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update their own profile" 
ON profiles FOR UPDATE USING (auth.uid() = id);

-- Listing Items Policies
CREATE POLICY "Public listings are viewable by everyone" 
ON listing_items FOR SELECT 
USING (status IN ('Active', 'Display', 'Sold', 'Shipped', 'Delivered', 'Completed', 'TransactionPending', 'AwaitingShipment'));

CREATE POLICY "Users can view their own draft/all listings" 
ON listing_items FOR SELECT 
USING (auth.uid() = seller_id);

CREATE POLICY "Users can insert their own listings" 
ON listing_items FOR INSERT 
WITH CHECK (auth.uid() = seller_id);

CREATE POLICY "Users can update their own listings" 
ON listing_items FOR UPDATE 
USING (auth.uid() = seller_id);

CREATE POLICY "Users can delete their own listings" 
ON listing_items FOR DELETE 
USING (auth.uid() = seller_id);

-- Orders Policies
-- Buyer can view their orders
CREATE POLICY "Buyers can view their own orders" 
ON orders FOR SELECT 
USING (auth.uid() = buyer_id);

-- Seller can view orders for their items (via listing_items)
CREATE POLICY "Sellers can view orders for their items" 
ON orders FOR SELECT 
USING (
    EXISTS (
        SELECT 1 FROM listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);

-- Buyers can create orders
CREATE POLICY "Buyers can create orders" 
ON orders FOR INSERT 
WITH CHECK (auth.uid() = buyer_id);

-- Updates are generally handled by system/RPC, but allowing status updates by participants if needed
-- For now, restricting updates to explicit cases or keeping it open to participants
CREATE POLICY "Participants can update orders" 
ON orders FOR UPDATE 
USING (
    auth.uid() = buyer_id OR 
    EXISTS (
        SELECT 1 FROM listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);
</file>

<file path="create_complete_order_function.sql">
-- Function to allow buyers to mark an order as completed
create or replace function public.complete_order(p_listing_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  -- Check if the user is the buyer of the order linked to this listing
  if not exists (
    select 1 from public.orders
    where orders.listing_id = p_listing_id
    and orders.buyer_id = auth.uid()
  ) then
    raise exception 'Not authorized';
  end if;

  -- Update the listing status
  update public.listing_items
  set status = 'Completed'
  where id = p_listing_id;
end;
$$;
</file>

<file path="create_complete_order_rpc.sql">
CREATE OR REPLACE FUNCTION complete_order(p_listing_id UUID)
RETURNS VOID AS $$
DECLARE
    v_buyer_id UUID;
    v_old_listing listing_items%ROWTYPE;
BEGIN
    -- 1. Get the listing and buyer info
    SELECT * INTO v_old_listing FROM listing_items WHERE id = p_listing_id;
    
    SELECT buyer_id INTO v_buyer_id FROM orders WHERE listing_id = p_listing_id;

    IF v_buyer_id IS NULL THEN
        RAISE EXCEPTION 'Order not found for listing %', p_listing_id;
    END IF;

    -- 2. Update old listing status to Completed
    UPDATE listing_items SET status = 'Completed' WHERE id = p_listing_id;

    -- 3. Create new listing for buyer
    INSERT INTO listing_items (
        catalog_id,
        seller_id,
        status,
        price,
        images,
        condition_grading
    ) VALUES (
        v_old_listing.catalog_id,
        v_buyer_id,
        'Draft',
        NULL,
        v_old_listing.images,
        v_old_listing.condition_grading
    );

END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="create_user_collections.sql">
-- Create user_collections table for manually added cards
create table public.user_collections (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) not null,
  catalog_id uuid references public.card_catalogs(id) not null,
  images jsonb not null default '[]'::jsonb,
  condition text,
  notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for user_collections
alter table public.user_collections enable row level security;

create policy "Users can view their own collection." 
on public.user_collections for select 
using (auth.uid() = user_id);

create policy "Users can insert into their own collection." 
on public.user_collections for insert 
with check (auth.uid() = user_id);

create policy "Users can update their own collection." 
on public.user_collections for update 
using (auth.uid() = user_id);

create policy "Users can delete from their own collection." 
on public.user_collections for delete 
using (auth.uid() = user_id);
</file>

<file path="enable_live_moment_sample.sql">
-- 最新のアイテム1つをLive Moment（金枠）に設定する
UPDATE listing_items
SET is_live_moment = TRUE
WHERE id = (
  SELECT id FROM listing_items
  ORDER BY created_at DESC
  LIMIT 1
);
</file>

<file path="package.json">
{
    "name": "tc-app-root",
    "version": "1.0.0",
    "private": true,
    "scripts": {
        "dev": "npm run dev --prefix frontend",
        "build": "npm run build --prefix frontend",
        "start": "npm run start --prefix frontend",
        "lint": "npm run lint --prefix frontend"
    },
    "dependencies": {
        "lucide-react": "^0.563.0"
    }
}
</file>

<file path="purchase_rpc.sql">
-- Function to handle item purchase transaction securely
create or replace function public.purchase_item(
  p_listing_id uuid,
  p_buyer_id uuid,
  p_total_amount integer,
  p_payment_method_id text,
  p_shipping_address text
)
returns uuid
language plpgsql
security definer -- Run with privileges of the creator (admin) to bypass RLS for status update
as $$
declare
  v_listing_status listing_status_enum;
  v_new_order_id uuid;
begin
  -- 1. Check if listing exists and is active
  select status into v_listing_status
  from public.listing_items
  where id = p_listing_id
  for update; -- Lock the row to prevent race conditions

  if v_listing_status is null then
    raise exception 'Listing not found';
  end if;

  if v_listing_status != 'Active' then
    raise exception 'Item is no longer available';
  end if;

  -- 2. Create Order
  insert into public.orders (
    listing_id,
    buyer_id,
    payment_method_id,
    total_amount,
    shipping_address,
    status
  ) values (
    p_listing_id,
    p_buyer_id,
    p_payment_method_id,
    p_total_amount,
    p_shipping_address,
    'Paid'
  )
  returning id into v_new_order_id;

  -- 3. Update Listing Status
  update public.listing_items
  set status = 'AwaitingShipment'
  where id = p_listing_id;

  return v_new_order_id;
end;
$$;
</file>

<file path="repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
downloads/
  chikamoto_back.png
  chikamoto_front.png
  hiroto_takahashi_back_1768266219133.png
  hiroto_takahashi_front_1768266203603.png
  ichiro_back.png
  ichiro_front.png
  katsuya_nomura_back_1768266219134_1768282897048.png
  katsuya_nomura_front_1768282877880.png
  kazuhiro_kiyohara_back_final_1768383719938.png
  kazuhiro_kiyohara_front_1768282945883.png
  kazuma_okamoto_back_1768266187933.png
  kazuma_okamoto_front_1768266171182.png
  kazuyoshi_tatsunami_back_1768266236821_1768282929679.png
  kazuyoshi_tatsunami_front_1768282911734.png
  live-moment-sample-test.csv
  maki_back.png
  maki_front.png
  masumi_kuwata_back_final_1768383756460.png
  masumi_kuwata_front_final_1768383738725.png
  murakami_back.png
  murakami_front.png
  roki_sasaki_back.png
  roki_sasaki_front.png
  sadaharu_oh_back_1768282860731.png
  sadaharu_oh_front_1768282839477.png
  sakamoto_back.png
  sakamoto_front.png
  sample-card1.zip
  sample-card2.zip
  seiji_uebayashi_back_1768266283635.png
  seiji_uebayashi_front_1768266268762.png
  seiya_suzuki_back.png
  seiya_suzuki_front.png
  shigeo_nagashima_back_1768282823107.png
  shigeo_nagashima_front_1768282806605.png
  shohei_ohtani_back.png
  shohei_ohtani_front.png
  shota_imanaga_back_1768266152976.png
  shota_imanaga_front_1768266137078.png
  ultimate_phantom_ace_16_9_1768470474343.png
  yamamoto_back.png
  yamamoto_front.png
  yoshida_back.png
  yoshida_front.png
  yu_darvish_back_1768266119714.png
  yu_darvish_front_1768266103651.png
  yuki_ishii_back_final_1768383796303.png
  yuki_ishii_front_final_1768383773628.png
  yuki_okabayashi_back_1768266253226.png
  yuki_okabayashi_front_1768266236820.png
  yumeto_kanamaru_back_final_1768383840757.png
  yumeto_kanamaru_front_final_1768383819511.png
  後半.png
frontend/
  app/
    actions/
      admin.ts
      item.ts
      order.ts
      payout.ts
      send-email.ts
    admin/
      moments/
        DeleteMomentButton.tsx
        MomentForm.tsx
        page.tsx
      payouts/
        page.tsx
        PayoutRow.tsx
      layout.tsx
      page.tsx
    api/
      ai/
        image/
          route.ts
        text/
          route.ts
      analyze-card/
        route.ts
      checkout/
        route.ts
      debug/
        config/
          route.ts
      debug-auth/
        route.ts
      debug-email/
        route.ts
      dev/
        moment/
          route.ts
      estimate-price/
        route.ts
      ping/
        route.ts
      webhooks/
        stripe/
          route.ts
    auctions/
      page.tsx
    checkout/
      [id]/
        page.tsx
    collection/
      page.tsx
    community/
      page.tsx
    debug-admin/
      page.tsx
    listings/
      [id]/
        page.tsx
    login/
      page.tsx
    market/
      page.tsx
    orders/
      [id]/
        success/
          page.tsx
      buy/
        [id]/
          page.tsx
      sell/
        [id]/
          page.tsx
    payouts/
      page.tsx
    profile/
      [userId]/
        page.tsx
      page.tsx
    register/
      page.tsx
    sell/
      page.tsx
    error.tsx
    favicon.ico
    global-error.tsx
    globals.css
    layout.tsx
    not-found.tsx
    page.tsx
  components/
    emails/
      OrderConfirmationEmail.tsx
      OrderReceivedEmail.tsx
      OrderShippedEmail.tsx
      PayoutRequestEmail.tsx
      ShippingRequestEmail.tsx
      WelcomeEmail.tsx
    AddToShowcaseModal.tsx
    CardListing.tsx
    DevTools.tsx
    Footer.tsx
    Header.tsx
    HeroSection.tsx
    LiveMomentListener.tsx
    LiveMomentToast.tsx
    MarketPriceLinks.tsx
    MomentHistoryBadge.tsx
    MomentHistoryPanel.tsx
    OrderHistory.tsx
    PremiumCardImage.tsx
    PurchaseAnimation.tsx
    ShowcaseCard.tsx
    SkeletonCard.tsx
  hooks/
    useZengin.ts
  lib/
    resend.ts
    stripe.ts
    teams.ts
  migrations/
    03_add_order_status.sql
    04_expand_listing_items.sql
    05_decouple_catalog.sql
    06_backfill_and_remove_catalog.sql
    07_update_complete_order_rpc.sql
    08_payout_system.sql
    09_add_shipping_to_orders.sql
    10_add_bank_codes.sql
    11_add_payout_fee.sql
    12_enhance_orders.sql
    13_fix_listing_rls.sql
    14_add_live_moments.sql
    15_add_moment_snapshot.sql
    16_add_moment_history.sql
    17_add_match_result_to_live_moments.sql
    18_add_is_finalized_to_live_moments.sql
    21_add_soft_delete_to_listings.sql
    22_add_origin_order_id_to_listings.sql
    23_add_incoming_to_listing_status_enum.sql
    24_add_seller_id_to_orders.sql
    25_fix_selling_view_rls.sql
    26_fix_buyer_seller_visibility.sql
    27_fix_rls_recursion.sql
    28_restore_mutation_rls.sql
    29_fix_workspace_visibility.sql
    30_self_healing_complete_order.sql
    31_allow_multiple_orders_per_listing.sql
    32_setup_storage.sql
    33_add_image_url_to_live_moments.sql
    debug_helper.sql
    debug_indexes.sql
    debug_triggers.sql
    fix_schema_add_condition_rating.sql
    production_setup.sql
    reset_data.sql
    Untitled-3
    Untitled-4
    Untitled-5
  public/
    bg-stadium.png
    file.svg
    globe.svg
    next.svg
    sample_card_back2.png
    sample_card_front1.png
    sample-card-back.png
    sample-card-front.png
    test.html
    vercel.svg
    window.svg
  scripts/
    debug_14fb.ts
    debug_7575.ts
    debug_c376.ts
    debug_moments.ts
    fix_sakamoto.ts
    seed.ts
    simulate_action.ts
    test-gemini.ts
  types/
    index.ts
  utils/
    supabase/
      client.ts
      middleware.ts
      server.ts
  .gitignore
  check_all_clones.ts
  check_constraints.ts
  check_enum.ts
  check_images.ts
  check_item_details.ts
  check_moments.ts
  check_order_prices.ts
  check_original_30k.ts
  check_prices.ts
  check_schema.ts
  check_seller.ts
  check_statuses.ts
  cleanup_ohtani.ts
  debug_22k.ts
  debug_30k.ts
  debug_39k.ts
  debug_all_items.ts
  debug_missing_card.ts
  debug_roki.ts
  debug_success_item.js
  deep_check_8e8eb573.ts
  dump_workspace.ts
  eslint.config.mjs
  final_cleanup.ts
  find_30k_card.ts
  find_buyer1_clone.ts
  find_buyer2.ts
  find_sasaki_30k.ts
  find_sold_logic.ts
  find_specific_clone.ts
  fix_buyer2_stuck_items.ts
  fix_final.ts
  get_enum_values.ts
  get_status_enum.ts
  inspect_listing.ts
  list_buyer2_items.ts
  manual_recovery.ts
  middleware.ts
  next.config.js
  package.json
  postcss.config.js
  README.md
  recover_39k.ts
  recover_sasaki.ts
  simulate_insert.ts
  tailwind.config.js
  TC-APP.code-workspace
  test_action.ts
  test_incoming.ts
  test.ts
  trace_order.ts
  trigger_recovery.ts
  tsconfig.json
  vercel.json
  verify_visibility.ts
migrations/
  01_add_profile_name_fields.sql
  02_create_live_moments.sql
specs/
  data_model.yaml
  openapi.yaml
  state_machine.md
supabase/
  migrations/
    20251220160000_add_origin_order_id.sql
add_address_columns.sql
add_columns.sql
add_delete_policy_listings.sql
add_live_moment_column.sql
add_more_catalog_items.sql
apply_rls_policies.sql
create_complete_order_function.sql
create_complete_order_rpc.sql
create_user_collections.sql
enable_live_moment_sample.sql
package.json
purchase_rpc.sql
seed_catalog.py
seed_data.sql
storage_policy.sql
supabase_schema.sql
test_image.txt
update_status_enum.sql
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="downloads/live-moment-sample-test.csv">
92f97a6f-15a8-40ea-8d9e-b956805c10d7,2025-12-09 06:29:35.059014+00,大谷 翔平,HOMERUN,大谷翔平、劇的なサヨナラ満塁ホームラン！今季40号達成！,9回裏、2アウト満塁。ドジャースタジアムが揺れた歴史的瞬間。,5,"{""inning"": ""9th Bottom"", ""opponent"": ""Rays"", ""video_url"": ""https://example.com/moment/ohtani-40.mp4"", ""related_card_ids"": []}"
</file>

<file path="frontend/app/actions/admin.ts">
'use server';

import { createClient } from '@supabase/supabase-js';
import { revalidatePath } from 'next/cache';

// Admin Client (Bypass RLS)
const getAdminClient = () => {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

export async function createLiveMoment(formData: FormData) {
    const playerName = formData.get('playerName') as string;
    const title = formData.get('title') as string;
    const type = formData.get('type') as string;
    const intensity = parseInt(formData.get('intensity') as string);
    const description = formData.get('description') as string;
    const imageUrl = formData.get('imageUrl') as string;

    // Structured Match Data
    const teamVisitor = formData.get('teamVisitor') as string;
    const scoreVisitor = formData.get('scoreVisitor') as string;
    const teamHome = formData.get('teamHome') as string;
    const scoreHome = formData.get('scoreHome') as string;
    const progress = formData.get('progress') as string;

    let matchResult = null;
    if (teamVisitor && teamHome) {
        matchResult = `${teamVisitor} ${scoreVisitor || '0'} - ${scoreHome || '0'} ${teamHome} (${progress || 'Pre-Game'})`;
    }

    if (!playerName || !title || !type) {
        throw new Error('Missing required fields');
    }

    const { error } = await getAdminClient()
        .from('live_moments')
        .insert({
            player_name: playerName,
            title,
            type,
            intensity,
            description,
            image_url: imageUrl,
            match_result: matchResult
        });

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}

export async function approvePayout(payoutId: string) {
    // 1. Mark Payout as Paid
    const { error } = await getAdminClient()
        .from('payouts')
        .update({
            status: 'paid',
            processed_at: new Date().toISOString()
        })
        .eq('id', payoutId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/payouts');
    revalidatePath('/admin/payouts');
    revalidatePath('/admin'); // KPI update
}

/**
 * Finalize a Live Moment (Game Set)
 * Updates the moment result and propagates it to all stamped cards.
 */
export async function finalizeMoment(momentId: string, formData: FormData) {
    let finalScore = formData.get('finalScore') as string;

    if (!momentId || !finalScore) {
        throw new Error('Missing required fields');
    }

    // Auto-update inning to "9回裏" if "Game Set" button is pressed (User Requirement)
    // Replaces pattern like "(Top 1st)" or "(1回表)" with "(9回裏)"
    const inningPattern = /\((?:Top|Bot)\s+\d+\w+\)|\(\d+回[表裏]\)/gi;
    if (inningPattern.test(finalScore)) {
        finalScore = finalScore.replace(inningPattern, '(9回裏)');
    }

    console.log(`Finalizing Moment ${momentId} with score: ${finalScore}`);

    // 1. Update Live Moment Record
    const { error: updateError } = await getAdminClient()
        .from('live_moments')
        .update({
            match_result: finalScore,
            is_finalized: true
        })
        .eq('id', momentId);

    if (updateError) throw new Error(`Failed to update moment: ${updateError.message}`);

    // 2. Propagate to Items (Sync Logic)
    // Find items that have this moment in their history
    // Since we use JSONB array, we can filter roughly by string match or JSON containment if supported.
    // For MVP, simplistic fetch & filter is safer if volume is low.
    // Or use pgsql contains operator '@>'. 
    // BUT supabase-js syntax for json array contains element with specific field value is tricky.
    // We'll fetch items where moment_history is not empty/null for efficiency, then filter in memory (MVP).
    // Or better: .not('moment_history', 'is', null)

    // Efficient Query Attempt:
    // We want rows where moment_history @> [{ "moment_id": "..." }]
    // Supabase TS: .contains('moment_history', JSON.stringify([{ moment_id: momentId }]))

    const { data: items, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('id, moment_history')
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (fetchError) {
        console.error('Error fetching affected items:', fetchError);
        // We don't throw, we effectively partial success (Moment updated, sync failed)
        // But better to warn.
    }

    if (items && items.length > 0) {
        console.log(`Syncing ${items.length} items for Moment ${momentId}...`);

        const updates = items.map(async (item) => {
            const history = item.moment_history as any[];
            const updatedHistory = history.map(h => {
                if (h.moment_id === momentId) {
                    return { ...h, match_result: finalScore, status: 'finalized' };
                }
                return h;
            });

            return getAdminClient()
                .from('listing_items')
                .update({ moment_history: updatedHistory })
                .eq('id', item.id);
        });

        await Promise.all(updates);
        console.log('Sync complete.');
    }

    revalidatePath('/admin/moments');
}

export async function updateLiveMoment(momentId: string, formData: FormData) {
    const playerName = formData.get('playerName') as string;
    const title = formData.get('title') as string;
    const type = formData.get('type') as string;
    const intensity = parseInt(formData.get('intensity') as string);
    const description = formData.get('description') as string;
    const imageUrl = formData.get('imageUrl') as string;

    // Structured Match Data
    const teamVisitor = formData.get('teamVisitor') as string;
    const scoreVisitor = formData.get('scoreVisitor') as string;
    const teamHome = formData.get('teamHome') as string;
    const scoreHome = formData.get('scoreHome') as string;
    const progress = formData.get('progress') as string;

    let matchResult = null;
    if (teamVisitor && teamHome) {
        matchResult = `${teamVisitor} ${scoreVisitor || '0'} - ${scoreHome || '0'} ${teamHome} (${progress || 'Pre-Game'})`;
    }

    if (!momentId || !playerName || !title || !type) {
        throw new Error('Missing required fields');
    }

    const admin = getAdminClient();

    // Checking usage in listing_items
    const { count } = await admin
        .from('listing_items')
        .select('id', { count: 'exact', head: true })
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (count && count > 0) {
        throw new Error("このモーメントはすでにカードに記録（配布）されているため、変更できません。");
    }

    const { error } = await admin
        .from('live_moments')
        .update({
            player_name: playerName,
            title,
            type,
            intensity,
            description,
            image_url: imageUrl,
            match_result: matchResult
        })
        .eq('id', momentId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}

export async function deleteLiveMoment(momentId: string) {
    if (!momentId) {
        throw new Error('Missing momentId');
    }

    const admin = getAdminClient();

    // Checking usage in listing_items
    const { count } = await admin
        .from('listing_items')
        .select('id', { count: 'exact', head: true })
        .contains('moment_history', JSON.stringify([{ moment_id: momentId }]));

    if (count && count > 0) {
        throw new Error("このモーメントはすでにカードに記録（配布）されているため、削除できません。");
    }

    const { error } = await admin
        .from('live_moments')
        .delete()
        .eq('id', momentId);

    if (error) throw new Error(error.message);

    revalidatePath('/admin/moments');
}
</file>

<file path="frontend/app/actions/item.ts">
'use server';

import { createClient as createServerClient } from '../../utils/supabase/server';
import { createClient } from '@supabase/supabase-js';
import { revalidatePath } from 'next/cache';
import { randomUUID } from 'crypto';

const getAdminClient = () => {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

/**
 * Soft delete an item
 */
export async function deleteItem(itemId: string) {
    console.log(`[Soft Delete] Archive Request: ${itemId}`);

    const { error } = await getAdminClient()
        .from('listing_items')
        .update({ deleted_at: new Date().toISOString() })
        .eq('id', itemId);

    if (error) {
        throw new Error(`Failed to archive item: ${error.message}`);
    }

    revalidatePath('/collection');
    return { success: true };
}

/**
 * Restore a soft-deleted item
 */
export async function restoreItem(itemId: string) {
    console.log(`[Soft Delete] Restore Request: ${itemId}`);

    const { error } = await getAdminClient()
        .from('listing_items')
        .update({ deleted_at: null })
        .eq('id', itemId);

    if (error) {
        throw new Error(`Failed to restore item: ${error.message}`);
    }

    revalidatePath('/collection');
    return { success: true };
}

/**
 * Add a memory note to a specific moment in the card's history
 */
// Old tagMomentMemory is deprecated/replaced by addMomentMemory
// We keep it temporarily if needed but essentially we are moving lightly.

/**
 * Delete a memory note (Set to null/empty)
 * Only the author of the note can delete it.
 */
/**
 * Add a new memory to the timeline
 */
export async function addMomentMemory(itemId: string, momentIndex: number, text: string, momentId?: string) {
    if (text.length > 150) throw new Error('Note must be less than 150 characters');

    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Item
    const { data: item, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('seller_id, moment_history, player_name')
        .eq('id', itemId)
        .single();

    if (fetchError || !item) throw new Error('Item not found');

    // Permission Check: Owner OR Current Buyer
    if (item.seller_id !== user.id) {
        const { data: order } = await getAdminClient()
            .from('orders')
            .select('id')
            .eq('listing_id', itemId)
            .eq('buyer_id', user.id)
            .neq('status', 'cancelled')
            .maybeSingle();

        if (!order) {
            throw new Error('Only the item owner or its buyer can record memories');
        }
    }

    // 2. Prepare History
    let history = [...(item.moment_history || [])];

    let targetIndex = momentIndex;
    if (momentId) {
        let foundIndex = history.findIndex((m: any) => m.moment_id === momentId);

        // --- SELF-HEALING (RESTORED & ENHANCED) ---
        // If not in item history, check if it's in a relevant order snapshot
        if (foundIndex === -1) {
            console.log(`[addMomentMemory] Moment ${momentId} not in item history. Checking order snapshots...`);
            const { data: order } = await getAdminClient()
                .from('orders')
                .select('id, moment_snapshot')
                .eq('listing_id', itemId)
                .eq('buyer_id', user.id)
                .neq('status', 'cancelled')
                .maybeSingle();

            if (order && order.moment_snapshot) {
                const snapshots = Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot];
                const snap = snapshots.find((s: any) => s.id === momentId);

                if (snap) {
                    console.log(`[Healing] Stamping missing snapshot ${momentId} to item ${itemId} before adding memory.`);
                    const newMomentEntry = {
                        moment_id: snap.id,
                        timestamp: new Date().toISOString(),
                        title: snap.title,
                        player_name: snap.player_name,
                        intensity: snap.intensity,
                        description: snap.description,
                        match_result: snap.match_result,
                        owner_at_time: order.id,
                        status: snap.is_finalized ? 'finalized' : 'pending'
                    };
                    history.push(newMomentEntry);
                    foundIndex = history.length - 1;
                }
            }
        }

        if (foundIndex !== -1) {
            targetIndex = foundIndex;
        } else {
            // Still not found, and index is out of bounds or invalid
            if (targetIndex < 0 || targetIndex >= history.length) {
                throw new Error('Invalid moment index');
            }
        }
    } else if (targetIndex < 0 || targetIndex >= history.length) {
        throw new Error('Invalid moment index');
    }

    // 3. Add Memory to Array
    const moment = history[targetIndex];
    const memories = Array.isArray(moment.memories) ? moment.memories : [];

    // Fetch Display Name (Nickname)
    const { data: profile } = await getAdminClient()
        .from('profiles')
        .select('display_name, name')
        .eq('id', user.id)
        .single();

    const authorDisplayName = profile?.display_name || profile?.name || user.user_metadata?.full_name || 'Owner';

    const newMemory = {
        id: randomUUID(),
        author_id: user.id,
        author_name: authorDisplayName, // Snapshot Nickname
        text: text,
        created_at: new Date().toISOString(),
        is_hidden: false
    };

    memories.push(newMemory);

    history[targetIndex] = {
        ...moment,
        memories: memories,
        // Legacy fields for backward compat (optional, or just clear them?)
        // user_note: text, // Maybe don't overwrite legacy to keep it safe?
        // note_updated_at: new Date().toISOString()
    };

    // 4. Save
    const { error: updateError } = await getAdminClient()
        .from('listing_items')
        .update({ moment_history: history })
        .eq('id', itemId);

    if (updateError) throw new Error(updateError.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Edit an existing memory
 */
export async function editMomentMemory(itemId: string, momentIndex: number, memoryId: string, newText: string, momentId?: string) {
    if (newText.length > 150) throw new Error('Note must be less than 150 characters');

    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }
    if (targetIndex < 0) throw new Error('Invalid index');

    const moment = history[targetIndex];
    const memories = Array.isArray(moment.memories) ? moment.memories : [];

    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    // Permission Check: Author only
    if (memories[memIndex].author_id !== user.id) throw new Error('You can only edit your own memories');

    // Refresh Display Name (Nickname) on Edit
    const { data: profile } = await getAdminClient()
        .from('profiles')
        .select('display_name, name')
        .eq('id', user.id)
        .single();

    const authorDisplayName = profile?.display_name || profile?.name || user.user_metadata?.full_name || memories[memIndex].author_name;

    memories[memIndex] = {
        ...memories[memIndex],
        text: newText,
        author_name: authorDisplayName,
        updated_at: new Date().toISOString()
    };

    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * PHYSICALLY Delete a memory
 * Only the author can physically delete their own memory.
 */
export async function deleteMomentMemory(itemId: string, momentIndex: number, memoryId: string, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }

    const moment = history[targetIndex];
    let memories = Array.isArray(moment.memories) ? moment.memories : [];
    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    const memory = memories[memIndex];

    // Author Check: ONLY the author can physically delete.
    if (memory.author_id !== user.id) {
        throw new Error('Only the original author can physically delete this memory. Owners should use Hide instead.');
    }

    // Physical Delete
    memories.splice(memIndex, 1);
    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * LOGICALLY Hide/Unhide a memory
 * Both the current card owner AND the original author can toggle visibility.
 */
export async function toggleHideMomentMemory(itemId: string, momentIndex: number, memoryId: string, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item } = await getAdminClient().from('listing_items').select('seller_id, moment_history').eq('id', itemId).single();
    if (!item) throw new Error('Item not found');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;
    if (momentId) {
        const idx = history.findIndex((m: any) => m.moment_id === momentId);
        if (idx !== -1) targetIndex = idx;
    }

    const moment = history[targetIndex];
    let memories = Array.isArray(moment.memories) ? moment.memories : [];
    const memIndex = memories.findIndex((m: any) => m.id === memoryId);
    if (memIndex === -1) throw new Error('Memory not found');

    // Permission Check: Owner or Author
    if (item.seller_id !== user.id && memories[memIndex].author_id !== user.id) {
        throw new Error('Only the current owner or the original author can change visibility');
    }

    // Toggle
    memories[memIndex].is_hidden = !memories[memIndex].is_hidden;
    history[targetIndex] = { ...moment, memories };

    const { error } = await getAdminClient().from('listing_items').update({ moment_history: history }).eq('id', itemId);
    if (error) throw new Error(error.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Hide/Unhide an entire moment in the history
 * Only the current card owner can hide/unhide whole moments.
 */
export async function toggleHideMoment(itemId: string, momentIndex: number, isHidden: boolean, momentId?: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) throw new Error('Unauthorized');

    const { data: item, error: fetchError } = await getAdminClient()
        .from('listing_items')
        .select('seller_id, moment_history')
        .eq('id', itemId)
        .single();

    if (fetchError || !item) throw new Error('Item not found');
    if (item.seller_id !== user.id) throw new Error('Only the owner can manage memories');

    let history = [...(item.moment_history || [])];
    let targetIndex = momentIndex;

    if (momentId) {
        const foundIndex = history.findIndex((m: any) => m.moment_id === momentId);
        if (foundIndex !== -1) targetIndex = foundIndex;
    }

    if (targetIndex < 0 || targetIndex >= history.length) throw new Error('Invalid index');

    // Logical delete (Hide)
    history[targetIndex] = {
        ...history[targetIndex],
        is_hidden: isHidden
    };

    const { error: updateError } = await getAdminClient()
        .from('listing_items')
        .update({ moment_history: history })
        .eq('id', itemId);

    if (updateError) throw new Error(updateError.message);

    revalidatePath(`/listings/${itemId}`);
    revalidatePath('/collection');
    return { success: true };
}

/**
 * Find the item that was cloned for the buyer after a successful order
 */
export async function getBuyerItemByOrder(orderId: string) {
    const supabase = await createServerClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error("FATAL: SUPABASE_SERVICE_ROLE_KEY is missing in Action environment.");
        return null;
    }

    try {
        // 1. Get order details
        const { data: order } = await getAdminClient()
            .from('orders')
            .select('listing_id, buyer_id, status, moment_snapshot, listing:listing_items!listing_id(*)')
            .eq('id', orderId)
            .single();

        if (!order) return null;

        // Security check
        if (order.buyer_id !== user.id) return null;

        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (!listing) return null;

        return {
            id: listing.id,
            history: listing.moment_history || []
        };
    } catch (criticalError: any) {
        console.error("[getBuyerItemByOrder] Critical Crash:", criticalError);
        return null;
    }
}
</file>

<file path="frontend/app/actions/order.ts">
'use server';

import { createClient } from '../../utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';
import { resend } from '../../lib/resend';
import OrderShippedEmail from '../../components/emails/OrderShippedEmail';
import OrderReceivedEmail from '../../components/emails/OrderReceivedEmail';
import { ReactElement } from 'react';

// Admin Client for Privileged Operations (Fetching Emails)
// Helper to get Admin Client safely
function getAdminClient() {
    console.log("[Debug] getAdminClient called. Checking env vars...");
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error("FATAL: SUPABASE_SERVICE_ROLE_KEY is missing/undefined in Vercel environment.");
        throw new Error('Server Config Error: SUPABASE_SERVICE_ROLE_KEY is missing.');
    }
    return createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        }
    );
}

/**
 * Mark Order as Shipped
 * Access: Seller Only
 */
export async function markAsShipped(orderId: string, trackingNumber?: string, carrier?: string) {
    const supabase = await createClient(); // Standard Client for Auth/RLS check
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order and Verify Ownership
    const { data: order, error: fetchError } = await supabase
        .from('orders')
        .select(`
            id,
            buyer_id,
            seller_id,
            status,
            listing:listing_items!listing_id (
                id, seller_id, series_name, player_name
            )
        `)
        .eq('id', orderId)
        .single();

    if (fetchError || !order) throw new Error('Order not found');

    // Verify Seller
    const listingDetail = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    console.log(`[Debug markAsShipped] Order: ${orderId}, User: ${user.id}, ListingSeller: ${listingDetail?.seller_id}, OrderSeller: ${order.seller_id}`);

    const isListingSeller = listingDetail.seller_id === user.id;
    const isOrderSeller = order.seller_id === user.id;

    if (!isListingSeller && !isOrderSeller) {
        const msg = `[Debug] Unauthorized: Seller ID mismatch. UserID=${user.id}, ListingSellerID=${listingDetail.seller_id}, OrderSellerID=${order.seller_id}`;
        console.error(msg);
        throw new Error(msg);
    }

    // 2. Update Order Status (Using Admin to bypass RLS/Policy constraints)
    const { error: updateError } = await getAdminClient()
        .from('orders')
        .update({
            status: 'shipped',
            tracking_number: trackingNumber,
            carrier: carrier,
            shipped_at: new Date().toISOString()
        })
        .eq('id', orderId);

    if (updateError) throw new Error(updateError.message);

    // 3. Send Email to Buyer (requires Admin to fetch email)
    try {
        const { data: buyerUser, error: buyerError } = await getAdminClient().auth.admin.getUserById(order.buyer_id);

        if (buyerUser && buyerUser.user && buyerUser.user.email) {
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
            const { error: emailError } = await resend.emails.send({
                from: 'Stadium Card <notifications@resend.dev>',
                to: [buyerUser.user.email],
                subject: 'Your Item Has Been Shipped',
                react: OrderShippedEmail({
                    buyerName: buyerUser.user.user_metadata?.full_name || 'Collector',
                    productName: listingDetail.player_name || listingDetail.series_name,
                    trackingNumber,
                    carrier,
                    orderUrl: `${baseUrl}/orders/buy/${order.id}`,
                    baseUrl
                }) as ReactElement
            });
            if (emailError) console.error('Email Error:', emailError);
        }
    } catch (err) {
        console.error('Failed to send email:', err);
        // Do not throw error here, as status update succeeded
    }

    return { success: true };
}

/**
 * Mark Order as Received (Completed)
 * Access: Buyer Only
 * Effect: Unlocks Funds (by setting listing status to Completed)
 */
export async function markAsReceived(orderId: string) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order details
    const { data: order, error: fetchError } = await supabase
        .from('orders')
        .select(`
            id,
            buyer_id,
            listing_id,
            status,
            listing:listing_items!listing_id (
                id, seller_id, series_name, player_name
            )
        `)
        .eq('id', orderId)
        .single();

    if (fetchError || !order) throw new Error('Order not found');

    // Verify Buyer
    if (order.buyer_id !== user.id) {
        throw new Error('Unauthorized: You are not the buyer.');
    }

    // 2. Call RPC to complete the order and unlock funds
    // We pass listing_id to RPC
    const { error: rpcError } = await supabase.rpc('complete_order', {
        p_listing_id: order.listing_id
    });

    if (rpcError) throw new Error(rpcError.message);

    // Also explicitly set completed_at (RPC might miss it if logic not updated)
    await getAdminClient().from('orders').update({
        completed_at: new Date().toISOString()
    }).eq('id', orderId);

    // --- Unlock Item for Buyer's Workspace ---
    try {
        const { getBuyerItemByOrder } = await import('./item');
        const buyerItemData = await getBuyerItemByOrder(orderId);
        if (buyerItemData?.id) {
            console.log(`[markAsReceived] Unlocking item ${buyerItemData.id} for buyer.`);
            await getAdminClient()
                .from('listing_items')
                .update({
                    status: 'Draft',
                    origin_order_id: orderId // Ensure link is set even if webhook failed
                })
                .eq('id', buyerItemData.id)
                .in('status', ['Incoming', 'AwaitingShipment', 'Active']); // Added 'Active' safety net
        }
    } catch (unlockErr) {
        console.error('[markAsReceived] Failed to unlock item:', unlockErr);
    }

    // Prepare Listing Detail safe access
    const listingDetail = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    // 3. Send Email to Seller (Funds Added Notification) & Auto-Clone
    try {
        const { data: sellerUser, error: sellerError } = await getAdminClient().auth.admin.getUserById(listingDetail.seller_id);

        if (sellerUser && sellerUser.user && sellerUser.user.email) {
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

            // 4. Send Email to Seller
            const { error: emailError } = await resend.emails.send({
                from: 'Trade Card App <onboarding@resend.dev>',
                to: [sellerUser.user.email],
                subject: 'Transaction Completed: Funds Added',
                react: OrderReceivedEmail({
                    sellerName: sellerUser.user.user_metadata?.full_name || 'Seller',
                    productName: listingDetail.player_name || listingDetail.series_name,
                    payoutUrl: `${baseUrl}/payouts`
                }) as ReactElement
            });
            if (emailError) console.error('Email Error:', emailError);
        }
    } catch (err) {
        console.error('Failed to send email:', err);
    }

    return { success: true };
}


/**
 * Fetch Order Details for Seller (Bypassing RLS)
 */
export async function getSellerOrderDetails(orderId: string) {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
        throw new Error('Server configuration error');
    }

    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    console.log('Fetching order (Seller):', orderId);

    // 1. Fetch Order (No Join)
    const { data: order, error: orderError } = await getAdminClient()
        .from('orders')
        .select('*')
        .eq('id', orderId)
        .single();

    if (orderError || !order) {
        console.error('Admin Fetch Order Error:', JSON.stringify(orderError));
        throw new Error('Order not found in database');
    }

    // 2. Fetch Listing (Manual Join)
    const { data: listing, error: listingError } = await getAdminClient()
        .from('listing_items')
        .select('id, series_name, player_name, images, price, seller_id')
        .eq('id', order.listing_id)
        .single();

    if (listingError || !listing) {
        console.error('Admin Fetch Listing Error:', JSON.stringify(listingError));
        throw new Error('Associated listing not found');
    }

    // Explicit Ownership Check
    console.log(`[Debug getSellerOrderDetails] Order: ${orderId}, User: ${user.id}, Seller: ${listing.seller_id}, OrderSeller: ${order.seller_id}`);

    const isListingSeller = listing.seller_id === user.id;
    const isOrderSeller = order.seller_id === user.id;

    if (!isListingSeller && !isOrderSeller) {
        const msg = `[Debug] Unauthorized: Seller ID mismatch in getSellerOrderDetails. UserID=${user.id}, ListingSellerID=${listing.seller_id}, OrderSellerID=${order.seller_id}`;
        console.error(msg);
        throw new Error(msg);
    }

    // Combine
    return {
        ...order,
        listing: {
            ...listing,
            title: listing.series_name || listing.player_name
        }
    };
}

/**
 * Fetch Order Details for Buyer (Bypassing RLS)
 */
export async function getBuyerOrderDetails(orderId: string) {
    if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
        console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
        throw new Error('Server configuration error');
    }

    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) throw new Error('Unauthorized');

    // 1. Fetch Order
    const { data: order, error: orderError } = await getAdminClient()
        .from('orders')
        .select('*')
        .eq('id', orderId)
        .single();

    if (orderError || !order) {
        console.error('Admin Fetch Order (Buyer) Error:', JSON.stringify(orderError));
        throw new Error('Order not found');
    }

    // Verify Buyer
    if (order.buyer_id !== user.id) {
        throw new Error('Unauthorized: You are not the buyer.');
    }

    // 2. Fetch Listing
    const { data: listing, error: listingError } = await getAdminClient()
        .from('listing_items')
        .select('id, series_name, player_name, images, price, seller_id, status, moment_history')
        .eq('id', order.listing_id)
        .single();

    if (listingError || !listing) {
        console.error('Fetch Listing Error:', listingError);
        throw new Error(`Listing details not found: ${listingError?.message || 'Unknown error'}`);
    }

    return {
        ...order,
        listing: {
            ...listing,
            title: listing.series_name || listing.player_name
        }
    };
}

/**
 * Fetch All Orders for Seller
 */
export async function getSellerOrders() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];

    const { data, error } = await getAdminClient()
        .from('orders')
        .select(`
            id,
            status,
            total_amount,
            created_at,
            listing:listing_items!listing_id (
                title, player_name, images, series_name
            )
        `)
        .eq('seller_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching seller orders:', error);
        return [];
    }

    return data.map((order: any) => ({
        ...order,
        listing: Array.isArray(order.listing) ? order.listing[0] : order.listing
    }));
}

/**
 * Fetch All Orders for Buyer
 */
export async function getBuyerOrders() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) return [];

    const { data, error } = await getAdminClient()
        .from('orders')
        .select(`
            id,
            status,
            total_amount,
            created_at,
            listing:listing_items!listing_id (
                title, player_name, images, series_name
            )
        `)
        .eq('buyer_id', user.id)
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching buyer orders:', error);
        return [];
    }

    return data.map((order: any) => ({
        ...order,
        listing: Array.isArray(order.listing) ? order.listing[0] : order.listing
    }));
}
</file>

<file path="frontend/app/actions/payout.ts">
'use server';

import { createClient } from '../../utils/supabase/server';
import { Payout } from '../../types';

import { Resend } from 'resend';
import { PayoutRequestEmail } from '../../components/emails/PayoutRequestEmail';
import { ReactElement } from 'react';

// Constants
const PLATFORM_FEE_PERCENTAGE = 0.1; // 10%
const resend = new Resend(process.env.RESEND_API_KEY);

/**
 * Logic A: Calculate Available Balance
 * Formula: (Total Sold Items Price * 0.9) - (Total Payouts Request/Paid)
 */
export async function getAvailableBalance(userId: string) {
    const supabase = await createClient();

    // 1. Fetch Sold Items from Orders (Status: Completed)
    // We use 'orders' because ownership of 'listing_items' transfers to the buyer upon completion.
    const { data: soldOrders, error: soldError } = await supabase
        .from('orders')
        .select('total_amount')
        .eq('seller_id', userId)
        .eq('status', 'completed');

    if (soldError) throw new Error(soldError.message);

    const totalSoldAmount = soldOrders?.reduce((sum, order) => sum + (order.total_amount || 0), 0) || 0;
    const totalEarnings = Math.floor(totalSoldAmount * (1 - PLATFORM_FEE_PERCENTAGE));

    // 2. Fetch Payouts (All status except rejected)
    const { data: payouts, error: payoutError } = await supabase
        .from('payouts')
        .select('amount, status')
        .eq('user_id', userId)
        .neq('status', 'rejected');

    if (payoutError) throw new Error(payoutError.message);

    const totalPayouts = payouts?.reduce((sum, p) => sum + p.amount, 0) || 0;

    return {
        totalSold: totalSoldAmount,
        totalEarnings: totalEarnings,
        withdrawn: totalPayouts,
        available: totalEarnings - totalPayouts
    };
}

/**
 * Update Profile Real Name (Kana)
 */
export async function updateProfileKana(userId: string, kana: string) {
    const supabase = await createClient();

    // Sanitize: Remove all spaces (half/full width)
    const sanitizedKana = kana.replace(/[\s\u3000]+/g, '');

    // Validate Kana (Katakana Only)
    const kanaRegex = /^[\u30A0-\u30FF]+$/;
    if (!kanaRegex.test(sanitizedKana)) {
        throw new Error('Real name must be in full-width Katakana.');
    }

    const { error } = await supabase
        .from('profiles')
        .update({ real_name_kana: sanitizedKana })
        .eq('id', userId);

    if (error) throw new Error(error.message);
    return { success: true };
}

/**
 * Logic B: Register Bank Account
 * Enforces KYC Name Match
 */
export async function registerBankAccount(userId: string, bankData: {
    bankName: string;
    bankCode?: string;
    branchName: string;
    branchCode?: string;
    accountType: 'ordinary' | 'current';
    accountNumber: string;
    accountHolderName?: string; // Optional from client, we override
}) {
    const supabase = await createClient();

    // 1. Get User Profile for Kata Name
    const { data: profile } = await supabase
        .from('profiles')
        .select('real_name_kana')
        .eq('id', userId)
        .single();

    if (!profile || !profile.real_name_kana) {
        throw new Error("Profile name (Katakana) is required.");
    }

    // 2. Validate Kana Match (Implicitly enforced by OVERRIDING the input)
    // We ignore bankData.accountHolderName and use profile.real_name_kana
    // Sanitize spaces just in case
    const safeHolderName = profile.real_name_kana.replace(/[\s\u3000]+/g, '');

    const { error } = await supabase
        .from('bank_accounts')
        .upsert({
            user_id: userId,
            bank_name: bankData.bankName,
            bank_code: bankData.bankCode,
            branch_name: bankData.branchName,
            branch_code: bankData.branchCode,
            account_type: bankData.accountType,
            account_number: bankData.accountNumber,
            account_holder_name: safeHolderName,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' });

    if (error) {
        console.error('Bank Reg Error:', error);
        throw new Error(error.message || 'Failed to register bank account.');
    }
    return { success: true };
}

const WITHDRAWAL_FEE = 250;
const FEE_EXEMPTION_THRESHOLD = 30000;

/**
 * Logic C: Request Payout
 */
export async function requestPayout(userId: string, netAmount: number) {
    const supabase = await createClient();

    if (netAmount <= 0) throw new Error('Invalid amount.');

    // 0. Verify Bank Account Exists
    const bankAccount = await getBankAccount(userId);
    if (!bankAccount) {
        throw new Error('Please register a bank account before requesting a payout.');
    }

    // 1. Calculate Fee based on Net Amount
    // Rule: If Net Payout is >= 30,000, Fee is 0.
    let fee = WITHDRAWAL_FEE;
    if (netAmount >= FEE_EXEMPTION_THRESHOLD) {
        fee = 0;
    }

    const grossAmount = netAmount + fee; // Total Deduction from Balance

    // 2. Check Balance against Gross Amount
    const balance = await getAvailableBalance(userId);
    if (balance.available < grossAmount) {
        throw new Error(`Insufficient balance. You need ¥${grossAmount.toLocaleString()} (Amount + Fee) but have ¥${balance.available.toLocaleString()}.`);
    }

    // 3. Create Payout Record
    const { error } = await supabase
        .from('payouts')
        .insert({
            user_id: userId,
            amount: grossAmount,     // Total Balance Deduction
            fee: fee,
            payout_amount: netAmount, // Actual Transfer Amount
            status: 'pending'
        });

    if (error) throw new Error(error.message);

    // 4. Send Notification to Admins
    if (process.env.ADMIN_EMAILS) {
        try {
            const adminEmails = process.env.ADMIN_EMAILS.split(',').map(e => e.trim());
            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

            // Fetch User Name for Email
            const { data: profile } = await supabase
                .from('profiles')
                .select('name')
                .eq('id', userId)
                .single();

            const userName = profile?.name || 'Unknown User';

            const fromEmail = process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev';
            await resend.emails.send({
                from: `Stadium Card <${fromEmail}>`,
                to: adminEmails,
                subject: 'New Payout Request',
                react: PayoutRequestEmail({
                    userName,
                    amount: netAmount,
                    payoutId: 'New', // We don't have ID easily unless we select it back. Using generic label.
                    adminUrl: `${baseUrl}/admin/payouts`
                }) as ReactElement
            });
        } catch (emailErr) {
            console.error("Failed to send admin notification:", emailErr);
            // Non-blocking error
        }
    }

    return { success: true };
}

/**
 * Fetch Payout History
 */
export async function getPayoutHistory(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('payouts')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data as Payout[];
}

/**
 * Fetch Registered Bank Account
 */
export async function getBankAccount(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('bank_accounts')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') throw new Error(error.message); // Ignore "not found"
    return data;
}

/**
 * Fetch Profile Kana
 */
export async function getProfileKana(userId: string) {
    const supabase = await createClient();
    const { data, error } = await supabase
        .from('profiles')
        .select('real_name_kana')
        .eq('id', userId)
        .single();

    if (error) return null;
    return data?.real_name_kana;
}
</file>

<file path="frontend/app/actions/send-email.ts">
'use server';

import { resend } from '../../lib/resend';
import WelcomeEmail from '../../components/emails/WelcomeEmail';
import { ReactElement } from 'react';

/**
 * Sends a welcome email to the specified user.
 * @param email - Recipient email address
 * @param name - User's name (optional)
 */
export async function sendWelcomeEmail(email: string, name: string = 'Member') {
    try {
        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';

        const { data, error } = await resend.emails.send({
            from: 'Stadium Card <onboarding@resend.dev>', // Update this to your verified domain in production
            to: [email],
            subject: 'Welcome to Stadium Card',
            react: WelcomeEmail({ userFirstname: name, baseUrl }) as ReactElement,
        });

        if (error) {
            console.error('Email sending failed:', error);
            return { success: false, error: error.message };
        }

        return { success: true, data };
    } catch (e) {
        console.error('Unexpected error sending email:', e);
        return { success: false, error: 'Internal Server Error' };
    }
}
</file>

<file path="frontend/app/admin/moments/DeleteMomentButton.tsx">
'use client';

import { deleteLiveMoment } from '@/app/actions/admin';
import { useFormStatus } from 'react-dom';

export default function DeleteMomentButton({ id }: { id: string }) {
    return (
        <form action={deleteLiveMoment.bind(null, id)}>
            <DeleteButtonInner />
        </form>
    );
}

function DeleteButtonInner() {
    const { pending } = useFormStatus();

    return (
        <button
            type="submit"
            disabled={pending}
            className="text-xs text-red-500 hover:text-red-400 flex items-center gap-1 disabled:opacity-50"
            onClick={(e) => {
                if (!confirm('本当に削除しますか？')) e.preventDefault();
            }}
        >
            {pending ? '削除中...' : '🗑️ 削除'}
        </button>
    );
}
</file>

<file path="frontend/app/admin/moments/MomentForm.tsx">
'use client';

import { useState, useActionState, useEffect } from 'react';
import { createClient } from '@/utils/supabase/client';
import { createLiveMoment, updateLiveMoment } from '@/app/actions/admin';
import { TEAM_GROUPS } from '@/lib/teams';
import Link from 'next/link';
import { Loader2 } from 'lucide-react';
import Image from 'next/image';

type MomentFormProps = {
    editingMoment?: any;
    defaultValues: {
        player: string;
        title: string;
        desc: string;
        intensity: string;
        visitor: string;
        home: string;
        scoreV: string;
        scoreH: string;
        progress: string;
        type: string;
    };
    isAutoFilled?: boolean;
};

export default function MomentForm({ editingMoment, defaultValues, isAutoFilled }: MomentFormProps) {
    const [isGenerating, setIsGenerating] = useState(false);
    const [generatedImage, setGeneratedImage] = useState<string | null>(null); // Base64
    const [isUploading, setIsUploading] = useState(false);
    const [uploadError, setUploadError] = useState<string | null>(null);

    // AI Text Draft State
    const [isDrafting, setIsDrafting] = useState(false);
    const [draftKeywords, setDraftKeywords] = useState("");

    // Form State (Controlled for AI Auto-fill)
    const [playerName, setPlayerName] = useState(editingMoment?.player_name || defaultValues.player);
    const [title, setTitle] = useState(editingMoment?.title || defaultValues.title);
    const [type, setType] = useState(editingMoment?.type || (defaultValues.type || 'BIG_PLAY'));
    const [intensity, setIntensity] = useState(editingMoment?.intensity || defaultValues.intensity || "3");
    const [description, setDescription] = useState(editingMoment?.description || defaultValues.desc);

    // Auto-scroll to generate button if auto-filled
    useEffect(() => {
        if (isAutoFilled && !editingMoment) {
            const btn = document.getElementById('generate-btn');
            if (btn) btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, [isAutoFilled, editingMoment]);

    const handleAiDraft = async () => {
        setIsDrafting(true);
        try {
            // Combine inputs for context
            const contextKeywords = [
                playerName,
                type,
                draftKeywords
            ].filter(Boolean).join(", ");

            const res = await fetch('/api/ai/text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords: contextKeywords }),
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            // Auto-fill fields
            if (data.title) setTitle(data.title);
            if (data.desc) setDescription(data.desc);
            if (data.intensity) setIntensity(String(data.intensity));

        } catch (e: any) {
            alert(`AI Draft Error: ${e.message}`);
        } finally {
            setIsDrafting(false);
        }
    };

    const handleGenerate = async () => {
        if (!description) {
            alert("画像生成には「詳細説明」が必要です。");
            return;
        }
        setIsGenerating(true);
        setGeneratedImage(null);
        try {
            const res = await fetch('/api/ai/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: description }),
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            setGeneratedImage(`data:image/png;base64,${data.b64_json}`);
        } catch (e: any) {
            alert(`生成エラー: ${e.message}`);
        } finally {
            setIsGenerating(false);
        }
    };

    const handleSubmit = async (formData: FormData) => {
        setIsUploading(true);
        setUploadError(null);

        try {
            let imageUrl = editingMoment?.image_url || null;

            // If we have a new generated image, upload it
            if (generatedImage) {
                const supabase = createClient();
                const blob = await (await fetch(generatedImage)).blob();
                const fileExt = 'png';
                const fileName = `generated-${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError, data } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, blob, {
                        contentType: 'image/png',
                        upsert: false
                    });

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                imageUrl = publicUrl;
            }

            if (imageUrl) {
                formData.append('imageUrl', imageUrl);
            }

            // Call Server Action
            if (editingMoment) {
                await updateLiveMoment(editingMoment.id, formData);
            } else {
                await createLiveMoment(formData);
            }

            // Reset only if successful create (update keeps user on page usually, but our action redirects/revalidates)
            // Ideally we'd reset state if we stay, but the server action revalidates path.

        } catch (e: any) {
            console.error(e);
            setUploadError(e.message);
            setIsUploading(false); // Stop loading on error
            return; // Don't proceed
        }

        setIsUploading(false);
    };

    return (
        <form action={handleSubmit} className="space-y-4">
            {uploadError && (
                <div className="bg-red-500/10 border border-red-500 text-red-400 p-3 rounded text-sm">
                    {uploadError}
                </div>
            )}

            {/* Player Name */}
            <div>
                <label className="block text-sm text-gray-400 mb-1">選手名 (Player Name)</label>
                <input
                    name="playerName"
                    required
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="例: 大谷翔平 / Shohei Ohtani"
                />
            </div>

            {/* AI Text Generation Control */}
            <div className="bg-gray-800/50 p-3 rounded border border-gray-700/50 flex flex-col gap-2">
                <div className="flex gap-2 items-center">
                    <input
                        value={draftKeywords}
                        onChange={(e) => setDraftKeywords(e.target.value)}
                        placeholder="AI生成用キーワード (例: 甲子園, 場外弾, 逆転サヨナラ)"
                        className="flex-1 bg-black/50 border border-white/20 rounded px-3 py-2 text-white text-sm focus:border-[#FFD700] outline-none"
                    />
                    <button
                        type="button"
                        onClick={handleAiDraft}
                        disabled={isDrafting}
                        className="bg-teal-600 hover:bg-teal-500 text-white text-sm font-bold px-4 py-2 rounded flex items-center gap-2 transition-colors whitespace-nowrap"
                    >
                        {isDrafting ? <Loader2 className="w-4 h-4 animate-spin" /> : '✨ AI Draft (Claude)'}
                    </button>
                </div>
                <p className="text-[10px] text-gray-500">
                    ※ 選手名とキーワードから、タイトル・説明・熱狂度を自動生成します。
                </p>
            </div>

            <div>
                <label className="block text-sm text-gray-400 mb-1">タイトル (Title)</label>
                <input
                    name="title"
                    required
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="例: Walk-off Home Run"
                />
            </div>

            {/* Match Status */}
            <div className="bg-black/30 p-3 rounded border border-white/10 space-y-3">
                <label className="block text-sm text-gray-400 -mb-2">試合状況 (Match Status)</label>

                {/* Visitor */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">ビジター</span>
                    <select
                        name="teamVisitor"
                        required
                        defaultValue={defaultValues.visitor}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="">チーム選択...</option>
                        {TEAM_GROUPS.map((group) => (
                            <optgroup key={group.label} label={group.label}>
                                {group.teams.map((team) => (
                                    <option key={team.code} value={team.code}>{team.name}</option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                    <input
                        name="scoreVisitor"
                        type="number"
                        min="0"
                        placeholder="0"
                        defaultValue={defaultValues.scoreV}
                        className="w-16 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center focus:border-[#FFD700]"
                    />
                </div>

                {/* Home */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">ホーム</span>
                    <select
                        name="teamHome"
                        required
                        defaultValue={defaultValues.home}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="">チーム選択...</option>
                        {TEAM_GROUPS.map((group) => (
                            <optgroup key={group.label} label={group.label}>
                                {group.teams.map((team) => (
                                    <option key={team.code} value={team.code}>{team.name}</option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                    <input
                        name="scoreHome"
                        type="number"
                        min="0"
                        placeholder="0"
                        defaultValue={defaultValues.scoreH}
                        className="w-16 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center focus:border-[#FFD700]"
                    />
                </div>

                {/* Progress */}
                <div className="flex gap-2 items-center">
                    <span className="text-xs text-gray-500 w-12">進行</span>
                    <select
                        name="progress"
                        defaultValue={editingMoment ? defaultValues.progress : (defaultValues.progress || 'Top 1st')}
                        className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm focus:border-[#FFD700]"
                    >
                        <option value="Top 1st">Top 1st (1回表)</option>
                        <option value="Bot 1st">Bot 1st (1回裏)</option>
                        <option value="Top 2nd">Top 2nd (2回表)</option>
                        <option value="Bot 2nd">Bot 2nd (2回裏)</option>
                        <option value="Top 3rd">Top 3rd (3回表)</option>
                        <option value="Bot 3rd">Bot 3rd (3回裏)</option>
                        <option value="Top 4th">Top 4th (4回表)</option>
                        <option value="Bot 4th">Bot 4th (4回裏)</option>
                        <option value="Top 5th">Top 5th (5回表)</option>
                        <option value="Bot 5th">Bot 5th (5回裏)</option>
                        <option value="Top 6th">Top 6th (6回表)</option>
                        <option value="Bot 6th">Bot 6th (6回裏)</option>
                        <option value="Top 7th">Top 7th (7回表)</option>
                        <option value="Bot 7th">Bot 7th (7回裏)</option>
                        <option value="Top 8th">Top 8th (8回表)</option>
                        <option value="Bot 8th">Bot 8th (8回裏)</option>
                        <option value="Top 9th">Top 9th (9回表)</option>
                        <option value="Bot 9th">Bot 9th (9回裏)</option>
                        <option value="Top 10th">Top 10th (10回表)</option>
                        <option value="Bot 10th">Bot 10th (10回裏)</option>
                        <option value="Top 11th">Top 11th (11回表)</option>
                        <option value="Bot 11th">Bot 11th (11回裏)</option>
                        <option value="Top 12th">Top 12th (12回表)</option>
                        <option value="Bot 12th">Bot 12th (12回裏)</option>
                        <option value="Final">Final (試合終了)</option>
                    </select>
                </div>
            </div>

            <div>
                <label className="block text-sm text-gray-400 mb-1">イベントタイプ (Type)</label>
                <select
                    name="type"
                    value={type}
                    onChange={(e) => setType(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                >
                    <option value="HOMERUN">ホームラン (Homerun)</option>
                    <option value="STRIKEOUT">奪三振 (Strikeout)</option>
                    <option value="TIMELY">タイムリー/長打 (Timely/Hit)</option>
                    <option value="VICTORY">勝利 (Victory)</option>
                    <option value="RECORD_BREAK">記録達成 (Record Breaker)</option>
                    <option value="BIG_PLAY">好プレー/その他 (Big Play)</option>
                </select>
            </div>
            <div>
                <label className="block text-sm text-gray-400 mb-1">熱狂度 (Intensity 1-5)</label>
                <select
                    name="intensity"
                    value={intensity}
                    onChange={(e) => setIntensity(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                >
                    <option value="5">5 - Legendary (伝説級)</option>
                    <option value="4">4 - High (高)</option>
                    <option value="3">3 - Medium (中)</option>
                    <option value="2">2 - Low (低)</option>
                    <option value="1">1 - Minimal (最小)</option>
                </select>
            </div>
            <div>
                <label className="block text-sm text-gray-400 mb-1">詳細説明 (Description)</label>
                <textarea
                    name="description"
                    rows={5}
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none"
                    placeholder="試合の文脈や詳細など..."
                />
            </div>

            {/* AI Image Generation Section */}
            <div className={`border rounded-lg p-4 transition-colors ${isAutoFilled ? 'border-purple-500/50 bg-purple-900/10' : 'border-white/10 bg-white/5'}`}>
                <div className="flex justify-between items-center mb-4">
                    <label className="text-sm font-bold text-gray-300 flex items-center gap-2">
                        <span>🖼️ カードアート (Card Art)</span>
                        {isAutoFilled && <span className="text-[10px] bg-purple-500 text-white px-2 py-0.5 rounded-full">Recommended</span>}
                    </label>
                </div>

                {/* Generated Image Preview */}
                {(generatedImage || editingMoment?.image_url) && (
                    <div className="mb-4 relative w-full aspect-square max-w-sm mx-auto rounded overflow-hidden border border-white/20">
                        <Image
                            src={generatedImage || editingMoment.image_url}
                            alt="Card Art"
                            fill
                            className="object-cover"
                        />
                        {generatedImage && (
                            <div className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                Preview (Unsaved)
                            </div>
                        )}
                    </div>
                )}

                <button
                    id="generate-btn"
                    type="button"
                    onClick={handleGenerate}
                    disabled={isGenerating || !description}
                    className={`w-full py-2 rounded font-bold text-sm flex items-center justify-center gap-2 transition-all
                        ${isGenerating ? 'bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-500 text-white shadow-lg shadow-purple-900/50'}
                    `}
                >
                    {isGenerating ? (
                        <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Generating Art...
                        </>
                    ) : (
                        <>
                            <span>⚡ Generate Card Art (DALL-E 3)</span>
                        </>
                    )}
                </button>
                <p className="text-[10px] text-gray-500 mt-2 text-center">
                    ※ 生成には数秒かかります。気に入るまで何度でも再生成可能です。<br />
                    保存時に自動的にアップロードされます。
                </p>
            </div>

            <button
                type="submit"
                disabled={isUploading}
                className={`w-full font-bold py-3 rounded transition-colors flex items-center justify-center gap-2
                    ${editingMoment ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-[#FFD700] hover:bg-[#F0C000] text-black'}
                    ${isUploading ? 'opacity-70 cursor-wait' : ''}
                `}
            >
                {isUploading && <Loader2 className="w-4 h-4 animate-spin" />}
                {editingMoment ? '変更を保存 (Update)' : 'モーメントを発行 (Broadcast)'}
            </button>
        </form>
    );
}
</file>

<file path="frontend/app/admin/moments/page.tsx">
import { createClient } from '@supabase/supabase-js';
import { finalizeMoment } from '@/app/actions/admin';
import { TEAM_GROUPS } from '@/lib/teams';
import Link from 'next/link';
import DeleteMomentButton from './DeleteMomentButton';
import MomentForm from './MomentForm';

// Admin Client for fetching list
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export default async function AdminMomentsPage({
    searchParams,
}: {
    searchParams: { [key: string]: string | string[] | undefined };
}) {
    // Handle searchParams safely
    const params = await searchParams;
    const editId = typeof params?.edit === 'string' ? params.edit : null;

    // Fetch list
    const { data: momentsData } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(20);

    // Fetch usage counts (N+1 tolerated for Admin UI)
    const moments = await Promise.all((momentsData || []).map(async (m) => {
        const { count } = await supabaseAdmin
            .from('listing_items')
            .select('id', { count: 'exact', head: true })
            .contains('moment_history', JSON.stringify([{ moment_id: m.id }]));
        return { ...m, usageCount: count || 0 };
    }));

    // Fetch editing item if needed
    let editingMoment = null;
    if (editId) {
        const { data } = await supabaseAdmin
            .from('live_moments')
            .select('*')
            .eq('id', editId)
            .single();
        editingMoment = data;
    }

    // Parse existing match result to pre-fill detailed fields if editing
    // match_result format example: "LAD 5 - 3 NYY (Top 9th)"
    let defaultVisitor = "";
    let defaultHome = "";
    let defaultScoreV = "";
    let defaultScoreH = "";
    let defaultProgress = "";

    // External Parameters (Auto-fill)
    const extPlayer = typeof params?.player === 'string' ? params.player : '';
    const extTitle = typeof params?.title === 'string' ? params.title : '';
    const extDesc = typeof params?.desc === 'string' ? params.desc : '';
    const extIntensity = typeof params?.intensity === 'string' ? params.intensity : '3';
    const extVisitor = typeof params?.visitor === 'string' ? params.visitor : '';
    const extHome = typeof params?.home === 'string' ? params.home : '';
    const extVisitorScore = typeof params?.visitorScore === 'string' ? params.visitorScore : '';
    const extHomeScore = typeof params?.homeScore === 'string' ? params.homeScore : '';
    // User requested defaults for these:
    // User requested defaults for these:
    const extType = typeof params?.type === 'string' ? params.type : '';
    const extProgress = typeof params?.progress === 'string' ? params.progress : '';

    // Check if any *meaningful* params are present for the banner (checking keys directly avoids default vals triggering it)
    const hasExternalParams = !editId && (
        !!params?.player || !!params?.title || !!params?.desc ||
        !!params?.visitor || !!params?.home ||
        !!params?.visitorScore || !!params?.homeScore ||
        !!params?.progress || !!params?.type
    );

    const isAutoFilled = hasExternalParams;

    if (editingMoment?.match_result) {
        try {
            const regex = /^(.+?)\s+(\d+)\s+-\s+(\d+)\s+(.+?)\s+\((.+)\)$/;
            const match = editingMoment.match_result.match(regex);
            if (match) {
                defaultVisitor = match[1];
                defaultScoreV = match[2];
                defaultScoreH = match[3];
                defaultHome = match[4];
                defaultProgress = match[5];
            }
        } catch (e) {
            console.error("Failed to parse match result", e);
        }
    } else if (isAutoFilled) {
        // Apply external params if valid
        console.log('[AutoFill] Applying external params:', { extVisitor, extHome, extProgress });
        defaultVisitor = extVisitor;
        defaultHome = extHome;
        defaultScoreV = extVisitorScore;
        defaultScoreH = extHomeScore;
        defaultProgress = extProgress;
    }

    return (
        <div className="p-8">
            <h2 className="text-2xl font-bold mb-6">ライブモーメント管理 (Live Matches)</h2>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Form Section */}
                <div className="bg-white/5 border border-white/10 rounded-xl p-6 h-fit">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className={`text-lg font-bold ${editingMoment ? 'text-blue-400' : 'text-[#FFD700]'}`}>
                            {editingMoment ? 'イベント登録情報の修正' : '新規イベント登録'}
                        </h3>
                        {isAutoFilled && (
                            <div className="ml-4 flex items-center gap-1 bg-purple-900/40 border border-purple-500/30 text-purple-300 text-xs px-2 py-1 rounded animate-pulse w-fit">
                                <span>⚡</span>
                                <span>外部データから自動入力</span>
                            </div>
                        )}
                        {editingMoment && (
                            <Link href="/admin/moments" className="text-xs text-gray-400 hover:text-white border border-gray-600 px-2 py-1 rounded">
                                キャンセル
                            </Link>
                        )}
                    </div>

                    <MomentForm
                        editingMoment={editingMoment}
                        defaultValues={{
                            player: extPlayer,
                            title: extTitle,
                            desc: extDesc,
                            intensity: extIntensity,
                            visitor: defaultVisitor,
                            home: defaultHome,
                            scoreV: defaultScoreV,
                            scoreH: defaultScoreH,
                            progress: defaultProgress,
                            type: extType
                        }}
                        isAutoFilled={isAutoFilled}
                    />
                </div>

                {/* List Section */}
                <div>
                    <h3 className="text-lg font-bold mb-4 text-gray-300">履歴ログ (History)</h3>
                    <div className="space-y-3">
                        {moments?.map((m: any) => (
                            <div key={m.id} className={`bg-white/5 border p-4 rounded flex justify-between items-start ${editingMoment?.id === m.id ? 'border-blue-500/50 bg-blue-900/10' : 'border-white/10'}`}>
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className="font-bold text-[#FFD700]">{m.player_name}</div>
                                        <div className="text-xs bg-white/10 px-1.5 py-0.5 rounded text-gray-300">{m.type}</div>
                                        {/* Usage Badge */}
                                        <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded border ${m.usageCount > 0 ? 'bg-green-900/40 border-green-500/50 text-green-400' : 'bg-gray-800 border-gray-600 text-gray-500'}`}>
                                            配布数: {m.usageCount || 0}枚
                                        </span>
                                    </div>
                                    <div className="text-sm text-white font-medium">{m.title}</div>
                                    {m.match_result && (
                                        <div className="text-xs text-gray-400 mt-0.5">
                                            {m.match_result}
                                            {m.is_finalized && <span className="ml-2 text-green-400 font-bold">✓ 終了済</span>}
                                        </div>
                                    )}
                                    <div className="text-xs text-gray-500 mt-1">{new Date(m.created_at).toLocaleString('ja-JP')}</div>

                                    {/* Action Buttons */}
                                    <div className="mt-3 flex items-center gap-3">
                                        {m.usageCount > 0 ? (
                                            <div title="配布済み(使用中)のため編集不可" className="flex items-center gap-2 text-gray-500 cursor-not-allowed border border-transparent px-2 py-0.5">
                                                <span className="text-xs">🔒</span>
                                                <span className="text-xs">使用中 (不可)</span>
                                            </div>
                                        ) : (
                                            <>
                                                <Link
                                                    href={`/admin/moments?edit=${m.id}`}
                                                    scroll={false}
                                                    className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 border border-blue-500/30 px-2 py-0.5 rounded hover:bg-blue-500/10 transition-colors"
                                                >
                                                    ✏️ 編集
                                                </Link>

                                                <DeleteMomentButton id={m.id} />
                                            </>
                                        )}
                                    </div>

                                    {/* Finalize Form for Pending Moments */}
                                    {!m.is_finalized && (
                                        <form action={finalizeMoment.bind(null, m.id)} className="mt-2 pt-2 border-t border-white/5 flex items-center gap-2">
                                            <input
                                                name="finalScore"
                                                required
                                                placeholder="最終スコア (例: 5-3)"
                                                defaultValue={m.match_result || ''}
                                                className="bg-black/30 border border-white/10 rounded px-2 py-1 text-xs text-white w-32 focus:border-[#FFD700] outline-none"
                                            />
                                            <button type="submit" className="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded transition-colors">
                                                試合終了を記録
                                            </button>
                                        </form>
                                    )}
                                </div>
                                <div className="ml-4 flex flex-col items-end gap-2">
                                    <div className="bg-white/10 px-2 py-1 rounded text-xs font-mono whitespace-nowrap">
                                        Lvl {m.intensity}
                                    </div>
                                </div>
                            </div>
                        ))}
                        {moments?.length === 0 && (
                            <div className="text-gray-500 text-sm">記録されたモーメントはありません。</div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/admin/payouts/page.tsx">
import { createClient } from '@supabase/supabase-js';
import { approvePayout } from '@/app/actions/admin';
import PayoutRow from './PayoutRow';

// Admin Client
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export default async function AdminPayoutsPage() {
    // Join logic is tricky with Supabase JS client basic syntax.
    // We fetch payouts and then manually join profiles/bank accounts or use foreign key query syntax.
    // 'payouts' has 'user_id'. 
    // We need bank acocunt info. 'bank_accounts' is 1:1 with user usually.

    // Fetch payouts
    const { data: payoutsRaw, error } = await supabaseAdmin
        .from('payouts')
        .select('*')
        .eq('status', 'pending')
        .order('created_at', { ascending: true });

    if (error) {
        console.error("Payout Fetch Error:", error);
    }

    // Manual Join to avoid Relation constraints with auth.users
    const payouts = payoutsRaw || [];
    const userIds = Array.from(new Set(payouts.map((p: any) => p.user_id)));

    let profilesMap: Record<string, any> = {};
    let banksMap: Record<string, any> = {};

    if (userIds.length > 0) {
        const { data: profiles } = await supabaseAdmin
            .from('profiles')
            .select('id, email, name')
            .in('id', userIds);

        const { data: banks } = await supabaseAdmin
            .from('bank_accounts')
            .select('*')
            .in('user_id', userIds);

        profiles?.forEach((p: any) => profilesMap[p.id] = p);
        banks?.forEach((b: any) => banksMap[b.user_id] = b);
    }


    return (
        <div className="p-8">
            <h2 className="text-2xl font-bold mb-6">Payout Manager</h2>

            <div className="overflow-x-auto rounded-xl border border-white/10">
                <table className="w-full text-left text-sm">
                    <thead className="bg-white/5 text-gray-400 uppercase font-medium">
                        <tr>
                            <th className="px-6 py-4">User</th>
                            <th className="px-6 py-4">Bank Details</th>
                            <th className="px-6 py-4 text-right">Amount (Yen)</th>
                            <th className="px-6 py-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-white/10 bg-black/20">
                        {payouts.map((p: any) => {
                            // Determine fee logic (Display only, assume DB amount is net or gross? p.amount usually is requested amount)
                            // We should probably display it clearly.
                            // For simplicity, just listing raw data.

                            // Bank account might be an array if using foreign key linking with 'user_id' which is not FK on bank_accounts directly?
                            // Wait, bank_accounts.user_id references auth.users. Payouts.user_id references auth.users.
                            // Supabase Query: `bank_accounts:user_id` might return array because it thinks it's 1:N unless unique constraint is clear.
                            // The schema says `bank_accounts_user_id_key UNIQUE`, so it should be single object or array of 1.

                            const bank = banksMap[p.user_id];
                            const profile = profilesMap[p.user_id];

                            return (
                                <PayoutRow key={p.id} payout={p} profile={profile} bank={bank} />
                            );
                        })}
                        {payouts?.length === 0 && (
                            <tr>
                                <td colSpan={4} className="px-6 py-8 text-center text-gray-500">
                                    No pending payouts.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/admin/payouts/PayoutRow.tsx">
'use client';

import { useState } from 'react';
import { approvePayout } from '@/app/actions/admin';

interface PayoutRowProps {
    payout: any;
    profile: any;
    bank: any;
}

export default function PayoutRow({ payout, profile, bank }: PayoutRowProps) {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isProcessing, setIsProcessing] = useState(false);

    const handleApprove = async () => {
        if (!confirm('Are you sure you want to mark this as PAID?')) return;
        setIsProcessing(true);
        try {
            await approvePayout(payout.id);
            // Server action revalidates path, so UI will update (row disappears)
        } catch (e) {
            alert('Error: ' + e);
            setIsProcessing(false);
        }
    };

    return (
        <>
            <tr className="hover:bg-white/5 transition-colors cursor-pointer group" onClick={() => setIsModalOpen(true)}>
                <td className="px-6 py-4">
                    <div className="font-bold text-white group-hover:text-[#FFD700] transition-colors">{profile?.name || 'Unknown'}</div>
                    <div className="text-gray-500 text-xs">{profile?.email}</div>
                    <div className="text-gray-500 text-xs font-mono mt-1">{payout.user_id}</div>
                </td>
                <td className="px-6 py-4 text-gray-300">
                    {bank ? (
                        <>
                            <div>{bank.bank_name}</div>
                            <div className="text-xs text-gray-500">{bank.account_holder_name}</div>
                        </>
                    ) : (
                        <span className="text-red-500">No Bank Info</span>
                    )}
                </td>
                <td className="px-6 py-4 text-right font-mono text-lg">
                    ¥{payout.amount.toLocaleString()}
                </td>
                <td className="px-6 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                    {bank ? (
                        <button
                            onClick={handleApprove}
                            disabled={isProcessing}
                            className="bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white px-4 py-2 rounded text-xs font-bold uppercase tracking-wide transition-colors"
                        >
                            {isProcessing ? 'Processing...' : 'Mark Paid'}
                        </button>
                    ) : (
                        <span className="text-red-500 font-bold text-xs uppercase border border-red-500 px-2 py-1 rounded">
                            Bank Info Missing
                        </span>
                    )}
                </td>
            </tr>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={() => setIsModalOpen(false)}>
                    <div className="bg-[#111] border border-white/20 rounded-xl p-8 max-w-lg w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-[#FFD700] mb-6 border-b border-white/10 pb-4">Payout Details</h3>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Transfer Amount</label>
                                <div className="text-3xl font-mono font-bold text-white">¥{payout.amount.toLocaleString()}</div>
                            </div>

                            <div className="bg-white/5 p-4 rounded-lg border border-white/10 space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Bank Name</label>
                                        <div className="text-lg text-white font-bold">{bank?.bank_name}</div>
                                        {bank?.bank_code && <div className="text-xs text-gray-400 font-mono">{bank.bank_code}</div>}
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Branch Name</label>
                                        <div className="text-lg text-white font-bold">{bank?.branch_name}</div>
                                        {bank?.branch_code && <div className="text-xs text-gray-400 font-mono">{bank.branch_code}</div>}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Type</label>
                                        <div className="text-white capitalize">{bank?.account_type === 'current' ? '当座' : '普通'}</div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Number</label>
                                        <div className="text-xl font-mono text-white tracking-widest">{bank?.account_number}</div>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">Account Holder (Kana)</label>
                                    <div className="text-xl text-[#FFD700] font-bold tracking-wider">{bank?.account_holder_name}</div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs text-gray-500 uppercase tracking-wider mb-1">User Info</label>
                                <div className="text-sm text-gray-300">
                                    {profile?.name} <span className="text-gray-500">({profile?.email})</span>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 flex justify-end space-x-4">
                            <button
                                onClick={() => setIsModalOpen(false)}
                                className="px-4 py-2 rounded text-sm font-bold text-gray-400 hover:text-white hover:bg-white/10 transition-colors"
                            >
                                Close
                            </button>
                            <button
                                onClick={() => {
                                    setIsModalOpen(false);
                                    handleApprove();
                                }}
                                disabled={isProcessing}
                                className="bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition-all"
                            >
                                Confirm Payment
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}
</file>

<file path="frontend/app/admin/layout.tsx">
import Link from 'next/link';
import { createClient } from '@/utils/supabase/server';
import { redirect } from 'next/navigation';

export default async function AdminLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    // Double check (Middleware should catch this, but safe to have)
    const adminEmails = (process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || '').split(/[,;|]+/).map(e => e.trim());
    if (!user || !user.email || !adminEmails.some(email => email.toLowerCase() === user.email?.toLowerCase())) {
        redirect('/');
    }

    return (
        <div className="min-h-screen bg-neutral-900 text-white flex flex-col md:flex-row">
            {/* Admin Sidebar */}
            <aside className="w-full md:w-64 bg-black border-b md:border-b-0 md:border-r border-white/10 flex-shrink-0">
                <div className="p-6 border-b border-white/10 flex justify-between items-center md:block">
                    <h1 className="text-xl font-bold tracking-wider text-[#FFD700]">ADMIN PANEL</h1>
                    <div className="md:hidden text-[10px] text-gray-500 text-right">
                        Logged in as:<br />
                        <span className="text-gray-300 truncate w-32 block">{user.email}</span>
                    </div>
                </div>
                <nav className="p-4 flex md:block space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto md:overflow-x-visible">
                    <Link href="/admin" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Dashboard
                    </Link>
                    <Link href="/admin/moments" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Live Moments
                    </Link>
                    <Link href="/admin/payouts" className="whitespace-nowrap px-4 py-2 md:py-3 rounded hover:bg-white/5 text-gray-300 hover:text-white transition-colors block">
                        Payouts
                    </Link>
                </nav>
                <div className="hidden md:block absolute bottom-0 w-64 p-4 border-t border-white/10">
                    <div className="text-xs text-gray-500">
                        Logged in as:<br />
                        <span className="text-gray-300 truncate block">{user.email}</span>
                    </div>
                    <Link href="/" className="mt-4 block text-center py-2 px-4 border border-white/20 rounded text-sm hover:bg-white/10 transition-colors">
                        Back to Site
                    </Link>
                </div>
            </aside>

            {/* Main Content */}
            <main className="flex-1 overflow-auto">
                {children}
            </main>
        </div>
    );
}
</file>

<file path="frontend/app/admin/page.tsx">
import Link from 'next/link';
import { createClient } from '@/utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';
import { createLiveMoment, finalizeMoment } from '@/app/actions/admin';

// Need admin client for global stats if RLS restricts (e.g. counting total users)
const getAdminClient = () => {
    return createAdminClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!
    );
};

export default async function AdminDashboard() {
    const supabaseAdmin = getAdminClient();

    // 1. Total Users
    const { count: userCount } = await supabaseAdmin
        .from('profiles')
        .select('*', { count: 'exact', head: true });

    // 2. Active Listings
    const { count: listingCount } = await supabaseAdmin
        .from('listing_items')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'Active');

    // 3. Pending Payouts
    const { count: payoutCount } = await supabaseAdmin
        .from('payouts')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'pending');

    // 4. Recent Moments (History)
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(5);

    return (
        <div className="p-4 md:p-8 space-y-10">
            <h2 className="text-2xl font-bold mb-6">Admin Control Panel</h2>

            {/* KPI Section */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Users</h3>
                    <p className="text-4xl font-mono font-bold text-white mt-2">{userCount ?? '-'}</p>
                </div>
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Active Listings</h3>
                    <p className="text-4xl font-mono font-bold text-[#FFD700] mt-2">{listingCount ?? '-'}</p>
                </div>
                <div className="bg-white/5 rounded-xl border border-white/10 p-6">
                    <h3 className="text-gray-400 text-sm font-medium uppercase tracking-wider">Pending Payouts</h3>
                    <p className="text-4xl font-mono font-bold text-red-500 mt-2">{payoutCount ?? '-'}</p>
                </div>
            </div>

            {/* Event Registration Section (Live Moments) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg className="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 className="text-xl font-bold mb-6 text-[#FFD700] flex items-center gap-2">
                        <span>Live Moment / Event Registration</span>
                    </h3>

                    <form action={createLiveMoment} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 uppercase tracking-tighter">Player Name</label>
                                <input name="playerName" required className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none" placeholder="e.g. Shohei Ohtani" />
                            </div>
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 uppercase tracking-tighter">Event Title</label>
                                <input name="title" required className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none" placeholder="e.g. 50-50 Achievement" />
                            </div>
                        </div>

                        <div className="bg-black/30 p-3 rounded border border-white/10 space-y-3">
                            <label className="block text-[10px] text-gray-400 mb-1 uppercase">Match Status / Live Score</label>
                            <div className="flex gap-2">
                                <select name="teamVisitor" required className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                    <option value="">Visitor Team</option>
                                    <option value="LAD">LAD (Dodgers)</option>
                                    <option value="NYY">NYY (Yankees)</option>
                                    <option value="SD">SD (Padres)</option>
                                    <option value="JPN">Samurai Japan</option>
                                </select>
                                <input name="scoreVisitor" type="number" min="0" placeholder="0" className="w-12 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center" />
                                <span className="text-gray-500">vs</span>
                                <input name="scoreHome" type="number" min="0" placeholder="0" className="w-12 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-center" />
                                <select name="teamHome" required className="flex-1 bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                    <option value="">Home Team</option>
                                    <option value="LAD">LAD (Dodgers)</option>
                                    <option value="NYY">NYY (Yankees)</option>
                                    <option value="SD">SD (Padres)</option>
                                    <option value="JPN">Samurai Japan</option>
                                </select>
                            </div>
                            <select name="progress" className="w-full bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-xs">
                                <option value="Top 1st">Top 1st</option>
                                <option value="Final">Final (試合終了)</option>
                            </select>
                        </div>

                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Impact Level (1-5)</label>
                            <input type="range" name="intensity" min="1" max="5" defaultValue="3" className="w-full accent-[#FFD700]" />
                        </div>

                        <div>
                            <label className="block text-xs text-gray-400 mb-1">Details</label>
                            <textarea name="description" rows={3} className="w-full bg-black/50 border border-white/20 rounded px-3 py-2 text-white focus:border-[#FFD700] outline-none text-sm" placeholder="Additional context..." />
                        </div>

                        <button type="submit" className="w-full bg-gradient-to-r from-[#FFD700] to-[#F0B000] text-black font-black py-4 rounded-xl hover:scale-[1.02] active:scale-[0.98] transition-all shadow-lg shadow-[#FFD700]/10">
                            BROADCAST EVENT
                        </button>
                    </form>
                </div>

                {/* History Quick-View */}
                <div>
                    <h3 className="text-xl font-bold mb-6 text-gray-300">Recent Events</h3>
                    <div className="space-y-3">
                        {moments?.map((m: any) => (
                            <div key={m.id} className="bg-white/5 border border-white/10 p-4 rounded-xl flex justify-between items-start">
                                <div>
                                    <div className="font-bold text-[#FFD700]">{m.player_name}</div>
                                    <div className="text-sm text-white">{m.title}</div>
                                    <div className="text-[10px] text-gray-500 mt-1">{new Date(m.created_at).toLocaleString()}</div>
                                </div>
                                <div className="text-right">
                                    <div className="bg-white/10 px-2 py-1 rounded text-[10px] font-bold">LVL {m.intensity}</div>
                                    {m.is_finalized && <span className="text-green-400 text-[10px] font-bold mt-1 block">✓ FINAL</span>}
                                </div>
                            </div>
                        ))}
                        <Link href="/admin/moments" className="block text-center py-2 text-xs text-gray-500 hover:text-white transition-colors">
                            View all event history →
                        </Link>
                    </div>

                    <div className="mt-8 p-6 bg-red-500/5 border border-red-500/10 rounded-2xl">
                        <h4 className="text-red-500 font-bold mb-2">Payout Queue</h4>
                        <p className="text-sm text-gray-400">There are currently <span className="text-white font-bold">{payoutCount ?? 0}</span> payout requests pending review.</p>
                        <Link href="/admin/payouts" className="inline-block mt-4 text-xs font-bold bg-red-500/10 text-red-500 px-4 py-2 rounded-full border border-red-500/20 hover:bg-red-500/20">
                            Process Payouts →
                        </Link>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/api/ai/image/route.ts">
import { NextResponse } from 'next/server';
import OpenAI from 'openai';

// Initialize OpenAI client
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export const maxDuration = 60; // Allow 60 seconds (DALL-E can be slow)
export const dynamic = 'force-dynamic';

export async function POST(req: Request) {
    try {
        const { prompt } = await req.json();

        if (!prompt) {
            return NextResponse.json({ error: 'Prompt is required' }, { status: 400 });
        }

        if (!process.env.OPENAI_API_KEY) {
            return NextResponse.json({ error: 'OpenAI API Key is missing' }, { status: 500 });
        }

        console.log('Generating image for prompt:', prompt);

        // 1. Common Base Style
        const baseStyle = [
            "Premium high-end trading card digital illustration",
            "hyper-realistic art style rendered from a photograph",
            "player wearing full professional uniform", // ユニフォーム着用は絶対
            "authentic professional baseball mechanics",
            "dynamic stadium night lighting",
            "subtle energy particle effects",
            "ultra-detailed texture",
            "masterpiece",
            "8k resolution"
        ].join(", ");

        // 2. Role Detection & Action Specification
        const lowerPrompt = prompt.toLowerCase();
        let role = 'generic';
        let actionKeywords = "";

        // Basic keyword matching
        if (lowerPrompt.includes('pitch') || lowerPrompt.includes('strikeout') || lowerPrompt.includes('strike out') || lowerPrompt.includes('mound') || lowerPrompt.includes('save') || lowerPrompt.includes('throw')) {
            role = 'pitcher';
            actionKeywords = "Pitching action, on the mound, throwing a baseball, holding a ball in hand (NO BAT), dynamic pitching form, athletic posture";
        } else if (lowerPrompt.includes('catch') || lowerPrompt.includes('diving') || lowerPrompt.includes('defense') || lowerPrompt.includes('field') || lowerPrompt.includes('glove')) {
            role = 'fielder';
            actionKeywords = "Fielding action, catching a ball with baseball glove, diving play, defensive stance, wearing a baseball glove (NO BAT)";
        } else {
            // Default to Batter for hits, homeruns, or generic
            role = 'batter';
            actionKeywords = "Batting action, swinging a baseball bat, holding a bat with both hands, hitting a ball, dynamic swing, athletic batting stance";
        }

        console.log(`Detected Role: ${role} for prompt: "${prompt}"`);

        const enhancedPrompt = `${baseStyle}. ${actionKeywords}. Context: ${prompt}`;

        const response = await openai.images.generate({
            model: "dall-e-3",
            prompt: enhancedPrompt,
            n: 1,
            size: "1024x1024",
            response_format: "b64_json",
            quality: "standard", // "hd" is more expensive, standard is fine for preview -> compress
        });

        const image = response.data?.[0];

        if (!image?.b64_json) {
            throw new Error("No b64_json received from OpenAI");
        }

        return NextResponse.json({ b64_json: image.b64_json });

    } catch (error: any) {
        console.error("AI Image Generation Error:", error);
        return NextResponse.json(
            { error: error?.message || 'Failed to generate image' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/ai/text/route.ts">
import { NextResponse } from 'next/server';
import Anthropic from '@anthropic-ai/sdk';

export const maxDuration = 60;
export const dynamic = 'force-dynamic';

export async function POST(req: Request) {
    try {
        const { keywords } = await req.json();

        if (!keywords) {
            return NextResponse.json({ error: 'Keywords are required' }, { status: 400 });
        }

        if (!process.env.ANTHROPIC_API_KEY) {
            return NextResponse.json({ error: 'Anthropic API Key is missing' }, { status: 500 });
        }

        const anthropic = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY,
        });

        const systemPrompt = `
あなたはプロ野球トレーディングカードの敏腕編集者です。
ユーザーから提供されたキーワードを元に、ファンが熱狂し、購買意欲をそそるようなテキストを作成してください。
出力は必ずJSON形式のみとしてください。
        `;

        const userPrompt = `
Target Keywords: "${keywords}"

以下の要件でコンテンツを作成してください：
1. Title: 20文字以内の劇的でキャッチーなタイトル。体言止め推奨。
2. Desc: 60文字程度の状況描写。情景が浮かぶようなエモーショナルな表現で。
3. Intensity: 1〜5の熱量スコア（5が最高）。

Response format (JSON only):
{ "title": "...", "desc": "...", "intensity": "..." }
        `;

        const msg = await anthropic.messages.create({
            model: "claude-sonnet-4-5-20250929", // Latest confirmed working model
            max_tokens: 1000,
            temperature: 0.7,
            system: systemPrompt,
            messages: [
                {
                    "role": "user",
                    "content": userPrompt
                }
            ]
        });

        const content = msg.content[0];
        if (content.type !== 'text') {
            throw new Error('Unexpected response type from Claude');
        }

        // Extract JSON from response (in case of extra text)
        const jsonMatch = content.text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
            throw new Error('Failed to parse JSON from Claude response');
        }

        const result = JSON.parse(jsonMatch[0]);

        return NextResponse.json(result);

    } catch (error: any) {
        console.error("AI Text Generation Error:", error);
        return NextResponse.json(
            { error: error?.message || 'Failed to generate text' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/analyze-card/route.ts">
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { generateObject } from 'ai';
import { z } from 'zod';

const google = createGoogleGenerativeAI({
    apiKey: process.env.GOOGLE_GENERATIVE_AI_API_KEY,
});

export async function POST(req: Request) {
    try {
        const { image } = await req.json();

        if (!image) {
            return new Response('No image provided', { status: 400 });
        }

        // Remove data URL prefix if present (e.g., "data:image/jpeg;base64,")
        const base64Image = image.replace(/^data:image\/[a-z]+;base64,/, '');

        const fieldSchema = z.object({
            value: z.string().nullable(),
            confidence: z.enum(['High', 'Medium', 'Low']),
            reason: z.string().optional().describe('Short reason for the confidence level.'),
        });

        const { object } = await generateObject({
            // Using generic alias for best availability
            model: google('gemini-flash-latest'),

            schema: z.object({
                playerName: fieldSchema.describe('Full name of the player. STRICT RULE: For Japanese players, you MUST output the name in "Kanji (Romaji)" format (e.g. "大谷翔平 (Shohei Ohtani)").'),
                team: fieldSchema.describe('Team name.'),
                year: fieldSchema.describe('Year of the card.'),
                brand: fieldSchema.describe('Card manufacturer/brand.'),
                cardNumber: fieldSchema.describe('Card number.'),

                // Features
                variation: fieldSchema.describe('Variation name or parallel type (e.g. "Pink Refractor", "Gold", "Base").'),
                parallelType: fieldSchema.describe('Specific parallel color/type if applicable (e.g. "Orange", "Camo", "Cracked Ice"). Null if base.'),
                isRefractor: fieldSchema.describe('Is this a Refractor/Chrome/Shiny card? "true" or "false".'),
                serialNumber: fieldSchema.describe('Serial number if visible (e.g. 10/50).'),

                isRookie: fieldSchema.describe('Is this a Rookie Card (RC)? "true" or "false".'),

                isAutograph: fieldSchema.describe('Is this an Autographed card? "true" or "false".'),
                autographType: fieldSchema.describe('Type of autograph: "On-Card", "Sticker", or "Facsimile" (printed). Null if no auto.'),

                // Grading
                isGraded: fieldSchema.describe('Is the card encased/graded? "true" or "false".'),
                gradingCompany: fieldSchema.describe('Grading company name (PSA, BGS, SGC, CGC) if graded.'),
                grade: fieldSchema.describe('Grade score (e.g. 10, 9.5, Gem Mint).'),

                condition: fieldSchema.describe('Condition if raw/ungraded (e.g. Near Mint).'),
            }),
            messages: [
                {
                    role: 'user',
                    content: [
                        { type: 'text', text: 'Analyze this baseball card. Extract details precisely. \n1. **Parallel/Variation**: Look carefully for colors (Orange, Blue, Gold) and texture (Refractor, Wave, Mojo). \n2. **Autograph**: Distinction between real auto (ink) and facsimile (printed) is crucial. \n3. **Japanese Players**: ALWAYS output "Kanji (Romaji)" format. Example: "山本由伸 (Yoshinobu Yamamoto)". \n4. **Booleans**: Output "true"/"false" as strings.' },
                        { type: 'image', image: base64Image },
                    ],
                },
            ],
        });

        return Response.json(object);
    } catch (error: any) {
        console.error('Gemini Analysis Error:', error);
        return new Response(JSON.stringify({ error: error.message }), { status: 500 });
    }
}
</file>

<file path="frontend/app/api/checkout/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '../../../lib/stripe';
import { createClient } from '../../../utils/supabase/server';
import { createClient as createAdminClient } from '@supabase/supabase-js';

export async function POST(req: NextRequest) {
    try {
        const { listingId, returnUrl, shippingDetails } = await req.json();
        const supabase = await createClient();

        // 1. Auth Check
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // 2. Fetch Listing Details
        const { data: listing, error: listingError } = await supabase
            .from('listing_items')
            .select('*')
            .eq('id', listingId)
            .single();

        if (listingError || !listing) {
            return NextResponse.json({ error: 'Listing not found' }, { status: 404 });
        }

        if (listing.status !== 'Active') {
            return NextResponse.json({ error: 'Listing is not active' }, { status: 400 });
        }

        if (listing.seller_id === user.id) {
            return NextResponse.json({ error: 'Cannot purchase your own listing' }, { status: 400 });
        }

        // 2.5 Fetch Active Live Moment (Snapshot)
        // Check for moments in the last 1 hour
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
        const { data: recentMoments } = await supabase
            .from('live_moments')
            .select('*')
            .gt('created_at', oneHourAgo);

        // Filter by Player Name (Fuzzy Match)
        const listingPlayer = (listing.player_name || '').toLowerCase();

        const matchedMoments = recentMoments?.filter(m => {
            const momentPlayer = (m.player_name || '').toLowerCase();
            return listingPlayer.includes(momentPlayer) || momentPlayer.includes(listingPlayer);
        }).sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()) || [];

        // Snapshot ALL matched moments (Multiple Moments Support)
        const momentSnapshot = matchedMoments.length > 0 ? matchedMoments : null;

        // 3. Create or Reuse Pending Order
        // Build Admin Client for cross-user reservation check
        const supabaseAdmin = createAdminClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_ROLE_KEY!
        );

        // Check for any order for this listing that is effectively "locked"
        // Statuses that block a new checkout: pending, paid, awaiting_shipping, shipped
        const { data: activeOrders, error: fetchOrderError } = await supabaseAdmin
            .from('orders')
            .select('*')
            .eq('listing_id', listingId)
            .in('status', ['pending', 'paid', 'awaiting_shipping', 'shipped']);

        if (fetchOrderError) {
            console.error('Fetch Order Error:', fetchOrderError);
        }

        const existingMyOrder = activeOrders?.find(o => o.buyer_id === user.id);
        const someoneElseActiveOrder = activeOrders?.find(o => o.buyer_id !== user.id);

        let order = null;

        if (someoneElseActiveOrder) {
            // If someone else has an active transaction (pending or paid), we are blocked.
            const errorMsg = ['paid', 'awaiting_shipping', 'shipped'].includes(someoneElseActiveOrder.status)
                ? 'This item has already been sold.'
                : 'Item is currently in a transaction.';
            return NextResponse.json({ error: errorMsg }, { status: 400 });
        }

        if (existingMyOrder) {
            // If we have a pending order, we reuse it.
            // Update shipping details AND refresh moment snapshot
            const updateData: any = {
                moment_snapshot: momentSnapshot
            };

            if (shippingDetails) {
                updateData.shipping_name = shippingDetails.name;
                updateData.shipping_postal_code = shippingDetails.postalCode;
                updateData.shipping_address = shippingDetails.address;
                updateData.shipping_phone = shippingDetails.phone;
            }

            await supabaseAdmin.from('orders').update(updateData).eq('id', existingMyOrder.id);
            order = { ...existingMyOrder, ...updateData };
        } else {
            // No active order for us. Create a new one.
            const { data: newOrder, error: insertError } = await supabaseAdmin
                .from('orders')
                .insert({
                    listing_id: listingId,
                    buyer_id: user.id,
                    seller_id: listing.seller_id,
                    payment_method_id: 'stripe_checkout',
                    total_amount: listing.price,
                    status: 'pending',
                    shipping_name: shippingDetails?.name,
                    shipping_postal_code: shippingDetails?.postalCode,
                    shipping_address: shippingDetails?.address,
                    shipping_phone: shippingDetails?.phone,
                    moment_snapshot: momentSnapshot
                })
                .select()
                .single();

            if (insertError) {
                if (insertError.code === '23505') {
                    return NextResponse.json({ error: 'Item is currently reserved by another user.' }, { status: 409 });
                }
                console.error('Order creation failed:', insertError);
                return NextResponse.json({
                    error: `Failed to create order record: ${insertError.message}`
                }, { status: 500 });
            }
            order = newOrder;
        }

        // 4. Create Stripe Checkout Session
        const session = await stripe.checkout.sessions.create({
            mode: 'payment',
            payment_method_types: ['card'],
            line_items: [
                {
                    price_data: {
                        currency: 'jpy',
                        product_data: {
                            name: `${listing.player_name || 'Card'}`,
                            description: `${listing.series_name || ''} (#${listing.card_number || '---'})`,
                            images: listing.images && listing.images.length > 0 ? [listing.images[0]] : [],
                            metadata: {
                                listing_id: listingId,
                            }
                        },
                        unit_amount: listing.price,
                    },
                    quantity: 1,
                },
            ],
            metadata: {
                userId: user.id,
                listingId: listingId,
                orderId: order.id, // Store our internal order ID to update it later
            },
            success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/orders/${order.id}/success?session_id={CHECKOUT_SESSION_ID}`,
            cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/checkout/${listingId}?canceled=true`,
        });

        return NextResponse.json({ url: session.url });
    } catch (err: any) {
        console.error('Stripe Checkout Error:', err);
        return NextResponse.json({ error: err.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/debug/config/route.ts">
import { NextResponse } from 'next/server';

export const dynamic = 'force-dynamic';

export async function GET() {
    const backendUrl = process.env.BACKEND_URL;
    return NextResponse.json({
        backend_url_configured: !!backendUrl,
        backend_url_value: backendUrl || 'NOT_SET (Defaults to localhost)',
        node_env: process.env.NODE_ENV
    });
}
</file>

<file path="frontend/app/api/debug-auth/route.ts">
import { createClient } from '@/utils/supabase/server';
import { NextResponse } from 'next/server';

export async function GET() {
    try {
        const supabase = await createClient();
        const { data: { user } } = await supabase.auth.getUser();

        const adminEmailsRaw = process.env.ADMIN_EMAILS || '';
        const publicAdminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || '';
        const adminEmails = adminEmailsRaw.split(',').map(e => e.trim().toLowerCase()).filter(Boolean);

        const userEmail = user?.email?.toLowerCase() || '';
        const isAdmin = userEmail ? adminEmails.includes(userEmail) : false;

        return NextResponse.json({
            status: 'success',
            diagnostics: {
                currentUser: user?.email || 'Guest',
                isAdmin,
                adminCount: adminEmails.length,
                // We don't return the full list for security, but we return a hint
                adminListHint: adminEmails.map(e => e[0] + '***' + e.split('@')[1]).join(', '),
                envSet: {
                    ADMIN_EMAILS: !!process.env.ADMIN_EMAILS,
                    NEXT_PUBLIC_ADMIN_EMAILS: !!process.env.NEXT_PUBLIC_ADMIN_EMAILS,
                    SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY
                }
            }
        });
    } catch (error: any) {
        return NextResponse.json({
            status: 'error',
            message: error.message
        }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/debug-email/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function POST(req: NextRequest) {
    if (!process.env.RESEND_API_KEY) {
        return NextResponse.json({ error: 'RESEND_API_KEY is missing' }, { status: 500 });
    }

    try {
        const { email } = await req.json();

        if (!email) {
            return NextResponse.json({ error: 'Email is required' }, { status: 400 });
        }

        const { data, error } = await resend.emails.send({
            from: 'Stadium Card <onboarding@resend.dev>',
            to: [email],
            subject: 'Debug Email Test',
            html: '<p>This is a test email from Stadium Card Debug Endpoint.</p>'
        });

        if (error) {
            console.error('Debug Email Error:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            success: true,
            data,
            message: `Email sent to ${email} (from onboarding@resend.dev). Note: In Test Mode, you can only send to your own authenticated email.`
        });

    } catch (err: any) {
        console.error('Debug Endpoint Error:', err);
        return NextResponse.json({ error: err.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/dev/moment/route.ts">
import { createClient } from '@supabase/supabase-js';
import { NextResponse } from 'next/server';

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

const MOMENT_TEMPLATES = [
    { title: '165km/h Fastball', desc: 'Japanese Record Speed!', intensity: 5, type: 'RECORD_BREAK' },
    { title: 'Dramatic Walk-off HR', desc: 'Bottom of the 9th, 2 outs.', intensity: 5, type: 'HOMERUN' },
    { title: 'Spectacular Diving Catch', desc: 'Saved the game!', intensity: 4, type: 'BIG_PLAY' },
    { title: '3000th Strikeout', desc: 'Legendary achievement.', intensity: 5, type: 'BIG_PLAY' },
    { title: 'Perfect Game Bid', desc: '8th inning completed.', intensity: 5, type: 'BIG_PLAY' }
];

const PLAYERS = ['Roki Sasaki', 'Shohei Ohtani', 'Munetaka Murakami'];

export async function POST() {
    if (process.env.NODE_ENV === 'production') {
        return NextResponse.json({ error: 'Not allowed in production' }, { status: 403 });
    }

    try {
        const template = MOMENT_TEMPLATES[Math.floor(Math.random() * MOMENT_TEMPLATES.length)];
        const playerName = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];

        const { data, error } = await supabase
            .from('live_moments')
            .insert({
                title: `${playerName}: ${template.title}`,
                description: template.desc,
                player_name: playerName,
                intensity: template.intensity,
                type: template.type,
                is_finalized: false
            })
            .select()
            .single();

        if (error) throw error;

        return NextResponse.json({ success: true, moment: data });
    } catch (error: any) {
        console.error('Failed to create dev moment:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="frontend/app/api/estimate-price/route.ts">
import { NextRequest, NextResponse } from 'next/server';

// ============================================================
// Types
// ============================================================

interface EstimatePriceRequest {
    playerName: string;
    year?: string;
    brand?: string;
    cardNumber?: string;
    variation?: string;
    isAutograph?: boolean;
    isGraded?: boolean;
    grade?: string;
}

interface RecentSale {
    title: string;
    price: number;
    currency: string;
    soldDate: string;
    condition?: string;
}

interface EstimatePriceResponse {
    estimatedPriceRange: {
        min: number;
        max: number;
        currency: string;
    };
    recentSales: RecentSale[];
    dataSource: 'ebay' | 'mock';
    searchQuery: string;
}

// ============================================================
// eBay API Integration
// ============================================================

async function getEbayAccessToken(): Promise<string | null> {
    const clientId = process.env.EBAY_CLIENT_ID;
    const clientSecret = process.env.EBAY_CLIENT_SECRET;

    if (!clientId || !clientSecret) {
        return null;
    }

    try {
        const credentials = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
        const response = await fetch('https://api.ebay.com/identity/v1/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': `Basic ${credentials}`,
            },
            body: 'grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope',
        });

        if (!response.ok) {
            console.error('eBay OAuth failed:', await response.text());
            return null;
        }

        const data = await response.json();
        return data.access_token;
    } catch (error) {
        console.error('eBay OAuth error:', error);
        return null;
    }
}

async function searchEbaySoldListings(
    query: string,
    accessToken: string
): Promise<{ sales: RecentSale[]; priceRange: { min: number; max: number } } | null> {
    try {
        // eBay Browse API - Search for completed/sold items
        const searchUrl = new URL('https://api.ebay.com/buy/browse/v1/item_summary/search');
        searchUrl.searchParams.set('q', query);
        searchUrl.searchParams.set('filter', 'buyingOptions:{AUCTION},soldItems:true');
        searchUrl.searchParams.set('limit', '10');
        searchUrl.searchParams.set('sort', '-endDate');

        const response = await fetch(searchUrl.toString(), {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'X-EBAY-C-MARKETPLACE-ID': 'EBAY_US',
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            console.error('eBay Search failed:', await response.text());
            return null;
        }

        const data = await response.json();
        const items = data.itemSummaries || [];

        if (items.length === 0) {
            return null;
        }

        const sales: RecentSale[] = items.slice(0, 5).map((item: any) => ({
            title: item.title,
            price: parseFloat(item.price?.value || '0'),
            currency: item.price?.currency || 'USD',
            soldDate: item.itemEndDate || new Date().toISOString(),
            condition: item.condition,
        }));

        const prices = sales.map(s => s.price).filter(p => p > 0);
        const min = Math.min(...prices);
        const max = Math.max(...prices);

        return { sales, priceRange: { min, max } };
    } catch (error) {
        console.error('eBay Search error:', error);
        return null;
    }
}

// ============================================================
// Mock Data Generator
// ============================================================

function generateMockData(request: EstimatePriceRequest): EstimatePriceResponse {
    const { playerName, year, brand, variation, isAutograph, isGraded, grade } = request;

    // Base price calculation based on card attributes
    let basePrice = 1000; // ¥1,000 base

    // Famous players get higher prices
    const famousPlayers = ['ohtani', '大谷', 'trout', 'judge', 'soto', 'acuna'];
    const isTopPlayer = famousPlayers.some(p =>
        playerName.toLowerCase().includes(p)
    );
    if (isTopPlayer) basePrice *= 5;

    // Recent cards (2020+) are generally more valuable
    const cardYear = parseInt(year || '2020');
    if (cardYear >= 2020) basePrice *= 1.5;

    // Premium variations
    const premiumVariations = ['refractor', 'gold', 'auto', 'parallel', 'chrome'];
    const isPremium = premiumVariations.some(v =>
        (variation || '').toLowerCase().includes(v) ||
        (brand || '').toLowerCase().includes(v)
    );
    if (isPremium) basePrice *= 2;

    // Autograph premium
    if (isAutograph) basePrice *= 3;

    // Graded premium
    if (isGraded) {
        basePrice *= 1.5;
        const gradeNum = parseFloat(grade || '9');
        if (gradeNum >= 10) basePrice *= 2;
        else if (gradeNum >= 9.5) basePrice *= 1.5;
    }

    // Add variance for realistic range
    const min = Math.round(basePrice * 0.7);
    const max = Math.round(basePrice * 1.3);

    // Generate mock recent sales
    const mockSales: RecentSale[] = [];
    const baseDate = new Date();
    const conditions = ['PSA 10', 'PSA 9', 'BGS 9.5', 'Raw NM', 'Raw EX'];

    for (let i = 0; i < 5; i++) {
        const saleDate = new Date(baseDate);
        saleDate.setDate(saleDate.getDate() - (i * 3 + Math.floor(Math.random() * 5)));

        const salePrice = min + Math.random() * (max - min);

        mockSales.push({
            title: `${year || '2024'} ${brand || 'Topps'} ${playerName} ${variation || 'Base'} #${Math.floor(Math.random() * 300) + 1}`,
            price: Math.round(salePrice),
            currency: 'JPY',
            soldDate: saleDate.toISOString(),
            condition: conditions[i % conditions.length],
        });
    }

    return {
        estimatedPriceRange: { min, max, currency: 'JPY' },
        recentSales: mockSales,
        dataSource: 'mock',
        searchQuery: buildSearchQuery(request),
    };
}

// ============================================================
// Helpers
// ============================================================

function buildSearchQuery(request: EstimatePriceRequest): string {
    const parts = [
        request.playerName,
        request.year,
        request.brand,
        request.variation,
    ].filter(Boolean);

    if (request.isAutograph) parts.push('autograph');
    if (request.isGraded && request.grade) parts.push(request.grade);

    return parts.join(' ');
}

// ============================================================
// API Handler
// ============================================================

export async function POST(req: NextRequest) {
    try {
        const body: EstimatePriceRequest = await req.json();

        if (!body.playerName) {
            return NextResponse.json(
                { error: 'playerName is required' },
                { status: 400 }
            );
        }

        const searchQuery = buildSearchQuery(body);

        // Try eBay API first
        const accessToken = await getEbayAccessToken();

        if (accessToken) {
            const ebayResult = await searchEbaySoldListings(searchQuery, accessToken);

            if (ebayResult && ebayResult.sales.length > 0) {
                return NextResponse.json({
                    estimatedPriceRange: {
                        ...ebayResult.priceRange,
                        currency: 'USD',
                    },
                    recentSales: ebayResult.sales,
                    dataSource: 'ebay',
                    searchQuery,
                } as EstimatePriceResponse);
            }
        }

        // Fallback to mock data
        console.log('Using mock data for price estimation (eBay API not configured or no results)');
        const mockResponse = generateMockData(body);

        return NextResponse.json(mockResponse);
    } catch (error: any) {
        console.error('Price Estimation Error:', error);
        return NextResponse.json(
            { error: error.message || 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="frontend/app/api/ping/route.ts">
import { NextResponse } from 'next/server';

export async function GET() {
    return NextResponse.json({ message: 'Pong' });
}
</file>

<file path="frontend/app/api/webhooks/stripe/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { stripe } from '../../../../lib/stripe';
import { headers } from 'next/headers';
import Stripe from 'stripe';
import { Resend } from 'resend';
import { ReactElement } from 'react';
import ShippingRequestEmail from '../../../../components/emails/ShippingRequestEmail';
import OrderConfirmationEmail from '../../../../components/emails/OrderConfirmationEmail';
import { createClient as createSupabaseClient } from '@supabase/supabase-js';

const resend = new Resend(process.env.RESEND_API_KEY!);

// This is required for the webhook to receive the raw body
// Not needed in App Router since we consume req.text() directly? 
// Actually, standard Next.js API routes needed bodyParser: false. 
// App Router handlers receive Request, we can read body.

export async function POST(req: NextRequest) {
    const body = await req.text();
    const headersList = await headers();
    const signature = headersList.get('stripe-signature');

    if (!signature) {
        return NextResponse.json({ error: 'Missing stripe-signature' }, { status: 400 });
    }

    let event: Stripe.Event;

    try {
        event = stripe.webhooks.constructEvent(
            body,
            signature,
            process.env.STRIPE_WEBHOOK_SECRET!
        );
        console.log(`[Webhook] Signature verified. Event Type: ${event.type}`);
    } catch (err: any) {
        console.error(`[Webhook] Signature verification failed: ${err.message}`);
        return NextResponse.json({ error: 'Webhook Error' }, { status: 400 });
    }

    // Handle the event
    if (event.type === 'checkout.session.completed') {
        const session = event.data.object as Stripe.Checkout.Session;

        // Retrieve metadata
        const md = session.metadata;
        console.log('[Webhook] Session Metadata:', md);

        const orderId = md?.orderId;
        const listingId = md?.listingId;

        if (!orderId || !listingId) {
            console.error('Webhook metadata missing orderId or listingId');
            return NextResponse.json({ error: 'Metadata missing' }, { status: 400 });
        }


        console.log(`Processing Order ${orderId} for Listing ${listingId}`);

        // 1. Update Order Status to 'paid'
        // Need to use service_role key ideally to bypass RLS if user is not logged in context?
        // Webhook is server-to-server. 'createClient()' uses cookie based auth usually.
        // HERE IS A PROBLEM: 'createClient' from utils/supabase/server relies on cookies.
        // Webhook requests DO NOT have user cookies.
        // We MUST use a Supabase Admin Client (Service Role) here.

        // I need to instantiate a Supabase client with SERVICE_ROLE_KEY.
        // Since I don't have a dedicated utility for admin client yet, I will create one inline or add to utils.
        // User has `process.env.SUPABASE_SERVICE_ROLE_KEY`? Usually yes in Supabase projects.
        // I'll check env vars later, but assuming standard setup.

        // Wait, I cannot see `utils/supabase/server.ts` imports easily to check if it supports admin.
        // I'll stick to creating a fresh client via `createClient` from `@supabase/supabase-js`.
        // I need to import `createClient` from package, not the helper.

        // 5. Create Admin Client
        if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
            console.error('FATAL: SUPABASE_SERVICE_ROLE_KEY is missing.');
            return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });
        }

        const supabaseAdmin = createSupabaseClient(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.SUPABASE_SERVICE_ROLE_KEY!
        );

        // Update Order
        const { error: orderError } = await supabaseAdmin
            .from('orders')
            .update({
                status: 'paid',
                payment_method_id: session.payment_intent as string || 'stripe'
            })
            .eq('id', orderId);

        if (orderError) {
            console.error('Error updating order:', orderError);
            return NextResponse.json({ error: 'DB Error' }, { status: 500 });
        }

        // 2. Fetch Listing, Active Moment & Order Data
        const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

        // Parallel fetch: Listing + Active Moments + Order (for buyer_id)
        const [listingResult, momentsResult, orderResult] = await Promise.all([
            supabaseAdmin
                .from('listing_items')
                .select('*') // Select all for cloning
                .eq('id', listingId)
                .single(),
            supabaseAdmin
                .from('live_moments')
                .select('*')
                .gt('created_at', oneHourAgo)
                .order('created_at', { ascending: false }),
            supabaseAdmin
                .from('orders')
                .select('id, moment_snapshot, buyer_id')
                .eq('id', orderId)
                .single()
        ]);

        const listingData = listingResult.data;
        const recentMoments = momentsResult.data || [];
        const currentOrder = orderResult.data;

        if (listingResult.error || !listingData || !currentOrder) {
            console.error('Error fetching data for cloning/moment matching:', listingResult.error || orderResult.error);
            return NextResponse.json({ error: 'DB Fetch Error' }, { status: 500 });
        }

        // 5. Transfer Ownership (Persistent ID Model)
        // Instead of cloning, we update the existing item's seller_id to the buyer_id
        // and set status to AwaitingShipment.
        const buyerId = currentOrder.buyer_id;
        const listing = listingData; // Rename for clarity in new logic
        console.log(`[Webhook] Transferring item ${listing.id} to buyer ${buyerId}`);

        const { error: transferError } = await supabaseAdmin
            .from('listing_items')
            .update({
                seller_id: buyerId,
                status: 'AwaitingShipment',
                origin_order_id: orderId, // Link for status tracking
                updated_at: new Date().toISOString()
            })
            .eq('id', listing.id);

        if (transferError) {
            console.error('[Webhook] CRITICAL: Failed to transfer ownership:', transferError.message);
            // We don't return 500 here because the payment was successful, 
            // but we need to track this failure.
        } else {
            console.log(`[Webhook] Successfully transferred ownership of item ${listing.id} to ${buyerId}`);
        }

        // 6. Record Seller in Order (For History)
        // Update the order with the original seller's ID before it was changed.
        const { error: orderUpdateError } = await supabaseAdmin
            .from('orders')
            .update({ seller_id: listing.seller_id })
            .eq('id', orderId);

        if (orderUpdateError) {
            console.error('[Webhook] Failed to record seller_id in order:', orderUpdateError.message);
        }

        // 7. Moment Syncing (Now on the transferred item)
        // Prefer captured snapshot from the order, fallback to live lookup ONLY if snapshot is missing
        let momentsToRecord = [];
        if (currentOrder.moment_snapshot) {
            console.log(`[Webhook Sync] Using captured snapshot (${Array.isArray(currentOrder.moment_snapshot) ? currentOrder.moment_snapshot.length : 1} moments) for item ${listing.id}`);
            momentsToRecord = Array.isArray(currentOrder.moment_snapshot) ? currentOrder.moment_snapshot : [currentOrder.moment_snapshot];
        } else {
            console.log(`[Webhook Sync] No snapshot found in order ${orderId}. Falling back to live lookup.`);
            const listingPlayer = (listing.player_name || '').toLowerCase();
            momentsToRecord = recentMoments.filter(m => {
                const momentPlayer = (m.player_name || '').toLowerCase();
                return listingPlayer.includes(momentPlayer) || momentPlayer.includes(listingPlayer);
            });
        }

        // Prepare History for Transferred Item
        const originalHistory = Array.isArray(listingData.moment_history) ? listingData.moment_history : [];

        // Filter out moments that are already present in the history (prevent duplicates from self-healing)
        const uniqueMomentsToRecord = momentsToRecord.filter(nm =>
            !originalHistory.some((oh: any) => (oh.moment_id === nm.id) || (oh.id === nm.id))
        );

        const newHistoryItems = uniqueMomentsToRecord.map(m => ({
            moment_id: m.id,
            timestamp: new Date().toISOString(),
            title: m.title,
            player_name: m.player_name,
            intensity: m.intensity,
            description: m.description,
            match_result: m.match_result,
            owner_at_time: orderId,
            status: m.is_finalized ? 'finalized' : 'pending'
        }));

        const fullBuyerHistory = [...originalHistory, ...newHistoryItems];

        // Update the item history
        if (newHistoryItems.length > 0) {
            console.log(`[Webhook] Appending ${newHistoryItems.length} moments to transferred item ${listing.id}`);
            await supabaseAdmin
                .from('listing_items')
                .update({ moment_history: fullBuyerHistory })
                .eq('id', listing.id);
        }

        // 3. Send Email to Seller (Shipping Request) - Using original listing data
        try {
            const { data: sellerUser } = await supabaseAdmin.auth.admin.getUserById(listingData.seller_id);

            if (sellerUser && sellerUser.user && sellerUser.user.email) {
                if (process.env.RESEND_API_KEY) {
                    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
                    await resend.emails.send({
                        from: 'Stadium Card <onboarding@resend.dev>',
                        to: [sellerUser.user.email],
                        subject: 'Item Sold - Shipping Required',
                        react: ShippingRequestEmail({
                            sellerName: sellerUser.user.user_metadata?.full_name || 'Seller',
                            productName: listingData.player_name || listingData.series_name,
                            orderUrl: `${baseUrl}/orders/sell/${orderId}`
                        }) as ReactElement
                    });
                }
            }
        } catch (emailErr) {
            console.error('Unexpected error sending shipping request email:', emailErr);
        }

        // 4. Send Email to Buyer (Order Confirmation)
        try {
            const { data: buyerUser } = await supabaseAdmin.auth.admin.getUserById(currentOrder.buyer_id);

            if (buyerUser && buyerUser.user && buyerUser.user.email) {
                if (process.env.RESEND_API_KEY) {
                    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
                    await resend.emails.send({
                        from: 'Stadium Card <onboarding@resend.dev>',
                        to: [buyerUser.user.email],
                        subject: 'Order Confirmed',
                        react: OrderConfirmationEmail({
                            buyerName: buyerUser.user.user_metadata?.full_name || 'Collector',
                            productName: listingData.player_name || listingData.series_name,
                            price: listingData.price,
                            orderUrl: `${baseUrl}/orders/buy/${orderId}`
                        }) as ReactElement
                    });
                }
            }
        } catch (buyerErr) {
            console.error('Unexpected error sending buyer confirmation email:', buyerErr);
        }

        console.log(`Order ${orderId} completed successfully (webhook logic).`);
    }

    return NextResponse.json({ received: true });
}
</file>

<file path="frontend/app/auctions/page.tsx">
'use client';

import Footer from '../../components/Footer';

export default function AuctionsPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full text-center">
                <div className="glass-panel-premium p-12 rounded-2xl shadow-2xl inline-block max-w-2xl">
                    <div className="w-20 h-20 bg-brand-blue/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-brand-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1槌3 10V3L4 14h7v7l9-11h-7z" />
                            {/* Using a gavel-like icon or generic lightning for now */}
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </div>
                    <h1 className="text-4xl font-heading font-bold text-white mb-4">Auctions Coming Soon</h1>
                    <p className="text-brand-platinum/60 text-lg mb-8">
                        Bid on exclusive, rare cards in real-time. The auction house is currently under construction.
                    </p>
                    <div className="inline-block px-6 py-3 rounded-full bg-brand-dark-light border border-brand-platinum/10 text-brand-platinum/40 text-sm font-mono">
                        ETA: Q1 2026
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/checkout/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import Footer from '../../../components/Footer';
import { createClient } from '../../../utils/supabase/client';

// Types (Duplicate from page.tsx for now)
type Manufacturer = "BBM" | "Calbee" | "Epoch" | "Topps_Japan";
type Team = "Giants" | "Tigers" | "Dragons" | "Swallows" | "Carp" | "BayStars" | "Hawks" | "Fighters" | "Marines" | "Buffaloes" | "Eagles" | "Lions";
type Rarity = "Common" | "Rare" | "Super Rare" | "Parallel" | "Autograph" | "Patch";



interface ConditionGrading {
    is_graded: boolean;
    service: string;
    score?: number;
    certification_number?: string;
}

interface ListingItem {
    id: string;
    price: number;
    images: string[];
    condition_grading: ConditionGrading;
    seller_id: string;
    status: string;

    // Backfilled Fields
    player_name?: string | null;
    team?: string | null;
    year?: number | null;
    manufacturer?: string | null;
    series_name?: string | null;
    card_number?: string | null;
}

export default function CheckoutPage() {
    const [user, setUser] = useState<any>(null);
    const params = useParams();
    const router = useRouter();
    const id = params.id as string;

    const [listing, setListing] = useState<ListingItem | null>(null);
    const [loading, setLoading] = useState(true);
    const [processing, setProcessing] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Detailed Shipping State
    const [shippingForm, setShippingForm] = useState({
        name: '',
        postalCode: '',
        address: '',
        phone: ''
    });

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            if (user) {
                // Fetch profile for address
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profile) {
                    const fullName = profile.last_name && profile.first_name
                        ? `${profile.last_name} ${profile.first_name}`
                        : profile.name || '';

                    const fullAddress = [
                        profile.address_line1,
                        profile.address_line2
                    ].filter(Boolean).join(' ');

                    setShippingForm({
                        name: fullName,
                        postalCode: profile.postal_code || '',
                        address: fullAddress,
                        phone: profile.phone_number || ''
                    });
                }
            }

            if (!id) return;

            try {
                const { data, error } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;
                setListing(data as any);
            } catch (err) {
                setError(err instanceof Error ? err.message : 'An unknown error occurred');
            } finally {
                setLoading(false);
            }
        };

        init();
    }, [id]);

    const handlePlaceOrder = async () => {
        if (!listing) return;
        if (!user) {
            router.push('/login');
            return;
        }

        // Validate Shipping Form
        if (!shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim()) {
            setError("Please fill in all shipping fields (Name, Address, Phone).");
            return;
        }

        setProcessing(true);
        setError(null);

        try {
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    listingId: listing.id,
                    returnUrl: window.location.origin,
                    shippingDetails: {
                        name: shippingForm.name,
                        postalCode: shippingForm.postalCode,
                        address: shippingForm.address,
                        phone: shippingForm.phone
                    }
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Payment initialization failed');
            }

            const { url } = await response.json();

            // Redirect to Stripe Checkout
            window.location.href = url;

        } catch (err: any) {
            console.error('Purchase Error:', err);
            setError(err.message || 'Transaction failed');
            setProcessing(false);
        }
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (error && !listing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-brand-dark">
                <div className="text-red-500 text-xl font-semibold mb-4">Error: {error}</div>
                <Link href="/" className="text-brand-blue hover:underline">
                    Back to Market
                </Link>
            </div>
        );
    }

    if (!listing) return null;

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pt-32 pb-12">
            <div className="flex-1 w-full max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                <h1 className="text-3xl font-heading font-bold text-white mb-8 text-center border-b border-white/10 pb-4">Checkout</h1>

                <div className="glass-panel-premium shadow-2xl rounded-2xl mb-6 overflow-hidden border border-brand-platinum/10">
                    <div className="bg-brand-dark-light/50 px-6 py-5 border-b border-brand-platinum/10">
                        <h3 className="text-lg leading-6 font-bold text-white">Order Summary</h3>
                    </div>
                    <div className="divide-y divide-white/5">
                        <div className="px-6 py-4 flex justify-between items-center group hover:bg-white/5 transition-colors">
                            <span className="text-sm font-medium text-brand-platinum">Item</span>
                            <span className="text-sm text-white font-bold group-hover:text-brand-blue-glow transition-colors">
                                {listing.player_name || 'Unknown Item'} <span className="text-brand-platinum/60 font-normal">({listing.year || '----'} {listing.manufacturer || ''})</span>
                            </span>
                        </div>
                        <div className="px-6 py-4 flex justify-between items-center">
                            <span className="text-sm font-medium text-brand-platinum">Condition</span>
                            <span className="text-sm text-white">
                                {listing.condition_grading.is_graded ? `Graded: ${listing.condition_grading.service} ${listing.condition_grading.score}` : 'Ungraded'}
                            </span>
                        </div>
                        <div className="px-6 py-5 flex justify-between items-center bg-brand-blue/5">
                            <span className="text-base font-bold text-white">Total Amount</span>
                            <span className="text-2xl font-bold text-brand-blue-glow font-heading tracking-tight">
                                ¥{listing.price.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>

                {/* Shipping Address Section */}
                <div className="glass-panel-premium shadow-2xl rounded-2xl mb-6 p-6 border border-brand-platinum/10">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="w-8 h-8 rounded-full bg-brand-gold/20 flex items-center justify-center text-brand-gold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 17h4V5H2v12h3m10 0h5v-3.5L15.5 8H10" /></svg>
                        </div>
                        <h3 className="text-lg leading-6 font-bold text-white">Shipping Address</h3>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Name <span className="text-red-400">*</span></label>
                            <input
                                type="text"
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                placeholder="Full Name"
                                value={shippingForm.name}
                                onChange={e => setShippingForm({ ...shippingForm, name: e.target.value })}
                            />
                        </div>

                        <div className="grid grid-cols-3 gap-4">
                            <div className="col-span-1">
                                <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Postal Code</label>
                                <input
                                    type="text"
                                    className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                    placeholder="123-4567"
                                    value={shippingForm.postalCode}
                                    onChange={e => setShippingForm({ ...shippingForm, postalCode: e.target.value })}
                                />
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Phone Number <span className="text-red-400">*</span></label>
                                <input
                                    type="tel"
                                    className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                    placeholder="090-1234-5678"
                                    value={shippingForm.phone}
                                    onChange={e => setShippingForm({ ...shippingForm, phone: e.target.value })}
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-xs font-medium text-brand-platinum/60 mb-1 uppercase tracking-wider">Full Address <span className="text-red-400">*</span></label>
                            <input
                                type="text"
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-blue transition-colors placeholder-brand-platinum/20"
                                placeholder="Prefecture, City, Street, Building"
                                value={shippingForm.address}
                                onChange={e => setShippingForm({ ...shippingForm, address: e.target.value })}
                            />
                        </div>

                        <div className="text-xs text-brand-platinum/40 italic mt-2">
                            * Updating this form does not change your main profile address.
                        </div>
                    </div>
                </div>

                {error && (
                    <div className="bg-red-500/10 border border-red-500/20 p-4 mb-6 rounded-xl flex items-center gap-3 animate-pulse">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-400"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
                        <p className="text-sm text-red-400 font-bold">{error}</p>
                    </div>
                )}

                <p className="text-xs text-brand-platinum/60 text-right mb-4 max-w-lg ml-auto leading-relaxed">
                    購入を確定すると、商品の発送に必要な範囲で、あなたの配送先情報が出品者に開示されます。
                </p>

                <div className="flex justify-end space-x-4">
                    <Link href={`/listings/${listing.id}`} className="px-6 py-3 border border-brand-platinum/20 rounded-xl text-sm font-bold text-brand-platinum hover:bg-brand-platinum/10 hover:text-white transition-all">
                        Cancel
                    </Link>
                    <button
                        onClick={handlePlaceOrder}
                        disabled={processing || !shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim()}
                        className={`inline-flex items-center gap-2 justify-center px-8 py-3 border border-transparent shadow-lg text-sm font-bold rounded-xl text-white bg-gradient-to-r from-brand-blue to-brand-blue-glow hover:from-brand-blue-glow hover:to-brand-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] shadow-brand-blue/20 ${processing || !shippingForm.name.trim() || !shippingForm.address.trim() || !shippingForm.phone.trim() ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                        {processing ? (
                            <>
                                <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                Processing...
                            </>
                        ) : (
                            <>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></svg>
                                Buy Now
                            </>
                        )}
                    </button>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/collection/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { createClient } from '../../utils/supabase/client';
import AddToShowcaseModal from '../../components/AddToShowcaseModal';
import ShowcaseCard from '../../components/ShowcaseCard';
import PurchaseAnimation from '../../components/PurchaseAnimation';
import SkeletonCard from '../../components/SkeletonCard';
import { deleteItem, restoreItem } from '../actions/item';

// Types
import { ListingItem } from '../../types';

interface OrderItem {
    id: string;
    listing_id: string;
    status: string;
    total_amount: number;
    tracking_number?: string;
    listing?: ListingItem;
    created_at: string;
    completed_at?: string;
}

function MyPageContent() {
    const [user, setUser] = useState<any>(null);
    const router = useRouter();
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const [activeTab, setActiveTab] = useState<'showcase' | 'listings' | 'orders' | 'history' | 'archive'>('showcase');
    const [historyTab, setHistoryTab] = useState<'sold' | 'purchased'>('sold');
    const [filter, setFilter] = useState<'All' | 'Draft' | 'Active' | 'Display'>('All');
    const [showcaseItems, setShowcaseItems] = useState<any[]>([]);
    const [archivedItems, setArchivedItems] = useState<any[]>([]);
    const [myListings, setMyListings] = useState<ListingItem[]>([]);
    const [myOrders, setMyOrders] = useState<OrderItem[]>([]);
    const [historySold, setHistorySold] = useState<ListingItem[]>([]);
    const [historyPurchased, setHistoryPurchased] = useState<OrderItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [currentUserId, setCurrentUserId] = useState<string | null>(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [showAnimation, setShowAnimation] = useState(false);

    const fetchData = async () => {
        setLoading(true);
        const supabase = createClient();
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            console.log('[Collection] No user found, redirecting to login');
            router.push('/login');
            setLoading(false);
            return;
        }
        setUser(user);
        setCurrentUserId(user.id);

        try {
            // Fetch All My Items (Listings + Collection)
            const { data: listingsData } = await supabase
                .from('listing_items')
                .select('*, orders:orders!listing_id(*), origin_order:orders!origin_order_id(id, status, moment_snapshot)') // Left Join (Removed !)
                .eq('seller_id', user.id);

            const activeItemsRaw = listingsData?.filter(i => !i.deleted_at) || [];
            const archivedItemsRaw = listingsData?.filter(i => !!i.deleted_at) || [];

            // Fetch Active Live Moments to tag items
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();
            const { data: recentMoments } = await supabase
                .from('live_moments')
                .select('*')
                .gt('created_at', oneHourAgo);

            const livePlayerNames = new Set(recentMoments?.map(m => (m.player_name || '').toLowerCase()) || []);

            const tagWithLive = (item: any) => {
                if (!item) return null;

                // Live Moments enabled for ALL items (as per user request to boost selling intent)
                // Originally restricted to Active, now globally enabled for "Opportunity" notification.

                const playerName = (item.player_name || '').toLowerCase();
                const matchedMoments = recentMoments?.filter(m => {
                    const mName = (m.player_name || '').toLowerCase();
                    return playerName.includes(mName) || mName.includes(playerName);
                }) || [];

                return {
                    ...item,
                    is_live_moment: matchedMoments.length > 0,
                    live_moments: matchedMoments, // Full array for multi-badge
                    moment_created_at: matchedMoments[0]?.created_at || null // For legacy single-badge if needed
                };
            };

            // Helper for merging moments from order snapshots into item history
            const mergeOrderMoments = (item: any, orderData: any) => {
                if (!item || !orderData || !orderData.moment_snapshot) return item;

                const snapshots = Array.isArray(orderData.moment_snapshot) ? orderData.moment_snapshot : [orderData.moment_snapshot];
                const history = Array.isArray(item.moment_history) ? item.moment_history : [];

                const missingSnapshots = snapshots.filter((sn: any) =>
                    !history.some((h: any) => (h.moment_id === sn.id) || (h.id === sn.id))
                );

                if (missingSnapshots.length > 0) {
                    item.moment_history = [
                        ...history,
                        ...missingSnapshots.map((sn: any) => ({
                            moment_id: sn.id,
                            timestamp: sn.created_at || new Date().toISOString(),
                            title: sn.title,
                            player_name: sn.player_name,
                            intensity: sn.intensity,
                            description: sn.description,
                            match_result: sn.match_result,
                            owner_at_time: orderData.id,
                            status: 'finalized'
                        }))
                    ];
                }
                return item;
            };

            // Selling Tab: Active Transactions (Persistent Model: Query from orders)
            const { data: pendingSalesData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)')
                .eq('seller_id', user.id)
                .is('completed_at', null);

            console.log('[Collection] Pending Sales:', pendingSalesData?.length || 0);

            const activeMyListings = (pendingSalesData || []).map(order => ({
                ...order.listing,
                orders: order // Pass order for Manage link
            })).map(tagWithLive).filter(item => item !== null);
            setMyListings(activeMyListings as any);

            // History: Sold Items (Persistent Model: Query from orders)
            const { data: soldOrdersData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Get the listing details at time of fetch
                .eq('seller_id', user.id)
                .is('completed_at', null); // Initial check for pending sales? No, history usually means completed.

            // Actually, History > Sold should probably show Completed orders.
            const { data: completedSoldData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Disambiguate join
                .eq('seller_id', user.id)
                .not('completed_at', 'is', null);

            const soldHistory = (completedSoldData || []).map(order => ({
                ...order.listing,
                orders: order, // For formatDate(item.orders.completed_at)
                type: 'sold'
            })).map(tagWithLive);
            setHistorySold(soldHistory as any);

            // Buying Tab: Active Transactions only
            const { data: ordersData } = await supabase
                .from('orders')
                .select('*, listing:listing_items!listing_id(*)') // Disambiguate join
                .eq('buyer_id', user.id);

            const activeMyOrders = (ordersData?.filter(order => {
                const orderStatus = (order.status || '').toLowerCase();
                // ONLY show orders that are actually in progress for THIS purchase
                return ['pending', 'paid', 'awaiting_shipping', 'shipped', 'delivered'].includes(orderStatus);
            }) || []).map(order => {
                const listing = order.listing ? mergeOrderMoments(order.listing, order) : null;
                return {
                    ...order,
                    listing: listing ? tagWithLive(listing) : null
                };
            }).filter(o => o.listing !== null); // safety
            setMyOrders(activeMyOrders as any || []);

            // History: Purchased Items
            const purchasedHistory = (ordersData?.filter(order =>
                (order.status || '').toLowerCase() === 'completed'
            ) || []).map(order => {
                const listing = order.listing ? mergeOrderMoments(order.listing, order) : null;
                return {
                    ...order,
                    listing: listing ? tagWithLive(listing) : null
                };
            });
            setHistoryPurchased(purchasedHistory as any);

            // Workspace Tab: Aggregated View
            const workspaceListings = (activeItemsRaw?.filter(item => {
                // Mandatory Filter: Must be Active, Display, or Draft (or Completed as fallback)
                const isCorrectStatus = ['Active', 'Display', 'Draft', 'Completed', 'completed'].includes(item.status);

                // Extra Protection: If it's a purchased clone (has origin_order_id), 
                // it MUST have a completed order to show up in Workspace.
                // If it's not a clone (origin_order_id is null), it's a seller's item, show normally.
                const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
                const isTransactionComplete = !item.origin_order_id || (originOrder?.status === 'completed');

                return isCorrectStatus && isTransactionComplete;
            }) || []).map(item => {
                // Self-Healing: Merge moment_snapshot from origin_order into history if missing
                let originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;

                // Fallback: If origin_order is missing link, look for my purchase order in related orders
                if (!originOrder && item.orders) {
                    const relatedOrders = Array.isArray(item.orders) ? item.orders : [item.orders];
                    const myPurchase = relatedOrders.find((o: any) =>
                        o.buyer_id === user.id &&
                        (o.status === 'completed' || o.status === 'shipped' || o.status === 'paid' || o.status === 'delivered')
                    );
                    if (myPurchase) {
                        originOrder = myPurchase;
                    }
                }

                return mergeOrderMoments(item, originOrder);
            }).map(tagWithLive);

            // Archive Tab
            const archiveListings = (archivedItemsRaw || []).map(tagWithLive);
            setArchivedItems(archiveListings);

            const aggregated = [
                ...workspaceListings.map(item => ({ type: 'listed', ...item }))
            ];
            setShowcaseItems(aggregated);

        } catch (error) {
            console.error('Failed to fetch data:', error);
        } finally {
            setLoading(false);
        }
    };


    const handleDeleteCollectionItem = async (id: string) => {
        if (!confirm('Are you sure you want to archive this item? It will be moved to your history tab.')) return;

        try {
            await deleteItem(id);
            fetchData();
        } catch (error) {
            console.error('Failed to archive item:', error);
            alert('Failed to archive item');
        }
    };

    const handleRestoreCollectionItem = async (id: string) => {
        if (!confirm('Restore this item to your collection?')) return;

        try {
            await restoreItem(id);
            fetchData();
        } catch (error) {
            console.error('Failed to restore item:', error);
            alert('Failed to restore item');
        }
    };

    const handleToggleDisplay = async (id: string, currentStatus: string) => {
        let newStatus = 'Draft';
        if (currentStatus === 'Draft') newStatus = 'Display';
        if (currentStatus === 'Active') newStatus = 'Display'; // Active -> Display
        if (currentStatus === 'Display') newStatus = 'Draft';

        const supabase = createClient();

        const { error } = await supabase
            .from('listing_items')
            .update({
                status: newStatus,
                deleted_at: null // Restoration safety
            })
            .eq('id', id);

        if (error) {
            console.error('Failed to update status:', error);
            alert('Failed to update status');
        } else {
            fetchData();
        }
    };

    const handleCancelListing = async (id: string) => {
        if (!confirm('Are you sure you want to cancel this listing? The item will be returned to your drafts.')) return;

        const supabase = createClient();

        try {
            // Mark listing as Draft (Soft Delete from Marketplace, but keeps in DB)
            const { error: updateError } = await supabase
                .from('listing_items')
                .update({
                    status: 'Draft',
                    deleted_at: null // Restoration safety 
                })
                .eq('id', id);

            if (updateError) throw updateError;

            fetchData();

        } catch (error) {
            console.error('Failed to cancel listing:', error);
            alert('Failed to cancel listing');
        }
    };

    const handleShipItem = async (listingId: string) => {
        if (!confirm('Are you ready to ship this item?')) return;

        const supabase = createClient();
        const { error } = await supabase
            .from('listing_items')
            .update({ status: 'Shipped' })
            .eq('id', listingId);

        if (error) {
            console.error('Failed to ship item:', error);
            alert('Failed to ship item');
        } else {
            fetchData();
        }
    };



    const formatDate = (dateString?: string) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
    };

    useEffect(() => {
        fetchData();
    }, []);

    // Filter Logic for Workspace
    const filteredShowcaseItems = showcaseItems.filter(item => {
        if (filter === 'All') return true;
        if (filter === 'Draft') return item.status === 'Draft';
        if (filter === 'Active') return item.status === 'Active';
        if (filter === 'Display') return item.status === 'Display';
        return true;
    });

    if (loading) {
        return (
            <div className="min-h-screen pt-32 pb-12 px-4 sm:px-6 lg:px-8 bg-brand-dark">
                <div className="max-w-6xl mx-auto">
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                        {[...Array(10)].map((_, i) => (
                            <SkeletonCard key={i} />
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    if (!user && !loading) return null;

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-12">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-heading font-bold text-white">My Collection</h1>
                    <div className="flex gap-4">
                        <Link
                            href={`/profile/${user.id}`}
                            className="px-4 py-2 bg-brand-platinum/10 text-brand-platinum border border-brand-platinum/20 rounded-lg hover:bg-brand-platinum/20 transition-all font-bold text-sm flex items-center gap-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            View Public Profile
                        </Link>
                        <button
                            onClick={() => setIsModalOpen(true)}
                            className="px-4 py-2 bg-brand-gold/10 text-brand-gold border border-brand-gold/20 rounded-lg hover:bg-brand-gold/20 transition-all font-bold text-sm flex items-center gap-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                            Add Card
                        </button>
                    </div>
                </div>

                <div className="glass-panel-premium shadow-2xl rounded-2xl border border-white/10">
                    <div className="border-b border-brand-platinum/10">
                        <nav className="-mb-px flex" aria-label="Tabs">
                            <button
                                onClick={() => setActiveTab('showcase')}
                                className={`${activeTab === 'showcase'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Workspace
                            </button>
                            <button
                                onClick={() => setActiveTab('listings')}
                                className={`${activeTab === 'listings'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Selling
                            </button>
                            <button
                                onClick={() => setActiveTab('orders')}
                                className={`${activeTab === 'orders'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Buying
                            </button>
                            <button
                                onClick={() => setActiveTab('history')}
                                className={`${activeTab === 'history'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                History
                            </button>
                            <button
                                onClick={() => setActiveTab('archive')}
                                className={`${activeTab === 'archive'
                                    ? 'border-brand-blue text-brand-blue-glow'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Archive
                            </button>
                        </nav>
                    </div>

                    <div className="p-6 min-h-[400px]">
                        {activeTab === 'showcase' && (
                            <>
                                {/* Filter Pills */}
                                <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                                    {['All', 'Draft', 'Active', 'Display'].map((f) => (
                                        <button
                                            key={f}
                                            onClick={() => setFilter(f as any)}
                                            className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all whitespace-nowrap ${filter === f
                                                ? 'bg-brand-blue text-white shadow-lg shadow-brand-blue/20'
                                                : 'bg-brand-dark-light border border-brand-platinum/10 text-brand-platinum/60 hover:bg-brand-platinum/10 hover:text-white'
                                                }`}
                                        >
                                            {f}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                    {filteredShowcaseItems.map((item, idx) => (
                                        <ShowcaseCard
                                            key={idx}
                                            item={item}
                                            type={item.type as any} // Pass type 'listed' or 'purchased'
                                            onDelete={handleDeleteCollectionItem}
                                            onCancel={handleCancelListing}
                                            onToggleDisplay={handleToggleDisplay}
                                            is_live_moment={item.is_live_moment || isDebugLive}
                                            live_moments={item.live_moments} // New prop
                                            moment_created_at={item.moment_created_at}
                                        />
                                    ))}
                                    {filteredShowcaseItems.length === 0 && (
                                        <div className="col-span-full flex flex-col items-center justify-center py-12 text-brand-platinum/50">
                                            <svg className="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                            <p>No items found in {filter}.</p>
                                            {filter === 'All' && (
                                                <button onClick={() => setIsModalOpen(true)} className="mt-4 text-brand-blue hover:text-brand-blue-glow">Add your first card</button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'listings' && (
                            <div className="grid grid-cols-1 gap-4">
                                {myListings.length === 0 ? (
                                    <div className="text-center py-12 text-brand-platinum/50">
                                        <p>No active sales in progress.</p>
                                        <p className="text-sm mt-2">Items listed for sale are in your Workspace.</p>
                                    </div>
                                ) : (
                                    myListings.map(item => {
                                        // Handle Supabase relation (Array vs Object) and multiple orders
                                        // @ts-ignore
                                        const order = item.orders ? (
                                            Array.isArray(item.orders)
                                                ? (item.orders.find((o: any) => !['completed', 'cancelled'].includes((o.status || '').toLowerCase())) || item.orders[0])
                                                : item.orders
                                        ) : null;

                                        return (
                                            <div key={item.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5">
                                                <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light">
                                                    {item.images?.[0] ? (
                                                        <img src={item.images[0]} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h3 className="text-white font-bold">{item.player_name || 'Unknown Item'}</h3>
                                                            <p className="text-brand-platinum/60 text-sm">{item.status}</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {(item.status === 'AwaitingShipment' || item.status === 'TransactionPending' || item.status === 'Shipped') && (
                                                                order ? (
                                                                    <Link
                                                                        href={(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id)
                                                                            ? `/orders/sell/${order.id}`
                                                                            : `/orders/buy/${order.id}`}
                                                                        className={`px-3 py-1 text-xs font-bold rounded-lg transition-colors shadow-lg ${(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id)
                                                                            ? "text-brand-dark bg-brand-blue hover:bg-brand-blue-light shadow-brand-blue/20"
                                                                            : "text-brand-dark bg-brand-gold hover:bg-brand-gold-light shadow-brand-gold/20"
                                                                            }`}
                                                                    >
                                                                        {(currentUserId === item.seller_id || currentUserId === item.orders?.seller_id) ? "Manage Order" : "View Order"}
                                                                    </Link>
                                                                ) : (
                                                                    <span className="text-xs text-brand-platinum/40 italic">Syncing Order...</span>
                                                                )
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        )}

                        {activeTab === 'orders' && (
                            <div className="grid grid-cols-1 gap-4">
                                {myOrders.length === 0 ? (
                                    <div className="text-center py-12 text-brand-platinum/50">
                                        <p>No active purchases in progress.</p>
                                    </div>
                                ) : (
                                    myOrders.map(order => (
                                        <div key={order.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5">
                                            <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light">
                                                {order.listing?.images?.[0] ? (
                                                    <img src={order.listing.images[0]} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="text-white font-bold">{order.listing?.player_name || 'Unknown Item'}</h3>
                                                        <p className="text-brand-platinum/60 text-sm">
                                                            {order.status === 'shipped' ? 'Shipped - On the way' :
                                                                order.status === 'completed' ? 'Delivered & Completed' :
                                                                    order.status === 'paid' || order.status === 'awaiting_shipping' ? 'Awaiting Shipment' :
                                                                        order.status === 'pending' ? 'Transaction Pending' :
                                                                            'Purchased'}
                                                        </p>
                                                    </div>
                                                    {['paid', 'awaiting_shipping', 'shipped', 'delivered'].includes(order.status?.toLowerCase()) ? (
                                                        <Link
                                                            href={`/orders/buy/${order.id}`}
                                                            className={`px-3 py-1 text-xs font-bold rounded-lg transition-colors shadow-lg ${order.status === 'shipped'
                                                                ? 'text-brand-dark bg-brand-gold hover:bg-brand-gold-light shadow-brand-gold/20'
                                                                : 'text-brand-platinum/60 bg-brand-dark-light border border-brand-platinum/10'
                                                                }`}
                                                        >
                                                            {order.status === 'shipped' ? 'View & Receive' : 'View Order'}
                                                        </Link>
                                                    ) : (
                                                        <span
                                                            className="px-3 py-1 text-xs font-bold text-brand-platinum/40 bg-brand-dark-light border border-brand-platinum/10 rounded-lg cursor-not-allowed"
                                                        >
                                                            Processing
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div>
                                <div className="flex gap-4 mb-6 border-b border-brand-platinum/10 pb-4">
                                    <button
                                        onClick={() => setHistoryTab('sold')}
                                        className={`text-sm font-bold transition-colors ${historyTab === 'sold' ? 'text-brand-blue' : 'text-brand-platinum/60 hover:text-brand-platinum'
                                            }`}
                                    >
                                        Sold History
                                    </button>
                                    <button
                                        onClick={() => setHistoryTab('purchased')}
                                        className={`text-sm font-bold transition-colors ${historyTab === 'purchased' ? 'text-brand-blue' : 'text-brand-platinum/60 hover:text-brand-platinum'
                                            }`}
                                    >
                                        Purchase History
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                    {historyTab === 'sold' ? (
                                        historySold.length === 0 ? (
                                            <div className="text-center py-12 text-brand-platinum/50">
                                                <p>No sold items history.</p>
                                            </div>
                                        ) : (
                                            historySold.map(item => (
                                                <div key={item.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5 opacity-75">
                                                    <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light grayscale">
                                                        {item.images?.[0] ? (
                                                            <img src={item.images[0]} className="w-full h-full object-cover" />
                                                        ) : (
                                                            <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">
                                                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="text-white font-bold">{item.player_name || 'Unknown Item'}</h3>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <p className="text-brand-platinum/60 text-xs italic">Sold - Completed</p>
                                                                    {/* @ts-ignore */}
                                                                    {item.orders && (
                                                                        <span className="text-[10px] px-2 py-0.5 rounded-full bg-brand-platinum/10 text-brand-platinum/40">
                                                                            {/* @ts-ignore */}
                                                                            {formatDate(Array.isArray(item.orders) ? item.orders[0]?.completed_at : item.orders?.completed_at)}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <div className="text-brand-gold font-bold">
                                                                {/* @ts-ignore */}
                                                                ¥{item.orders?.total_amount?.toLocaleString() || item.price?.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )
                                    ) : (
                                        historyPurchased.length === 0 ? (
                                            <div className="text-center py-12 text-brand-platinum/50">
                                                <p>No purchase history.</p>
                                            </div>
                                        ) : (
                                            historyPurchased.map(order => (
                                                <div key={order.id} className="flex gap-4 p-4 rounded-xl bg-brand-dark-light/30 border border-brand-platinum/5 opacity-75">
                                                    <div className="w-20 h-20 rounded-lg overflow-hidden bg-brand-dark-light grayscale">
                                                        <img src={order.listing?.images[0]} className="w-full h-full object-cover" />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <h3 className="text-white font-bold">{order.listing?.player_name || 'Unknown Item'}</h3>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <p className="text-brand-platinum/60 text-xs italic">Purchased - Completed</p>
                                                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-brand-platinum/10 text-brand-platinum/40">
                                                                        {(order as any).completed_at ? formatDate((order as any).completed_at) : formatDate(order.created_at)}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div className="text-brand-gold font-bold">
                                                                ¥{order.total_amount?.toLocaleString() || order.listing?.price?.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'archive' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {archivedItems.map((item) => (
                                    <ShowcaseCard
                                        key={item.id}
                                        item={item}
                                        isArchived={true}
                                        onRestore={handleRestoreCollectionItem}
                                        onDelete={handleDeleteCollectionItem} // Optional: if physical delete ever needed
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                        live_moments={item.live_moments} // New prop
                                        moment_created_at={item.moment_created_at}
                                    />
                                ))}
                                {archivedItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-12 text-brand-platinum/50">
                                        <svg className="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                                        <p>Your archive is empty.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
                <Footer />
                <AddToShowcaseModal
                    isOpen={isModalOpen}
                    onClose={() => setIsModalOpen(false)}
                    onAdded={fetchData}
                />

                {
                    showAnimation && (
                        <PurchaseAnimation
                            onComplete={() => {
                                setShowAnimation(false);
                                fetchData();
                            }}
                        />
                    )
                }
            </div>
        </div>
    );
}

export default function MyPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <MyPageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/community/page.tsx">
'use client';

import Footer from '../../components/Footer';

export default function CommunityPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full text-center">
                <div className="glass-panel-premium p-12 rounded-2xl shadow-2xl inline-block max-w-2xl">
                    <div className="w-20 h-20 bg-brand-gold/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-brand-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h1 className="text-4xl font-heading font-bold text-white mb-4">Community Hub</h1>
                    <p className="text-brand-platinum/60 text-lg mb-8">
                        Connect with other collectors, discuss trends, and show off your showcase.
                    </p>
                    <button className="px-8 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-xl transition-all shadow-lg shadow-brand-blue/20">
                        Join Discord
                    </button>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/debug-admin/page.tsx">
import { createClient } from '@/utils/supabase/server';

export default async function DebugAdminPage() {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    const adminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || 'NOT SET';
    // const publicAdminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || 'NOT SET'; // Removed redundancy
    const adminEmailsList = adminEmailsRaw.split(/[,;|]+/).map(e => e.trim().toLowerCase());

    const currentUserEmail = user?.email?.toLowerCase() || 'NOT LOGGED IN';
    const isMatched = user?.email ? adminEmailsList.includes(currentUserEmail) : false;

    return (
        <div style={{ padding: '40px', fontFamily: 'monospace', backgroundColor: '#111', color: '#eee', minHeight: '100vh' }}>
            <h1 style={{ color: '#FFD700' }}>Admin Authorization Debug</h1>
            <div style={{ backgroundColor: '#222', padding: '20px', borderRadius: '8px', border: '1px solid #444' }}>
                <p><strong>Logged in as:</strong> {user?.email || 'None'}</p>
                <p><strong>Environment ADMIN_EMAILS:</strong> {adminEmailsRaw}</p>
                <p><strong>Parsed Admin List:</strong> {JSON.stringify(adminEmailsList)}</p>
                <hr style={{ border: '0', borderTop: '1px solid #444', margin: '20px 0' }} />
                <p style={{ fontSize: '1.5rem' }}>
                    <strong>Result:</strong> {isMatched ? <span style={{ color: '#4ade80' }}>MATCHED (ACCESS GRANTED)</span> : <span style={{ color: '#f87171' }}>MISMATCH (ACCESS DENIED)</span>}
                </p>
            </div>

            <div style={{ marginTop: '40px', fontSize: '0.8rem', color: '#888' }}>
                <p>Possible causes for mismatch:</p>
                <ul>
                    <li>The email in ADMIN_EMAILS has a typo or extra space.</li>
                    <li>Vercel environment variables are not yet applied (requires redeploy).</li>
                    <li>Lowercase/Uppercase mismatch (the debug above normalizes to lowercase).</li>
                </ul>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/listings/[id]/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useParams, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { motion, AnimatePresence } from 'framer-motion';
import { createClient } from '../../../utils/supabase/client';
import Footer from '../../../components/Footer';
import { ListingItem } from '../../../types';
import AddToShowcaseModal from '../../../components/AddToShowcaseModal';
import MomentHistoryPanel from '../../../components/MomentHistoryPanel';

export default function ListingDetail() {
    const params = useParams();
    const searchParams = useSearchParams();
    const id = params?.id as string;
    const isDebugLive = searchParams.get('live') === 'true';

    const [user, setUser] = useState<any>(null);
    const [listing, setListing] = useState<ListingItem | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [selectedImage, setSelectedImage] = useState<string | null>(null);
    const [isEditModalOpen, setIsEditModalOpen] = useState(false);

    // Live Moment Logic
    const [isLiveActive, setIsLiveActive] = useState(false);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [momentsWithTime, setMomentsWithTime] = useState<any[]>([]);

    useEffect(() => {
        if (activeMoments.length === 0 && !isDebugLive) {
            setIsLiveActive(false);
            return;
        }

        setIsLiveActive(true);

        const updateTimers = () => {
            const now = new Date().getTime();
            const updated = activeMoments.map(m => {
                const createdTime = new Date(m.created_at).getTime();
                const end = createdTime + 60 * 60 * 1000;
                const distance = end - now;
                let timeLeft = '00:00';
                if (distance > 0) {
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timeLeft = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return { ...m, timeLeft, endTime: end };
            });

            setMomentsWithTime(updated);

            const hasOngoing = updated.some(m => (m.endTime - now) > 0);
            setIsLiveActive(isDebugLive || hasOngoing);
        };

        updateTimers();
        const timer = setInterval(updateTimers, 1000);
        return () => clearInterval(timer);
    }, [activeMoments, isDebugLive]);

    // Derived state for pure visual toggle
    const isLiveMoment = isLiveActive;

    const fetchListingAndUser = async () => {
        const supabase = createClient();

        // Fetch User
        const { data: { user } = { user: null } } = await supabase.auth.getUser();
        setUser(user);

        // Use the id from the outer scope (useParams hook)
        if (!id) return;

        try {
            const { data, error } = await supabase
                .from('listing_items')
                .select('*, seller:profiles(*), origin_order:orders!origin_order_id(id, status, moment_snapshot), related_orders:orders!listing_id(id, buyer_id, status, moment_snapshot)')
                .eq('id', id)
                .single();

            if (error) {
                throw error;
            }

            // Self-Healing Moment Logic
            let listingData = data as any;
            let originOrder = Array.isArray(listingData.origin_order) ? listingData.origin_order[0] : listingData.origin_order;

            // Fallback: If origin_order is missing, look for a completed order where I am the buyer
            if (!originOrder && user && listingData.related_orders) {
                const myPurchase = listingData.related_orders.find((o: any) =>
                    o.buyer_id === user.id &&
                    (o.status === 'completed' || o.status === 'shipped' || o.status === 'paid' || o.status === 'delivered')
                );
                if (myPurchase) {
                    originOrder = myPurchase;
                }
            }

            if (originOrder && originOrder.moment_snapshot) {
                const snapshots = Array.isArray(originOrder.moment_snapshot) ? originOrder.moment_snapshot : [originOrder.moment_snapshot];
                const history = Array.isArray(listingData.moment_history) ? listingData.moment_history : [];

                const missingSnapshots = snapshots.filter((sn: any) =>
                    !history.some((h: any) => (h.moment_id === sn.id) || (h.id === sn.id))
                );

                if (missingSnapshots.length > 0) {
                    listingData = {
                        ...listingData,
                        moment_history: [
                            ...history,
                            ...missingSnapshots.map((sn: any) => ({
                                moment_id: sn.id,
                                timestamp: sn.created_at || new Date().toISOString(),
                                title: sn.title,
                                player_name: sn.player_name,
                                intensity: sn.intensity,
                                description: sn.description,
                                match_result: sn.match_result,
                                owner_at_time: originOrder.id,
                                status: 'finalized'
                            }))
                        ]
                    };
                }
            }

            setListing(listingData);
            if (data.images && data.images.length > 0) {
                setSelectedImage(data.images[0]);
            }

            // CHECK LIVE MOMENTS
            const now = new Date();
            const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();
            const listingPlayerName = (data.player_name || '').toLowerCase();

            const { data: moments } = await supabase
                .from('live_moments')
                .select('*')
                .gt('created_at', lookback)
                .order('created_at', { ascending: false });

            if (moments && moments.length > 0) {
                const matched = moments.filter(m => {
                    const activePlayer = (m.player_name || '').toLowerCase();
                    if (listingPlayerName.includes(activePlayer)) return true;
                    if (activePlayer.includes(listingPlayerName)) return true;
                    return false;
                });

                setActiveMoments(matched);
            } else {
                setActiveMoments([]);
            }
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An unknown error occurred');
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchListingAndUser();
    }, [id]);

    const handleEditSuccess = () => {
        setIsEditModalOpen(false);
        window.location.reload();
    };

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (error || !listing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-brand-dark">
                <div className="text-red-500 text-xl font-semibold mb-4 bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error || 'Listing not found'}</div>
                <Link href="/" className="text-brand-blue hover:text-brand-blue-glow hover:underline transition-colors">
                    Back to Market
                </Link>
            </div>
        );
    }

    // Helper to get seller display name
    const getSellerName = (seller: any) => {
        if (!seller) return 'Unknown Seller';
        return seller.display_name || seller.name || 'Trading Card Collector';
    };

    return (
        <div className="min-h-screen bg-brand-dark pt-32 pb-32 px-4 sm:px-6 lg:px-8 flex flex-col">
            <div className="max-w-7xl mx-auto w-full flex-1">
                <nav className="mb-8">
                    <Link href="/market" className="text-brand-platinum hover:text-white font-medium flex items-center transition-colors group">
                        <span className="mr-2 group-hover:-translate-x-1 transition-transform">←</span> マーケットに戻る
                    </Link>
                </nav>

                <div className={`glass-panel-premium rounded-2xl shadow-2xl overflow-hidden border ${isLiveMoment ? 'border-brand-gold/50' : 'border-white/10'} transition-colors duration-500`}>
                    <div className="md:flex">
                        {/* Image Gallery Section */}
                        <div className="md:w-1/2 p-2 md:p-8 bg-brand-dark-light/50 relative overflow-hidden">
                            {/* Live Moment Ambient Background */}
                            {isLiveMoment && (
                                <div className="absolute inset-0 z-0">
                                    <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-br from-brand-gold/5 to-transparent mix-blend-overlay pointer-events-none" />
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-brand-gold/10 blur-[100px] animate-pulse-slow pointer-events-none" />
                                </div>
                            )}

                            <motion.div
                                className={`mb-6 aspect-[2/3] relative rounded-xl bg-brand-dark group perspective-[1000px] z-10`}
                                animate={isLiveMoment ? {
                                    boxShadow: [
                                        "0 0 20px rgba(255, 69, 0, 0.3)",
                                        "0 0 50px rgba(255, 69, 0, 0.6)",
                                        "0 0 20px rgba(255, 69, 0, 0.3)"
                                    ],
                                    borderColor: [
                                        "rgba(255, 69, 0, 0.4)",
                                        "rgba(255, 69, 0, 1)",
                                        "rgba(255, 69, 0, 0.4)"
                                    ]
                                } : {}}
                                transition={{
                                    duration: 2,
                                    repeat: Infinity,
                                    ease: "easeInOut"
                                }}
                                style={{
                                    borderWidth: isLiveMoment ? '2px' : '1px',
                                    borderStyle: 'solid',
                                    borderColor: isLiveMoment ? '#FF4500' : 'rgba(255, 255, 255, 0.05)'
                                }}
                            >
                                {/* Live Moment Badges */}
                                {isLiveActive && (
                                    <div className="absolute top-4 left-4 z-50 flex flex-col gap-2">
                                        {isDebugLive && momentsWithTime.length === 0 && (
                                            <div className="relative">
                                                <div className="absolute inset-0 bg-red-600 blur-lg opacity-50 animate-pulse"></div>
                                                <div className="relative px-3 py-1 bg-gradient-to-r from-red-600 to-red-500 text-white text-[10px] font-bold tracking-widest uppercase rounded shadow-lg border border-white/30 flex items-center gap-2">
                                                    <span className="text-sm">🔥</span>
                                                    DEBUG LIVE
                                                    <span className="ml-2 pl-2 border-l border-white/20 font-mono text-xs">60:00</span>
                                                </div>
                                            </div>
                                        )}
                                        {momentsWithTime.map((m) => (
                                            <div key={m.id} className="relative">
                                                <div className="absolute inset-0 bg-red-600 blur-lg opacity-50 animate-pulse"></div>
                                                <div className="relative px-3 py-1 bg-gradient-to-r from-red-600 to-red-500 text-white text-[10px] font-bold tracking-widest uppercase rounded shadow-lg border border-white/30 flex items-center gap-2">
                                                    <span className="text-sm">🔥</span>
                                                    {m.title || 'LIVE MOMENT'}
                                                    <span className="ml-2 pl-2 border-l border-white/20 font-mono text-xs">{m.timeLeft}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${selectedImage === listing.images[1] ? '[transform:rotateY(180deg)]' : ''}`}>
                                    {/* Front Image (Image 0) */}
                                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] rounded-xl overflow-hidden shadow-2xl">
                                        {listing.images && listing.images.length > 0 ? (
                                            <>
                                                <Image
                                                    src={listing.images[0]}
                                                    alt={listing.player_name || "Card Image"}
                                                    fill
                                                    sizes="(max-width: 768px) 100vw, 50vw"
                                                    className="object-contain p-0 md:p-4 bg-brand-dark-light/50"
                                                />
                                                {/* Inner Glow Overlay */}
                                                {isLiveMoment && (
                                                    <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_50px_rgba(255,215,0,0.3)] rounded-xl mix-blend-overlay" />
                                                )}
                                            </>
                                        ) : (
                                            <div className="flex items-center justify-center h-full text-brand-platinum/30">No Image</div>
                                        )}
                                    </div>

                                    {/* Back Image (Image 1) */}
                                    {listing.images && listing.images.length > 1 && (
                                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] rounded-xl overflow-hidden shadow-2xl bg-brand-dark-light/50">
                                            <Image
                                                src={listing.images[1]}
                                                alt={`${listing.player_name || ''} Back`}
                                                fill
                                                sizes="(max-width: 768px) 100vw, 50vw"
                                                className="object-contain p-4"
                                            />
                                        </div>
                                    )}
                                </div>

                                {/* Glow Effect Behind Image (Enhanced for Live Moment) */}
                                <div className={`absolute inset-0 blur-3xl -z-10 ${isLiveMoment ? 'bg-brand-gold/20' : 'bg-brand-blue/5'}`}></div>
                            </motion.div>

                            {/* Thumbnails */}
                            {listing.images && listing.images.length > 1 && (
                                <div className="flex space-x-4 overflow-x-auto pb-2 scrollbar-hide">
                                    {listing.images.map((img: string, index: number) => (
                                        <button
                                            key={index}
                                            onClick={() => setSelectedImage(img)}
                                            className={`w-20 h-28 flex-shrink-0 rounded-lg border-2 overflow-hidden transition-all ${selectedImage === img ? 'border-brand-blue shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'border-transparent opacity-60 hover:opacity-100'}`}
                                        >
                                            <div className="relative w-full h-full">
                                                <Image
                                                    src={img}
                                                    alt={`View ${index + 1}`}
                                                    fill
                                                    sizes="80px"
                                                    className="object-cover"
                                                />
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Product Details Section */}
                        <div className="md:w-1/2 p-10 flex flex-col">
                            <div className="mb-8">
                                {/* Active Moment Context Box */}
                                {momentsWithTime.length > 0 && (
                                    <div className="flex flex-col gap-4 mb-6">
                                        {momentsWithTime.map((m) => (
                                            <div key={m.id} className="p-4 rounded-xl bg-gradient-to-r from-red-900/40 to-black border border-red-500/30 relative overflow-hidden group/live shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                                                <div className="absolute top-0 right-0 p-2 opacity-10">
                                                    <svg className="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 1012.12 15.12z" clipRule="evenodd" /></svg>
                                                </div>
                                                <div className="relative z-10">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="relative flex h-2 w-2">
                                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                                            <span className="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                                                        </span>
                                                        <p className="text-red-400 text-xs font-bold tracking-widest uppercase">HAPPENING NOW</p>
                                                        <span className="text-brand-platinum/40 text-xs">•</span>
                                                        <p className="text-brand-platinum/60 text-xs font-mono">{m.match_result || 'Live Match'}</p>
                                                    </div>
                                                    <h3 className="text-white font-bold text-lg mb-1 leading-tight">{m.title}</h3>
                                                    <p className="text-brand-platinum/80 text-sm line-clamp-2">{m.description}</p>
                                                    <div className="mt-3 flex items-center gap-3">
                                                        <div className="px-2 py-0.5 bg-red-500/20 rounded border border-red-500/30">
                                                            <span className="text-[10px] text-red-400 font-bold font-mono">{m.timeLeft} REMAINING</span>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            {[...Array(m.intensity || 1)].map((_, i) => (
                                                                <span key={i} className="text-red-500 text-xs">🔥</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <div className="flex items-center space-x-3 mb-4">
                                    <span className="px-3 py-1 rounded-full text-xs font-bold bg-brand-blue/10 text-brand-blue border border-brand-blue/20 uppercase tracking-wider">
                                        {listing.team || 'Unknown Team'}
                                    </span>
                                    {listing.is_rookie && (
                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-brand-gold/10 text-brand-gold border border-brand-gold/20 uppercase tracking-wider animate-pulse-slow">
                                            Rookie Card
                                        </span>
                                    )}
                                    {listing.is_autograph && (
                                        <span className="px-3 py-1 rounded-full text-xs font-bold bg-purple-500/10 text-purple-400 border border-purple-500/20 uppercase tracking-wider">
                                            Autograph
                                        </span>
                                    )}
                                </div>
                                <h1 className="text-4xl md:text-5xl font-heading font-bold text-white mb-2 text-glow">{listing.player_name || 'Unknown Player'}</h1>
                                <p className="text-xl text-brand-platinum/80 font-light">{listing.year} {listing.manufacturer} {listing.series_name || ''}</p>
                                <p className="text-brand-platinum/50 mt-2 text-sm">
                                    Card #{listing.card_number || '---'}
                                    {listing.serial_number && ` • SN: ${listing.serial_number}`}
                                    {listing.variation && ` • ${listing.variation}`}
                                </p>

                                {/* Seller Info */}
                                <div className="flex items-center gap-3 mt-4 pt-4 border-t border-brand-platinum/10">
                                    <div className="w-10 h-10 rounded-full bg-brand-platinum/10 overflow-hidden relative">
                                        <Image
                                            src={listing.seller?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${listing.seller?.display_name || listing.seller?.email || 'Seller'}`}
                                            alt="Seller"
                                            fill
                                            className="object-cover"
                                        />
                                    </div>
                                    <div>
                                        <p className="text-xs text-brand-platinum/50 uppercase tracking-wider">出品者</p>
                                        <Link href={`/profile/${listing.seller_id}`} className="text-white font-medium hover:text-brand-blue transition-colors">
                                            {getSellerName(listing.seller)}
                                        </Link>
                                    </div>
                                </div>
                            </div>

                            {/* --- Product Details (Spec Sheet) --- */}
                            <div className="border-t border-brand-platinum/10 py-6">
                                <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-4">商品詳細 (Product Details)</h3>
                                <dl className="grid grid-cols-2 gap-x-4 gap-y-4 text-sm">
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">チーム (Team)</dt>
                                        <dd className="font-medium text-white">{listing.team || '---'}</dd>
                                    </div>
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">年度 (Year)</dt>
                                        <dd className="font-medium text-white">{listing.year || '---'}</dd>
                                    </div>
                                    <div className="col-span-1">
                                        <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">ブランド (Brand)</dt>
                                        <dd className="font-medium text-white">{listing.manufacturer || '---'}</dd>
                                    </div>
                                    {listing.variation && (
                                        <div className="col-span-1">
                                            <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">バリエーション</dt>
                                            <dd className="font-medium text-white">{listing.variation}</dd>
                                        </div>
                                    )}
                                    {listing.serial_number && (
                                        <div className="col-span-1">
                                            <dt className="text-brand-platinum/50 text-xs uppercase tracking-wider mb-1">シリアル番号</dt>
                                            <dd className="font-mono text-brand-gold">{listing.serial_number}</dd>
                                        </div>
                                    )}
                                </dl>
                            </div>

                            {/* --- Description --- */}
                            {listing.description && (
                                <div className="border-t border-brand-platinum/10 py-6">
                                    <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-3">商品説明 (Description)</h3>
                                    <p className="text-brand-platinum/80 leading-relaxed whitespace-pre-wrap">{listing.description}</p>
                                </div>
                            )}

                            <div className="border-t border-brand-platinum/10 py-8">
                                <h3 className="text-sm font-bold text-brand-platinum/40 uppercase tracking-widest mb-6">状態・グレーディング (Condition)</h3>
                                <div className="grid grid-cols-2 gap-y-6 gap-x-4">
                                    <div>
                                        <p className="text-xs text-brand-platinum/50 uppercase mb-1">鑑定有無 (Graded)</p>
                                        <p className="font-medium text-white text-lg">{listing.condition_grading.is_graded ? 'あり (Yes)' : 'なし (No)'}</p>
                                    </div>
                                    {!listing.condition_grading.is_graded && (
                                        <div>
                                            <p className="text-xs text-brand-platinum/50 uppercase mb-1">状態 (Condition)</p>
                                            <p className="font-medium text-white text-lg">{listing.condition_rating || listing.condition_grading.service || '---'}</p>
                                        </div>
                                    )}
                                    {listing.condition_grading.is_graded && (
                                        <>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">鑑定機関 (Service)</p>
                                                <p className="font-medium text-white text-lg">{listing.condition_grading.service}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">グレード点数 (Score)</p>
                                                <p className="font-heading font-bold text-3xl text-brand-blue text-glow">{listing.condition_grading.score}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-brand-platinum/50 uppercase mb-1">証明番号 (Cert #)</p>
                                                <p className="font-mono text-sm text-brand-platinum">{listing.condition_grading.certification_number}</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>

                            {/* --- Moment History Timeline --- */}
                            {(() => {
                                // Merge Active (Live) Moments into the history for display
                                const displayHistory = [...(listing.moment_history || [])];

                                // Inject Active Moments for ALL listings (including owned)
                                // This encourages owners to sell when a card is "hot" (Live).
                                // [RESTORED & REFINED] Per user request (Step 7743), we restore this injection BUT with a check.
                                // If the Active Moment matches a moment captured in the Purchase Snapshot (origin_order),
                                // we treat it as "Real" (is_virtual: false), allowing the owner to write memories.
                                // Otherwise, it implies a Future Event (Opportunity), so we treat it as "Virtual" (Read-only).

                                const originOrder = listing.origin_order ? (Array.isArray(listing.origin_order) ? listing.origin_order[0] : listing.origin_order) : null;
                                const snapshotIds = originOrder && originOrder.moment_snapshot
                                    ? (Array.isArray(originOrder.moment_snapshot) ? originOrder.moment_snapshot.map((s: any) => s.id) : [originOrder.moment_snapshot.id])
                                    : [];

                                activeMoments.forEach(am => {
                                    const isAlreadyAccountedFor = displayHistory.some((m: any) =>
                                        (m.moment_id === am.id) || (m.id === am.id)
                                    );

                                    if (!isAlreadyAccountedFor) {
                                        // Check if this active moment was captured in the purchase snapshot
                                        const isCapturedInSnapshot = snapshotIds.includes(am.id);

                                        // [CHANGED] Strictly HIDE virtual moments from the history list.
                                        // Only show active moments if they are part of the OWNED history (captured in snapshot).
                                        if (isCapturedInSnapshot) {
                                            displayHistory.push({
                                                id: am.id,
                                                moment_id: am.id,
                                                title: am.title,
                                                description: am.description,
                                                timestamp: am.created_at,
                                                status: 'live', // Mark as live
                                                player_name: am.player_name,
                                                intensity: am.intensity,
                                                match_result: am.match_result,
                                                is_virtual: false // It is real/owned
                                            } as any);
                                        }
                                    }
                                });

                                return (
                                    <MomentHistoryPanel
                                        history={displayHistory}
                                        itemId={listing.id}
                                        isOwner={user?.id === listing.seller_id}
                                        onSuccess={fetchListingAndUser}
                                    />
                                );
                            })()}

                            <div className="border-t border-brand-platinum/10 pt-8 mt-auto">
                                <div className="flex items-end justify-between mb-8">
                                    <div>
                                        <p className="text-sm text-brand-platinum/50 uppercase tracking-wider mb-1">
                                            {listing.status === 'Display' ? 'ステータス' : '現在価格'}
                                        </p>
                                        {listing.status === 'Display' ? (
                                            <span className="px-4 py-2 rounded-lg bg-brand-platinum/10 border border-brand-platinum/20 text-white font-bold tracking-wider">
                                                展示のみ (Display Only)
                                            </span>
                                        ) : (
                                            <p className="text-5xl font-heading font-bold text-brand-gold text-gold-glow tracking-tight">
                                                ¥{listing.price?.toLocaleString() ?? '---'}
                                            </p>
                                        )}
                                    </div>
                                </div>

                                {user?.id === listing.seller_id ? (
                                    <div className="bg-brand-dark-light/50 p-6 rounded-xl text-center border border-brand-platinum/10">
                                        <p className="text-brand-platinum font-medium">あなたの出品商品です。</p>
                                        <button
                                            onClick={() => setIsEditModalOpen(true)}
                                            className="mt-4 text-brand-blue hover:text-brand-blue-glow text-sm font-bold uppercase tracking-wider transition-colors"
                                        >
                                            出品を編集
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        {listing.status === 'Active' ? (
                                            <>
                                                <Link
                                                    href={`/checkout/${listing.id}`}
                                                    className="block w-full bg-brand-blue hover:bg-brand-blue-glow text-white text-xl font-bold py-5 rounded-xl transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:shadow-[0_0_40px_rgba(59,130,246,0.6)] hover:scale-[1.02] text-center"
                                                >
                                                    購入手続きへ
                                                </Link>
                                                <div className="flex items-center justify-center mt-6 gap-2 text-brand-platinum/40 text-sm">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                                    Secure transaction via Stripe
                                                </div>
                                            </>
                                        ) : (
                                            <div className="bg-brand-dark-light/30 p-6 rounded-xl text-center border border-brand-platinum/5">
                                                <p className="text-brand-platinum/60">
                                                    この商品は{listing.status === 'Display' ? '展示のみで' : '現在'}購入できません。
                                                </p>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <Footer />

            <AddToShowcaseModal
                isOpen={isEditModalOpen}
                onClose={() => setIsEditModalOpen(false)}
                onAdded={handleEditSuccess}
                mode="edit"
                initialData={listing}
            />
        </div>
    );
}
</file>

<file path="frontend/app/login/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';

import { Suspense } from 'react';

function LoginForm() {
    const [email, setEmail] = useState('demo@example.com');
    const [password, setPassword] = useState('password');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const router = useRouter();
    const searchParams = useSearchParams();

    useEffect(() => {
        if (searchParams.get('registered') === 'true') {
            // Optional: Show a success message if redirected from registration
        }
    }, [searchParams]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
            const supabase = createClient();
            const { error } = await supabase.auth.signInWithPassword({
                email,
                password,
            });

            if (error) {
                setError(error.message);
            } else {
                window.location.href = '/';
            }
        } catch (err) {
            setError('予期せぬエラーが発生しました');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="glass-panel-premium p-8 rounded-2xl shadow-2xl border border-white/10">
            <form className="space-y-6" onSubmit={handleSubmit}>
                {error && (
                    <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl text-sm">
                        {error}
                    </div>
                )}

                {searchParams.get('registered') === 'true' && !error && (
                    <div className="bg-green-500/10 border border-green-500/20 text-green-400 px-4 py-3 rounded-xl text-sm">
                        アカウント作成が完了しました。ログインしてください。
                    </div>
                )}

                <div>
                    <label htmlFor="email" className="block text-sm font-medium text-brand-platinum mb-2">
                        メールアドレス (Email)
                    </label>
                    <input
                        id="email"
                        name="email"
                        type="email"
                        autoComplete="email"
                        required
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                        placeholder="name@example.com"
                    />
                </div>

                <div>
                    <label htmlFor="password" className="block text-sm font-medium text-brand-platinum mb-2">
                        パスワード (Password)
                    </label>
                    <input
                        id="password"
                        name="password"
                        type="password"
                        autoComplete="current-password"
                        required
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                        placeholder="••••••••"
                    />
                </div>

                <div>
                    <button
                        type="submit"
                        disabled={loading}
                        className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                        {loading ? 'ログイン処理中...' : 'ログイン'}
                    </button>
                </div>
            </form>

            <div className="mt-6 text-center">
                <p className="text-sm text-brand-platinum/60">
                    アカウントをお持ちでない場合は{' '}
                    <Link href="/register" className="font-medium text-brand-blue hover:text-brand-blue-glow transition-colors">
                        新規登録
                    </Link>
                </p>
            </div>
        </div>
    );
}

export default function LoginPage() {
    return (
        <div className="min-h-screen flex flex-col">
            <div className="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div className="max-w-md w-full space-y-8">
                    <div className="text-center">
                        <Link href="/" className="inline-block mb-6 group">
                            <span className="font-heading text-4xl font-bold tracking-tighter text-white group-hover:text-glow transition-all">
                                TC<span className="text-brand-gold text-gold-glow">.APP</span>
                            </span>
                        </Link>
                        <h2 className="text-3xl font-heading font-bold text-white">
                            おかえりなさい
                        </h2>
                        <p className="mt-2 text-brand-platinum/60">
                            コレクションにアクセスするにはログインしてください。
                        </p>
                    </div>

                    <Suspense fallback={<div className="text-center text-white">読み込み中...</div>}>
                        <LoginForm />
                    </Suspense>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/market/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import CardListing from '../../components/CardListing';
import Footer from '../../components/Footer';
import { ListingItem, Team } from '../../types';

function MarketPageContent() {
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const [listings, setListings] = useState<ListingItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    // Search & Filter State
    const [searchQuery, setSearchQuery] = useState(searchParams.get('search') || '');
    const [selectedTeam, setSelectedTeam] = useState<string>('');
    const [sortOrder, setSortOrder] = useState('newest');

    // Debounce search
    const [debouncedSearch, setDebouncedSearch] = useState(searchQuery);

    useEffect(() => {
        const timer = setTimeout(() => {
            setDebouncedSearch(searchQuery);
        }, 500);
        return () => clearTimeout(timer);
    }, [searchQuery]);

    useEffect(() => {
        const fetchListings = async () => {
            setLoading(true);
            try {
                const supabase = createClient();
                const now = new Date();
                const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();

                // 1. Fetch Active Live Moments
                const { data: activeMoments } = await supabase
                    .from('live_moments')
                    .select('player_name, created_at')
                    .gt('created_at', lookback);

                // Store full objects for time calculation
                const momentsData = activeMoments || [];

                const activePlayers = Array.from(new Set(momentsData?.map(m => (m.player_name || '').toLowerCase().trim()) || []));
                console.log("Active Players (Live):", activePlayers);

                // Helper to build base query with filters
                const buildBaseQuery = () => {
                    let q = supabase
                        .from('listing_items')
                        .select('*')
                        .eq('status', 'Active');

                    if (selectedTeam) {
                        q = q.eq('team', selectedTeam);
                    }
                    return q;
                };

                let finalData: any[] = [];

                if (sortOrder === 'newest' && activePlayers.length > 0) {
                    // --- Priority Logic ---

                    // A. Fetch Priority Listings (Matches Active Players)
                    // A. Fetch Priority Listings (Matches Active Players)
                    let pQuery = buildBaseQuery()
                        .in('player_name', activePlayers)
                        .order('created_at', { ascending: false });

                    // B. Fetch Regular Listings (Non-Active Players)
                    const activePlayersList = `(${activePlayers.map(p => `"${p}"`).join(',')})`;
                    let rQuery = buildBaseQuery()
                        .not('player_name', 'in', activePlayersList)
                        .order('created_at', { ascending: false });

                    // Execute in parallel
                    const [pRes, rRes] = await Promise.all([pQuery, rQuery]);

                    if (pRes.error) throw pRes.error;
                    if (rRes.error) throw rRes.error;

                    finalData = [...(pRes.data || []), ...(rRes.data || [])];

                } else {
                    // --- Standard Logic ---
                    let query = buildBaseQuery();

                    if (sortOrder === 'newest') {
                        query = query.order('created_at', { ascending: false });
                    } else if (sortOrder === 'price_asc') {
                        query = query.order('price', { ascending: true, nullsFirst: false });
                    } else if (sortOrder === 'price_desc') {
                        query = query.order('price', { ascending: false, nullsFirst: false });
                    }

                    const { data, error } = await query;
                    if (error) throw error;
                    finalData = data || [];
                }

                // Client-side Text Search (as before)
                if (debouncedSearch) {
                    const lowerSearch = debouncedSearch.toLowerCase();
                    finalData = finalData.filter((item: any) =>
                        (item.player_name || '').toLowerCase().includes(lowerSearch) ||
                        (item.manufacturer || '').toLowerCase().includes(lowerSearch) ||
                        (item.series_name || '').toLowerCase().includes(lowerSearch)
                    );
                }

                // INJECT LIVE MOMENT FLAG
                // This ensures the CardListing receives true if player is in the active list (Case Insensitive & Fuzzy)
                finalData = finalData.map((item: any) => {
                    const itemName = (item.player_name || '').toLowerCase();

                    // Find all matching moments (Multiple Moments Support)
                    const matchedMoments = momentsData.filter((m: any) => {
                        const p1 = (m.player_name || '').toLowerCase();
                        if (itemName.includes(p1)) return true;
                        if (p1.includes(itemName)) return true;
                        return false;
                    });

                    // Store all end times as an array
                    const liveMoments = matchedMoments.map((m: any) => {
                        let endTime = null;
                        if (m.created_at) {
                            const created = new Date(m.created_at).getTime();
                            if (!isNaN(created)) {
                                endTime = created + 60 * 60 * 1000;
                            }
                        }
                        return {
                            id: m.id,
                            title: m.title,
                            endTime: endTime
                        };
                    }).filter(m => m.endTime !== null);

                    return {
                        ...item,
                        is_live_moment: liveMoments.length > 0,
                        live_moments: liveMoments
                    };
                });

                setListings(finalData);

            } catch (err) {
                console.error(err);
                setError(err instanceof Error ? err.message : 'An unknown error occurred');
            } finally {
                setLoading(false);
            }
        };

        fetchListings();
    }, [debouncedSearch, selectedTeam, sortOrder]);

    const teams: Team[] = ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"];

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pb-20">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full">
                <div className="mb-8">
                    <h1 className="text-4xl font-heading font-bold text-white mb-2">Marketplace</h1>
                    <p className="text-brand-platinum/60">Discover and trade premium baseball cards.</p>
                </div>

                {/* Search & Filter Bar */}
                <div className="glass-panel-premium p-6 rounded-2xl shadow-2xl mb-12 animate-fade-in-up">
                    <div className="flex flex-col md:flex-row gap-4 items-center">
                        {/* Search Input */}
                        <div className="flex-1 w-full">
                            <label htmlFor="search" className="sr-only">Search</label>
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg className="h-5 w-5 text-brand-platinum/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input
                                    type="text"
                                    id="search"
                                    placeholder="Search player, series, or year..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="block w-full pl-10 pr-3 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                />
                            </div>
                        </div>

                        {/* Team Filter */}
                        <div className="w-full md:w-48">
                            <label htmlFor="team" className="sr-only">Team</label>
                            <select
                                id="team"
                                value={selectedTeam}
                                onChange={(e) => setSelectedTeam(e.target.value)}
                                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
                            >
                                <option value="">All Teams</option>
                                {teams.map((team) => (
                                    <option key={team} value={team}>{team}</option>
                                ))}
                            </select>
                        </div>

                        {/* Sort Order */}
                        <div className="w-full md:w-48">
                            <label htmlFor="sort" className="sr-only">Sort</label>
                            <select
                                id="sort"
                                value={sortOrder}
                                onChange={(e) => setSortOrder(e.target.value)}
                                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
                            >
                                <option value="newest">Newest</option>
                                <option value="price_asc">Price: Low to High</option>
                                <option value="price_desc">Price: High to Low</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* Listings Grid */}
                <div className="mb-12">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-heading font-bold text-white">All Listings</h2>
                        <span className="text-brand-platinum/60 text-sm">{listings.length} items found</span>
                    </div>

                    {loading ? (
                        <div className="min-h-[400px] flex items-center justify-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
                        </div>
                    ) : error ? (
                        <div className="min-h-[400px] flex items-center justify-center">
                            <div className="text-red-500 text-xl font-semibold bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error}</div>
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6">
                                {listings.map((item) => (
                                    <CardListing
                                        key={item.id}
                                        item={item}
                                        isLiveMoment={(item as any).is_live_moment || isDebugLive}
                                        liveMoments={(item as any).live_moments}
                                    />
                                ))}
                            </div>

                            {listings.length === 0 && (
                                <div className="text-center py-20 bg-brand-dark-light/30 rounded-2xl border border-brand-platinum/5">
                                    <p className="text-brand-platinum/50 text-lg">No listings found matching your criteria.</p>
                                    <button
                                        onClick={() => { setSearchQuery(''); setSelectedTeam(''); }}
                                        className="mt-4 text-brand-blue hover:text-brand-blue-glow font-medium"
                                    >
                                        Clear Filters
                                    </button>
                                </div>
                            )}
                        </>
                    )}
                </div>
            </div>

            <Footer />
        </div>
    );
}

export default function MarketPage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <MarketPageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/orders/[id]/success/page.tsx">
'use client';

import { useParams } from 'next/navigation';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import Image from 'next/image';
import { createClient } from '../../../../utils/supabase/client';
import { getBuyerItemByOrder } from '../../../../app/actions/item';
import MomentHistoryPanel from '../../../../components/MomentHistoryPanel';

export default function OrderSuccessPage() {
    const params = useParams();
    const id = params.id as string;

    const [order, setOrder] = useState<any>(null);
    const [buyerItem, setBuyerItem] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [retryCount, setRetryCount] = useState(0);
    const [user, setUser] = useState<any>(null);

    const fetchData = async () => {
        const supabase = createClient();

        // 0. Fetch User
        const { data: { user: userData } } = await supabase.auth.getUser();
        setUser(userData);

        // 1. Fetch order with listing details
        const { data: orderData } = await supabase
            .from('orders')
            .select('*, listing:listing_items!listing_id(*)')
            .eq('id', id)
            .single();

        if (orderData) {
            setOrder(orderData);

            // 2. Detect Active Live Moment for this player
            const playerName = orderData.listing?.player_name;
            if (playerName) {
                const now = new Date();
                const lookback = new Date(now.getTime() - 60 * 60 * 1000).toISOString();
                const listingPlayerName = playerName.toLowerCase();

                const { data: moments } = await supabase
                    .from('live_moments')
                    .select('*')
                    .gt('created_at', lookback)
                    .order('created_at', { ascending: false });

                if (moments) {
                    const matched = moments.filter(m => {
                        const activePlayer = (m.player_name || '').toLowerCase();
                        return listingPlayerName.includes(activePlayer) || activePlayer.includes(listingPlayerName);
                    });
                    setActiveMoments(matched);
                }
            }

            // 3. Try to find the buyer's cloned item
            const item = await getBuyerItemByOrder(id);
            if (item) {
                setBuyerItem(item);
            }
        }
        setLoading(false);
    };

    useEffect(() => {
        if (id) {
            fetchData();
        }
    }, [id]);

    // Polling for buyerItem (Stripe Webhook might be slow)
    useEffect(() => {
        if (id && !buyerItem && retryCount < 150 && !loading) {
            const timer = setTimeout(() => {
                console.log(`Polling for buyer item (Attempt ${retryCount + 1}/150)...`);
                setRetryCount(prev => prev + 1);
                fetchData();
            }, 2000); // Poll every 2 seconds
            return () => clearTimeout(timer);
        }
    }, [id, buyerItem, retryCount, loading]);

    if (loading && retryCount === 0) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    const listing = order?.listing;

    return (
        <div className="min-h-screen bg-brand-dark py-12 px-4 sm:px-6 lg:px-8 flex flex-col items-center">
            <div className="w-full max-w-2xl">
                <div className="glass-panel-premium py-10 px-6 sm:px-10 shadow-2xl rounded-2xl text-center border border-white/10 relative overflow-hidden">
                    {/* Decorative Background */}
                    <div className="absolute -top-24 -right-24 w-64 h-64 bg-brand-blue/10 rounded-full blur-[80px]"></div>
                    <div className="absolute -bottom-24 -left-24 w-64 h-64 bg-brand-gold/5 rounded-full blur-[80px]"></div>

                    <div className="relative z-10">
                        <div className="mx-auto flex items-center justify-center h-20 w-20 rounded-full bg-brand-blue/20 mb-6 border border-brand-blue/30 shadow-[0_0_20px_rgba(59,130,246,0.2)]">
                            <svg className="h-10 w-10 text-brand-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>

                        <h2 className="text-3xl font-heading font-bold text-white mb-2 tracking-tight">Purchase Successful!</h2>
                        <p className="text-brand-platinum/60 mb-8 max-w-md mx-auto">
                            Thank you for your order. Your transaction has been completed and the card is now part of your collection.
                        </p>

                        {/* Order ID Box */}
                        <div className="bg-black/40 rounded-xl p-4 mb-8 border border-white/5 inline-block mx-auto">
                            <p className="text-[10px] text-brand-platinum/40 uppercase tracking-widest mb-1 font-bold">Order ID</p>
                            <p className="font-mono text-xs text-brand-blue-glow break-all px-4">{id}</p>
                        </div>

                        {/* Card Details Summary */}
                        {listing && (
                            <div className="bg-brand-dark-light/40 rounded-2xl p-6 mb-8 border border-brand-gold/20 flex flex-col sm:flex-row items-center gap-6 text-left group">
                                <div className="relative w-32 h-44 flex-shrink-0 rounded-lg overflow-hidden border border-white/10 shadow-xl group-hover:border-brand-gold/50 transition-colors">
                                    <Image
                                        src={listing.images?.[0] || '/placeholder-card.png'}
                                        alt={listing.player_name || 'Card'}
                                        fill
                                        className="object-cover"
                                    />
                                </div>
                                <div className="flex-1">
                                    <p className="text-brand-gold text-xs font-bold uppercase tracking-widest mb-1">Newly Acquired</p>
                                    <h3 className="text-2xl font-bold text-white mb-1">{listing.player_name}</h3>
                                    <p className="text-brand-platinum/70 text-sm mb-4">
                                        {listing.year} {listing.manufacturer} {listing.series_name}
                                    </p>
                                    <div className="flex flex-wrap gap-2">
                                        <span className="px-2 py-1 bg-white/5 rounded text-[10px] font-bold text-brand-platinum/50 border border-white/10">#{listing.card_number}</span>
                                        {listing.is_rookie && <span className="px-2 py-1 bg-brand-gold/10 rounded text-[10px] font-bold text-brand-gold border border-brand-gold/20">ROOKIE</span>}
                                        <span className="px-2 py-1 bg-brand-blue/10 rounded text-[10px] font-bold text-brand-blue border border-brand-blue/20 uppercase">{listing.condition_grading?.score || 'RAW'}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Moment History (Legendary Log) */}
                        <div className="text-left mb-8 border-t border-white/5 pt-8">
                            <h3 className="text-xs font-bold text-brand-platinum/40 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 rounded-full bg-brand-gold animate-pulse"></span>
                                {buyerItem ? "Start Your Card's Legend" : (retryCount < 10 ? "Preparing your card for memories..." : "Recording delayed - You can add memories later in Collection")}
                            </h3>
                            {(() => {
                                let displayHistory = [...(buyerItem?.history || listing?.moment_history || [])];

                                // Virtual Moment Injection: 
                                // Check if active live moments are captured in the snapshot (Owned) or are new (Virtual).
                                const snapshotIds = order?.moment_snapshot
                                    ? (Array.isArray(order.moment_snapshot) ? order.moment_snapshot.map((s: any) => s.id) : [order.moment_snapshot.id])
                                    : [];

                                activeMoments.forEach(am => {
                                    if (!displayHistory.some(m => m.moment_id === am.id)) {
                                        // If this active moment is in the snapshot, it's REAL (Owned History), so allow editing.
                                        const isCaptured = snapshotIds.includes(am.id);
                                        const isVirtual = !isCaptured;

                                        displayHistory.push({
                                            moment_id: am.id,
                                            title: am.title,
                                            description: am.description,
                                            timestamp: am.created_at,
                                            status: 'live',
                                            player_name: am.player_name,
                                            intensity: am.intensity,
                                            match_result: am.match_result,
                                            is_virtual: isVirtual
                                        });
                                    }
                                });

                                if (displayHistory.length === 0 && !buyerItem) {
                                    return (
                                        <div className="p-8 rounded-xl bg-white/5 border border-dashed border-white/10 text-center">
                                            <div className="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-brand-gold mb-2"></div>
                                            <p className="text-xs text-brand-platinum/30 uppercase tracking-widest">
                                                {retryCount < 10 ? "Syncing Ownership..." : "Sync taking longer than expected"}
                                            </p>
                                        </div>
                                    );
                                }

                                return (
                                    <MomentHistoryPanel
                                        history={displayHistory}
                                        itemId={buyerItem?.id || undefined}
                                        isOwner={!!(user && order && user.id === order.buyer_id)}
                                        onSuccess={fetchData}
                                    />
                                );
                            })()}
                        </div>

                        {/* Navigation Buttons */}
                        <div className="flex flex-col sm:flex-row gap-4 mt-10">
                            <Link
                                href="/collection"
                                className="flex-1 flex justify-center items-center py-4 px-6 rounded-xl text-sm font-bold text-white bg-white/5 hover:bg-white/10 border border-white/10 transition-all hover:scale-[1.02] active:scale-[0.98]"
                            >
                                <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                Go to Collection
                            </Link>
                            <Link
                                href="/market"
                                className="flex-1 flex justify-center items-center py-4 px-6 border border-transparent rounded-xl shadow-[0_0_20px_rgba(59,130,246,0.3)] text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow transition-all hover:scale-[1.02] active:scale-[0.98]"
                            >
                                Back to Market
                                <svg className="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </Link>
                        </div>

                        <p className="mt-8 text-[10px] text-brand-platinum/30 uppercase tracking-[0.2em] font-light">
                            Secured and Verified by Stadium Card Chain
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/orders/buy/[id]/page.tsx">
'use client';

import { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation';
import MomentHistoryPanel from '../../../../components/MomentHistoryPanel';
import { createClient } from '../../../../utils/supabase/client';
import { markAsReceived, getBuyerOrderDetails } from '../../../actions/order';
import { getBuyerItemByOrder } from '../../../actions/item';

interface OrderDetail {
    id: string;
    buyer_id: string;
    status: string;
    listing: {
        title: string;
        player_name: string;
        images: string[];
        price: number;
        seller_id: string;
        moment_history?: any[];
    };
    created_at: string;
    tracking_number?: string;
    carrier?: string;
    shipped_at?: string;
    completed_at?: string;
    moment_snapshot?: any | null; // Can be object or array
}

export default function BuyerOrderPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const [order, setOrder] = useState<OrderDetail | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);
    const [buyerItem, setBuyerItem] = useState<{ id: string; history: any[] } | null>(null);
    const [activeMoments, setActiveMoments] = useState<any[]>([]);
    const [retryCount, setRetryCount] = useState(0);
    const [user, setUser] = useState<any>(null);

    const fetchOrder = async () => {
        try {
            const supabase = createClient();
            const { data: { user: userData } } = await supabase.auth.getUser();
            setUser(userData);

            const data = await getBuyerOrderDetails(id);
            setOrder(data as any);
            setLoading(false);

            if (data) {
                // 1. Fetch buyer's copy if paid, shipped or completed
                if (['paid', 'shipped', 'completed', 'AwaitingShipment'].includes(data.status)) {
                    const itemData = await getBuyerItemByOrder(id);
                    if (itemData) setBuyerItem(itemData);
                }

                // 2. Detect Active Live Moment: Removed.
                // We rely strictly on snapshots captured at checkout creation.
            }
        } catch (error: any) {
            console.error('Fetch Order Error:', error);
            alert(error.message || 'Order not found');
            router.push('/collection');
        }
    };

    useEffect(() => {
        fetchOrder();
    }, [id, router]);

    // Polling for buyerItem (Stripe Webhook might be slow)
    useEffect(() => {
        if (id && !buyerItem && retryCount < 150 && !loading) {
            const timer = setTimeout(() => {
                console.log(`Polling for buyer item (Attempt ${retryCount + 1}/150)...`);
                setRetryCount(prev => prev + 1);
                fetchOrder();
            }, 2000); // Poll every 2 seconds
            return () => clearTimeout(timer);
        }
    }, [id, buyerItem, retryCount, loading]);

    const handleReceive = async () => {
        if (!confirm('Have you received the item? This will complete the transaction and release funds to the seller.')) return;

        setSubmitting(true);
        try {
            await markAsReceived(id);
            alert('Transaction Completed!');
            window.location.reload();
        } catch (error: any) {
            alert(error.message || 'Failed to update status');
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-white">Loading...</div>;
    if (!order) return null;

    return (
        <div className="min-h-screen bg-brand-dark text-white pt-24 pb-12 px-4">
            <div className="max-w-2xl mx-auto glass-panel-premium rounded-2xl p-8 border border-white/10">
                <h1 className="text-2xl font-bold font-heading mb-6 flex items-center justify-between">
                    <span>Order Status</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider
                        ${order.status === 'completed' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                            order.status === 'shipped' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                                'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'}`}>
                        {order.status.replace('_', ' ')}
                    </span>
                </h1>

                {/* Moment Certificates */}
                {order.moment_snapshot && (
                    <div className="flex flex-col gap-4 mb-8">
                        {(Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot]).map((moment: any, idx: number) => (
                            <div key={moment.id || idx} className="relative overflow-hidden rounded-xl p-[2px] bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 animate-gradient-xy shadow-[0_0_20px_rgba(234,179,8,0.3)]">
                                <div className="bg-black/90 rounded-[10px] p-6 relative overflow-hidden backdrop-blur-xl">
                                    {/* Decorative Background Elements */}
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 blur-[50px] rounded-full pointer-events-none" />
                                    <div className="absolute bottom-0 left-0 w-32 h-32 bg-red-500/10 blur-[50px] rounded-full pointer-events-none" />

                                    <div className="relative z-10 flex flex-col md:flex-row md:items-center gap-4 md:gap-6">
                                        <div className="flex-shrink-0 w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-red-600 flex items-center justify-center text-3xl shadow-lg">
                                            🏆
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-xs font-bold uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">
                                                    Moment Captured / 伝説の瞬間
                                                </span>
                                                <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${moment.is_finalized ? 'bg-green-500' : 'bg-red-500 animate-pulse'} text-white`}>
                                                    {moment.is_finalized ? 'MATCH END' : 'LIVE'}
                                                </span>
                                            </div>
                                            <h3 className="text-xl font-bold text-white mb-1">
                                                {moment.title}
                                            </h3>
                                            <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-brand-platinum/80">
                                                <span className="flex items-center gap-1">
                                                    <span className="text-brand-gold">Player:</span> {moment.player_name}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <span className="text-brand-gold">Time:</span> {new Date(moment.created_at).toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div className="mt-2 text-xs text-center text-brand-platinum/60 italic font-serif">
                            "このカードは、これらの歴史的瞬間の熱狂の中で取引されました。"
                        </div>
                    </div>
                )}

                {/* Item Summary */}
                <div className="flex gap-4 mb-8 bg-white/5 p-4 rounded-xl border border-white/5">
                    {order.listing.images?.[0] && (
                        <div className="w-20 h-28 relative rounded overflow-hidden">
                            <img src={order.listing.images[0]} alt="Item" className="object-cover w-full h-full" />
                        </div>
                    )}
                    <div>
                        <h2 className="font-bold text-lg">{order.listing.player_name}</h2>
                        <p className="text-brand-platinum/60 text-sm">{order.listing.title}</p>
                        <p className="text-brand-gold font-mono mt-1">¥{order.listing.price.toLocaleString()}</p>
                    </div>
                </div>

                {/* Tracking Info */}
                {(order.status === 'shipped' || order.status === 'completed') && (
                    <div className="mb-8 p-6 bg-brand-blue/5 border border-brand-blue/10 rounded-xl">
                        <h3 className="text-brand-blue font-bold mb-4 flex items-center gap-2">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            Shipment Details
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <p className="text-xs text-brand-platinum/60 uppercase">Carrier</p>
                                <p className="font-bold text-lg">{order.carrier || 'Not specified'}</p>
                            </div>
                            <div>
                                <p className="text-xs text-brand-platinum/60 uppercase">Tracking Number</p>
                                <p className="font-mono text-lg tracking-wider">{order.tracking_number || 'No tracking number'}</p>
                            </div>
                        </div>
                        {order.shipped_at && (
                            <p className="text-xs text-brand-platinum/40 mt-4 text-right">Shipped: {new Date(order.shipped_at).toLocaleString()}</p>
                        )}
                    </div>
                )}

                {/* Moment History Logic */}
                {(() => {
                    const displayHistory = [...(buyerItem?.history || order.listing?.moment_history || [])];

                    // 1. Snapshot Injection: Moments captured at time of purchase
                    // These should ALWAYS be visible throughout the order lifecycle.
                    const snapshots = order.moment_snapshot ? (Array.isArray(order.moment_snapshot) ? order.moment_snapshot : [order.moment_snapshot]) : [];
                    snapshots.forEach((sm: any) => {
                        if (!displayHistory.some((m: any) => (m.moment_id === sm.id) || (m.id === sm.id))) {
                            displayHistory.push({
                                ...sm,
                                moment_id: sm.id,
                                status: 'recorded', // Mark as recorded (historical but confirmed)
                                is_snapshot: true
                            });
                        }
                    });

                    // 2. Virtual Moment Injection: Removed as per user request.
                    // Only moments captured in the snapshot (at checkout time) should be displayed.
                    if (displayHistory.length === 0) {
                        if (!buyerItem && retryCount < 10 && ['paid', 'shipped', 'completed'].includes(order.status)) {
                            return (
                                <div className="p-8 rounded-xl bg-white/5 border border-dashed border-white/10 text-center mb-8">
                                    <div className="inline-block animate-spin rounded-full h-4 w-4 border-t-2 border-brand-gold mb-2"></div>
                                    <p className="text-xs text-brand-platinum/30 uppercase tracking-widest">
                                        Preparing your card for memories...
                                    </p>
                                </div>
                            );
                        }
                        return null;
                    }

                    return (
                        <>
                            {/* Memory Tagging CTA */}
                            {['paid', 'shipped', 'completed'].includes(order.status) && (
                                <div className="mb-8 p-6 rounded-2xl bg-gradient-to-br from-brand-gold/20 via-brand-gold/5 to-transparent border border-brand-gold/30 relative overflow-hidden group shadow-xl">
                                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                        <span className="text-6xl text-brand-gold">✍️</span>
                                    </div>
                                    <div className="relative z-10 text-center">
                                        <h3 className="text-lg font-bold text-white mb-2">
                                            <span className="text-brand-gold">Legendary History</span> - あなたの想い出を刻みませんか？
                                        </h3>
                                        <p className="text-sm text-brand-platinum/70 leading-relaxed max-w-lg mx-auto">
                                            下記の「Legendary History」セクションの各瞬間の横にあるボタン <span className="inline-block p-1 bg-white/10 rounded-md"><svg className="w-3 h-3 text-brand-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></span> から、<br />
                                            あなただけのストーリーや想い出をカードに刻むことができます。
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* History Panel */}
                            <div id="history-panel">
                                <MomentHistoryPanel
                                    history={displayHistory}
                                    itemId={buyerItem?.id || undefined}
                                    isOwner={!!(user && order && user.id === order.buyer_id)}
                                    onSuccess={fetchOrder}
                                />
                            </div>
                        </>
                    );
                })()}

                {/* Action Area */}
                {order.status === 'shipped' ? (
                    <div className="mb-8">
                        <div className="p-4 bg-brand-gold/10 border border-brand-gold/20 rounded-lg text-brand-gold mb-4 text-sm">
                            Please confirm receiving the item only after verifying its condition. This action is irreversible.
                        </div>
                        <button
                            onClick={handleReceive}
                            disabled={submitting}
                            className="w-full bg-brand-gold text-brand-dark font-bold py-4 rounded-xl hover:bg-brand-gold/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-brand-gold/20"
                        >
                            {submitting ? 'Processing...' : 'I Received the Item (Complete Transaction)'}
                        </button>
                    </div>
                ) : order.status === 'completed' ? (
                    <div className="mb-8 p-6 bg-green-500/10 border border-green-500/20 rounded-xl text-center">
                        <h3 className="text-green-400 font-bold text-xl mb-2">Transaction Completed</h3>
                        <p className="text-brand-platinum/60 text-sm">Thank you for your purchase.</p>
                    </div>
                ) : order.status === 'processing' || order.status === 'open' || order.status === 'pending' ? (
                    <div className="mb-8 p-6 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-center">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-yellow-500 mb-4"></div>
                        <h3 className="text-yellow-400 font-bold text-xl mb-2">Payment Processing</h3>
                        <p className="text-brand-platinum/60 text-sm">
                            We are confirming your payment. This typically takes a few moments.<br />
                            Once confirmed, you will be able to record your moments.
                        </p>
                        <button onClick={() => window.location.reload()} className="mt-4 text-xs text-yellow-500/80 hover:text-yellow-400 underline">
                            Check Status Again
                        </button>
                    </div>
                ) : (
                    <div className="mb-8 p-6 bg-white/5 border border-white/10 rounded-xl text-center text-brand-platinum/60">
                        Waiting for seller to ship...
                    </div>
                )}

                <button onClick={() => router.back()} className="text-brand-platinum hover:text-white transition-colors text-sm">
                    &larr; Back to Collection
                </button>
            </div>
        </div >
    );
}
</file>

<file path="frontend/app/orders/sell/[id]/page.tsx">
'use client';

import { useEffect, useState, use } from 'react'; // React 19: use() for params
import { useRouter } from 'next/navigation';
import { createClient } from '../../../../utils/supabase/client';
import { markAsShipped, getSellerOrderDetails } from '../../../actions/order';
import { SellerOrderDetail } from '../../../../types/index';



export default function SellerOrderPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const [order, setOrder] = useState<SellerOrderDetail | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);

    // Form State
    const [trackingNumber, setTrackingNumber] = useState('');
    const [carrier, setCarrier] = useState('');

    useEffect(() => {
        const fetchOrder = async () => {
            // No need to check user here, Server Action checks it.
            // But we might need standard auth check for redirect? 
            // Better to let SA throw error.

            try {
                const data = await getSellerOrderDetails(id);
                setOrder(data as SellerOrderDetail);
                setLoading(false);
            } catch (error: any) {
                console.error('Fetch Order Error:', error);
                alert(error.message || 'Order not found');
                router.push('/collection');
            }
        };
        fetchOrder();
    }, [id, router]);

    const handleShip = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!confirm('Mark as shipped? This will notify the buyer.')) return;

        setSubmitting(true);
        try {
            await markAsShipped(id, trackingNumber, carrier);
            alert('Order mark as shipped!');
            // Refresh
            window.location.reload();
        } catch (error: any) {
            alert(error.message || 'Failed to update status');
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-white">Loading...</div>;
    if (!order) return null;

    // Resolve Shipping Address (Snapshot vs Legacy columns)
    const shippingInfo = order.shipping_address_snapshot || {
        name: order.shipping_name || 'Unknown',
        postal_code: order.shipping_postal_code || '',
        address: order.shipping_address || '',
        phone: order.shipping_phone || ''
    };

    return (
        <div className="min-h-screen bg-brand-dark text-white pt-24 pb-12 px-4">
            <div className="max-w-2xl mx-auto glass-panel-premium rounded-2xl p-8 border border-white/10">
                <h1 className="text-2xl font-bold font-heading mb-6 flex items-center justify-between">
                    <span>Manage Order</span>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wider
                        ${order.status === 'completed' ? 'bg-green-500/20 text-green-400 border border-green-500/30' :
                            order.status === 'shipped' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' :
                                order.status === 'awaiting_shipping' ? 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30' :
                                    'bg-gray-500/20 text-gray-400'}`}>
                        {order.status.replace('_', ' ')}
                    </span>
                </h1>

                {/* Item Summary */}
                <div className="flex gap-4 mb-8 bg-white/5 p-4 rounded-xl border border-white/5">
                    {order.listing.images?.[0] && (
                        <div className="w-20 h-28 relative rounded overflow-hidden">
                            <img src={order.listing.images[0]} alt="Item" className="object-cover w-full h-full" />
                        </div>
                    )}
                    <div>
                        <h2 className="font-bold text-lg">{order.listing.player_name}</h2>
                        <p className="text-brand-platinum/60 text-sm">{order.listing.title}</p>
                        <p className="text-brand-gold font-mono mt-1">¥{(order.listing.price || 0).toLocaleString()}</p>
                    </div>
                </div>

                {/* Financial Summary */}
                <div className="mb-8 p-6 rounded-xl bg-white/5 border border-white/10 space-y-4">
                    <h3 className="text-sm font-bold text-brand-platinum/60 uppercase tracking-widest mb-2 font-heading">会計明細 (Financial Summary)</h3>

                    <div className="space-y-3">
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">注文日時 (Ordered At)</span>
                            <span className="text-white font-mono">{new Date(order.created_at).toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">販売価格 (Sale Price)</span>
                            <span className="text-white font-bold">¥{(order.total_amount || 0).toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-brand-platinum/60">販売手数料 (Platform Fee 10%)</span>
                            <span className="text-red-400">-¥{Math.floor((order.total_amount || 0) * 0.1).toLocaleString()}</span>
                        </div>
                        <div className="pt-3 border-t border-white/10 flex justify-between items-center">
                            <span className="text-brand-gold font-bold">振込予定金額 (Seller Net)</span>
                            <span className="text-brand-gold text-xl font-bold font-heading">¥{Math.floor((order.total_amount || 0) * 0.9).toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="mt-4 p-3 bg-brand-blue/10 border border-brand-blue/20 rounded-lg">
                        <p className="text-xs text-brand-blue leading-relaxed">
                            ※ <strong>配送料は出品者（販売者）負担</strong>となります。発送時に配送業者へお支払いください。
                        </p>
                    </div>
                </div>

                {/* Shipping Action Area */}
                {order.status === 'awaiting_shipping' || order.status === 'paid' ? (
                    <div className="mb-8">

                        {/* Privacy Warning Banner */}
                        <div className="bg-red-900/20 border border-red-600/50 rounded-xl p-4 mb-6 flex gap-4 items-start">
                            <div className="text-2xl">⚠️</div>
                            <div>
                                <h4 className="font-bold text-red-500 mb-1 text-sm uppercase tracking-wider">個人情報の取り扱いについて (Strictly Prohibited)</h4>
                                <p className="text-sm text-red-200/80 leading-relaxed">
                                    表示されている購入者の氏名・住所は、<span className="font-bold text-white">商品の発送目的以外での利用を固く禁じます。</span> SNSへの投稿や第三者への共有、取引終了後の利用は法律により罰せられる可能性があります。
                                </p>
                            </div>
                        </div>

                        <div className="bg-brand-blue/10 border border-brand-blue/20 p-6 rounded-xl mb-6">
                            <h3 className="text-brand-blue font-bold mb-4 flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                Shipping Address
                            </h3>
                            <div className="text-sm space-y-1">
                                <p className="font-bold text-lg">{shippingInfo.name}</p>
                                <p>〒{shippingInfo.postal_code}</p>
                                <p>{shippingInfo.address}</p>
                                <p className="text-brand-platinum/60 mt-2">Phone: {shippingInfo.phone}</p>
                            </div>

                        </div>

                        <form onSubmit={handleShip} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-brand-platinum mb-1">Carrier (Optional)</label>
                                <input
                                    type="text"
                                    value={carrier}
                                    onChange={(e) => setCarrier(e.target.value)}
                                    placeholder="e.g. Yamato, Japan Post"
                                    className="w-full bg-brand-dark-light border border-brand-platinum/20 rounded-lg px-4 py-3 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold outline-none transition-all"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-brand-platinum mb-1">Tracking Number (Optional)</label>
                                <input
                                    type="text"
                                    value={trackingNumber}
                                    onChange={(e) => setTrackingNumber(e.target.value)}
                                    placeholder="e.g. 1234-5678-9012"
                                    className="w-full bg-brand-dark-light border border-brand-platinum/20 rounded-lg px-4 py-3 focus:border-brand-gold focus:ring-1 focus:ring-brand-gold outline-none transition-all"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={submitting}
                                className="w-full bg-brand-gold text-brand-dark font-bold py-4 rounded-xl hover:bg-brand-gold/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed mt-4"
                            >
                                {submitting ? 'Processing...' : 'Notify Shipment'}
                            </button>
                        </form>
                    </div>
                ) : (
                    <div className="mb-8 p-6 bg-white/5 rounded-xl border border-white/10 text-center">
                        <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-green-500/20 text-green-400 mb-4">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                        </div>
                        <h3 className="text-xl font-bold mb-2">Item Shipped</h3>
                        {order.shipped_at && <p className="text-sm text-brand-platinum/60 mb-4">Shipped on {new Date(order.shipped_at).toLocaleDateString()}</p>}

                        {(order.carrier || order.tracking_number) && (
                            <div className="text-left bg-black/20 p-4 rounded-lg inline-block w-full text-sm">
                                {order.carrier && <p><span className="text-brand-platinum/60">Carrier:</span> {order.carrier}</p>}
                                {order.tracking_number && <p><span className="text-brand-platinum/60">Tracking:</span> {order.tracking_number}</p>}
                            </div>
                        )}
                    </div>
                )}

                <button onClick={() => router.back()} className="text-brand-platinum hover:text-white transition-colors text-sm">
                    &larr; Back to Collection
                </button>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/payouts/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { createClient } from '../../utils/supabase/client';
import Footer from '../../components/Footer';
import {
    getAvailableBalance,
    registerBankAccount,
    requestPayout,
    getPayoutHistory,
    getBankAccount,
    updateProfileKana,
    getProfileKana
} from '../actions/payout';
import { BankAccount, Payout } from '../../types';

import { useZengin, Bank, Branch } from '../../hooks/useZengin';

export default function PayoutPage() {
    const [loading, setLoading] = useState(true);
    const [userId, setUserId] = useState<string | null>(null);

    // Data State
    const [balanceData, setBalanceData] = useState({ available: 0, totalEarnings: 0, withdrawn: 0 });
    const [bankAccount, setBankAccount] = useState<BankAccount | null>(null);
    const [payoutHistory, setPayoutHistory] = useState<Payout[]>([]);
    const [profileKana, setProfileKana] = useState<string | null>(null);

    // Form State
    const [payoutAmount, setPayoutAmount] = useState<number>(0);
    const [settingBank, setSettingBank] = useState(false); // Modal toggle

    // Zengin Hook
    const { banks, branches, fetchBranches, loadingBanks, loadingBranches } = useZengin();

    // Bank Selection State
    const [selectedBank, setSelectedBank] = useState<Bank | null>(null);
    const [selectedBranch, setSelectedBranch] = useState<Branch | null>(null);
    const [bankSearch, setBankSearch] = useState('');
    const [branchSearch, setBranchSearch] = useState('');
    const [showBankList, setShowBankList] = useState(false);
    const [showBranchList, setShowBranchList] = useState(false);

    // Bank Form
    const [bankForm, setBankForm] = useState({
        bankName: '',
        bankCode: '',
        branchName: '',
        branchCode: '',
        accountType: 'ordinary' as 'ordinary' | 'current',
        accountNumber: '',
        accountHolderName: ''
    });

    const [fieldErrors, setFieldErrors] = useState({
        bankName: false,
        branchName: false,
        accountNumber: false
    });

    const [errorMsg, setErrorMsg] = useState<string | null>(null);
    const [successMsg, setSuccessMsg] = useState<string | null>(null);

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                setUserId(user.id);
                await refreshData(user.id);
            }
            setLoading(false);
        };
        init();
    }, []);

    // Auto-heal legacy data: If we have bank name but no code, try to find it in loaded banks
    useEffect(() => {
        if (bankAccount && !bankAccount.bank_code && banks.length > 0 && !selectedBank) {
            const match = banks.find(b => b.name === bankAccount.bank_name);
            if (match) {
                console.log("Auto-healing bank code for:", match.name);
                // Update local form state (this doesn't save to DB until they click Register)
                setBankForm(prev => ({ ...prev, bankCode: match.code }));
                setSelectedBank(match);
                fetchBranches(match.code);
            }
        }
    }, [bankAccount, banks, selectedBank]);

    const refreshData = async (uid: string) => {
        try {
            const [bal, bank, hist, kana] = await Promise.all([
                getAvailableBalance(uid),
                getBankAccount(uid),
                getPayoutHistory(uid),
                getProfileKana(uid)
            ]);
            setBalanceData(bal);
            setBankAccount(bank);
            setPayoutHistory(hist || []);
            setProfileKana(kana);

            // Pre-fill bank form if exists
            if (bank) {
                setBankForm({
                    bankName: bank.bank_name,
                    bankCode: bank.bank_code || '',
                    branchName: bank.branch_name,
                    branchCode: bank.branch_code || '',
                    accountType: bank.account_type as 'ordinary' | 'current',
                    accountNumber: bank.account_number,
                    accountHolderName: bank.account_holder_name
                });

                // Initialize input search fields
                setBankSearch(bank.bank_name);
                setBranchSearch(bank.branch_name);

                // Set Selected Bank if code exists (for branch enabling)
                if (bank.bank_code) {
                    setSelectedBank({ code: bank.bank_code, name: bank.bank_name, kana: '', hira: '', roma: '' } as Bank);
                    // Fetch branches for this code so user can edit branch immediately if needed
                    fetchBranches(bank.bank_code);
                }
            }
        } catch (err) {
            console.error(err);
        }
    };

    const [isSubmitting, setIsSubmitting] = useState(false);

    const handleRegisterBank = async () => {
        if (!userId || isSubmitting) return;

        // Reset errors
        setFieldErrors({ bankName: false, branchName: false, accountNumber: false });
        setErrorMsg(null);

        const newErrors = {
            bankName: !bankForm.bankName.trim(),
            branchName: !bankForm.branchName.trim(),
            accountNumber: !bankForm.accountNumber.trim() || bankForm.accountNumber.length !== 7
        };

        if (newErrors.bankName || newErrors.branchName || newErrors.accountNumber) {
            setFieldErrors(newErrors);
            if (newErrors.accountNumber && bankForm.accountNumber.length !== 7 && bankForm.accountNumber.trim()) {
                setErrorMsg("Account Number must be exactly 7 digits.");
            } else {
                setErrorMsg("Please fill in all highlighted fields.");
            }
            return;
        }

        setIsSubmitting(true);
        try {
            setErrorMsg(null);
            // 1. Register Bank
            await registerBankAccount(userId, bankForm);

            // 2. Close Modal Immediately for responsiveness
            setSettingBank(false);
            setSuccessMsg("Bank account registered successfully.");

            // 3. Refresh Data in Background
            await refreshData(userId);

        } catch (err: any) {
            setErrorMsg(err.message);
            // If failed, keep modal open to show error
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleRequestPayout = async () => {
        if (!userId) return;

        if (payoutAmount < 1000) {
            setErrorMsg("Minimum payout amount is ¥1,000.");
            return;
        }

        try {
            setErrorMsg(null);
            await requestPayout(userId, payoutAmount);
            await refreshData(userId);
            setPayoutAmount(0);
            setSuccessMsg("Payout requested successfully.");
        } catch (err: any) {
            setErrorMsg(err.message);
        }
    };

    // Filter Banks
    const filteredBanks = banks.filter(b =>
        b.name.includes(bankSearch) ||
        b.code.includes(bankSearch) ||
        b.kana.includes(bankSearch)
    );

    // Filter Branches
    const filteredBranches = branches.filter(b =>
        b.name.includes(branchSearch) ||
        b.code.includes(branchSearch) ||
        b.kana.includes(branchSearch)
    );

    const selectBank = (bank: Bank) => {
        setSelectedBank(bank);
        setBankForm(prev => ({ ...prev, bankName: bank.name, bankCode: bank.code, branchName: '', branchCode: '' }));
        setFieldErrors(prev => ({ ...prev, bankName: false }));
        setBankSearch(bank.name);
        setShowBankList(false);
        fetchBranches(bank.code);
        setBranchSearch('');
        setSelectedBranch(null);
    };

    const selectBranch = (branch: Branch) => {
        setSelectedBranch(branch);
        setBankForm(prev => ({ ...prev, branchName: branch.name, branchCode: branch.code }));
        setFieldErrors(prev => ({ ...prev, branchName: false }));
        setBranchSearch(branch.name);
        setShowBranchList(false);
    };

    if (loading) return <div className="min-h-screen bg-brand-dark flex items-center justify-center text-brand-gold">Loading...</div>;
    if (!userId) return <div className="min-h-screen bg-brand-dark p-10 text-white">Please Log In</div>;

    const displayHolderName = profileKana ? profileKana.replace(/[\s\u3000]+/g, '') : '';

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col pt-32 pb-12">
            <div className="max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 flex-1">

                <h1 className="text-3xl font-heading font-bold text-white mb-8 border-b border-white/10 pb-4">
                    Earnings & Payouts
                </h1>

                {errorMsg && (
                    <div className="mb-6 p-4 bg-red-500/10 border border-red-500/30 text-red-500 rounded-lg">
                        {errorMsg}
                    </div>
                )}
                {successMsg && (
                    <div className="mb-6 p-4 bg-green-500/10 border border-green-500/30 text-green-500 rounded-lg">
                        {successMsg}
                    </div>
                )}

                {/* --- 1. Dashboard: Balance --- */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div className="p-6 rounded-2xl bg-brand-dark-light/50 border border-brand-gold/20 shadow-[0_0_30px_rgba(234,179,8,0.05)]">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">Available Balance</p>
                        <p className="text-4xl text-brand-gold font-heading font-bold">
                            ¥{balanceData.available.toLocaleString()}
                        </p>
                    </div>
                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/5">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">Total Earnings</p>
                        <p className="text-2xl text-white font-heading font-bold">
                            ¥{balanceData.totalEarnings.toLocaleString()}
                        </p>
                    </div>
                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/5">
                        <p className="text-brand-platinum/60 text-sm font-medium uppercase tracking-wider mb-2">Withdrawn/Pending</p>
                        <p className="text-2xl text-white font-heading font-bold">
                            ¥{balanceData.withdrawn.toLocaleString()}
                        </p>
                    </div>
                </div>

                {/* --- 2. Bank Settings & Profile Name --- */}
                <div className="mb-10">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white">Bank Account</h2>
                        {!bankAccount && (
                            <button
                                onClick={() => setSettingBank(true)}
                                className="px-4 py-2 bg-brand-blue/10 text-brand-blue border border-brand-blue/30 rounded-lg hover:bg-brand-blue/20 transition-all font-bold text-sm"
                            >
                                Register Account
                            </button>
                        )}
                        {bankAccount && (
                            <button
                                onClick={() => setSettingBank(true)}
                                className="px-4 py-2 bg-brand-platinum/10 text-brand-platinum border border-brand-platinum/20 rounded-lg hover:bg-brand-platinum/20 transition-all font-bold text-sm"
                            >
                                Edit Account
                            </button>
                        )}
                    </div>

                    <div className="p-6 rounded-2xl bg-brand-dark-light/30 border border-white/10">
                        {bankAccount ? (
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div><span className="text-brand-platinum/50 block">Bank</span> <span className="text-white">{bankAccount.bank_name}</span></div>
                                <div><span className="text-brand-platinum/50 block">Branch</span> <span className="text-white">{bankAccount.branch_name}</span></div>
                                <div><span className="text-brand-platinum/50 block">Type</span> <span className="text-white">{bankAccount.account_type === 'ordinary' ? '普通' : '当座'}</span></div>
                                <div><span className="text-brand-platinum/50 block">Number</span> <span className="text-white">****{bankAccount.account_number.slice(-4)}</span></div>
                                <div className="col-span-2 border-t border-white/5 pt-2 mt-2">
                                    <span className="text-brand-platinum/50 block">Holder Name</span>
                                    <span className="text-brand-gold font-mono">{bankAccount.account_holder_name}</span>
                                </div>
                            </div>
                        ) : (
                            <p className="text-brand-platinum/50 italic">No bank account registered.</p>
                        )}
                    </div>
                </div>

                {/* --- 3. Withdraw Action --- */}
                <div className="mb-10 p-6 rounded-2xl bg-brand-dark-light/30 border border-white/10">
                    <h2 className="text-xl font-bold text-white mb-4">Request Payout</h2>
                    <div className="flex flex-col md:flex-row gap-6 items-start md:items-end">
                        <div className="flex-1 w-full">
                            <label className="block text-brand-platinum/60 text-xs uppercase mb-2">Withdrawal Amount (Net)</label>
                            <input
                                type="number"
                                value={payoutAmount || ''}
                                onChange={(e) => setPayoutAmount(Math.max(0, parseInt(e.target.value) || 0))}
                                className="w-full bg-brand-dark border border-brand-platinum/20 rounded-lg px-4 py-3 text-white focus:border-brand-gold focus:outline-none mb-2"
                                placeholder="Min ¥1,000"
                            />

                            {/* Fee Calculation Display */}
                            <div className="bg-brand-dark p-3 rounded-lg border border-white/5 text-sm space-y-1">
                                <div className="flex justify-between text-brand-platinum/60">
                                    <span>Withdrawal Amount:</span>
                                    <span>¥{payoutAmount.toLocaleString()}</span>
                                </div>
                                <div className="flex justify-between text-brand-platinum/60">
                                    <span>Fee:</span>
                                    {/* Fee Rule: If Input >= 30,000, 0. Else 250. */}
                                    <span className="text-red-400">
                                        {(payoutAmount >= 30000) ? '¥0' : '¥250'}
                                    </span>
                                </div>
                                <div className="border-t border-white/10 my-1"></div>
                                <div className="flex justify-between font-bold text-white">
                                    <span>Total Deduction:</span>
                                    <span className="text-brand-gold">
                                        ¥{(payoutAmount + (payoutAmount >= 30000 ? 0 : 250)).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <p className="text-[10px] text-brand-platinum/50 mt-2">
                                ※ Fee is ¥250. Free for withdrawals ¥30,000 or more.
                            </p>
                        </div>

                        <button
                            onClick={handleRequestPayout}
                            disabled={
                                !bankAccount ||
                                payoutAmount < 1000 ||
                                (payoutAmount + (payoutAmount >= 30000 ? 0 : 250)) > balanceData.available
                            }
                            className="w-full md:w-auto bg-brand-gold text-brand-dark font-bold px-8 py-3 rounded-lg hover:bg-brand-gold-light disabled:opacity-50 disabled:cursor-not-allowed transition-colors h-[50px]"
                        >
                            Request Payout
                        </button>
                    </div>
                    {(!bankAccount) && <p className="text-red-400 text-xs mt-2">Please register a bank account first.</p>}
                    {/* Error if Total > Balance */}
                    {((payoutAmount + (payoutAmount >= 30000 ? 0 : 250)) > balanceData.available) &&
                        <p className="text-red-400 text-xs mt-2">Insufficient balance for Amount + Fee.</p>}
                    {(payoutAmount > 0 && payoutAmount < 1000) && <p className="text-red-400 text-xs mt-2">Minimum withdrawal is ¥1,000.</p>}
                </div>

                {/* --- 4. History --- */}
                <div>
                    <h2 className="text-xl font-bold text-white mb-4">Payout History</h2>
                    <div className="rounded-xl overflow-hidden border border-white/10">
                        <table className="w-full text-left text-sm text-brand-platinum">
                            <thead className="bg-brand-dark-light/50 text-brand-platinum/60 uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-3">Date</th>
                                    <th className="px-6 py-3">Amount</th>
                                    <th className="px-6 py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-white/5">
                                {payoutHistory.length === 0 ? (
                                    <tr><td colSpan={3} className="px-6 py-8 text-center opacity-50">No history found.</td></tr>
                                ) : (
                                    payoutHistory.map(p => (
                                        <tr key={p.id} className="hover:bg-white/5">
                                            <td className="px-6 py-4">{new Date(p.created_at).toLocaleDateString()}</td>
                                            <td className="px-6 py-4 text-white font-mono">¥{p.amount.toLocaleString()}</td>
                                            <td className="px-6 py-4">
                                                <span className={`px-2 py-1 rounded text-xs border ${p.status === 'paid' ? 'border-green-500/30 text-green-400 bg-green-500/10' :
                                                    p.status === 'rejected' ? 'border-red-500/30 text-red-400 bg-red-500/10' :
                                                        'border-yellow-500/30 text-yellow-400 bg-yellow-500/10'
                                                    }`}>
                                                    {p.status.toUpperCase()}
                                                </span>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <Footer />

            {/* --- Modals --- */}
            {settingBank && (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="bg-brand-dark-light border border-white/10 rounded-t-2xl sm:rounded-2xl w-full max-w-md p-6 shadow-2xl h-[90vh] sm:h-auto overflow-y-auto">
                        <h3 className="text-xl font-bold text-white mb-4 border-b border-white/10 pb-2">Bank Account</h3>

                        {!profileKana ? (
                            /* BLOCKER VIEW */
                            <div className="py-8 flex flex-col items-center text-center space-y-4">
                                <div className="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>
                                </div>
                                <h4 className="text-lg font-bold text-white">Profile Name Required</h4>
                                <p className="text-brand-platinum/80 text-sm">
                                    To register a bank account, you must first set your <strong>Real Name (Katakana)</strong> in your profile.<br />
                                    This ensures the name matches your bank account holder name.
                                </p>
                                <a href="/profile" className="mt-4 px-6 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-xl w-full">
                                    Go to Profile Settings
                                </a>
                                <button onClick={() => setSettingBank(false)} className="text-brand-platinum text-sm hover:text-white mt-4">
                                    Close
                                </button>
                            </div>
                        ) : (
                            /* FORM VIEW */
                            <div className="space-y-5">
                                {/* 1. Bank Name Combobox */}
                                <div className="relative">
                                    <label className={`block text-xs mb-1 ${fieldErrors.bankName ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Bank Name <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className={`w-full bg-brand-dark border rounded-lg p-3 text-white focus:outline-none transition-colors ${fieldErrors.bankName ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                        placeholder="Search bank name or code..."
                                        value={bankSearch}
                                        onChange={e => {
                                            const val = e.target.value;
                                            setBankSearch(val);
                                            setShowBankList(true);
                                            setFieldErrors(prev => ({ ...prev, bankName: false }));

                                            // Live match or update text
                                            const match = banks.find(b => b.name === val || b.code === val);
                                            if (match) {
                                                setSelectedBank(match);
                                                setBankForm(prev => ({ ...prev, bankName: match.name, bankCode: match.code, branchName: '', branchCode: '' }));
                                                fetchBranches(match.code);
                                                setBranchSearch('');
                                                setSelectedBranch(null);
                                            } else {
                                                setSelectedBank(null);
                                                setBankForm(prev => ({ ...prev, bankName: val, bankCode: '' }));
                                                // If loose text, we can't fetch branches yet or ensure validity, but we save the text.
                                            }
                                        }}
                                        onFocus={() => setShowBankList(true)}
                                    />
                                    {showBankList && (
                                        <div className="absolute z-50 top-full left-0 w-full max-h-60 overflow-y-auto bg-brand-dark border border-brand-platinum/20 rounded-lg mt-1 shadow-xl">
                                            {loadingBanks ? <div className="p-3 text-xs text-brand-platinum">Loading banks...</div> :
                                                filteredBanks.length === 0 ? <div className="p-3 text-xs text-brand-platinum">No banks found.</div> :
                                                    filteredBanks.map(bank => (
                                                        <button
                                                            key={bank.code}
                                                            className="w-full text-left px-4 py-3 hover:bg-white/5 border-b border-white/5 last:border-0 text-sm text-white"
                                                            onClick={() => selectBank(bank)}
                                                        >
                                                            <span className="text-brand-platinum/60 mr-2 text-xs">{bank.code}</span>
                                                            {bank.name}
                                                        </button>
                                                    ))
                                            }
                                        </div>
                                    )}
                                </div>

                                {/* 2. Branch Name Combobox */}
                                <div className="relative">
                                    <label className={`block text-xs mb-1 ${fieldErrors.branchName ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Branch Name <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className={`w-full bg-brand-dark border rounded-lg p-3 text-white focus:outline-none transition-colors ${!selectedBank ? 'opacity-50 cursor-not-allowed' : ''} ${fieldErrors.branchName ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                        placeholder="Search branch name or code..."
                                        value={branchSearch}
                                        onChange={e => {
                                            const val = e.target.value;
                                            setBranchSearch(val);
                                            setShowBranchList(true);
                                            setFieldErrors(prev => ({ ...prev, branchName: false }));

                                            // Live match branch
                                            if (selectedBank) {
                                                // Need to search in 'branches' if available? 'branches' are loaded for selectedBank.
                                                // Since filteredBranches is derived from branches, we can search branches.
                                                const match = branches.find(b => b.name === val || b.code === val);
                                                if (match) {
                                                    setSelectedBranch(match);
                                                    setBankForm(prev => ({ ...prev, branchName: match.name, branchCode: match.code }));
                                                } else {
                                                    setSelectedBranch(null);
                                                    setBankForm(prev => ({ ...prev, branchName: val, branchCode: '' }));
                                                }
                                            }
                                        }}
                                        onFocus={() => setShowBranchList(true)}
                                        disabled={!selectedBank}
                                    />
                                    {showBranchList && selectedBank && (
                                        <div className="absolute z-50 top-full left-0 w-full max-h-60 overflow-y-auto bg-brand-dark border border-brand-platinum/20 rounded-lg mt-1 shadow-xl">
                                            {loadingBranches ? <div className="p-3 text-xs text-brand-platinum">Loading branches...</div> :
                                                filteredBranches.length === 0 ? <div className="p-3 text-xs text-brand-platinum">No branches found.</div> :
                                                    filteredBranches.map(branch => (
                                                        <button
                                                            key={branch.code}
                                                            className="w-full text-left px-4 py-3 hover:bg-white/5 border-b border-white/5 last:border-0 text-sm text-white"
                                                            onClick={() => selectBranch(branch)}
                                                        >
                                                            <span className="text-brand-platinum/60 mr-2 text-xs">{branch.code}</span>
                                                            {branch.name}
                                                        </button>
                                                    ))
                                            }
                                        </div>
                                    )}
                                </div>

                                {/* 3. Type & Number */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-brand-platinum/60 mb-1">Type</label>
                                        <select className="w-full bg-brand-dark border border-brand-platinum/20 rounded-lg p-3 text-white outline-none"
                                            value={bankForm.accountType} onChange={e => setBankForm(prev => ({ ...prev, accountType: e.target.value as any }))}>
                                            <option value="ordinary">普通 (Ordinary)</option>
                                            <option value="current">当座 (Current)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className={`block text-xs mb-1 ${fieldErrors.accountNumber ? 'text-red-400 font-bold' : 'text-brand-platinum/60'}`}>Number (7 digits) <span className="text-red-400">*</span></label>
                                        <input type="text"
                                            className={`w-full bg-brand-dark border rounded-lg p-3 text-white outline-none font-mono transition-colors ${fieldErrors.accountNumber ? 'border-red-500/50 focus:border-red-500' : 'border-brand-platinum/20 focus:border-brand-blue'}`}
                                            placeholder="1234567"
                                            maxLength={7}
                                            value={bankForm.accountNumber}
                                            onChange={e => {
                                                const val = e.target.value.replace(/[^0-9]/g, '');
                                                setBankForm(prev => ({ ...prev, accountNumber: val }));
                                                setFieldErrors(prev => ({ ...prev, accountNumber: false }));
                                            }} />
                                    </div>
                                </div>

                                {/* 4. Holder Name (Read Only with Sync) */}
                                <div>
                                    <label className="block text-xs text-brand-platinum/60 mb-1">Account Holder Name (Auto-Synced) <span className="text-red-400">*</span></label>
                                    <input
                                        type="text"
                                        className="w-full bg-brand-dark/50 border border-brand-platinum/10 rounded-lg p-3 text-brand-platinum font-mono cursor-not-allowed"
                                        value={displayHolderName}
                                        readOnly
                                        title="Synced with Profile"
                                    />
                                    <div className="mt-2 p-2 bg-blue-500/10 border border-blue-500/20 rounded text-[10px] text-blue-300 flex items-start gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mt-[1px] flex-shrink-0"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="16" y2="12" /><line x1="12" x2="12.01" y1="8" y2="8" /></svg>
                                        <span>
                                            Name is synced from your profile.<br />
                                            To change it, please update your <a href="/profile" className="underline hover:text-white font-bold">Profile Settings</a>.
                                        </span>
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-4">
                                    <button onClick={() => setSettingBank(false)} className="flex-1 py-3 border border-white/10 text-brand-platinum rounded-xl hover:bg-white/5 transition-all text-sm font-bold">Cancel</button>
                                    <button onClick={handleRegisterBank} disabled={isSubmitting} className="flex-1 py-3 bg-brand-gold text-brand-dark font-bold rounded-xl hover:bg-brand-gold-light transition-all text-sm shadow-lg shadow-brand-gold/10 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {isSubmitting ? 'Processing...' : 'Register Bank'}
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/app/profile/[userId]/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { createClient } from '@/utils/supabase/client';
import { useParams, useSearchParams } from 'next/navigation';
import ShowcaseCard from '@/components/ShowcaseCard';
import SkeletonCard from '@/components/SkeletonCard';
import Image from 'next/image';
import Footer from '../../../components/Footer';

function ProfilePageContent() {
    const params = useParams();
    const searchParams = useSearchParams();
    const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

    const userId = params.userId as string;
    const [profile, setProfile] = useState<any>(null);
    const [activeTab, setActiveTab] = useState<'showcase' | 'selling'>('showcase');
    const [displayItems, setDisplayItems] = useState<any[]>([]);
    const [activeItems, setActiveItems] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            if (!userId) return;
            setLoading(true);
            const supabase = createClient();

            try {
                // Fetch Profile
                const { data: profileData, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (profileError) throw profileError;
                setProfile(profileData);

                // Fetch Public Items (Display & Active)
                const { data: itemsData, error: itemsError } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('seller_id', userId)
                    .in('status', ['Display', 'Active']);

                if (itemsError) throw itemsError;

                // Split items by status
                const display = itemsData?.filter(item => item.status === 'Display') || [];
                const active = itemsData?.filter(item => item.status === 'Active') || [];

                setDisplayItems(display);
                setActiveItems(active);

            } catch (error) {
                console.error('Failed to fetch profile data:', error);
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [userId]);

    const handleShare = () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('Profile URL copied to clipboard!');
        });
    };

    if (loading) {
        return (
            <div className="min-h-screen pt-32 pb-12 px-4 sm:px-6 lg:px-8 bg-brand-dark relative overflow-hidden">
                <div className="max-w-6xl mx-auto relative z-10">
                    {/* Header Skeleton */}
                    <div className="flex flex-col md:flex-row items-center md:items-end gap-8 mb-12 p-8 rounded-2xl bg-white/5 border border-white/10 animate-pulse">
                        <div className="w-32 h-32 rounded-full bg-brand-platinum/10"></div>
                        <div className="flex-1 w-full space-y-4">
                            <div className="h-8 bg-brand-platinum/10 rounded w-1/2 mx-auto md:mx-0"></div>
                            <div className="h-4 bg-brand-platinum/10 rounded w-1/3 mx-auto md:mx-0"></div>
                        </div>
                    </div>
                    {/* Grid Skeleton */}
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                        {[...Array(5)].map((_, i) => (
                            <SkeletonCard key={i} />
                        ))}
                    </div>
                </div>
            </div>
        );
    }

    if (!profile) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-brand-dark text-white">
                User not found.
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute top-0 left-0 w-full h-[400px] bg-gradient-to-b from-brand-blue/10 to-transparent pointer-events-none"></div>
            <div className="absolute -top-20 -right-20 w-96 h-96 bg-brand-gold/5 rounded-full blur-3xl pointer-events-none"></div>

            <div className="flex-1 w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-12 relative z-10">
                {/* Profile Header */}
                <div className="flex flex-col md:flex-row items-center md:items-end gap-8 mb-12 p-8 rounded-2xl bg-white/5 border border-white/10 shadow-2xl backdrop-blur-md relative overflow-hidden group">
                    {/* Header Background Glow */}
                    <div className="absolute inset-0 bg-gradient-to-r from-brand-blue/10 via-transparent to-brand-gold/5 opacity-50 group-hover:opacity-100 transition-opacity duration-700"></div>

                    {/* Avatar */}
                    <div className="relative">
                        <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-brand-gold/50 shadow-[0_0_20px_rgba(234,179,8,0.3)] relative z-10 bg-brand-dark">
                            {profile.avatar_url ? (
                                <Image
                                    src={profile.avatar_url}
                                    alt={profile.name}
                                    fill
                                    sizes="128px"
                                    className="object-cover"
                                />
                            ) : (
                                <div className="w-full h-full bg-brand-platinum/10 flex items-center justify-center text-brand-platinum/40">
                                    <svg className="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                </div>
                            )}
                        </div>
                        {/* Avatar Glow */}
                        <div className="absolute inset-0 rounded-full bg-brand-gold/20 blur-xl -z-10 scale-110"></div>
                    </div>

                    {/* User Info */}
                    <div className="flex-1 text-center md:text-left z-10">
                        <h1 className="text-4xl md:text-5xl font-heading font-bold text-white mb-2 tracking-tight drop-shadow-lg">
                            {profile.name || 'Anonymous User'}
                        </h1>
                        <div className="flex items-center justify-center md:justify-start gap-4 text-brand-platinum/80 text-sm font-mono">
                            <span className="flex items-center gap-1">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                Member since {new Date(profile.created_at).getFullYear()}
                            </span>
                            <span className="w-1 h-1 rounded-full bg-brand-platinum/40"></span>
                            <span className="flex items-center gap-1 text-brand-gold">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                {displayItems.length} Items Displayed
                            </span>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="z-10">
                        <button
                            onClick={handleShare}
                            className="px-6 py-2.5 bg-white/10 hover:bg-white/20 text-white border border-white/20 rounded-full transition-all font-bold text-sm flex items-center gap-2 backdrop-blur-sm group/btn"
                        >
                            <svg className="w-5 h-5 group-hover/btn:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                            Share Profile
                        </button>
                    </div>
                </div>

                {/* Tabs & Content */}
                <div className="glass-panel-premium shadow-2xl overflow-hidden rounded-2xl border border-white/10">
                    <div className="border-b border-brand-platinum/10">
                        <nav className="-mb-px flex" aria-label="Tabs">
                            <button
                                onClick={() => setActiveTab('showcase')}
                                className={`${activeTab === 'showcase'
                                    ? 'border-brand-blue text-brand-blue-glow bg-brand-blue/5'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30 hover:bg-white/5'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                Showcase ({displayItems.length})
                            </button>
                            <button
                                onClick={() => setActiveTab('selling')}
                                className={`${activeTab === 'selling'
                                    ? 'border-brand-blue text-brand-blue-glow bg-brand-blue/5'
                                    : 'border-transparent text-brand-platinum/60 hover:text-brand-platinum hover:border-brand-platinum/30 hover:bg-white/5'
                                    } flex-1 py-4 px-1 text-center border-b-2 font-medium text-sm transition-all`}
                            >
                                For Sale ({activeItems.length})
                            </button>
                        </nav>
                    </div>

                    <div className="p-6 min-h-[400px]">
                        {activeTab === 'showcase' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {displayItems.map((item, idx) => (
                                    <ShowcaseCard
                                        key={idx}
                                        item={item}
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                    // No action props passed, so buttons will be hidden
                                    />
                                ))}
                                {displayItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-20 text-brand-platinum/50 border-2 border-dashed border-brand-platinum/10 rounded-xl">
                                        <svg className="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                                        <p className="font-bold text-lg">No items in Showcase</p>
                                        <p className="text-sm mt-1 opacity-70">This user hasn't displayed any items yet.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'selling' && (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-6">
                                {activeItems.map((item, idx) => (
                                    <ShowcaseCard
                                        key={idx}
                                        item={item}
                                        is_live_moment={item.is_live_moment || isDebugLive}
                                    // No action props passed, so buttons will be hidden
                                    />
                                ))}
                                {activeItems.length === 0 && (
                                    <div className="col-span-full flex flex-col items-center justify-center py-20 text-brand-platinum/50 border-2 border-dashed border-brand-platinum/10 rounded-xl">
                                        <svg className="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                        <p className="font-bold text-lg">No items for sale</p>
                                        <p className="text-sm mt-1 opacity-70">This user has no active listings.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}

export default function ProfilePage() {
    return (
        <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
            <ProfilePageContent />
        </Suspense>
    );
}
</file>

<file path="frontend/app/profile/page.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { getAvailableBalance } from '../../app/actions/payout';
import OrderHistory from '../../components/OrderHistory';
// import { createClient } from '@/utils/supabase/client';

export default function ProfilePage() {
    const [user, setUser] = useState<any>(null);
    const [profile, setProfile] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    const router = useRouter();

    const [activeTab, setActiveTab] = useState<'purchases' | 'sales'>('purchases');
    const [isEditing, setIsEditing] = useState(false);
    const [editDisplayName, setEditDisplayName] = useState('');
    const [editFirstName, setEditFirstName] = useState('');
    const [editLastName, setEditLastName] = useState('');
    const [editEmail, setEditEmail] = useState('');
    const [editPostalCode, setEditPostalCode] = useState('');
    const [editAddressLine1, setEditAddressLine1] = useState('');
    const [editAddressLine2, setEditAddressLine2] = useState('');
    const [editPhoneNumber, setEditPhoneNumber] = useState('');
    const [editRealNameKana, setEditRealNameKana] = useState('');
    const [balance, setBalance] = useState<number | null>(null);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        const fetchUserAndProfile = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                router.push('/login');
                return;
            }

            setUser(user);
            setEditEmail(user.email || '');

            // Fetch profile
            const { data: profileData } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (profileData) {
                setProfile(profileData);
                setEditDisplayName(profileData.display_name || profileData.name || user.user_metadata?.name || '');
                setEditFirstName(profileData.first_name || '');
                setEditLastName(profileData.last_name || '');
                setEditPostalCode(profileData.postal_code || '');
                setEditAddressLine1(profileData.address_line1 || '');
                setEditAddressLine2(profileData.address_line2 || '');
                setEditPhoneNumber(profileData.phone_number || '');
                setEditRealNameKana(profileData.real_name_kana || '');
            } else {
                setEditDisplayName(user.user_metadata?.name || '');
            }

            // Fetch Balance
            try {
                const balanceData = await getAvailableBalance(user.id);
                setBalance(balanceData.available);
            } catch (e) {
                console.error("Failed to load balance", e);
                setBalance(0);
            }

            setLoading(false);
        };

        fetchUserAndProfile();
    }, [router]);

    const handleSave = async () => {
        if (!user?.id) return;
        setSaving(true);
        try {
            const supabase = createClient();

            // Sanitize: Remove all spaces (half/full width) from Kana
            const sanitizedKana = editRealNameKana.replace(/[\s\u3000]+/g, '');

            // Validate: Must be Full-width Katakana if provided
            if (sanitizedKana && !/^[\u30A0-\u30FF]+$/.test(sanitizedKana)) {
                alert('Real Name (Kana) must be in full-width Katakana only (no Kanji, Hiragana, or Latin letters).');
                setSaving(false);
                return;
            }

            // Update Profile Table
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: user.id,
                    display_name: editDisplayName,
                    first_name: editFirstName,
                    last_name: editLastName,
                    // name: editDisplayName, // Optional: duplicate to name for compat
                    email: user.email,
                    postal_code: editPostalCode,
                    address_line1: editAddressLine1,
                    address_line2: editAddressLine2,
                    phone_number: editPhoneNumber,
                    real_name_kana: sanitizedKana,
                    updated_at: new Date().toISOString(),
                });

            if (profileError) throw profileError;

            // Update Auth Metadata (optional, but good for consistency)
            /* const { error: authError } = await supabase.auth.updateUser({
                data: { name: editDisplayName },
            }); */

            // if (authError) throw authError;

            setProfile({
                ...profile,
                display_name: editDisplayName,
                first_name: editFirstName,
                last_name: editLastName,
                postal_code: editPostalCode,
                address_line1: editAddressLine1,
                address_line2: editAddressLine2,
                phone_number: editPhoneNumber,
                real_name_kana: sanitizedKana
            });
            setIsEditing(false);
            setEditRealNameKana(sanitizedKana); // Update state to sanitized version
            alert('Profile updated successfully!');

        } catch (error) {
            console.error(error);
            alert('Failed to update profile.');
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-brand-dark flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div>
            </div>
        );
    }

    if (!user) {
        return null;
    }

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 container mx-auto px-4 py-24 sm:px-6 lg:px-8">
                <div className="max-w-3xl mx-auto space-y-8">
                    {/* Header Section */}
                    <div className="text-center space-y-4">
                        <h1 className="text-4xl font-heading font-bold text-white tracking-tight">
                            My Profile
                        </h1>
                        <p className="text-brand-platinum/60">
                            Manage your account settings and view your activity.
                        </p>
                    </div>

                    {/* Profile Card */}
                    <div className="glass-panel p-8 rounded-3xl shadow-2xl border border-brand-platinum/10 relative overflow-hidden group">
                        {/* Background Decoration */}
                        <div className="absolute top-0 right-0 w-64 h-64 bg-brand-blue/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none group-hover:bg-brand-blue/20 transition-all duration-700"></div>

                        <div className="relative z-10 flex flex-col md:flex-row items-start gap-8">
                            {/* Avatar */}
                            <div className="relative flex-shrink-0 mx-auto md:mx-0">
                                <div className="w-32 h-32 rounded-full bg-gradient-to-br from-brand-blue to-brand-blue-glow p-[2px] shadow-lg shadow-brand-blue/20">
                                    <div className="w-full h-full rounded-full bg-brand-dark-light overflow-hidden">
                                        <img
                                            src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user?.email || 'Guest'}`}
                                            alt="Profile"
                                            className="w-full h-full object-cover"
                                        />
                                    </div>
                                </div>
                                <div className="absolute bottom-0 right-0 w-8 h-8 bg-green-500 rounded-full border-4 border-brand-dark-light flex items-center justify-center" title="Active">
                                    <div className="w-full h-full rounded-full animate-pulse bg-green-400/50"></div>
                                </div>
                            </div>

                            {/* Info */}
                            <div className="flex-1 text-center md:text-left space-y-4 w-full">
                                {isEditing ? (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-1 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Nickname (Display Name)</label>
                                                <input
                                                    type="text"
                                                    value={editDisplayName}
                                                    onChange={(e) => setEditDisplayName(e.target.value)}
                                                    placeholder="e.g. CardMaster2024"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Last Name (姓)</label>
                                                    <input
                                                        type="text"
                                                        value={editLastName}
                                                        onChange={(e) => setEditLastName(e.target.value)}
                                                        placeholder="山田"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">First Name (名)</label>
                                                    <input
                                                        type="text"
                                                        value={editFirstName}
                                                        onChange={(e) => setEditFirstName(e.target.value)}
                                                        placeholder="太郎"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                            </div>

                                            {/* Real Name Kana Input */}
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Real Name (カタカナ) <span className="text-red-400 text-xs">*Required for Payouts</span></label>
                                                <input
                                                    type="text"
                                                    value={editRealNameKana}
                                                    onChange={(e) => setEditRealNameKana(e.target.value)}
                                                    placeholder="ヤマダタロウ"
                                                    pattern="^[\u30A0-\u30FF]+$"
                                                    title="Full-width Katakana only"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                                <p className="text-[10px] text-brand-platinum/50 mt-1">※ 銀行口座名義と一致させてください (姓と名の間のスペースなし)</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Email</label>
                                                <input
                                                    type="email"
                                                    value={editEmail}
                                                    onChange={(e) => setEditEmail(e.target.value)}
                                                    disabled
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white/50 cursor-not-allowed focus:outline-none"
                                                />
                                            </div>
                                        </div>

                                        <div className="border-t border-brand-platinum/10 pt-4 mt-4">
                                            <h3 className="text-white font-bold mb-3">Shipping Address (配送先住所)</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Postal Code (郵便番号)</label>
                                                    <input
                                                        type="text"
                                                        value={editPostalCode}
                                                        onChange={(e) => setEditPostalCode(e.target.value)}
                                                        placeholder="123-4567"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Phone Number (電話番号)</label>
                                                    <input
                                                        type="tel"
                                                        value={editPhoneNumber}
                                                        onChange={(e) => setEditPhoneNumber(e.target.value)}
                                                        placeholder="090-1234-5678"
                                                        className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                    />
                                                </div>
                                            </div>
                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Address Line 1 (都道府県・市区町村)</label>
                                                <input
                                                    type="text"
                                                    value={editAddressLine1}
                                                    onChange={(e) => setEditAddressLine1(e.target.value)}
                                                    placeholder="Tokyo, Minato-ku"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-brand-platinum/60 mb-1">Address Line 2 (番地・建物名)</label>
                                                <input
                                                    type="text"
                                                    value={editAddressLine2}
                                                    onChange={(e) => setEditAddressLine2(e.target.value)}
                                                    placeholder="Roppongi 1-2-3, Hills Tower 4F"
                                                    className="w-full bg-brand-dark-light/50 border border-brand-platinum/20 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-brand-blue"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div>
                                        <h2 className="text-2xl font-bold text-white mb-1">
                                            {profile?.display_name || editDisplayName || 'No Nickname'}
                                        </h2>
                                        <p className="text-brand-platinum/60 font-mono text-sm mb-4">
                                            @{profile?.email?.split('@')[0] || 'username'}
                                        </p>

                                        {(profile?.address_line1 || profile?.postal_code || profile?.real_name_kana) && (
                                            <div className="bg-brand-dark-light/30 p-4 rounded-xl border border-brand-platinum/10 text-left">
                                                <h3 className="text-xs font-bold text-brand-platinum uppercase tracking-wider mb-2">Shipping Information</h3>
                                                <p className="text-white text-sm font-bold mb-1">
                                                    {profile.last_name} {profile.first_name}
                                                    {profile.real_name_kana && <span className="text-xs font-normal text-brand-platinum/60 ml-2">({profile.real_name_kana})</span>}
                                                </p>
                                                <p className="text-brand-platinum/80 text-sm">
                                                    〒{profile.postal_code}<br />
                                                    {profile.address_line1}<br />
                                                    {profile.address_line2}<br />
                                                    {profile.phone_number && <span className="text-brand-platinum/60 mt-1 block">{profile.phone_number}</span>}
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {!isEditing && (
                                    <div className="flex flex-wrap justify-center md:justify-start gap-3">
                                        <span className="px-3 py-1 rounded-full bg-brand-blue/10 text-brand-blue text-xs font-bold border border-brand-blue/20">
                                            MEMBER
                                        </span>
                                        <span className="px-3 py-1 rounded-full bg-brand-gold/10 text-brand-gold text-xs font-bold border border-brand-gold/20">
                                            EARLY ADOPTER
                                        </span>
                                    </div>
                                )}
                            </div>

                            {/* Actions */}
                            <div className="flex flex-col gap-3 w-full md:w-auto">
                                {isEditing ? (
                                    <>
                                        <button
                                            onClick={handleSave}
                                            disabled={saving}
                                            className="px-6 py-2 rounded-xl bg-brand-blue hover:bg-brand-blue-glow text-white font-bold text-sm shadow-lg shadow-brand-blue/20 transition-all text-center disabled:opacity-50"
                                        >
                                            {saving ? 'Saving...' : 'Save Changes'}
                                        </button>
                                        <button
                                            onClick={() => setIsEditing(false)}
                                            disabled={saving}
                                            className="px-6 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm border border-white/10 transition-all"
                                        >
                                            Cancel
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button
                                            onClick={() => setIsEditing(true)}
                                            className="px-6 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold text-sm border border-white/10 transition-all"
                                        >
                                            Edit Profile
                                        </button>
                                        <Link href="/collection" className="px-6 py-2 rounded-xl bg-brand-blue hover:bg-brand-blue-glow text-white font-bold text-sm shadow-lg shadow-brand-blue/20 transition-all text-center">
                                            My Collection
                                        </Link>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Wallet Card */}
                    <div className="bg-gradient-to-r from-gray-900 to-black border border-yellow-600/50 rounded-3xl p-8 shadow-2xl relative overflow-hidden group">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-yellow-600/10 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none group-hover:bg-yellow-600/20 transition-all duration-700"></div>

                        <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                            <div>
                                <h3 className="text-yellow-600/80 text-sm font-bold tracking-widest uppercase mb-1">Current Balance / 売上金残高</h3>
                                <div className="text-4xl md:text-5xl font-heading font-bold text-white tracking-tight flex items-baseline gap-2">
                                    <span className="text-2xl text-white/50">¥</span>
                                    {balance !== null ? balance.toLocaleString() : '---'}
                                </div>
                            </div>

                            <Link
                                href="/payouts"
                                className="px-8 py-3 rounded-full bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-black font-bold shadow-lg shadow-yellow-600/20 transition-all transform hover:scale-105"
                            >
                                Withdraw / 出金申請
                            </Link>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {[
                            { label: 'Total Listings', value: '0', icon: '📋' },
                            { label: 'Sales', value: '¥0', icon: '💰' },
                            { label: 'Purchases', value: '0', icon: '🛍️' },
                        ].map((stat, i) => (
                            <div key={i} className="glass-panel p-6 rounded-2xl border border-brand-platinum/5 hover:border-brand-platinum/20 transition-all group">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-brand-platinum/60 text-sm font-bold">{stat.label}</span>
                                    <span className="text-xl group-hover:scale-110 transition-transform">{stat.icon}</span>
                                </div>
                                <div className="text-2xl font-heading font-bold text-white group-hover:text-brand-blue-glow transition-colors">
                                    {stat.value}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Transaction History */}
                    <div className="space-y-6 pt-8 border-t border-brand-platinum/10">
                        <div className="flex items-center gap-8 border-b border-brand-platinum/10">
                            <button
                                onClick={() => setActiveTab('purchases')}
                                className={`pb-3 text-sm font-bold tracking-wider transition-all border-b-2 ${activeTab === 'purchases' ? 'text-white border-brand-blue' : 'text-brand-platinum/40 border-transparent hover:text-brand-platinum'}`}
                            >
                                Purchases (購入履歴)
                            </button>
                            <button
                                onClick={() => setActiveTab('sales')}
                                className={`pb-3 text-sm font-bold tracking-wider transition-all border-b-2 ${activeTab === 'sales' ? 'text-white border-brand-gold' : 'text-brand-platinum/40 border-transparent hover:text-brand-platinum'}`}
                            >
                                Sales (販売履歴)
                            </button>
                        </div>

                        <div className="min-h-[200px]">
                            <OrderHistory mode={activeTab === 'purchases' ? 'buy' : 'sell'} />
                        </div>
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/register/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Link from 'next/link';
import Footer from '../../components/Footer';
import { sendWelcomeEmail } from '../actions/send-email';

export default function RegisterPage() {
    const router = useRouter();
    const [name, setName] = useState('');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState<string | null>(null);
    const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            const supabase = createClient();
            const { error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        name: name,
                    },
                },
            });

            if (error) {
                throw error;
            }

            // Send Welcome Email
            await sendWelcomeEmail(email, name);

            // Redirect to login page after successful registration
            router.push('/login?registered=true');
        } catch (err) {
            setError(err instanceof Error ? err.message : 'An error occurred');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <div className="flex-1 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div className="max-w-md w-full space-y-8">
                    <div className="text-center">
                        <Link href="/" className="inline-block mb-6 group">
                            <span className="font-heading text-4xl font-bold tracking-tighter text-white group-hover:text-glow transition-all">
                                TC<span className="text-brand-blue">.APP</span>
                            </span>
                        </Link>
                        <h2 className="text-3xl font-heading font-bold text-white">
                            Create your account
                        </h2>
                        <p className="mt-2 text-brand-platinum/60">
                            Join the premium marketplace for collectors.
                        </p>
                    </div>

                    <div className="glass-panel p-8 rounded-2xl shadow-2xl border border-brand-platinum/10">
                        <form className="space-y-6" onSubmit={handleSubmit}>
                            {error && (
                                <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl text-sm">
                                    {error}
                                </div>
                            )}

                            <div>
                                <label htmlFor="name" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Nickname
                                </label>
                                <input
                                    id="name"
                                    name="name"
                                    type="text"
                                    required
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="CardMaster2024"
                                />
                            </div>

                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Email address
                                </label>
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    autoComplete="email"
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="name@example.com"
                                />
                            </div>

                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-brand-platinum mb-2">
                                    Password
                                </label>
                                <input
                                    id="password"
                                    name="password"
                                    type="password"
                                    autoComplete="new-password"
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                                    placeholder="••••••••"
                                />
                            </div>

                            <div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-sm font-bold text-white bg-brand-blue hover:bg-brand-blue-glow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${loading ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {loading ? 'Creating account...' : 'Sign up'}
                                </button>
                            </div>
                        </form>

                        <div className="mt-6 text-center">
                            <p className="text-sm text-brand-platinum/60">
                                Already have an account?{' '}
                                <Link href="/login" className="font-medium text-brand-blue hover:text-brand-blue-glow transition-colors">
                                    Sign in
                                </Link>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/sell/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { createClient } from '../../utils/supabase/client';
import Footer from '../../components/Footer';
import PremiumCardImage from '../../components/PremiumCardImage';
import MarketPriceLinks from '../../components/MarketPriceLinks';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

// --- Data Constants ---
const MLB_TEAMS = [
    "アリゾナ・ダイヤモンドバックス", "アトランタ・ブレーブス", "ボルチモア・オリオールズ", "ボストン・レッドソックス", "シカゴ・カブス",
    "シカゴ・ホワイトソックス", "シンシナティ・レッズ", "クリーブランド・ガーディアンズ", "コロラド・ロッキーズ", "デトロイト・タイガース",
    "ヒューストン・アストロズ", "カンザスシティ・ロイヤルズ", "ロサンゼルス・エンゼルス", "ロサンゼルス・ドジャース", "マイアミ・マーリンズ",
    "ミルウォーキー・ブルワーズ", "ミネソタ・ツインズ", "ニューヨーク・メッツ", "ニューヨーク・ヤンキース", "オークランド・アスレチックス",
    "フィラデルフィア・フィリーズ", "ピッツバーグ・パイレーツ", "サンディエゴ・パドレス", "サンフランシスコ・ジャイアンツ", "シアトル・マリナーズ",
    "セントルイス・カージナルス", "タンパベイ・レイズ", "テキサス・レンジャーズ", "トロント・ブルージェイズ", "ワシントン・ナショナルズ"
];

const NPB_TEAMS = [
    "読売ジャイアンツ", "阪神タイガース", "中日ドラゴンズ", "横浜DeNAベイスターズ", "広島東洋カープ", "東京ヤクルトスワローズ",
    "福岡ソフトバンクホークス", "千葉ロッテマリーンズ", "埼玉西武ライオンズ", "東北楽天ゴールデンイーグルス", "北海道日本ハムファイターズ", "オリックス・バファローズ", "日本代表", "その他"
];

const CARD_BRANDS = [
    "Topps", "Panini", "Upper Deck", "BBM", "EPOCH", "Leaf", "Bowman", "Fleer", "Donruss", "Score", "Select", "Prizm", "Chrome", "Finest", "Other", "Unknown"
];

// Generate Year Options (1950 - Current+1)
const CURRENT_YEAR = new Date().getFullYear();
const YEARS = Array.from({ length: CURRENT_YEAR - 1949 }, (_, i) => (CURRENT_YEAR + 1 - i).toString());

// --- Zod Schema Definition ---
const listingSchema = z.object({
    // --- Section 1: Basic Info (AI-Assisted) ---
    playerName: z.string().min(1, "選手名は必須です"),
    team: z.string().min(1, "球団名は必須です"),
    // Year can be "Unknown" (empty string in UI logic?) or a year string.
    // If user selects "Unknown", value might be empty.
    year: z.string().optional(),
    brand: z.string().min(1, "ブランドは必須です"),

    // --- Section 2: Features & Rarity ---
    variation: z.string().optional(),
    serialNumber: z.string().optional(),
    isRookie: z.boolean().default(false),
    isAutograph: z.boolean().default(false),

    // --- Section 3: Condition & Grading ---
    isGraded: z.boolean().default(false),
    gradingCompany: z.string().optional(),
    grade: z.string().optional(),
    certificationNumber: z.string().optional(),
    condition: z.string().optional(),

    // --- Section 4: Other ---
    price: z.number().min(1, "価格は必須です"),
    description: z.string().optional(),
    images: z.array(z.string()).min(1, "画像は少なくとも1枚必要です"),
}).superRefine((data, ctx) => {
    if (!data.isGraded && !data.condition) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "コンディションを選択してください",
            path: ["condition"],
        });
    }
});

type ListingFormData = z.infer<typeof listingSchema>;

function SellContent() {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const [user, setUser] = useState<any>(null);
    const router = useRouter();

    const searchParams = useSearchParams();
    const source = searchParams.get('source');
    const sourceId = searchParams.get('id');
    const sourceType = searchParams.get('type');

    // UI State
    const [uploading, setUploading] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    const [submitting, setSubmitting] = useState(false);
    const [formError, setFormError] = useState<string | null>(null);
    const [aiFeedback, setAiFeedback] = useState<string | null>(null);
    const [isDragging, setIsDragging] = useState(false);
    const [isEditing, setIsEditing] = useState(false);
    const [hasAnalyzed, setHasAnalyzed] = useState(false); // New state to track analysis

    // Country logic (Default JP)
    const [country, setCountry] = useState<'USA' | 'JP'>('JP');

    // Image Selection for AI
    const [selectedImageIndices, setSelectedImageIndices] = useState<number[]>([0]);

    // Drag State
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null);

    // AI Suggestions Data
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const [suggestedData, setSuggestedData] = useState<any>(null);



    // React Hook Form
    const {
        register,
        handleSubmit,
        setValue,
        getValues,
        watch,
        formState: { errors },
        reset
    } = useForm<ListingFormData>({
        // @ts-expect-error - Resolver type mismatch due to optional default values vs required schema
        resolver: zodResolver(listingSchema),
        defaultValues: {
            playerName: '',
            team: '',
            year: '',
            brand: '', // Default to Unknown (empty string matches "Select Brand..." disabled option)
            variation: '',
            serialNumber: '',
            isRookie: false,
            isAutograph: false,
            isGraded: false,
            gradingCompany: 'PSA',
            grade: '10',
            certificationNumber: '',

            condition: '', // Default to empty to force selection
            price: 0,
            description: '',
            images: [],
        }
    });

    const images = watch('images');
    const isGraded = watch('isGraded');

    useEffect(() => {
        const init = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            if (source === 'collection' && sourceId && user) {
                try {
                    const { data: listingData } = await supabase.from('listing_items').select('*').eq('id', sourceId).single();
                    if (listingData) {
                        // Resell Logic: If I am not the seller, treat as New Listing (Clone data, but INSERT new)
                        // If I AM the seller, treat as Edit (UPDATE existing)
                        setIsEditing(listingData.seller_id === user.id);
                        setHasAnalyzed(true); // Editing implies analysis/data exists
                        reset({
                            playerName: listingData.player_name || '',
                            team: listingData.team || '',
                            year: listingData.year?.toString() || '',
                            brand: listingData.manufacturer || 'Unknown',
                            variation: listingData.variation || '',
                            serialNumber: listingData.serial_number || '',
                            isRookie: listingData.is_rookie || false,
                            isAutograph: listingData.is_autograph || false,
                            isGraded: listingData.condition_grading?.is_graded || false,
                            gradingCompany: listingData.condition_grading?.service || 'PSA',
                            grade: listingData.condition_grading?.score?.toString() || '10',
                            certificationNumber: listingData.condition_grading?.certification_number || '',
                            condition: listingData.condition_rating || 'Near Mint',
                            price: listingData.price || 0,
                            description: listingData.description || '',
                            images: listingData.images || [],
                        });

                        // Infer country
                        if (listingData.team && MLB_TEAMS.includes(listingData.team)) {
                            setCountry('USA');
                        } else {
                            setCountry('JP');
                        }
                    }
                } catch (err) {
                    console.error("Failed to load source", err);
                }
            }
        };
        init();
    }, [source, sourceId, sourceType, reset]);

    const uploadFiles = async (files: FileList) => {
        setUploading(true);
        const supabase = createClient();
        const uploadedUrls: string[] = [];

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                uploadedUrls.push(publicUrl);
            }

            const currentImages = getValues('images') || [];
            const newImages = [...currentImages, ...uploadedUrls];
            setValue('images', newImages);

            if (currentImages.length === 0 && uploadedUrls.length > 0) {
                setSelectedImageIndices([0]);
            }

        } catch (err: any) {
            console.error("Upload Error Details:", err);
            const msg = err?.message || err?.error_description || JSON.stringify(err);
            setFormError(`Upload Failed: ${msg}`);
        } finally {
            setUploading(false);
        }
    };

    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.files || e.target.files.length === 0) return;
        await uploadFiles(e.target.files);
    };

    const handleDrop = async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            await uploadFiles(e.dataTransfer.files);
        }
    };

    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    };

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    };

    const toggleImageSelection = (index: number) => {
        if (selectedImageIndices.includes(index)) {
            setSelectedImageIndices(prev => prev.filter(i => i !== index));
        } else {
            setSelectedImageIndices(prev => [...prev, index]);
        }
    };

    const removeImage = (index: number) => {
        const currentImages = getValues('images');
        const newImages = currentImages.filter((_, i) => i !== index);
        setValue('images', newImages);
        setSelectedImageIndices(prev => prev.filter(i => i !== index).map(i => i > index ? i - 1 : i));
    };

    // --- Drag & Drop Reordering ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = "move";
    };

    const handleDragEnter = (e: React.DragEvent, index: number) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;

        // Optimistic Reordering 
        const currentImages = getValues('images');
        const newImages = [...currentImages];
        const item = newImages[draggedIndex];
        newImages.splice(draggedIndex, 1);
        newImages.splice(index, 0, item);

        setValue('images', newImages);
        setDraggedIndex(index);
    };

    const handleDragEnd = () => {
        setDraggedIndex(null);
    };


    const analyzeImage = async () => {
        const currentImages = getValues('images');
        if (!currentImages || currentImages.length === 0) return;
        if (selectedImageIndices.length === 0) {
            setFormError("Please select at least one image to analyze.");
            return;
        }

        setAnalyzing(true);
        setAiFeedback(null);
        setFormError(null);
        setSuggestedData(null);


        try {
            const imageIndex = selectedImageIndices[0];
            const imageUrl = currentImages[imageIndex];

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const reader = new FileReader();

            reader.onloadend = async () => {
                const base64data = reader.result;
                try {
                    const apiRes = await fetch('/api/analyze-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64data }),
                    });

                    if (!apiRes.ok) {
                        const errorData = await apiRes.json().catch(() => ({}));
                        throw new Error(errorData.error || `AI Analysis failed with status ${apiRes.status}`);
                    }
                    const data = await apiRes.json();

                    const missingFields = [];
                    if (!data.playerName?.value) missingFields.push('Player Name');
                    if (!data.year?.value) missingFields.push('Year');

                    const hasAnalysis = missingFields.length < 2;

                    if (!hasAnalysis) {
                        setFormError("AI could not identify Player or Year. Please fill in manually.");
                        setAnalyzing(false);
                        return;
                    }

                    setSuggestedData(data);
                    setHasAnalyzed(true);

                    if (data.playerName?.value) setValue('playerName', data.playerName.value);
                    if (data.year?.value) setValue('year', data.year.value);

                    if (data.variation?.value) setValue('variation', data.variation.value);
                    if (data.serialNumber?.value) setValue('serialNumber', data.serialNumber.value);
                    if (data.isRookie?.value === 'true') setValue('isRookie', true);
                    if (data.isAutograph?.value === 'true') setValue('isAutograph', true);

                    if (data.isGraded?.value === 'true') {
                        setValue('isGraded', true);
                        if (data.gradingCompany?.value) setValue('gradingCompany', data.gradingCompany.value);
                        if (data.grade?.value) setValue('grade', data.grade.value);
                    } else if (data.condition?.value) {
                        setValue('condition', data.condition.value);
                    }

                    // Handle Parallel/Variation logic
                    let variationVal = data.variation?.value || '';
                    if (data.parallelType?.value) {
                        variationVal = variationVal ? `${variationVal} / ${data.parallelType.value}` : data.parallelType.value;
                    }
                    if (variationVal) setValue('variation', variationVal);



                } catch (err) {
                    console.error(err);
                    setFormError('Failed to analyze image.');
                } finally {
                    setAnalyzing(false);
                }
            };
            reader.readAsDataURL(blob);
        } catch (err) {
            console.error(err);
            setFormError('Could not process image.');
            setAnalyzing(false);
        }
    };

    const onSubmit = async (formData: ListingFormData) => {
        if (!user?.id) {
            setFormError("You must be logged in to sell items.");
            return;
        }
        setSubmitting(true);
        setFormError(null);

        try {
            const supabase = createClient();
            const listingData = {
                // catalog_id: null, // Removed
                player_name: formData.playerName,
                team: formData.team,
                year: parseInt(formData.year || '') || null, // Handle Unknown/Empty as null
                manufacturer: formData.brand,

                price: formData.price,
                images: formData.images,
                condition_grading: {
                    is_graded: formData.isGraded,
                    service: formData.isGraded ? formData.gradingCompany : "None",
                    score: formData.isGraded ? parseFloat(formData.grade || '0') : null,
                    certification_number: formData.isGraded ? formData.certificationNumber : null
                },
                variation: formData.variation,
                serial_number: formData.serialNumber,
                is_rookie: formData.isRookie,
                is_autograph: formData.isAutograph,
                description: formData.description,
                condition_rating: !formData.isGraded ? formData.condition : null,
                deleted_at: null, // Clear archived status if listed
                status: 'Active'
            };

            if (isEditing && sourceId) {
                const { error: updateError } = await supabase
                    .from('listing_items')
                    .update(listingData)
                    .eq('id', sourceId);
                if (updateError) throw updateError;
                router.push(`/listings/${sourceId}`);
            } else {
                const { data: listing, error: insertError } = await supabase
                    .from('listing_items')
                    .insert({ ...listingData, seller_id: user.id })
                    .select()
                    .single();
                if (insertError) throw insertError;

                if (source === 'collection' && sourceType === 'manual') {
                    await supabase.from('user_collections').delete().eq('id', sourceId);
                }
                router.push(`/listings/${listing.id}`);
            }

        } catch (err: any) {
            console.error("Submission Error:", err);
            // Supabase errors might be objects with a 'message' property but not instances of Error
            const msg = err?.message || err?.error_description || (typeof err === 'string' ? err : 'An error occurred');
            setFormError(msg);
            setSubmitting(false);
        }
    };

    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const renderChip = (label: string, fieldData: any, fieldName: keyof ListingFormData) => {
        if (!fieldData?.value) return (
            <span className="text-xs text-red-400 font-mono ml-2 border border-red-500/20 px-2 py-0.5 rounded-full bg-red-500/10">Unknown</span>
        );
        const isHigh = fieldData.confidence === 'High';
        return (
            <button
                type="button"
                onClick={() => setValue(fieldName, fieldData.value)}
                className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium border transition-all hover:scale-105 active:scale-95 ${isHigh
                    ? 'bg-blue-500/20 text-blue-200 border-blue-500/50 hover:bg-blue-500/30'
                    : 'bg-brand-gold/10 text-brand-gold border-brand-gold/30 hover:bg-brand-gold/20'
                    }`}
            >
                {isHigh && <span>✨</span>}
                <span className="opacity-70">{label}:</span>
                <span className="font-bold">{fieldData.value}</span>
            </button>
        );
    };

    return (
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-32 relative z-20 flex-1 w-full">
            <div className="md:flex md:items-center md:justify-between mb-8">
                <div className="flex-1 min-w-0">
                    <h2 className="text-3xl font-heading font-bold leading-7 text-white sm:text-4xl sm:truncate drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                        Create New Listing
                    </h2>
                    <p className="mt-2 text-brand-platinum/60">AIを活用した出品インターフェース</p>
                </div>
            </div>

            <div className="glass-panel-premium rounded-2xl overflow-hidden shadow-2xl border border-white/10 relative">
                <div className="absolute top-0 right-0 w-64 h-64 bg-brand-gold/5 rounded-full blur-3xl -z-10"></div>
                <div className="absolute bottom-0 left-0 w-64 h-64 bg-brand-blue/5 rounded-full blur-3xl -z-10"></div>

                {/* eslint-disable-next-line @typescript-eslint/no-explicit-any */}
                <form onSubmit={handleSubmit(onSubmit as any)} className="p-8 space-y-12">

                    {/* --- 0. Image Upload --- */}
                    <div className="mb-6">
                        <label
                            onDragOver={handleDragOver}
                            onDragLeave={handleDragLeave}
                            onDrop={handleDrop}
                            className={`group relative flex flex-col items-center justify-center w-full h-80 border-2 border-dashed rounded-2xl transition-all cursor-pointer ${uploading ? 'opacity-50 cursor-not-allowed' : ''
                                } ${isDragging
                                    ? 'border-brand-gold bg-brand-gold/10 scale-[1.02]'
                                    : 'border-brand-platinum/20 hover:border-brand-gold/50 hover:bg-brand-gold/5'
                                }`}
                        >
                            {images.length > 0 ? (
                                <div className="w-full h-full relative p-4 flex items-center justify-center">
                                    <PremiumCardImage src={images[0]} alt="Main upload" className="max-h-full object-contain rounded-lg shadow-2xl" />
                                    <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-2xl">
                                        <p className="text-white font-bold">画像を追加 / 変更</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg className={`w-12 h-12 mb-4 transition-colors ${isDragging ? 'text-brand-gold' : 'text-brand-platinum/50 group-hover:text-brand-gold'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    <p className={`mb-2 text-lg ${isDragging ? 'text-white' : 'text-brand-platinum group-hover:text-white'}`}><span className="font-bold">カード画像をアップロード</span></p>
                                    <p className="text-sm text-brand-platinum/50">複数枚のアップロードに対応</p>
                                </div>
                            )}
                            <input
                                type="file"
                                accept="image/*"
                                multiple
                                className="hidden"
                                onChange={handleImageUpload}
                                disabled={uploading}
                            />
                            {uploading && (
                                <div className="absolute inset-0 bg-brand-dark/80 flex items-center justify-center rounded-2xl backdrop-blur-sm">
                                    <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-brand-gold"></div>
                                </div>
                            )}
                        </label>

                        {/* Thumbnail Grid & Tools */}
                        <div className="flex justify-between items-start mt-4">
                            <div className="flex gap-2 overflow-x-auto pb-2 flex-1 items-center">
                                {images.map((url, idx) => (
                                    <div
                                        key={idx}
                                        draggable
                                        onDragStart={(e) => handleDragStart(e, idx)}
                                        onDragEnter={(e) => handleDragEnter(e, idx)}
                                        onDragEnd={handleDragEnd}
                                        onDragOver={(e) => e.preventDefault()}
                                        onClick={() => toggleImageSelection(idx)}
                                        className={`relative w-20 h-28 flex-shrink-0 rounded-lg overflow-hidden border-2 cursor-pointer transition-all ${selectedImageIndices.includes(idx)
                                            ? 'border-brand-gold shadow-[0_0_10px_rgba(212,175,55,0.5)] scale-105'
                                            : 'border-brand-platinum/20 opacity-70 hover:opacity-100'
                                            } group`}
                                        style={{
                                            opacity: draggedIndex === idx ? 0.5 : 1,
                                            transform: draggedIndex === idx ? 'scale(1.05)' : 'scale(1)',
                                        }}
                                    >
                                        {/* eslint-disable-next-line @next/next/no-img-element */}
                                        <img src={url} alt={`View ${idx + 1}`} className="w-full h-full object-cover" />
                                        {selectedImageIndices.includes(idx) && (
                                            <div className="absolute top-1 right-1 w-4 h-4 bg-brand-gold rounded-full flex items-center justify-center shadow-md">
                                                <svg className="w-3 h-3 text-brand-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>
                                            </div>
                                        )}
                                        {/* Delete Button (Hover) */}
                                        <div className="absolute top-0 left-0 w-full h-full bg-black/40 hidden group-hover:flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); removeImage(idx); }}
                                                className="bg-red-500 rounded-full p-1 text-white hover:bg-red-600"
                                                title="Delete Image"
                                            >
                                                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {images.length > 0 && (
                                <div className="flex flex-col items-end gap-2 ml-4">
                                    <button
                                        type="button"
                                        onClick={analyzeImage}
                                        disabled={analyzing}
                                        className="bg-brand-gold text-brand-dark font-bold px-5 py-2 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center gap-2 whitespace-nowrap"
                                    >
                                        {analyzing ? <div className="w-4 h-4 border-2 border-brand-dark border-t-transparent rounded-full animate-spin" /> : <span>✨ AI解析を実行</span>}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- Form Sections (Revealed after Analysis) --- */}
                    {hasAnalyzed && (
                        <div className="space-y-12 animate-fade-in-up">
                            {/* --- Section 1: Basic Info --- */}
                            <section>
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-brand-gold/20 flex items-center justify-center text-brand-gold text-sm">1</span>
                                    Basic Info (基本情報)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Player Name */}
                                    <div className="md:col-span-2">
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">選手名 <span className="text-red-500">*</span></label>
                                            {suggestedData && renderChip("AI", suggestedData.playerName, 'playerName')}
                                        </div>
                                        <input {...register('playerName')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:ring-2 focus:ring-brand-blue" placeholder="大谷翔平 (Shohei Ohtani)" />
                                        {errors.playerName && <p className="text-red-400 text-xs mt-1">{errors.playerName.message}</p>}
                                    </div>

                                    {/* Year Dropdown */}
                                    <div>
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">発行年 <span className="text-red-500">*</span></label>
                                            {suggestedData && renderChip("AI", suggestedData.year, 'year')}
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('year')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>年を選択...</option>
                                                <option value="Unknown">Unknown (不明)</option>
                                                {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                        {errors.year && <p className="text-red-400 text-xs mt-1">{errors.year.message}</p>}
                                    </div>

                                    {/* Brand (Catalog) */}
                                    <div>
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">Brand <span className="text-red-500">*</span></label>
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('brand')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>ブランドを選択...</option>
                                                {CARD_BRANDS.map(b => <option key={b} value={b}>{b}</option>)}
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                        {errors.brand && <p className="text-red-400 text-xs mt-1">{errors.brand.message}</p>}
                                    </div>

                                    {/* Team (Localized) */}
                                    <div className="md:col-span-2">
                                        <div className="flex justify-between mb-2 items-center">
                                            <label className="text-sm font-medium text-brand-platinum">Team <span className="text-red-500">*</span></label>
                                        </div>

                                        <div className="flex gap-4">
                                            {/* Country Select */}
                                            <div className="w-1/3">
                                                <select
                                                    value={country}
                                                    onChange={(e) => setCountry(e.target.value as 'USA' | 'JP')}
                                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                                >
                                                    <option value="JP">🇯🇵 NPB (日本)</option>
                                                    <option value="USA">🇺🇸 MLB (米国)</option>
                                                </select>
                                            </div>

                                            {/* Catalog Select */}
                                            <div className="flex-1 relative">
                                                <select
                                                    {...register('team')}
                                                    className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                                >
                                                    <option value="" disabled>チームを選択...</option>
                                                    {(country === 'USA' ? MLB_TEAMS : NPB_TEAMS).map(team => (
                                                        <option key={team} value={team}>{team}</option>
                                                    ))}
                                                    <option value="Other">その他</option>
                                                    <option value="Unknown">Unknown (不明)</option>
                                                </select>
                                                <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                                </div>
                                            </div>
                                        </div>
                                        {errors.team && <p className="text-red-400 text-xs mt-1">{errors.team.message}</p>}
                                    </div>
                                </div>
                            </section>

                            {/* --- Section 2: Features & Rarity --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-brand-blue/20 flex items-center justify-center text-brand-blue text-sm">2</span>
                                    Features & Rarity (特徴・レアリティ)
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Variation */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">バリエーション</label>
                                            {suggestedData && renderChip("AI", suggestedData.variation, 'variation')}
                                        </div>
                                        <input {...register('variation')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="例: Black Refractor" />
                                    </div>

                                    {/* Serial */}
                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">シリアル番号</label>
                                            {suggestedData && renderChip("AI", suggestedData.serialNumber, 'serialNumber')}
                                        </div>
                                        <input {...register('serialNumber')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="例: 01/10" />
                                    </div>

                                    {/* Flags */}
                                    <div className="md:col-span-2 flex gap-8 pt-2">
                                        <label className="flex items-center gap-3 cursor-pointer group">
                                            <input type="checkbox" {...register('isRookie')} className="w-5 h-5 rounded border-brand-platinum/20 bg-brand-dark text-brand-gold focus:ring-brand-gold" />
                                            <span className="text-white group-hover:text-brand-gold transition-colors">ルーキーカード (RC)</span>
                                        </label>
                                        <label className="flex items-center gap-3 cursor-pointer group">
                                            <input type="checkbox" {...register('isAutograph')} className="w-5 h-5 rounded border-brand-platinum/20 bg-brand-dark text-brand-gold focus:ring-brand-gold" />
                                            <span className="text-white group-hover:text-brand-gold transition-colors">直筆サイン入り (Auto)</span>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            {/* --- Section 3: Condition & Grading --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-sm">3</span>
                                    Condition (状態)
                                </h3>

                                {/* Graded Toggle */}
                                <div className="flex items-center mb-6 p-4 rounded-xl bg-brand-dark-light/30 border border-white/5 cursor-pointer" onClick={() => setValue('isGraded', !isGraded)}>
                                    <div className={`w-6 h-6 rounded border flex items-center justify-center mr-4 transition-all ${isGraded ? 'bg-brand-gold border-brand-gold' : 'border-brand-platinum/30'}`}>
                                        {isGraded && <svg className="w-4 h-4 text-brand-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                    </div>
                                    <span className="text-white font-bold">鑑定済みですか？ (PSA/BGSなど)</span>
                                </div>

                                {isGraded ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in-up">
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">鑑定会社</label>
                                                {suggestedData && renderChip("AI", suggestedData.gradingCompany, 'gradingCompany')}
                                            </div>
                                            <select {...register('gradingCompany')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white">
                                                <option value="PSA">PSA</option>
                                                <option value="BGS">BGS</option>
                                                <option value="SGC">SGC</option>
                                                <option value="CGC">CGC</option>
                                                <option value="ARS">ARS</option>
                                            </select>
                                        </div>
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">グレード (点数)</label>
                                                {suggestedData && renderChip("AI", suggestedData.grade, 'grade')}
                                            </div>
                                            <input {...register('grade')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="10" />
                                        </div>

                                        {/* Certification Number */}
                                        <div className="md:col-span-2">
                                            <div className="flex justify-between mb-2">
                                                <label className="text-sm font-medium text-brand-platinum">証明番号 (任意)</label>
                                            </div>
                                            <input {...register('certificationNumber')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white" placeholder="12345678" />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="animate-fade-in-up">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-sm font-medium text-brand-platinum">未鑑定カードの状態</label>
                                            {suggestedData && renderChip("AI", suggestedData.condition, 'condition')}
                                        </div>
                                        <div className="relative">
                                            <select
                                                {...register('condition')}
                                                className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-brand-blue"
                                            >
                                                <option value="" disabled>状態を選択...</option>
                                                <option value="Gem Mint">Gem Mint (完品)</option>
                                                <option value="Mint">Mint (美品)</option>
                                                <option value="Near Mint">Near Mint (準美品)</option>
                                                <option value="Excellent">Excellent (良品)</option>
                                                <option value="Very Good">Very Good (可)</option>
                                                <option value="Poor">Poor (難あり)</option>
                                            </select>
                                            <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </section>

                            {/* --- Section 4: Other --- */}
                            <section className="border-t border-white/5 pt-8">
                                <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                    <span className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400 text-sm">4</span>
                                    Price & Note (価格・詳細)
                                </h3>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-sm font-medium text-brand-platinum mb-2 block">商品説明 / 詳細メモ</label>
                                        <textarea {...register('description')} className="block w-full px-4 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white h-24" placeholder="傷の状態や特徴など..." />
                                    </div>

                                    <div>



                                        {/* External Market Links */}
                                        {suggestedData && (
                                            <div className="mb-6">
                                                <MarketPriceLinks
                                                    initialQuery={[
                                                        suggestedData.year?.value,
                                                        suggestedData.brand?.value,
                                                        suggestedData.playerName?.value,
                                                        suggestedData.cardNumber?.value,
                                                        // suggestedData.variation?.value // Optional: might be too specific
                                                    ].filter(Boolean).join(' ')}
                                                />
                                            </div>
                                        )}

                                        <label className="text-sm font-bold text-brand-gold tracking-wider mb-2 block uppercase">販売価格 (円) <span className="text-red-500">*</span></label>
                                        <div className="relative">
                                            <span className="absolute left-4 top-3.5 text-brand-platinum">¥</span>
                                            <input
                                                type="number"
                                                {...register('price', { valueAsNumber: true })}
                                                className="block w-full pl-8 pr-4 py-3 rounded-xl bg-brand-dark-light/80 border border-brand-platinum/20 text-white font-heading text-lg"
                                                placeholder="5000"
                                            />
                                            {errors.price && <p className="text-red-400 text-xs mt-1">{errors.price.message}</p>}
                                        </div>
                                    </div>
                                </div>
                            </section>

                            {/* Status Feedback */}
                            {
                                aiFeedback && (
                                    <div className="rounded-xl bg-green-500/10 p-4 border border-green-500/20 flex items-center gap-3 animate-fade-in-up">
                                        <svg className="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                        <p className="text-sm text-green-300 font-medium">{aiFeedback}</p>
                                    </div>
                                )
                            }
                            {
                                formError && (
                                    <div className="rounded-xl bg-red-500/10 p-4 border border-red-500/20 flex items-center gap-3 animate-shake">
                                        <svg className="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <p className="text-sm text-red-300 font-medium">{formError}</p>
                                    </div>
                                )
                            }

                            {/* Submit Button */}
                            <div className="pt-6">
                                <button
                                    type="submit"
                                    disabled={submitting}
                                    className={`w-full flex justify-center items-center gap-2 py-4 px-6 border border-transparent rounded-xl shadow-lg shadow-brand-blue/20 text-lg font-bold text-white bg-gradient-to-r from-brand-blue to-brand-blue-glow hover:from-brand-blue-glow hover:to-brand-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-blue transition-all transform hover:scale-[1.02] ${submitting ? 'opacity-50 cursor-not-allowed' : ''}`}
                                >
                                    {submitting ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>出品中...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>出品する</span>
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    )}

                </form >
            </div >
        </div >
    );
}

export default function SellPage() {
    return (
        <div className="min-h-screen bg-brand-dark flex flex-col">
            <Suspense fallback={<div className="min-h-screen flex items-center justify-center text-white">Loading...</div>}>
                <SellContent />
            </Suspense>
            <Footer />
        </div>
    );
}
</file>

<file path="frontend/app/error.tsx">
'use client';

import { useEffect } from 'react';

export default function Error({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    useEffect(() => {
        console.error(error);
    }, [error]);

    return (
        <div className="min-h-screen flex items-center justify-center bg-brand-dark relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute inset-0 z-0">
                <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-red-500/5 rounded-full blur-[100px]"></div>
                <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-brand-blue/5 rounded-full blur-[100px]"></div>
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10 bg-center"></div>
            </div>

            <div className="relative z-10 text-center px-4 max-w-lg mx-auto">
                <div className="mb-8 flex justify-center">
                    <div className="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center border border-red-500/20 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
                        <svg className="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                </div>
                <h2 className="text-3xl font-heading font-bold text-white mb-4">System Malfunction</h2>
                <p className="text-brand-platinum/60 mb-8 text-lg">{error.message || "An unexpected error occurred within the stadium network."}</p>
                <button
                    onClick={() => reset()}
                    className="px-8 py-3 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-full transition-all shadow-lg hover:shadow-brand-blue/30"
                >
                    Reboot System
                </button>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/global-error.tsx">
'use client';

import './globals.css';


export default function GlobalError({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    return (
        <html>
            <body className="bg-brand-dark text-white">
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="text-center">
                        <h2 className="text-2xl font-bold mb-4">Something went wrong!</h2>
                        <p className="text-brand-platinum/60 mb-6">{error.message}</p>
                        <button
                            onClick={() => reset()}
                            className="px-4 py-2 bg-brand-blue rounded-lg hover:bg-brand-blue-glow transition-colors"
                        >
                            Try again
                        </button>
                    </div>
                </div>
            </body>
        </html>
    );
}
</file>

<file path="frontend/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    @apply bg-brand-dark;
  }

  body {
    @apply text-white font-sans antialiased relative min-h-screen overflow-x-hidden;
    background-color: transparent;
    background-image:
      radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
      linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 100% 100%, 40px 40px, 40px 40px;
    background-position: center top, center top, center top;
    background-repeat: no-repeat, repeat, repeat;
  }

  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/bg-stadium.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.2;
    z-index: -1;
    pointer-events: none;
    mix-blend-mode: screen;
  }
}

@layer utilities {
  .glass-panel {
    @apply bg-brand-dark-light/70 backdrop-blur-xl border border-white/10 shadow-2xl;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
  }

  .glass-panel-premium {
    @apply bg-brand-dark-light/80 backdrop-blur-xl border-t border-l border-white/10 border-b border-r border-black/30 shadow-2xl;
    box-shadow:
      0 4px 30px rgba(0, 0, 0, 0.5),
      inset 0 0 0 1px rgba(255, 215, 0, 0.05);
    /* Subtle gold inset */
  }

  .text-glow {
    text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
  }

  .text-gold-glow {
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
  }

  .card-hover {
    @apply transition-all duration-300 hover:scale-105 hover:-translate-y-2 hover:shadow-2xl hover:shadow-brand-blue/20 hover:border-brand-blue/40;
  }

  .card-hover-premium {
    @apply transition-all duration-500 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl hover:shadow-brand-gold/20 hover:border-brand-gold/40;
  }
}
</file>

<file path="frontend/app/layout.tsx">
import type { Metadata, Viewport } from "next";
import { Inter, Outfit } from "next/font/google";
import "./globals.css";
import Link from "next/link";
// import { Providers } from "./providers";
import Header from "../components/Header";
import LiveMomentListener from "../components/LiveMomentListener";
import DevTools from "../components/DevTools";

const inter = Inter({ subsets: ["latin"], variable: "--font-inter" });
const outfit = Outfit({ subsets: ["latin"], variable: "--font-outfit" });

export const metadata: Metadata = {
  title: "Baseball Card Market",
  description: "Trading platform for baseball cards",
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={`${inter.variable} ${outfit.variable} font-sans text-white antialiased`}>
        {/* <Providers> */}
        <Header />
        <LiveMomentListener />
        <DevTools />
        <main>{children}</main>
        {/* </Providers> */}
      </body>
    </html>
  );
}
</file>

<file path="frontend/app/not-found.tsx">
'use client';

import Link from 'next/link';

export default function NotFound() {
    return (
        <div className="min-h-screen flex items-center justify-center bg-brand-dark relative overflow-hidden">
            {/* Background Elements */}
            <div className="absolute inset-0 z-0">
                <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-brand-blue/10 rounded-full blur-[100px]"></div>
                <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-brand-gold/5 rounded-full blur-[100px]"></div>
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-10 bg-center"></div>
            </div>

            <div className="relative z-10 text-center px-4">
                <h1 className="text-9xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-br from-brand-platinum to-brand-dark-light opacity-50 mb-0 leading-none select-none">
                    404
                </h1>
                <div className="-mt-12 mb-8 relative">
                    <h2 className="text-3xl md:text-4xl font-heading font-bold text-white mb-4 drop-shadow-lg">
                        Page Not Found
                    </h2>
                    <p className="text-brand-platinum/60 max-w-md mx-auto text-lg mb-8">
                        The card you are looking for seems to have been lost in the shuffle.
                    </p>
                </div>

                <Link
                    href="/"
                    className="inline-flex items-center gap-2 px-8 py-4 bg-brand-blue hover:bg-brand-blue-glow text-white font-bold rounded-full transition-all shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:scale-105"
                >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    Return to Home
                </Link>
            </div>
        </div>
    );
}
</file>

<file path="frontend/app/page.tsx">
'use client';

import { useEffect, useState, Suspense } from 'react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation'; // Added
import HeroSection from '../components/HeroSection';
import CardListing from '../components/CardListing';
import Footer from '../components/Footer';
import SkeletonCard from '../components/SkeletonCard';
import { ListingItem, Team } from '../types';

import { createClient } from '../utils/supabase/client';

function HomeContent() {
  const searchParams = useSearchParams(); // Added
  const isDebugLive = searchParams.get('live') === 'true'; // Debug Mode

  const [listings, setListings] = useState<ListingItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Search & Filter State
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedTeam, setSelectedTeam] = useState<string>('');
  const [sortOrder, setSortOrder] = useState('newest');

  // Debounce search
  const [debouncedSearch, setDebouncedSearch] = useState(searchQuery);

  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearch(searchQuery);
    }, 500);
    return () => clearTimeout(timer);
  }, [searchQuery]);

  useEffect(() => {
    const fetchListings = async () => {
      setLoading(true);
      try {
        const supabase = createClient();
        let query = supabase
          .from('listing_items')
          .select('*')
          .eq('status', 'Active');

        if (debouncedSearch) {
          // Note: This is a simple search. For better search, use text search capabilities or join with catalog
          // Since we can't easily filter on joined table fields with simple syntax in one go without embedding, 
          // we might need to rely on client side filtering or more complex queries.
          // For now, let's assume we filter by catalog fields if possible, but Supabase JS client filtering on joined tables is tricky.
          // A common workaround is !inner join or text search.
          // Let's try to filter by player_name in catalog if possible, but standard select doesn't support filtering on joined relation easily in top level.
          // We will fetch all and filter client side for search if it's small, or use a specific RPC or search index.
          // Given the constraints, let's try to use the 'search' param if we had an RPC, but we don't.
          // Let's just fetch active listings and filter client side for the demo if the dataset is small, 
          // OR use the text search on a view.
          // For this migration, I'll implement a basic fetch and client-side filter for the search text to be safe, 
          // or try to use `!inner` to filter by catalog team/player.

          // Using !inner to filter by catalog properties
          // query = query.not('catalog', 'is', null); // Ensure catalog exists
        }

        if (selectedTeam) {
          // This requires filtering on the joined 'catalog' table.
          // Supabase supports this with: .eq('catalog.team', selectedTeam) if using JSON or specific syntax, 
          // but strictly typed client might complain.
          // Let's use the !inner hint if we can, or just fetch and filter.
          // For simplicity and reliability in this migration without changing schema:
          // We will fetch more and filter in memory, OR we assume the user has set up RLS/Views.
          // Actually, let's try to use the foreign key filter syntax:
          // .eq('catalog.team', selectedTeam) works if we use !inner in select: select('*, catalog!inner(*)')
          // But let's stick to a simpler approach: Fetch active items and filter.
        }

        // Sorting
        if (sortOrder === 'newest') {
          query = query.order('created_at', { ascending: false });
        } else if (sortOrder === 'price_asc') {
          query = query.order('price', { ascending: true });
        } else if (sortOrder === 'price_desc') {
          query = query.order('price', { ascending: false });
        }

        const { data, error } = await query;

        if (error) throw error;

        let filteredData = data as any[];

        // Client-side filtering for Search and Team (since simple join filtering is complex in JS client without specific setup)
        if (debouncedSearch) {
          const lowerSearch = debouncedSearch.toLowerCase();
          filteredData = filteredData.filter(item => {
            const playerName = item.player_name || '';
            const manufacturer = item.manufacturer || '';
            const series = item.variation || item.series_name || '';

            return (
              playerName.toLowerCase().includes(lowerSearch) ||
              manufacturer.toLowerCase().includes(lowerSearch) ||
              series.toLowerCase().includes(lowerSearch)
            );
          });
        }

        if (selectedTeam) {
          filteredData = filteredData.filter(item => {
            const team = item.team;
            return team === selectedTeam;
          });
        }

        setListings(filteredData);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'An unknown error occurred');
      } finally {
        setLoading(false);
      }
    };

    fetchListings();
  }, [debouncedSearch, selectedTeam, sortOrder]);

  const teams: Team[] = ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"];

  return (
    <div className="min-h-screen bg-brand-dark flex flex-col">
      <HeroSection />

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-20 relative z-20 flex-1 w-full">
        {/* Search & Filter Bar */}
        <div className="glass-panel-premium p-6 rounded-2xl shadow-2xl mb-12 animate-fade-in-up">
          <div className="flex flex-col md:flex-row gap-4 items-center">
            {/* Search Input */}
            <div className="flex-1 w-full">
              <label htmlFor="search" className="sr-only">Search</label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg className="h-5 w-5 text-brand-platinum/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                </div>
                <input
                  type="text"
                  id="search"
                  placeholder="選手名、シリーズ、年代などで検索..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="block w-full pl-10 pr-3 py-3 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white placeholder-brand-platinum/30 focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all"
                />
              </div>
            </div>

            {/* Team Filter */}
            <div className="w-full md:w-48">
              <label htmlFor="team" className="sr-only">Team</label>
              <select
                id="team"
                value={selectedTeam}
                onChange={(e) => setSelectedTeam(e.target.value)}
                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
              >
                <option value="">全チーム</option>
                {teams.map((team) => (
                  <option key={team} value={team}>{team}</option>
                ))}
              </select>
            </div>

            {/* Sort Order */}
            <div className="w-full md:w-48">
              <label htmlFor="sort" className="sr-only">Sort</label>
              <select
                id="sort"
                value={sortOrder}
                onChange={(e) => setSortOrder(e.target.value)}
                className="block w-full py-3 px-4 rounded-xl bg-brand-dark-light/50 border border-brand-platinum/10 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all appearance-none"
              >
                <option value="newest">新着順</option>
                <option value="price_asc">価格が安い順</option>
                <option value="price_desc">価格が高い順</option>
              </select>
            </div>
          </div>
        </div>

        {/* Listings Grid */}
        <div className="mb-12">
          <div className="flex items-center justify-between mb-8">
            <h2 className="text-3xl font-heading font-bold text-white">Latest Arrivals</h2>
            <span className="text-brand-platinum/60 text-sm">{listings.length} 件</span>
          </div>

          {loading ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
              {[...Array(8)].map((_, i) => (
                <SkeletonCard key={i} />
              ))}
            </div>
          ) : error ? (
            <div className="min-h-[400px] flex items-center justify-center">
              <div className="text-red-500 text-xl font-semibold bg-red-500/10 px-6 py-4 rounded-lg border border-red-500/20">Error: {error}</div>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                {listings.map((item) => (
                  <CardListing key={item.id} item={item} isLiveMoment={isDebugLive} />
                ))}
              </div>

              {listings.length === 0 && (
                <div className="text-center py-20 bg-brand-dark-light/30 rounded-2xl border border-brand-platinum/5">
                  <p className="text-brand-platinum/50 text-lg">条件に一致するカードが見つかりませんでした。</p>
                  <button
                    onClick={() => { setSearchQuery(''); setSelectedTeam(''); }}
                    className="mt-4 text-brand-blue hover:text-brand-blue-glow font-medium"
                  >
                    条件をクリア
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      </div>

      <Footer />
    </div>
  );
}

export default function Home() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-brand-dark flex items-center justify-center"><div className="w-8 h-8 border-2 border-brand-gold border-t-transparent rounded-full animate-spin"></div></div>}>
      <HomeContent />
    </Suspense>
  );
}
</file>

<file path="frontend/components/emails/OrderConfirmationEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderConfirmationEmailProps {
    buyerName?: string;
    productName?: string;
    orderUrl?: string;
    price?: number;
}

export const OrderConfirmationEmail = ({
    buyerName = "Collector",
    productName = "Your New Card",
    orderUrl = "http://localhost:3000/orders/buy",
    price = 0,
}: OrderConfirmationEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Order Confirmed: {productName}</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Order Confirmed!
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                Thank you for your purchase, {buyerName}.
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] font-mono text-[16px] font-bold text-center mt-2">
                                ¥{price.toLocaleString()}
                            </Text>

                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The seller has been notified and will ship your item soon.
                                You will receive another email when it ships.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                VIEW ORDER
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderConfirmationEmail;
</file>

<file path="frontend/components/emails/OrderReceivedEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderReceivedEmailProps {
    sellerName?: string;
    productName?: string;
    payoutUrl?: string; // Link to payout page
}

export const OrderReceivedEmail = ({
    sellerName = "Seller",
    productName = "Your Item",
    payoutUrl = "http://localhost:3000/payouts",
}: OrderReceivedEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Transaction Complete: Funds Added</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Transaction Complete, {sellerName}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The buyer has received your item:
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] text-[14px] font-bold text-center mt-6">
                                The sales proceeds have been added to your balance.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={payoutUrl}
                            >
                                VIEW BALANCE
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderReceivedEmail;
</file>

<file path="frontend/components/emails/OrderShippedEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface OrderShippedEmailProps {
    buyerName?: string;
    productName?: string;
    trackingNumber?: string;
    carrier?: string;
    orderUrl?: string; // Link to order detail
    baseUrl?: string;
}

export const OrderShippedEmail = ({
    buyerName = "Collector",
    productName = "Your Item",
    trackingNumber,
    carrier,
    orderUrl = "http://localhost:3000/orders",
}: OrderShippedEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Your order has been shipped!</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Your Item is on the Way, {buyerName}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                The following item has been shipped:
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>

                            {(trackingNumber || carrier) && (
                                <Section className="mt-4 p-4 bg-white/5 rounded border border-white/10 text-center">
                                    {carrier && (
                                        <Text className="text-[#E5E4E2] text-[14px] m-0">
                                            Carrier: {carrier}
                                        </Text>
                                    )}
                                    {trackingNumber && (
                                        <Text className="text-[#FFD700] text-[16px] font-mono m-0 mt-1">
                                            Tracking: {trackingNumber}
                                        </Text>
                                    )}
                                </Section>
                            )}

                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                VIEW ORDER STATUS
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Please click "Received" when the item arrives.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default OrderShippedEmail;
</file>

<file path="frontend/components/emails/PayoutRequestEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface PayoutRequestEmailProps {
    userName?: string;
    amount?: number;
    payoutId?: string;
    adminUrl?: string;
}

export const PayoutRequestEmail = ({
    userName = "User",
    amount = 0,
    payoutId = "",
    adminUrl = "http://localhost:3000/admin/payouts",
}: PayoutRequestEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>New Payout Request: ¥{amount.toLocaleString()}</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-2xl font-bold text-center tracking-widest p-0 my-0">
                                ADMIN NOTIFICATION
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[18px] font-normal text-center p-0 my-0 mx-0">
                                New Payout Request
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                User <strong>{userName}</strong> has requested a payout.
                            </Text>
                            <Text className="text-[#FFD700] font-mono text-[24px] font-bold text-center mt-4">
                                ¥{amount.toLocaleString()}
                            </Text>

                            <Text className="text-[#6B7280] text-[12px] text-center mt-2">
                                ID: {payoutId}
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={adminUrl}
                            >
                                REVIEW PAYOUTS
                            </Button>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default PayoutRequestEmail;
</file>

<file path="frontend/components/emails/ShippingRequestEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface ShippingRequestEmailProps {
    sellerName?: string;
    productName?: string;
    orderUrl?: string;
}

export const ShippingRequestEmail = ({
    sellerName = "Seller",
    productName = "Your Item",
    orderUrl = "http://localhost:3000/orders/sell",
}: ShippingRequestEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Action Required: Your item has been sold!</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Item Sold!
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                Great news, {sellerName}. Your item has been purchased.
                            </Text>
                            <Text className="text-white text-[16px] font-bold text-center mt-2">
                                {productName}
                            </Text>
                            <Text className="text-[#FFD700] text-[14px] font-bold text-center mt-6">
                                Please ship the item to the buyer.
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-2">
                                Check the shipping address and enter the tracking number on your dashboard.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={orderUrl}
                            >
                                MANAGE ORDER
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                Thank you for using Stadium Card.<br />
                                © 2024 Stadium Card Team.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default ShippingRequestEmail;
</file>

<file path="frontend/components/emails/WelcomeEmail.tsx">
import {
    Html,
    Head,
    Body,
    Container,
    Section,
    Text,
    Button,
    Preview,
    Tailwind,
} from '@react-email/components';
import * as React from 'react';

interface WelcomeEmailProps {
    userFirstname?: string;
    baseUrl?: string;
}

export const WelcomeEmail = ({
    userFirstname = "Member",
    baseUrl = "http://localhost:3000",
}: WelcomeEmailProps) => {
    return (
        <Html>
            <Head />
            <Preview>Welcome to the Stadium Card Exclusive Club.</Preview>
            <Tailwind
                config={{
                    theme: {
                        extend: {
                            colors: {
                                brand: {
                                    dark: '#0a0a0a',
                                    gold: '#FFD700',
                                    platinum: '#E5E4E2',
                                },
                            },
                        },
                    },
                }}
            >
                <Body className="bg-black my-auto mx-auto font-sans">
                    <Container className="border border-[#FFD700] rounded mx-auto p-8 max-w-[465px] bg-[#111111] my-[40px]">
                        <Section className="mt-[20px]">
                            <Text className="text-[#FFD700] text-3xl font-bold text-center tracking-widest p-0 my-0">
                                STADIUM CARD
                            </Text>
                        </Section>
                        <Section className="mt-[32px]">
                            <Text className="text-[#E5E4E2] text-[20px] font-normal text-center p-0 my-0 mx-0">
                                Welcome to the Elite, {userFirstname}
                            </Text>
                            <Text className="text-[#9CA3AF] text-[14px] leading-[24px] text-center mt-6">
                                You have successfully joined the premier marketplace for high-end baseball cards.
                                Prepare to collect moments that define history.
                            </Text>
                        </Section>
                        <Section className="text-center mt-[32px] mb-[32px]">
                            <Button
                                className="bg-[#FFD700] rounded text-black px-8 py-4 font-bold text-[14px] no-underline tracking-wide"
                                href={`${baseUrl}/market`}
                            >
                                EXPLORE THE COLLECTION
                            </Button>
                        </Section>
                        <Section>
                            <Text className="text-[#6B7280] text-[12px] leading-[20px] text-center">
                                © 2024 Stadium Card Team. All rights reserved.<br />
                                This is a system generated message.
                            </Text>
                        </Section>
                    </Container>
                </Body>
            </Tailwind>
        </Html>
    );
};

export default WelcomeEmail;
</file>

<file path="frontend/components/AddToShowcaseModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '../utils/supabase/client';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';

// --- Data Constants (Mirrored from SellPage) ---
const MLB_TEAMS = [
    "アリゾナ・ダイヤモンドバックス", "アトランタ・ブレーブス", "ボルチモア・オリオールズ", "ボストン・レッドソックス", "シカゴ・カブス",
    "シカゴ・ホワイトソックス", "シンシナティ・レッズ", "クリーブランド・ガーディアンズ", "コロラド・ロッキーズ", "デトロイト・タイガース",
    "ヒューストン・アストロズ", "カンザスシティ・ロイヤルズ", "ロサンゼルス・エンゼルス", "ロサンゼルス・ドジャース", "マイアミ・マーリンズ",
    "ミルウォーキー・ブルワーズ", "ミネソタ・ツインズ", "ニューヨーク・メッツ", "ニューヨーク・ヤンキース", "オークランド・アスレチックス",
    "フィラデルフィア・フィリーズ", "ピッツバーグ・パイレーツ", "サンディエゴ・パドレス", "サンフランシスコ・ジャイアンツ", "シアトル・マリナーズ",
    "セントルイス・カージナルス", "タンパベイ・レイズ", "テキサス・レンジャーズ", "トロント・ブルージェイズ", "ワシントン・ナショナルズ"
];

const NPB_TEAMS = [
    "読売ジャイアンツ", "阪神タイガース", "中日ドラゴンズ", "横浜DeNAベイスターズ", "広島東洋カープ", "東京ヤクルトスワローズ",
    "福岡ソフトバンクホークス", "千葉ロッテマリーンズ", "埼玉西武ライオンズ", "東北楽天ゴールデンイーグルス", "北海道日本ハムファイターズ", "オリックス・バファローズ", "日本代表", "その他"
];

const CARD_BRANDS = [
    "Topps", "Panini", "Upper Deck", "BBM", "EPOCH", "Leaf", "Bowman", "Fleer", "Donruss", "Score", "Select", "Prizm", "Chrome", "Finest", "Other", "Unknown"
];

const CURRENT_YEAR = new Date().getFullYear();
const YEARS = Array.from({ length: CURRENT_YEAR - 1949 }, (_, i) => (CURRENT_YEAR + 1 - i).toString());

// --- Zod Schema ---
const collectionSchema = z.object({
    playerName: z.string().min(1, "Player name is required"),
    team: z.string().min(1, "Team is required"),
    year: z.string().optional(),
    brand: z.string().min(1, "Brand is required"),
    variation: z.string().optional(),
    serialNumber: z.string().optional(),
    isRookie: z.boolean().optional(),
    isAutograph: z.boolean().optional(),
    isGraded: z.boolean().optional(),
    gradingCompany: z.string().optional(),
    grade: z.string().optional(),
    certificationNumber: z.string().optional(),
    condition: z.string().optional(),
    images: z.array(z.string()).min(1, "At least one image is required"),
    status: z.enum(['Draft', 'Active', 'Display', 'Sold']),
    price: z.string().optional(),
}).superRefine((data, ctx) => {
    if (data.status === 'Active' && (!data.price || isNaN(parseInt(data.price)))) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Price is required for active listings",
            path: ["price"],
        });
    }
    if (!data.isGraded && !data.condition) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Condition is required for raw cards",
            path: ["condition"],
        });
    }
});

type CollectionFormData = z.infer<typeof collectionSchema>;

interface AddToShowcaseModalProps {
    isOpen: boolean;
    onClose: () => void;
    onAdded: () => void;
    mode?: 'add' | 'edit';
    initialData?: any;
}

export default function AddToShowcaseModal({ isOpen, onClose, onAdded, mode = 'add', initialData }: AddToShowcaseModalProps) {
    const [images, setImages] = useState<string[]>([]);
    const [selectedImageIndices, setSelectedImageIndices] = useState<number[]>([]);
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null);
    const [uploading, setUploading] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    const [hasAnalyzed, setHasAnalyzed] = useState(false);
    const [suggestedData, setSuggestedData] = useState<any>(null);
    const [country, setCountry] = useState<'USA' | 'JP'>('USA');
    const [isDragging, setIsDragging] = useState(false);

    const {
        register,
        handleSubmit,
        setValue,
        getValues,
        watch,
        reset,
        formState: { errors, isSubmitting }
    } = useForm<CollectionFormData>({
        resolver: zodResolver(collectionSchema),
        defaultValues: {
            playerName: '',
            team: '',
            year: '',
            brand: 'Unknown',
            variation: '',
            serialNumber: '',
            isRookie: false,
            isAutograph: false,
            isGraded: false,
            gradingCompany: 'PSA',
            grade: '10',
            certificationNumber: '',
            condition: '',
            images: [],
            status: 'Draft',
            price: '',
        }
    });

    const status = watch('status');

    const isGraded = watch('isGraded');

    useEffect(() => {
        if (isOpen) {
            reset();
            setHasAnalyzed(false);
            setSuggestedData(null);
            setCountry('USA');

            if (mode === 'edit' && initialData) {
                // Populate for Edit with Catalog Fallback
                setValue('playerName', initialData.player_name || '');
                setValue('team', initialData.team || '');
                setValue('year', (initialData.year || '').toString());
                setValue('brand', initialData.manufacturer || 'Unknown');
                setValue('variation', initialData.variation || ''); // Variation usually not in catalog base
                setValue('serialNumber', initialData.serial_number || '');
                setValue('isRookie', initialData.is_rookie || false);
                setValue('isAutograph', initialData.is_autograph || false);

                // Images
                const existingImages = initialData.images || [];
                setImages(existingImages);
                setValue('images', existingImages);

                // Grading / Condition
                if (initialData.condition_grading?.is_graded) {
                    setValue('isGraded', true);
                    setValue('gradingCompany', initialData.condition_grading.service || 'PSA');
                    setValue('grade', initialData.condition_grading.score?.toString() || '10');
                    setValue('certificationNumber', initialData.condition_grading.certification_number || '');
                } else {
                    setValue('isGraded', false);
                    setValue('condition', initialData.condition_rating || '');
                }

                // Status & Price
                setValue('status', initialData.status as any || 'Draft');
                setValue('price', initialData.price ? initialData.price.toString() : '');
            } else {
                // Reset for Add
                setImages([]);
                setSelectedImageIndices([]);
            }
        }
    }, [isOpen, reset, mode, initialData, setValue]);

    const uploadFiles = async (files: FileList) => {
        setUploading(true);
        const newUrls: string[] = [];
        const supabase = createClient();

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `${fileName}`;

                const { error: uploadError } = await supabase.storage
                    .from('card-images')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabase.storage
                    .from('card-images')
                    .getPublicUrl(filePath);

                newUrls.push(publicUrl);
            }

            const currentImages = getValues('images') || [];
            const updatedImages = [...currentImages, ...newUrls];
            setImages(updatedImages);
            setValue('images', updatedImages);

            if (currentImages.length === 0 && newUrls.length > 0) {
                setSelectedImageIndices([0]);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to upload image(s)');
        } finally {
            setUploading(false);
        }
    };

    const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        if (!e.target.files || e.target.files.length === 0) return;
        await uploadFiles(e.target.files);
    };

    const handleDragOver = (e: React.DragEvent) => { e.preventDefault(); setIsDragging(true); };
    const handleDragLeave = (e: React.DragEvent) => { e.preventDefault(); setIsDragging(false); };
    const handleDrop = async (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
        if (e.dataTransfer.files?.length > 0) await uploadFiles(e.dataTransfer.files);
    };

    const removeImage = (index: number) => {
        const newImages = images.filter((_, i) => i !== index);
        setImages(newImages);
        setValue('images', newImages);
        setSelectedImageIndices(prev => prev.filter(i => i !== index).map(i => i > index ? i - 1 : i));
    };

    const toggleImageSelection = (index: number) => {
        if (selectedImageIndices.includes(index)) {
            setSelectedImageIndices(prev => prev.filter(i => i !== index));
        } else {
            setSelectedImageIndices(prev => [...prev, index]);
        }
    };

    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = "move";
    };

    const handleDragEnter = (e: React.DragEvent, index: number) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;

        const currentImages = [...images];
        const item = currentImages[draggedIndex];
        currentImages.splice(draggedIndex, 1);
        currentImages.splice(index, 0, item);

        setImages(currentImages);
        setValue('images', currentImages);
        setDraggedIndex(index);
    };

    const handleDragEnd = () => {
        setDraggedIndex(null);
    };

    const analyzeImage = async () => {
        if (images.length === 0) return;
        if (selectedImageIndices.length === 0) {
            alert("Please select at least one image to analyze.");
            return;
        }

        setAnalyzing(true);
        try {
            const imageIndex = selectedImageIndices[0];
            const imageUrl = images[imageIndex];

            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64data = reader.result;
                const apiRes = await fetch('/api/analyze-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64data }),
                });
                if (!apiRes.ok) throw new Error('AI Analysis failed');
                const data = await apiRes.json();

                setSuggestedData(data);
                setHasAnalyzed(true);

                // Populate Form
                if (data.playerName?.value) setValue('playerName', data.playerName.value);
                if (data.year?.value) setValue('year', data.year.value);
                if (data.variation?.value) setValue('variation', data.variation.value);
                if (data.serialNumber?.value) setValue('serialNumber', data.serialNumber.value);
                if (data.isRookie?.value === 'true') setValue('isRookie', true);
                if (data.isAutograph?.value === 'true') setValue('isAutograph', true);
                if (data.isGraded?.value === 'true') {
                    setValue('isGraded', true);
                    if (data.gradingCompany?.value) setValue('gradingCompany', data.gradingCompany.value);
                    if (data.grade?.value) setValue('grade', data.grade.value);
                } else if (data.condition?.value) {
                    setValue('condition', data.condition.value);
                }
            };
            reader.readAsDataURL(blob);
        } catch (err) {
            console.error(err);
            alert('AI Analysis failed');
        } finally {
            setAnalyzing(false);
        }
    };

    const onSubmit = async (formData: CollectionFormData) => {
        try {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) throw new Error('Not authenticated');

            const listingData = {
                seller_id: user.id,
                // catalog_id: null, // Removed
                player_name: formData.playerName,
                team: formData.team,
                year: parseInt(formData.year || '0') || null,
                manufacturer: formData.brand,
                variation: formData.variation,
                serial_number: formData.serialNumber,
                is_rookie: formData.isRookie || false,
                is_autograph: formData.isAutograph || false,
                images: formData.images,

                status: formData.status,
                price: formData.price ? parseInt(formData.price) : null,
                condition_grading: {
                    is_graded: formData.isGraded || false,
                    service: formData.isGraded ? formData.gradingCompany : "None",
                    score: formData.isGraded ? parseFloat(formData.grade || '0') : null,
                    certification_number: formData.isGraded ? formData.certificationNumber : null
                },
                condition_rating: !formData.isGraded ? formData.condition : null,
                deleted_at: null, // Clear archived status if edited/added
            };

            if (mode === 'edit' && initialData?.id) {
                // UPDATE
                const { error } = await supabase
                    .from('listing_items')
                    .update(listingData)
                    .eq('id', initialData.id);

                if (error) throw error;
            } else {
                // INSERT
                const { error } = await supabase.from('listing_items').insert(listingData);
                if (error) throw error;
            }

            onAdded();
            onClose();
        } catch (err: any) {
            console.error(err);
            alert('Failed to save to collection: ' + (err.message || 'Unknown error'));
        }
    };

    const renderChip = (label: string, fieldData: any, fieldName: keyof CollectionFormData) => {
        if (!fieldData?.value) return null;
        return (
            <button
                type="button"
                onClick={() => setValue(fieldName, fieldData.value)}
                className="ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-brand-gold/10 text-brand-gold border border-brand-gold/30 hover:bg-brand-gold/20"
            >
                AI: {fieldData.value}
            </button>
        );
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-md overflow-y-auto">
            <div className="glass-panel-premium border border-white/10 rounded-2xl w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto shadow-2xl">
                <button onClick={onClose} className="absolute top-4 right-4 text-brand-platinum/50 hover:text-white transition-colors z-10 p-2 hover:bg-white/5 rounded-full">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>

                <h2 className="text-2xl font-heading font-bold text-white mb-6 flex items-center gap-3">
                    <span className="w-1 h-8 bg-brand-gold rounded-full shadow-[0_0_10px_rgba(234,179,8,0.5)]"></span>
                    {mode === 'edit' ? 'Edit Collection Item' : 'Add to Collection'}
                </h2>

                {/* --- Image Upload (Step 1) --- */}
                <div className="mb-6">
                    <label
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        className={`group relative flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-xl transition-all duration-300 cursor-pointer overflow-hidden ${uploading ? 'opacity-50 cursor-not-allowed' : ''} ${isDragging ? 'border-brand-gold bg-brand-gold/10 scale-[1.02]' : 'border-brand-platinum/20 hover:border-brand-gold/50 hover:bg-brand-gold/5 bg-black/20'}`}
                    >
                        <div className="flex flex-col items-center justify-center">
                            <div className="w-12 h-12 mb-3 rounded-full bg-brand-platinum/5 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                <svg className="w-6 h-6 text-brand-platinum/50 group-hover:text-brand-gold transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </div>
                            <p className="text-sm text-brand-platinum font-medium">Click or Drag to Upload</p>
                            <p className="text-xs text-brand-platinum/50 mt-1">Supports Multiple JPG, PNG</p>
                        </div>
                        <input type="file" accept="image/*" multiple className="hidden" onChange={handleImageUpload} disabled={uploading} />
                        {uploading && <div className="absolute inset-0 bg-brand-dark/80 backdrop-blur-sm flex items-center justify-center rounded-xl"><div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-brand-gold"></div></div>}
                    </label>



                    {/* Thumbnails Grid */}
                    {(images.length > 0 || (mode === 'edit' && images.length > 0)) && (
                        <div className="grid grid-cols-5 gap-2 mt-4">
                            {images.map((img, idx) => (
                                <div
                                    key={idx}
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, idx)}
                                    onDragEnter={(e) => handleDragEnter(e, idx)}
                                    onDragEnd={handleDragEnd}
                                    onDragOver={(e) => e.preventDefault()}
                                    onClick={() => toggleImageSelection(idx)}
                                    className={`relative aspect-[3/4] group cursor-pointer transition-transform ${draggedIndex === idx ? 'opacity-50 scale-105' : ''}`}
                                >
                                    {/* eslint-disable-next-line @next/next/no-img-element */}
                                    <img
                                        src={img}
                                        alt={`Thumbnail ${idx}`}
                                        className={`w-full h-full object-cover rounded-md border transition-all ${selectedImageIndices.includes(idx) ? 'border-brand-gold ring-2 ring-brand-gold/30' : 'border-white/10'}`}
                                    />
                                    {selectedImageIndices.includes(idx) && (
                                        <div className="absolute top-1 right-1 w-4 h-4 bg-brand-gold rounded-full flex items-center justify-center shadow-md">
                                            <svg className="w-3 h-3 text-brand-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>
                                        </div>
                                    )}
                                    <button
                                        type="button"
                                        onClick={(e) => { e.stopPropagation(); removeImage(idx); }}
                                        className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                    >
                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {images.length > 0 && !hasAnalyzed && (
                        <div className="mt-6 flex justify-center">
                            <button
                                onClick={analyzeImage}
                                disabled={analyzing}
                                className="bg-gradient-to-r from-brand-gold to-yellow-400 text-brand-dark font-bold px-8 py-3 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.3)] hover:shadow-[0_0_30px_rgba(234,179,8,0.5)] hover:scale-105 transition-all flex items-center gap-2 text-lg"
                            >
                                {analyzing ? <div className="w-5 h-5 border-2 border-brand-dark border-t-transparent rounded-full animate-spin" /> : <span>✨ AI Auto-Analysis</span>}
                            </button>
                        </div>
                    )}
                </div>

                {/* --- Form (Revealed after Analysis or in Edit Mode) --- */}
                {(hasAnalyzed || mode === 'edit') && (
                    <form onSubmit={handleSubmit(onSubmit as any)} className="space-y-6 animate-fade-in-up">
                        {/* Basic Info */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div className="md:col-span-2">
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Player Name {suggestedData && renderChip("AI", suggestedData.playerName, 'playerName')}</label>
                                <input {...register('playerName')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. Shohei Ohtani" />
                                {errors.playerName && <p className="text-red-400 text-xs mt-1">{errors.playerName.message}</p>}
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Year {suggestedData && renderChip("AI", suggestedData.year, 'year')}</label>
                                <div className="relative">
                                    <select {...register('year')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="" disabled>Select Year</option>
                                        <option value="Unknown">Unknown</option>
                                        {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Brand</label>
                                <div className="relative">
                                    <select {...register('brand')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="Unknown">Unknown</option>
                                        {CARD_BRANDS.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>
                        </div>

                        {/* Team Selection */}
                        <div>
                            <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Team</label>
                            <div className="flex gap-2">
                                <div className="relative w-1/3">
                                    <select value={country} onChange={(e) => setCountry(e.target.value as any)} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                        <option value="JP">🇯🇵 NPB</option>
                                        <option value="USA">🇺🇸 MLB</option>
                                    </select>
                                    <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                </div>
                                <div className="flex-1 relative">
                                    <select {...register('team')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all">
                                        <option value="" disabled>Select Team</option>
                                        {(country === 'USA' ? MLB_TEAMS : NPB_TEAMS).map(t => <option key={t} value={t}>{t}</option>)}
                                        <option value="Other">Other</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                    <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                </div>
                            </div>
                            {errors.team && <p className="text-red-400 text-xs mt-1">{errors.team.message}</p>}
                        </div>

                        {/* Features */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Variation</label>
                                <input {...register('variation')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. Gold Refractor" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Serial #</label>
                                <input {...register('serialNumber')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30" placeholder="e.g. 05/10" />
                            </div>
                        </div>
                        <div className="flex gap-6 p-4 bg-black/20 rounded-xl border border-white/5">
                            <label className="flex items-center gap-3 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isRookie')} className="peer sr-only" />
                                    <div className="w-5 h-5 border-2 border-brand-platinum/30 rounded bg-brand-dark peer-checked:bg-brand-gold peer-checked:border-brand-gold transition-all"></div>
                                    <svg className="absolute w-3 h-3 text-brand-dark left-1 top-1 opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <span className="text-sm font-bold text-brand-platinum group-hover:text-white transition-colors">Rookie (RC)</span>
                            </label>
                            <label className="flex items-center gap-3 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isAutograph')} className="peer sr-only" />
                                    <div className="w-5 h-5 border-2 border-brand-platinum/30 rounded bg-brand-dark peer-checked:bg-brand-gold peer-checked:border-brand-gold transition-all"></div>
                                    <svg className="absolute w-3 h-3 text-brand-dark left-1 top-1 opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <span className="text-sm font-bold text-brand-platinum group-hover:text-white transition-colors">Autograph</span>
                            </label>
                        </div>

                        {/* Condition */}
                        <div className="border-t border-brand-platinum/10 pt-6">
                            <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2">
                                Condition & Grading
                            </h3>
                            <label className="flex items-center gap-3 mb-5 cursor-pointer group">
                                <div className="relative flex items-center">
                                    <input type="checkbox" {...register('isGraded')} className="peer sr-only" />
                                    <div className="w-10 h-6 bg-brand-dark border border-brand-platinum/30 rounded-full peer-checked:bg-brand-green/20 peer-checked:border-brand-green/50 transition-all"></div>
                                    <div className="absolute left-1 top-1 w-4 h-4 bg-brand-platinum rounded-full peer-checked:translate-x-4 peer-checked:bg-brand-green transition-all shadow-sm"></div>
                                </div>
                                <span className="text-sm font-medium text-white">Professionally Graded Listing</span>
                            </label>

                            {isGraded ? (
                                <div className="grid grid-cols-3 gap-3 animate-fade-in-up">
                                    <div className="relative">
                                        <select {...register('gradingCompany')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                            <option value="PSA">PSA</option>
                                            <option value="BGS">BGS</option>
                                            <option value="CGC">CGC</option>
                                            <option value="SGC">SGC</option>
                                        </select>
                                        <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                    </div>
                                    <div className="relative">
                                        <select {...register('grade')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm appearance-none font-bold">
                                            <option value="10">10</option>
                                            <option value="9.5">9.5</option>
                                            <option value="9">9</option>
                                            <option value="8">8</option>
                                            <option value="Authentic">Auth</option>
                                        </select>
                                        <div className="absolute right-2 top-3.5 pointer-events-none text-brand-platinum/50 text-xs">▼</div>
                                    </div>
                                    <input {...register('certificationNumber')} className="bg-black/40 border border-brand-platinum/10 rounded-xl px-3 py-3 text-white text-sm placeholder:text-brand-platinum/30" placeholder="Cert #" />
                                </div>
                            ) : (
                                <div className="animate-fade-in-up">
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Card Condition {suggestedData && renderChip("AI", suggestedData.condition, 'condition')}</label>
                                    <div className="relative">
                                        <select {...register('condition')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 transition-all">
                                            <option value="" disabled>Select Condition...</option>
                                            <option value="Gem Mint">Gem Mint</option>
                                            <option value="Mint">Mint</option>
                                            <option value="Near Mint">Near Mint</option>
                                            <option value="Excellent">Excellent</option>
                                            <option value="Very Good">Very Good</option>
                                            <option value="Poor">Poor</option>
                                        </select>
                                        <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                    </div>
                                    {errors.condition && <p className="text-red-400 text-xs mt-1">{errors.condition.message}</p>}
                                </div>
                            )}
                        </div>

                        {/* Status and Price Section */}
                        <div className="border-t border-brand-platinum/10 pt-6">
                            <h3 className="text-sm font-bold text-white mb-4">Listing Status & Price</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Status</label>
                                    <div className="relative">
                                        <select {...register('status')} className="w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-brand-gold/50 transition-all">
                                            <option value="Draft">Draft (Private)</option>
                                            <option value="Display">Showcase (Public Display)</option>
                                            <option value="Active">Active Listing (For Sale)</option>
                                        </select>
                                        <div className="absolute right-3 top-3.5 pointer-events-none text-brand-platinum/50">▼</div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-brand-platinum mb-1.5 uppercase tracking-wider">Price (¥) {status === 'Active' && <span className="text-red-400">*</span>}</label>
                                    <input
                                        type="number"
                                        {...register('price')}
                                        disabled={status !== 'Active'}
                                        placeholder={status === 'Active' ? "Required" : "Optional"}
                                        className={`w-full bg-black/40 border border-brand-platinum/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-brand-gold/50 transition-all placeholder:text-brand-platinum/30 ${status !== 'Active' ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    />
                                    {errors.price && <p className="text-red-400 text-xs mt-1">{errors.price.message}</p>}
                                </div>
                            </div>
                        </div>

                        <button
                            type="submit"
                            disabled={isSubmitting}
                            className="w-full py-4 bg-gradient-to-r from-brand-blue to-blue-600 hover:from-brand-blue-glow hover:to-blue-500 text-white font-bold rounded-xl transition-all disabled:opacity-50 mt-8 shadow-[0_0_20px_rgba(59,130,246,0.3)] hover:shadow-[0_0_30px_rgba(59,130,246,0.5)] transform hover:scale-[1.01] active:scale-[0.99]"
                        >
                            {isSubmitting ? (
                                <div className="flex items-center justify-center gap-2">
                                    <span>{mode === 'edit' ? 'Save Changes' : 'Adding...'}</span>
                                </div>
                            ) : (mode === 'edit' ? 'Save Changes' : (status === 'Active' ? 'List for Sale' : 'Add to Collection'))}
                        </button>
                    </form>
                )}
            </div>
        </div >
    );
}
</file>

<file path="frontend/components/CardListing.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { useState, useEffect, memo } from 'react';
import { motion } from 'framer-motion';
import { ListingItem } from '../types';
import MomentHistoryBadge from './MomentHistoryBadge';

interface LiveMomentInfo {
    id: string;
    title: string;
    endTime: number;
}

interface ListingItemProps {
    item: ListingItem;
    isLiveMoment?: boolean; // Debug/Live prop
    liveMoments?: LiveMomentInfo[];
}

const EMPTY_LIVE_MOMENTS: LiveMomentInfo[] = [];

const CardListing = memo(({ item, isLiveMoment = false, liveMoments = EMPTY_LIVE_MOMENTS }: ListingItemProps) => {
    const isSold = item.status !== 'Active';
    const [isFlipped, setIsFlipped] = useState(false);
    const hasBackImage = item.images && item.images.length > 1;

    // Multiple Countdown Logic
    const [momentsWithTime, setMomentsWithTime] = useState<(LiveMomentInfo & { timeLeft: string })[]>([]);
    // Initialize with correct value to avoid immediate useEffect setState
    const [isLiveActive, setIsLiveActive] = useState(isLiveMoment || liveMoments.length > 0);

    useEffect(() => {
        // BAIL if nothing to track
        if (!isLiveMoment && liveMoments.length === 0) {
            setIsLiveActive(prev => prev !== false ? false : prev);
            setMomentsWithTime(prev => prev.length !== 0 ? [] : prev);
            return;
        }

        const updateTimers = () => {
            const now = new Date().getTime();
            let anyActive = false;

            const updatedMoments = liveMoments.map((m: LiveMomentInfo) => {
                const distance = m.endTime - now;
                let timeLeft = '00:00';
                if (distance > 0) {
                    anyActive = true;
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timeLeft = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                return { ...m, timeLeft };
            });

            // Deep comparison to avoid redundant renders
            setMomentsWithTime(prev => {
                const isSame = prev.length === updatedMoments.length &&
                    prev.every((p, i) => p.timeLeft === updatedMoments[i].timeLeft && p.id === updatedMoments[i].id);
                return isSame ? prev : updatedMoments;
            });

            const nextLiveActive = isLiveMoment || anyActive;
            setIsLiveActive(prev => prev !== nextLiveActive ? nextLiveActive : prev);
        };

        updateTimers();
        const timer = setInterval(updateTimers, 1000);
        return () => clearInterval(timer);
    }, [isLiveMoment, liveMoments]);

    const handleFlip = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsFlipped(!isFlipped);
    };

    const cardContent = (
        <motion.div
            className={`glass-panel rounded-xl overflow-hidden card-hover h-full flex flex-col relative ${isSold ? 'grayscale-[0.5]' : ''}`}
            animate={isLiveActive ? {
                boxShadow: [
                    "0 0 15px rgba(255, 69, 0, 0.2)",
                    "0 0 30px rgba(255, 69, 0, 0.6)",
                    "0 0 15px rgba(255, 69, 0, 0.2)"
                ],
                borderColor: [
                    "rgba(255, 69, 0, 0.4)",
                    "rgba(255, 69, 0, 1)",
                    "rgba(255, 69, 0, 0.4)"
                ]
            } : {}}
            transition={{
                duration: 2,
                repeat: Infinity,
                ease: "easeInOut"
            }}
            style={{
                borderColor: isLiveActive ? '#FFD700' : ''
            }}
        >
            {/* Image Section */}
            <div className="relative h-72 bg-brand-dark-light group/image perspective-[1000px]">
                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${isFlipped && hasBackImage ? '[transform:rotateY(180deg)]' : ''}`}>
                    {/* Front Image */}
                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden]">
                        {item.images && item.images.length > 0 ? (
                            <Image
                                src={item.images[0]}
                                alt={item.player_name || 'Card Image'}
                                fill
                                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                                className="object-cover"
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full text-brand-platinum/30">
                                No Image
                            </div>
                        )}
                        {/* Live Moment Inner Glow */}
                        {isLiveActive && (
                            <div className="absolute inset-0 shadow-[inset_0_0_30px_rgba(255,215,0,0.3)] mix-blend-overlay pointer-events-none" />
                        )}
                    </div>

                    {/* Back Image */}
                    {hasBackImage && (
                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] bg-brand-dark-light">
                            <Image
                                src={item.images[1]}
                                alt={`${item.player_name || ''} Back`}
                                fill
                                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                                className="object-cover"
                            />
                        </div>
                    )}
                </div>

                {/* Flip Button (Manual) */}
                {hasBackImage && !isSold && (
                    <button
                        onClick={handleFlip}
                        className="absolute bottom-3 right-3 z-20 p-2 rounded-full bg-black/60 text-white hover:bg-brand-blue hover:text-white transition-colors backdrop-blur-sm border border-white/10"
                        title="Flip Card"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                )}

                {/* SOLD Overlay */}
                {isSold && (
                    <div className="absolute inset-0 bg-black/60 flex items-center justify-center z-10 [backface-visibility:hidden]">
                        <div className="border-4 border-red-500 text-red-500 font-bold text-3xl px-6 py-2 transform -rotate-12 tracking-widest uppercase">
                            SOLD
                        </div>
                    </div>
                )}

                {/* Badges */}
                <div className="absolute top-3 right-3 flex flex-col gap-2 items-end z-20 [backface-visibility:hidden]">
                    {isLiveActive && (
                        <div className="flex flex-col gap-1.5 items-end">
                            {/* Priority Header for Debug/Global Live */}
                            {isLiveMoment && momentsWithTime.length === 0 && (
                                <div className="px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold tracking-wider rounded shadow-lg shadow-red-600/40 border border-white/20 flex items-center gap-1.5 animate-pulse">
                                    <span className="text-sm">🔥</span>
                                    LIVE
                                    <span className="ml-1 pl-1 border-l border-white/20 font-mono">60:00</span>
                                </div>
                            )}

                            {/* Individual Moment Countdowns */}
                            {momentsWithTime.map((m) => (
                                <div key={m.id} className="px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold tracking-wider rounded shadow-lg shadow-red-600/40 border border-white/20 flex items-center gap-1.5 animate-pulse">
                                    <span className="text-sm">🔥</span>
                                    {m.title || 'LIVE'}
                                    <span className="ml-1 pl-1 border-l border-white/20 font-mono">{m.timeLeft}</span>
                                </div>
                            ))}
                        </div>
                    )}
                    <span className="bg-black/60 backdrop-blur-sm text-white text-xs px-2 py-1 rounded border border-white/10">
                        {item.year} {item.manufacturer}
                    </span>
                    {item.is_rookie && (
                        <span className="bg-brand-gold text-brand-dark text-xs font-bold px-2 py-1 rounded shadow-lg shadow-brand-gold/20 animate-pulse-slow">
                            RC
                        </span>
                    )}
                </div>
            </div>

            {/* Content Section */}
            <div className="p-5 flex-1 flex flex-col bg-gradient-to-b from-transparent to-black/40">
                <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                        <span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold tracking-wider uppercase bg-brand-blue/20 text-brand-blue border border-brand-blue/30">
                            {item.team}
                        </span>
                        <MomentHistoryBadge history={item.moment_history} />

                    </div>

                    <h2 className="font-heading text-lg font-bold text-white mb-1 group-hover:text-brand-blue-glow transition-colors truncate">
                        {item.player_name}
                    </h2>
                    <p className="text-xs text-brand-platinum/50 font-mono">
                        {item.variation || item.series_name} {item.card_number ? `#${item.card_number}` : ''}
                    </p>
                </div>

                <div className="mt-auto pt-4 border-t border-brand-platinum/10 grid grid-cols-2 gap-4">
                    <div>
                        <p className="text-[10px] text-brand-platinum/50 uppercase tracking-wider mb-1">Price</p>
                        <div className="flex items-center gap-1.5">
                            <div className="w-4 h-4 rounded-full bg-brand-gold flex items-center justify-center shadow-[0_0_10px_rgba(234,179,8,0.5)]">
                                <span className="text-[10px] text-brand-dark font-bold">¥</span>
                            </div>
                            <p className="font-heading text-lg font-bold text-white group-hover:text-brand-gold transition-colors">
                                {item.price?.toLocaleString() ?? '---'}
                            </p>
                        </div>
                    </div>
                    {!isSold && (
                        <div className="text-right border-l border-brand-platinum/10 pl-4">
                            <p className="text-[10px] text-brand-platinum/50 uppercase tracking-wider mb-1">Status</p>
                            <div className="flex items-center justify-end gap-1.5 text-brand-blue-glow">
                                <span className="font-mono text-sm font-medium">Active</span>
                            </div>
                        </div>
                    )}
                </div>
            </div>



            {/* Hover Glow Effect */}
            <div className="absolute inset-0 border-2 border-brand-blue/0 group-hover:border-brand-blue/50 rounded-xl transition-all duration-300 pointer-events-none"></div>
        </motion.div>
    );

    if (isSold) {
        return (
            <div className="block group cursor-not-allowed opacity-80">
                {cardContent}
            </div>
        );
    }

    return (
        <Link href={`/listings/${item.id}`} className="block group">
            {cardContent}
        </Link>
    );
});

export default CardListing;
</file>

<file path="frontend/components/DevTools.tsx">
'use client';

import { createClient } from '../utils/supabase/client';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

const TEST_ACCOUNTS = [
    { email: 'seller@test.com', password: 'password123', label: 'Seller' },
    { email: 'buyer1@test.com', password: 'password123', label: 'Buyer 1' },
    { email: 'buyer2@test.com', password: 'password123', label: 'Buyer 2' },
];

export default function DevTools() {
    // Only show in dev environment (or via feature flag)
    // In Next.js, process.env.NODE_ENV is reliable.
    // However, sometimes it is 'production' even on staging effectively.
    // We can double check if we are on localhost window side or just assume dev.
    const [isOpen, setIsOpen] = useState(false);
    const [status, setStatus] = useState('');
    const supabase = createClient();
    const router = useRouter();

    if (process.env.NODE_ENV === 'production') return null;

    const handleLogin = async (email: string, pass: string) => {
        setStatus(`Logging in as ${email}...`);
        await supabase.auth.signOut();
        const { error } = await supabase.auth.signInWithPassword({
            email,
            password: pass
        });

        if (error) {
            setStatus('Login Failed: ' + error.message);
        } else {
            setStatus('Logged In! Refresing...');
            router.refresh();
            // Force reload to update server components properly
            window.location.href = '/collection';
        }
    };

    const handleCreateLiveMoment = async () => {
        setStatus('Creating Live Moment...');
        try {
            const res = await fetch('/api/dev/moment', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                setStatus(`Moment Created: ${data.moment.title}`);
                router.refresh();
            } else {
                setStatus('Failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e: any) {
            setStatus('Error: ' + e.message);
        }
    };

    return (
        <div className="fixed bottom-4 right-4 z-[9999] font-sans">
            {!isOpen ? (
                <button
                    onClick={() => setIsOpen(true)}
                    className="bg-purple-600/80 hover:bg-purple-600 text-white p-2 rounded-full shadow-lg border border-white/20 backdrop-blur-md text-xs font-bold"
                >
                    🛠️ DEV
                </button>
            ) : (
                <div className="bg-black/90 text-white p-4 rounded-lg shadow-2xl border border-purple-500/50 w-64 backdrop-blur-xl">
                    <div className="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                        <span className="font-bold text-purple-400 text-xs tracking-widest">DEV TOOLS</span>
                        <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-white">✕</button>
                    </div>

                    <div className="space-y-2">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Quick Login</p>
                        <div className="grid grid-cols-2 gap-2">
                            {TEST_ACCOUNTS.map((acc) => (
                                <button
                                    key={acc.email}
                                    onClick={() => handleLogin(acc.email, acc.password)}
                                    className="px-2 py-1.5 bg-gray-800 hover:bg-gray-700 rounded text-xs border border-gray-700 hover:border-purple-500/50 transition-all text-left truncate"
                                    title={acc.email}
                                >
                                    {acc.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="mt-4 pt-4 border-t border-gray-800 space-y-2">
                        <p className="text-[10px] text-gray-500 uppercase font-bold">Actions</p>
                        <button
                            onClick={handleCreateLiveMoment}
                            className="w-full py-1.5 bg-blue-900/40 hover:bg-blue-900/60 rounded text-xs border border-blue-500/30 text-blue-200"
                        >
                            + Live Moment (Use Script)
                        </button>
                    </div>

                    {status && (
                        <div className="mt-3 text-[10px] text-yellow-400 bg-yellow-900/20 p-2 rounded border border-yellow-500/20">
                            {status}
                        </div>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend/components/Footer.tsx">
import Link from 'next/link';

export default function Footer() {
    return (
        <footer className="bg-brand-dark relative mt-20">
            {/* Top Gradient Line */}
            <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-brand-platinum/20 to-transparent"></div>
            <div className="absolute top-[-1px] left-1/4 right-1/4 h-[1px] bg-gradient-to-r from-transparent via-brand-blue/50 to-transparent blur-sm"></div>

            <div className="py-12 relative z-10">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div className="col-span-1 md:col-span-2">
                            <Link href="/" className="flex items-center gap-2 mb-4">
                                <span className="font-heading text-2xl font-bold tracking-tighter text-white">
                                    TC<span className="text-brand-blue">.APP</span>
                                </span>
                            </Link>
                            <p className="text-brand-platinum/60 max-w-sm">
                                The premier marketplace for professional baseball trading cards.
                                Buy, sell, and collect with confidence.
                            </p>
                        </div>

                        <div>
                            <h3 className="font-heading font-bold text-white mb-4">Marketplace</h3>
                            <ul className="space-y-2">
                                <li><Link href="/" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">All Listings</Link></li>
                                <li><Link href="/sell" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">Start Selling</Link></li>
                                <li><Link href="/catalog" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">Card Catalog</Link></li>
                            </ul>
                        </div>

                        <div>
                            <h3 className="font-heading font-bold text-white mb-4">Support</h3>
                            <ul className="space-y-2">
                                <li><Link href="/help" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">Help Center</Link></li>
                                <li><Link href="/terms" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">Terms of Service</Link></li>
                                <li><Link href="/privacy" className="text-brand-platinum/60 hover:text-brand-blue transition-colors">Privacy Policy</Link></li>
                            </ul>
                        </div>
                    </div>

                    <div className="mt-12 pt-8 border-t border-brand-platinum/10 text-center text-brand-platinum/40 text-sm">
                        &copy; {new Date().getFullYear()} TC-APP. All rights reserved.
                    </div>
                </div>
            </div>
        </footer>
    );
}
</file>

<file path="frontend/components/Header.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { usePathname, useRouter } from 'next/navigation';
import { createClient } from '../utils/supabase/client';

export default function Header() {
    const [user, setUser] = useState<any>(null);
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const pathname = usePathname();
    const router = useRouter();
    const supabase = createClient();

    useEffect(() => {
        const getUser = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);
        };
        getUser();

        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
    }, []);

    const handleSignOut = async () => {
        await supabase.auth.signOut();
        setUser(null);
        router.push('/');
        router.refresh();
    };

    const NAV_ITEMS = [
        { name: 'マーケット (Market)', path: '/market' },
        { name: 'コレクション (Collection)', path: '/collection' },
        { name: 'オークション (Auctions)', path: '/auctions' },
        { name: 'コミュニティ (Community)', path: '/community' },
    ];

    return (
        <header className="fixed top-0 left-0 w-full z-50 p-4 md:p-6 pointer-events-none flex flex-col items-center">
            <div className="pointer-events-auto w-full md:max-w-4xl bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-full px-4 py-3 shadow-2xl flex items-center justify-between">
                {/* Logo */}
                <Link href="/" className="flex items-center gap-2 group">
                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-blue to-brand-blue-glow flex items-center justify-center shadow-lg shadow-brand-blue/20 group-hover:shadow-brand-blue/40 transition-all">
                        <span className="font-heading font-bold text-white text-sm">TC</span>
                    </div>
                    <span className="font-heading font-bold text-lg text-white tracking-tight hidden md:block">
                        TC APP
                    </span>
                </Link>

                {/* Desktop Navigation */}
                <nav className="hidden md:flex items-center gap-1">
                    {NAV_ITEMS.map((item) => (
                        <Link
                            key={item.name}
                            href={item.path}
                            className={`px-4 py-2 rounded-full text-xs font-bold tracking-widest transition-all ${pathname === item.path
                                ? 'bg-brand-blue/20 text-brand-blue border border-brand-blue/20 shadow-[0_0_10px_rgba(59,130,246,0.2)]'
                                : 'text-brand-platinum/60 hover:text-white hover:bg-white/5'
                                }`}
                        >
                            {item.name}
                        </Link>
                    ))}
                </nav>

                {/* Actions */}
                <div className="flex items-center gap-3">
                    {user && (
                        <Link
                            href="/sell"
                            className="hidden md:flex items-center gap-2 px-4 py-2 bg-brand-gold text-brand-dark rounded-full text-xs font-bold hover:bg-white transition-colors shadow-lg shadow-brand-gold/20"
                        >
                            <span>出品する</span>
                        </Link>
                    )}

                    {/* User Profile (Desktop Only) */}
                    <div className="relative group hidden md:block">
                        <button
                            className="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center transition-all"
                        >
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-brand-platinum to-brand-platinum/50 overflow-hidden relative">
                                <Image
                                    src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${user?.email || 'Guest'}`}
                                    alt="User"
                                    fill
                                    className="object-cover"
                                />
                            </div>
                        </button>

                        {/* Dropdown Menu (Desktop) */}
                        <div className="absolute top-full right-0 mt-2 w-48 bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                            <div className="p-2 space-y-1">
                                {user ? (
                                    <>
                                        <div className="px-3 py-2 text-xs text-brand-platinum/60 border-b border-white/5 mb-1">
                                            ログイン中:<br />
                                            <span className="text-white font-bold truncate block">{user.email}</span>
                                        </div>
                                        <Link href="/profile" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                            マイページ
                                        </Link>
                                        <Link href="/collection" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                            マイコレクション
                                        </Link>
                                        <Link href="/payouts" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />
                                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5" />
                                                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z" />
                                            </svg>
                                            売上・振込
                                        </Link>

                                        {/* Admin Link (Only for authorized emails) */}
                                        {(() => {
                                            const adminEmails = (process.env.NEXT_PUBLIC_ADMIN_EMAILS || '').split(',').map(e => e.trim().toLowerCase());
                                            if (user?.email && adminEmails.includes(user.email.toLowerCase())) {
                                                return (
                                                    <Link href="/admin" className="block px-3 py-2 rounded-lg bg-brand-gold/10 text-brand-gold hover:bg-brand-gold/20 text-xs font-bold transition-colors mt-2 text-center border border-brand-gold/20">
                                                        管理画面
                                                    </Link>
                                                );
                                            }
                                            return null;
                                        })()}
                                        <button
                                            onClick={handleSignOut}
                                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-red-500/10 text-sm text-red-400 hover:text-red-300 transition-colors"
                                        >
                                            ログアウト
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <>
                                            <Link href="/login" className="block px-3 py-2 rounded-lg hover:bg-white/5 text-sm text-brand-platinum hover:text-white transition-colors">
                                                ログイン
                                            </Link>
                                            <Link href="/register" className="block px-3 py-2 rounded-lg hover:bg-brand-blue/10 text-sm text-brand-blue hover:text-brand-blue-glow transition-colors">
                                                新規登録
                                            </Link>
                                        </>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Mobile Menu Toggle (Visible on Mobile only) */}
                    <button
                        onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                        className="md:hidden w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center transition-all bg-brand-dark text-white"
                        aria-label="Menu"
                    >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {isMobileMenuOpen ? (
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            ) : (
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" />
                            )}
                        </svg>
                    </button>
                </div>
            </div>

            {/* Mobile Menu Overlay */}
            {isMobileMenuOpen && (
                <div className="pointer-events-auto w-full md:max-w-4xl mt-2 bg-brand-dark-light/95 backdrop-blur-xl border border-white/10 rounded-2xl p-4 shadow-2xl md:hidden flex flex-col gap-2 animate-fade-in-up">
                    {NAV_ITEMS.map((item) => (
                        <Link
                            key={item.name}
                            href={item.path}
                            onClick={() => setIsMobileMenuOpen(false)}
                            className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm"
                        >
                            {item.name}
                        </Link>
                    ))}
                    {user && (
                        <>
                            <Link href="/profile" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm">マイページ</Link>
                            <Link href="/payouts" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl hover:bg-white/5 text-brand-platinum font-bold text-sm">売上・振込設定</Link>
                            <Link href="/sell" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl bg-brand-gold/10 text-brand-gold font-bold text-sm text-center border border-brand-gold/20">出品する</Link>
                        </>
                    )}
                    {user ? (
                        <button onClick={() => { handleSignOut(); setIsMobileMenuOpen(false); }} className="p-3 rounded-xl bg-red-500/10 text-red-400 font-bold text-sm text-center border border-red-500/20 mt-2">ログアウト</button>
                    ) : (
                        <Link href="/login" onClick={() => setIsMobileMenuOpen(false)} className="p-3 rounded-xl bg-brand-blue/10 text-brand-blue font-bold text-sm text-center border border-brand-blue/20 mt-2">ログイン</Link>
                    )}
                </div>
            )}
        </header>
    );
}
</file>

<file path="frontend/components/HeroSection.tsx">
'use client';

import Link from 'next/link';
import { useEffect, useState } from 'react';
import { ListingItem } from '../types';

import { createClient } from '../utils/supabase/client';

export default function HeroSection() {
    const [user, setUser] = useState<any>(null);
    const [featuredCard, setFeaturedCard] = useState<ListingItem | null>(null);

    useEffect(() => {
        const fetchFeaturedAndUser = async () => {
            const supabase = createClient();

            // Fetch User
            const { data: { user } } = await supabase.auth.getUser();
            setUser(user);

            // Fetch Featured Card
            try {
                const { data, error } = await supabase
                    .from('listing_items')
                    .select('*')
                    .eq('status', 'Active')
                    .not('price', 'is', null)
                    .order('price', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    setFeaturedCard(data[0] as any);
                }
            } catch (error) {
                console.error("Failed to fetch featured card:", error);
            }
        };
        fetchFeaturedAndUser();
    }, []);

    return (
        <section className="relative w-full min-h-[90vh] flex flex-col items-center justify-center bg-brand-dark pt-32 pb-48">
            {/* Spotlight Effects */}
            <div className="absolute inset-0 z-0 pointer-events-none">
                {/* Main Top Spotlight */}
                <div className="absolute top-[-20%] left-1/2 -translate-x-1/2 w-[800px] h-[800px] bg-brand-gold/20 rounded-full blur-[100px] opacity-60 animate-pulse-slow"></div>
                {/* Side Blue Glows */}
                <div className="absolute top-[20%] left-[-10%] w-[600px] h-[600px] bg-brand-blue/10 rounded-full blur-[120px]"></div>
                <div className="absolute top-[20%] right-[-10%] w-[600px] h-[600px] bg-brand-blue/10 rounded-full blur-[120px]"></div>
                {/* Grid Pattern */}
                <div className="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-20 bg-center"></div>
            </div>

            {/* Floating Card Display */}
            <div className="relative z-10 mb-12 animate-float">
                <div className="relative w-64 h-96 md:w-80 md:h-[500px] rounded-2xl p-2 bg-gradient-to-b from-brand-platinum/20 to-brand-dark-light/80 backdrop-blur-md border border-brand-platinum/30 shadow-[0_0_50px_rgba(59,130,246,0.3)]">
                    {/* Spotlight Beam */}
                    <div className="absolute -top-[150%] left-1/2 -translate-x-1/2 w-[100px] h-[500px] bg-gradient-to-b from-white/20 via-brand-gold/10 to-transparent blur-xl rotate-[15deg] transform-origin-top animate-pulse-slow pointer-events-none z-20"></div>

                    {/* Inner Card Frame */}
                    <div className="w-full h-full rounded-xl overflow-hidden relative border border-brand-blue/30 bg-brand-dark-light group cursor-pointer">
                        {featuredCard ? (
                            <Link href={`/listings/${featuredCard.id}`}>
                                {/* Card Image */}
                                <div className="absolute inset-0 bg-gradient-to-br from-brand-dark-light to-brand-blue/20 flex items-center justify-center">
                                    {!featuredCard.images?.[0] && <span className="text-brand-platinum/20 font-heading text-6xl font-bold">TC</span>}
                                </div>
                                {featuredCard.images?.[0] && (
                                    <img
                                        src={featuredCard.images[0]}
                                        alt={featuredCard.player_name || 'Card Image'}
                                        className="w-full h-full object-cover opacity-90 transition-opacity group-hover:opacity-100"
                                    />
                                )}

                                {/* Holo Effect Overlay */}
                                <div className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50 group-hover:opacity-70 transition-opacity"></div>

                                {/* Shimmer Effect */}
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 animate-shimmer pointer-events-none"></div>

                                {/* Card Details Overlay */}
                                <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                                    <div className="flex justify-between items-end">
                                        <div>
                                            <p className="text-brand-gold text-xs font-bold tracking-widest mb-1 uppercase">
                                                {'PREMIUM'}
                                            </p>
                                            <h3 className="text-white font-heading text-xl font-bold leading-tight">
                                                {featuredCard.player_name || 'Unknown Player'}
                                            </h3>
                                            <p className="text-brand-platinum/80 text-xs mt-1">
                                                {featuredCard.year || ''} {featuredCard.manufacturer || ''}
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-brand-gold text-gold-glow text-lg font-bold">
                                                ¥{featuredCard.price?.toLocaleString() ?? '---'}
                                            </p>
                                            {featuredCard.condition_grading?.is_graded && (
                                                <p className="text-brand-platinum/60 text-[10px] uppercase">
                                                    {featuredCard.condition_grading.service} {featuredCard.condition_grading.score}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </Link>
                        ) : (
                            // Loading / Placeholder State
                            <div className="w-full h-full flex items-center justify-center bg-brand-dark-light">
                                <div className="animate-pulse flex flex-col items-center">
                                    <div className="h-12 w-12 border-2 border-brand-blue border-t-transparent rounded-full animate-spin mb-4"></div>
                                    <p className="text-brand-platinum/50 text-sm">Loading Featured Card...</p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Outer Glow Ring */}
                    <div className="absolute -inset-4 border border-brand-blue/20 rounded-3xl -z-10 animate-pulse-slow"></div>
                    <div className="absolute -inset-1 bg-gradient-to-b from-brand-gold/20 to-transparent rounded-2xl -z-10 blur-md"></div>
                    {/* Rotating Glow */}
                    <div className="absolute -inset-[100%] bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,215,0,0.1)_90deg,transparent_180deg)] rounded-full animate-rotate-slow -z-20 opacity-50 blur-2xl"></div>
                </div>
            </div>

            <div className="relative z-10 container mx-auto px-4 text-center">
                <h1 className="font-heading text-5xl md:text-7xl font-bold mb-4 tracking-tight animate-fade-in-up">
                    <span className="text-brand-gold drop-shadow-[0_0_15px_rgba(234,179,8,0.3)]">THE FUTURE OF TRADING.</span><br />
                    <span className="text-brand-blue drop-shadow-[0_0_15px_rgba(59,130,246,0.3)]">
                        COLLECT THE UNTOUCHABLE.
                    </span>
                </h1>

                <p className="text-brand-platinum/80 text-lg md:text-xl mb-10 max-w-2xl mx-auto animate-fade-in-up delay-200">
                    Experience the next generation of sports card collecting.
                    Verify, trade, and showcase your assets in a premium ecosystem.
                </p>

                <div className="flex flex-col md:flex-row gap-6 justify-center">
                    {user ? (
                        <Link
                            href="/market"
                            className="group relative px-8 py-4 bg-brand-blue text-white font-bold rounded-full overflow-hidden transition-all hover:scale-105 shadow-[0_0_20px_rgba(59,130,246,0.5)]"
                        >
                            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                            <span className="relative z-10">EXPLORE MARKETPLACE</span>
                        </Link>
                    ) : (
                        <>
                            <Link
                                href="/register"
                                className="group relative px-8 py-4 bg-brand-gold text-brand-dark font-bold rounded-full overflow-hidden transition-all hover:scale-105 shadow-[0_0_20px_rgba(234,179,8,0.3)]"
                            >
                                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                                <span className="relative z-10">SIGN UP NOW</span>
                            </Link>
                            <Link
                                href="/login"
                                className="px-8 py-4 bg-white/5 text-white font-bold rounded-full border border-white/10 hover:bg-white/10 transition-all hover:scale-105 backdrop-blur-md"
                            >
                                SIGN IN
                            </Link>
                        </>
                    )}
                </div>
            </div>
        </section>
    );
}
</file>

<file path="frontend/components/LiveMomentListener.tsx">
"use client";

import { useEffect, useState } from "react";
import { createBrowserClient } from "@supabase/ssr";
import LiveMomentToast, { LiveMomentData } from "./LiveMomentToast";

export default function LiveMomentListener() {
    const [moment, setMoment] = useState<LiveMomentData | null>(null);

    // Initialize Supabase Client (Stable outside effect if possible, or memoized)
    // For simplicity and stability in App Router, we can initialize it once
    const [supabase] = useState(() => createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key'
    ));

    useEffect(() => {
        // Subscribe to INSERT events on 'live_moments' table
        const channel = supabase
            .channel("live-moments-channel")
            .on(
                "postgres_changes",
                {
                    event: "INSERT",
                    schema: "public",
                    table: "live_moments",
                },
                (payload) => {
                    const newMoment = payload.new as LiveMomentData;

                    // Trigger Toast
                    setMoment(newMoment);

                    // Auto-hide after 8 seconds (longer for reading)
                    setTimeout(() => {
                        setMoment(null);
                    }, 8000);
                }
            )
            .subscribe();

        // Cleanup subscription
        return () => {
            supabase.removeChannel(channel);
        };
    }, [supabase]);

    return (
        <LiveMomentToast
            data={moment}
            onDismiss={() => setMoment(null)}
        />
    );
}
</file>

<file path="frontend/components/LiveMomentToast.tsx">
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import { AnimatePresence, motion } from "framer-motion";

export type LiveMomentData = {
    id: string;
    player_name: string;
    type: "HOMERUN" | "BIG_PLAY" | "VICTORY" | "RECORD_BREAK" | "system_notice";
    title: string;
    description?: string;
    intensity: number; // 1-5
};

interface LiveMomentToastProps {
    data: LiveMomentData | null;
    onDismiss: () => void;
}

export default function LiveMomentToast({ data, onDismiss }: LiveMomentToastProps) {
    const router = useRouter();

    if (!data) return null;

    // Determine colors based on intensity/type
    // User Request: Make ALL notifications Gold (Premium Look)
    const isGold = true;

    // Base styles
    const containerClasses = isGold
        ? "bg-gradient-to-r from-brand-gold/90 to-brand-gold-glow/90 border-brand-gold text-brand-dark"
        : "bg-brand-dark-light/95 border-brand-blue/30 text-white backdrop-blur-xl";

    const handleClick = () => {
        router.push(`/market?search=${encodeURIComponent(data.player_name)}&sort=newest`);
        onDismiss();
    };

    return (
        <AnimatePresence>
            <div className="fixed top-24 right-4 md:right-8 z-[100] w-full max-w-sm pointer-events-none">
                <motion.div
                    initial={{ opacity: 0, y: -50, scale: 0.9 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, x: 100, scale: 0.9 }}
                    transition={{ type: "spring", stiffness: 300, damping: 25 }}
                    onClick={handleClick}
                    className={`
                        pointer-events-auto p-4 rounded-xl border shadow-2xl overflow-hidden relative cursor-pointer group
                        ${containerClasses}
                        hover:scale-105 transition-transform duration-300
                    `}
                >
                    {/* Intensity Particles/Glow (Simplified CSS) */}
                    {isGold && (
                        <div className="absolute inset-0 bg-[url('/noise.png')] opacity-10 mix-blend-overlay" />
                    )}
                    {data.intensity === 5 && (
                        <div className="absolute inset-0 animate-pulse bg-brand-gold/20 z-0" />
                    )}

                    <div className="relative z-10 flex flex-col gap-1">
                        <div className="flex items-center justify-between">
                            <span className={`text-[10px] font-bold tracking-widest uppercase px-2 py-0.5 rounded-full border ${isGold ? 'border-brand-dark/20 bg-brand-dark/10' : 'border-white/10 bg-white/5'}`}>
                                {data.type.replace('_', ' ')}
                            </span>
                            <button
                                onClick={(e) => { e.stopPropagation(); onDismiss(); }}
                                className="opacity-60 hover:opacity-100 p-1"
                            >
                                ×
                            </button>
                        </div>

                        <h4 className={`font-heading font-bold text-lg leading-tight mt-1 ${isGold ? 'text-brand-dark' : 'text-white'}`}>
                            {data.title}
                        </h4>

                        <p className={`text-sm font-bold opacity-80 ${isGold ? 'text-brand-dark' : 'text-brand-platinum'}`}>
                            {data.player_name}
                        </p>

                        {data.description && (
                            <p className={`text-xs mt-1 leading-relaxed ${isGold ? 'text-brand-dark/80' : 'text-brand-platinum/60'}`}>
                                {data.description}
                            </p>
                        )}

                        {/* CTA Button */}
                        <div className="mt-3 flex justify-end">
                            <span className={`text-[10px] font-bold uppercase tracking-wider flex items-center gap-1 ${isGold ? 'text-brand-dark group-hover:underline' : 'text-white'}`}>
                                Check Cards
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                            </span>
                        </div>
                    </div>
                </motion.div>
            </div>
        </AnimatePresence>
    );
}
</file>

<file path="frontend/components/MarketPriceLinks.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Search, ExternalLink, ShoppingBag, Gavel, Globe } from 'lucide-react';

interface MarketPriceLinksProps {
    initialQuery: string;
}

export default function MarketPriceLinks({ initialQuery }: MarketPriceLinksProps) {
    const [query, setQuery] = useState(initialQuery);

    // Sync state if prop changes (e.g. AI re-analyzes)
    useEffect(() => {
        setQuery(initialQuery);
    }, [initialQuery]);

    const openSearch = (urlTemplate: string) => {
        if (!query.trim()) return;
        const encodedQuery = encodeURIComponent(query.trim());
        const url = urlTemplate.replace('{encodedQuery}', encodedQuery);
        window.open(url, '_blank', 'noopener,noreferrer');
    };

    return (
        <div className="glass-panel p-4 rounded-xl border border-white/10 animate-fade-in-up">
            <div className="flex flex-col gap-3">
                <div className="flex justify-between items-center">
                    <label className="text-sm font-bold text-brand-platinum flex items-center gap-2">
                        <Search className="w-4 h-4" />
                        相場をチェック (参考)
                    </label>
                </div>

                {/* Editable Query Input */}
                <div className="relative">
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-brand-blue/50 transition-colors"
                        placeholder="キーワードを入力 (例: 大谷翔平 2024)"
                    />
                    <div className="absolute right-3 top-2.5 pointer-events-none">
                        <span className="text-xs text-brand-platinum/50">キーワードを編集</span>
                    </div>
                </div>

                {/* Market Buttons */}
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-1">
                    {/* Mercari */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://jp.mercari.com/search?keyword={encodedQuery}&status=sold_out_processing,sold_out')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all text-sm font-medium group"
                    >
                        <ShoppingBag className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>Mercari</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>

                    {/* Yahoo Auction */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://auctions.yahoo.co.jp/search/search?p={encodedQuery}&aucmaxprice=999999999&istatus=2')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 hover:bg-yellow-500/20 transition-all text-sm font-medium group"
                    >
                        <Gavel className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>Yahoo!</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>

                    {/* eBay */}
                    <button
                        type="button"
                        onClick={() => openSearch('https://www.ebay.com/sch/i.html?_nkw={encodedQuery}&LH_Sold=1')}
                        className="flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 hover:bg-blue-500/20 transition-all text-sm font-medium group"
                    >
                        <Globe className="w-4 h-4 group-hover:scale-110 transition-transform" />
                        <span>eBay</span>
                        <ExternalLink className="w-3 h-3 opacity-50" />
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/MomentHistoryBadge.tsx">
import React from 'react';

interface MomentHistoryBadgeProps {
    history?: any[];
    liveCount?: number;
}

export default function MomentHistoryBadge({ history, liveCount = 0 }: MomentHistoryBadgeProps) {
    const historyCount = history?.length || 0;
    const total = historyCount + liveCount;

    if (total === 0) return null;

    return (
        <div className="bg-orange-500/90 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 border border-orange-300 shadow-sm backdrop-blur-sm">
            <span className="text-[10px]">🏆</span>
            <span>{total} Moments</span>
        </div>
    );
}
</file>

<file path="frontend/components/MomentHistoryPanel.tsx">
import { addMomentMemory, editMomentMemory, deleteMomentMemory, toggleHideMoment, toggleHideMomentMemory } from '../app/actions/item';
import { createClient } from '../utils/supabase/client';
import { useEffect, useState } from 'react';

interface MomentHistoryPanelProps {
    history?: any[];
    itemId?: string;
    isOwner?: boolean;
    onSuccess?: () => void;
}

export default function MomentHistoryPanel({ history, itemId, isOwner, onSuccess }: MomentHistoryPanelProps) {
    // State for managing the modal
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [targetMomentIndex, setTargetMomentIndex] = useState<number | null>(null);
    const [targetMomentId, setTargetMomentId] = useState<string | undefined>(undefined);

    // If editing an existing memory
    const [editingMemoryId, setEditingMemoryId] = useState<string | null>(null);

    const [noteContent, setNoteContent] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [currentUser, setCurrentUser] = useState<any>(null);
    const [expandedMemoryIds, setExpandedMemoryIds] = useState<string[]>([]);

    const togglePeek = (memoryId: string) => {
        setExpandedMemoryIds(prev =>
            prev.includes(memoryId)
                ? prev.filter(id => id !== memoryId)
                : [...prev, memoryId]
        );
    };

    useEffect(() => {
        const fetchUser = async () => {
            const supabase = createClient();
            const { data: { user } } = await supabase.auth.getUser();
            setCurrentUser(user);
        };
        fetchUser();
    }, []);

    if (!history || !Array.isArray(history) || history.length === 0) return null;

    // --- Actions ---

    const openAddModal = (index: number, moment: any) => {
        if (!itemId) {
            alert('購入者情報を同期中です。1分ほどお待ちください。 (Possession syncing...)');
            return;
        }
        setTargetMomentIndex(index);
        setTargetMomentId(moment.moment_id);
        setEditingMemoryId(null); // Adding new
        setNoteContent('');
        setIsModalOpen(true);
    };

    const openEditModal = (index: number, moment: any, memory: any) => {
        if (!itemId) return;
        setTargetMomentIndex(index);
        setTargetMomentId(moment.moment_id);
        setEditingMemoryId(memory.id);
        setNoteContent(memory.text || '');
        setIsModalOpen(true);
    };

    const handleSave = async () => {
        if (!itemId || targetMomentIndex === null) return;

        setIsSubmitting(true);
        try {
            // Note: history is displayed reversed, so we need original index if using array index
            // But we prefer momentId if available. Let's pass array index as fallback.
            // Re-calculate original index from the displayed index (which comes from the mapped reversed slice?)
            // Wait, the map below uses `history.slice().reverse().map(...)`.
            // So `index` passed here is the Display Index.
            // Original Index = (Length - 1) - Display Index.
            const originalIndex = history.length - 1 - targetMomentIndex;

            if (editingMemoryId) {
                await editMomentMemory(itemId, originalIndex, editingMemoryId, noteContent, targetMomentId);
            } else {
                await addMomentMemory(itemId, originalIndex, noteContent, targetMomentId);
            }

            setIsModalOpen(false);
            if (onSuccess) onSuccess();
        } catch (error: any) {
            alert(error.message || 'Failed to save note');
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleDelete = async (displayIndex: number, moment: any, memoryId: string) => {
        if (!itemId) return;

        const originalIndex = history.length - 1 - displayIndex;
        const memory = moment.memories?.find((m: any) => m.id === memoryId);
        if (!memory) return;

        if (!confirm("このメッセージを完全に消去しますか？ この操作は取り消せません。")) return;

        try {
            await deleteMomentMemory(itemId, originalIndex, memoryId, moment.moment_id);
            if (onSuccess) onSuccess();
        } catch (err: any) { alert(err.message); }
    };

    const handleToggleHide = async (displayIndex: number, moment: any, memoryId: string) => {
        if (!itemId) return;
        const originalIndex = history.length - 1 - displayIndex;
        try {
            await toggleHideMomentMemory(itemId, originalIndex, memoryId, moment.moment_id);
            if (onSuccess) onSuccess();
        } catch (err: any) {
            alert(err.message);
        }
    };

    return (
        <div className="border-t border-brand-platinum/10 py-8">
            <div className="flex items-center justify-between mb-6">
                <h3 className="text-xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-gold via-white to-brand-gold animate-shimmer bg-[length:200%_100%] uppercase tracking-widest flex items-center gap-3">
                    <span className="text-2xl">⚡</span>
                    Legendary History / 伝説の記録
                </h3>
                <div className="px-4 py-1.5 rounded-full bg-gradient-to-r from-orange-500 to-red-600 text-white text-xs font-bold uppercase tracking-wider flex items-center gap-2 shadow-[0_0_15px_rgba(234,88,12,0.4)] border border-white/20">
                    <span>🏆</span>
                    {history.length} Moments
                </div>
            </div>

            <div className="space-y-6">
                {history.slice().reverse().map((moment: any, index: number) => (
                    <div
                        key={index}
                        className="relative overflow-hidden rounded-xl bg-gradient-to-br from-gray-900 via-black to-gray-800 border border-amber-400/30 p-1 group hover:border-amber-400/60 transition-all duration-500 hover:shadow-[0_0_20px_rgba(251,191,36,0.15)]"
                    >
                        {/* Background Effects */}
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20 pointer-events-none mix-blend-overlay"></div>
                        <div className="absolute -right-20 -top-20 w-64 h-64 bg-amber-500/10 rounded-full blur-[80px] group-hover:bg-amber-500/20 transition-colors duration-500"></div>

                        <div className="relative bg-black/40 backdrop-blur-sm rounded-lg p-5 md:p-6 flex flex-col md:flex-row gap-6 items-start md:items-center">

                            {/* Icon / Intensity Badge */}
                            <div className="flex-shrink-0">
                                <div className="w-16 h-16 rounded-xl bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center shadow-lg border border-white/20 transform group-hover:scale-105 transition-transform duration-300">
                                    <div className="text-3xl filter drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]">
                                        {moment.intensity >= 90 ? '🔥' : '⚾'}
                                    </div>
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="flex-1 w-full">
                                <div className="flex flex-wrap items-center justify-between gap-2 mb-2">
                                    <span className="text-xs font-mono text-amber-500/80 tracking-widest uppercase flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
                                        {new Date(moment.timestamp).toLocaleDateString()}
                                    </span>

                                    <div className="flex items-center gap-2">
                                        {/* Status Badge */}
                                        {(() => {
                                            const now = new Date().getTime();
                                            const momentTime = new Date(moment.timestamp).getTime();
                                            const isRecent = now - momentTime < 60 * 60 * 1000;
                                            const isFinalized = moment.status === 'finalized';

                                            if (isFinalized) {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-green-500/10 text-green-400 border border-green-500/20 uppercase">Match End</span>;
                                            } else if (isRecent) {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-red-500/20 text-red-500 border border-red-500/30 animate-pulse uppercase flex items-center gap-1"><span className="w-1.5 h-1.5 bg-red-500 rounded-full"></span>Live</span>;
                                            } else {
                                                return <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-orange-500/10 text-orange-400 border border-orange-500/20 uppercase">Live End</span>;
                                            }
                                        })()}
                                    </div>
                                </div>

                                <h4 className="text-xl md:text-2xl font-bold text-white mb-2 group-hover:text-amber-400 transition-colors duration-300">
                                    {moment.title}
                                </h4>

                                <p className="text-sm text-gray-300 mb-3 leading-relaxed">
                                    {moment.description}
                                </p>

                                {/* ---------------- Memories Section ---------------- */}
                                <div className="mt-6 space-y-4">

                                    {/* Legacy Note Support */}
                                    {moment.user_note && (
                                        <div className="p-3 rounded-lg bg-white/5 border border-white/10 relative group/note">
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-[10px] text-brand-gold uppercase tracking-wider font-bold">Previous Note</span>
                                                <span className="text-[10px] text-gray-500">{new Date(moment.note_updated_at || moment.timestamp).toLocaleDateString()}</span>
                                            </div>
                                            <p className="text-sm text-gray-300 italic font-serif leading-relaxed">"{moment.user_note}"</p>
                                        </div>
                                    )}

                                    {/* New Memories Array */}
                                    {moment.memories && Array.isArray(moment.memories) && moment.memories.map((memory: any) => {
                                        const isAuthor = currentUser?.id === memory.author_id;
                                        const canManage = isAuthor || isOwner;

                                        // New Visibility Logic:
                                        // 1. If visible -> Show to everyone
                                        // 2. If hidden -> Show placeholder to everyone, show content ONLY to Owner, Author, OR if the user is "peeking"
                                        const isPeeking = expandedMemoryIds.includes(memory.id);
                                        const showContent = !memory.is_hidden || canManage || isPeeking;

                                        return (
                                            <div key={memory.id} className={`rounded-xl border relative group/mem transition-all duration-300 ${memory.is_hidden ? 'p-2 bg-black/40 border-white/5 opacity-50' : 'p-4 bg-brand-gold/5 border-brand-gold/20'}`}>
                                                {/* Header / Info Line */}
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-6 h-6 rounded-full bg-gradient-to-br from-gray-700 to-black border border-white/20 flex items-center justify-center text-[10px] font-bold text-white">
                                                            {memory.author_name ? memory.author_name[0] : 'U'}
                                                        </div>
                                                        <span className="text-xs text-brand-platinum font-bold">{memory.author_name}</span>
                                                        {memory.is_hidden && (
                                                            <span className="text-[10px] text-gray-500 font-mono italic">
                                                                (Private History - Hidden)
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-[10px] text-brand-platinum/40 font-mono">
                                                            {new Date(memory.created_at).toLocaleDateString()}
                                                        </span>
                                                        {/* Inline Actions for Hidden state (Unhide - Owner/Author only) */}
                                                        {memory.is_hidden && canManage && (
                                                            <button
                                                                onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                className="text-[10px] uppercase font-bold text-brand-gold hover:underline"
                                                            >
                                                                Unhide
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Body */}
                                                <div className="mt-2 animate-fade-in text-left">
                                                    {(showContent && !memory.is_hidden) || (isPeeking) ? (
                                                        <>
                                                            <p className={`text-sm italic font-serif leading-relaxed pl-2 border-l-2 ${memory.is_hidden ? 'text-gray-500 border-gray-700 font-sans' : 'text-brand-gold/90 border-brand-gold/30'}`}>
                                                                {memory.text}
                                                            </p>
                                                            {/* Actions for visible/owner/author context */}
                                                            <div className="flex gap-2 justify-end mt-2 opacity-0 group-hover/mem:opacity-100 transition-opacity">
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => openEditModal(index, moment, memory)}
                                                                        className="text-[10px] uppercase font-bold text-brand-gold hover:underline"
                                                                    >
                                                                        Edit
                                                                    </button>
                                                                )}
                                                                {canManage && (
                                                                    <button
                                                                        onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-brand-platinum/60 hover:text-white hover:underline"
                                                                    >
                                                                        {memory.is_hidden ? 'Unhide' : 'Hide'}
                                                                    </button>
                                                                )}
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => handleDelete(index, moment, memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-red-500/60 hover:text-red-400 hover:underline"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                )}
                                                                {/* Close Peek button */}
                                                                {isPeeking && (
                                                                    <button
                                                                        onClick={() => togglePeek(memory.id)}
                                                                        className="text-[10px] uppercase font-bold text-gray-500 hover:underline"
                                                                    >
                                                                        Close
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </>
                                                    ) : (
                                                        <div className="flex items-center justify-between pl-2 border-l border-white/10">
                                                            <p className="text-[10px] text-brand-platinum/20 italic">
                                                                想い出の内容は非表示に設定されています。
                                                            </p>
                                                            <div className="flex gap-3">
                                                                {canManage && (
                                                                    <button
                                                                        onClick={() => handleToggleHide(index, moment, memory.id)}
                                                                        className="text-[10px] text-brand-gold/60 hover:text-brand-gold font-bold uppercase tracking-wider"
                                                                    >
                                                                        Unhide
                                                                    </button>
                                                                )}
                                                                {isAuthor && (
                                                                    <button
                                                                        onClick={() => handleDelete(index, moment, memory.id)}
                                                                        className="text-[10px] text-red-500/40 hover:text-red-500 font-bold uppercase tracking-wider"
                                                                    >
                                                                        Delete
                                                                    </button>
                                                                )}
                                                                <button
                                                                    onClick={() => togglePeek(memory.id)}
                                                                    className="text-[10px] text-brand-gold/60 hover:text-brand-gold font-bold uppercase tracking-wider"
                                                                >
                                                                    内容を確認する (Peek)
                                                                </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {/* Add Button */}
                                    {isOwner && !moment.is_virtual && (
                                        <button
                                            onClick={() => openAddModal(index, moment)}
                                            className="w-full py-2 rounded-lg border border-dashed border-white/20 text-white/40 text-xs hover:bg-white/5 hover:text-brand-gold hover:border-brand-gold/30 transition-all flex items-center justify-center gap-2"
                                        >
                                            <span>✍️</span> 想い出を記録する
                                        </button>
                                    )}
                                    {isOwner && moment.is_virtual && (
                                        <div className="w-full py-2 rounded-lg border border-dashed border-white/10 text-brand-platinum/20 text-[10px] text-center italic select-none">
                                            ※所有者に関連付けられていないため記録できません
                                        </div>
                                    )}
                                </div>

                                {/* Match Result */}
                                {moment.match_result && (
                                    <div className="inline-flex items-center gap-3 bg-white/5 border border-white/10 rounded-lg px-4 py-2 mt-4">
                                        <span className="text-[10px] uppercase text-gray-500 font-bold tracking-wider">Result</span>
                                        <span className="text-sm font-mono font-bold text-amber-300 tracking-wide">
                                            {moment.match_result}
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl animate-fade-in">
                    <div className="glass-panel-premium border border-brand-gold/30 rounded-2xl w-full max-w-md p-6 shadow-2xl relative overflow-hidden">
                        <div className="absolute -top-24 -right-24 w-48 h-48 bg-brand-gold/20 rounded-full blur-[60px]"></div>
                        <h2 className="text-xl font-heading font-bold text-white mb-2 flex items-center gap-2">
                            <span className="text-brand-gold">✍️</span> {editingMemoryId ? 'Edit Memory' : 'New Memory'}
                        </h2>
                        <p className="text-xs text-brand-platinum/50 mb-6 uppercase tracking-widest">この瞬間の想い出をカードに刻む</p>

                        <div className="relative">
                            <textarea
                                value={noteContent}
                                onChange={(e) => setNoteContent(e.target.value.substring(0, 140))}
                                className="w-full bg-black/40 border border-white/10 rounded-xl p-4 text-white text-sm focus:ring-2 focus:ring-brand-gold/50 focus:border-brand-gold/50 transition-all min-h-[120px] placeholder:text-white/20 font-serif italic"
                                placeholder="例: 現地で観戦していました！一生の宝物にします。"
                            />
                            <div className="absolute bottom-3 right-3 text-[10px] font-mono text-white/30">
                                {noteContent.length}/140
                            </div>
                        </div>

                        <div className="flex gap-3 mt-8">
                            <button
                                onClick={() => setIsModalOpen(false)}
                                className="flex-1 py-3 rounded-xl border border-white/10 text-white font-bold text-sm hover:bg-white/5 transition-colors"
                            >
                                CANCEL
                            </button>
                            <button
                                onClick={handleSave}
                                disabled={isSubmitting}
                                className="flex-1 py-3 rounded-xl bg-gradient-to-r from-brand-gold to-orange-500 text-brand-dark font-bold text-sm hover:scale-[1.02] active:scale-[0.98] transition-all shadow-lg shadow-brand-gold/20 disabled:opacity-50"
                            >
                                {isSubmitting ? 'SAVING...' : 'SAVE MEMORY'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <div className="mt-4 text-center">
                <p className="text-[10px] text-gray-600 uppercase tracking-[0.2em] font-light">
                    Verified by Stadium Card Chain
                </p>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/OrderHistory.tsx">
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { getSellerOrders, getBuyerOrders } from '../app/actions/order';

export default function OrderHistory({ mode }: { mode: 'buy' | 'sell' }) {
    const [orders, setOrders] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchOrders = async () => {
            try {
                const data = mode === 'sell' ? await getSellerOrders() : await getBuyerOrders();
                setOrders(data);
            } catch (error) {
                console.error('Failed to fetch orders', error);
            } finally {
                setLoading(false);
            }
        };
        fetchOrders();
    }, [mode]);

    if (loading) {
        return (
            <div className="flex justify-center p-8">
                <div className="w-6 h-6 border-2 border-brand-blue border-t-transparent rounded-full animate-spin"></div>
            </div>
        );
    }

    if (orders.length === 0) {
        return (
            <div className="p-8 text-center border border-white/5 rounded-2xl bg-white/5">
                <p className="text-brand-platinum/60">
                    {mode === 'sell' ? 'You have no sales yet.' : 'You have no purchases yet.'}
                </p>
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {orders.map((order) => (
                <Link
                    key={order.id}
                    href={`/orders/${mode}/${order.id}`}
                    className="block group relative overflow-hidden rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition-all p-4"
                >
                    <div className="flex gap-4 items-center">
                        {/* Image */}
                        <div className="w-16 h-20 bg-black/20 rounded-lg overflow-hidden flex-shrink-0">
                            {order.listing?.images?.[0] ? (
                                <img
                                    src={order.listing.images[0]}
                                    alt={order.listing.title}
                                    className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center text-2xl">🃏</div>
                            )}
                        </div>

                        {/* Details */}
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between mb-1">
                                <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full border ${getStatusStyle(order.status)}`}>
                                    {order.status.replace('_', ' ')}
                                </span>
                                <span className="text-xs text-brand-platinum/60 font-mono">
                                    {new Date(order.created_at).toLocaleDateString()}
                                </span>
                            </div>
                            <h3 className="font-bold text-white truncate text-sm mb-0.5">
                                {order.listing?.player_name || order.listing?.series_name || 'Unknown Item'}
                            </h3>
                            <p className="text-xs text-brand-platinum/60 truncate">
                                {order.listing?.title}
                            </p>
                            <div className="mt-2 text-brand-gold font-mono text-sm font-bold">
                                ¥{(order.total_amount || 0).toLocaleString()}
                            </div>
                        </div>

                        {/* Arrow */}
                        <div className="text-brand-platinum/20 group-hover:text-white transition-colors">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </div>
                </Link>
            ))}
        </div>
    );
}

function getStatusStyle(status: string) {
    switch (status) {
        case 'paid':
        case 'awaiting_shipping':
            return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
        case 'shipped':
            return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
        case 'completed':
            return 'bg-green-500/20 text-green-400 border-green-500/30';
        default:
            return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }
}
</file>

<file path="frontend/components/PremiumCardImage.tsx">
import React from 'react';
import Image from 'next/image';

interface PremiumCardImageProps {
    src: string;
    alt: string;
    className?: string;
}

const PremiumCardImage: React.FC<PremiumCardImageProps> = ({ src, alt, className = '' }) => {
    return (
        <div className={`relative overflow-hidden rounded-xl group ${className}`}>
            {/* Base Image with Filters */}
            <Image
                src={src}
                alt={alt}
                fill
                sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
                className="object-cover filter contrast-110 saturate-125"
            />

            {/* Gold Frame Overlay */}
            <div className="absolute inset-0 border-[6px] border-brand-gold rounded-xl pointer-events-none shadow-[inset_0_0_20px_rgba(255,215,0,0.5)] z-10"></div>

            {/* Holographic Sheen Animation */}
            <div className="absolute inset-0 pointer-events-none z-20 overflow-hidden">
                <div className="absolute inset-0 w-[200%] h-[200%] bg-gradient-to-br from-transparent via-white/30 to-transparent animate-shimmer-diagonal mix-blend-overlay"></div>
            </div>

            {/* Optional: Glass reflection effect */}
            <div className="absolute inset-0 bg-gradient-to-tr from-white/5 to-transparent opacity-50 pointer-events-none z-10"></div>
        </div>
    );
};

export default PremiumCardImage;
</file>

<file path="frontend/components/PurchaseAnimation.tsx">
'use client';

import { useEffect, useState } from 'react';

interface PurchaseAnimationProps {
    onComplete: () => void;
}

export default function PurchaseAnimation({ onComplete }: PurchaseAnimationProps) {
    const [stage, setStage] = useState<'start' | 'flash' | 'reveal' | 'end'>('start');

    useEffect(() => {
        // Sequence of animation
        const timer1 = setTimeout(() => setStage('flash'), 500);
        const timer2 = setTimeout(() => setStage('reveal'), 1500);
        const timer3 = setTimeout(() => setStage('end'), 4000);
        const timer4 = setTimeout(onComplete, 4500);

        return () => {
            clearTimeout(timer1);
            clearTimeout(timer2);
            clearTimeout(timer3);
            clearTimeout(timer4);
        };
    }, [onComplete]);

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-xl">
            {/* Background Rays */}
            <div className={`absolute inset-0 flex items-center justify-center transition-opacity duration-1000 ${stage === 'start' ? 'opacity-0' : 'opacity-100'}`}>
                <div className="w-[200vw] h-[200vw] bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,215,0,0.1)_20deg,transparent_40deg,rgba(255,215,0,0.1)_60deg,transparent_80deg,rgba(255,215,0,0.1)_100deg,transparent_120deg,rgba(255,215,0,0.1)_140deg,transparent_160deg,rgba(255,215,0,0.1)_180deg,transparent_200deg,rgba(255,215,0,0.1)_220deg,transparent_240deg,rgba(255,215,0,0.1)_260deg,transparent_280deg,rgba(255,215,0,0.1)_300deg,transparent_320deg,rgba(255,215,0,0.1)_340deg,transparent_360deg)] animate-[spin_20s_linear_infinite]"></div>
            </div>

            {/* Flash Effect */}
            <div className={`absolute inset-0 bg-white transition-opacity duration-300 pointer-events-none ${stage === 'flash' ? 'opacity-80' : 'opacity-0'}`}></div>

            {/* Content */}
            <div className={`relative flex flex-col items-center transform transition-all duration-1000 ${stage === 'reveal' ? 'scale-100 opacity-100' : 'scale-50 opacity-0'}`}>
                <div className="text-6xl mb-8 animate-bounce">🎉</div>
                <h2 className="text-4xl md:text-6xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-gold via-white to-brand-gold animate-pulse text-center">
                    ORDER COMPLETED!
                </h2>
                <p className="mt-4 text-brand-platinum text-xl text-center max-w-md">
                    Congratulations! You have successfully received your item.
                </p>

                {/* Particles/Confetti (Simplified CSS) */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full pointer-events-none">
                    {[...Array(12)].map((_, i) => (
                        <div key={i} className="absolute top-1/2 left-1/2 w-2 h-2 bg-brand-gold rounded-full animate-ping" style={{
                            animationDelay: `${i * 0.1}s`,
                            transform: `rotate(${i * 30}deg) translate(100px)`
                        }}></div>
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/ShowcaseCard.tsx">
import Link from 'next/link';
import Image from 'next/image';
import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';

interface ICard {
    id: string;
    // catalog_id, catalog removed
    player_name?: string | null;
    year?: number | null;
    manufacturer?: string | null;
    team?: string | null;
    images?: string[];
    is_rookie?: boolean;
    is_autograph?: boolean;
    price?: number | null;
    status?: string | null;
    variation?: string | null;
    series_name?: string | null;
    card_number?: string | null;
    moment_history?: any[];
    moment_created_at?: string | null;
}

import MomentHistoryBadge from './MomentHistoryBadge';
interface ShowcaseItemProps {
    item: ICard;
    type?: 'listed' | 'purchased'; // To distinguish in aggregated view
    variant?: 'default' | 'live-moment';
    is_live_moment?: boolean; // Added flag
    live_moments?: any[]; // Array for multiple moments
    onDelete?: (id: string) => void;
    onCancel?: (id: string) => void;
    onToggleDisplay?: (id: string, currentStatus: string) => void;
    onClone?: (id: string) => void;
    onRestore?: (id: string) => void;
    isArchived?: boolean;
    moment_created_at?: string | null;
}

export default function ShowcaseCard({ item, type, variant = 'default', is_live_moment, live_moments = [], onDelete, onCancel, onToggleDisplay, onClone, onRestore, isArchived, moment_created_at }: ShowcaseItemProps) {
    const [isFlipped, setIsFlipped] = useState(false);
    const hasBackImage = item.images && item.images.length > 1;
    // Use prop if provided, otherwise fallback to variant (for backward compatibility or explicit override)
    const isLiveMoment = is_live_moment || variant === 'live-moment' || live_moments.length > 0;

    // Countdown logic for multiple moments
    const [momentsWithTime, setMomentsWithTime] = useState<any[]>([]);
    const [isLiveActive, setIsLiveActive] = useState(isLiveMoment);

    useEffect(() => {
        if (isLiveMoment) {
            // Normalize moments: use live_moments array or fallback to single moment_created_at
            let sourceMoments = [...live_moments];
            if (sourceMoments.length === 0 && (is_live_moment || variant === 'live-moment')) {
                sourceMoments.push({
                    id: 'temp-' + item.id,
                    created_at: moment_created_at || new Date().toISOString(),
                    title: 'Live Moment'
                });
            }

            const updateTimers = () => {
                const now = new Date().getTime();
                const updated = sourceMoments.map(m => {
                    const startTime = new Date(m.created_at).getTime();
                    const endTime = startTime + 60 * 60 * 1000;
                    const distance = endTime - now;

                    if (distance > 0) {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        return {
                            ...m,
                            timeLeft: `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`,
                            isExpired: false
                        };
                    }
                    return { ...m, timeLeft: '00:00', isExpired: true };
                });

                setMomentsWithTime(updated);
                setIsLiveActive(updated.some(m => !m.isExpired));
            };

            updateTimers();
            const timerId = setInterval(updateTimers, 1000);
            return () => clearInterval(timerId);
        } else {
            setMomentsWithTime([]);
            setIsLiveActive(false);
        }
    }, [isLiveMoment, live_moments, is_live_moment, variant, moment_created_at, item.id]);

    const handleFlip = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsFlipped(!isFlipped);
    };

    return (
        <motion.div
            className={`group relative flex flex-col rounded-xl overflow-hidden border transition-all duration-500 bg-brand-dark-light/50`}
            animate={isLiveActive ? {
                boxShadow: [
                    "0 0 15px rgba(255, 215, 0, 0.2)",
                    "0 0 30px rgba(255, 215, 0, 0.5)",
                    "0 0 15px rgba(255, 215, 0, 0.2)"
                ],
                borderColor: [
                    "rgba(255, 215, 0, 0.4)",
                    "rgba(255, 215, 0, 1)",
                    "rgba(255, 215, 0, 0.4)"
                ]
            } : {}}
            transition={{
                duration: 3,
                repeat: Infinity,
                ease: "easeInOut"
            }}
            whileHover={{ scale: 1.02 }}
            style={{
                borderColor: isLiveActive ? '#FFD700' : 'rgba(255, 255, 255, 0.1)'
            }}
        >

            {/* Main Clickable Link Overlay */}
            <Link href={`/listings/${item.id}`} className="absolute inset-0 z-10" />

            {/* Live Moment Badge */}
            {isLiveActive && (
                <div className="absolute top-0 left-0 z-30 w-full overflow-hidden h-full pointer-events-none p-3 space-y-2">
                    {momentsWithTime.filter(m => !m.isExpired).map((m, idx) => (
                        <div key={m.id || idx} className="relative px-2 py-0.5 bg-brand-gold text-brand-dark text-[10px] font-bold tracking-wider rounded shadow-lg shadow-brand-gold/20 border border-white/20 flex items-center gap-1.5 z-50 animate-pulse w-fit">
                            <span className="w-1.5 h-1.5 rounded-full bg-red-600 animate-ping" />
                            LIVE
                            <span className="ml-1 pl-1 border-l border-brand-dark/20 font-mono">{m.timeLeft}</span>
                        </div>
                    ))}
                    {/* Corner Glow Effect */}
                    <div className="absolute -top-10 -left-10 w-20 h-20 bg-brand-gold/30 blur-2xl rounded-full"></div>
                    <div className="absolute -bottom-10 -right-10 w-20 h-20 bg-brand-gold/30 blur-2xl rounded-full"></div>
                </div>
            )}
            {/* Card Image Area */}
            <div className="relative aspect-[3/4] w-full perspective-[1000px]">
                <div className={`relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${isFlipped && (hasBackImage || isLiveActive || (item.moment_history && item.moment_history.length > 0)) ? '[transform:rotateY(180deg)]' : ''}`}>
                    {/* Front Image */}
                    <div className="absolute inset-0 w-full h-full [backface-visibility:hidden]">
                        {item.images && item.images[0] ? (
                            <Image
                                src={item.images[0]}
                                alt={item.player_name || 'Card Image'}
                                fill
                                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
                                className="object-cover"
                            />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-brand-platinum/20">No Image</div>
                        )}
                        {/* Live Moment Inner Glow */}
                        {isLiveActive && (
                            <div className="absolute inset-0 shadow-[inset_0_0_30px_rgba(255,215,0,0.3)] mix-blend-overlay pointer-events-none" />
                        )}
                    </div>

                    {/* Back Image */}
                    {hasBackImage && (
                        <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] bg-brand-dark-light relative">
                            <Image
                                src={(item.images && item.images[1]) || ''}
                                alt={`${item.player_name || ''} Back`}
                                fill
                                sizes="(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 20vw"
                                className="object-cover"
                            />

                            {/* Live Moment Stats Overlay / Latest Stamped Moment */}
                            {(isLiveActive || (item.moment_history && item.moment_history.length > 0)) && (
                                <div className="absolute inset-0 bg-black/70 flex flex-col justify-center items-center p-4 text-center">
                                    <div className="border-2 border-brand-gold/50 p-3 rounded-lg bg-black/40 backdrop-blur-md w-full">
                                        <h4 className="text-brand-gold font-heading font-bold text-sm mb-2 tracking-widest border-b border-brand-gold/30 pb-1">
                                            {isLiveActive ? 'LIVE MOMENT DATA' : 'STAMPED MOMENT'}
                                        </h4>
                                        {(() => {
                                            const activeMoment = momentsWithTime.find(m => !m.isExpired);
                                            // Prioritize moments with memories, or fallback to the absolute latest
                                            const history = item.moment_history || [];
                                            const memoryMoment = history.slice().reverse().find((m: any) => m.memories && m.memories.length > 0);

                                            const latestMoment = memoryMoment || (history.length > 0 ? history[history.length - 1] : activeMoment);

                                            if (!latestMoment) return null;

                                            return (
                                                <div className="space-y-2 text-[10px] font-mono">
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">TITLE</span>
                                                        <span className="text-white font-bold truncate max-w-[100px]" title={latestMoment.title || 'ACTIVE'}>
                                                            {latestMoment.title || 'ACTIVE NOW'}
                                                        </span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">PLAYER</span>
                                                        <span className="text-white font-bold">{latestMoment.player_name || item.player_name || '---'}</span>
                                                    </div>
                                                    <div className="flex justify-between">
                                                        <span className="text-brand-platinum/60 uppercase">TIME</span>
                                                        <span className="text-white font-bold">
                                                            {latestMoment.timestamp ? new Date(latestMoment.timestamp).toLocaleDateString() : (latestMoment.created_at ? new Date(latestMoment.created_at).toLocaleDateString() : new Date().toLocaleDateString())}
                                                        </span>
                                                    </div>
                                                    <div className="pt-2 border-t border-brand-platinum/10">
                                                        <div className="text-brand-gold font-bold mb-1 uppercase text-[9px]">
                                                            {latestMoment.description?.substring(0, 30) || 'CAPTURING LIVE EVENT...'}
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-2 text-[9px]">
                                                            <div className="bg-brand-platinum/10 rounded p-1">
                                                                <div className="text-brand-platinum/50 uppercase">INTENSITY</div>
                                                                <div className="text-white font-bold">{latestMoment.intensity || '--'}</div>
                                                            </div>
                                                            <div className="bg-brand-platinum/10 rounded p-1">
                                                                <div className="text-brand-platinum/50 uppercase">RESULT</div>
                                                                <div className="text-white font-bold truncate">{latestMoment.match_result || '---'}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* Flip Button */}
                {(hasBackImage || isLiveActive || (item.moment_history && item.moment_history.length > 0)) && (
                    <button
                        onClick={handleFlip}
                        className="absolute top-2 right-2 z-20 p-1.5 rounded-full bg-black/60 text-white hover:bg-brand-blue hover:text-white transition-colors backdrop-blur-sm border border-white/10"
                        title="Flip Card"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                )}
            </div>

            {/* Footer Area: Info & Actions */}
            <div className="p-3 bg-brand-dark-light border-t border-brand-platinum/5 flex flex-col gap-2">
                {/* Info */}
                <div className="flex justify-between items-start">
                    <div className="overflow-hidden">
                        <p className="text-white font-bold text-sm truncate" title={item.player_name || 'Unknown'}>{item.player_name || 'Unknown'}</p>
                        <p className="text-brand-platinum/70 text-xs truncate">{item.year || ''} {item.manufacturer || ''}</p>
                    </div>
                    {/* Moment History Badge */}
                    <MomentHistoryBadge
                        history={item.moment_history}
                        liveCount={0} // Disabled per user request (Step 7712)
                    />
                </div>

                {/* Status & Price */}
                <div className="flex justify-between items-center min-h-[20px]">
                    {type === 'purchased' ? (
                        <span className="text-[10px] px-2 py-0.5 rounded-full border bg-green-500/10 border-green-500/30 text-green-400 font-medium tracking-wide">
                            PURCHASED
                        </span>
                    ) : (
                        <>
                            {item.status === 'Active' ? (
                                <div className="flex items-center gap-1.5">
                                    <div className="w-4 h-4 rounded-full bg-brand-gold flex items-center justify-center shadow-[0_0_8px_rgba(234,179,8,0.4)]">
                                        <span className="text-[9px] text-brand-dark font-bold">¥</span>
                                    </div>
                                    <span className="font-heading font-bold text-white text-base tracking-tight">
                                        {item.price?.toLocaleString() ?? '---'}
                                    </span>
                                </div>
                            ) : (
                                <span className={`text-[10px] px-2 py-0.5 rounded-full border font-medium tracking-wide ${item.status === 'Sold' || item.status === 'Completed' || item.status === 'Delivered' ? 'bg-red-500/10 border-red-500/30 text-red-400' :
                                    item.status === 'Display' ? 'bg-brand-blue/10 border-brand-blue/30 text-brand-blue-glow' :
                                        'bg-brand-platinum/10 border-brand-platinum/20 text-brand-platinum/60'
                                    } `}>
                                    {item.status === 'Sold' || item.status === 'Completed' || item.status === 'Delivered' ? 'SOLD' :
                                        item.status === 'Display' ? 'DISPLAY' :
                                            (item.status || '').toUpperCase()}
                                </span>
                            )}
                        </>
                    )}
                </div>

                {/* Action Buttons Row */}
                <div className="relative z-20 flex items-center justify-end gap-2 pt-3 mt-1 border-t border-brand-platinum/10">
                    {/* Toggle Display Status Button */}
                    {!isArchived && (((item.status === 'Draft' || item.status === 'Display' || item.status === 'Active') && onToggleDisplay) || (type === 'purchased' && onClone)) ? (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (type === 'purchased' && onClone) {
                                        onClone(item.id);
                                    } else if (onToggleDisplay) {
                                        onToggleDisplay(item.id, item.status || '');
                                    }
                                }}
                                className={`p-2 rounded-lg border transition-all duration-300 ${item.status === 'Display'
                                    ? 'bg-brand-blue/10 border-brand-blue/40 text-brand-blue hover:bg-brand-blue/20 hover:border-brand-blue'
                                    : 'bg-brand-platinum/5 border-brand-platinum/10 text-brand-platinum/40 hover:bg-brand-platinum/10 hover:text-brand-platinum hover:border-brand-platinum/30'
                                    } `}
                            >
                                {item.status === 'Display' ? (
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                ) : (
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.243M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                                )}
                            </button>
                            <div className="absolute center-x bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                {item.status === 'Display' ? "非公開にする" :
                                    (item.status === 'Active' ? "Displayに変更" :
                                        (type === 'purchased' ? "Displayに追加 (Clone)" : "公開する"))}
                            </div>
                        </div>
                    ) : null}

                    {/* List Button (For Draft/Display OR Purchased) */}
                    {(item.status === 'Draft' || item.status === 'Display' || type === 'purchased') && (
                        <Link
                            href={`/sell?source=collection&id=${item.id}`}
                            className="group/tooltip relative p-2 bg-brand-gold/10 hover:bg-brand-gold/20 text-brand-gold rounded-lg border border-brand-gold/30 hover:border-brand-gold/50 transition-all duration-300"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                出品する
                            </div>
                        </Link>
                    )}

                    {/* Cancel Listing Button (for Active items) */}
                    {!isArchived && item.status === 'Active' && onCancel && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onCancel(item.id);
                                }}
                                className="p-2 bg-brand-platinum/5 hover:bg-red-500/20 text-brand-platinum/60 hover:text-red-400 rounded-lg border border-brand-platinum/10 hover:border-red-500/30 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                出品取り消し
                            </div>
                        </div>
                    )}

                    {/* Restore Button (Archive only) */}
                    {isArchived && onRestore && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onRestore(item.id);
                                }}
                                className="p-2 bg-green-500/10 hover:bg-green-500/20 text-green-500 rounded-lg border border-green-500/30 hover:border-green-500/50 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                コレクションに戻す
                            </div>
                        </div>
                    )}

                    {/* Delete Button (Normal view only, or Archive if physical delete allowed) */}
                    {!isArchived && onDelete && (item.status === 'Draft' || item.status === 'Display') && (
                        <div className="group/tooltip relative">
                            <button
                                onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    onDelete(item.id);
                                }}
                                className="p-2 bg-brand-platinum/5 hover:bg-red-500/20 text-brand-platinum/40 hover:text-red-400 rounded-lg border border-brand-platinum/10 hover:border-red-500/30 transition-all duration-300"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <div className="absolute right-0 bottom-full mb-2 px-2 py-1 bg-brand-dark border border-brand-platinum/20 text-white text-[10px] rounded shadow-xl opacity-0 group-hover/tooltip:opacity-100 pointer-events-none whitespace-nowrap transition-opacity duration-200 z-50">
                                削除 (アーカイブ)
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </motion.div>
    );
}
</file>

<file path="frontend/components/SkeletonCard.tsx">
export default function SkeletonCard() {
    return (
        <div className="relative group w-full aspect-[3/4] rounded-xl overflow-hidden bg-brand-dark-light border border-white/5 animate-pulse">
            {/* Shimmer Effect */}
            <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_1.5s_infinite]"></div>

            <div className="h-full flex flex-col justify-end p-3">
                <div className="space-y-2">
                    <div className="h-4 bg-brand-platinum/10 rounded w-3/4"></div>
                    <div className="h-3 bg-brand-platinum/10 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/hooks/useZengin.ts">
import { useState, useEffect } from 'react';

export interface Bank {
    code: string;
    name: string;
    kana: string;
    hira: string;
    roma: string;
}

export interface Branch {
    code: string;
    name: string;
    kana: string;
    hira: string;
    roma: string;
}

const ZENGIN_BASE_URL = 'https://zengin-code.github.io/api';

export function useZengin() {
    const [banks, setBanks] = useState<Bank[]>([]);
    const [branches, setBranches] = useState<Branch[]>([]);
    const [loadingBanks, setLoadingBanks] = useState(false);
    const [loadingBranches, setLoadingBranches] = useState(false);
    const [error, setError] = useState<string | null>(null);

    // Fetch All Banks on mount
    useEffect(() => {
        const fetchBanks = async () => {
            setLoadingBanks(true);
            try {
                const res = await fetch(`${ZENGIN_BASE_URL}/banks.json`);
                if (!res.ok) throw new Error('Failed to fetch bank data');
                const data = await res.json();
                // The data is an object where keys are codes, or array? 
                // Zengin data format: { "0001": { code: "0001", name: "みずほ", ... }, ... }
                // Convert to array
                const bankList = Object.values(data) as Bank[];
                setBanks(bankList);
            } catch (err: any) {
                console.error(err);
                setError('Failed to load bank list.');
            } finally {
                setLoadingBanks(false);
            }
        };
        fetchBanks();
    }, []);

    // Fetch Branches for a specific bank
    const fetchBranches = async (bankCode: string) => {
        if (!bankCode) {
            setBranches([]);
            return;
        }
        setLoadingBranches(true);
        setBranches([]); // Clear previous
        try {
            const res = await fetch(`${ZENGIN_BASE_URL}/branches/${bankCode}.json`);
            if (!res.ok) throw new Error('Failed to fetch branch data');
            const data = await res.json();
            const branchList = Object.values(data) as Branch[];
            setBranches(branchList);
        } catch (err: any) {
            console.error(err);
            // Some banks might not have branch data in this simplified API or URL issue
            // But typical zengin-data supports major banks.
            setError(`Failed to load branches for bank ${bankCode}`);
            setBranches([]);
        } finally {
            setLoadingBranches(false);
        }
    };

    return {
        banks,
        branches,
        fetchBranches,
        loadingBanks,
        loadingBranches,
        error
    };
}
</file>

<file path="frontend/lib/resend.ts">
import { Resend } from 'resend';

// Initialize Resend client
const apiKey = process.env.RESEND_API_KEY;

if (!apiKey) {
    console.warn("⚠️  RESEND_API_KEY is not defined in process.env. Email sending will fail.");
    console.log("Current NODE_ENV:", process.env.NODE_ENV);
} else {
    console.log("✅ RESEND_API_KEY is loaded (starts with " + apiKey.substring(0, 3) + ")");
}

export const resend = new Resend(apiKey || 're_123_placeholder');
</file>

<file path="frontend/lib/stripe.ts">
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
    apiVersion: '2025-11-17.clover', // Latest API version
    typescript: true,
});
</file>

<file path="frontend/lib/teams.ts">
export const TEAM_GROUPS = [
    {
        label: "ア・リーグ 東地区",
        teams: [
            { code: 'BAL', name: 'オリオールズ' },
            { code: 'BOS', name: 'レッドソックス' },
            { code: 'NYY', name: 'ヤンキース' },
            { code: 'TB', name: 'レイズ' },
            { code: 'TOR', name: 'ブルージェイズ' },
        ]
    },
    {
        label: "ア・リーグ 中地区",
        teams: [
            { code: 'CWS', name: 'ホワイトソックス' },
            { code: 'CLE', name: 'ガーディアンズ' },
            { code: 'DET', name: 'タイガース' },
            { code: 'KC', name: 'ロイヤルズ' },
            { code: 'MIN', name: 'ツインズ' },
        ]
    },
    {
        label: "ア・リーグ 西地区",
        teams: [
            { code: 'HOU', name: 'アストロズ' },
            { code: 'LAA', name: 'エンゼルス' },
            { code: 'OAK', name: 'アスレチックス' },
            { code: 'SEA', name: 'マリナーズ' },
            { code: 'TEX', name: 'レンジャーズ' },
        ]
    },
    {
        label: "ナ・リーグ 東地区",
        teams: [
            { code: 'ATL', name: 'ブレーブス' },
            { code: 'MIA', name: 'マーリンズ' },
            { code: 'NYM', name: 'メッツ' },
            { code: 'PHI', name: 'フィリーズ' },
            { code: 'WSH', name: 'ナショナルズ' },
        ]
    },
    {
        label: "ナ・リーグ 中地区",
        teams: [
            { code: 'CHC', name: 'カブス' },
            { code: 'CIN', name: 'レッズ' },
            { code: 'MIL', name: 'ブリュワーズ' },
            { code: 'PIT', name: 'パイレーツ' },
            { code: 'STL', name: 'カージナルス' },
        ]
    },
    {
        label: "ナ・リーグ 西地区",
        teams: [
            { code: 'AZ', name: 'ダイヤモンドバックス' },
            { code: 'COL', name: 'ロッキーズ' },
            { code: 'LAD', name: 'ドジャース' },
            { code: 'SD', name: 'パドレス' },
            { code: 'SF', name: 'ジャイアンツ' },
        ]
    },
    {
        label: "NPB セ・リーグ",
        teams: [
            { code: "YG", name: "巨人 (Giants)" },
            { code: "T", name: "阪神 (Tigers)" },
            { code: "DB", name: "DeNA (BayStars)" },
            { code: "C", name: "広島 (Carp)" },
            { code: "S", name: "ヤクルト (Swallows)" },
            { code: "D", name: "中日 (Dragons)" },
        ]
    },
    {
        label: "NPB パ・リーグ",
        teams: [
            { code: "H", name: "ソフトバンク (Hawks)" },
            { code: "F", name: "日本ハム (Fighters)" },
            { code: "M", name: "ロッテ (Marines)" },
            { code: "E", name: "楽天 (Eagles)" },
            { code: "L", name: "西武 (Lions)" },
            { code: "B", name: "オリックス (Buffaloes)" },
        ]
    },
    {
        label: "ナショナルチーム",
        teams: [
            { code: "JPN", name: "侍ジャパン (Samurai Japan)" },
            { code: "USA", name: "アメリカ代表 (USA)" },
            { code: "DOM", name: "ドミニカ代表 (Dominican Rep.)" },
            { code: "KOR", name: "韓国代表 (Korea)" },
        ]
    }
];
</file>

<file path="frontend/migrations/03_add_order_status.sql">
ｍ
</file>

<file path="frontend/migrations/04_expand_listing_items.sql">
-- Add columns to listing_items to support detailed card information
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS variation text,
ADD COLUMN IF NOT EXISTS serial_number text,
ADD COLUMN IF NOT EXISTS is_rookie boolean default false,
ADD COLUMN IF NOT EXISTS is_autograph boolean default false,
ADD COLUMN IF NOT EXISTS description text,
ADD COLUMN IF NOT EXISTS condition_rating text; -- For raw card condition (e.g. Near Mint)

-- Comment on columns
COMMENT ON COLUMN public.listing_items.variation IS 'Variant of the card (e.g. Refractor, Gold)';
COMMENT ON COLUMN public.listing_items.serial_number IS 'Serial number printed on card (e.g. 10/50)';
COMMENT ON COLUMN public.listing_items.condition_rating IS 'Condition string for raw cards, separate from graded info in condition_grading jsonb';
</file>

<file path="frontend/migrations/05_decouple_catalog.sql">
-- Make catalog_id nullable to allow manual listings without catalog entry
ALTER TABLE public.listing_items ALTER COLUMN catalog_id DROP NOT NULL;

-- Add columns for manual entry (Basic Info)
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS player_name text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS team text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS year integer;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS manufacturer text;

-- Comment: These fields will be populated if catalog_id is null (or as overrides)
</file>

<file path="frontend/migrations/06_backfill_and_remove_catalog.sql">
-- 1. Add missing specific columns from catalog to listing_items
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS card_number text;
ALTER TABLE public.listing_items ADD COLUMN IF NOT EXISTS series_name text;

-- 2. Backfill data: Copy from card_catalogs to listing_items where listing_items fields are null
-- We use COALESCE to keep existing overrides, or just unconditional copy if the target is null.
-- Actually, if mode was "add", target is likely null. If "edit" override, target has value.
-- We only fill where target is NULL to respect potential manual edits (though previous logic didn't really support edits well until now).
-- Safe bet: Fill where NULL.

UPDATE public.listing_items
SET
    player_name = COALESCE(public.listing_items.player_name, c.player_name),
    team = COALESCE(public.listing_items.team, c.team::text),
    year = COALESCE(public.listing_items.year, c.year),
    manufacturer = COALESCE(public.listing_items.manufacturer, c.manufacturer::text),
    is_rookie = COALESCE(public.listing_items.is_rookie, c.is_rookie),
    -- New columns
    card_number = COALESCE(public.listing_items.card_number, c.card_number),
    series_name = COALESCE(public.listing_items.series_name, c.series_name)
    -- rarity? We map 'Autograph' rarity to is_autograph=true if needed, but is_autograph is likely set manually or default false.
    -- Let's check rarity. If catalog says Autograph, we should probably ensure is_autograph is true?
    -- is_autograph = CASE WHEN c.rarity = 'Autograph' THEN true ELSE public.listing_items.is_autograph END
FROM public.card_catalogs c
WHERE public.listing_items.catalog_id = c.id;


-- 1b. Add missing columns to user_collections (assuming it follows similar structure or needs these to hold data)
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS player_name text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS team text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS year integer;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS manufacturer text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS card_number text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS series_name text;
ALTER TABLE public.user_collections ADD COLUMN IF NOT EXISTS is_rookie boolean;
-- Add other cols if user_collections is used for rich display, otherwise basic info might suffice.

-- 2b. Backfill user_collections
UPDATE public.user_collections
SET
    player_name = COALESCE(public.user_collections.player_name, c.player_name),
    team = COALESCE(public.user_collections.team, c.team::text),
    year = COALESCE(public.user_collections.year, c.year),
    manufacturer = COALESCE(public.user_collections.manufacturer, c.manufacturer::text),
    card_number = COALESCE(public.user_collections.card_number, c.card_number),
    series_name = COALESCE(public.user_collections.series_name, c.series_name),
    is_rookie = COALESCE(public.user_collections.is_rookie, c.is_rookie)
FROM public.card_catalogs c
WHERE public.user_collections.catalog_id = c.id;

-- 3. Drop Foreign Key Constraints
ALTER TABLE public.listing_items DROP CONSTRAINT IF EXISTS listing_items_catalog_id_fkey;
ALTER TABLE public.user_collections DROP CONSTRAINT IF EXISTS user_collections_catalog_id_fkey;

-- 4. Drop catalog_id columns
ALTER TABLE public.listing_items DROP COLUMN IF EXISTS catalog_id;
ALTER TABLE public.user_collections DROP COLUMN IF EXISTS catalog_id;

-- 5. Drop card_catalogs table
DROP TABLE IF EXISTS public.card_catalogs CASCADE;
</file>

<file path="frontend/migrations/07_update_complete_order_rpc.sql">
-- Migration: Update complete_order RPC to remove catalog_id dependency
-- Created at: 2025-12-11

CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Update listing status to Completed
  UPDATE listing_items
  SET status = 'Completed'
  WHERE id = p_listing_id;

  -- Update order status to completed
  UPDATE orders
  SET status = 'completed'
  WHERE listing_id = p_listing_id;
END;
$$;
</file>

<file path="frontend/migrations/08_payout_system.sql">
-- Migration: Add Payout System Tables and Columns
-- Created at: 2025-12-12

-- 1. Add real_name_kana to profiles
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS real_name_kana text;

-- 2. Create bank_accounts table
CREATE TABLE IF NOT EXISTS public.bank_accounts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    bank_name text NOT NULL,
    branch_name text NOT NULL,
    account_type text NOT NULL, -- 'ordinary' (普通) or 'current' (当座)
    account_number text NOT NULL,
    account_holder_name text NOT NULL, -- Kana Only
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    CONSTRAINT bank_accounts_user_id_key UNIQUE (user_id) -- One active account per user for simplicity initially
);

-- 3. Create payouts table
CREATE TABLE IF NOT EXISTS public.payouts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    amount integer NOT NULL,
    status text NOT NULL DEFAULT 'pending', -- pending, paid, rejected
    created_at timestamptz DEFAULT now(),
    processed_at timestamptz
);

-- Enable RLS
ALTER TABLE public.bank_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payouts ENABLE ROW LEVEL SECURITY;

-- Policies for bank_accounts
CREATE POLICY "Users can view own bank account" 
    ON public.bank_accounts FOR SELECT 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own bank account" 
    ON public.bank_accounts FOR INSERT 
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own bank account" 
    ON public.bank_accounts FOR UPDATE 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own bank account" 
    ON public.bank_accounts FOR DELETE 
    USING (auth.uid() = user_id);

-- Policies for payouts
CREATE POLICY "Users can view own payouts" 
    ON public.payouts FOR SELECT 
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own payouts" 
    ON public.payouts FOR INSERT 
    WITH CHECK (auth.uid() = user_id);

-- Only admins/service role can update payouts (e.g. to 'paid'), users cannot.
</file>

<file path="frontend/migrations/09_add_shipping_to_orders.sql">
-- Add shipping details to orders table
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS shipping_name text,
ADD COLUMN IF NOT EXISTS shipping_postal_code text,
ADD COLUMN IF NOT EXISTS shipping_address text,
ADD COLUMN IF NOT EXISTS shipping_phone text;

COMMENT ON COLUMN public.orders.shipping_name IS 'Snapshot of shipping name at purchase time';
COMMENT ON COLUMN public.orders.shipping_address IS 'Snapshot of full address at purchase time';
</file>

<file path="frontend/migrations/10_add_bank_codes.sql">
-- Add bank_code and branch_code to bank_accounts
ALTER TABLE public.bank_accounts 
ADD COLUMN IF NOT EXISTS bank_code text,
ADD COLUMN IF NOT EXISTS branch_code text;

-- Ideally make them NOT NULL after backfill, but for now allow null or rely on app logic
</file>

<file path="frontend/migrations/11_add_payout_fee.sql">
-- Migration: Add fee and payout_amount to payouts table
alter table public.payouts
add column if not exists fee integer not null default 0,
add column if not exists payout_amount integer;

-- Backfill payout_amount for existing records (assume fee was 0)
update public.payouts
set payout_amount = amount
where payout_amount is null;

-- Now make payout_amount NOT NULL
alter table public.payouts
alter column payout_amount set not null;
</file>

<file path="frontend/migrations/12_enhance_orders.sql">
-- Migration: Enhance orders table for Fulfillment Workflow
-- Created at: 2025-12-12

-- 1. Add Shipment Columns
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS shipping_address_snapshot jsonb, -- { name, postal_code, address, phone }
ADD COLUMN IF NOT EXISTS tracking_number text,
ADD COLUMN IF NOT EXISTS carrier text,
ADD COLUMN IF NOT EXISTS shipped_at timestamptz,
ADD COLUMN IF NOT EXISTS completed_at timestamptz;

-- 1.5 Normalize Existing Statuses (Fixing 23514 violation)
-- Convert PascalCase or legacy values to snake_case allowed values
UPDATE public.orders SET status = 'pending' WHERE status = 'TransactionPending';
UPDATE public.orders SET status = 'awaiting_shipping' WHERE status = 'AwaitingShipment';
UPDATE public.orders SET status = 'shipped' WHERE status = 'Shipped';
UPDATE public.orders SET status = 'completed' WHERE status = 'Delivered';
-- Fallback for any other unmapped values if necessary, or let it fail if unknown.
-- Assuming 'paid' might be 'Paid'
UPDATE public.orders SET status = 'paid' WHERE status = 'Paid';

-- 2. Add Status Check Constraint
-- Allow: pending, awaiting_shipping, shipped, completed, cancelled, (and 'paid' for legacy/compatibility if needed)
-- Renaming 'paid' to 'awaiting_shipping' is ideal, but for now we accept both or assume 'paid' -> 'awaiting_shipping' logic in app.
ALTER TABLE public.orders
DROP CONSTRAINT IF EXISTS orders_status_check;

ALTER TABLE public.orders
ADD CONSTRAINT orders_status_check 
CHECK (status IN ('pending', 'paid', 'awaiting_shipping', 'shipped', 'completed', 'cancelled', 'returned'));

-- 3. Comments
COMMENT ON COLUMN public.orders.shipping_address_snapshot IS 'Fixed address snapshot at time of purchase';
COMMENT ON COLUMN public.orders.tracking_number IS 'Shipment tracking number';
COMMENT ON COLUMN public.orders.shipped_at IS 'Timestamp when seller marked as shipped';
COMMENT ON COLUMN public.orders.completed_at IS 'Timestamp when buyer received item';

-- 4. Enable RLS and Add Policies
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

-- Drop existing policies to avoid conflicts if re-running
DROP POLICY IF EXISTS "Users can view their own purchases" ON public.orders;
DROP POLICY IF EXISTS "Users can view orders for their items" ON public.orders;
DROP POLICY IF EXISTS "Buyers can view their orders" ON public.orders;
DROP POLICY IF EXISTS "Sellers can view their orders" ON public.orders;

-- Policy: Users can view orders where they are the Buyer
CREATE POLICY "Buyers can view their orders"
ON public.orders FOR SELECT
USING (auth.uid() = buyer_id);

-- Policy: Users can view orders where they are the Seller (via listing_items join)
-- Optimized with EXISTS
CREATE POLICY "Sellers can view their orders"
ON public.orders FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM public.listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);

-- Note: No UPDATE/INSERT policies for public users. 
-- Updates must be done via Server Actions (Service Role) or RPC (Security Definer).
</file>

<file path="frontend/migrations/13_fix_listing_rls.sql">
-- Migration: Fix Listing Items RLS for Sellers
-- Created at: 2025-12-12
-- Goal: Ensure sellers can view their own items (even if not Active), 
-- which is required for the orders RLS policy to work.

ALTER TABLE public.listing_items ENABLE ROW LEVEL SECURITY;

-- 1. Policy: Users can view their own items (All statuses)
DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;

CREATE POLICY "Users can view own items"
ON public.listing_items FOR SELECT
USING (auth.uid() = seller_id);

-- 2. Policy: Public can view Active items (re-affirming existing or creating if missing)
-- (We use separate names to not conflict if "Enable read access for all users" exists for everything)
-- Assuming there might be an existing policy "Enable read access for all users" which might be filtering by status.
-- We add "Users can view own items" which is permissive for the owner. 
-- PostgREST combines policies with OR. So if one allows, access is granted.
</file>

<file path="frontend/migrations/14_add_live_moments.sql">
-- Migration: Add Live Moments Table
-- Created for Admin Dashboard Feature

create table if not exists public.live_moments (
    id uuid default gen_random_uuid() primary key,
    player_name text not null,
    title text not null,
    description text,
    intensity integer not null default 1, check (intensity >= 1 and intensity <= 5),
    created_at timestamptz default now()
);

-- RLS
alter table public.live_moments enable row level security;

-- Policy: Everyone can view
create policy "Live moments are viewable by everyone" 
    on public.live_moments for select 
    using (true);

-- Policy: Only Admins can insert/update (Enforced by App Logic using Service Role, so we deny here for standard users)
-- No INSERT/UPDATE policy for public/authenticated users means default deny.
</file>

<file path="frontend/migrations/15_add_moment_snapshot.sql">
-- Migration: Add Moment Snapshot to Orders
-- Created at: 2025-12-16
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS moment_snapshot jsonb;
COMMENT ON COLUMN public.orders.moment_snapshot IS 'Snapshot of the active Live Moment at the time of purchase (if any).';
</file>

<file path="frontend/migrations/16_add_moment_history.sql">
-- Migration: Add Moment History to Listing Items
-- Created at: 2025-12-16
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS moment_history jsonb DEFAULT '[]'::jsonb;
COMMENT ON COLUMN public.listing_items.moment_history IS 'Array of Live Moments this card has experienced during transactions.';
</file>

<file path="frontend/migrations/17_add_match_result_to_live_moments.sql">
-- Migration: Add Match Result to Live Moments
-- Created at: 2025-12-16
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS match_result text;
COMMENT ON COLUMN public.live_moments.match_result IS 'Score or Matchup details (e.g. "LAD 6 - 3 NYY")';
</file>

<file path="frontend/migrations/18_add_is_finalized_to_live_moments.sql">
-- Migration: Add Finalized Flag to Live Moments
-- Created at: 2025-12-16
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS is_finalized boolean DEFAULT false;
COMMENT ON COLUMN public.live_moments.is_finalized IS 'True if the match event has concluded and score is final.';
</file>

<file path="frontend/migrations/21_add_soft_delete_to_listings.sql">
-- Migration: Add Soft Delete to listing_items
-- Created: 2025-12-19
-- 1. Add deleted_at column
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS deleted_at timestamptz DEFAULT NULL;
-- 2. Update RLS Policies to Respect deleted_at
-- Standard read policy usually filters by status='Active'.
-- We need to ensure that deleted items are NOT visible even if status is Active (unexpected but possible).
-- Note: We have "Enable read access for all users" policy likely for Active items.
-- Let's check existing policies and update the one that exposes Active items.
-- 3. Policy: Public can only view ACTIVE and NOT DELETED items
-- (Replacing or Refining existing public read policy)
DROP POLICY IF EXISTS "Enable read access for all users" ON public.listing_items;
CREATE POLICY "Public can view active non-deleted items" ON public.listing_items FOR
SELECT USING (
        status = 'Active'
        AND deleted_at IS NULL
    );
-- 4. Policy: Users can view their OWN items (Including Deleted/Draft/etc)
-- This allows the "Archive" tab to work for the owner.
DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;
CREATE POLICY "Users can view own items" ON public.listing_items FOR
SELECT USING (auth.uid() = seller_id);
-- 5. Update Update/Delete policies (Owners only, non-deleted items)
DROP POLICY IF EXISTS "Users can update own items" ON public.listing_items;
CREATE POLICY "Users can update own items" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
-- Owners can update even if deleted (to restore)
DROP POLICY IF EXISTS "Users can delete own items" ON public.listing_items;
CREATE POLICY "Users can delete own items" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
-- Keep physical delete for now but actions will use soft delete
</file>

<file path="frontend/migrations/22_add_origin_order_id_to_listings.sql">
-- Add origin_order_id to track which order created this cloned item
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS origin_order_id uuid REFERENCES public.orders(id);
-- Create index for faster lookup
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Comment on column
COMMENT ON COLUMN public.listing_items.origin_order_id IS 'Reference to the order that created this cloned/buyer copy';
</file>

<file path="frontend/migrations/23_add_incoming_to_listing_status_enum.sql">
-- Add 'Incoming' to listing_status_enum to support purchased items in transit
-- This is necessary because the column is an ENUM and 'Incoming' was newly introduced.
ALTER TYPE public.listing_status_enum
ADD VALUE IF NOT EXISTS 'Incoming';
</file>

<file path="frontend/migrations/24_add_seller_id_to_orders.sql">
-- Add seller_id to orders table to maintain transaction history
-- This is necessary for the Ownership Transfer model where the card moves to the buyer.
ALTER TABLE public.orders
ADD COLUMN IF NOT EXISTS seller_id uuid REFERENCES public.profiles(id);
-- Optional: Populate existing orders with listing.seller_id to prevent data loss in history
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL;
</file>

<file path="frontend/migrations/25_fix_selling_view_rls.sql">
-- Migration: Fix RLS for Persistent ID Model (Ownership Transfer)
-- This ensures sellers can see items they've sold even after the card's seller_id changes to the buyer.
-- 1. Update Orders RLS
-- Previous policy relied on joining listing_items.seller_id, which now points to the buyer.
-- Use the new orders.seller_id column instead.
DROP POLICY IF EXISTS "Sellers can view their orders" ON public.orders;
CREATE POLICY "Sellers can view their orders" ON public.orders FOR
SELECT USING (auth.uid() = seller_id);
-- 2. Update Listing Items RLS
-- Allow former sellers to view the physical card details if they are the seller_id on an associated order.
-- This is necessary for the "History" tab and "Manage Order" page.
DROP POLICY IF EXISTS "Sellers can view sold items" ON public.listing_items;
CREATE POLICY "Sellers can view sold items" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
-- Ensure current owners can always see their items (existing policy)
-- DROP POLICY IF EXISTS "Users can view own items" ON public.listing_items;
-- (Keep existing "Users can view own items" as it covers the current owner)
-- 3. Data Integrity Fix
-- Ensure any orders created during the transition have the correct seller_id 
-- if they were missed by the webhook logic during the update.
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL
    AND l.seller_id != o.buyer_id;
-- Only fill if the card hasn't been transferred yet or we can deduce it.
-- Note: If the card WAS already transferred, l.seller_id is the buyer. 
-- In that case, we might need manual recovery or rely on timestamps, but for most immediate cases this is safe.
</file>

<file path="frontend/migrations/26_fix_buyer_seller_visibility.sql">
-- Migration: Fix Buyer/Seller Visibility in Persistent ID Model
-- Ensures Buyers can see items they are purchasing and Sellers see all sold items.
-- 1. Listing Items RLS for Buyers
-- Allow buyers of an active order to view the physical card details.
-- This is necessary because the card's seller_id hasn't updated to them yet in transit.
DROP POLICY IF EXISTS "Buyers can view items in transit" ON public.listing_items;
CREATE POLICY "Buyers can view items in transit" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
-- 2. Ensure Sellers can view items they ever sold (via associated order)
-- (Already in 25, but re-affirming or ensuring it works with any order status)
DROP POLICY IF EXISTS "Sellers can view sold history" ON public.listing_items;
CREATE POLICY "Sellers can view sold history" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
-- 3. Comprehensive Data Backfill
-- Ensure every order has a seller_id populated from the listing's perspective at that time.
-- This is critical for RLS 'auth.uid() = seller_id' to work safely.
DO $$ BEGIN
UPDATE public.orders o
SET seller_id = l.seller_id
FROM public.listing_items l
WHERE o.listing_id = l.id
    AND o.seller_id IS NULL;
END $$;
</file>

<file path="frontend/migrations/27_fix_rls_recursion.sql">
-- Migration: Mandatory RLS Purge & Recursion Break
-- This migration dynamically finds and drops EVERY policy on orders and listing_items
-- before setting up clean, non-recursive rules. This is the guaranteed fix.
DO $$
DECLARE pol RECORD;
BEGIN -- 1. Dynamically drop all existing policies on relevant tables
FOR pol IN (
    SELECT policyname,
        tablename
    FROM pg_policies
    WHERE schemaname = 'public'
        AND tablename IN ('listing_items', 'orders')
) LOOP EXECUTE format(
    'DROP POLICY IF EXISTS %I ON %I',
    pol.policyname,
    pol.tablename
);
END LOOP;
END $$;
-- 2. Orders Re-definition (Non-Recursive)
-- Use ONLY direct column checks. NO JOINS.
CREATE POLICY "Orders_Buyer_Access" ON public.orders FOR
SELECT USING (buyer_id = auth.uid());
CREATE POLICY "Orders_Seller_Access" ON public.orders FOR
SELECT USING (seller_id = auth.uid());
-- 3. Listing Items Re-definition
-- A. Public (No Join)
CREATE POLICY "Listings_Public_Access" ON public.listing_items FOR
SELECT USING (status = 'Active');
-- B. Owner (No Join)
CREATE POLICY "Listings_Owner_Access" ON public.listing_items FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
-- C. Historical Seller & Transit Buyer (Checks orders)
-- This is now SAFE because orders policies have zero dependencies.
CREATE POLICY "Listings_SoldHistory_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
CREATE POLICY "Listings_InTransit_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
</file>

<file path="frontend/migrations/28_restore_mutation_rls.sql">
-- Migration: Restore Insert/Update RLS Policies
-- Migration 27 purged everything to break recursion. Now we restore necessary mutation access.
-- 1. Orders Mutation Policies
-- Allow buyers to create their own orders
DROP POLICY IF EXISTS "Orders_Buyer_Insert" ON public.orders;
CREATE POLICY "Orders_Buyer_Insert" ON public.orders FOR
INSERT WITH CHECK (auth.uid() = buyer_id);
-- Allow buyers to update their own pending orders (e.g. shipping info, snapshot refresh)
DROP POLICY IF EXISTS "Orders_Buyer_Update" ON public.orders;
CREATE POLICY "Orders_Buyer_Update" ON public.orders FOR
UPDATE USING (auth.uid() = buyer_id) WITH CHECK (auth.uid() = buyer_id);
-- 2. Listing Items Mutation Policies
-- Allow users to create new listings
DROP POLICY IF EXISTS "Listings_Owner_Insert" ON public.listing_items;
CREATE POLICY "Listings_Owner_Insert" ON public.listing_items FOR
INSERT WITH CHECK (auth.uid() = seller_id);
-- Allow owners to update/delete their own items
DROP POLICY IF EXISTS "Listings_Owner_Update" ON public.listing_items;
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (auth.uid() = seller_id);
DROP POLICY IF EXISTS "Listings_Owner_Delete" ON public.listing_items;
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (auth.uid() = seller_id);
</file>

<file path="frontend/migrations/29_fix_workspace_visibility.sql">
-- Migration: Fix Workspace Visibility for Purchased Items
-- Status 'Completed' (old) or 'Draft' (new) should allow entry into Workspace.
-- Also updates complete_order RPC to set status to 'Draft' for new owner.
-- 1. Update the RPC to use 'Draft' (Owner Default) instead of 'Completed' (Transaction End)
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN -- Update listing status to Draft (makes it ownable/visible in Workspace but not listed)
UPDATE listing_items
SET status = 'Draft'
WHERE id = p_listing_id;
-- Update order status to completed
UPDATE orders
SET status = 'completed'
WHERE listing_id = p_listing_id;
END;
$$;
-- 2. Backfill existing 'Completed' items to 'Draft' to fix visibility for previous tests
UPDATE public.listing_items
SET status = 'Draft'
WHERE status = 'Completed';
</file>

<file path="frontend/migrations/30_self_healing_complete_order.sql">
-- Migration: Self-Healing complete_order RPC & Backfill
-- 2025-12-23: Ensure ownership transfer occurs even if webhook fails.
-- This RPC is triggered by markAsReceived (Buyer Action).
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE v_buyer_id uuid;
BEGIN -- 1. Find the buyer ID from the most recent order for this listing.
SELECT buyer_id INTO v_buyer_id
FROM orders
WHERE listing_id = p_listing_id
ORDER BY created_at DESC
LIMIT 1;
-- 2. Update listing status and FORCE ownership transfer to the buyer.
UPDATE listing_items
SET status = 'Draft',
    seller_id = COALESCE(v_buyer_id, seller_id),
    updated_at = NOW()
WHERE id = p_listing_id;
-- 3. Mark the order as completed.
UPDATE orders
SET status = 'completed',
    completed_at = NOW()
WHERE listing_id = p_listing_id
    AND status != 'completed';
END;
$$;
-- 4. Backfill existing 'Draft' or 'Completed' items that SHOULD be owned by the buyer
-- Fixes items that stuck in 'zombie' state (owned by seller but transaction finished)
UPDATE listing_items li
SET seller_id = o.buyer_id
FROM orders o
WHERE li.id = o.listing_id
    AND o.status = 'completed'
    AND li.seller_id = o.seller_id;
-- Only if owner is still the original seller
</file>

<file path="frontend/migrations/31_allow_multiple_orders_per_listing.sql">
-- Migration: Allow Multiple Orders per Listing (Persistent ID Support)
-- 2025-12-23: Remove absolute unique constraint and replace with partial unique index.
-- 1. Identify and Drop the existing unique constraint if it exists.
-- The name might be orders_listing_id_key (standard Postgres naming).
ALTER TABLE public.orders DROP CONSTRAINT IF EXISTS orders_listing_id_key;
-- 2. Create a Partial Unique Index.
-- This allows multiple COMPLETED or CANCELLED orders for the same item (buy/sell history),
-- but ensures only ONE active/pending transaction can exist at any given time.
CREATE UNIQUE INDEX IF NOT EXISTS unique_active_order_per_listing ON public.orders (listing_id)
WHERE (status NOT IN ('completed', 'cancelled'));
-- 3. Comment for clarity
COMMENT ON INDEX unique_active_order_per_listing IS 'Ensures only one active transaction per item, while allowing historical orders to coexist.';
</file>

<file path="frontend/migrations/32_setup_storage.sql">
-- Create a new storage bucket for card images
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true) on conflict (id) do nothing;
-- Set up access policies for the storage bucket
-- 1. Allow public read access to the bucket
create policy "Public Access" on storage.objects for
select using (bucket_id = 'card-images');
-- 2. Allow authenticated users to upload images
create policy "Authenticated users can upload images" on storage.objects for
insert with check (
        bucket_id = 'card-images'
        and auth.role() = 'authenticated'
    );
-- 3. Allow users to update/delete their own images
create policy "Users can update own images" on storage.objects for
update using (
        bucket_id = 'card-images'
        and auth.uid() = owner
    );
create policy "Users can delete own images" on storage.objects for delete using (
    bucket_id = 'card-images'
    and auth.uid() = owner
);
</file>

<file path="frontend/migrations/33_add_image_url_to_live_moments.sql">
-- Migration: Add image_url to live_moments
-- id: 33_add_image_url_to_live_moments
ALTER TABLE public.live_moments
ADD COLUMN IF NOT EXISTS image_url text;
</file>

<file path="frontend/migrations/debug_helper.sql">
-- Migration: Debug Helper (Expose Policies)
-- Creates an RPC to list policies for debugging purposes.
CREATE OR REPLACE FUNCTION get_policies_debug() RETURNS TABLE (
        tablename text,
        policyname text,
        definition text
    ) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT p.tablename::text,
    p.policyname::text,
    p.definition::text
FROM pg_policies p
WHERE p.schemaname = 'public';
END;
$$;
</file>

<file path="frontend/migrations/debug_indexes.sql">
-- Migration: Debug Helper (Expose Indexes)
-- Creates an RPC to list indexes for debugging purposes.
CREATE OR REPLACE FUNCTION get_indexes_debug(p_table_name text) RETURNS TABLE (index_name text, index_definition text) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT i.indexname::text,
    i.indexdef::text
FROM pg_indexes i
WHERE i.tablename = p_table_name
    AND i.schemaname = 'public';
END;
$$;
</file>

<file path="frontend/migrations/debug_triggers.sql">
-- Migration: Debug Helper (Expose Triggers)
-- Creates an RPC to list triggers for debugging purposes.
CREATE OR REPLACE FUNCTION get_triggers_debug() RETURNS TABLE (
        trigger_name text,
        event_manipulation text,
        event_object_table text,
        action_statement text
    ) LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN RETURN QUERY
SELECT t.trigger_name::text,
    t.event_manipulation::text,
    t.event_object_table::text,
    t.action_statement::text
FROM information_schema.triggers t
WHERE t.event_object_schema = 'public';
END;
$$;
</file>

<file path="frontend/migrations/fix_schema_add_condition_rating.sql">
-- Comprehensive Fix: Add ALL potentially missing columns from Migration 04 AND 05

-- 1. Migration 04 Columns (Features & Condition)
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS variation text,
ADD COLUMN IF NOT EXISTS serial_number text,
ADD COLUMN IF NOT EXISTS is_rookie boolean default false,
ADD COLUMN IF NOT EXISTS is_autograph boolean default false,
ADD COLUMN IF NOT EXISTS description text,
ADD COLUMN IF NOT EXISTS condition_rating text;

-- 2. Migration 05 Columns (Basic Info & Decoupling)
ALTER TABLE public.listing_items ALTER COLUMN catalog_id DROP NOT NULL;

ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS player_name text,
ADD COLUMN IF NOT EXISTS team text,
ADD COLUMN IF NOT EXISTS year integer,
ADD COLUMN IF NOT EXISTS manufacturer text; -- This was the missing one reported

-- 3. Comments
COMMENT ON COLUMN public.listing_items.condition_rating IS 'Condition string for raw cards';
COMMENT ON COLUMN public.listing_items.manufacturer IS 'Brand/Manufacturer of the card';

-- 4. Force a schema cache reload
NOTIFY pgrst, 'reload schema';
</file>

<file path="frontend/migrations/production_setup.sql">
-- ======================================================================================
-- PRODUCTION DATABASE SETUP SCRIPT
-- Application: TC-APP (Trading Card App)
-- Generated at: 2026-01-27
--
-- This script consolidates all schema definitions, migrations, and RLS policies.
-- It is designed to be run on a FRESH Supabase instance.
-- ======================================================================================
-- 1. EXTENSIONS
create extension if not exists "uuid-ossp";
-- 2. ENUMS (Initial Definition)
create type manufacturer_enum as enum ('BBM', 'Calbee', 'Epoch', 'Topps_Japan', 'Topps');
create type team_enum as enum (
    'Giants',
    'Tigers',
    'Dragons',
    'Swallows',
    'Carp',
    'BayStars',
    'Hawks',
    'Fighters',
    'Marines',
    'Buffaloes',
    'Eagles',
    'Lions',
    'Dodgers'
);
create type rarity_enum as enum (
    'Common',
    'Rare',
    'Super Rare',
    'Parallel',
    'Autograph',
    'Patch',
    'Rookie',
    'Legend'
);
create type listing_status_enum as enum (
    'Draft',
    'Active',
    'TransactionPending',
    'AwaitingShipment',
    'Shipped',
    'Delivered',
    'Completed',
    'Cancelled'
);
-- Update Enum: Add 'Display', 'Sold', 'Incoming' (from update_status_enum.sql & migration 23)
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Display';
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Sold';
ALTER TYPE listing_status_enum
ADD VALUE IF NOT EXISTS 'Incoming';
-- 3. PROFILES Table
create table public.profiles (
    id uuid references auth.users on delete cascade not null primary key,
    email text unique not null,
    name text,
    avatar_url text,
    real_name_kana text,
    -- Added from migration 08
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);
alter table public.profiles enable row level security;
create policy "Public profiles are viewable by everyone." on public.profiles for
select using (true);
create policy "Users can insert their own profile." on public.profiles for
insert with check (auth.uid() = id);
create policy "Users can update their own profile." on public.profiles for
update using (auth.uid() = id);
-- 4. CARD CATALOGS (Deprecated but kept for reference if needed, largely replaced by loose listing items)
create table public.card_catalogs (
    id uuid default uuid_generate_v4() primary key,
    manufacturer manufacturer_enum not null,
    series_name text,
    player_name text not null,
    team team_enum not null,
    card_number text,
    rarity rarity_enum,
    is_rookie boolean default false,
    year integer,
    created_at timestamptz default now()
);
alter table public.card_catalogs enable row level security;
create policy "Catalog is viewable by everyone." on public.card_catalogs for
select using (true);
-- 5. LISTING ITEMS (Products)
create table public.listing_items (
    id uuid default uuid_generate_v4() primary key,
    catalog_id uuid references public.card_catalogs(id),
    -- Nullable in new schema (migration 05)
    seller_id uuid references public.profiles(id) not null,
    status listing_status_enum default 'Draft'::listing_status_enum not null,
    price integer,
    -- Nullable (migration update_status_enum.sql)
    images jsonb not null,
    condition_grading jsonb not null,
    -- Additional columns from migrations
    origin_order_id uuid,
    -- migration 22 (Recursive references added later)
    deleted_at timestamptz DEFAULT NULL,
    -- migration 21
    moment_history jsonb DEFAULT '[]'::jsonb,
    -- migration 16
    -- Expanded columns (migration 04 consolidated)
    player_name text,
    team text,
    year integer,
    manufacturer text,
    set_name text,
    card_number text,
    is_rookie boolean default false,
    is_autograph boolean default false,
    start_price integer,
    min_bid_price integer,
    condition_rating text,
    -- migration fix_schema
    variation text,
    serial_number text,
    description text,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
);
-- Note: references for origin_order_id will be added after orders table creation
-- 6. ORDERS (Transaction History)
create table public.orders (
    id uuid default uuid_generate_v4() primary key,
    listing_id uuid references public.listing_items(id) not null,
    -- Unique constraint removed/modified in migration 31
    buyer_id uuid references public.profiles(id) not null,
    seller_id uuid references public.profiles(id),
    -- migration 24
    payment_method_id text not null,
    total_amount integer not null,
    status text not null check (
        status IN (
            'pending',
            'paid',
            'awaiting_shipping',
            'shipped',
            'completed',
            'cancelled',
            'returned'
        )
    ),
    -- migration 12
    -- Shipping Details (migration 09 & 12)
    tracking_number text,
    carrier text,
    shipped_at timestamptz,
    completed_at timestamptz,
    shipping_address_snapshot jsonb,
    shipping_name text,
    shipping_postal_code text,
    shipping_address text,
    shipping_phone text,
    -- Live Moments (migration 15)
    moment_snapshot jsonb,
    created_at timestamptz default now()
);
-- Add Circular Reference for listing_items
ALTER TABLE public.listing_items
ADD CONSTRAINT fk_origin_order FOREIGN KEY (origin_order_id) REFERENCES public.orders(id);
-- 7. BANK ACCOUNTS & PAYOUTS (migration 08 & 10 & 11)
CREATE TABLE IF NOT EXISTS public.bank_accounts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL UNIQUE,
    bank_name text NOT NULL,
    branch_name text NOT NULL,
    account_type text NOT NULL,
    account_number text NOT NULL,
    account_holder_name text NOT NULL,
    bank_code text,
    -- migration 10
    branch_code text,
    -- migration 10
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);
CREATE TABLE IF NOT EXISTS public.payouts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    amount integer NOT NULL,
    fee integer not null default 0,
    -- migration 11
    payout_amount integer not null,
    -- migration 11
    status text NOT NULL DEFAULT 'pending',
    created_at timestamptz DEFAULT now(),
    processed_at timestamptz
);
-- 8. LIVE MOMENTS (migration 14, 17, 18)
create table if not exists public.live_moments (
    id uuid default gen_random_uuid() primary key,
    player_name text not null,
    title text not null,
    description text,
    intensity integer not null default 1 check (
        intensity >= 1
        and intensity <= 5
    ),
    match_result text,
    -- migration 17
    is_finalized boolean DEFAULT false,
    -- migration 18
    created_at timestamptz default now()
);
-- 9. INDICES
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Partial index from migration 31
CREATE UNIQUE INDEX IF NOT EXISTS unique_active_order_per_listing ON public.orders (listing_id)
WHERE (status NOT IN ('completed', 'cancelled'));
-- 10. ROW LEVEL SECURITY (Consolidated Final Policies - Migration 27 & 32 mostly)
-- A. Table Enablement
ALTER TABLE public.listing_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.bank_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.live_moments ENABLE ROW LEVEL SECURITY;
-- B. Listings Policies (Non-Recursive)
-- Public Access
CREATE POLICY "Listings_Public_Access" ON public.listing_items FOR
SELECT USING (
        status = 'Active'
        AND deleted_at IS NULL
    );
-- Owner Access
CREATE POLICY "Listings_Owner_Access" ON public.listing_items FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Update" ON public.listing_items FOR
UPDATE USING (seller_id = auth.uid());
CREATE POLICY "Listings_Owner_Delete" ON public.listing_items FOR DELETE USING (seller_id = auth.uid());
-- Transaction History Access (Sold & Bought)
CREATE POLICY "Listings_SoldHistory_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.seller_id = auth.uid()
        )
    );
CREATE POLICY "Listings_InTransit_Access" ON public.listing_items FOR
SELECT USING (
        EXISTS (
            SELECT 1
            FROM public.orders
            WHERE orders.listing_id = listing_items.id
                AND orders.buyer_id = auth.uid()
        )
    );
-- C. Orders Policies
CREATE POLICY "Orders_Buyer_Access" ON public.orders FOR
SELECT USING (buyer_id = auth.uid());
CREATE POLICY "Orders_Seller_Access" ON public.orders FOR
SELECT USING (seller_id = auth.uid());
CREATE POLICY "Users can create orders" ON public.orders FOR
INSERT WITH CHECK (auth.uid() = buyer_id);
-- D. Bank & Payouts Policies
CREATE POLICY "Users can view own bank account" ON public.bank_accounts FOR
SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own bank account" ON public.bank_accounts FOR
INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own bank account" ON public.bank_accounts FOR
UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own bank account" ON public.bank_accounts FOR DELETE USING (auth.uid() = user_id);
CREATE POLICY "Users can view own payouts" ON public.payouts FOR
SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own payouts" ON public.payouts FOR
INSERT WITH CHECK (auth.uid() = user_id);
-- E. Live Moments Policies
CREATE POLICY "Live moments are viewable by everyone" on public.live_moments for
select using (true);
-- 11. STORAGE SETUP (Migration 32)
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true) on conflict (id) do nothing;
create policy "Public Access" on storage.objects for
select using (bucket_id = 'card-images');
create policy "Authenticated users can upload images" on storage.objects for
insert with check (
        bucket_id = 'card-images'
        and auth.role() = 'authenticated'
    );
create policy "Users can update own images" on storage.objects for
update using (
        bucket_id = 'card-images'
        and auth.uid() = owner
    );
create policy "Users can delete own images" on storage.objects for delete using (
    bucket_id = 'card-images'
    and auth.uid() = owner
);
-- 12. TRIGGERS & FUNCTIONS
-- Handle New User
create or replace function public.handle_new_user() returns trigger as $$ begin
insert into public.profiles (id, email, name)
values (
        new.id,
        new.email,
        new.raw_user_meta_data->>'name'
    );
return new;
end;
$$ language plpgsql security definer;
create trigger on_auth_user_created
after
insert on auth.users for each row execute procedure public.handle_new_user();
-- Self-Healing Complete Order (Migration 30)
CREATE OR REPLACE FUNCTION public.complete_order(p_listing_id uuid) RETURNS void LANGUAGE plpgsql SECURITY DEFINER AS $$ BEGIN -- Update listing status to Draft (makes it ownable/visible in Workspace but not listed)
UPDATE listing_items
SET status = 'Draft',
    updated_at = NOW()
WHERE id = p_listing_id;
-- Update order status to completed
UPDATE orders
SET status = 'completed',
    completed_at = NOW()
WHERE listing_id = p_listing_id;
END;
$$;
</file>

<file path="frontend/migrations/reset_data.sql">
-- Clean up data to reset environment
-- Run this in Supabase Dashboard SQL Editor
-- 1. Truncate Transaction Tables (Cascade to ensure dependent data is removed)
-- Note: 'messages' and 'notifications' omitted as they do not exist in current schema on staging.
-- If you added them manually, uncomment lines below:
-- TRUNCATE TABLE messages RESTART IDENTITY CASCADE;
-- TRUNCATE TABLE notifications RESTART IDENTITY CASCADE;
TRUNCATE TABLE orders RESTART IDENTITY CASCADE;
TRUNCATE TABLE listing_items RESTART IDENTITY CASCADE;
TRUNCATE TABLE live_moments RESTART IDENTITY CASCADE;
TRUNCATE TABLE payouts RESTART IDENTITY CASCADE;
-- Note: We generally do NOT delete auth.users to avoid breaking login sessions.
-- The seed script will check if users exist and reuse them if possible.
</file>

<file path="frontend/migrations/Untitled-3">

</file>

<file path="frontend/migrations/Untitled-4">
u
</file>

<file path="frontend/migrations/Untitled-5">

</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/test.html">
<!DOCTYPE html>
<html>
<body>
<h1>Vercel Test</h1>
<p>If you can see this, Vercel is serving static files correctly.</p>
</body>
</html>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/scripts/debug_14fb.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = '14fb9a60-8492-4969-893b-2e8c1668b48c';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        console.log('Listing Data:', order.listing ? 'Found' : 'MISSING');
        if (order.listing) {
            const l = Array.isArray(order.listing) ? order.listing[0] : order.listing;
            console.log(`Listing ID: ${l.id}, Player: ${l.player_name}`);
        }

        // 2. Check for Pinpoint Item
        const { data: pinItems } = await supabase
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', orderId);

        console.log(`Pinpoint Items found: ${pinItems?.length}`);
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_7575.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = '7575e260-6772-487b-83ea-e140e09c680a';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        // 2. Check for Pinpoint Item (origin_order_id)
        const { data: pinItems, error: pinError } = await supabase
            .from('listing_items')
            .select('id, origin_order_id, status, seller_id')
            .eq('origin_order_id', orderId);

        if (pinError) console.error('❌ Pinpoint Query Error:', pinError);
        console.log('Pinpoint Items found:', pinItems);

        // 3. Check for Fuzzy/Recent items for this buyer
        const { data: fuzzyItems } = await supabase
            .from('listing_items')
            .select('id, player_name, created_at, origin_order_id')
            .eq('seller_id', order.buyer_id)
            .order('created_at', { ascending: false })
            .limit(3);

        console.log('Recent Items for Buyer:', fuzzyItems);
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_c376.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debugOrder() {
    const orderId = 'c376ca76-cd87-47af-93ed-2ab0f7dd7a86';
    console.log(`Debug Order: ${orderId}`);

    // 1. Fetch Order and check Relation
    const { data: order, error: orderError } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (orderError) console.error('❌ Order Fetch Error:', orderError);
    else console.log(`✅ Order Found. Status: ${order.status}, Buyer: ${order.buyer_id}`);

    if (order) {
        // Log Listing Details
        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (listing) {
            console.log(`Original Listing: ${listing.id}, Status: ${listing.status}`);
        } else {
            console.log('❌ Original Listing MISSING or null');
        }

        // 2. Check for Pinpoint Item
        const { data: pinItems, error } = await supabase
            .from('listing_items')
            .select('id, origin_order_id, seller_id, status, deleted_at')
            .eq('origin_order_id', orderId);

        if (error) console.error("Query Error:", error);

        console.log(`Pinpoint Items found: ${pinItems?.length}`);
        if (pinItems && pinItems.length > 0) {
            pinItems.forEach(i => {
                console.log(`Item: ${i.id}, Seller: ${i.seller_id}, Origin: ${i.origin_order_id}, Status: ${i.status}`);
                console.log(`Match? Seller=${order.buyer_id === i.seller_id}, Origin=${orderId === i.origin_order_id}`);
            });
        }
    }
}

debugOrder();
</file>

<file path="frontend/scripts/debug_moments.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function check() {
    console.log('--- FETCHING LATEST ORDERS for Roki Sasaki ---');
    const { data: orders } = await supabase
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .order('created_at', { ascending: false })
        .limit(5);

    for (const order of (orders || [])) {
        const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
        if (!listing || !listing.player_name.includes('Roki')) continue;

        console.log(`\nOrder ID: ${order.id}`);
        console.log(`Order Moment Snapshot: ${order.moment_snapshot?.title} (ID: ${order.moment_snapshot?.id})`);

        if (listing) {
            console.log(`Original Listing: ${listing.id}`);
            console.log('Original History:');
            listing.moment_history?.forEach((h: any, idx: number) => {
                console.log(`  [${idx}] ${h.title} (MomentID: ${h.moment_id})`);
            });
        }

        // Check Buyer Clone
        const { data: buyerItem } = await supabase
            .from('listing_items')
            .select('id, moment_history, seller_id')
            .eq('origin_order_id', order.id)
            .single();

        if (buyerItem) {
            console.log(`Buyer Clone Found: ${buyerItem.id}`);
            console.log('Moment History:');
            buyerItem.moment_history?.forEach((h: any, idx: number) => {
                console.log(`  [${idx}] ${h.title} (MomentID: ${h.moment_id}) - Author: ${h.owner_at_time}`);
            });
        } else {
            console.log('Buyer Clone MISSING');
        }
    }
}
check();
</file>

<file path="frontend/scripts/fix_sakamoto.ts">
import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import path from 'path';

// Load env from frontend/.env.local because that's where the new secret is (and likely other configs)
// Load env from .env.local in frontend root
dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase credentials');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function main() {
    console.log('Searching for Sakamoto moment...');

    const { data: moments, error } = await supabase
        .from('live_moments')
        .select('*')
        .ilike('player_name', '%坂本%')
        .ilike('title', '%2000%');

    if (error) {
        console.error('Error fetching moments:', error);
        return;
    }

    if (!moments || moments.length === 0) {
        console.log('No matching moment found.');
        return;
    }

    console.log(`Found ${moments.length} moment(s).`);

    for (const m of moments) {
        console.log(`Updating Moment: ${m.title} (${m.id})`);
        console.log(`Current Result: ${m.match_result}`);

        // Regex to replace content inside parentheses with '9回裏'
        // Or simply replace "Top 1st" if present.
        // User wants "9回裏".
        let newResult = m.match_result;

        // Strategy: Replace the text inside the last parentheses
        if (newResult.includes('(') && newResult.includes(')')) {
            newResult = newResult.replace(/\([^)]+\)$/, '(9回裏)');
        } else {
            // Append if not present?
            newResult = `${newResult} (9回裏)`;
        }

        console.log(`New Result: ${newResult}`);

        // Update live_moments
        const { error: updateError } = await supabase
            .from('live_moments')
            .update({ match_result: newResult })
            .eq('id', m.id);

        if (updateError) {
            console.error('Failed to update live_moments:', updateError);
        } else {
            console.log('✅ live_moments updated.');
        }

        // Also update history in listing_items (Sync)
        // Similar logic to finalizeMoment
        const { data: items, error: fetchError } = await supabase
            .from('listing_items')
            .select('id, moment_history')
            .contains('moment_history', JSON.stringify([{ moment_id: m.id }]));

        if (items && items.length > 0) {
            console.log(`Syncing ${items.length} cards...`);
            for (const item of items) {
                const history = item.moment_history as any[];
                const updatedHistory = history.map(h => {
                    if (h.moment_id === m.id) {
                        return { ...h, match_result: newResult };
                    }
                    return h;
                });

                await supabase
                    .from('listing_items')
                    .update({ moment_history: updatedHistory })
                    .eq('id', item.id);
            }
            console.log('✅ Cards synced.');
        }
    }
}

main();
</file>

<file path="frontend/scripts/seed.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';
import { randomUUID } from 'crypto';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// --- CONFIG ---
const TEST_USERS = [
    {
        email: 'seller@test.com',
        password: 'password123',
        name: 'Test Seller',
        address: {
            postal_code: '100-0005', address_line1: 'Tokyo Chiyoda-ku', address_line2: 'Marunouchi 1-1', phone_number: '090-1111-1111',
            display_name: 'Seller-san',
            first_name: 'Taro',
            last_name: 'Yamada'
        }
    },
    {
        email: 'buyer1@test.com',
        password: 'password123',
        name: 'Test Buyer 1',
        address: {
            postal_code: '530-0001', address_line1: 'Osaka Kita-ku', address_line2: 'Umeda 1-1', phone_number: '080-2222-2222',
            display_name: 'Buyer-kun 1',
            first_name: 'Jiro',
            last_name: 'Suzuki'
        }
    },
    {
        email: 'buyer2@test.com',
        password: 'password123',
        name: 'Test Buyer 2',
        address: {
            postal_code: '460-0008', address_line1: 'Aichi Nagoya-shi Naka-ku', address_line2: 'Sakae 3-5-12', phone_number: '070-3333-3333',
            display_name: 'Buyer-chan 2',
            first_name: 'Hanako',
            last_name: 'Sato'
        }
    },
];

const PLAYERS = [
    { name: 'Roki Sasaki', team: 'Marines', number: 17 },
    { name: 'Shohei Ohtani', team: 'Dodgers', number: 17 },
    { name: 'Munetaka Murakami', team: 'Swallows', number: 55 },
];

async function seed() {
    console.log('🌱 Starting Seed...');

    // 1. Create Users
    console.log('--- Creating Users ---');
    const userMap: Record<string, string> = {}; // email -> id

    for (const u of TEST_USERS) {
        const { data: { users } } = await supabase.auth.admin.listUsers();
        const existing = users.find(user => user.email === u.email);

        if (existing) {
            console.log(`User ${u.email} already exists: ${existing.id}`);
            userMap[u.email] = existing.id;
        } else {
            console.log(`Creating user ${u.email}...`);
            const { data, error } = await supabase.auth.admin.createUser({
                email: u.email,
                password: u.password,
                email_confirm: true,
                user_metadata: { full_name: u.name }
            });
            if (error) {
                console.error(`Failed to create ${u.email}:`, error.message);
            } else if (data.user) {
                userMap[u.email] = data.user.id;
            }
        }

        // Update Profile with Address
        if (userMap[u.email]) {
            const { error: pError } = await supabase
                .from('profiles')
                .update(u.address)
                .eq('id', userMap[u.email]);

            if (pError) console.error(`Failed to update profile for ${u.email}:`, pError.message);
            else console.log(`Updated profile address for ${u.email}`);
        }
    }

    const sellerId = userMap['seller@test.com'];
    const buyer1Id = userMap['buyer1@test.com'];
    const buyer2Id = userMap['buyer2@test.com'];

    if (!sellerId || !buyer1Id) {
        console.error('Failed to setup users');
        return;
    }

    // 3. Create Live Moments
    console.log('--- Creating Live Moments ---');
    const momentIds: string[] = [];
    const momentTemplates = [
        { title: '165km/h Fastball Info', desc: 'Japanese Record Speed!', intensity: 5, status: 'finalized', type: 'RECORD_BREAK' },
        { title: 'Dramatic Walk-off HR', desc: 'Bottom of the 9th, 2 outs.', intensity: 5, status: 'finalized', type: 'HOMERUN' },
        { title: 'Spectacular Diving Catch', desc: 'Saved the game!', intensity: 4, status: 'finalized', type: 'BIG_PLAY' },
        { title: '3000th Strikeout', desc: 'Legendary achievement.', intensity: 5, status: 'live', type: 'BIG_PLAY' }, // Active
        { title: 'Perfect Game Bid', desc: '8th inning completed.', intensity: 5, status: 'live', type: 'BIG_PLAY' }
    ];

    for (const t of momentTemplates) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];
        const { data: moment, error } = await supabase.from('live_moments').insert({
            title: `${player.name}: ${t.title}`,
            description: t.desc,
            player_name: player.name,
            intensity: t.intensity,
            is_finalized: t.status === 'finalized',
            match_result: t.status === 'finalized' ? 'WIN 3-2' : undefined,
            type: t.type
        }).select().single();

        if (error) console.error('Moment error:', error.message);
        else if (moment) {
            momentIds.push(moment.id);
            console.log(`Created moment: ${moment.id} (${t.title})`);
        }
    }

    // 4. Create Listings (Active)
    console.log('--- Creating Active Listings ---');
    const listingIds: string[] = [];

    for (let i = 0; i < 10; i++) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];
        const price = (Math.floor(Math.random() * 50) + 1) * 1000; // 1000 - 50000

        const { data: item, error } = await supabase.from('listing_items').insert({
            seller_id: sellerId,
            player_name: player.name,
            team: player.team,
            series_name: '2025 Legend Series',
            card_number: `LS-${String(i).padStart(3, '0')}`,
            price: price,
            status: 'Active',
            images: [`https://placehold.co/400x600/202020/FFF?text=${encodeURIComponent(player.name)}`],
            description: `Seeded Item #${i}. Mint condition.`,
            condition_grading: 'Gem Mint 10',
            condition_rating: 10,
            year: 2025,
            manufacturer: 'Stadium Card',
            is_live_moment: Math.random() > 0.5,
            moment_history: [] // Initially empty
        }).select().single();

        if (error) console.error('Listing error:', error.message);
        else if (item) listingIds.push(item.id);
    }

    // 5. Create Sold Listings & Orders (History)
    console.log('--- Creating Sold History ---');
    for (let i = 0; i < 3; i++) {
        const player = PLAYERS[Math.floor(Math.random() * PLAYERS.length)];

        // Original Listing (Sold)
        const { data: original, error: lError } = await supabase.from('listing_items').insert({
            seller_id: sellerId,
            player_name: player.name,
            price: 5000,
            status: 'Completed', // Sold
            images: [`https://placehold.co/400x600/333/FFF?text=SOLD-${i}`],
            description: `Sold Item #${i}`,
            moment_history: []
        }).select().single();

        if (original) {
            // Buyer Item (Clone)
            const { data: item, error: cError } = await supabase.from('listing_items').insert({
                seller_id: buyer1Id,
                player_name: player.name,
                price: 0,
                status: 'Draft',
                moment_history: [
                    // Add a seeded memory
                    {
                        moment_id: momentIds[0] || 'seed-moment',
                        title: 'Seeded Memory',
                        timestamp: new Date().toISOString(),
                        memories: [
                            {
                                id: randomUUID(),
                                author_id: sellerId,
                                author_name: 'Test Seller',
                                text: 'Thank you for buying!',
                                created_at: new Date(Date.now() - 86400000).toISOString(),
                                is_hidden: false
                            },
                            {
                                id: randomUUID(),
                                author_id: buyer1Id,
                                author_name: 'Test Buyer 1',
                                text: 'Testing memory timeline array!',
                                created_at: new Date().toISOString(),
                                is_hidden: false
                            }
                        ]
                    }
                ]
            }).select().single();

            // Order Record
            if (item) {
                await supabase.from('orders').insert({
                    listing_id: original.id,
                    buyer_id: buyer1Id,
                    seller_id: sellerId, // Fix: Explicitly set seller_id
                    status: 'completed',
                    total_amount: 5000,
                    stripe_payment_intent_id: `pi_seed_${i}`,
                    shipping_address: { postal_code: "000-0000", line1: "Test City" }
                });
                console.log(`Created sold history for ${original.id}`);
            }
        }
    }

    console.log('✅ Seed Complete!');
}

seed().catch(e => console.error(e));
</file>

<file path="frontend/scripts/simulate_action.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../.env.local') });

const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function simulateAction() {
    const orderId = 'c376ca76-cd87-47af-93ed-2ab0f7dd7a86';
    console.log(`--- Simulating getBuyerItemByOrder for ${orderId} ---`);

    // 1. Get Order & Buyer
    const { data: order, error: oErr } = await supabaseAdmin
        .from('orders')
        .select('listing_id, buyer_id, created_at, status, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (oErr || !order) {
        console.error("Step 1 Failed: Order not found or ambiguous.", oErr);
        return;
    }
    console.log(`Step 1 Success: Order found. Buyer ID: ${order.buyer_id}`);

    const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;

    // Simulate Auto-Recovery Insert
    console.log("\n--- Testing Auto-Recovery Insert ---");
    const payload = {
        player_name: listing.player_name,
        team: listing.team,
        year: listing.year,
        manufacturer: listing.manufacturer,
        series_name: listing.series_name,
        card_number: listing.card_number,
        images: listing.images,
        condition_grading: listing.condition_grading,
        condition_rating: listing.condition_rating,
        variation: listing.variation,
        serial_number: listing.serial_number,
        is_rookie: listing.is_rookie,
        is_autograph: listing.is_autograph,
        description: listing.description,
        is_live_moment: listing.is_live_moment,
        seller_id: order.buyer_id, // Current User is Buyer
        status: 'Draft',
        price: 0,
        origin_order_id: orderId,
        moment_history: listing.moment_history || []
    };

    const { data: recoveredItem, error: recoveryError } = await supabaseAdmin
        .from('listing_items')
        .insert(payload)
        .select('id')
        .single();

    if (recoveryError) {
        console.error("❌ Insert Failed:", recoveryError);
        console.log("Payload:", payload);
    } else {
        console.log("✅ Insert Success:", recoveredItem.id);
    }
}

simulateAction();
</file>

<file path="frontend/scripts/test-gemini.ts">
import { config } from 'dotenv';
import path from 'path';

// Load env from frontend/.env.local (assuming that's where keys are)
// We need to resolve the path relative to where we run the script
// If running from root, path is frontend/.env.local
config({ path: path.resolve(process.cwd(), 'frontend/.env.local') });

const apiKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY;

if (!apiKey) {
    console.error('❌ GOOGLE_GENERATIVE_AI_API_KEY is missing from process.env');
    process.exit(1);
}

console.log('🔑 API Key found:', apiKey.slice(0, 5) + '...');

async function listModels() {
    const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
            console.error('❌ API Error:', data.error);
            return;
        }

        if (data.models) {
            console.log('✅ Available Models:');
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            data.models.forEach((m: any) => {
                // Filter for likely candidates
                if (m.name.includes('gemini')) {
                    console.log(`- ${m.name} (${m.supportedGenerationMethods})`);
                }
            });
        } else {
            console.log('⚠️ No models returned.', data);
        }

    } catch (e) {
        console.error('❌ Network/Fetch Error:', e);
    }
}

listModels();
</file>

<file path="frontend/types/index.ts">
export type Manufacturer = "BBM" | "Calbee" | "Epoch" | "Topps_Japan";
export type Team = "Giants" | "Tigers" | "Dragons" | "Swallows" | "Carp" | "BayStars" | "Hawks" | "Fighters" | "Marines" | "Buffaloes" | "Eagles" | "Lions" | "SamuraiJapan" | "Other";
export type Rarity = "Common" | "Rare" | "Super Rare" | "Parallel" | "Autograph" | "Patch";

export interface CardCatalog {
    id: string;
    manufacturer: Manufacturer;
    year: number;
    series_name?: string;
    player_name: string;
    team: Team;
    card_number?: string;
    rarity?: Rarity;
    is_rookie: boolean;
}

export interface ConditionGrading {
    is_graded: boolean;
    service: string;
    score?: number;
    certification_number?: string;
}

export interface Profile {
    id: string;
    email: string;
    display_name?: string;
    name?: string;
    first_name?: string;
    last_name?: string;
    avatar_url?: string;
    phone_number?: string;
    postal_code?: string;
    address_line1?: string;
    address_line2?: string;
    real_name_kana?: string;
}

export interface BankAccount {
    id: string;
    user_id: string;
    bank_name: string;
    bank_code?: string;
    branch_name: string;
    branch_code?: string;
    account_type: 'ordinary' | 'current';
    account_number: string;
    account_holder_name: string;
    created_at: string;
}

export interface Payout {
    id: string;
    user_id: string;
    amount: number;
    fee: number;
    payout_amount?: number;
    status: 'pending' | 'paid' | 'rejected';
    created_at: string;
    processed_at?: string;
}

export interface ListingItem {
    id: string;
    // catalog_id: string; // Removed
    price: number | null;
    images: string[];
    condition_grading: ConditionGrading;
    seller_id: string;
    status: string;

    // Flat Fields (Backfilled from Catalog)
    player_name: string | null; // Made nullable but effectively populated
    team: string | null;
    year: number | null;
    manufacturer: string | null;
    series_name?: string | null;
    card_number?: string | null;
    variation?: string | null;
    serial_number?: string | null;
    is_rookie?: boolean;
    is_autograph?: boolean;
    description?: string | null;
    condition_rating?: string | null;

    // catalog: CardCatalog | null; // Removed
    seller?: Profile; // Can be joined
    is_live_moment?: boolean;
    live_moments?: any[];
    moment_history?: MomentHistoryItem[];
    orders?: any[] | any; // Joined via Supabase
    origin_order?: any; // Joined via Supabase
}

export interface MomentHistoryItem {
    moment_id: string;
    timestamp: string;
    title: string;
    player_name: string;
    intensity: number;
    description?: string;
    match_result?: string;
    owner_at_time?: string;
    status?: 'pending' | 'finalized';
}

export interface SellerOrderDetail {
    id: string;
    status: string;
    listing: {
        id: string;
        title: string;
        seller_id: string;
        series_name: string;
        player_name: string;
        images: string[];
        price: number;
    };
    total_amount: number;
    created_at: string;
    // Snapshot of address at time of purchase
    shipping_address_snapshot: {
        name: string;
        postal_code: string;
        address: string;
        phone: string;
    } | null;
    // Legacy fallback columns
    shipping_name?: string;
    shipping_address?: string;
    shipping_postal_code?: string;
    shipping_phone?: string;

    // Shipment details
    tracking_number?: string;
    carrier?: string;
    shipped_at?: string;
    completed_at?: string;
}
</file>

<file path="frontend/utils/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
    return createBrowserClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key'
    )
}
</file>

<file path="frontend/utils/supabase/middleware.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    })

    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key',
        {
            cookies: {
                get(name: string) {
                    return request.cookies.get(name)?.value
                },
                set(name: string, value: string, options: CookieOptions) {
                    request.cookies.set({
                        name,
                        value,
                        ...options,
                    })
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    response.cookies.set({
                        name,
                        value,
                        ...options,
                    })
                },
                remove(name: string, options: CookieOptions) {
                    request.cookies.set({
                        name,
                        value: '',
                        ...options,
                    })
                    response = NextResponse.next({
                        request: {
                            headers: request.headers,
                        },
                    })
                    response.cookies.set({
                        name,
                        value: '',
                        ...options,
                    })
                },
            },
        }
    )

    const { data: { user } } = await supabase.auth.getUser()

    // Admin Access Control
    if (request.nextUrl.pathname.startsWith('/admin')) {
        // Exclude diagnostic routes
        if (request.nextUrl.pathname.includes('debug')) {
            return response;
        }

        const adminEmailsRaw = process.env.NEXT_PUBLIC_ADMIN_EMAILS || process.env.ADMIN_EMAILS || '';
        const adminEmails = adminEmailsRaw
            .split(/[,;|]+/)
            .map(e => e.trim().toLowerCase())
            .filter(Boolean);

        const userEmail = user?.email?.toLowerCase();

        if (!user || !userEmail || !adminEmails.includes(userEmail)) {
            // Internal redirect to a specific error page if needed, but for now just console/home
            const reason = !user
                ? 'no_user'
                : !userEmail
                    ? 'no_email'
                    : `not_in_list`;

            // Create debug URL
            const debugUrl = new URL('/', request.url);
            debugUrl.searchParams.set('debug_error', 'admin_access_denied');
            debugUrl.searchParams.set('debug_reason', reason);
            debugUrl.searchParams.set('debug_email', userEmail || 'none');
            debugUrl.searchParams.set('debug_env_len', String(adminEmails.length));

            console.log(`[AUTH] Access Denied: User "${userEmail || 'none'}" not in admin list: [${adminEmails.join('|')}]`);
            return NextResponse.redirect(debugUrl)
        }
    }

    return response
}
</file>

<file path="frontend/utils/supabase/server.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co',
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key',
        {
            cookies: {
                get(name: string) {
                    return cookieStore.get(name)?.value
                },
                set(name: string, value: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value, ...options })
                    } catch (error) {
                        // The `set` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
                remove(name: string, options: CookieOptions) {
                    try {
                        cookieStore.set({ name, value: '', ...options })
                    } catch (error) {
                        // The `delete` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/check_all_clones.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders:orders!origin_order_id(*)')
        .eq('seller_id', buyerId);

    console.log('--- All Items for Buyer2 ---');
    items?.forEach(item => {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        console.log(`Item: ${item.id}, Status: ${item.status}, Player: ${item.player_name}, OriginOrder: ${item.origin_order_id}, OrderStatus: ${order?.status}`);
    });
}

debug();
</file>

<file path="frontend/check_constraints.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data, error } = await supabaseAdmin.rpc('get_table_constraints', { t_name: 'listing_items' });
    if (error) {
        // Fallback: try querying information_schema
        const { data: constraints, error: cError } = await supabaseAdmin.from('information_schema.table_constraints').select('*').eq('table_name', 'listing_items');
        console.log('Constraints:', constraints);
    } else {
        console.log('Constraints:', data);
    }
}

// Since RLS might block information_schema, I will try a direct SQL query via a temporary function if needed, 
// but first let's see if I can just find it in migrations.
debug();
</file>

<file path="frontend/check_enum.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: enumValues, error } = await supabaseAdmin.rpc('get_enum_values', { enum_name: 'listing_status_enum' });
    if (error) {
         // Fallback SQL
         console.error('Error fetching enum:', error);
    } else {
        console.log('Enum values:', enumValues);
    }
}

debug();
</file>

<file path="frontend/check_images.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('id, player_name, price, images, origin_order_id')
        .ilike('player_name', '%Sasaki%');

    console.log('--- Sasaki Item Images ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Price: ${item.price}, Order: ${item.origin_order_id}, Image: ${item.images?.[0]?.substring(0, 50)}...`);
    });
}

debug();
</file>

<file path="frontend/check_item_details.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const itemId = '8e8eb573-060b-44e6-8436-e8008c9db422';
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', itemId)
        .single();

    console.log('--- Item 8e8eb573 Details ---');
    console.log(`Player: ${item.player_name}`);
    console.log(`Description: ${item.description}`);
    console.log(`Price: ${item.price}`);
    console.log(`OriginOrder: ${item.origin_order_id}`);
}

debug();
</file>

<file path="frontend/check_moments.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .ilike('player_name', '%Roki%');
    
    console.log('--- Roki Moments ---');
    console.log(moments);
}

debug();
</file>

<file path="frontend/check_order_prices.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(price, player_name)')
        .eq('buyer_id', '868187c0-f34f-47c7-9449-bc829a212cff');

    console.log('--- Orders for Buyer 2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order: ${o.id} | Status: ${o.status} | Price: ${listing?.price} | Player: ${listing?.player_name}`);
    });
}

debug();
</file>

<file path="frontend/check_original_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const listingId = '2dc382b1-881d-4c95-b228-8687c39d1548';
    const { data: listing } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', listingId)
        .single();

    console.log('--- Original 30k Listing ---');
    console.log(JSON.stringify(listing, null, 2));

    // Try to SIMULATE CLONING
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    const clonePayload = {
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            seller_id: buyerId,
            status: 'AwaitingShipment', // My new fallback
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
    };

    console.log('\n--- Simulating Insert ---');
    const { data: cloned, error: cloneError } = await supabaseAdmin
        .from('listing_items')
        .insert(clonePayload)
        .select('id')
        .single();

    if (cloneError) {
        console.error('INSERT FAILED:', cloneError.message, cloneError.code);
    } else {
        console.log('INSERT SUCCESS:', cloned.id);
    }
}

debug();
</file>

<file path="frontend/check_prices.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId);

    console.log('--- Items for Buyer2 ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, Player: ${item.player_name}, Price: ${item.price}, OriginOrder: ${item.origin_order_id}`);
    });
}

debug();
</file>

<file path="frontend/check_schema.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // 1. Check orders table columns
    const { data: orderSample } = await supabaseAdmin.from('orders').select('*').limit(1).single();
    console.log('--- Orders Table Columns ---');
    console.log(Object.keys(orderSample || {}));

    // 2. Check listing_items table columns
    const { data: itemSample } = await supabaseAdmin.from('listing_items').select('*').limit(1).single();
    console.log('\n--- Listing Items Table Columns ---');
    console.log(Object.keys(itemSample || {}));
}

debug();
</file>

<file path="frontend/check_seller.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const sellerId = '1380fba9-8aff-41c7-9a90-0e5752a63526';
    const { data: { user } } = await supabaseAdmin.auth.admin.getUserById(sellerId);
    console.log('Seller:', user?.email, user?.user_metadata?.full_name);
}

debug();
</file>

<file path="frontend/check_statuses.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // Get unique statuses from the table
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .select('status');
    
    if (data) {
        const statuses = Array.from(new Set(data.map(d => d.status)));
        console.log('Unique statuses found in DB:', statuses);
    }
}

debug();
</file>

<file path="frontend/cleanup_ohtani.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function cleanup() {
    const orderId = '8c637d61-eb0a-47c7-9434-4a8f95a69ed8';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    // 1. Find the card
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId)
        .eq('seller_id', buyerId)
        .single();

    if (item) {
        console.log('--- Current Item History ---');
        console.log(JSON.stringify(item.moment_history, null, 2));

        // The user says "Perfect Game Bid" was incorrectly added.
        // Snapshot for this order was "Dramatic Walk-off HR".
        // History should only have whatever was on the original card + Dramatic Walk-off HR.
        
        // Original card history (based on my earlier check of b0f042cd) was just "3000th Strikeout".
        const correctedHistory = [
            {
                "title": "Shohei Ohtani: 3000th Strikeout",
                "moment_id": "b9c3957d-8925-4a40-a0fa-4c6af0480ae9",
                "player_name": "Shohei Ohtani"
                // ... other fields simplified or restored
            },
            {
                "title": "Shohei Ohtani: Dramatic Walk-off HR",
                "moment_id": "52cded48-b34f-4ceb-ab42-078d4e0a708e",
                "player_name": "Shohei Ohtani",
                "owner_at_time": orderId,
                "status": "pending",
                "timestamp": new Date().toISOString()
            }
        ];

        console.log('\n--- Correcting History ---');
        const { error } = await supabaseAdmin
            .from('listing_items')
            .update({ moment_history: correctedHistory })
            .eq('id', item.id);
        
        if (!error) console.log('Fixed buyer copy!');
    }

    // 2. Clear contamination from original listing
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';
    const { data: original } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (original) {
        // Keep only the "3000th Strikeout" or whatever was there before.
        const cleanHistory = (original.moment_history || []).filter((m: any) => 
            m.moment_id === 'b9c3957d-8925-4a40-a0fa-4c6af0480ae9'
        );
        await supabaseAdmin.from('listing_items').update({ moment_history: cleanHistory }).eq('id', listingId);
        console.log('Cleaned original listing contamination!');
    }
}

cleanup();
</file>

<file path="frontend/debug_22k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 22000 && listing?.player_name?.includes('Ohtani');
    });

    if (specificOrder) {
        console.log('\n--- Found 22k Order ---');
        console.log('Order Snapshot:', JSON.stringify(specificOrder.moment_snapshot, null, 2));

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        items?.forEach(item => {
            console.log(`Item ID: ${item.id}, Status: ${item.status}`);
            console.log('Moment History:', JSON.stringify(item.moment_history, null, 2));
        });
    }

    // 3. Check Ohtani Moments
    const { data: moments } = await supabaseAdmin
        .from('live_moments')
        .select('*')
        .eq('player_name', 'Shohei Ohtani');
    
    console.log('\n--- All Ohtani Moments ---');
    console.log(moments);
}

debug();
</file>

<file path="frontend/debug_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 30000 && listing?.player_name?.includes('Sasaki');
    });

    if (specificOrder) {
        console.log('\n--- Found 30k Order ---');
        console.log('Order Status:', specificOrder.status);

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        items?.forEach(item => {
            console.log(`Item ID: ${item.id}, Status: ${item.status}, CreatedAt: ${item.created_at}`);
        });
    } else {
        console.log('\n30k Sasaki order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_39k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find the order
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('--- Orders for Buyer2 ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        return listing?.price === 39000 && listing?.player_name?.includes('Roki');
    });

    if (specificOrder) {
        console.log('\n--- Found 39k Order ---');
        console.log(specificOrder);

        // 2. Check for clones
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items ---');
        console.log(items);

        // 3. Try to RUN getBuyerItemByOrder via script to see error
        console.log('\n--- Triggering getBuyerItemByOrder ---');
        // I'll import it dynamically or just use direct logic to see what happens
        const { getBuyerItemByOrder } = await import('./app/actions/item');
        try {
            const result = await getBuyerItemByOrder(specificOrder.id);
            console.log('Recovery Result:', result);
        } catch (e) {
            console.error('Recovery Error:', e);
        }
    } else {
        console.log('Order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_all_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId)
        .is('deleted_at', null);
    
    console.log('--- All Items for Buyer2 ---');
    console.log(items);
}

debug();
</file>

<file path="frontend/debug_missing_card.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function debug() {
    // 1. Find buyer2
    const { data: profiles } = await supabaseAdmin
        .from('profiles')
        .select('id, display_name, email')
        .eq('email', 'buyer2@test.com');
    
    console.log('--- Profiles found ---');
    console.log(profiles);

    if (!profiles || profiles.length === 0) {
        console.log('Buyer not found.');
        return;
    }

    const buyerId = profiles[0].id;

    // 2. Find relevant orders
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('\n--- Recent Orders for Buyer ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    const specificOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Ohtani') && listing?.price === 3444;
    });

    if (specificOrder) {
        console.log('\n--- Found Specific Order ---');
        console.log(specificOrder);

        // 3. Find Cloned Item
        const { data: items } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('origin_order_id', specificOrder.id);
        
        console.log('\n--- Cloned Items for this Order ---');
        console.log(items);

        // 4. Find ANY items owned by this buyer with status Incoming or Draft
        const { data: allItems } = await supabaseAdmin
            .from('listing_items')
            .select('id, player_name, status, origin_order_id')
            .eq('seller_id', buyerId)
            .is('deleted_at', null);
        
        console.log('\n--- All Active Items for Buyer ---');
        console.log(allItems);
    } else {
        console.log('Specific Ohtani order not found.');
    }
}

debug();
</file>

<file path="frontend/debug_roki.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

// Load .env.local
dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function debug() {
    // 1. Find buyer2
    const { data: profiles } = await supabaseAdmin
        .from('profiles')
        .select('id, display_name, email')
        .eq('email', 'buyer2@test.com');
    
    if (!profiles || profiles.length === 0) {
        console.log('Buyer not found.');
        return;
    }

    const buyerId = profiles[0].id;

    // 2. Find relevant orders
    const { data: orders } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('buyer_id', buyerId)
        .order('created_at', { ascending: false });

    console.log('\n--- Recent Orders for Buyer ---');
    orders?.forEach(o => {
        const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
        console.log(`Order ID: ${o.id}, Status: ${o.status}, Price: ${listing?.price}, Player: ${listing?.player_name}`);
    });

    // Check specific 15,000 order
    const missingOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Roki') && listing?.price === 15000;
    });

    // Check successful 2,000 order
    const okOrder = orders?.find(o => {
      const listing = Array.isArray(o.listing) ? o.listing[0] : o.listing;
      return listing?.player_name?.includes('Roki') && listing?.price === 2000;
    });

    if (missingOrder) {
        console.log('\n--- Found Missing Order (15k) ---');
        console.log(missingOrder);
        const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', missingOrder.id);
        console.log('Clones for 15k:', items);
    }

    if (okOrder) {
        console.log('\n--- Found OK Order (2k) ---');
        console.log(okOrder);
        const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', okOrder.id);
        console.log('Clones for 2k:', items);
    }
}

debug();
</file>

<file path="frontend/debug_success_item.js">
const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function debugSuccessItem() {
    console.log("--- Scanning Recent Orders (Large) ---");
    const { data: orders, error: orderErr } = await supabase
        .from('orders')
        .select('id, listing_id, buyer_id, created_at, status')
        .order('created_at', { ascending: false })
        .limit(20);

    if (orderErr) {
        console.error("Order Fetch Error:", orderErr);
        return;
    }

    for (const order of orders) {
        // Fetch original listing
        const { data: original } = await supabase
            .from('listing_items')
            .select('id, player_name, series_name, seller_id')
            .eq('id', order.listing_id)
            .single();

        if (!original) continue;
        if (!original.player_name.includes("山本")) continue; // Focus on Yamamoto for now

        console.log(`\nOrder: ${order.id}`);
        console.log(`Status: ${order.status} | Buyer: ${order.buyer_id} | Created: ${order.created_at}`);
        console.log(`Original Card: ${original.player_name} (${original.series_name}) | Seller: ${original.seller_id}`);

        // Look for current buyer's items
        const { data: buyerItems } = await supabase
            .from('listing_items')
            .select('id, seller_id, player_name, series_name, created_at')
            .eq('seller_id', order.buyer_id)
            .order('created_at', { ascending: false })
            .limit(20);

        console.log(`Buyer Items Found: ${buyerItems?.length || 0}`);
        if (buyerItems) {
            buyerItems.forEach(item => {
                const match = item.player_name?.trim() === original.player_name?.trim() &&
                    item.series_name?.trim() === original.series_name?.trim();
                console.log(` - [${match ? 'MATCH' : ' '} ] ${item.id} | ${item.player_name} | ${item.created_at}`);
            });
        }
    }
}

debugSuccessItem();
</file>

<file path="frontend/deep_check_8e8eb573.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const itemId = '8e8eb573-060b-44e6-8436-e8008c9db422';
    const { data: item } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', itemId)
        .single();

    console.log('--- Item 8e8eb573 History ---');
    console.log(JSON.stringify(item.moment_history, null, 2));

    const orderId30k = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const has30k = item.moment_history?.some((m: any) => m.owner_at_time === orderId30k);
    console.log(`\nContains 30k Order ID: ${has30k}`);

    // Try to find the 30k order details
    const { data: order30k } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId30k)
        .single();
    
    console.log('\n--- 30k Order Details ---');
    console.log(`Status: ${order30k?.status}`);
    console.log(`ListingID: ${order30k?.listing_id}`);
}

debug();
</file>

<file path="frontend/dump_workspace.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const userId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // Emulate app/collection/page.tsx:fetchData
    const { data: listingsData } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders!listing_id(*), origin_order:orders!origin_order_id(status, id)')
        .eq('seller_id', userId)
        .is('deleted_at', null);

    console.log('--- Raw Items for Buyer 2 ---');
    listingsData?.forEach(item => {
        const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        console.log(`ID: ${item.id} | Status: ${item.status} | Player: ${item.player_name} | OriginOrder: ${item.origin_order_id} | OrderStatus: ${originOrder?.status}`);
    });

    console.log('\n--- Workspace Filter Results ---');
    const workspaceListings = listingsData?.filter(item => {
        const isCorrectStatus = ['Active', 'Display', 'Draft'].includes(item.status);
        const originOrder = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        const isTransactionComplete = !item.origin_order_id || (originOrder?.status === 'completed');
        return isCorrectStatus && isTransactionComplete;
    });

    workspaceListings?.forEach(item => {
        console.log(`VISIBLE: ID: ${item.id} | Player: ${item.player_name}`);
    });
}

debug();
</file>

<file path="frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend/final_cleanup.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function cleanup() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2
    const orderId30k = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId);

    for (const item of (items || [])) {
        if (!item.moment_history) continue;
        
        const originalCount = item.moment_history.length;
        const cleaned = item.moment_history.filter((m: any) => m.owner_at_time !== orderId30k);
        
        if (cleaned.length !== originalCount && item.id !== 'd670a908-a901-464d-bc3e-929bc04f3830') {
            console.log(`Cleaning item ${item.id} (${item.player_name})...`);
            await supabaseAdmin
                .from('listing_items')
                .update({ moment_history: cleaned })
                .eq('id', item.id);
        }
    }
}

cleanup();
</file>

<file path="frontend/find_30k_card.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .ilike('player_name', '%Sasaki%')
        .eq('price', 30000);

    console.log('--- 30k Sasaki Cards found in DB ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, SellerID: ${item.seller_id}, Deletion: ${item.deleted_at}`);
    });

}

debug();
</file>

<file path="frontend/find_buyer1_clone.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = '1e449fd3-d389-4481-aa47-01e64b7d66a8';
    const { data: item } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', orderId).single();
    if (item) {
        console.log('--- Buyer 1 Clone ---');
        console.log(JSON.stringify(item, null, 2));
    } else {
        console.log('Buyer 1 clone not found.');
    }
}

debug();
</file>

<file path="frontend/find_buyer2.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const { data: { users } } = await supabaseAdmin.auth.admin.listUsers();
    const buyer2 = users?.find(u => u.user_metadata?.full_name?.includes('Buyer 2') || u.email?.includes('buyer2'));
    if (buyer2) {
        console.log('Buyer 2 Found:', buyer2.id, buyer2.email);
    } else {
        console.log('Buyer 2 not found by Name/Email. Searching by my presumed ID...');
        const presumedId = '868187c0-f34f-47c7-9449-bc829a212cff';
        const target = users?.find(u => u.id === presumedId);
        if (target) {
            console.log('Found user with presumed ID:', target.id, target.email, target.user_metadata?.full_name);
        } else {
            console.log('No user found with presumed ID.');
        }
    }
}

debug();
</file>

<file path="frontend/find_sasaki_30k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders:orders!origin_order_id(*)')
        .eq('seller_id', buyerId)
        .ilike('player_name', '%Sasaki%');

    console.log('--- Sasaki Items for Buyer2 ---');
    items?.forEach(item => {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        console.log(`ID: ${item.id}, Status: ${item.status}, Price: ${item.price}, OriginOrder: ${item.origin_order_id}, OrderStatus: ${order?.status}`);
    });
}

debug();
</file>

<file path="frontend/find_sold_logic.ts">
import fs from 'fs';
import path from 'path';

const filePath = '/Users/jun_yoshida/Documents/my-pj/TC-APP/frontend/app/collection/page.tsx';
const content = fs.readFileSync(filePath, 'utf-8');

const regex = /\/\/\s*History:\s*Sold\s*Items[\s\S]*?setHistorySold/g;
const match = content.match(regex);
if (match) {
    console.log(match[0]);
} else {
    console.log('Not found');
}
</file>

<file path="frontend/find_specific_clone.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4';
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId);

    console.log(`--- Items for Order ${orderId} ---`);
    if (items && items.length > 0) {
        items.forEach(item => {
            console.log(`ID: ${item.id}, Status: ${item.status}, SellerID: ${item.seller_id}`);
        });
    } else {
        console.log('None found.');
    }
}

debug();
</file>

<file path="frontend/fix_buyer2_stuck_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function fix() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // 1. Find items owned by buyer2 that have an origin_order_id and are 'Draft'
    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, orders!origin_order_id(status)')
        .eq('seller_id', buyerId)
        .eq('status', 'Draft')
        .not('origin_order_id', 'is', null);

    console.log(`Checking ${items?.length} potential stuck items...`);

    for (const item of (items || [])) {
        const order = Array.isArray(item.orders) ? item.orders[0] : item.orders;
        if (order && order.status !== 'completed') {
            console.log(`Item ${item.id} (${item.player_name}) is Draft but Order ${item.origin_order_id} is ${order.status}. Moving to AwaitingShipment...`);
            await supabaseAdmin
                .from('listing_items')
                .update({ status: 'AwaitingShipment' })
                .eq('id', item.id);
        }
    }
}

fix();
</file>

<file path="frontend/fix_final.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function fix() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const { data: items } = await supabaseAdmin.from('listing_items').select('*').eq('seller_id', buyerId);
    
    for (const item of (items || [])) {
        if (item.player_name === 'Shohei Ohtani' && item.moment_history?.length > 1) {
            console.log(`Found Ohtani item ${item.id} with ${item.moment_history.length} moments.`);
            console.log('History:', JSON.stringify(item.moment_history, null, 2));

            // Remove "Perfect Game Bid" if it matches buyer1's order ID or is just extra
            const corrected = item.moment_history.filter((m: any) => 
                m.title !== 'Shohei Ohtani: Perfect Game Bid'
            );

            if (corrected.length !== item.moment_history.length) {
                console.log(`Correcting item ${item.id}...`);
                await supabaseAdmin.from('listing_items').update({ moment_history: corrected }).eq('id', item.id);
                console.log('DONE.');
            }
        }
    }
}

fix();
</file>

<file path="frontend/get_enum_values.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // We can't query enums directly via JS client usually, but we can try to trigger an error or use an RPC if available.
    // Alternatively, we can check the migrations or just try to insert a garbage value and read the error message which often lists valid values.
    const { error } = await supabaseAdmin
        .from('listing_items')
        .insert({ 
            player_name: 'TEST', 
            status: 'GARBAGE_VALUE_FOR_ERROR' 
        });
    
    if (error) {
        console.log('Error Message (should list valid values):', error.message);
    }
}

debug();
</file>

<file path="frontend/get_status_enum.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    // Query to get enum name and values for a column
    const query = `
        SELECT 
            t.typname AS enum_name,  
            e.enumlabel AS enum_value
        FROM pg_type t 
        JOIN pg_enum e ON t.oid = e.enumtypid  
        JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
        WHERE t.typname = 'listing_status_enum';
    `;

    const { data, error } = await supabaseAdmin.rpc('run_sql_query', { query_text: query });
    if (error) {
        console.error('Error:', error);
        // If RPC not available, try to find in table columns
        const { data: cols } = await supabaseAdmin.from('information_schema.columns').select('udt_name').eq('table_name', 'listing_items').eq('column_name', 'status');
        console.log('Columns metadata:', cols);
    } else {
        console.log('Enum Details:', data);
    }
}

debug();
</file>

<file path="frontend/inspect_listing.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    console.log('--- Original Listing ---');
    console.log(JSON.stringify(listing?.moment_history, null, 2));

    const { data: clones } = await supabaseAdmin.from('listing_items').select('*').eq('origin_order_id', '8c637d61-eb0a-47c7-9434-4a8f95a69ed8');
    console.log('\n--- Direct Clones ---');
    console.log(JSON.stringify(clones?.map(c => ({ id: c.id, history: c.moment_history })), null, 2));

    const { data: allBuyerOhtani } = await supabaseAdmin.from('listing_items').select('*').eq('seller_id', buyerId).ilike('player_name', '%Ohtani%');
    console.log('\n--- All Buyer Ohtani Cards ---');
    console.log(JSON.stringify(allBuyerOhtani?.map(c => ({ id: c.id, price: c.price, history: c.moment_history })), null, 2));
}

debug();
</file>

<file path="frontend/list_buyer2_items.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('seller_id', buyerId)
        .is('deleted_at', null);

    console.log('--- Items owned by Buyer2 ---');
    items?.forEach(item => {
        console.log(`ID: ${item.id}, Status: ${item.status}, Price: ${item.price}, Player: ${item.player_name}, OriginOrder: ${item.origin_order_id}`);
    });
}

debug();
</file>

<file path="frontend/manual_recovery.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SERVICE_ROLE_KEY');
    process.exit(1);
}

const supabaseAdmin = createClient(supabaseUrl, supabaseKey);

async function recover() {
    const orderId = '747bf8d6-0889-47f5-90ef-c890542ce115';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = 'b0f042cd-a95e-4008-9814-31c9fdfa5c62';

    console.log('--- Starting Manual Recovery ---');

    // 1. Get original listing
    const { data: listing, error: lError } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('id', listingId)
        .single();
    
    if (lError || !listing) {
        console.error('Error fetching listing:', lError);
        return;
    }

    // 2. Insert clone
    const { data: recovered, error: rError } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (rError) {
        console.error('Error inserting clone:', rError);
    } else {
        console.log('--- Successfully Recovered Item ---');
        console.log(recovered);
    }
}

recover();
</file>

<file path="frontend/middleware.ts">
import { NextResponse, type NextRequest } from 'next/server'
import { updateSession } from './utils/supabase/middleware'

export async function middleware(request: NextRequest) {
    // 1. Basic Auth Logic
    const basicAuthUser = process.env.BASIC_AUTH_USER;
    const basicAuthPassword = process.env.BASIC_AUTH_PASSWORD;

    // Exclude Webhooks and Debug from Admin Check
    if (request.nextUrl.pathname.startsWith('/api/webhooks') ||
        request.nextUrl.pathname.startsWith('/debug-admin') ||
        request.nextUrl.pathname.startsWith('/api/debug-auth')) {
        return await updateSession(request);
    }

    if (basicAuthUser && basicAuthPassword) {
        const authHeader = request.headers.get('authorization');

        if (authHeader) {
            try {
                const authValue = authHeader.split(' ')[1];
                const decoded = atob(authValue);
                const firstColonIndex = decoded.indexOf(':');

                if (firstColonIndex !== -1) {
                    const user = decoded.substring(0, firstColonIndex);
                    const pwd = decoded.substring(firstColonIndex + 1);

                    // Case-insensitive user check for iOS auto-capitalization
                    if (user.toLowerCase() === basicAuthUser.toLowerCase() && pwd === basicAuthPassword) {
                        return await updateSession(request);
                    }
                }
            } catch (e) {
                console.error('Basic Auth decode error:', e);
            }
        }

        const userAgent = request.headers.get('user-agent') || '';
        const isFBorMessenger = userAgent.includes('FBAN') || userAgent.includes('FBAV');

        const responseHeaders: Record<string, string> = {
            'Content-Type': 'text/html; charset=utf-8',
            'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
        };

        // Do not send WWW-Authenticate for FB/Messenger to force custom HTML display
        if (!isFBorMessenger) {
            responseHeaders['WWW-Authenticate'] = 'Basic realm="Restricted"';
        }

        return new Response(`
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Authentication Required [v2]</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                        background-color: #f4f7f9;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        height: 100vh;
                        margin: 0;
                        color: #333;
                    }
                    .container {
                        background: white;
                        padding: 2rem;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                        max-width: 400px;
                        text-align: center;
                    }
                    h1 { font-size: 1.5rem; margin-bottom: 1rem; color: #000; }
                    p { line-height: 1.6; color: #666; font-size: 0.95rem; }
                    .warning {
                        background: #fff8e1;
                        border-left: 4px solid #ffb300;
                        padding: 10px;
                        margin: 20px 0;
                        text-align: left;
                        font-size: 0.85rem;
                    }
                    .btn {
                        display: inline-block;
                        margin-top: 20px;
                        padding: 12px 24px;
                        background: #0070f3;
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>Authentication Required [v2]</h1>
                    <p>このページにアクセスするには認証が必要です。</p>
                    <div class="warning">
                        <strong>Messenger等をお使いの方へ:</strong><br>
                        アプリ内のブラウザでは認証画面が表示されない制約があります。右上のメニュー等から<strong>「ブラウザで開く」</strong>（SafariやChrome）を選択してください。
                    </div>
                    <p>通常はブラウザ側でログイン画面が表示されます。</p>
                </div>
            </body>
            </html>
        `, {
            status: 401,
            headers: responseHeaders,
        });
    }

    // 2. Standard Supabase Middleware
    return await updateSession(request);
}

export const config = {
    matcher: [
        /*
         * Match all request paths except for the ones starting with:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         * Feel free to modify this pattern to include more paths.
         */
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
    ],
}
</file>

<file path="frontend/next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
    async rewrites() {
        const backendUrl = process.env.BACKEND_URL || 'http://127.0.0.1:8000';
        return [
            {
                source: '/api/proxy/:path*',
                destination: `${backendUrl}/:path*`,
            },
        ];
    },
    images: {
        dangerouslyAllowSVG: true,
        contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
        remotePatterns: [
            {
                protocol: 'https',
                hostname: '**',
            },
        ],
    },
};

module.exports = nextConfig;
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "seed": "tsx scripts/seed.ts"
  },
  "dependencies": {
    "@ai-sdk/google": "^2.0.45",
    "@anthropic-ai/sdk": "^0.73.0",
    "@hookform/resolvers": "^5.2.2",
    "@react-email/components": "^1.0.1",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.86.2",
    "ai": "^5.0.108",
    "framer-motion": "^12.23.25",
    "lucide-react": "^0.563.0",
    "next": "^16.0.7",
    "openai": "^6.18.0",
    "pg": "^8.16.3",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-hook-form": "^7.68.0",
    "resend": "^6.5.2",
    "stripe": "^20.0.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.19",
    "dotenv": "^17.2.3",
    "eslint": "^9.39.1",
    "eslint-config-next": "^16.0.7",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "ts-node": "^10.9.2",
    "tsx": "^4.21.0",
    "typescript": "^5"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
};
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/recover_39k.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function recover() {
    const orderId = '22ffcc3d-92b3-409a-9455-02d688d801c5';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = 'fd35a791-acad-43e9-896b-26ac6fde589b';

    console.log('--- Starting Manual Recovery for 39k Sasaki ---');

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    const { data: recovered, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (error) {
        console.error('Manual Recovery Failed:', error);
    } else {
        console.log('Manual Recovery Success:', recovered);
    }
}

recover();
</file>

<file path="frontend/recover_sasaki.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function recover() {
    const orderId = '54ad7353-f758-4c9e-b115-773e59efe203';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = '642e6fda-9b31-4024-a97b-e2bb85cd0336';

    console.log('--- Starting Manual Recovery for 15k Sasaki ---');

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    const { data: recovered, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Draft', // Order is completed
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('*')
        .single();
    
    if (error) {
        console.error('Manual Recovery Failed:', error);
    } else {
        console.log('Manual Recovery Success:', recovered);
    }
}

recover();
</file>

<file path="frontend/simulate_insert.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function simulate() {
    const orderId = '54ad7353-f758-4c9e-b115-773e59efe203';
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff';
    const listingId = '642e6fda-9b31-4024-a97b-e2bb85cd0336';

    const { data: listing } = await supabaseAdmin.from('listing_items').select('*').eq('id', listingId).single();
    if (!listing) return;

    console.log('Inserting clone for 15k Sasaki...');
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: listing.player_name,
            team: listing.team,
            year: listing.year,
            manufacturer: listing.manufacturer,
            series_name: listing.series_name,
            card_number: listing.card_number,
            images: listing.images,
            condition_grading: listing.condition_grading,
            condition_rating: listing.condition_rating,
            variation: listing.variation,
            serial_number: listing.serial_number,
            is_rookie: listing.is_rookie,
            is_autograph: listing.is_autograph,
            description: listing.description,
            is_live_moment: listing.is_live_moment,
            
            seller_id: buyerId,
            status: 'Incoming',
            price: 0,
            origin_order_id: orderId,
            moment_history: listing.moment_history || []
        })
        .select('id')
        .single();
    
    if (error) {
        console.error('SIMULATED INSERT FAILED:', error);
    } else {
        console.log('SIMULATED INSERT SUCCESS:', data);
    }
}

simulate();
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
    content: [
        "./app/**/*.{js,ts,jsx,tsx,mdx}",
        "./components/**/*.{js,ts,jsx,tsx,mdx}",
    ],
    theme: {
        extend: {
            colors: {
                brand: {
                    dark: "#020408", // Deeper black/blue for background
                    "dark-light": "#0f172a",
                    blue: "#3b82f6",
                    "blue-glow": "#60a5fa",
                    gold: "#FFD700", // Bright Gold
                    bronze: "#CD7F32",
                    platinum: "#e2e8f0",
                },
            },
            fontFamily: {
                sans: ["var(--font-inter)", "sans-serif"],
                heading: ["var(--font-outfit)", "sans-serif"],
            },

            keyframes: {
                fadeInUp: {
                    "0%": { opacity: "0", transform: "translateY(10px)" },
                    "100%": { opacity: "1", transform: "translateY(0)" },
                },
                float: {
                    "0%, 100%": { transform: "translateY(0)" },
                    "50%": { transform: "translateY(-20px)" },
                },
                spotlight: {
                    "0%": { opacity: "0.5", transform: "scale(1)" },
                    "100%": { opacity: "1", transform: "scale(1.1)" },
                },
                shimmer: {
                    "0%": { backgroundPosition: "-200% 0" },
                    "100%": { backgroundPosition: "200% 0" },
                },
                "rotate-slow": {
                    "0%": { transform: "rotate(0deg)" },
                    "100%": { transform: "rotate(360deg)" },
                },
                shake: {
                    "0%, 100%": { transform: "translateX(0)" },
                    "10%, 30%, 50%, 70%, 90%": { transform: "translateX(-5px)" },
                    "20%, 40%, 60%, 80%": { transform: "translateX(5px)" },
                },
                "shimmer-diagonal": {
                    "0%": { transform: "translate(-100%, -100%) rotate(45deg)" },
                    "100%": { transform: "translate(100%, 100%) rotate(45deg)" },
                },
            },
            animation: {
                "fade-in-up": "fadeInUp 0.5s ease-out forwards",
                "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite",
                "float": "float 6s ease-in-out infinite",
                "spotlight": "spotlight 2s ease-in-out infinite alternate",
                "shimmer": "shimmer 3s linear infinite",
                "rotate-slow": "rotate-slow 10s linear infinite",
                "shake": "shake 0.5s cubic-bezier(.36,.07,.19,.97) both",
                "shimmer-diagonal": "shimmer-diagonal 3s ease-in-out infinite",
            },
        },
    },
    plugins: [],
};
</file>

<file path="frontend/TC-APP.code-workspace">
{
	"folders": [
		{
			"path": ".."
		}
	],
	"settings": {}
}
</file>

<file path="frontend/test_action.ts">
import { getBuyerItemByOrder } from './app/actions/item';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

// Emulate user context if possible, but the action uses createServerClient which might fail in script.
// I will instead create a script that emulates the logic inside the action with admin rights.

import { createClient } from '@supabase/supabase-js';
const supabaseAdmin = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
);

async function debug() {
    const orderId = 'd7bf11cc-54a4-4888-a8e8-dcddbf8d81d4'; // 30k Sasaki
    const userId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    // Logic from getBuyerItemByOrder
    const { data: order } = await supabaseAdmin
        .from('orders')
        .select('*, listing:listing_items!listing_id(*)')
        .eq('id', orderId)
        .single();

    if (!order) return console.log('Order not found');

    const listing = Array.isArray(order.listing) ? order.listing[0] : order.listing;
    
    // 3. Search for the buyer's copy using PINPOINT match
    const { data: pinpoint } = await supabaseAdmin
        .from('listing_items')
        .select('*')
        .eq('origin_order_id', orderId)
        .eq('seller_id', userId)
        .maybeSingle();

    console.log('Pinpoint Match:', pinpoint?.id);

    // 4. Fallback search (Fuzzy matching)
    if (!pinpoint) {
        const orderAt = new Date(order.created_at);
        const bufferTime = new Date(orderAt.getTime() - 10 * 24 * 60 * 60 * 1000).toISOString();

        const { data: results } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('seller_id', userId)
            .is('deleted_at', null)
            .not('status', 'in', '("Completed","Sold","Delivered")')
            .is('origin_order_id', null) // MY NEW FIX
            .gte('created_at', bufferTime);

        console.log('Fuzzy Match Results (with origin_order_id: null):', results?.length);

        // Try WITHOUT my fix to see what it would have done
        const { data: resultsOld } = await supabaseAdmin
            .from('listing_items')
            .select('*')
            .eq('seller_id', userId)
            .is('deleted_at', null)
            .not('status', 'in', '("Completed","Sold","Delivered")')
            .gte('created_at', bufferTime);
        
        console.log('Fuzzy Match Results (WITHOUT fix):', resultsOld?.length);
        resultsOld?.forEach(r => {
            if (r.images?.[0] === listing.images?.[0]) {
                console.log(`FOUND OLD MATCH: ${r.id} | OriginOrder: ${r.origin_order_id}`);
            }
        });
    }
}

debug();
</file>

<file path="frontend/test_incoming.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function test() {
    console.log('Testing "Incoming" status...');
    const { data, error } = await supabaseAdmin
        .from('listing_items')
        .insert({
            player_name: 'Enum Test',
            status: 'Incoming',
            seller_id: '868187c0-f34f-47c7-9449-bc829a212cff',
            price: 0,
            images: [],
            condition_grading: {}
        })
        .select('id')
        .single();
    
    if (error) {
        console.error('FAILED:', error.message);
    } else {
        console.log('SUCCESS! id:', data.id);
        // Clean up
        await supabaseAdmin.from('listing_items').delete().eq('id', data.id);
    }
}

test();
</file>

<file path="frontend/test.ts">
console.log('test')
</file>

<file path="frontend/trace_order.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function debug() {
    const orderId = '1e449fd3-d389-4481-aa47-01e64b7d66a8';
    const { data: order } = await supabaseAdmin.from('orders').select('*, listing:listing_items!listing_id(*)').eq('id', orderId).single();
    console.log('--- Traced Order ---');
    console.log(JSON.stringify(order, null, 2));

    const { data: profiles } = await supabaseAdmin.from('profiles').select('*').eq('id', order?.buyer_id);
    console.log('\n--- Order Buyer ---');
    console.log(profiles);
}

debug();
</file>

<file path="frontend/trigger_recovery.ts">
import { getBuyerItemByOrder } from './app/actions/item';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

async function run() {
    const orderId = '747bf8d6-0889-47f5-90ef-c890542ce115';
    console.log(`Triggering recovery for Order: ${orderId}`);
    const result = await getBuyerItemByOrder(orderId);
    console.log('Result:', result);
}

run();
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="frontend/vercel.json">
{
    "framework": "nextjs",
    "buildCommand": "next build",
    "installCommand": "npm install",
    "outputDirectory": ".next"
}
</file>

<file path="frontend/verify_visibility.ts">
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabaseAdmin = createClient(supabaseUrl!, supabaseKey!);

async function verify() {
    const buyerId = '868187c0-f34f-47c7-9449-bc829a212cff'; // buyer2

    const { data: items } = await supabaseAdmin
        .from('listing_items')
        .select('*, origin_order:orders!origin_order_id(status)')
        .eq('seller_id', buyerId);

    console.log('--- Buyer 2 Items ---');
    items?.forEach(item => {
        const order = Array.isArray(item.origin_order) ? item.origin_order[0] : item.origin_order;
        const willShowInWorkspace = ['Active', 'Display', 'Draft'].includes(item.status) && (!item.origin_order_id || order?.status === 'completed');
        
        console.log(`ID: ${item.id.substring(0,8)} | Player: ${item.player_name.padEnd(15)} | Status: ${item.status.padEnd(15)} | OrderStatus: ${(order?.status || 'N/A').padEnd(10)} | Visible: ${willShowInWorkspace}`);
    });
}

verify();
</file>

<file path="migrations/01_add_profile_name_fields.sql">
-- Add new columns for separating name types
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS display_name text,
ADD COLUMN IF NOT EXISTS first_name text,
ADD COLUMN IF NOT EXISTS last_name text;

-- Migrate existing 'name' to 'display_name' initially so it's not empty
UPDATE public.profiles 
SET display_name = name 
WHERE display_name IS NULL;
</file>

<file path="migrations/02_create_live_moments.sql">
-- ==============================================================================
-- Migration: 02_create_live_moments
-- Description: "Live Moment Engine" (リアルタイム通知基盤) 用のスキーマ定義
-- Author: Database Architect (Antigravity)
-- ==============================================================================

-- 1. Enum定義: moment_type
-- 設計思想: Enumを使用し、イベントタイプのデータ整合性を保証します。
-- 内部値は標準的な小文字（または英大文字）とし、UI側で必要に応じてフォーマットします。
CREATE TYPE moment_type AS ENUM (
    'HOMERUN',
    'BIG_PLAY',
    'VICTORY',
    'RECORD_BREAK',
    'system_notice'
);

-- 2. テーブル定義: live_moments
-- 設計思想:
-- - `player_name` は外部キー制約を持たせず TEXT とし、柔軟性を持たせます（現時点でplayersテーブルと密結合させない）。
-- - `metadata` は JSONB を採用し、"Antigravity"（将来の未知の要件）に対応できる柔軟性を確保します。
-- - `intensity` は演出の強度を決定します (1=控えめ, 5=最大級のGlowing/派手な演出)。
CREATE TABLE live_moments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    player_name TEXT NOT NULL,
    type moment_type NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    intensity INTEGER CHECK (intensity BETWEEN 1 AND 5) DEFAULT 1,
    metadata JSONB DEFAULT '{}'::jsonb
);

-- 3. セキュリティ (RLS)
-- 設計思想:
-- 「熱狂（Heartbeat）」データは全ユーザー（認証/未認証問わず）が読み取れるべきです。
-- これら運命的なイベントを書き込めるのは、システム管理者（Service Role）のみとします。
ALTER TABLE live_moments ENABLE ROW LEVEL SECURITY;

-- 全ユーザー（Authenticated & Anon）に読み取り権限を付与
CREATE POLICY "Public Read Access"
ON live_moments FOR SELECT
USING (true);

-- 書き込み権限は Service Role のみに制限
-- (Supabaseのデフォルト動作として、明示的なPolicyがない限りユーザーによるINSERT/UPDATE/DELETEは拒否されます)

-- 4. Realtime (リアルタイム機能) の有効化
-- 設計思想: フロントエンドはこのテーブルの INSERT を監視し、即座にアニメーションを発火させます。
-- `supabase_realtime` パブリケーションにこのテーブルを追加します。
alter publication supabase_realtime add table live_moments;

-- 5. シードデータ (動作確認用)
-- 設計思想: Intensity 5 の視覚効果を即座にテストするための、伝説的な瞬間データ。
INSERT INTO live_moments (player_name, type, title, description, intensity, metadata)
VALUES (
    '大谷 翔平',
    'HOMERUN',
    '大谷翔平、劇的なサヨナラ満塁ホームラン！今季40号達成！',
    '9回裏、2アウト満塁。ドジャースタジアムが揺れた歴史的瞬間。',
    5,
    '{
        "inning": "9th Bottom",
        "opponent": "Rays",
        "video_url": "https://example.com/moment/ohtani-40.mp4",
        "related_card_ids": []
    }'::jsonb
);
</file>

<file path="specs/data_model.yaml">
# Data Model Definition for Baseball Trading Card Platform
# Version: 1.0.0

models:
  # ---------------------------------------------------------
  # CardCatalog: カードそのもののマスターデータ（不変）
  # ---------------------------------------------------------
  CardCatalog:
    type: object
    description: "メーカーが発行したカードのカタログ情報。出品時の親データとなる。"
    properties:
      id:
        type: uuid
        primary_key: true
      manufacturer:
        type: string
        enum: ["BBM", "Calbee", "Epoch", "Topps_Japan"]
        description: "発行メーカー"
      year:
        type: integer
        example: 2024
        description: "発行年度"
      series_name:
        type: string
        example: "Genesis"
        description: "シリーズ名"
      card_number:
        type: string
        example: "G-01"
        description: "カード裏面の番号"
      player_name:
        type: string
        example: "大谷翔平"
        description: "選手名（漢字フルネーム推奨）"
      team:
        type: string
        enum: 
          - "Giants"    # 読売ジャイアンツ
          - "Tigers"    # 阪神タイガース
          - "Dragons"   # 中日ドラゴンズ
          - "Swallows"  # 東京ヤクルトスワローズ
          - "Carp"      # 広島東洋カープ
          - "BayStars"  # 横浜DeNAベイスターズ
          - "Hawks"     # 福岡ソフトバンクホークス
          - "Fighters"  # 北海道日本ハムファイターズ
          - "Marines"   # 千葉ロッテマリーンズ
          - "Buffaloes" # オリックス・バファローズ
          - "Eagles"    # 東北楽天ゴールデンイーグルス
          - "Lions"     # 埼玉西武ライオンズ
      rarity:
        type: string
        enum: ["Common", "Rare", "Super Rare", "Parallel", "Autograph", "Patch"]
      is_rookie:
        type: boolean
        default: false
        description: "ルーキーカードフラグ"

  # ---------------------------------------------------------
  # ListingItem: ユーザーが出品した個別の商品データ
  # ---------------------------------------------------------
  ListingItem:
    type: object
    description: "ユーザー間取引の対象となる具体的な出品アイテム"
    properties:
      id:
        type: uuid
        primary_key: true
      catalog_id:
        type: uuid
        foreign_key: "CardCatalog.id"
        description: "どのカタログのカードか"
      seller_id:
        type: uuid
        description: "出品ユーザーID"
      status:
        type: string
        enum: ["Draft", "Active", "TransactionPending", "Sold", "Cancelled", "Dispute"]
        default: "Draft"
      price:
        type: integer
        minimum: 100
        description: "出品価格（日本円）。100円以上必須。"
      images:
        type: array
        items: 
          type: string
          format: uri
        min_items: 2
        description: "画像URLリスト。表と裏の最低2枚が必要。"
      condition_grading:
        type: object
        description: "カードの状態または鑑定情報"
        properties:
          is_graded:
            type: boolean
            description: "鑑定済みかどうか"
          service:
            type: string
            enum: ["PSA", "BGS", "CGC", "ARS", "Raw"]
            description: "鑑定機関。未鑑定の場合はRaw。"
          score:
            type: number
            nullable: true
            example: 10
            description: "鑑定スコア"
          certification_number:
            type: string
            nullable: true
            description: "鑑定証明番号（PSA/BGS等の場合必須）"
      created_at:
        type: datetime
      updated_at:
        type: datetime
</file>

<file path="specs/openapi.yaml">
openapi: 3.0.3
info:
  title: Baseball Card Trading Platform API
  version: 1.0.0
  description: プロ野球カード取引プラットフォームのバックエンドAPI仕様

servers:
  - url: http://localhost:8000/v1
    description: Local Development Server

paths:
  # --- Catalog Endpoints ---
  /catalog/cards:
    get:
      summary: カタログ検索
      description: 条件に一致するカードカタログ情報を検索する
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: フリーワード検索（選手名など）
        - name: team
          in: query
          schema:
            type: string
            enum: ["Giants", "Tigers", "Dragons", "Swallows", "Carp", "BayStars", "Hawks", "Fighters", "Marines", "Buffaloes", "Eagles", "Lions"]
        - name: year
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: 検索結果リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CardCatalog'

  # --- Market Endpoints ---
  /market/listings:
    get:
      summary: 出品一覧取得
      description: 特定のカタログIDに紐づく出品、または新着出品を取得する
      parameters:
        - name: catalog_id
          in: query
          schema:
            type: string
            format: uuid
        - name: sort
          in: query
          schema:
            type: string
            enum: ["price_asc", "price_desc", "newest"]
      responses:
        '200':
          description: 出品リスト
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ListingItem'
    
    post:
      summary: 新規出品作成
      description: 新しいカードを出品する
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["catalog_id", "price", "images", "condition_grading"]
              properties:
                catalog_id:
                  type: string
                  format: uuid
                price:
                  type: integer
                  minimum: 100
                images:
                  type: array
                  items:
                    type: string
                  minItems: 2
                condition_grading:
                  $ref: '#/components/schemas/ConditionGrading'
      responses:
        '201':
          description: 出品作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListingItem'

  /market/orders:
    post:
      summary: 購入処理（注文作成）
      description: 出品されているアイテムを購入し、決済プロセスを開始する
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: ["listing_id", "payment_method_id"]
              properties:
                listing_id:
                  type: string
                  format: uuid
                payment_method_id:
                  type: string
      responses:
        '200':
          description: 注文受付完了
          content:
            application/json:
              schema:
                type: object
                properties:
                  order_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: "payment_processing"
        '409':
          description: コンフリクト（既に売り切れ、または決済処理中）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    CardCatalog:
      type: object
      properties:
        id: { type: string, format: uuid }
        player_name: { type: string }
        team: { type: string }
        manufacturer: { type: string }
        year: { type: integer }
    
    ListingItem:
      type: object
      properties:
        id: { type: string, format: uuid }
        catalog_id: { type: string, format: uuid }
        price: { type: integer }
        status: { type: string }
        condition_grading: { $ref: '#/components/schemas/ConditionGrading' }
    
    ConditionGrading:
      type: object
      properties:
        service: { type: string }
        score: { type: number }
        certification_number: { type: string }

    ErrorResponse:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        detail: { type: string }
</file>

<file path="specs/state_machine.md">
# Listing Lifecycle State Machine

このドキュメントは、出品アイテム(`ListingItem`)の状態遷移ルールを定義します。
バックエンド実装時は、この遷移図以外のステータス変更を許可しないでください。

```mermaid
stateDiagram-v2
    [*] --> Draft: 新規作成(下書き)
    
    Draft --> Active: 出品公開(Publish)
    note right of Active: 検索結果に表示される状態
    
    Active --> Cancelled: 出品取り下げ
    Active --> TransactionPending: 購入リクエスト(Buy)
    
    state TransactionPending {
        [*] --> PaymentVerifying
        PaymentVerifying --> PaymentCaptured: 決済成功
        PaymentVerifying --> PaymentFailed: 決済失敗
    }
    
    TransactionPending --> Active: 決済失敗/タイムアウト(在庫戻し)
    TransactionPending --> Sold: 決済確定(在庫引き落とし完了)
    
    state Sold {
        [*] --> AwaitingShipment: 発送待ち
        AwaitingShipment --> Shipped: 発送通知(追跡番号登録)
        Shipped --> Delivered: 配達完了(配送業者API連携)
        Delivered --> Completed: 受取評価完了(取引終了)
    }
    
    Sold --> Dispute: トラブル報告(運営介入)
    Dispute --> Cancelled: 返金・キャンセル
    Dispute --> Completed: 調停・取引成立
</file>

<file path="supabase/migrations/20251220160000_add_origin_order_id.sql">
-- Add origin_order_id to track which order created this cloned item
ALTER TABLE public.listing_items
ADD COLUMN IF NOT EXISTS origin_order_id uuid REFERENCES public.orders(id);
-- Create index for faster lookup
CREATE INDEX IF NOT EXISTS idx_listing_items_origin_order_id ON public.listing_items(origin_order_id);
-- Comment on column
COMMENT ON COLUMN public.listing_items.origin_order_id IS 'Reference to the order that created this cloned/buyer copy';
</file>

<file path="add_address_columns.sql">
-- Add address columns to profiles table
alter table public.profiles
add column if not exists postal_code text,
add column if not exists address_line1 text,
add column if not exists address_line2 text,
add column if not exists phone_number text;
</file>

<file path="add_columns.sql">
-- Add missing columns to orders table
alter table public.orders 
add column if not exists shipping_address text,
add column if not exists status text default 'Pending';
</file>

<file path="add_delete_policy_listings.sql">
-- Add delete policy for listing_items
create policy "Users can delete their own listings." 
on public.listing_items for delete 
using (auth.uid() = seller_id);
</file>

<file path="add_live_moment_column.sql">
ALTER TABLE listing_items ADD COLUMN is_live_moment BOOLEAN DEFAULT FALSE;
</file>

<file path="add_more_catalog_items.sql">
-- Add more sample data to card_catalogs
insert into public.card_catalogs (manufacturer, year, series_name, player_name, team, card_number, rarity, is_rookie)
values
  ('Topps', 2024, 'Chrome', 'Yoshinobu Yamamoto', 'Dodgers', '18', 'Rookie', true),
  ('Topps', 2024, 'Chrome', 'Shohei Ohtani', 'Dodgers', '17', 'Super Rare', false),
  ('BBM', 2023, 'Glory', 'Roki Sasaki', 'Marines', '17', 'Rare', false),
  ('BBM', 2023, 'Genesis', 'Munetaka Murakami', 'Swallows', '55', 'Super Rare', false),
  ('Epoch', 2022, 'Stars & Legends', 'Masataka Yoshida', 'Buffaloes', '7', 'Autograph', false),
  ('Topps_Japan', 2021, 'NPB Chrome', 'Seiya Suzuki', 'Carp', '51', 'Rare', false),
  ('Calbee', 2020, 'Pro Baseball Chips', 'Hayato Sakamoto', 'Giants', '6', 'Common', false),
  ('BBM', 2019, '1st Version', 'Koji Chikamoto', 'Tigers', '5', 'Rookie', true),
  ('Epoch', 2024, 'Premier', 'Shugo Maki', 'BayStars', '2', 'Patch', false),
  ('Topps', 2001, 'Traded', 'Ichiro Suzuki', 'Marines', '51', 'Rookie', true), -- Mariners mapped to Marines for enum compatibility or need new enum
  ('Topps', 2018, 'Update', 'Shohei Ohtani', 'Fighters', '17', 'Rookie', true); -- Angels mapped to Fighters for enum compatibility

-- Note: Team enum might need expansion if we want MLB teams properly. 
-- Current enum: Giants, Tigers, Dragons, Swallows, Carp, BayStars, Hawks, Fighters, Marines, Buffaloes, Eagles, Lions, Dodgers
</file>

<file path="apply_rls_policies.sql">
-- Enable RLS on tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE listing_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- Profiles Policies
CREATE POLICY "Public profiles are viewable by everyone" 
ON profiles FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" 
ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update their own profile" 
ON profiles FOR UPDATE USING (auth.uid() = id);

-- Listing Items Policies
CREATE POLICY "Public listings are viewable by everyone" 
ON listing_items FOR SELECT 
USING (status IN ('Active', 'Display', 'Sold', 'Shipped', 'Delivered', 'Completed', 'TransactionPending', 'AwaitingShipment'));

CREATE POLICY "Users can view their own draft/all listings" 
ON listing_items FOR SELECT 
USING (auth.uid() = seller_id);

CREATE POLICY "Users can insert their own listings" 
ON listing_items FOR INSERT 
WITH CHECK (auth.uid() = seller_id);

CREATE POLICY "Users can update their own listings" 
ON listing_items FOR UPDATE 
USING (auth.uid() = seller_id);

CREATE POLICY "Users can delete their own listings" 
ON listing_items FOR DELETE 
USING (auth.uid() = seller_id);

-- Orders Policies
-- Buyer can view their orders
CREATE POLICY "Buyers can view their own orders" 
ON orders FOR SELECT 
USING (auth.uid() = buyer_id);

-- Seller can view orders for their items (via listing_items)
CREATE POLICY "Sellers can view orders for their items" 
ON orders FOR SELECT 
USING (
    EXISTS (
        SELECT 1 FROM listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);

-- Buyers can create orders
CREATE POLICY "Buyers can create orders" 
ON orders FOR INSERT 
WITH CHECK (auth.uid() = buyer_id);

-- Updates are generally handled by system/RPC, but allowing status updates by participants if needed
-- For now, restricting updates to explicit cases or keeping it open to participants
CREATE POLICY "Participants can update orders" 
ON orders FOR UPDATE 
USING (
    auth.uid() = buyer_id OR 
    EXISTS (
        SELECT 1 FROM listing_items 
        WHERE listing_items.id = orders.listing_id 
        AND listing_items.seller_id = auth.uid()
    )
);
</file>

<file path="create_complete_order_function.sql">
-- Function to allow buyers to mark an order as completed
create or replace function public.complete_order(p_listing_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  -- Check if the user is the buyer of the order linked to this listing
  if not exists (
    select 1 from public.orders
    where orders.listing_id = p_listing_id
    and orders.buyer_id = auth.uid()
  ) then
    raise exception 'Not authorized';
  end if;

  -- Update the listing status
  update public.listing_items
  set status = 'Completed'
  where id = p_listing_id;
end;
$$;
</file>

<file path="create_complete_order_rpc.sql">
CREATE OR REPLACE FUNCTION complete_order(p_listing_id UUID)
RETURNS VOID AS $$
DECLARE
    v_buyer_id UUID;
    v_old_listing listing_items%ROWTYPE;
BEGIN
    -- 1. Get the listing and buyer info
    SELECT * INTO v_old_listing FROM listing_items WHERE id = p_listing_id;
    
    SELECT buyer_id INTO v_buyer_id FROM orders WHERE listing_id = p_listing_id;

    IF v_buyer_id IS NULL THEN
        RAISE EXCEPTION 'Order not found for listing %', p_listing_id;
    END IF;

    -- 2. Update old listing status to Completed
    UPDATE listing_items SET status = 'Completed' WHERE id = p_listing_id;

    -- 3. Create new listing for buyer
    INSERT INTO listing_items (
        catalog_id,
        seller_id,
        status,
        price,
        images,
        condition_grading
    ) VALUES (
        v_old_listing.catalog_id,
        v_buyer_id,
        'Draft',
        NULL,
        v_old_listing.images,
        v_old_listing.condition_grading
    );

END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="create_user_collections.sql">
-- Create user_collections table for manually added cards
create table public.user_collections (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references public.profiles(id) not null,
  catalog_id uuid references public.card_catalogs(id) not null,
  images jsonb not null default '[]'::jsonb,
  condition text,
  notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for user_collections
alter table public.user_collections enable row level security;

create policy "Users can view their own collection." 
on public.user_collections for select 
using (auth.uid() = user_id);

create policy "Users can insert into their own collection." 
on public.user_collections for insert 
with check (auth.uid() = user_id);

create policy "Users can update their own collection." 
on public.user_collections for update 
using (auth.uid() = user_id);

create policy "Users can delete from their own collection." 
on public.user_collections for delete 
using (auth.uid() = user_id);
</file>

<file path="enable_live_moment_sample.sql">
-- 最新のアイテム1つをLive Moment（金枠）に設定する
UPDATE listing_items
SET is_live_moment = TRUE
WHERE id = (
  SELECT id FROM listing_items
  ORDER BY created_at DESC
  LIMIT 1
);
</file>

<file path="package.json">
{
    "name": "tc-app-root",
    "version": "1.0.0",
    "private": true,
    "scripts": {
        "dev": "npm run dev --prefix frontend",
        "build": "npm run build --prefix frontend",
        "start": "npm run start --prefix frontend",
        "lint": "npm run lint --prefix frontend"
    },
    "dependencies": {
        "lucide-react": "^0.563.0"
    }
}
</file>

<file path="purchase_rpc.sql">
-- Function to handle item purchase transaction securely
create or replace function public.purchase_item(
  p_listing_id uuid,
  p_buyer_id uuid,
  p_total_amount integer,
  p_payment_method_id text,
  p_shipping_address text
)
returns uuid
language plpgsql
security definer -- Run with privileges of the creator (admin) to bypass RLS for status update
as $$
declare
  v_listing_status listing_status_enum;
  v_new_order_id uuid;
begin
  -- 1. Check if listing exists and is active
  select status into v_listing_status
  from public.listing_items
  where id = p_listing_id
  for update; -- Lock the row to prevent race conditions

  if v_listing_status is null then
    raise exception 'Listing not found';
  end if;

  if v_listing_status != 'Active' then
    raise exception 'Item is no longer available';
  end if;

  -- 2. Create Order
  insert into public.orders (
    listing_id,
    buyer_id,
    payment_method_id,
    total_amount,
    shipping_address,
    status
  ) values (
    p_listing_id,
    p_buyer_id,
    p_payment_method_id,
    p_total_amount,
    p_shipping_address,
    'Paid'
  )
  returning id into v_new_order_id;

  -- 3. Update Listing Status
  update public.listing_items
  set status = 'AwaitingShipment'
  where id = p_listing_id;

  return v_new_order_id;
end;
$$;
</file>

<file path="seed_catalog.py">
import os
from supabase import create_client, Client
from dotenv import load_dotenv

load_dotenv("frontend/.env.local")

url: str = os.environ.get("NEXT_PUBLIC_SUPABASE_URL")
key: str = os.environ.get("NEXT_PUBLIC_SUPABASE_ANON_KEY")

if not url or not key:
    print("Error: Supabase URL or Key not found in frontend/.env.local")
    exit(1)

supabase: Client = create_client(url, key)

sample_catalogs = [
    {
        "manufacturer": "Topps",
        "series_name": "Chrome",
        "player_name": "Shohei Ohtani",
        "team": "Dodgers",
        "card_number": "1",
        "rarity": "Super Rare",
        "is_rookie": False,
        "year": 2024
    },
    {
        "manufacturer": "BBM",
        "series_name": "Genesis",
        "player_name": "Roki Sasaki",
        "team": "Marines",
        "card_number": "17",
        "rarity": "Rare",
        "is_rookie": False,
        "year": 2023
    },
    {
        "manufacturer": "Epoch",
        "series_name": "Stars & Legends",
        "player_name": "Ichiro Suzuki",
        "team": "Marines", # Note: Ichiro played for Orix/Mariners, but using valid enum for now or need to check enum
        "card_number": "51",
        "rarity": "Legend",
        "is_rookie": False,
        "year": 2022
    },
    {
        "manufacturer": "Calbee",
        "series_name": "Pro Baseball Chips",
        "player_name": "Munetaka Murakami",
        "team": "Swallows",
        "card_number": "55",
        "rarity": "Common",
        "is_rookie": False,
        "year": 2024
    }
]

# Check team enum validity based on schema
# enum: 'Giants', 'Tigers', 'Dragons', 'Swallows', 'Carp', 'BayStars', 'Hawks', 'Fighters', 'Marines', 'Buffaloes', 'Eagles', 'Lions', 'Dodgers'
# Ichiro -> Marines is technically wrong team but valid enum. Let's change Ichiro to 'Buffaloes' (Orix)

sample_catalogs[2]["team"] = "Buffaloes"

print("Seeding catalog data...")

for item in sample_catalogs:
    try:
        data, count = supabase.table("card_catalogs").insert(item).execute()
        print(f"Inserted: {item['player_name']}")
    except Exception as e:
        print(f"Error inserting {item['player_name']}: {e}")

print("Seeding complete.")
</file>

<file path="seed_data.sql">
-- Insert sample data into card_catalogs
insert into public.card_catalogs (manufacturer, series_name, player_name, team, card_number, rarity, is_rookie, year)
values
  ('Topps', 'Chrome', 'Shohei Ohtani', 'Dodgers', '1', 'Super Rare', false, 2024),
  ('BBM', 'Genesis', 'Roki Sasaki', 'Marines', '17', 'Rare', false, 2023),
  ('Epoch', 'Stars & Legends', 'Ichiro Suzuki', 'Buffaloes', '51', 'Legend', false, 2022),
  ('Calbee', 'Pro Baseball Chips', 'Munetaka Murakami', 'Swallows', '55', 'Common', false, 2024);
</file>

<file path="storage_policy.sql">
-- Create a new storage bucket for card images
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true)
on conflict (id) do nothing;

-- Set up access policies for the storage bucket
-- 1. Allow public read access to the bucket
create policy "Public Access"
on storage.objects for select
using ( bucket_id = 'card-images' );

-- 2. Allow authenticated users to upload images
create policy "Authenticated users can upload images"
on storage.objects for insert
with check (
  bucket_id = 'card-images'
  and auth.role() = 'authenticated'
);

-- 3. Allow users to update/delete their own images (Optional but good practice)
create policy "Users can update own images"
on storage.objects for update
using (
  bucket_id = 'card-images'
  and auth.uid() = owner
);

create policy "Users can delete own images"
on storage.objects for delete
using (
  bucket_id = 'card-images'
  and auth.uid() = owner
);
</file>

<file path="supabase_schema.sql">
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. ENUMS
create type manufacturer_enum as enum ('BBM', 'Calbee', 'Epoch', 'Topps_Japan', 'Topps');
create type team_enum as enum ('Giants', 'Tigers', 'Dragons', 'Swallows', 'Carp', 'BayStars', 'Hawks', 'Fighters', 'Marines', 'Buffaloes', 'Eagles', 'Lions', 'Dodgers');
create type rarity_enum as enum ('Common', 'Rare', 'Super Rare', 'Parallel', 'Autograph', 'Patch', 'Rookie', 'Legend');
create type listing_status_enum as enum ('Draft', 'Active', 'TransactionPending', 'AwaitingShipment', 'Shipped', 'Delivered', 'Completed', 'Cancelled');

-- 2. USERS (Profiles)
-- Supabase handles auth in auth.users. This table extends that data.
create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text unique not null,
  name text,
  avatar_url text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for Profiles
alter table public.profiles enable row level security;
create policy "Public profiles are viewable by everyone." on public.profiles for select using (true);
create policy "Users can insert their own profile." on public.profiles for insert with check (auth.uid() = id);
create policy "Users can update their own profile." on public.profiles for update using (auth.uid() = id);

-- 3. CARD CATALOG (Master Data)
create table public.card_catalogs (
  id uuid default uuid_generate_v4() primary key,
  manufacturer manufacturer_enum not null,
  series_name text,
  player_name text not null,
  team team_enum not null,
  card_number text,
  rarity rarity_enum,
  is_rookie boolean default false,
  year integer,
  created_at timestamptz default now()
);

-- RLS for Catalog
alter table public.card_catalogs enable row level security;
create policy "Catalog is viewable by everyone." on public.card_catalogs for select using (true);
-- Only admins should insert/update catalog (skipping policy for now or assume service role)

-- 4. LISTING ITEMS (Products)
create table public.listing_items (
  id uuid default uuid_generate_v4() primary key,
  catalog_id uuid references public.card_catalogs(id) not null,
  seller_id uuid references public.profiles(id) not null,
  status listing_status_enum default 'Draft'::listing_status_enum not null,
  price integer not null,
  images jsonb not null, -- Stores array of image URLs
  condition_grading jsonb not null, -- Stores grading details
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for Listings
alter table public.listing_items enable row level security;
create policy "Listings are viewable by everyone." on public.listing_items for select using (true);
create policy "Users can create their own listings." on public.listing_items for insert with check (auth.uid() = seller_id);
create policy "Users can update their own listings." on public.listing_items for update using (auth.uid() = seller_id);

-- 5. ORDERS (Transaction History)
create table public.orders (
  id uuid default uuid_generate_v4() primary key,
  listing_id uuid references public.listing_items(id) not null unique,
  buyer_id uuid references public.profiles(id) not null,
  payment_method_id text not null,
  total_amount integer not null,
  tracking_number text,
  created_at timestamptz default now()
);

-- RLS for Orders
alter table public.orders enable row level security;
create policy "Users can view their own orders (as buyer)." on public.orders for select using (auth.uid() = buyer_id);
create policy "Sellers can view orders for their items." on public.orders for select using (
  exists (
    select 1 from public.listing_items
    where listing_items.id = orders.listing_id
    and listing_items.seller_id = auth.uid()
  )
);
create policy "Users can create orders." on public.orders for insert with check (auth.uid() = buyer_id);

-- Function to handle new user signup (Trigger)
create or replace function public.handle_new_user() 
returns trigger as $$
begin
  insert into public.profiles (id, email, name)
  values (new.id, new.email, new.raw_user_meta_data->>'name');
  return new;
end;
$$ language plpgsql security definer;

-- Trigger for new user signup
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
</file>

<file path="test_image.txt">
fake image content
</file>

<file path="update_status_enum.sql">
-- 1. Update Enum to include 'Display' and 'Sold'
ALTER TYPE listing_status_enum ADD VALUE IF NOT EXISTS 'Display';
ALTER TYPE listing_status_enum ADD VALUE IF NOT EXISTS 'Sold';

-- 2. Make price nullable in listing_items
ALTER TABLE listing_items ALTER COLUMN price DROP NOT NULL;

-- 3. Migrate user_collections to listing_items
-- We assume user_collections has: user_id, catalog_id, images, condition (text)
-- We map this to listing_items: seller_id, catalog_id, images, condition_grading (jsonb)
INSERT INTO listing_items (
    catalog_id,
    seller_id,
    status,
    price,
    images,
    condition_grading
)
SELECT
    catalog_id,
    user_id,
    'Draft', -- Default status for migrated items
    NULL,    -- Price is null for Draft/Collection items
    images,
    jsonb_build_object(
        'is_graded', CASE WHEN condition = 'Graded' THEN true ELSE false END,
        'service', CASE WHEN condition = 'Graded' THEN 'PSA' ELSE 'Raw' END, -- Defaulting to PSA/Raw for migration
        'score', 10 -- Placeholder score
    )
FROM user_collections;

-- 4. Verify migration (Optional select to check)
-- SELECT * FROM listing_items WHERE status = 'Draft';
</file>

</files>
</file>

<file path="seed_catalog.py">
import os
from supabase import create_client, Client
from dotenv import load_dotenv

load_dotenv("frontend/.env.local")

url: str = os.environ.get("NEXT_PUBLIC_SUPABASE_URL")
key: str = os.environ.get("NEXT_PUBLIC_SUPABASE_ANON_KEY")

if not url or not key:
    print("Error: Supabase URL or Key not found in frontend/.env.local")
    exit(1)

supabase: Client = create_client(url, key)

sample_catalogs = [
    {
        "manufacturer": "Topps",
        "series_name": "Chrome",
        "player_name": "Shohei Ohtani",
        "team": "Dodgers",
        "card_number": "1",
        "rarity": "Super Rare",
        "is_rookie": False,
        "year": 2024
    },
    {
        "manufacturer": "BBM",
        "series_name": "Genesis",
        "player_name": "Roki Sasaki",
        "team": "Marines",
        "card_number": "17",
        "rarity": "Rare",
        "is_rookie": False,
        "year": 2023
    },
    {
        "manufacturer": "Epoch",
        "series_name": "Stars & Legends",
        "player_name": "Ichiro Suzuki",
        "team": "Marines", # Note: Ichiro played for Orix/Mariners, but using valid enum for now or need to check enum
        "card_number": "51",
        "rarity": "Legend",
        "is_rookie": False,
        "year": 2022
    },
    {
        "manufacturer": "Calbee",
        "series_name": "Pro Baseball Chips",
        "player_name": "Munetaka Murakami",
        "team": "Swallows",
        "card_number": "55",
        "rarity": "Common",
        "is_rookie": False,
        "year": 2024
    }
]

# Check team enum validity based on schema
# enum: 'Giants', 'Tigers', 'Dragons', 'Swallows', 'Carp', 'BayStars', 'Hawks', 'Fighters', 'Marines', 'Buffaloes', 'Eagles', 'Lions', 'Dodgers'
# Ichiro -> Marines is technically wrong team but valid enum. Let's change Ichiro to 'Buffaloes' (Orix)

sample_catalogs[2]["team"] = "Buffaloes"

print("Seeding catalog data...")

for item in sample_catalogs:
    try:
        data, count = supabase.table("card_catalogs").insert(item).execute()
        print(f"Inserted: {item['player_name']}")
    except Exception as e:
        print(f"Error inserting {item['player_name']}: {e}")

print("Seeding complete.")
</file>

<file path="seed_data.sql">
-- Insert sample data into card_catalogs
insert into public.card_catalogs (manufacturer, series_name, player_name, team, card_number, rarity, is_rookie, year)
values
  ('Topps', 'Chrome', 'Shohei Ohtani', 'Dodgers', '1', 'Super Rare', false, 2024),
  ('BBM', 'Genesis', 'Roki Sasaki', 'Marines', '17', 'Rare', false, 2023),
  ('Epoch', 'Stars & Legends', 'Ichiro Suzuki', 'Buffaloes', '51', 'Legend', false, 2022),
  ('Calbee', 'Pro Baseball Chips', 'Munetaka Murakami', 'Swallows', '55', 'Common', false, 2024);
</file>

<file path="storage_policy.sql">
-- Create a new storage bucket for card images
insert into storage.buckets (id, name, public)
values ('card-images', 'card-images', true)
on conflict (id) do nothing;

-- Set up access policies for the storage bucket
-- 1. Allow public read access to the bucket
create policy "Public Access"
on storage.objects for select
using ( bucket_id = 'card-images' );

-- 2. Allow authenticated users to upload images
create policy "Authenticated users can upload images"
on storage.objects for insert
with check (
  bucket_id = 'card-images'
  and auth.role() = 'authenticated'
);

-- 3. Allow users to update/delete their own images (Optional but good practice)
create policy "Users can update own images"
on storage.objects for update
using (
  bucket_id = 'card-images'
  and auth.uid() = owner
);

create policy "Users can delete own images"
on storage.objects for delete
using (
  bucket_id = 'card-images'
  and auth.uid() = owner
);
</file>

<file path="supabase_schema.sql">
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. ENUMS
create type manufacturer_enum as enum ('BBM', 'Calbee', 'Epoch', 'Topps_Japan', 'Topps');
create type team_enum as enum ('Giants', 'Tigers', 'Dragons', 'Swallows', 'Carp', 'BayStars', 'Hawks', 'Fighters', 'Marines', 'Buffaloes', 'Eagles', 'Lions', 'Dodgers');
create type rarity_enum as enum ('Common', 'Rare', 'Super Rare', 'Parallel', 'Autograph', 'Patch', 'Rookie', 'Legend');
create type listing_status_enum as enum ('Draft', 'Active', 'TransactionPending', 'AwaitingShipment', 'Shipped', 'Delivered', 'Completed', 'Cancelled');

-- 2. USERS (Profiles)
-- Supabase handles auth in auth.users. This table extends that data.
create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text unique not null,
  name text,
  avatar_url text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for Profiles
alter table public.profiles enable row level security;
create policy "Public profiles are viewable by everyone." on public.profiles for select using (true);
create policy "Users can insert their own profile." on public.profiles for insert with check (auth.uid() = id);
create policy "Users can update their own profile." on public.profiles for update using (auth.uid() = id);

-- 3. CARD CATALOG (Master Data)
create table public.card_catalogs (
  id uuid default uuid_generate_v4() primary key,
  manufacturer manufacturer_enum not null,
  series_name text,
  player_name text not null,
  team team_enum not null,
  card_number text,
  rarity rarity_enum,
  is_rookie boolean default false,
  year integer,
  created_at timestamptz default now()
);

-- RLS for Catalog
alter table public.card_catalogs enable row level security;
create policy "Catalog is viewable by everyone." on public.card_catalogs for select using (true);
-- Only admins should insert/update catalog (skipping policy for now or assume service role)

-- 4. LISTING ITEMS (Products)
create table public.listing_items (
  id uuid default uuid_generate_v4() primary key,
  catalog_id uuid references public.card_catalogs(id) not null,
  seller_id uuid references public.profiles(id) not null,
  status listing_status_enum default 'Draft'::listing_status_enum not null,
  price integer not null,
  images jsonb not null, -- Stores array of image URLs
  condition_grading jsonb not null, -- Stores grading details
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- RLS for Listings
alter table public.listing_items enable row level security;
create policy "Listings are viewable by everyone." on public.listing_items for select using (true);
create policy "Users can create their own listings." on public.listing_items for insert with check (auth.uid() = seller_id);
create policy "Users can update their own listings." on public.listing_items for update using (auth.uid() = seller_id);

-- 5. ORDERS (Transaction History)
create table public.orders (
  id uuid default uuid_generate_v4() primary key,
  listing_id uuid references public.listing_items(id) not null unique,
  buyer_id uuid references public.profiles(id) not null,
  payment_method_id text not null,
  total_amount integer not null,
  tracking_number text,
  created_at timestamptz default now()
);

-- RLS for Orders
alter table public.orders enable row level security;
create policy "Users can view their own orders (as buyer)." on public.orders for select using (auth.uid() = buyer_id);
create policy "Sellers can view orders for their items." on public.orders for select using (
  exists (
    select 1 from public.listing_items
    where listing_items.id = orders.listing_id
    and listing_items.seller_id = auth.uid()
  )
);
create policy "Users can create orders." on public.orders for insert with check (auth.uid() = buyer_id);

-- Function to handle new user signup (Trigger)
create or replace function public.handle_new_user() 
returns trigger as $$
begin
  insert into public.profiles (id, email, name)
  values (new.id, new.email, new.raw_user_meta_data->>'name');
  return new;
end;
$$ language plpgsql security definer;

-- Trigger for new user signup
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
</file>

<file path="test_image.txt">
fake image content
</file>

<file path="update_status_enum.sql">
-- 1. Update Enum to include 'Display' and 'Sold'
ALTER TYPE listing_status_enum ADD VALUE IF NOT EXISTS 'Display';
ALTER TYPE listing_status_enum ADD VALUE IF NOT EXISTS 'Sold';

-- 2. Make price nullable in listing_items
ALTER TABLE listing_items ALTER COLUMN price DROP NOT NULL;

-- 3. Migrate user_collections to listing_items
-- We assume user_collections has: user_id, catalog_id, images, condition (text)
-- We map this to listing_items: seller_id, catalog_id, images, condition_grading (jsonb)
INSERT INTO listing_items (
    catalog_id,
    seller_id,
    status,
    price,
    images,
    condition_grading
)
SELECT
    catalog_id,
    user_id,
    'Draft', -- Default status for migrated items
    NULL,    -- Price is null for Draft/Collection items
    images,
    jsonb_build_object(
        'is_graded', CASE WHEN condition = 'Graded' THEN true ELSE false END,
        'service', CASE WHEN condition = 'Graded' THEN 'PSA' ELSE 'Raw' END, -- Defaulting to PSA/Raw for migration
        'score', 10 -- Placeholder score
    )
FROM user_collections;

-- 4. Verify migration (Optional select to check)
-- SELECT * FROM listing_items WHERE status = 'Draft';
</file>

</files>
